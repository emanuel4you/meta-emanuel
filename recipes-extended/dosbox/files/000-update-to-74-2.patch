diff -Nur dosbox-0.74/acinclude.m4 dosbox-0.74.patch/acinclude.m4
--- dosbox-0.74/acinclude.m4	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/acinclude.m4	2016-12-11 18:35:15.474284008 +0100
@@ -305,7 +305,7 @@
 
 AH_TOP([
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
diff -Nur dosbox-0.74/aclocal.m4 dosbox-0.74.patch/aclocal.m4
--- dosbox-0.74/aclocal.m4	2010-05-10 20:59:01.000000000 +0200
+++ dosbox-0.74.patch/aclocal.m4	1970-01-01 01:00:00.000000000 +0100
@@ -1,964 +0,0 @@
-# generated automatically by aclocal 1.11.1 -*- Autoconf -*-
-
-# Copyright (C) 1996, 1997, 1998, 1999, 2000, 2001, 2002, 2003, 2004,
-# 2005, 2006, 2007, 2008, 2009  Free Software Foundation, Inc.
-# This file is free software; the Free Software Foundation
-# gives unlimited permission to copy and/or distribute it,
-# with or without modifications, as long as this notice is preserved.
-
-# This program is distributed in the hope that it will be useful,
-# but WITHOUT ANY WARRANTY, to the extent permitted by law; without
-# even the implied warranty of MERCHANTABILITY or FITNESS FOR A
-# PARTICULAR PURPOSE.
-
-m4_ifndef([AC_AUTOCONF_VERSION],
-  [m4_copy([m4_PACKAGE_VERSION], [AC_AUTOCONF_VERSION])])dnl
-m4_if(m4_defn([AC_AUTOCONF_VERSION]), [2.65],,
-[m4_warning([this file was generated for autoconf 2.65.
-You have another version of autoconf.  It may work, but is not guaranteed to.
-If you have problems, you may need to regenerate the build system entirely.
-To do so, use the procedure documented by the package, typically `autoreconf'.])])
-
-# Copyright (C) 2002, 2003, 2005, 2006, 2007, 2008  Free Software Foundation, Inc.
-#
-# This file is free software; the Free Software Foundation
-# gives unlimited permission to copy and/or distribute it,
-# with or without modifications, as long as this notice is preserved.
-
-# AM_AUTOMAKE_VERSION(VERSION)
-# ----------------------------
-# Automake X.Y traces this macro to ensure aclocal.m4 has been
-# generated from the m4 files accompanying Automake X.Y.
-# (This private macro should not be called outside this file.)
-AC_DEFUN([AM_AUTOMAKE_VERSION],
-[am__api_version='1.11'
-dnl Some users find AM_AUTOMAKE_VERSION and mistake it for a way to
-dnl require some minimum version.  Point them to the right macro.
-m4_if([$1], [1.11.1], [],
-      [AC_FATAL([Do not call $0, use AM_INIT_AUTOMAKE([$1]).])])dnl
-])
-
-# _AM_AUTOCONF_VERSION(VERSION)
-# -----------------------------
-# aclocal traces this macro to find the Autoconf version.
-# This is a private macro too.  Using m4_define simplifies
-# the logic in aclocal, which can simply ignore this definition.
-m4_define([_AM_AUTOCONF_VERSION], [])
-
-# AM_SET_CURRENT_AUTOMAKE_VERSION
-# -------------------------------
-# Call AM_AUTOMAKE_VERSION and AM_AUTOMAKE_VERSION so they can be traced.
-# This function is AC_REQUIREd by AM_INIT_AUTOMAKE.
-AC_DEFUN([AM_SET_CURRENT_AUTOMAKE_VERSION],
-[AM_AUTOMAKE_VERSION([1.11.1])dnl
-m4_ifndef([AC_AUTOCONF_VERSION],
-  [m4_copy([m4_PACKAGE_VERSION], [AC_AUTOCONF_VERSION])])dnl
-_AM_AUTOCONF_VERSION(m4_defn([AC_AUTOCONF_VERSION]))])
-
-# AM_AUX_DIR_EXPAND                                         -*- Autoconf -*-
-
-# Copyright (C) 2001, 2003, 2005  Free Software Foundation, Inc.
-#
-# This file is free software; the Free Software Foundation
-# gives unlimited permission to copy and/or distribute it,
-# with or without modifications, as long as this notice is preserved.
-
-# For projects using AC_CONFIG_AUX_DIR([foo]), Autoconf sets
-# $ac_aux_dir to `$srcdir/foo'.  In other projects, it is set to
-# `$srcdir', `$srcdir/..', or `$srcdir/../..'.
-#
-# Of course, Automake must honor this variable whenever it calls a
-# tool from the auxiliary directory.  The problem is that $srcdir (and
-# therefore $ac_aux_dir as well) can be either absolute or relative,
-# depending on how configure is run.  This is pretty annoying, since
-# it makes $ac_aux_dir quite unusable in subdirectories: in the top
-# source directory, any form will work fine, but in subdirectories a
-# relative path needs to be adjusted first.
-#
-# $ac_aux_dir/missing
-#    fails when called from a subdirectory if $ac_aux_dir is relative
-# $top_srcdir/$ac_aux_dir/missing
-#    fails if $ac_aux_dir is absolute,
-#    fails when called from a subdirectory in a VPATH build with
-#          a relative $ac_aux_dir
-#
-# The reason of the latter failure is that $top_srcdir and $ac_aux_dir
-# are both prefixed by $srcdir.  In an in-source build this is usually
-# harmless because $srcdir is `.', but things will broke when you
-# start a VPATH build or use an absolute $srcdir.
-#
-# So we could use something similar to $top_srcdir/$ac_aux_dir/missing,
-# iff we strip the leading $srcdir from $ac_aux_dir.  That would be:
-#   am_aux_dir='\$(top_srcdir)/'`expr "$ac_aux_dir" : "$srcdir//*\(.*\)"`
-# and then we would define $MISSING as
-#   MISSING="\${SHELL} $am_aux_dir/missing"
-# This will work as long as MISSING is not called from configure, because
-# unfortunately $(top_srcdir) has no meaning in configure.
-# However there are other variables, like CC, which are often used in
-# configure, and could therefore not use this "fixed" $ac_aux_dir.
-#
-# Another solution, used here, is to always expand $ac_aux_dir to an
-# absolute PATH.  The drawback is that using absolute paths prevent a
-# configured tree to be moved without reconfiguration.
-
-AC_DEFUN([AM_AUX_DIR_EXPAND],
-[dnl Rely on autoconf to set up CDPATH properly.
-AC_PREREQ([2.50])dnl
-# expand $ac_aux_dir to an absolute path
-am_aux_dir=`cd $ac_aux_dir && pwd`
-])
-
-# AM_CONDITIONAL                                            -*- Autoconf -*-
-
-# Copyright (C) 1997, 2000, 2001, 2003, 2004, 2005, 2006, 2008
-# Free Software Foundation, Inc.
-#
-# This file is free software; the Free Software Foundation
-# gives unlimited permission to copy and/or distribute it,
-# with or without modifications, as long as this notice is preserved.
-
-# serial 9
-
-# AM_CONDITIONAL(NAME, SHELL-CONDITION)
-# -------------------------------------
-# Define a conditional.
-AC_DEFUN([AM_CONDITIONAL],
-[AC_PREREQ(2.52)dnl
- ifelse([$1], [TRUE],  [AC_FATAL([$0: invalid condition: $1])],
-	[$1], [FALSE], [AC_FATAL([$0: invalid condition: $1])])dnl
-AC_SUBST([$1_TRUE])dnl
-AC_SUBST([$1_FALSE])dnl
-_AM_SUBST_NOTMAKE([$1_TRUE])dnl
-_AM_SUBST_NOTMAKE([$1_FALSE])dnl
-m4_define([_AM_COND_VALUE_$1], [$2])dnl
-if $2; then
-  $1_TRUE=
-  $1_FALSE='#'
-else
-  $1_TRUE='#'
-  $1_FALSE=
-fi
-AC_CONFIG_COMMANDS_PRE(
-[if test -z "${$1_TRUE}" && test -z "${$1_FALSE}"; then
-  AC_MSG_ERROR([[conditional "$1" was never defined.
-Usually this means the macro was only invoked conditionally.]])
-fi])])
-
-# Copyright (C) 1999, 2000, 2001, 2002, 2003, 2004, 2005, 2006, 2009
-# Free Software Foundation, Inc.
-#
-# This file is free software; the Free Software Foundation
-# gives unlimited permission to copy and/or distribute it,
-# with or without modifications, as long as this notice is preserved.
-
-# serial 10
-
-# There are a few dirty hacks below to avoid letting `AC_PROG_CC' be
-# written in clear, in which case automake, when reading aclocal.m4,
-# will think it sees a *use*, and therefore will trigger all it's
-# C support machinery.  Also note that it means that autoscan, seeing
-# CC etc. in the Makefile, will ask for an AC_PROG_CC use...
-
-
-# _AM_DEPENDENCIES(NAME)
-# ----------------------
-# See how the compiler implements dependency checking.
-# NAME is "CC", "CXX", "GCJ", or "OBJC".
-# We try a few techniques and use that to set a single cache variable.
-#
-# We don't AC_REQUIRE the corresponding AC_PROG_CC since the latter was
-# modified to invoke _AM_DEPENDENCIES(CC); we would have a circular
-# dependency, and given that the user is not expected to run this macro,
-# just rely on AC_PROG_CC.
-AC_DEFUN([_AM_DEPENDENCIES],
-[AC_REQUIRE([AM_SET_DEPDIR])dnl
-AC_REQUIRE([AM_OUTPUT_DEPENDENCY_COMMANDS])dnl
-AC_REQUIRE([AM_MAKE_INCLUDE])dnl
-AC_REQUIRE([AM_DEP_TRACK])dnl
-
-ifelse([$1], CC,   [depcc="$CC"   am_compiler_list=],
-       [$1], CXX,  [depcc="$CXX"  am_compiler_list=],
-       [$1], OBJC, [depcc="$OBJC" am_compiler_list='gcc3 gcc'],
-       [$1], UPC,  [depcc="$UPC"  am_compiler_list=],
-       [$1], GCJ,  [depcc="$GCJ"  am_compiler_list='gcc3 gcc'],
-                   [depcc="$$1"   am_compiler_list=])
-
-AC_CACHE_CHECK([dependency style of $depcc],
-               [am_cv_$1_dependencies_compiler_type],
-[if test -z "$AMDEP_TRUE" && test -f "$am_depcomp"; then
-  # We make a subdir and do the tests there.  Otherwise we can end up
-  # making bogus files that we don't know about and never remove.  For
-  # instance it was reported that on HP-UX the gcc test will end up
-  # making a dummy file named `D' -- because `-MD' means `put the output
-  # in D'.
-  mkdir conftest.dir
-  # Copy depcomp to subdir because otherwise we won't find it if we're
-  # using a relative directory.
-  cp "$am_depcomp" conftest.dir
-  cd conftest.dir
-  # We will build objects and dependencies in a subdirectory because
-  # it helps to detect inapplicable dependency modes.  For instance
-  # both Tru64's cc and ICC support -MD to output dependencies as a
-  # side effect of compilation, but ICC will put the dependencies in
-  # the current directory while Tru64 will put them in the object
-  # directory.
-  mkdir sub
-
-  am_cv_$1_dependencies_compiler_type=none
-  if test "$am_compiler_list" = ""; then
-     am_compiler_list=`sed -n ['s/^#*\([a-zA-Z0-9]*\))$/\1/p'] < ./depcomp`
-  fi
-  am__universal=false
-  m4_case([$1], [CC],
-    [case " $depcc " in #(
-     *\ -arch\ *\ -arch\ *) am__universal=true ;;
-     esac],
-    [CXX],
-    [case " $depcc " in #(
-     *\ -arch\ *\ -arch\ *) am__universal=true ;;
-     esac])
-
-  for depmode in $am_compiler_list; do
-    # Setup a source with many dependencies, because some compilers
-    # like to wrap large dependency lists on column 80 (with \), and
-    # we should not choose a depcomp mode which is confused by this.
-    #
-    # We need to recreate these files for each test, as the compiler may
-    # overwrite some of them when testing with obscure command lines.
-    # This happens at least with the AIX C compiler.
-    : > sub/conftest.c
-    for i in 1 2 3 4 5 6; do
-      echo '#include "conftst'$i'.h"' >> sub/conftest.c
-      # Using `: > sub/conftst$i.h' creates only sub/conftst1.h with
-      # Solaris 8's {/usr,}/bin/sh.
-      touch sub/conftst$i.h
-    done
-    echo "${am__include} ${am__quote}sub/conftest.Po${am__quote}" > confmf
-
-    # We check with `-c' and `-o' for the sake of the "dashmstdout"
-    # mode.  It turns out that the SunPro C++ compiler does not properly
-    # handle `-M -o', and we need to detect this.  Also, some Intel
-    # versions had trouble with output in subdirs
-    am__obj=sub/conftest.${OBJEXT-o}
-    am__minus_obj="-o $am__obj"
-    case $depmode in
-    gcc)
-      # This depmode causes a compiler race in universal mode.
-      test "$am__universal" = false || continue
-      ;;
-    nosideeffect)
-      # after this tag, mechanisms are not by side-effect, so they'll
-      # only be used when explicitly requested
-      if test "x$enable_dependency_tracking" = xyes; then
-	continue
-      else
-	break
-      fi
-      ;;
-    msvisualcpp | msvcmsys)
-      # This compiler won't grok `-c -o', but also, the minuso test has
-      # not run yet.  These depmodes are late enough in the game, and
-      # so weak that their functioning should not be impacted.
-      am__obj=conftest.${OBJEXT-o}
-      am__minus_obj=
-      ;;
-    none) break ;;
-    esac
-    if depmode=$depmode \
-       source=sub/conftest.c object=$am__obj \
-       depfile=sub/conftest.Po tmpdepfile=sub/conftest.TPo \
-       $SHELL ./depcomp $depcc -c $am__minus_obj sub/conftest.c \
-         >/dev/null 2>conftest.err &&
-       grep sub/conftst1.h sub/conftest.Po > /dev/null 2>&1 &&
-       grep sub/conftst6.h sub/conftest.Po > /dev/null 2>&1 &&
-       grep $am__obj sub/conftest.Po > /dev/null 2>&1 &&
-       ${MAKE-make} -s -f confmf > /dev/null 2>&1; then
-      # icc doesn't choke on unknown options, it will just issue warnings
-      # or remarks (even with -Werror).  So we grep stderr for any message
-      # that says an option was ignored or not supported.
-      # When given -MP, icc 7.0 and 7.1 complain thusly:
-      #   icc: Command line warning: ignoring option '-M'; no argument required
-      # The diagnosis changed in icc 8.0:
-      #   icc: Command line remark: option '-MP' not supported
-      if (grep 'ignoring option' conftest.err ||
-          grep 'not supported' conftest.err) >/dev/null 2>&1; then :; else
-        am_cv_$1_dependencies_compiler_type=$depmode
-        break
-      fi
-    fi
-  done
-
-  cd ..
-  rm -rf conftest.dir
-else
-  am_cv_$1_dependencies_compiler_type=none
-fi
-])
-AC_SUBST([$1DEPMODE], [depmode=$am_cv_$1_dependencies_compiler_type])
-AM_CONDITIONAL([am__fastdep$1], [
-  test "x$enable_dependency_tracking" != xno \
-  && test "$am_cv_$1_dependencies_compiler_type" = gcc3])
-])
-
-
-# AM_SET_DEPDIR
-# -------------
-# Choose a directory name for dependency files.
-# This macro is AC_REQUIREd in _AM_DEPENDENCIES
-AC_DEFUN([AM_SET_DEPDIR],
-[AC_REQUIRE([AM_SET_LEADING_DOT])dnl
-AC_SUBST([DEPDIR], ["${am__leading_dot}deps"])dnl
-])
-
-
-# AM_DEP_TRACK
-# ------------
-AC_DEFUN([AM_DEP_TRACK],
-[AC_ARG_ENABLE(dependency-tracking,
-[  --disable-dependency-tracking  speeds up one-time build
-  --enable-dependency-tracking   do not reject slow dependency extractors])
-if test "x$enable_dependency_tracking" != xno; then
-  am_depcomp="$ac_aux_dir/depcomp"
-  AMDEPBACKSLASH='\'
-fi
-AM_CONDITIONAL([AMDEP], [test "x$enable_dependency_tracking" != xno])
-AC_SUBST([AMDEPBACKSLASH])dnl
-_AM_SUBST_NOTMAKE([AMDEPBACKSLASH])dnl
-])
-
-# Generate code to set up dependency tracking.              -*- Autoconf -*-
-
-# Copyright (C) 1999, 2000, 2001, 2002, 2003, 2004, 2005, 2008
-# Free Software Foundation, Inc.
-#
-# This file is free software; the Free Software Foundation
-# gives unlimited permission to copy and/or distribute it,
-# with or without modifications, as long as this notice is preserved.
-
-#serial 5
-
-# _AM_OUTPUT_DEPENDENCY_COMMANDS
-# ------------------------------
-AC_DEFUN([_AM_OUTPUT_DEPENDENCY_COMMANDS],
-[{
-  # Autoconf 2.62 quotes --file arguments for eval, but not when files
-  # are listed without --file.  Let's play safe and only enable the eval
-  # if we detect the quoting.
-  case $CONFIG_FILES in
-  *\'*) eval set x "$CONFIG_FILES" ;;
-  *)   set x $CONFIG_FILES ;;
-  esac
-  shift
-  for mf
-  do
-    # Strip MF so we end up with the name of the file.
-    mf=`echo "$mf" | sed -e 's/:.*$//'`
-    # Check whether this is an Automake generated Makefile or not.
-    # We used to match only the files named `Makefile.in', but
-    # some people rename them; so instead we look at the file content.
-    # Grep'ing the first line is not enough: some people post-process
-    # each Makefile.in and add a new line on top of each file to say so.
-    # Grep'ing the whole file is not good either: AIX grep has a line
-    # limit of 2048, but all sed's we know have understand at least 4000.
-    if sed -n 's,^#.*generated by automake.*,X,p' "$mf" | grep X >/dev/null 2>&1; then
-      dirpart=`AS_DIRNAME("$mf")`
-    else
-      continue
-    fi
-    # Extract the definition of DEPDIR, am__include, and am__quote
-    # from the Makefile without running `make'.
-    DEPDIR=`sed -n 's/^DEPDIR = //p' < "$mf"`
-    test -z "$DEPDIR" && continue
-    am__include=`sed -n 's/^am__include = //p' < "$mf"`
-    test -z "am__include" && continue
-    am__quote=`sed -n 's/^am__quote = //p' < "$mf"`
-    # When using ansi2knr, U may be empty or an underscore; expand it
-    U=`sed -n 's/^U = //p' < "$mf"`
-    # Find all dependency output files, they are included files with
-    # $(DEPDIR) in their names.  We invoke sed twice because it is the
-    # simplest approach to changing $(DEPDIR) to its actual value in the
-    # expansion.
-    for file in `sed -n "
-      s/^$am__include $am__quote\(.*(DEPDIR).*\)$am__quote"'$/\1/p' <"$mf" | \
-	 sed -e 's/\$(DEPDIR)/'"$DEPDIR"'/g' -e 's/\$U/'"$U"'/g'`; do
-      # Make sure the directory exists.
-      test -f "$dirpart/$file" && continue
-      fdir=`AS_DIRNAME(["$file"])`
-      AS_MKDIR_P([$dirpart/$fdir])
-      # echo "creating $dirpart/$file"
-      echo '# dummy' > "$dirpart/$file"
-    done
-  done
-}
-])# _AM_OUTPUT_DEPENDENCY_COMMANDS
-
-
-# AM_OUTPUT_DEPENDENCY_COMMANDS
-# -----------------------------
-# This macro should only be invoked once -- use via AC_REQUIRE.
-#
-# This code is only required when automatic dependency tracking
-# is enabled.  FIXME.  This creates each `.P' file that we will
-# need in order to bootstrap the dependency handling code.
-AC_DEFUN([AM_OUTPUT_DEPENDENCY_COMMANDS],
-[AC_CONFIG_COMMANDS([depfiles],
-     [test x"$AMDEP_TRUE" != x"" || _AM_OUTPUT_DEPENDENCY_COMMANDS],
-     [AMDEP_TRUE="$AMDEP_TRUE" ac_aux_dir="$ac_aux_dir"])
-])
-
-# Copyright (C) 1996, 1997, 2000, 2001, 2003, 2005
-# Free Software Foundation, Inc.
-#
-# This file is free software; the Free Software Foundation
-# gives unlimited permission to copy and/or distribute it,
-# with or without modifications, as long as this notice is preserved.
-
-# serial 8
-
-# AM_CONFIG_HEADER is obsolete.  It has been replaced by AC_CONFIG_HEADERS.
-AU_DEFUN([AM_CONFIG_HEADER], [AC_CONFIG_HEADERS($@)])
-
-# Do all the work for Automake.                             -*- Autoconf -*-
-
-# Copyright (C) 1996, 1997, 1998, 1999, 2000, 2001, 2002, 2003, 2004,
-# 2005, 2006, 2008, 2009 Free Software Foundation, Inc.
-#
-# This file is free software; the Free Software Foundation
-# gives unlimited permission to copy and/or distribute it,
-# with or without modifications, as long as this notice is preserved.
-
-# serial 16
-
-# This macro actually does too much.  Some checks are only needed if
-# your package does certain things.  But this isn't really a big deal.
-
-# AM_INIT_AUTOMAKE(PACKAGE, VERSION, [NO-DEFINE])
-# AM_INIT_AUTOMAKE([OPTIONS])
-# -----------------------------------------------
-# The call with PACKAGE and VERSION arguments is the old style
-# call (pre autoconf-2.50), which is being phased out.  PACKAGE
-# and VERSION should now be passed to AC_INIT and removed from
-# the call to AM_INIT_AUTOMAKE.
-# We support both call styles for the transition.  After
-# the next Automake release, Autoconf can make the AC_INIT
-# arguments mandatory, and then we can depend on a new Autoconf
-# release and drop the old call support.
-AC_DEFUN([AM_INIT_AUTOMAKE],
-[AC_PREREQ([2.62])dnl
-dnl Autoconf wants to disallow AM_ names.  We explicitly allow
-dnl the ones we care about.
-m4_pattern_allow([^AM_[A-Z]+FLAGS$])dnl
-AC_REQUIRE([AM_SET_CURRENT_AUTOMAKE_VERSION])dnl
-AC_REQUIRE([AC_PROG_INSTALL])dnl
-if test "`cd $srcdir && pwd`" != "`pwd`"; then
-  # Use -I$(srcdir) only when $(srcdir) != ., so that make's output
-  # is not polluted with repeated "-I."
-  AC_SUBST([am__isrc], [' -I$(srcdir)'])_AM_SUBST_NOTMAKE([am__isrc])dnl
-  # test to see if srcdir already configured
-  if test -f $srcdir/config.status; then
-    AC_MSG_ERROR([source directory already configured; run "make distclean" there first])
-  fi
-fi
-
-# test whether we have cygpath
-if test -z "$CYGPATH_W"; then
-  if (cygpath --version) >/dev/null 2>/dev/null; then
-    CYGPATH_W='cygpath -w'
-  else
-    CYGPATH_W=echo
-  fi
-fi
-AC_SUBST([CYGPATH_W])
-
-# Define the identity of the package.
-dnl Distinguish between old-style and new-style calls.
-m4_ifval([$2],
-[m4_ifval([$3], [_AM_SET_OPTION([no-define])])dnl
- AC_SUBST([PACKAGE], [$1])dnl
- AC_SUBST([VERSION], [$2])],
-[_AM_SET_OPTIONS([$1])dnl
-dnl Diagnose old-style AC_INIT with new-style AM_AUTOMAKE_INIT.
-m4_if(m4_ifdef([AC_PACKAGE_NAME], 1)m4_ifdef([AC_PACKAGE_VERSION], 1), 11,,
-  [m4_fatal([AC_INIT should be called with package and version arguments])])dnl
- AC_SUBST([PACKAGE], ['AC_PACKAGE_TARNAME'])dnl
- AC_SUBST([VERSION], ['AC_PACKAGE_VERSION'])])dnl
-
-_AM_IF_OPTION([no-define],,
-[AC_DEFINE_UNQUOTED(PACKAGE, "$PACKAGE", [Name of package])
- AC_DEFINE_UNQUOTED(VERSION, "$VERSION", [Version number of package])])dnl
-
-# Some tools Automake needs.
-AC_REQUIRE([AM_SANITY_CHECK])dnl
-AC_REQUIRE([AC_ARG_PROGRAM])dnl
-AM_MISSING_PROG(ACLOCAL, aclocal-${am__api_version})
-AM_MISSING_PROG(AUTOCONF, autoconf)
-AM_MISSING_PROG(AUTOMAKE, automake-${am__api_version})
-AM_MISSING_PROG(AUTOHEADER, autoheader)
-AM_MISSING_PROG(MAKEINFO, makeinfo)
-AC_REQUIRE([AM_PROG_INSTALL_SH])dnl
-AC_REQUIRE([AM_PROG_INSTALL_STRIP])dnl
-AC_REQUIRE([AM_PROG_MKDIR_P])dnl
-# We need awk for the "check" target.  The system "awk" is bad on
-# some platforms.
-AC_REQUIRE([AC_PROG_AWK])dnl
-AC_REQUIRE([AC_PROG_MAKE_SET])dnl
-AC_REQUIRE([AM_SET_LEADING_DOT])dnl
-_AM_IF_OPTION([tar-ustar], [_AM_PROG_TAR([ustar])],
-	      [_AM_IF_OPTION([tar-pax], [_AM_PROG_TAR([pax])],
-			     [_AM_PROG_TAR([v7])])])
-_AM_IF_OPTION([no-dependencies],,
-[AC_PROVIDE_IFELSE([AC_PROG_CC],
-		  [_AM_DEPENDENCIES(CC)],
-		  [define([AC_PROG_CC],
-			  defn([AC_PROG_CC])[_AM_DEPENDENCIES(CC)])])dnl
-AC_PROVIDE_IFELSE([AC_PROG_CXX],
-		  [_AM_DEPENDENCIES(CXX)],
-		  [define([AC_PROG_CXX],
-			  defn([AC_PROG_CXX])[_AM_DEPENDENCIES(CXX)])])dnl
-AC_PROVIDE_IFELSE([AC_PROG_OBJC],
-		  [_AM_DEPENDENCIES(OBJC)],
-		  [define([AC_PROG_OBJC],
-			  defn([AC_PROG_OBJC])[_AM_DEPENDENCIES(OBJC)])])dnl
-])
-_AM_IF_OPTION([silent-rules], [AC_REQUIRE([AM_SILENT_RULES])])dnl
-dnl The `parallel-tests' driver may need to know about EXEEXT, so add the
-dnl `am__EXEEXT' conditional if _AM_COMPILER_EXEEXT was seen.  This macro
-dnl is hooked onto _AC_COMPILER_EXEEXT early, see below.
-AC_CONFIG_COMMANDS_PRE(dnl
-[m4_provide_if([_AM_COMPILER_EXEEXT],
-  [AM_CONDITIONAL([am__EXEEXT], [test -n "$EXEEXT"])])])dnl
-])
-
-dnl Hook into `_AC_COMPILER_EXEEXT' early to learn its expansion.  Do not
-dnl add the conditional right here, as _AC_COMPILER_EXEEXT may be further
-dnl mangled by Autoconf and run in a shell conditional statement.
-m4_define([_AC_COMPILER_EXEEXT],
-m4_defn([_AC_COMPILER_EXEEXT])[m4_provide([_AM_COMPILER_EXEEXT])])
-
-
-# When config.status generates a header, we must update the stamp-h file.
-# This file resides in the same directory as the config header
-# that is generated.  The stamp files are numbered to have different names.
-
-# Autoconf calls _AC_AM_CONFIG_HEADER_HOOK (when defined) in the
-# loop where config.status creates the headers, so we can generate
-# our stamp files there.
-AC_DEFUN([_AC_AM_CONFIG_HEADER_HOOK],
-[# Compute $1's index in $config_headers.
-_am_arg=$1
-_am_stamp_count=1
-for _am_header in $config_headers :; do
-  case $_am_header in
-    $_am_arg | $_am_arg:* )
-      break ;;
-    * )
-      _am_stamp_count=`expr $_am_stamp_count + 1` ;;
-  esac
-done
-echo "timestamp for $_am_arg" >`AS_DIRNAME(["$_am_arg"])`/stamp-h[]$_am_stamp_count])
-
-# Copyright (C) 2001, 2003, 2005, 2008  Free Software Foundation, Inc.
-#
-# This file is free software; the Free Software Foundation
-# gives unlimited permission to copy and/or distribute it,
-# with or without modifications, as long as this notice is preserved.
-
-# AM_PROG_INSTALL_SH
-# ------------------
-# Define $install_sh.
-AC_DEFUN([AM_PROG_INSTALL_SH],
-[AC_REQUIRE([AM_AUX_DIR_EXPAND])dnl
-if test x"${install_sh}" != xset; then
-  case $am_aux_dir in
-  *\ * | *\	*)
-    install_sh="\${SHELL} '$am_aux_dir/install-sh'" ;;
-  *)
-    install_sh="\${SHELL} $am_aux_dir/install-sh"
-  esac
-fi
-AC_SUBST(install_sh)])
-
-# Copyright (C) 2003, 2005  Free Software Foundation, Inc.
-#
-# This file is free software; the Free Software Foundation
-# gives unlimited permission to copy and/or distribute it,
-# with or without modifications, as long as this notice is preserved.
-
-# serial 2
-
-# Check whether the underlying file-system supports filenames
-# with a leading dot.  For instance MS-DOS doesn't.
-AC_DEFUN([AM_SET_LEADING_DOT],
-[rm -rf .tst 2>/dev/null
-mkdir .tst 2>/dev/null
-if test -d .tst; then
-  am__leading_dot=.
-else
-  am__leading_dot=_
-fi
-rmdir .tst 2>/dev/null
-AC_SUBST([am__leading_dot])])
-
-# Check to see how 'make' treats includes.	            -*- Autoconf -*-
-
-# Copyright (C) 2001, 2002, 2003, 2005, 2009  Free Software Foundation, Inc.
-#
-# This file is free software; the Free Software Foundation
-# gives unlimited permission to copy and/or distribute it,
-# with or without modifications, as long as this notice is preserved.
-
-# serial 4
-
-# AM_MAKE_INCLUDE()
-# -----------------
-# Check to see how make treats includes.
-AC_DEFUN([AM_MAKE_INCLUDE],
-[am_make=${MAKE-make}
-cat > confinc << 'END'
-am__doit:
-	@echo this is the am__doit target
-.PHONY: am__doit
-END
-# If we don't find an include directive, just comment out the code.
-AC_MSG_CHECKING([for style of include used by $am_make])
-am__include="#"
-am__quote=
-_am_result=none
-# First try GNU make style include.
-echo "include confinc" > confmf
-# Ignore all kinds of additional output from `make'.
-case `$am_make -s -f confmf 2> /dev/null` in #(
-*the\ am__doit\ target*)
-  am__include=include
-  am__quote=
-  _am_result=GNU
-  ;;
-esac
-# Now try BSD make style include.
-if test "$am__include" = "#"; then
-   echo '.include "confinc"' > confmf
-   case `$am_make -s -f confmf 2> /dev/null` in #(
-   *the\ am__doit\ target*)
-     am__include=.include
-     am__quote="\""
-     _am_result=BSD
-     ;;
-   esac
-fi
-AC_SUBST([am__include])
-AC_SUBST([am__quote])
-AC_MSG_RESULT([$_am_result])
-rm -f confinc confmf
-])
-
-# Fake the existence of programs that GNU maintainers use.  -*- Autoconf -*-
-
-# Copyright (C) 1997, 1999, 2000, 2001, 2003, 2004, 2005, 2008
-# Free Software Foundation, Inc.
-#
-# This file is free software; the Free Software Foundation
-# gives unlimited permission to copy and/or distribute it,
-# with or without modifications, as long as this notice is preserved.
-
-# serial 6
-
-# AM_MISSING_PROG(NAME, PROGRAM)
-# ------------------------------
-AC_DEFUN([AM_MISSING_PROG],
-[AC_REQUIRE([AM_MISSING_HAS_RUN])
-$1=${$1-"${am_missing_run}$2"}
-AC_SUBST($1)])
-
-
-# AM_MISSING_HAS_RUN
-# ------------------
-# Define MISSING if not defined so far and test if it supports --run.
-# If it does, set am_missing_run to use it, otherwise, to nothing.
-AC_DEFUN([AM_MISSING_HAS_RUN],
-[AC_REQUIRE([AM_AUX_DIR_EXPAND])dnl
-AC_REQUIRE_AUX_FILE([missing])dnl
-if test x"${MISSING+set}" != xset; then
-  case $am_aux_dir in
-  *\ * | *\	*)
-    MISSING="\${SHELL} \"$am_aux_dir/missing\"" ;;
-  *)
-    MISSING="\${SHELL} $am_aux_dir/missing" ;;
-  esac
-fi
-# Use eval to expand $SHELL
-if eval "$MISSING --run true"; then
-  am_missing_run="$MISSING --run "
-else
-  am_missing_run=
-  AC_MSG_WARN([`missing' script is too old or missing])
-fi
-])
-
-# Copyright (C) 2003, 2004, 2005, 2006  Free Software Foundation, Inc.
-#
-# This file is free software; the Free Software Foundation
-# gives unlimited permission to copy and/or distribute it,
-# with or without modifications, as long as this notice is preserved.
-
-# AM_PROG_MKDIR_P
-# ---------------
-# Check for `mkdir -p'.
-AC_DEFUN([AM_PROG_MKDIR_P],
-[AC_PREREQ([2.60])dnl
-AC_REQUIRE([AC_PROG_MKDIR_P])dnl
-dnl Automake 1.8 to 1.9.6 used to define mkdir_p.  We now use MKDIR_P,
-dnl while keeping a definition of mkdir_p for backward compatibility.
-dnl @MKDIR_P@ is magic: AC_OUTPUT adjusts its value for each Makefile.
-dnl However we cannot define mkdir_p as $(MKDIR_P) for the sake of
-dnl Makefile.ins that do not define MKDIR_P, so we do our own
-dnl adjustment using top_builddir (which is defined more often than
-dnl MKDIR_P).
-AC_SUBST([mkdir_p], ["$MKDIR_P"])dnl
-case $mkdir_p in
-  [[\\/$]]* | ?:[[\\/]]*) ;;
-  */*) mkdir_p="\$(top_builddir)/$mkdir_p" ;;
-esac
-])
-
-# Helper functions for option handling.                     -*- Autoconf -*-
-
-# Copyright (C) 2001, 2002, 2003, 2005, 2008  Free Software Foundation, Inc.
-#
-# This file is free software; the Free Software Foundation
-# gives unlimited permission to copy and/or distribute it,
-# with or without modifications, as long as this notice is preserved.
-
-# serial 4
-
-# _AM_MANGLE_OPTION(NAME)
-# -----------------------
-AC_DEFUN([_AM_MANGLE_OPTION],
-[[_AM_OPTION_]m4_bpatsubst($1, [[^a-zA-Z0-9_]], [_])])
-
-# _AM_SET_OPTION(NAME)
-# ------------------------------
-# Set option NAME.  Presently that only means defining a flag for this option.
-AC_DEFUN([_AM_SET_OPTION],
-[m4_define(_AM_MANGLE_OPTION([$1]), 1)])
-
-# _AM_SET_OPTIONS(OPTIONS)
-# ----------------------------------
-# OPTIONS is a space-separated list of Automake options.
-AC_DEFUN([_AM_SET_OPTIONS],
-[m4_foreach_w([_AM_Option], [$1], [_AM_SET_OPTION(_AM_Option)])])
-
-# _AM_IF_OPTION(OPTION, IF-SET, [IF-NOT-SET])
-# -------------------------------------------
-# Execute IF-SET if OPTION is set, IF-NOT-SET otherwise.
-AC_DEFUN([_AM_IF_OPTION],
-[m4_ifset(_AM_MANGLE_OPTION([$1]), [$2], [$3])])
-
-# Check to make sure that the build environment is sane.    -*- Autoconf -*-
-
-# Copyright (C) 1996, 1997, 2000, 2001, 2003, 2005, 2008
-# Free Software Foundation, Inc.
-#
-# This file is free software; the Free Software Foundation
-# gives unlimited permission to copy and/or distribute it,
-# with or without modifications, as long as this notice is preserved.
-
-# serial 5
-
-# AM_SANITY_CHECK
-# ---------------
-AC_DEFUN([AM_SANITY_CHECK],
-[AC_MSG_CHECKING([whether build environment is sane])
-# Just in case
-sleep 1
-echo timestamp > conftest.file
-# Reject unsafe characters in $srcdir or the absolute working directory
-# name.  Accept space and tab only in the latter.
-am_lf='
-'
-case `pwd` in
-  *[[\\\"\#\$\&\'\`$am_lf]]*)
-    AC_MSG_ERROR([unsafe absolute working directory name]);;
-esac
-case $srcdir in
-  *[[\\\"\#\$\&\'\`$am_lf\ \	]]*)
-    AC_MSG_ERROR([unsafe srcdir value: `$srcdir']);;
-esac
-
-# Do `set' in a subshell so we don't clobber the current shell's
-# arguments.  Must try -L first in case configure is actually a
-# symlink; some systems play weird games with the mod time of symlinks
-# (eg FreeBSD returns the mod time of the symlink's containing
-# directory).
-if (
-   set X `ls -Lt "$srcdir/configure" conftest.file 2> /dev/null`
-   if test "$[*]" = "X"; then
-      # -L didn't work.
-      set X `ls -t "$srcdir/configure" conftest.file`
-   fi
-   rm -f conftest.file
-   if test "$[*]" != "X $srcdir/configure conftest.file" \
-      && test "$[*]" != "X conftest.file $srcdir/configure"; then
-
-      # If neither matched, then we have a broken ls.  This can happen
-      # if, for instance, CONFIG_SHELL is bash and it inherits a
-      # broken ls alias from the environment.  This has actually
-      # happened.  Such a system could not be considered "sane".
-      AC_MSG_ERROR([ls -t appears to fail.  Make sure there is not a broken
-alias in your environment])
-   fi
-
-   test "$[2]" = conftest.file
-   )
-then
-   # Ok.
-   :
-else
-   AC_MSG_ERROR([newly created file is older than distributed files!
-Check your system clock])
-fi
-AC_MSG_RESULT(yes)])
-
-# Copyright (C) 2001, 2003, 2005  Free Software Foundation, Inc.
-#
-# This file is free software; the Free Software Foundation
-# gives unlimited permission to copy and/or distribute it,
-# with or without modifications, as long as this notice is preserved.
-
-# AM_PROG_INSTALL_STRIP
-# ---------------------
-# One issue with vendor `install' (even GNU) is that you can't
-# specify the program used to strip binaries.  This is especially
-# annoying in cross-compiling environments, where the build's strip
-# is unlikely to handle the host's binaries.
-# Fortunately install-sh will honor a STRIPPROG variable, so we
-# always use install-sh in `make install-strip', and initialize
-# STRIPPROG with the value of the STRIP variable (set by the user).
-AC_DEFUN([AM_PROG_INSTALL_STRIP],
-[AC_REQUIRE([AM_PROG_INSTALL_SH])dnl
-# Installed binaries are usually stripped using `strip' when the user
-# run `make install-strip'.  However `strip' might not be the right
-# tool to use in cross-compilation environments, therefore Automake
-# will honor the `STRIP' environment variable to overrule this program.
-dnl Don't test for $cross_compiling = yes, because it might be `maybe'.
-if test "$cross_compiling" != no; then
-  AC_CHECK_TOOL([STRIP], [strip], :)
-fi
-INSTALL_STRIP_PROGRAM="\$(install_sh) -c -s"
-AC_SUBST([INSTALL_STRIP_PROGRAM])])
-
-# Copyright (C) 2006, 2008  Free Software Foundation, Inc.
-#
-# This file is free software; the Free Software Foundation
-# gives unlimited permission to copy and/or distribute it,
-# with or without modifications, as long as this notice is preserved.
-
-# serial 2
-
-# _AM_SUBST_NOTMAKE(VARIABLE)
-# ---------------------------
-# Prevent Automake from outputting VARIABLE = @VARIABLE@ in Makefile.in.
-# This macro is traced by Automake.
-AC_DEFUN([_AM_SUBST_NOTMAKE])
-
-# AM_SUBST_NOTMAKE(VARIABLE)
-# ---------------------------
-# Public sister of _AM_SUBST_NOTMAKE.
-AC_DEFUN([AM_SUBST_NOTMAKE], [_AM_SUBST_NOTMAKE($@)])
-
-# Check how to create a tarball.                            -*- Autoconf -*-
-
-# Copyright (C) 2004, 2005  Free Software Foundation, Inc.
-#
-# This file is free software; the Free Software Foundation
-# gives unlimited permission to copy and/or distribute it,
-# with or without modifications, as long as this notice is preserved.
-
-# serial 2
-
-# _AM_PROG_TAR(FORMAT)
-# --------------------
-# Check how to create a tarball in format FORMAT.
-# FORMAT should be one of `v7', `ustar', or `pax'.
-#
-# Substitute a variable $(am__tar) that is a command
-# writing to stdout a FORMAT-tarball containing the directory
-# $tardir.
-#     tardir=directory && $(am__tar) > result.tar
-#
-# Substitute a variable $(am__untar) that extract such
-# a tarball read from stdin.
-#     $(am__untar) < result.tar
-AC_DEFUN([_AM_PROG_TAR],
-[# Always define AMTAR for backward compatibility.
-AM_MISSING_PROG([AMTAR], [tar])
-m4_if([$1], [v7],
-     [am__tar='${AMTAR} chof - "$$tardir"'; am__untar='${AMTAR} xf -'],
-     [m4_case([$1], [ustar],, [pax],,
-              [m4_fatal([Unknown tar format])])
-AC_MSG_CHECKING([how to create a $1 tar archive])
-# Loop over all known methods to create a tar archive until one works.
-_am_tools='gnutar m4_if([$1], [ustar], [plaintar]) pax cpio none'
-_am_tools=${am_cv_prog_tar_$1-$_am_tools}
-# Do not fold the above two line into one, because Tru64 sh and
-# Solaris sh will not grok spaces in the rhs of `-'.
-for _am_tool in $_am_tools
-do
-  case $_am_tool in
-  gnutar)
-    for _am_tar in tar gnutar gtar;
-    do
-      AM_RUN_LOG([$_am_tar --version]) && break
-    done
-    am__tar="$_am_tar --format=m4_if([$1], [pax], [posix], [$1]) -chf - "'"$$tardir"'
-    am__tar_="$_am_tar --format=m4_if([$1], [pax], [posix], [$1]) -chf - "'"$tardir"'
-    am__untar="$_am_tar -xf -"
-    ;;
-  plaintar)
-    # Must skip GNU tar: if it does not support --format= it doesn't create
-    # ustar tarball either.
-    (tar --version) >/dev/null 2>&1 && continue
-    am__tar='tar chf - "$$tardir"'
-    am__tar_='tar chf - "$tardir"'
-    am__untar='tar xf -'
-    ;;
-  pax)
-    am__tar='pax -L -x $1 -w "$$tardir"'
-    am__tar_='pax -L -x $1 -w "$tardir"'
-    am__untar='pax -r'
-    ;;
-  cpio)
-    am__tar='find "$$tardir" -print | cpio -o -H $1 -L'
-    am__tar_='find "$tardir" -print | cpio -o -H $1 -L'
-    am__untar='cpio -i -H $1 -d'
-    ;;
-  none)
-    am__tar=false
-    am__tar_=false
-    am__untar=false
-    ;;
-  esac
-
-  # If the value was cached, stop now.  We just wanted to have am__tar
-  # and am__untar set.
-  test -n "${am_cv_prog_tar_$1}" && break
-
-  # tar/untar a dummy directory, and stop if the command works
-  rm -rf conftest.dir
-  mkdir conftest.dir
-  echo GrepMe > conftest.dir/file
-  AM_RUN_LOG([tardir=conftest.dir && eval $am__tar_ >conftest.tar])
-  rm -rf conftest.dir
-  if test -s conftest.tar; then
-    AM_RUN_LOG([$am__untar <conftest.tar])
-    grep GrepMe conftest.dir/file >/dev/null 2>&1 && break
-  fi
-done
-rm -rf conftest.dir
-
-AC_CACHE_VAL([am_cv_prog_tar_$1], [am_cv_prog_tar_$1=$_am_tool])
-AC_MSG_RESULT([$am_cv_prog_tar_$1])])
-AC_SUBST([am__tar])
-AC_SUBST([am__untar])
-]) # _AM_PROG_TAR
-
-m4_include([acinclude.m4])
diff -Nur dosbox-0.74/config.guess dosbox-0.74.patch/config.guess
--- dosbox-0.74/config.guess	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/config.guess	1970-01-01 01:00:00.000000000 +0100
@@ -1,1502 +0,0 @@
-#! /bin/sh
-# Attempt to guess a canonical system name.
-#   Copyright (C) 1992, 1993, 1994, 1995, 1996, 1997, 1998, 1999,
-#   2000, 2001, 2002, 2003, 2004, 2005, 2006, 2007, 2008, 2009, 2010
-#   Free Software Foundation, Inc.
-
-timestamp='2009-12-30'
-
-# This file is free software; you can redistribute it and/or modify it
-# under the terms of the GNU General Public License as published by
-# the Free Software Foundation; either version 2 of the License, or
-# (at your option) any later version.
-#
-# This program is distributed in the hope that it will be useful, but
-# WITHOUT ANY WARRANTY; without even the implied warranty of
-# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
-# General Public License for more details.
-#
-# You should have received a copy of the GNU General Public License
-# along with this program; if not, write to the Free Software
-# Foundation, Inc., 51 Franklin Street - Fifth Floor, Boston, MA
-# 02110-1301, USA.
-#
-# As a special exception to the GNU General Public License, if you
-# distribute this file as part of a program that contains a
-# configuration script generated by Autoconf, you may include it under
-# the same distribution terms that you use for the rest of that program.
-
-
-# Originally written by Per Bothner.  Please send patches (context
-# diff format) to <config-patches@gnu.org> and include a ChangeLog
-# entry.
-#
-# This script attempts to guess a canonical system name similar to
-# config.sub.  If it succeeds, it prints the system name on stdout, and
-# exits with 0.  Otherwise, it exits with 1.
-#
-# You can get the latest version of this script from:
-# http://git.savannah.gnu.org/gitweb/?p=config.git;a=blob_plain;f=config.guess;hb=HEAD
-
-me=`echo "$0" | sed -e 's,.*/,,'`
-
-usage="\
-Usage: $0 [OPTION]
-
-Output the configuration name of the system \`$me' is run on.
-
-Operation modes:
-  -h, --help         print this help, then exit
-  -t, --time-stamp   print date of last modification, then exit
-  -v, --version      print version number, then exit
-
-Report bugs and patches to <config-patches@gnu.org>."
-
-version="\
-GNU config.guess ($timestamp)
-
-Originally written by Per Bothner.
-Copyright (C) 1992, 1993, 1994, 1995, 1996, 1997, 1998, 1999, 2000,
-2001, 2002, 2003, 2004, 2005, 2006, 2007, 2008, 2009, 2010 Free
-Software Foundation, Inc.
-
-This is free software; see the source for copying conditions.  There is NO
-warranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE."
-
-help="
-Try \`$me --help' for more information."
-
-# Parse command line
-while test $# -gt 0 ; do
-  case $1 in
-    --time-stamp | --time* | -t )
-       echo "$timestamp" ; exit ;;
-    --version | -v )
-       echo "$version" ; exit ;;
-    --help | --h* | -h )
-       echo "$usage"; exit ;;
-    -- )     # Stop option processing
-       shift; break ;;
-    - )	# Use stdin as input.
-       break ;;
-    -* )
-       echo "$me: invalid option $1$help" >&2
-       exit 1 ;;
-    * )
-       break ;;
-  esac
-done
-
-if test $# != 0; then
-  echo "$me: too many arguments$help" >&2
-  exit 1
-fi
-
-trap 'exit 1' 1 2 15
-
-# CC_FOR_BUILD -- compiler used by this script. Note that the use of a
-# compiler to aid in system detection is discouraged as it requires
-# temporary files to be created and, as you can see below, it is a
-# headache to deal with in a portable fashion.
-
-# Historically, `CC_FOR_BUILD' used to be named `HOST_CC'. We still
-# use `HOST_CC' if defined, but it is deprecated.
-
-# Portable tmp directory creation inspired by the Autoconf team.
-
-set_cc_for_build='
-trap "exitcode=\$?; (rm -f \$tmpfiles 2>/dev/null; rmdir \$tmp 2>/dev/null) && exit \$exitcode" 0 ;
-trap "rm -f \$tmpfiles 2>/dev/null; rmdir \$tmp 2>/dev/null; exit 1" 1 2 13 15 ;
-: ${TMPDIR=/tmp} ;
- { tmp=`(umask 077 && mktemp -d "$TMPDIR/cgXXXXXX") 2>/dev/null` && test -n "$tmp" && test -d "$tmp" ; } ||
- { test -n "$RANDOM" && tmp=$TMPDIR/cg$$-$RANDOM && (umask 077 && mkdir $tmp) ; } ||
- { tmp=$TMPDIR/cg-$$ && (umask 077 && mkdir $tmp) && echo "Warning: creating insecure temp directory" >&2 ; } ||
- { echo "$me: cannot create a temporary directory in $TMPDIR" >&2 ; exit 1 ; } ;
-dummy=$tmp/dummy ;
-tmpfiles="$dummy.c $dummy.o $dummy.rel $dummy" ;
-case $CC_FOR_BUILD,$HOST_CC,$CC in
- ,,)    echo "int x;" > $dummy.c ;
-	for c in cc gcc c89 c99 ; do
-	  if ($c -c -o $dummy.o $dummy.c) >/dev/null 2>&1 ; then
-	     CC_FOR_BUILD="$c"; break ;
-	  fi ;
-	done ;
-	if test x"$CC_FOR_BUILD" = x ; then
-	  CC_FOR_BUILD=no_compiler_found ;
-	fi
-	;;
- ,,*)   CC_FOR_BUILD=$CC ;;
- ,*,*)  CC_FOR_BUILD=$HOST_CC ;;
-esac ; set_cc_for_build= ;'
-
-# This is needed to find uname on a Pyramid OSx when run in the BSD universe.
-# (ghazi@noc.rutgers.edu 1994-08-24)
-if (test -f /.attbin/uname) >/dev/null 2>&1 ; then
-	PATH=$PATH:/.attbin ; export PATH
-fi
-
-UNAME_MACHINE=`(uname -m) 2>/dev/null` || UNAME_MACHINE=unknown
-UNAME_RELEASE=`(uname -r) 2>/dev/null` || UNAME_RELEASE=unknown
-UNAME_SYSTEM=`(uname -s) 2>/dev/null`  || UNAME_SYSTEM=unknown
-UNAME_VERSION=`(uname -v) 2>/dev/null` || UNAME_VERSION=unknown
-
-# Note: order is significant - the case branches are not exclusive.
-
-case "${UNAME_MACHINE}:${UNAME_SYSTEM}:${UNAME_RELEASE}:${UNAME_VERSION}" in
-    *:NetBSD:*:*)
-	# NetBSD (nbsd) targets should (where applicable) match one or
-	# more of the tupples: *-*-netbsdelf*, *-*-netbsdaout*,
-	# *-*-netbsdecoff* and *-*-netbsd*.  For targets that recently
-	# switched to ELF, *-*-netbsd* would select the old
-	# object file format.  This provides both forward
-	# compatibility and a consistent mechanism for selecting the
-	# object file format.
-	#
-	# Note: NetBSD doesn't particularly care about the vendor
-	# portion of the name.  We always set it to "unknown".
-	sysctl="sysctl -n hw.machine_arch"
-	UNAME_MACHINE_ARCH=`(/sbin/$sysctl 2>/dev/null || \
-	    /usr/sbin/$sysctl 2>/dev/null || echo unknown)`
-	case "${UNAME_MACHINE_ARCH}" in
-	    armeb) machine=armeb-unknown ;;
-	    arm*) machine=arm-unknown ;;
-	    sh3el) machine=shl-unknown ;;
-	    sh3eb) machine=sh-unknown ;;
-	    sh5el) machine=sh5le-unknown ;;
-	    *) machine=${UNAME_MACHINE_ARCH}-unknown ;;
-	esac
-	# The Operating System including object format, if it has switched
-	# to ELF recently, or will in the future.
-	case "${UNAME_MACHINE_ARCH}" in
-	    arm*|i386|m68k|ns32k|sh3*|sparc|vax)
-		eval $set_cc_for_build
-		if echo __ELF__ | $CC_FOR_BUILD -E - 2>/dev/null \
-			| grep -q __ELF__
-		then
-		    # Once all utilities can be ECOFF (netbsdecoff) or a.out (netbsdaout).
-		    # Return netbsd for either.  FIX?
-		    os=netbsd
-		else
-		    os=netbsdelf
-		fi
-		;;
-	    *)
-	        os=netbsd
-		;;
-	esac
-	# The OS release
-	# Debian GNU/NetBSD machines have a different userland, and
-	# thus, need a distinct triplet. However, they do not need
-	# kernel version information, so it can be replaced with a
-	# suitable tag, in the style of linux-gnu.
-	case "${UNAME_VERSION}" in
-	    Debian*)
-		release='-gnu'
-		;;
-	    *)
-		release=`echo ${UNAME_RELEASE}|sed -e 's/[-_].*/\./'`
-		;;
-	esac
-	# Since CPU_TYPE-MANUFACTURER-KERNEL-OPERATING_SYSTEM:
-	# contains redundant information, the shorter form:
-	# CPU_TYPE-MANUFACTURER-OPERATING_SYSTEM is used.
-	echo "${machine}-${os}${release}"
-	exit ;;
-    *:OpenBSD:*:*)
-	UNAME_MACHINE_ARCH=`arch | sed 's/OpenBSD.//'`
-	echo ${UNAME_MACHINE_ARCH}-unknown-openbsd${UNAME_RELEASE}
-	exit ;;
-    *:ekkoBSD:*:*)
-	echo ${UNAME_MACHINE}-unknown-ekkobsd${UNAME_RELEASE}
-	exit ;;
-    *:SolidBSD:*:*)
-	echo ${UNAME_MACHINE}-unknown-solidbsd${UNAME_RELEASE}
-	exit ;;
-    macppc:MirBSD:*:*)
-	echo powerpc-unknown-mirbsd${UNAME_RELEASE}
-	exit ;;
-    *:MirBSD:*:*)
-	echo ${UNAME_MACHINE}-unknown-mirbsd${UNAME_RELEASE}
-	exit ;;
-    alpha:OSF1:*:*)
-	case $UNAME_RELEASE in
-	*4.0)
-		UNAME_RELEASE=`/usr/sbin/sizer -v | awk '{print $3}'`
-		;;
-	*5.*)
-	        UNAME_RELEASE=`/usr/sbin/sizer -v | awk '{print $4}'`
-		;;
-	esac
-	# According to Compaq, /usr/sbin/psrinfo has been available on
-	# OSF/1 and Tru64 systems produced since 1995.  I hope that
-	# covers most systems running today.  This code pipes the CPU
-	# types through head -n 1, so we only detect the type of CPU 0.
-	ALPHA_CPU_TYPE=`/usr/sbin/psrinfo -v | sed -n -e 's/^  The alpha \(.*\) processor.*$/\1/p' | head -n 1`
-	case "$ALPHA_CPU_TYPE" in
-	    "EV4 (21064)")
-		UNAME_MACHINE="alpha" ;;
-	    "EV4.5 (21064)")
-		UNAME_MACHINE="alpha" ;;
-	    "LCA4 (21066/21068)")
-		UNAME_MACHINE="alpha" ;;
-	    "EV5 (21164)")
-		UNAME_MACHINE="alphaev5" ;;
-	    "EV5.6 (21164A)")
-		UNAME_MACHINE="alphaev56" ;;
-	    "EV5.6 (21164PC)")
-		UNAME_MACHINE="alphapca56" ;;
-	    "EV5.7 (21164PC)")
-		UNAME_MACHINE="alphapca57" ;;
-	    "EV6 (21264)")
-		UNAME_MACHINE="alphaev6" ;;
-	    "EV6.7 (21264A)")
-		UNAME_MACHINE="alphaev67" ;;
-	    "EV6.8CB (21264C)")
-		UNAME_MACHINE="alphaev68" ;;
-	    "EV6.8AL (21264B)")
-		UNAME_MACHINE="alphaev68" ;;
-	    "EV6.8CX (21264D)")
-		UNAME_MACHINE="alphaev68" ;;
-	    "EV6.9A (21264/EV69A)")
-		UNAME_MACHINE="alphaev69" ;;
-	    "EV7 (21364)")
-		UNAME_MACHINE="alphaev7" ;;
-	    "EV7.9 (21364A)")
-		UNAME_MACHINE="alphaev79" ;;
-	esac
-	# A Pn.n version is a patched version.
-	# A Vn.n version is a released version.
-	# A Tn.n version is a released field test version.
-	# A Xn.n version is an unreleased experimental baselevel.
-	# 1.2 uses "1.2" for uname -r.
-	echo ${UNAME_MACHINE}-dec-osf`echo ${UNAME_RELEASE} | sed -e 's/^[PVTX]//' | tr 'ABCDEFGHIJKLMNOPQRSTUVWXYZ' 'abcdefghijklmnopqrstuvwxyz'`
-	exit ;;
-    Alpha\ *:Windows_NT*:*)
-	# How do we know it's Interix rather than the generic POSIX subsystem?
-	# Should we change UNAME_MACHINE based on the output of uname instead
-	# of the specific Alpha model?
-	echo alpha-pc-interix
-	exit ;;
-    21064:Windows_NT:50:3)
-	echo alpha-dec-winnt3.5
-	exit ;;
-    Amiga*:UNIX_System_V:4.0:*)
-	echo m68k-unknown-sysv4
-	exit ;;
-    *:[Aa]miga[Oo][Ss]:*:*)
-	echo ${UNAME_MACHINE}-unknown-amigaos
-	exit ;;
-    *:[Mm]orph[Oo][Ss]:*:*)
-	echo ${UNAME_MACHINE}-unknown-morphos
-	exit ;;
-    *:OS/390:*:*)
-	echo i370-ibm-openedition
-	exit ;;
-    *:z/VM:*:*)
-	echo s390-ibm-zvmoe
-	exit ;;
-    *:OS400:*:*)
-        echo powerpc-ibm-os400
-	exit ;;
-    arm:RISC*:1.[012]*:*|arm:riscix:1.[012]*:*)
-	echo arm-acorn-riscix${UNAME_RELEASE}
-	exit ;;
-    arm:riscos:*:*|arm:RISCOS:*:*)
-	echo arm-unknown-riscos
-	exit ;;
-    SR2?01:HI-UX/MPP:*:* | SR8000:HI-UX/MPP:*:*)
-	echo hppa1.1-hitachi-hiuxmpp
-	exit ;;
-    Pyramid*:OSx*:*:* | MIS*:OSx*:*:* | MIS*:SMP_DC-OSx*:*:*)
-	# akee@wpdis03.wpafb.af.mil (Earle F. Ake) contributed MIS and NILE.
-	if test "`(/bin/universe) 2>/dev/null`" = att ; then
-		echo pyramid-pyramid-sysv3
-	else
-		echo pyramid-pyramid-bsd
-	fi
-	exit ;;
-    NILE*:*:*:dcosx)
-	echo pyramid-pyramid-svr4
-	exit ;;
-    DRS?6000:unix:4.0:6*)
-	echo sparc-icl-nx6
-	exit ;;
-    DRS?6000:UNIX_SV:4.2*:7* | DRS?6000:isis:4.2*:7*)
-	case `/usr/bin/uname -p` in
-	    sparc) echo sparc-icl-nx7; exit ;;
-	esac ;;
-    s390x:SunOS:*:*)
-	echo ${UNAME_MACHINE}-ibm-solaris2`echo ${UNAME_RELEASE}|sed -e 's/[^.]*//'`
-	exit ;;
-    sun4H:SunOS:5.*:*)
-	echo sparc-hal-solaris2`echo ${UNAME_RELEASE}|sed -e 's/[^.]*//'`
-	exit ;;
-    sun4*:SunOS:5.*:* | tadpole*:SunOS:5.*:*)
-	echo sparc-sun-solaris2`echo ${UNAME_RELEASE}|sed -e 's/[^.]*//'`
-	exit ;;
-    i86pc:AuroraUX:5.*:* | i86xen:AuroraUX:5.*:*)
-	echo i386-pc-auroraux${UNAME_RELEASE}
-	exit ;;
-    i86pc:SunOS:5.*:* | i86xen:SunOS:5.*:*)
-	eval $set_cc_for_build
-	SUN_ARCH="i386"
-	# If there is a compiler, see if it is configured for 64-bit objects.
-	# Note that the Sun cc does not turn __LP64__ into 1 like gcc does.
-	# This test works for both compilers.
-	if [ "$CC_FOR_BUILD" != 'no_compiler_found' ]; then
-	    if (echo '#ifdef __amd64'; echo IS_64BIT_ARCH; echo '#endif') | \
-		(CCOPTS= $CC_FOR_BUILD -E - 2>/dev/null) | \
-		grep IS_64BIT_ARCH >/dev/null
-	    then
-		SUN_ARCH="x86_64"
-	    fi
-	fi
-	echo ${SUN_ARCH}-pc-solaris2`echo ${UNAME_RELEASE}|sed -e 's/[^.]*//'`
-	exit ;;
-    sun4*:SunOS:6*:*)
-	# According to config.sub, this is the proper way to canonicalize
-	# SunOS6.  Hard to guess exactly what SunOS6 will be like, but
-	# it's likely to be more like Solaris than SunOS4.
-	echo sparc-sun-solaris3`echo ${UNAME_RELEASE}|sed -e 's/[^.]*//'`
-	exit ;;
-    sun4*:SunOS:*:*)
-	case "`/usr/bin/arch -k`" in
-	    Series*|S4*)
-		UNAME_RELEASE=`uname -v`
-		;;
-	esac
-	# Japanese Language versions have a version number like `4.1.3-JL'.
-	echo sparc-sun-sunos`echo ${UNAME_RELEASE}|sed -e 's/-/_/'`
-	exit ;;
-    sun3*:SunOS:*:*)
-	echo m68k-sun-sunos${UNAME_RELEASE}
-	exit ;;
-    sun*:*:4.2BSD:*)
-	UNAME_RELEASE=`(sed 1q /etc/motd | awk '{print substr($5,1,3)}') 2>/dev/null`
-	test "x${UNAME_RELEASE}" = "x" && UNAME_RELEASE=3
-	case "`/bin/arch`" in
-	    sun3)
-		echo m68k-sun-sunos${UNAME_RELEASE}
-		;;
-	    sun4)
-		echo sparc-sun-sunos${UNAME_RELEASE}
-		;;
-	esac
-	exit ;;
-    aushp:SunOS:*:*)
-	echo sparc-auspex-sunos${UNAME_RELEASE}
-	exit ;;
-    # The situation for MiNT is a little confusing.  The machine name
-    # can be virtually everything (everything which is not
-    # "atarist" or "atariste" at least should have a processor
-    # > m68000).  The system name ranges from "MiNT" over "FreeMiNT"
-    # to the lowercase version "mint" (or "freemint").  Finally
-    # the system name "TOS" denotes a system which is actually not
-    # MiNT.  But MiNT is downward compatible to TOS, so this should
-    # be no problem.
-    atarist[e]:*MiNT:*:* | atarist[e]:*mint:*:* | atarist[e]:*TOS:*:*)
-        echo m68k-atari-mint${UNAME_RELEASE}
-	exit ;;
-    atari*:*MiNT:*:* | atari*:*mint:*:* | atarist[e]:*TOS:*:*)
-	echo m68k-atari-mint${UNAME_RELEASE}
-        exit ;;
-    *falcon*:*MiNT:*:* | *falcon*:*mint:*:* | *falcon*:*TOS:*:*)
-        echo m68k-atari-mint${UNAME_RELEASE}
-	exit ;;
-    milan*:*MiNT:*:* | milan*:*mint:*:* | *milan*:*TOS:*:*)
-        echo m68k-milan-mint${UNAME_RELEASE}
-        exit ;;
-    hades*:*MiNT:*:* | hades*:*mint:*:* | *hades*:*TOS:*:*)
-        echo m68k-hades-mint${UNAME_RELEASE}
-        exit ;;
-    *:*MiNT:*:* | *:*mint:*:* | *:*TOS:*:*)
-        echo m68k-unknown-mint${UNAME_RELEASE}
-        exit ;;
-    m68k:machten:*:*)
-	echo m68k-apple-machten${UNAME_RELEASE}
-	exit ;;
-    powerpc:machten:*:*)
-	echo powerpc-apple-machten${UNAME_RELEASE}
-	exit ;;
-    RISC*:Mach:*:*)
-	echo mips-dec-mach_bsd4.3
-	exit ;;
-    RISC*:ULTRIX:*:*)
-	echo mips-dec-ultrix${UNAME_RELEASE}
-	exit ;;
-    VAX*:ULTRIX*:*:*)
-	echo vax-dec-ultrix${UNAME_RELEASE}
-	exit ;;
-    2020:CLIX:*:* | 2430:CLIX:*:*)
-	echo clipper-intergraph-clix${UNAME_RELEASE}
-	exit ;;
-    mips:*:*:UMIPS | mips:*:*:RISCos)
-	eval $set_cc_for_build
-	sed 's/^	//' << EOF >$dummy.c
-#ifdef __cplusplus
-#include <stdio.h>  /* for printf() prototype */
-	int main (int argc, char *argv[]) {
-#else
-	int main (argc, argv) int argc; char *argv[]; {
-#endif
-	#if defined (host_mips) && defined (MIPSEB)
-	#if defined (SYSTYPE_SYSV)
-	  printf ("mips-mips-riscos%ssysv\n", argv[1]); exit (0);
-	#endif
-	#if defined (SYSTYPE_SVR4)
-	  printf ("mips-mips-riscos%ssvr4\n", argv[1]); exit (0);
-	#endif
-	#if defined (SYSTYPE_BSD43) || defined(SYSTYPE_BSD)
-	  printf ("mips-mips-riscos%sbsd\n", argv[1]); exit (0);
-	#endif
-	#endif
-	  exit (-1);
-	}
-EOF
-	$CC_FOR_BUILD -o $dummy $dummy.c &&
-	  dummyarg=`echo "${UNAME_RELEASE}" | sed -n 's/\([0-9]*\).*/\1/p'` &&
-	  SYSTEM_NAME=`$dummy $dummyarg` &&
-	    { echo "$SYSTEM_NAME"; exit; }
-	echo mips-mips-riscos${UNAME_RELEASE}
-	exit ;;
-    Motorola:PowerMAX_OS:*:*)
-	echo powerpc-motorola-powermax
-	exit ;;
-    Motorola:*:4.3:PL8-*)
-	echo powerpc-harris-powermax
-	exit ;;
-    Night_Hawk:*:*:PowerMAX_OS | Synergy:PowerMAX_OS:*:*)
-	echo powerpc-harris-powermax
-	exit ;;
-    Night_Hawk:Power_UNIX:*:*)
-	echo powerpc-harris-powerunix
-	exit ;;
-    m88k:CX/UX:7*:*)
-	echo m88k-harris-cxux7
-	exit ;;
-    m88k:*:4*:R4*)
-	echo m88k-motorola-sysv4
-	exit ;;
-    m88k:*:3*:R3*)
-	echo m88k-motorola-sysv3
-	exit ;;
-    AViiON:dgux:*:*)
-        # DG/UX returns AViiON for all architectures
-        UNAME_PROCESSOR=`/usr/bin/uname -p`
-	if [ $UNAME_PROCESSOR = mc88100 ] || [ $UNAME_PROCESSOR = mc88110 ]
-	then
-	    if [ ${TARGET_BINARY_INTERFACE}x = m88kdguxelfx ] || \
-	       [ ${TARGET_BINARY_INTERFACE}x = x ]
-	    then
-		echo m88k-dg-dgux${UNAME_RELEASE}
-	    else
-		echo m88k-dg-dguxbcs${UNAME_RELEASE}
-	    fi
-	else
-	    echo i586-dg-dgux${UNAME_RELEASE}
-	fi
- 	exit ;;
-    M88*:DolphinOS:*:*)	# DolphinOS (SVR3)
-	echo m88k-dolphin-sysv3
-	exit ;;
-    M88*:*:R3*:*)
-	# Delta 88k system running SVR3
-	echo m88k-motorola-sysv3
-	exit ;;
-    XD88*:*:*:*) # Tektronix XD88 system running UTekV (SVR3)
-	echo m88k-tektronix-sysv3
-	exit ;;
-    Tek43[0-9][0-9]:UTek:*:*) # Tektronix 4300 system running UTek (BSD)
-	echo m68k-tektronix-bsd
-	exit ;;
-    *:IRIX*:*:*)
-	echo mips-sgi-irix`echo ${UNAME_RELEASE}|sed -e 's/-/_/g'`
-	exit ;;
-    ????????:AIX?:[12].1:2)   # AIX 2.2.1 or AIX 2.1.1 is RT/PC AIX.
-	echo romp-ibm-aix     # uname -m gives an 8 hex-code CPU id
-	exit ;;               # Note that: echo "'`uname -s`'" gives 'AIX '
-    i*86:AIX:*:*)
-	echo i386-ibm-aix
-	exit ;;
-    ia64:AIX:*:*)
-	if [ -x /usr/bin/oslevel ] ; then
-		IBM_REV=`/usr/bin/oslevel`
-	else
-		IBM_REV=${UNAME_VERSION}.${UNAME_RELEASE}
-	fi
-	echo ${UNAME_MACHINE}-ibm-aix${IBM_REV}
-	exit ;;
-    *:AIX:2:3)
-	if grep bos325 /usr/include/stdio.h >/dev/null 2>&1; then
-		eval $set_cc_for_build
-		sed 's/^		//' << EOF >$dummy.c
-		#include <sys/systemcfg.h>
-
-		main()
-			{
-			if (!__power_pc())
-				exit(1);
-			puts("powerpc-ibm-aix3.2.5");
-			exit(0);
-			}
-EOF
-		if $CC_FOR_BUILD -o $dummy $dummy.c && SYSTEM_NAME=`$dummy`
-		then
-			echo "$SYSTEM_NAME"
-		else
-			echo rs6000-ibm-aix3.2.5
-		fi
-	elif grep bos324 /usr/include/stdio.h >/dev/null 2>&1; then
-		echo rs6000-ibm-aix3.2.4
-	else
-		echo rs6000-ibm-aix3.2
-	fi
-	exit ;;
-    *:AIX:*:[456])
-	IBM_CPU_ID=`/usr/sbin/lsdev -C -c processor -S available | sed 1q | awk '{ print $1 }'`
-	if /usr/sbin/lsattr -El ${IBM_CPU_ID} | grep ' POWER' >/dev/null 2>&1; then
-		IBM_ARCH=rs6000
-	else
-		IBM_ARCH=powerpc
-	fi
-	if [ -x /usr/bin/oslevel ] ; then
-		IBM_REV=`/usr/bin/oslevel`
-	else
-		IBM_REV=${UNAME_VERSION}.${UNAME_RELEASE}
-	fi
-	echo ${IBM_ARCH}-ibm-aix${IBM_REV}
-	exit ;;
-    *:AIX:*:*)
-	echo rs6000-ibm-aix
-	exit ;;
-    ibmrt:4.4BSD:*|romp-ibm:BSD:*)
-	echo romp-ibm-bsd4.4
-	exit ;;
-    ibmrt:*BSD:*|romp-ibm:BSD:*)            # covers RT/PC BSD and
-	echo romp-ibm-bsd${UNAME_RELEASE}   # 4.3 with uname added to
-	exit ;;                             # report: romp-ibm BSD 4.3
-    *:BOSX:*:*)
-	echo rs6000-bull-bosx
-	exit ;;
-    DPX/2?00:B.O.S.:*:*)
-	echo m68k-bull-sysv3
-	exit ;;
-    9000/[34]??:4.3bsd:1.*:*)
-	echo m68k-hp-bsd
-	exit ;;
-    hp300:4.4BSD:*:* | 9000/[34]??:4.3bsd:2.*:*)
-	echo m68k-hp-bsd4.4
-	exit ;;
-    9000/[34678]??:HP-UX:*:*)
-	HPUX_REV=`echo ${UNAME_RELEASE}|sed -e 's/[^.]*.[0B]*//'`
-	case "${UNAME_MACHINE}" in
-	    9000/31? )            HP_ARCH=m68000 ;;
-	    9000/[34]?? )         HP_ARCH=m68k ;;
-	    9000/[678][0-9][0-9])
-		if [ -x /usr/bin/getconf ]; then
-		    sc_cpu_version=`/usr/bin/getconf SC_CPU_VERSION 2>/dev/null`
-                    sc_kernel_bits=`/usr/bin/getconf SC_KERNEL_BITS 2>/dev/null`
-                    case "${sc_cpu_version}" in
-                      523) HP_ARCH="hppa1.0" ;; # CPU_PA_RISC1_0
-                      528) HP_ARCH="hppa1.1" ;; # CPU_PA_RISC1_1
-                      532)                      # CPU_PA_RISC2_0
-                        case "${sc_kernel_bits}" in
-                          32) HP_ARCH="hppa2.0n" ;;
-                          64) HP_ARCH="hppa2.0w" ;;
-			  '') HP_ARCH="hppa2.0" ;;   # HP-UX 10.20
-                        esac ;;
-                    esac
-		fi
-		if [ "${HP_ARCH}" = "" ]; then
-		    eval $set_cc_for_build
-		    sed 's/^              //' << EOF >$dummy.c
-
-              #define _HPUX_SOURCE
-              #include <stdlib.h>
-              #include <unistd.h>
-
-              int main ()
-              {
-              #if defined(_SC_KERNEL_BITS)
-                  long bits = sysconf(_SC_KERNEL_BITS);
-              #endif
-                  long cpu  = sysconf (_SC_CPU_VERSION);
-
-                  switch (cpu)
-              	{
-              	case CPU_PA_RISC1_0: puts ("hppa1.0"); break;
-              	case CPU_PA_RISC1_1: puts ("hppa1.1"); break;
-              	case CPU_PA_RISC2_0:
-              #if defined(_SC_KERNEL_BITS)
-              	    switch (bits)
-              		{
-              		case 64: puts ("hppa2.0w"); break;
-              		case 32: puts ("hppa2.0n"); break;
-              		default: puts ("hppa2.0"); break;
-              		} break;
-              #else  /* !defined(_SC_KERNEL_BITS) */
-              	    puts ("hppa2.0"); break;
-              #endif
-              	default: puts ("hppa1.0"); break;
-              	}
-                  exit (0);
-              }
-EOF
-		    (CCOPTS= $CC_FOR_BUILD -o $dummy $dummy.c 2>/dev/null) && HP_ARCH=`$dummy`
-		    test -z "$HP_ARCH" && HP_ARCH=hppa
-		fi ;;
-	esac
-	if [ ${HP_ARCH} = "hppa2.0w" ]
-	then
-	    eval $set_cc_for_build
-
-	    # hppa2.0w-hp-hpux* has a 64-bit kernel and a compiler generating
-	    # 32-bit code.  hppa64-hp-hpux* has the same kernel and a compiler
-	    # generating 64-bit code.  GNU and HP use different nomenclature:
-	    #
-	    # $ CC_FOR_BUILD=cc ./config.guess
-	    # => hppa2.0w-hp-hpux11.23
-	    # $ CC_FOR_BUILD="cc +DA2.0w" ./config.guess
-	    # => hppa64-hp-hpux11.23
-
-	    if echo __LP64__ | (CCOPTS= $CC_FOR_BUILD -E - 2>/dev/null) |
-		grep -q __LP64__
-	    then
-		HP_ARCH="hppa2.0w"
-	    else
-		HP_ARCH="hppa64"
-	    fi
-	fi
-	echo ${HP_ARCH}-hp-hpux${HPUX_REV}
-	exit ;;
-    ia64:HP-UX:*:*)
-	HPUX_REV=`echo ${UNAME_RELEASE}|sed -e 's/[^.]*.[0B]*//'`
-	echo ia64-hp-hpux${HPUX_REV}
-	exit ;;
-    3050*:HI-UX:*:*)
-	eval $set_cc_for_build
-	sed 's/^	//' << EOF >$dummy.c
-	#include <unistd.h>
-	int
-	main ()
-	{
-	  long cpu = sysconf (_SC_CPU_VERSION);
-	  /* The order matters, because CPU_IS_HP_MC68K erroneously returns
-	     true for CPU_PA_RISC1_0.  CPU_IS_PA_RISC returns correct
-	     results, however.  */
-	  if (CPU_IS_PA_RISC (cpu))
-	    {
-	      switch (cpu)
-		{
-		  case CPU_PA_RISC1_0: puts ("hppa1.0-hitachi-hiuxwe2"); break;
-		  case CPU_PA_RISC1_1: puts ("hppa1.1-hitachi-hiuxwe2"); break;
-		  case CPU_PA_RISC2_0: puts ("hppa2.0-hitachi-hiuxwe2"); break;
-		  default: puts ("hppa-hitachi-hiuxwe2"); break;
-		}
-	    }
-	  else if (CPU_IS_HP_MC68K (cpu))
-	    puts ("m68k-hitachi-hiuxwe2");
-	  else puts ("unknown-hitachi-hiuxwe2");
-	  exit (0);
-	}
-EOF
-	$CC_FOR_BUILD -o $dummy $dummy.c && SYSTEM_NAME=`$dummy` &&
-		{ echo "$SYSTEM_NAME"; exit; }
-	echo unknown-hitachi-hiuxwe2
-	exit ;;
-    9000/7??:4.3bsd:*:* | 9000/8?[79]:4.3bsd:*:* )
-	echo hppa1.1-hp-bsd
-	exit ;;
-    9000/8??:4.3bsd:*:*)
-	echo hppa1.0-hp-bsd
-	exit ;;
-    *9??*:MPE/iX:*:* | *3000*:MPE/iX:*:*)
-	echo hppa1.0-hp-mpeix
-	exit ;;
-    hp7??:OSF1:*:* | hp8?[79]:OSF1:*:* )
-	echo hppa1.1-hp-osf
-	exit ;;
-    hp8??:OSF1:*:*)
-	echo hppa1.0-hp-osf
-	exit ;;
-    i*86:OSF1:*:*)
-	if [ -x /usr/sbin/sysversion ] ; then
-	    echo ${UNAME_MACHINE}-unknown-osf1mk
-	else
-	    echo ${UNAME_MACHINE}-unknown-osf1
-	fi
-	exit ;;
-    parisc*:Lites*:*:*)
-	echo hppa1.1-hp-lites
-	exit ;;
-    C1*:ConvexOS:*:* | convex:ConvexOS:C1*:*)
-	echo c1-convex-bsd
-        exit ;;
-    C2*:ConvexOS:*:* | convex:ConvexOS:C2*:*)
-	if getsysinfo -f scalar_acc
-	then echo c32-convex-bsd
-	else echo c2-convex-bsd
-	fi
-        exit ;;
-    C34*:ConvexOS:*:* | convex:ConvexOS:C34*:*)
-	echo c34-convex-bsd
-        exit ;;
-    C38*:ConvexOS:*:* | convex:ConvexOS:C38*:*)
-	echo c38-convex-bsd
-        exit ;;
-    C4*:ConvexOS:*:* | convex:ConvexOS:C4*:*)
-	echo c4-convex-bsd
-        exit ;;
-    CRAY*Y-MP:*:*:*)
-	echo ymp-cray-unicos${UNAME_RELEASE} | sed -e 's/\.[^.]*$/.X/'
-	exit ;;
-    CRAY*[A-Z]90:*:*:*)
-	echo ${UNAME_MACHINE}-cray-unicos${UNAME_RELEASE} \
-	| sed -e 's/CRAY.*\([A-Z]90\)/\1/' \
-	      -e y/ABCDEFGHIJKLMNOPQRSTUVWXYZ/abcdefghijklmnopqrstuvwxyz/ \
-	      -e 's/\.[^.]*$/.X/'
-	exit ;;
-    CRAY*TS:*:*:*)
-	echo t90-cray-unicos${UNAME_RELEASE} | sed -e 's/\.[^.]*$/.X/'
-	exit ;;
-    CRAY*T3E:*:*:*)
-	echo alphaev5-cray-unicosmk${UNAME_RELEASE} | sed -e 's/\.[^.]*$/.X/'
-	exit ;;
-    CRAY*SV1:*:*:*)
-	echo sv1-cray-unicos${UNAME_RELEASE} | sed -e 's/\.[^.]*$/.X/'
-	exit ;;
-    *:UNICOS/mp:*:*)
-	echo craynv-cray-unicosmp${UNAME_RELEASE} | sed -e 's/\.[^.]*$/.X/'
-	exit ;;
-    F30[01]:UNIX_System_V:*:* | F700:UNIX_System_V:*:*)
-	FUJITSU_PROC=`uname -m | tr 'ABCDEFGHIJKLMNOPQRSTUVWXYZ' 'abcdefghijklmnopqrstuvwxyz'`
-        FUJITSU_SYS=`uname -p | tr 'ABCDEFGHIJKLMNOPQRSTUVWXYZ' 'abcdefghijklmnopqrstuvwxyz' | sed -e 's/\///'`
-        FUJITSU_REL=`echo ${UNAME_RELEASE} | sed -e 's/ /_/'`
-        echo "${FUJITSU_PROC}-fujitsu-${FUJITSU_SYS}${FUJITSU_REL}"
-        exit ;;
-    5000:UNIX_System_V:4.*:*)
-        FUJITSU_SYS=`uname -p | tr 'ABCDEFGHIJKLMNOPQRSTUVWXYZ' 'abcdefghijklmnopqrstuvwxyz' | sed -e 's/\///'`
-        FUJITSU_REL=`echo ${UNAME_RELEASE} | tr 'ABCDEFGHIJKLMNOPQRSTUVWXYZ' 'abcdefghijklmnopqrstuvwxyz' | sed -e 's/ /_/'`
-        echo "sparc-fujitsu-${FUJITSU_SYS}${FUJITSU_REL}"
-	exit ;;
-    i*86:BSD/386:*:* | i*86:BSD/OS:*:* | *:Ascend\ Embedded/OS:*:*)
-	echo ${UNAME_MACHINE}-pc-bsdi${UNAME_RELEASE}
-	exit ;;
-    sparc*:BSD/OS:*:*)
-	echo sparc-unknown-bsdi${UNAME_RELEASE}
-	exit ;;
-    *:BSD/OS:*:*)
-	echo ${UNAME_MACHINE}-unknown-bsdi${UNAME_RELEASE}
-	exit ;;
-    *:FreeBSD:*:*)
-	case ${UNAME_MACHINE} in
-	    pc98)
-		echo i386-unknown-freebsd`echo ${UNAME_RELEASE}|sed -e 's/[-(].*//'` ;;
-	    amd64)
-		echo x86_64-unknown-freebsd`echo ${UNAME_RELEASE}|sed -e 's/[-(].*//'` ;;
-	    *)
-		echo ${UNAME_MACHINE}-unknown-freebsd`echo ${UNAME_RELEASE}|sed -e 's/[-(].*//'` ;;
-	esac
-	exit ;;
-    i*:CYGWIN*:*)
-	echo ${UNAME_MACHINE}-pc-cygwin
-	exit ;;
-    *:MINGW*:*)
-	echo ${UNAME_MACHINE}-pc-mingw32
-	exit ;;
-    i*:windows32*:*)
-    	# uname -m includes "-pc" on this system.
-    	echo ${UNAME_MACHINE}-mingw32
-	exit ;;
-    i*:PW*:*)
-	echo ${UNAME_MACHINE}-pc-pw32
-	exit ;;
-    *:Interix*:*)
-    	case ${UNAME_MACHINE} in
-	    x86)
-		echo i586-pc-interix${UNAME_RELEASE}
-		exit ;;
-	    authenticamd | genuineintel | EM64T)
-		echo x86_64-unknown-interix${UNAME_RELEASE}
-		exit ;;
-	    IA64)
-		echo ia64-unknown-interix${UNAME_RELEASE}
-		exit ;;
-	esac ;;
-    [345]86:Windows_95:* | [345]86:Windows_98:* | [345]86:Windows_NT:*)
-	echo i${UNAME_MACHINE}-pc-mks
-	exit ;;
-    8664:Windows_NT:*)
-	echo x86_64-pc-mks
-	exit ;;
-    i*:Windows_NT*:* | Pentium*:Windows_NT*:*)
-	# How do we know it's Interix rather than the generic POSIX subsystem?
-	# It also conflicts with pre-2.0 versions of AT&T UWIN. Should we
-	# UNAME_MACHINE based on the output of uname instead of i386?
-	echo i586-pc-interix
-	exit ;;
-    i*:UWIN*:*)
-	echo ${UNAME_MACHINE}-pc-uwin
-	exit ;;
-    amd64:CYGWIN*:*:* | x86_64:CYGWIN*:*:*)
-	echo x86_64-unknown-cygwin
-	exit ;;
-    p*:CYGWIN*:*)
-	echo powerpcle-unknown-cygwin
-	exit ;;
-    prep*:SunOS:5.*:*)
-	echo powerpcle-unknown-solaris2`echo ${UNAME_RELEASE}|sed -e 's/[^.]*//'`
-	exit ;;
-    *:GNU:*:*)
-	# the GNU system
-	echo `echo ${UNAME_MACHINE}|sed -e 's,[-/].*$,,'`-unknown-gnu`echo ${UNAME_RELEASE}|sed -e 's,/.*$,,'`
-	exit ;;
-    *:GNU/*:*:*)
-	# other systems with GNU libc and userland
-	echo ${UNAME_MACHINE}-unknown-`echo ${UNAME_SYSTEM} | sed 's,^[^/]*/,,' | tr '[A-Z]' '[a-z]'``echo ${UNAME_RELEASE}|sed -e 's/[-(].*//'`-gnu
-	exit ;;
-    i*86:Minix:*:*)
-	echo ${UNAME_MACHINE}-pc-minix
-	exit ;;
-    alpha:Linux:*:*)
-	case `sed -n '/^cpu model/s/^.*: \(.*\)/\1/p' < /proc/cpuinfo` in
-	  EV5)   UNAME_MACHINE=alphaev5 ;;
-	  EV56)  UNAME_MACHINE=alphaev56 ;;
-	  PCA56) UNAME_MACHINE=alphapca56 ;;
-	  PCA57) UNAME_MACHINE=alphapca56 ;;
-	  EV6)   UNAME_MACHINE=alphaev6 ;;
-	  EV67)  UNAME_MACHINE=alphaev67 ;;
-	  EV68*) UNAME_MACHINE=alphaev68 ;;
-        esac
-	objdump --private-headers /bin/sh | grep -q ld.so.1
-	if test "$?" = 0 ; then LIBC="libc1" ; else LIBC="" ; fi
-	echo ${UNAME_MACHINE}-unknown-linux-gnu${LIBC}
-	exit ;;
-    arm*:Linux:*:*)
-	eval $set_cc_for_build
-	if echo __ARM_EABI__ | $CC_FOR_BUILD -E - 2>/dev/null \
-	    | grep -q __ARM_EABI__
-	then
-	    echo ${UNAME_MACHINE}-unknown-linux-gnu
-	else
-	    echo ${UNAME_MACHINE}-unknown-linux-gnueabi
-	fi
-	exit ;;
-    avr32*:Linux:*:*)
-	echo ${UNAME_MACHINE}-unknown-linux-gnu
-	exit ;;
-    cris:Linux:*:*)
-	echo cris-axis-linux-gnu
-	exit ;;
-    crisv32:Linux:*:*)
-	echo crisv32-axis-linux-gnu
-	exit ;;
-    frv:Linux:*:*)
-    	echo frv-unknown-linux-gnu
-	exit ;;
-    i*86:Linux:*:*)
-	LIBC=gnu
-	eval $set_cc_for_build
-	sed 's/^	//' << EOF >$dummy.c
-	#ifdef __dietlibc__
-	LIBC=dietlibc
-	#endif
-EOF
-	eval `$CC_FOR_BUILD -E $dummy.c 2>/dev/null | grep '^LIBC'`
-	echo "${UNAME_MACHINE}-pc-linux-${LIBC}"
-	exit ;;
-    ia64:Linux:*:*)
-	echo ${UNAME_MACHINE}-unknown-linux-gnu
-	exit ;;
-    m32r*:Linux:*:*)
-	echo ${UNAME_MACHINE}-unknown-linux-gnu
-	exit ;;
-    m68*:Linux:*:*)
-	echo ${UNAME_MACHINE}-unknown-linux-gnu
-	exit ;;
-    mips:Linux:*:* | mips64:Linux:*:*)
-	eval $set_cc_for_build
-	sed 's/^	//' << EOF >$dummy.c
-	#undef CPU
-	#undef ${UNAME_MACHINE}
-	#undef ${UNAME_MACHINE}el
-	#if defined(__MIPSEL__) || defined(__MIPSEL) || defined(_MIPSEL) || defined(MIPSEL)
-	CPU=${UNAME_MACHINE}el
-	#else
-	#if defined(__MIPSEB__) || defined(__MIPSEB) || defined(_MIPSEB) || defined(MIPSEB)
-	CPU=${UNAME_MACHINE}
-	#else
-	CPU=
-	#endif
-	#endif
-EOF
-	eval `$CC_FOR_BUILD -E $dummy.c 2>/dev/null | grep '^CPU'`
-	test x"${CPU}" != x && { echo "${CPU}-unknown-linux-gnu"; exit; }
-	;;
-    or32:Linux:*:*)
-	echo or32-unknown-linux-gnu
-	exit ;;
-    padre:Linux:*:*)
-	echo sparc-unknown-linux-gnu
-	exit ;;
-    parisc64:Linux:*:* | hppa64:Linux:*:*)
-	echo hppa64-unknown-linux-gnu
-	exit ;;
-    parisc:Linux:*:* | hppa:Linux:*:*)
-	# Look for CPU level
-	case `grep '^cpu[^a-z]*:' /proc/cpuinfo 2>/dev/null | cut -d' ' -f2` in
-	  PA7*) echo hppa1.1-unknown-linux-gnu ;;
-	  PA8*) echo hppa2.0-unknown-linux-gnu ;;
-	  *)    echo hppa-unknown-linux-gnu ;;
-	esac
-	exit ;;
-    ppc64:Linux:*:*)
-	echo powerpc64-unknown-linux-gnu
-	exit ;;
-    ppc:Linux:*:*)
-	echo powerpc-unknown-linux-gnu
-	exit ;;
-    s390:Linux:*:* | s390x:Linux:*:*)
-	echo ${UNAME_MACHINE}-ibm-linux
-	exit ;;
-    sh64*:Linux:*:*)
-    	echo ${UNAME_MACHINE}-unknown-linux-gnu
-	exit ;;
-    sh*:Linux:*:*)
-	echo ${UNAME_MACHINE}-unknown-linux-gnu
-	exit ;;
-    sparc:Linux:*:* | sparc64:Linux:*:*)
-	echo ${UNAME_MACHINE}-unknown-linux-gnu
-	exit ;;
-    vax:Linux:*:*)
-	echo ${UNAME_MACHINE}-dec-linux-gnu
-	exit ;;
-    x86_64:Linux:*:*)
-	echo x86_64-unknown-linux-gnu
-	exit ;;
-    xtensa*:Linux:*:*)
-    	echo ${UNAME_MACHINE}-unknown-linux-gnu
-	exit ;;
-    i*86:DYNIX/ptx:4*:*)
-	# ptx 4.0 does uname -s correctly, with DYNIX/ptx in there.
-	# earlier versions are messed up and put the nodename in both
-	# sysname and nodename.
-	echo i386-sequent-sysv4
-	exit ;;
-    i*86:UNIX_SV:4.2MP:2.*)
-        # Unixware is an offshoot of SVR4, but it has its own version
-        # number series starting with 2...
-        # I am not positive that other SVR4 systems won't match this,
-	# I just have to hope.  -- rms.
-        # Use sysv4.2uw... so that sysv4* matches it.
-	echo ${UNAME_MACHINE}-pc-sysv4.2uw${UNAME_VERSION}
-	exit ;;
-    i*86:OS/2:*:*)
-	# If we were able to find `uname', then EMX Unix compatibility
-	# is probably installed.
-	echo ${UNAME_MACHINE}-pc-os2-emx
-	exit ;;
-    i*86:XTS-300:*:STOP)
-	echo ${UNAME_MACHINE}-unknown-stop
-	exit ;;
-    i*86:atheos:*:*)
-	echo ${UNAME_MACHINE}-unknown-atheos
-	exit ;;
-    i*86:syllable:*:*)
-	echo ${UNAME_MACHINE}-pc-syllable
-	exit ;;
-    i*86:LynxOS:2.*:* | i*86:LynxOS:3.[01]*:* | i*86:LynxOS:4.[02]*:*)
-	echo i386-unknown-lynxos${UNAME_RELEASE}
-	exit ;;
-    i*86:*DOS:*:*)
-	echo ${UNAME_MACHINE}-pc-msdosdjgpp
-	exit ;;
-    i*86:*:4.*:* | i*86:SYSTEM_V:4.*:*)
-	UNAME_REL=`echo ${UNAME_RELEASE} | sed 's/\/MP$//'`
-	if grep Novell /usr/include/link.h >/dev/null 2>/dev/null; then
-		echo ${UNAME_MACHINE}-univel-sysv${UNAME_REL}
-	else
-		echo ${UNAME_MACHINE}-pc-sysv${UNAME_REL}
-	fi
-	exit ;;
-    i*86:*:5:[678]*)
-    	# UnixWare 7.x, OpenUNIX and OpenServer 6.
-	case `/bin/uname -X | grep "^Machine"` in
-	    *486*)	     UNAME_MACHINE=i486 ;;
-	    *Pentium)	     UNAME_MACHINE=i586 ;;
-	    *Pent*|*Celeron) UNAME_MACHINE=i686 ;;
-	esac
-	echo ${UNAME_MACHINE}-unknown-sysv${UNAME_RELEASE}${UNAME_SYSTEM}${UNAME_VERSION}
-	exit ;;
-    i*86:*:3.2:*)
-	if test -f /usr/options/cb.name; then
-		UNAME_REL=`sed -n 's/.*Version //p' </usr/options/cb.name`
-		echo ${UNAME_MACHINE}-pc-isc$UNAME_REL
-	elif /bin/uname -X 2>/dev/null >/dev/null ; then
-		UNAME_REL=`(/bin/uname -X|grep Release|sed -e 's/.*= //')`
-		(/bin/uname -X|grep i80486 >/dev/null) && UNAME_MACHINE=i486
-		(/bin/uname -X|grep '^Machine.*Pentium' >/dev/null) \
-			&& UNAME_MACHINE=i586
-		(/bin/uname -X|grep '^Machine.*Pent *II' >/dev/null) \
-			&& UNAME_MACHINE=i686
-		(/bin/uname -X|grep '^Machine.*Pentium Pro' >/dev/null) \
-			&& UNAME_MACHINE=i686
-		echo ${UNAME_MACHINE}-pc-sco$UNAME_REL
-	else
-		echo ${UNAME_MACHINE}-pc-sysv32
-	fi
-	exit ;;
-    pc:*:*:*)
-	# Left here for compatibility:
-        # uname -m prints for DJGPP always 'pc', but it prints nothing about
-        # the processor, so we play safe by assuming i586.
-	# Note: whatever this is, it MUST be the same as what config.sub
-	# prints for the "djgpp" host, or else GDB configury will decide that
-	# this is a cross-build.
-	echo i586-pc-msdosdjgpp
-        exit ;;
-    Intel:Mach:3*:*)
-	echo i386-pc-mach3
-	exit ;;
-    paragon:*:*:*)
-	echo i860-intel-osf1
-	exit ;;
-    i860:*:4.*:*) # i860-SVR4
-	if grep Stardent /usr/include/sys/uadmin.h >/dev/null 2>&1 ; then
-	  echo i860-stardent-sysv${UNAME_RELEASE} # Stardent Vistra i860-SVR4
-	else # Add other i860-SVR4 vendors below as they are discovered.
-	  echo i860-unknown-sysv${UNAME_RELEASE}  # Unknown i860-SVR4
-	fi
-	exit ;;
-    mini*:CTIX:SYS*5:*)
-	# "miniframe"
-	echo m68010-convergent-sysv
-	exit ;;
-    mc68k:UNIX:SYSTEM5:3.51m)
-	echo m68k-convergent-sysv
-	exit ;;
-    M680?0:D-NIX:5.3:*)
-	echo m68k-diab-dnix
-	exit ;;
-    M68*:*:R3V[5678]*:*)
-	test -r /sysV68 && { echo 'm68k-motorola-sysv'; exit; } ;;
-    3[345]??:*:4.0:3.0 | 3[34]??A:*:4.0:3.0 | 3[34]??,*:*:4.0:3.0 | 3[34]??/*:*:4.0:3.0 | 4400:*:4.0:3.0 | 4850:*:4.0:3.0 | SKA40:*:4.0:3.0 | SDS2:*:4.0:3.0 | SHG2:*:4.0:3.0 | S7501*:*:4.0:3.0)
-	OS_REL=''
-	test -r /etc/.relid \
-	&& OS_REL=.`sed -n 's/[^ ]* [^ ]* \([0-9][0-9]\).*/\1/p' < /etc/.relid`
-	/bin/uname -p 2>/dev/null | grep 86 >/dev/null \
-	  && { echo i486-ncr-sysv4.3${OS_REL}; exit; }
-	/bin/uname -p 2>/dev/null | /bin/grep entium >/dev/null \
-	  && { echo i586-ncr-sysv4.3${OS_REL}; exit; } ;;
-    3[34]??:*:4.0:* | 3[34]??,*:*:4.0:*)
-        /bin/uname -p 2>/dev/null | grep 86 >/dev/null \
-          && { echo i486-ncr-sysv4; exit; } ;;
-    NCR*:*:4.2:* | MPRAS*:*:4.2:*)
-	OS_REL='.3'
-	test -r /etc/.relid \
-	    && OS_REL=.`sed -n 's/[^ ]* [^ ]* \([0-9][0-9]\).*/\1/p' < /etc/.relid`
-	/bin/uname -p 2>/dev/null | grep 86 >/dev/null \
-	    && { echo i486-ncr-sysv4.3${OS_REL}; exit; }
-	/bin/uname -p 2>/dev/null | /bin/grep entium >/dev/null \
-	    && { echo i586-ncr-sysv4.3${OS_REL}; exit; }
-	/bin/uname -p 2>/dev/null | /bin/grep pteron >/dev/null \
-	    && { echo i586-ncr-sysv4.3${OS_REL}; exit; } ;;
-    m68*:LynxOS:2.*:* | m68*:LynxOS:3.0*:*)
-	echo m68k-unknown-lynxos${UNAME_RELEASE}
-	exit ;;
-    mc68030:UNIX_System_V:4.*:*)
-	echo m68k-atari-sysv4
-	exit ;;
-    TSUNAMI:LynxOS:2.*:*)
-	echo sparc-unknown-lynxos${UNAME_RELEASE}
-	exit ;;
-    rs6000:LynxOS:2.*:*)
-	echo rs6000-unknown-lynxos${UNAME_RELEASE}
-	exit ;;
-    PowerPC:LynxOS:2.*:* | PowerPC:LynxOS:3.[01]*:* | PowerPC:LynxOS:4.[02]*:*)
-	echo powerpc-unknown-lynxos${UNAME_RELEASE}
-	exit ;;
-    SM[BE]S:UNIX_SV:*:*)
-	echo mips-dde-sysv${UNAME_RELEASE}
-	exit ;;
-    RM*:ReliantUNIX-*:*:*)
-	echo mips-sni-sysv4
-	exit ;;
-    RM*:SINIX-*:*:*)
-	echo mips-sni-sysv4
-	exit ;;
-    *:SINIX-*:*:*)
-	if uname -p 2>/dev/null >/dev/null ; then
-		UNAME_MACHINE=`(uname -p) 2>/dev/null`
-		echo ${UNAME_MACHINE}-sni-sysv4
-	else
-		echo ns32k-sni-sysv
-	fi
-	exit ;;
-    PENTIUM:*:4.0*:*) # Unisys `ClearPath HMP IX 4000' SVR4/MP effort
-                      # says <Richard.M.Bartel@ccMail.Census.GOV>
-        echo i586-unisys-sysv4
-        exit ;;
-    *:UNIX_System_V:4*:FTX*)
-	# From Gerald Hewes <hewes@openmarket.com>.
-	# How about differentiating between stratus architectures? -djm
-	echo hppa1.1-stratus-sysv4
-	exit ;;
-    *:*:*:FTX*)
-	# From seanf@swdc.stratus.com.
-	echo i860-stratus-sysv4
-	exit ;;
-    i*86:VOS:*:*)
-	# From Paul.Green@stratus.com.
-	echo ${UNAME_MACHINE}-stratus-vos
-	exit ;;
-    *:VOS:*:*)
-	# From Paul.Green@stratus.com.
-	echo hppa1.1-stratus-vos
-	exit ;;
-    mc68*:A/UX:*:*)
-	echo m68k-apple-aux${UNAME_RELEASE}
-	exit ;;
-    news*:NEWS-OS:6*:*)
-	echo mips-sony-newsos6
-	exit ;;
-    R[34]000:*System_V*:*:* | R4000:UNIX_SYSV:*:* | R*000:UNIX_SV:*:*)
-	if [ -d /usr/nec ]; then
-	        echo mips-nec-sysv${UNAME_RELEASE}
-	else
-	        echo mips-unknown-sysv${UNAME_RELEASE}
-	fi
-        exit ;;
-    BeBox:BeOS:*:*)	# BeOS running on hardware made by Be, PPC only.
-	echo powerpc-be-beos
-	exit ;;
-    BeMac:BeOS:*:*)	# BeOS running on Mac or Mac clone, PPC only.
-	echo powerpc-apple-beos
-	exit ;;
-    BePC:BeOS:*:*)	# BeOS running on Intel PC compatible.
-	echo i586-pc-beos
-	exit ;;
-    BePC:Haiku:*:*)	# Haiku running on Intel PC compatible.
-	echo i586-pc-haiku
-	exit ;;
-    SX-4:SUPER-UX:*:*)
-	echo sx4-nec-superux${UNAME_RELEASE}
-	exit ;;
-    SX-5:SUPER-UX:*:*)
-	echo sx5-nec-superux${UNAME_RELEASE}
-	exit ;;
-    SX-6:SUPER-UX:*:*)
-	echo sx6-nec-superux${UNAME_RELEASE}
-	exit ;;
-    SX-7:SUPER-UX:*:*)
-	echo sx7-nec-superux${UNAME_RELEASE}
-	exit ;;
-    SX-8:SUPER-UX:*:*)
-	echo sx8-nec-superux${UNAME_RELEASE}
-	exit ;;
-    SX-8R:SUPER-UX:*:*)
-	echo sx8r-nec-superux${UNAME_RELEASE}
-	exit ;;
-    Power*:Rhapsody:*:*)
-	echo powerpc-apple-rhapsody${UNAME_RELEASE}
-	exit ;;
-    *:Rhapsody:*:*)
-	echo ${UNAME_MACHINE}-apple-rhapsody${UNAME_RELEASE}
-	exit ;;
-    *:Darwin:*:*)
-	UNAME_PROCESSOR=`uname -p` || UNAME_PROCESSOR=unknown
-	case $UNAME_PROCESSOR in
-	    i386)
-		eval $set_cc_for_build
-		if [ "$CC_FOR_BUILD" != 'no_compiler_found' ]; then
-		  if (echo '#ifdef __LP64__'; echo IS_64BIT_ARCH; echo '#endif') | \
-		      (CCOPTS= $CC_FOR_BUILD -E - 2>/dev/null) | \
-		      grep IS_64BIT_ARCH >/dev/null
-		  then
-		      UNAME_PROCESSOR="x86_64"
-		  fi
-		fi ;;
-	    unknown) UNAME_PROCESSOR=powerpc ;;
-	esac
-	echo ${UNAME_PROCESSOR}-apple-darwin${UNAME_RELEASE}
-	exit ;;
-    *:procnto*:*:* | *:QNX:[0123456789]*:*)
-	UNAME_PROCESSOR=`uname -p`
-	if test "$UNAME_PROCESSOR" = "x86"; then
-		UNAME_PROCESSOR=i386
-		UNAME_MACHINE=pc
-	fi
-	echo ${UNAME_PROCESSOR}-${UNAME_MACHINE}-nto-qnx${UNAME_RELEASE}
-	exit ;;
-    *:QNX:*:4*)
-	echo i386-pc-qnx
-	exit ;;
-    NSE-?:NONSTOP_KERNEL:*:*)
-	echo nse-tandem-nsk${UNAME_RELEASE}
-	exit ;;
-    NSR-?:NONSTOP_KERNEL:*:*)
-	echo nsr-tandem-nsk${UNAME_RELEASE}
-	exit ;;
-    *:NonStop-UX:*:*)
-	echo mips-compaq-nonstopux
-	exit ;;
-    BS2000:POSIX*:*:*)
-	echo bs2000-siemens-sysv
-	exit ;;
-    DS/*:UNIX_System_V:*:*)
-	echo ${UNAME_MACHINE}-${UNAME_SYSTEM}-${UNAME_RELEASE}
-	exit ;;
-    *:Plan9:*:*)
-	# "uname -m" is not consistent, so use $cputype instead. 386
-	# is converted to i386 for consistency with other x86
-	# operating systems.
-	if test "$cputype" = "386"; then
-	    UNAME_MACHINE=i386
-	else
-	    UNAME_MACHINE="$cputype"
-	fi
-	echo ${UNAME_MACHINE}-unknown-plan9
-	exit ;;
-    *:TOPS-10:*:*)
-	echo pdp10-unknown-tops10
-	exit ;;
-    *:TENEX:*:*)
-	echo pdp10-unknown-tenex
-	exit ;;
-    KS10:TOPS-20:*:* | KL10:TOPS-20:*:* | TYPE4:TOPS-20:*:*)
-	echo pdp10-dec-tops20
-	exit ;;
-    XKL-1:TOPS-20:*:* | TYPE5:TOPS-20:*:*)
-	echo pdp10-xkl-tops20
-	exit ;;
-    *:TOPS-20:*:*)
-	echo pdp10-unknown-tops20
-	exit ;;
-    *:ITS:*:*)
-	echo pdp10-unknown-its
-	exit ;;
-    SEI:*:*:SEIUX)
-        echo mips-sei-seiux${UNAME_RELEASE}
-	exit ;;
-    *:DragonFly:*:*)
-	echo ${UNAME_MACHINE}-unknown-dragonfly`echo ${UNAME_RELEASE}|sed -e 's/[-(].*//'`
-	exit ;;
-    *:*VMS:*:*)
-    	UNAME_MACHINE=`(uname -p) 2>/dev/null`
-	case "${UNAME_MACHINE}" in
-	    A*) echo alpha-dec-vms ; exit ;;
-	    I*) echo ia64-dec-vms ; exit ;;
-	    V*) echo vax-dec-vms ; exit ;;
-	esac ;;
-    *:XENIX:*:SysV)
-	echo i386-pc-xenix
-	exit ;;
-    i*86:skyos:*:*)
-	echo ${UNAME_MACHINE}-pc-skyos`echo ${UNAME_RELEASE}` | sed -e 's/ .*$//'
-	exit ;;
-    i*86:rdos:*:*)
-	echo ${UNAME_MACHINE}-pc-rdos
-	exit ;;
-    i*86:AROS:*:*)
-	echo ${UNAME_MACHINE}-pc-aros
-	exit ;;
-esac
-
-#echo '(No uname command or uname output not recognized.)' 1>&2
-#echo "${UNAME_MACHINE}:${UNAME_SYSTEM}:${UNAME_RELEASE}:${UNAME_VERSION}" 1>&2
-
-eval $set_cc_for_build
-cat >$dummy.c <<EOF
-#ifdef _SEQUENT_
-# include <sys/types.h>
-# include <sys/utsname.h>
-#endif
-main ()
-{
-#if defined (sony)
-#if defined (MIPSEB)
-  /* BFD wants "bsd" instead of "newsos".  Perhaps BFD should be changed,
-     I don't know....  */
-  printf ("mips-sony-bsd\n"); exit (0);
-#else
-#include <sys/param.h>
-  printf ("m68k-sony-newsos%s\n",
-#ifdef NEWSOS4
-          "4"
-#else
-	  ""
-#endif
-         ); exit (0);
-#endif
-#endif
-
-#if defined (__arm) && defined (__acorn) && defined (__unix)
-  printf ("arm-acorn-riscix\n"); exit (0);
-#endif
-
-#if defined (hp300) && !defined (hpux)
-  printf ("m68k-hp-bsd\n"); exit (0);
-#endif
-
-#if defined (NeXT)
-#if !defined (__ARCHITECTURE__)
-#define __ARCHITECTURE__ "m68k"
-#endif
-  int version;
-  version=`(hostinfo | sed -n 's/.*NeXT Mach \([0-9]*\).*/\1/p') 2>/dev/null`;
-  if (version < 4)
-    printf ("%s-next-nextstep%d\n", __ARCHITECTURE__, version);
-  else
-    printf ("%s-next-openstep%d\n", __ARCHITECTURE__, version);
-  exit (0);
-#endif
-
-#if defined (MULTIMAX) || defined (n16)
-#if defined (UMAXV)
-  printf ("ns32k-encore-sysv\n"); exit (0);
-#else
-#if defined (CMU)
-  printf ("ns32k-encore-mach\n"); exit (0);
-#else
-  printf ("ns32k-encore-bsd\n"); exit (0);
-#endif
-#endif
-#endif
-
-#if defined (__386BSD__)
-  printf ("i386-pc-bsd\n"); exit (0);
-#endif
-
-#if defined (sequent)
-#if defined (i386)
-  printf ("i386-sequent-dynix\n"); exit (0);
-#endif
-#if defined (ns32000)
-  printf ("ns32k-sequent-dynix\n"); exit (0);
-#endif
-#endif
-
-#if defined (_SEQUENT_)
-    struct utsname un;
-
-    uname(&un);
-
-    if (strncmp(un.version, "V2", 2) == 0) {
-	printf ("i386-sequent-ptx2\n"); exit (0);
-    }
-    if (strncmp(un.version, "V1", 2) == 0) { /* XXX is V1 correct? */
-	printf ("i386-sequent-ptx1\n"); exit (0);
-    }
-    printf ("i386-sequent-ptx\n"); exit (0);
-
-#endif
-
-#if defined (vax)
-# if !defined (ultrix)
-#  include <sys/param.h>
-#  if defined (BSD)
-#   if BSD == 43
-      printf ("vax-dec-bsd4.3\n"); exit (0);
-#   else
-#    if BSD == 199006
-      printf ("vax-dec-bsd4.3reno\n"); exit (0);
-#    else
-      printf ("vax-dec-bsd\n"); exit (0);
-#    endif
-#   endif
-#  else
-    printf ("vax-dec-bsd\n"); exit (0);
-#  endif
-# else
-    printf ("vax-dec-ultrix\n"); exit (0);
-# endif
-#endif
-
-#if defined (alliant) && defined (i860)
-  printf ("i860-alliant-bsd\n"); exit (0);
-#endif
-
-  exit (1);
-}
-EOF
-
-$CC_FOR_BUILD -o $dummy $dummy.c 2>/dev/null && SYSTEM_NAME=`$dummy` &&
-	{ echo "$SYSTEM_NAME"; exit; }
-
-# Apollos put the system type in the environment.
-
-test -d /usr/apollo && { echo ${ISP}-apollo-${SYSTYPE}; exit; }
-
-# Convex versions that predate uname can use getsysinfo(1)
-
-if [ -x /usr/convex/getsysinfo ]
-then
-    case `getsysinfo -f cpu_type` in
-    c1*)
-	echo c1-convex-bsd
-	exit ;;
-    c2*)
-	if getsysinfo -f scalar_acc
-	then echo c32-convex-bsd
-	else echo c2-convex-bsd
-	fi
-	exit ;;
-    c34*)
-	echo c34-convex-bsd
-	exit ;;
-    c38*)
-	echo c38-convex-bsd
-	exit ;;
-    c4*)
-	echo c4-convex-bsd
-	exit ;;
-    esac
-fi
-
-cat >&2 <<EOF
-$0: unable to guess system type
-
-This script, last modified $timestamp, has failed to recognize
-the operating system you are using. It is advised that you
-download the most up to date version of the config scripts from
-
-  http://git.savannah.gnu.org/gitweb/?p=config.git;a=blob_plain;f=config.guess;hb=HEAD
-and
-  http://git.savannah.gnu.org/gitweb/?p=config.git;a=blob_plain;f=config.sub;hb=HEAD
-
-If the version you run ($0) is already up to date, please
-send the following data and any information you think might be
-pertinent to <config-patches@gnu.org> in order to provide the needed
-information to handle your system.
-
-config.guess timestamp = $timestamp
-
-uname -m = `(uname -m) 2>/dev/null || echo unknown`
-uname -r = `(uname -r) 2>/dev/null || echo unknown`
-uname -s = `(uname -s) 2>/dev/null || echo unknown`
-uname -v = `(uname -v) 2>/dev/null || echo unknown`
-
-/usr/bin/uname -p = `(/usr/bin/uname -p) 2>/dev/null`
-/bin/uname -X     = `(/bin/uname -X) 2>/dev/null`
-
-hostinfo               = `(hostinfo) 2>/dev/null`
-/bin/universe          = `(/bin/universe) 2>/dev/null`
-/usr/bin/arch -k       = `(/usr/bin/arch -k) 2>/dev/null`
-/bin/arch              = `(/bin/arch) 2>/dev/null`
-/usr/bin/oslevel       = `(/usr/bin/oslevel) 2>/dev/null`
-/usr/convex/getsysinfo = `(/usr/convex/getsysinfo) 2>/dev/null`
-
-UNAME_MACHINE = ${UNAME_MACHINE}
-UNAME_RELEASE = ${UNAME_RELEASE}
-UNAME_SYSTEM  = ${UNAME_SYSTEM}
-UNAME_VERSION = ${UNAME_VERSION}
-EOF
-
-exit 1
-
-# Local variables:
-# eval: (add-hook 'write-file-hooks 'time-stamp)
-# time-stamp-start: "timestamp='"
-# time-stamp-format: "%:y-%02m-%02d"
-# time-stamp-end: "'"
-# End:
diff -Nur dosbox-0.74/config.h.in dosbox-0.74.patch/config.h.in
--- dosbox-0.74/config.h.in	2010-05-10 21:01:28.000000000 +0200
+++ dosbox-0.74.patch/config.h.in	1970-01-01 01:00:00.000000000 +0100
@@ -1,310 +0,0 @@
-/* config.h.in.  Generated from configure.in by autoheader.  */
-
-
-/*
- *  Copyright (C) 2002-2010  The DOSBox Team
- *
- *  This program is free software; you can redistribute it and/or modify
- *  it under the terms of the GNU General Public License as published by
- *  the Free Software Foundation; either version 2 of the License, or
- *  (at your option) any later version.
- *
- *  This program is distributed in the hope that it will be useful,
- *  but WITHOUT ANY WARRANTY; without even the implied warranty of
- *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
- *  GNU Library General Public License for more details.
- *
- *  You should have received a copy of the GNU General Public License
- *  along with this program; if not, write to the Free Software
- *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
- */
-
-
-/* Define if building universal (internal helper macro) */
-#undef AC_APPLE_UNIVERSAL_BUILD
-
-/* Compiling on BSD */
-#undef BSD
-
-/* Determines if the compilers supports always_inline attribute. */
-#undef C_ATTRIBUTE_ALWAYS_INLINE
-
-/* Determines if the compilers supports fastcall attribute. */
-#undef C_ATTRIBUTE_FASTCALL
-
-/* Define to 1 to use inlined memory functions in cpu core */
-#undef C_CORE_INLINE
-
-/* Define to 1 to enable internal debugger, requires libcurses */
-#undef C_DEBUG
-
-/* Define to 1 if you want serial passthrough support (Win32, Posix and OS/2).
-   */
-#undef C_DIRECTSERIAL
-
-/* Define to 1 to use x86 dynamic cpu core */
-#undef C_DYNAMIC_X86
-
-/* Define to 1 to use recompiling cpu core. Can not be used together with the
-   dynamic-x86 core */
-#undef C_DYNREC
-
-/* Define to 1 to enable floating point emulation */
-#undef C_FPU
-
-/* Define to 1 to use a x86 assembly fpu core */
-#undef C_FPU_X86
-
-/* Determines if the compilers supports attributes for structures. */
-#undef C_HAS_ATTRIBUTE
-
-/* Determines if the compilers supports __builtin_expect for branch
-   prediction. */
-#undef C_HAS_BUILTIN_EXPECT
-
-/* Define to 1 if you have the mprotect function */
-#undef C_HAVE_MPROTECT
-
-/* Define to 1 to enable heavy debugging, also have to enable C_DEBUG */
-#undef C_HEAVY_DEBUG
-
-/* Define to 1 to enable IPX over Internet networking, requires SDL_net */
-#undef C_IPX
-
-/* Define to 1 to enable internal modem support, requires SDL_net */
-#undef C_MODEM
-
-/* Define to 1 to use opengl display output support */
-#undef C_OPENGL
-
-/* Define to 1 to enable SDL_sound support */
-#undef C_SDL_SOUND
-
-/* Define to 1 if you have setpriority support */
-#undef C_SET_PRIORITY
-
-/* Define to 1 to enable screenshots, requires libpng */
-#undef C_SSHOT
-
-/* The type of cpu this target has */
-#undef C_TARGETCPU
-
-/* Define to 1 to use a unaligned memory access */
-#undef C_UNALIGNED_MEMORY
-
-/* define to 1 if you have XKBlib.h and X11 lib */
-#undef C_X11_XKB
-
-/* libm doesn't include powf */
-#undef DB_HAVE_NO_POWF
-
-/* struct dirent has d_type */
-#undef DIRENT_HAS_D_TYPE
-
-/* environ can be included */
-#undef ENVIRON_INCLUDED
-
-/* environ can be linked */
-#undef ENVIRON_LINKED
-
-/* Define to 1 to use ALSA for MIDI */
-#undef HAVE_ALSA
-
-/* Define to 1 if you have the <ddraw.h> header file. */
-#undef HAVE_DDRAW_H
-
-/* Define to 1 if you have the <inttypes.h> header file. */
-#undef HAVE_INTTYPES_H
-
-/* Define to 1 if you have the `asound' library (-lasound). */
-#undef HAVE_LIBASOUND
-
-/* Define to 1 if you have the <memory.h> header file. */
-#undef HAVE_MEMORY_H
-
-/* Define to 1 if you have the <netinet/in.h> header file. */
-#undef HAVE_NETINET_IN_H
-
-/* Define to 1 if you have the <pwd.h> header file. */
-#undef HAVE_PWD_H
-
-/* Define to 1 if you have the <stdint.h> header file. */
-#undef HAVE_STDINT_H
-
-/* Define to 1 if you have the <stdlib.h> header file. */
-#undef HAVE_STDLIB_H
-
-/* Define to 1 if you have the <strings.h> header file. */
-#undef HAVE_STRINGS_H
-
-/* Define to 1 if you have the <string.h> header file. */
-#undef HAVE_STRING_H
-
-/* Define to 1 if you have the <sys/socket.h> header file. */
-#undef HAVE_SYS_SOCKET_H
-
-/* Define to 1 if you have the <sys/stat.h> header file. */
-#undef HAVE_SYS_STAT_H
-
-/* Define to 1 if you have the <sys/types.h> header file. */
-#undef HAVE_SYS_TYPES_H
-
-/* Define to 1 if you have the <unistd.h> header file. */
-#undef HAVE_UNISTD_H
-
-/* Compiling on GNU/Linux */
-#undef LINUX
-
-/* Compiling on Mac OS X */
-#undef MACOSX
-
-/* Compiling on OS/2 EMX */
-#undef OS2
-
-/* Name of package */
-#undef PACKAGE
-
-/* Define to the address where bug reports for this package should be sent. */
-#undef PACKAGE_BUGREPORT
-
-/* Define to the full name of this package. */
-#undef PACKAGE_NAME
-
-/* Define to the full name and version of this package. */
-#undef PACKAGE_STRING
-
-/* Define to the one symbol short name of this package. */
-#undef PACKAGE_TARNAME
-
-/* Define to the home page for this package. */
-#undef PACKAGE_URL
-
-/* Define to the version of this package. */
-#undef PACKAGE_VERSION
-
-/* The size of `int *', as computed by sizeof. */
-#undef SIZEOF_INT_P
-
-/* The size of `unsigned char', as computed by sizeof. */
-#undef SIZEOF_UNSIGNED_CHAR
-
-/* The size of `unsigned int', as computed by sizeof. */
-#undef SIZEOF_UNSIGNED_INT
-
-/* The size of `unsigned long', as computed by sizeof. */
-#undef SIZEOF_UNSIGNED_LONG
-
-/* The size of `unsigned long long', as computed by sizeof. */
-#undef SIZEOF_UNSIGNED_LONG_LONG
-
-/* The size of `unsigned short', as computed by sizeof. */
-#undef SIZEOF_UNSIGNED_SHORT
-
-/* Define to 1 if you have the ANSI C header files. */
-#undef STDC_HEADERS
-
-/* Define to 1 if your <sys/time.h> declares `struct tm'. */
-#undef TM_IN_SYS_TIME
-
-/* Version number of package */
-#undef VERSION
-
-/* Define WORDS_BIGENDIAN to 1 if your processor stores words with the most
-   significant byte first (like Motorola and SPARC, unlike Intel). */
-#if defined AC_APPLE_UNIVERSAL_BUILD
-# if defined __BIG_ENDIAN__
-#  define WORDS_BIGENDIAN 1
-# endif
-#else
-# ifndef WORDS_BIGENDIAN
-#  undef WORDS_BIGENDIAN
-# endif
-#endif
-
-/* Define to empty if `const' does not conform to ANSI C. */
-#undef const
-
-/* Define to `__inline__' or `__inline' if that's what the C compiler
-   calls it, or to nothing if 'inline' is not supported under any name.  */
-#ifndef __cplusplus
-#undef inline
-#endif
-
-/* Define to `unsigned int' if <sys/types.h> does not define. */
-#undef size_t
-
-/* Define to `int` if you don't have socklen_t */
-#undef socklen_t
-
-#if C_ATTRIBUTE_ALWAYS_INLINE
-#define INLINE inline __attribute__((always_inline))
-#else
-#define INLINE inline
-#endif
-
-#if C_ATTRIBUTE_FASTCALL
-#define DB_FASTCALL __attribute__((fastcall))
-#else
-#define DB_FASTCALL
-#endif
-
-#if C_HAS_ATTRIBUTE
-#define GCC_ATTRIBUTE(x) __attribute__ ((x))
-#else
-#define GCC_ATTRIBUTE(x) /* attribute not supported */
-#endif
-
-#if C_HAS_BUILTIN_EXPECT
-#define GCC_UNLIKELY(x) __builtin_expect((x),0)
-#define GCC_LIKELY(x) __builtin_expect((x),1)
-#else
-#define GCC_UNLIKELY(x) (x)
-#define GCC_LIKELY(x) (x)
-#endif
-
-
-typedef         double     Real64;
-
-#if SIZEOF_UNSIGNED_CHAR != 1
-#  error "sizeof (unsigned char) != 1"
-#else
-  typedef unsigned char Bit8u;
-  typedef   signed char Bit8s;
-#endif
-
-#if SIZEOF_UNSIGNED_SHORT != 2
-#  error "sizeof (unsigned short) != 2"
-#else
-  typedef unsigned short Bit16u;
-  typedef   signed short Bit16s;
-#endif
-
-#if SIZEOF_UNSIGNED_INT == 4
-  typedef unsigned int Bit32u;
-  typedef   signed int Bit32s;
-#elif SIZEOF_UNSIGNED_LONG == 4
-  typedef unsigned long Bit32u;
-  typedef   signed long Bit32s;
-#else
-#  error "can't find sizeof(type) of 4 bytes!"
-#endif
-
-#if SIZEOF_UNSIGNED_LONG == 8
-  typedef unsigned long Bit64u;
-  typedef   signed long Bit64s;
-#elif SIZEOF_UNSIGNED_LONG_LONG == 8
-  typedef unsigned long long Bit64u;
-  typedef   signed long long Bit64s;
-#else
-#  error "can't find data type of 8 bytes"
-#endif
-
-#if SIZEOF_INT_P == 4
-  typedef Bit32u Bitu;
-  typedef Bit32s Bits;
-#else
-  typedef Bit64u Bitu;
-  typedef Bit64s Bits;
-#endif
-
-
diff -Nur dosbox-0.74/config.sub dosbox-0.74.patch/config.sub
--- dosbox-0.74/config.sub	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/config.sub	1970-01-01 01:00:00.000000000 +0100
@@ -1,1714 +0,0 @@
-#! /bin/sh
-# Configuration validation subroutine script.
-#   Copyright (C) 1992, 1993, 1994, 1995, 1996, 1997, 1998, 1999,
-#   2000, 2001, 2002, 2003, 2004, 2005, 2006, 2007, 2008, 2009, 2010
-#   Free Software Foundation, Inc.
-
-timestamp='2010-01-22'
-
-# This file is (in principle) common to ALL GNU software.
-# The presence of a machine in this file suggests that SOME GNU software
-# can handle that machine.  It does not imply ALL GNU software can.
-#
-# This file is free software; you can redistribute it and/or modify
-# it under the terms of the GNU General Public License as published by
-# the Free Software Foundation; either version 2 of the License, or
-# (at your option) any later version.
-#
-# This program is distributed in the hope that it will be useful,
-# but WITHOUT ANY WARRANTY; without even the implied warranty of
-# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-# GNU General Public License for more details.
-#
-# You should have received a copy of the GNU General Public License
-# along with this program; if not, write to the Free Software
-# Foundation, Inc., 51 Franklin Street - Fifth Floor, Boston, MA
-# 02110-1301, USA.
-#
-# As a special exception to the GNU General Public License, if you
-# distribute this file as part of a program that contains a
-# configuration script generated by Autoconf, you may include it under
-# the same distribution terms that you use for the rest of that program.
-
-
-# Please send patches to <config-patches@gnu.org>.  Submit a context
-# diff and a properly formatted GNU ChangeLog entry.
-#
-# Configuration subroutine to validate and canonicalize a configuration type.
-# Supply the specified configuration type as an argument.
-# If it is invalid, we print an error message on stderr and exit with code 1.
-# Otherwise, we print the canonical config type on stdout and succeed.
-
-# You can get the latest version of this script from:
-# http://git.savannah.gnu.org/gitweb/?p=config.git;a=blob_plain;f=config.sub;hb=HEAD
-
-# This file is supposed to be the same for all GNU packages
-# and recognize all the CPU types, system types and aliases
-# that are meaningful with *any* GNU software.
-# Each package is responsible for reporting which valid configurations
-# it does not support.  The user should be able to distinguish
-# a failure to support a valid configuration from a meaningless
-# configuration.
-
-# The goal of this file is to map all the various variations of a given
-# machine specification into a single specification in the form:
-#	CPU_TYPE-MANUFACTURER-OPERATING_SYSTEM
-# or in some cases, the newer four-part form:
-#	CPU_TYPE-MANUFACTURER-KERNEL-OPERATING_SYSTEM
-# It is wrong to echo any other type of specification.
-
-me=`echo "$0" | sed -e 's,.*/,,'`
-
-usage="\
-Usage: $0 [OPTION] CPU-MFR-OPSYS
-       $0 [OPTION] ALIAS
-
-Canonicalize a configuration name.
-
-Operation modes:
-  -h, --help         print this help, then exit
-  -t, --time-stamp   print date of last modification, then exit
-  -v, --version      print version number, then exit
-
-Report bugs and patches to <config-patches@gnu.org>."
-
-version="\
-GNU config.sub ($timestamp)
-
-Copyright (C) 1992, 1993, 1994, 1995, 1996, 1997, 1998, 1999, 2000,
-2001, 2002, 2003, 2004, 2005, 2006, 2007, 2008, 2009, 2010 Free
-Software Foundation, Inc.
-
-This is free software; see the source for copying conditions.  There is NO
-warranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE."
-
-help="
-Try \`$me --help' for more information."
-
-# Parse command line
-while test $# -gt 0 ; do
-  case $1 in
-    --time-stamp | --time* | -t )
-       echo "$timestamp" ; exit ;;
-    --version | -v )
-       echo "$version" ; exit ;;
-    --help | --h* | -h )
-       echo "$usage"; exit ;;
-    -- )     # Stop option processing
-       shift; break ;;
-    - )	# Use stdin as input.
-       break ;;
-    -* )
-       echo "$me: invalid option $1$help"
-       exit 1 ;;
-
-    *local*)
-       # First pass through any local machine types.
-       echo $1
-       exit ;;
-
-    * )
-       break ;;
-  esac
-done
-
-case $# in
- 0) echo "$me: missing argument$help" >&2
-    exit 1;;
- 1) ;;
- *) echo "$me: too many arguments$help" >&2
-    exit 1;;
-esac
-
-# Separate what the user gave into CPU-COMPANY and OS or KERNEL-OS (if any).
-# Here we must recognize all the valid KERNEL-OS combinations.
-maybe_os=`echo $1 | sed 's/^\(.*\)-\([^-]*-[^-]*\)$/\2/'`
-case $maybe_os in
-  nto-qnx* | linux-gnu* | linux-dietlibc | linux-newlib* | linux-uclibc* | \
-  uclinux-uclibc* | uclinux-gnu* | kfreebsd*-gnu* | knetbsd*-gnu* | netbsd*-gnu* | \
-  kopensolaris*-gnu* | \
-  storm-chaos* | os2-emx* | rtmk-nova*)
-    os=-$maybe_os
-    basic_machine=`echo $1 | sed 's/^\(.*\)-\([^-]*-[^-]*\)$/\1/'`
-    ;;
-  *)
-    basic_machine=`echo $1 | sed 's/-[^-]*$//'`
-    if [ $basic_machine != $1 ]
-    then os=`echo $1 | sed 's/.*-/-/'`
-    else os=; fi
-    ;;
-esac
-
-### Let's recognize common machines as not being operating systems so
-### that things like config.sub decstation-3100 work.  We also
-### recognize some manufacturers as not being operating systems, so we
-### can provide default operating systems below.
-case $os in
-	-sun*os*)
-		# Prevent following clause from handling this invalid input.
-		;;
-	-dec* | -mips* | -sequent* | -encore* | -pc532* | -sgi* | -sony* | \
-	-att* | -7300* | -3300* | -delta* | -motorola* | -sun[234]* | \
-	-unicom* | -ibm* | -next | -hp | -isi* | -apollo | -altos* | \
-	-convergent* | -ncr* | -news | -32* | -3600* | -3100* | -hitachi* |\
-	-c[123]* | -convex* | -sun | -crds | -omron* | -dg | -ultra | -tti* | \
-	-harris | -dolphin | -highlevel | -gould | -cbm | -ns | -masscomp | \
-	-apple | -axis | -knuth | -cray | -microblaze)
-		os=
-		basic_machine=$1
-		;;
-        -bluegene*)
-	        os=-cnk
-		;;
-	-sim | -cisco | -oki | -wec | -winbond)
-		os=
-		basic_machine=$1
-		;;
-	-scout)
-		;;
-	-wrs)
-		os=-vxworks
-		basic_machine=$1
-		;;
-	-chorusos*)
-		os=-chorusos
-		basic_machine=$1
-		;;
- 	-chorusrdb)
- 		os=-chorusrdb
-		basic_machine=$1
- 		;;
-	-hiux*)
-		os=-hiuxwe2
-		;;
-	-sco6)
-		os=-sco5v6
-		basic_machine=`echo $1 | sed -e 's/86-.*/86-pc/'`
-		;;
-	-sco5)
-		os=-sco3.2v5
-		basic_machine=`echo $1 | sed -e 's/86-.*/86-pc/'`
-		;;
-	-sco4)
-		os=-sco3.2v4
-		basic_machine=`echo $1 | sed -e 's/86-.*/86-pc/'`
-		;;
-	-sco3.2.[4-9]*)
-		os=`echo $os | sed -e 's/sco3.2./sco3.2v/'`
-		basic_machine=`echo $1 | sed -e 's/86-.*/86-pc/'`
-		;;
-	-sco3.2v[4-9]*)
-		# Don't forget version if it is 3.2v4 or newer.
-		basic_machine=`echo $1 | sed -e 's/86-.*/86-pc/'`
-		;;
-	-sco5v6*)
-		# Don't forget version if it is 3.2v4 or newer.
-		basic_machine=`echo $1 | sed -e 's/86-.*/86-pc/'`
-		;;
-	-sco*)
-		os=-sco3.2v2
-		basic_machine=`echo $1 | sed -e 's/86-.*/86-pc/'`
-		;;
-	-udk*)
-		basic_machine=`echo $1 | sed -e 's/86-.*/86-pc/'`
-		;;
-	-isc)
-		os=-isc2.2
-		basic_machine=`echo $1 | sed -e 's/86-.*/86-pc/'`
-		;;
-	-clix*)
-		basic_machine=clipper-intergraph
-		;;
-	-isc*)
-		basic_machine=`echo $1 | sed -e 's/86-.*/86-pc/'`
-		;;
-	-lynx*)
-		os=-lynxos
-		;;
-	-ptx*)
-		basic_machine=`echo $1 | sed -e 's/86-.*/86-sequent/'`
-		;;
-	-windowsnt*)
-		os=`echo $os | sed -e 's/windowsnt/winnt/'`
-		;;
-	-psos*)
-		os=-psos
-		;;
-	-mint | -mint[0-9]*)
-		basic_machine=m68k-atari
-		os=-mint
-		;;
-esac
-
-# Decode aliases for certain CPU-COMPANY combinations.
-case $basic_machine in
-	# Recognize the basic CPU types without company name.
-	# Some are omitted here because they have special meanings below.
-	1750a | 580 \
-	| a29k \
-	| alpha | alphaev[4-8] | alphaev56 | alphaev6[78] | alphapca5[67] \
-	| alpha64 | alpha64ev[4-8] | alpha64ev56 | alpha64ev6[78] | alpha64pca5[67] \
-	| am33_2.0 \
-	| arc | arm | arm[bl]e | arme[lb] | armv[2345] | armv[345][lb] | avr | avr32 \
-	| bfin \
-	| c4x | clipper \
-	| d10v | d30v | dlx | dsp16xx \
-	| fido | fr30 | frv \
-	| h8300 | h8500 | hppa | hppa1.[01] | hppa2.0 | hppa2.0[nw] | hppa64 \
-	| i370 | i860 | i960 | ia64 \
-	| ip2k | iq2000 \
-	| lm32 \
-	| m32c | m32r | m32rle | m68000 | m68k | m88k \
-	| maxq | mb | microblaze | mcore | mep | metag \
-	| mips | mipsbe | mipseb | mipsel | mipsle \
-	| mips16 \
-	| mips64 | mips64el \
-	| mips64octeon | mips64octeonel \
-	| mips64orion | mips64orionel \
-	| mips64r5900 | mips64r5900el \
-	| mips64vr | mips64vrel \
-	| mips64vr4100 | mips64vr4100el \
-	| mips64vr4300 | mips64vr4300el \
-	| mips64vr5000 | mips64vr5000el \
-	| mips64vr5900 | mips64vr5900el \
-	| mipsisa32 | mipsisa32el \
-	| mipsisa32r2 | mipsisa32r2el \
-	| mipsisa64 | mipsisa64el \
-	| mipsisa64r2 | mipsisa64r2el \
-	| mipsisa64sb1 | mipsisa64sb1el \
-	| mipsisa64sr71k | mipsisa64sr71kel \
-	| mipstx39 | mipstx39el \
-	| mn10200 | mn10300 \
-	| moxie \
-	| mt \
-	| msp430 \
-	| nios | nios2 \
-	| ns16k | ns32k \
-	| or32 \
-	| pdp10 | pdp11 | pj | pjl \
-	| powerpc | powerpc64 | powerpc64le | powerpcle | ppcbe \
-	| pyramid \
-	| rx \
-	| score \
-	| sh | sh[1234] | sh[24]a | sh[24]aeb | sh[23]e | sh[34]eb | sheb | shbe | shle | sh[1234]le | sh3ele \
-	| sh64 | sh64le \
-	| sparc | sparc64 | sparc64b | sparc64v | sparc86x | sparclet | sparclite \
-	| sparcv8 | sparcv9 | sparcv9b | sparcv9v \
-	| spu | strongarm \
-	| tahoe | thumb | tic4x | tic80 | tron \
-	| ubicom32 \
-	| v850 | v850e \
-	| we32k \
-	| x86 | xc16x | xscale | xscalee[bl] | xstormy16 | xtensa \
-	| z8k | z80)
-		basic_machine=$basic_machine-unknown
-		;;
-	m6811 | m68hc11 | m6812 | m68hc12 | picochip)
-		# Motorola 68HC11/12.
-		basic_machine=$basic_machine-unknown
-		os=-none
-		;;
-	m88110 | m680[12346]0 | m683?2 | m68360 | m5200 | v70 | w65 | z8k)
-		;;
-	ms1)
-		basic_machine=mt-unknown
-		;;
-
-	# We use `pc' rather than `unknown'
-	# because (1) that's what they normally are, and
-	# (2) the word "unknown" tends to confuse beginning users.
-	i*86 | x86_64)
-	  basic_machine=$basic_machine-pc
-	  ;;
-	# Object if more than one company name word.
-	*-*-*)
-		echo Invalid configuration \`$1\': machine \`$basic_machine\' not recognized 1>&2
-		exit 1
-		;;
-	# Recognize the basic CPU types with company name.
-	580-* \
-	| a29k-* \
-	| alpha-* | alphaev[4-8]-* | alphaev56-* | alphaev6[78]-* \
-	| alpha64-* | alpha64ev[4-8]-* | alpha64ev56-* | alpha64ev6[78]-* \
-	| alphapca5[67]-* | alpha64pca5[67]-* | arc-* \
-	| arm-*  | armbe-* | armle-* | armeb-* | armv*-* \
-	| avr-* | avr32-* \
-	| bfin-* | bs2000-* \
-	| c[123]* | c30-* | [cjt]90-* | c4x-* | c54x-* | c55x-* | c6x-* \
-	| clipper-* | craynv-* | cydra-* \
-	| d10v-* | d30v-* | dlx-* \
-	| elxsi-* \
-	| f30[01]-* | f700-* | fido-* | fr30-* | frv-* | fx80-* \
-	| h8300-* | h8500-* \
-	| hppa-* | hppa1.[01]-* | hppa2.0-* | hppa2.0[nw]-* | hppa64-* \
-	| i*86-* | i860-* | i960-* | ia64-* \
-	| ip2k-* | iq2000-* \
-	| lm32-* \
-	| m32c-* | m32r-* | m32rle-* \
-	| m68000-* | m680[012346]0-* | m68360-* | m683?2-* | m68k-* \
-	| m88110-* | m88k-* | maxq-* | mcore-* | metag-* | microblaze-* \
-	| mips-* | mipsbe-* | mipseb-* | mipsel-* | mipsle-* \
-	| mips16-* \
-	| mips64-* | mips64el-* \
-	| mips64octeon-* | mips64octeonel-* \
-	| mips64orion-* | mips64orionel-* \
-	| mips64r5900-* | mips64r5900el-* \
-	| mips64vr-* | mips64vrel-* \
-	| mips64vr4100-* | mips64vr4100el-* \
-	| mips64vr4300-* | mips64vr4300el-* \
-	| mips64vr5000-* | mips64vr5000el-* \
-	| mips64vr5900-* | mips64vr5900el-* \
-	| mipsisa32-* | mipsisa32el-* \
-	| mipsisa32r2-* | mipsisa32r2el-* \
-	| mipsisa64-* | mipsisa64el-* \
-	| mipsisa64r2-* | mipsisa64r2el-* \
-	| mipsisa64sb1-* | mipsisa64sb1el-* \
-	| mipsisa64sr71k-* | mipsisa64sr71kel-* \
-	| mipstx39-* | mipstx39el-* \
-	| mmix-* \
-	| mt-* \
-	| msp430-* \
-	| nios-* | nios2-* \
-	| none-* | np1-* | ns16k-* | ns32k-* \
-	| orion-* \
-	| pdp10-* | pdp11-* | pj-* | pjl-* | pn-* | power-* \
-	| powerpc-* | powerpc64-* | powerpc64le-* | powerpcle-* | ppcbe-* \
-	| pyramid-* \
-	| romp-* | rs6000-* | rx-* \
-	| sh-* | sh[1234]-* | sh[24]a-* | sh[24]aeb-* | sh[23]e-* | sh[34]eb-* | sheb-* | shbe-* \
-	| shle-* | sh[1234]le-* | sh3ele-* | sh64-* | sh64le-* \
-	| sparc-* | sparc64-* | sparc64b-* | sparc64v-* | sparc86x-* | sparclet-* \
-	| sparclite-* \
-	| sparcv8-* | sparcv9-* | sparcv9b-* | sparcv9v-* | strongarm-* | sv1-* | sx?-* \
-	| tahoe-* | thumb-* \
-	| tic30-* | tic4x-* | tic54x-* | tic55x-* | tic6x-* | tic80-* \
-	| tile-* | tilegx-* \
-	| tron-* \
-	| ubicom32-* \
-	| v850-* | v850e-* | vax-* \
-	| we32k-* \
-	| x86-* | x86_64-* | xc16x-* | xps100-* | xscale-* | xscalee[bl]-* \
-	| xstormy16-* | xtensa*-* \
-	| ymp-* \
-	| z8k-* | z80-*)
-		;;
-	# Recognize the basic CPU types without company name, with glob match.
-	xtensa*)
-		basic_machine=$basic_machine-unknown
-		;;
-	# Recognize the various machine names and aliases which stand
-	# for a CPU type and a company and sometimes even an OS.
-	386bsd)
-		basic_machine=i386-unknown
-		os=-bsd
-		;;
-	3b1 | 7300 | 7300-att | att-7300 | pc7300 | safari | unixpc)
-		basic_machine=m68000-att
-		;;
-	3b*)
-		basic_machine=we32k-att
-		;;
-	a29khif)
-		basic_machine=a29k-amd
-		os=-udi
-		;;
-    	abacus)
-		basic_machine=abacus-unknown
-		;;
-	adobe68k)
-		basic_machine=m68010-adobe
-		os=-scout
-		;;
-	alliant | fx80)
-		basic_machine=fx80-alliant
-		;;
-	altos | altos3068)
-		basic_machine=m68k-altos
-		;;
-	am29k)
-		basic_machine=a29k-none
-		os=-bsd
-		;;
-	amd64)
-		basic_machine=x86_64-pc
-		;;
-	amd64-*)
-		basic_machine=x86_64-`echo $basic_machine | sed 's/^[^-]*-//'`
-		;;
-	amdahl)
-		basic_machine=580-amdahl
-		os=-sysv
-		;;
-	amiga | amiga-*)
-		basic_machine=m68k-unknown
-		;;
-	amigaos | amigados)
-		basic_machine=m68k-unknown
-		os=-amigaos
-		;;
-	amigaunix | amix)
-		basic_machine=m68k-unknown
-		os=-sysv4
-		;;
-	apollo68)
-		basic_machine=m68k-apollo
-		os=-sysv
-		;;
-	apollo68bsd)
-		basic_machine=m68k-apollo
-		os=-bsd
-		;;
-	aros)
-		basic_machine=i386-pc
-		os=-aros
-		;;
-	aux)
-		basic_machine=m68k-apple
-		os=-aux
-		;;
-	balance)
-		basic_machine=ns32k-sequent
-		os=-dynix
-		;;
-	blackfin)
-		basic_machine=bfin-unknown
-		os=-linux
-		;;
-	blackfin-*)
-		basic_machine=bfin-`echo $basic_machine | sed 's/^[^-]*-//'`
-		os=-linux
-		;;
-	bluegene*)
-		basic_machine=powerpc-ibm
-		os=-cnk
-		;;
-	c90)
-		basic_machine=c90-cray
-		os=-unicos
-		;;
-        cegcc)
-		basic_machine=arm-unknown
-		os=-cegcc
-		;;
-	convex-c1)
-		basic_machine=c1-convex
-		os=-bsd
-		;;
-	convex-c2)
-		basic_machine=c2-convex
-		os=-bsd
-		;;
-	convex-c32)
-		basic_machine=c32-convex
-		os=-bsd
-		;;
-	convex-c34)
-		basic_machine=c34-convex
-		os=-bsd
-		;;
-	convex-c38)
-		basic_machine=c38-convex
-		os=-bsd
-		;;
-	cray | j90)
-		basic_machine=j90-cray
-		os=-unicos
-		;;
-	craynv)
-		basic_machine=craynv-cray
-		os=-unicosmp
-		;;
-	cr16)
-		basic_machine=cr16-unknown
-		os=-elf
-		;;
-	crds | unos)
-		basic_machine=m68k-crds
-		;;
-	crisv32 | crisv32-* | etraxfs*)
-		basic_machine=crisv32-axis
-		;;
-	cris | cris-* | etrax*)
-		basic_machine=cris-axis
-		;;
-	crx)
-		basic_machine=crx-unknown
-		os=-elf
-		;;
-	da30 | da30-*)
-		basic_machine=m68k-da30
-		;;
-	decstation | decstation-3100 | pmax | pmax-* | pmin | dec3100 | decstatn)
-		basic_machine=mips-dec
-		;;
-	decsystem10* | dec10*)
-		basic_machine=pdp10-dec
-		os=-tops10
-		;;
-	decsystem20* | dec20*)
-		basic_machine=pdp10-dec
-		os=-tops20
-		;;
-	delta | 3300 | motorola-3300 | motorola-delta \
-	      | 3300-motorola | delta-motorola)
-		basic_machine=m68k-motorola
-		;;
-	delta88)
-		basic_machine=m88k-motorola
-		os=-sysv3
-		;;
-	dicos)
-		basic_machine=i686-pc
-		os=-dicos
-		;;
-	djgpp)
-		basic_machine=i586-pc
-		os=-msdosdjgpp
-		;;
-	dpx20 | dpx20-*)
-		basic_machine=rs6000-bull
-		os=-bosx
-		;;
-	dpx2* | dpx2*-bull)
-		basic_machine=m68k-bull
-		os=-sysv3
-		;;
-	ebmon29k)
-		basic_machine=a29k-amd
-		os=-ebmon
-		;;
-	elxsi)
-		basic_machine=elxsi-elxsi
-		os=-bsd
-		;;
-	encore | umax | mmax)
-		basic_machine=ns32k-encore
-		;;
-	es1800 | OSE68k | ose68k | ose | OSE)
-		basic_machine=m68k-ericsson
-		os=-ose
-		;;
-	fx2800)
-		basic_machine=i860-alliant
-		;;
-	genix)
-		basic_machine=ns32k-ns
-		;;
-	gmicro)
-		basic_machine=tron-gmicro
-		os=-sysv
-		;;
-	go32)
-		basic_machine=i386-pc
-		os=-go32
-		;;
-	h3050r* | hiux*)
-		basic_machine=hppa1.1-hitachi
-		os=-hiuxwe2
-		;;
-	h8300hms)
-		basic_machine=h8300-hitachi
-		os=-hms
-		;;
-	h8300xray)
-		basic_machine=h8300-hitachi
-		os=-xray
-		;;
-	h8500hms)
-		basic_machine=h8500-hitachi
-		os=-hms
-		;;
-	harris)
-		basic_machine=m88k-harris
-		os=-sysv3
-		;;
-	hp300-*)
-		basic_machine=m68k-hp
-		;;
-	hp300bsd)
-		basic_machine=m68k-hp
-		os=-bsd
-		;;
-	hp300hpux)
-		basic_machine=m68k-hp
-		os=-hpux
-		;;
-	hp3k9[0-9][0-9] | hp9[0-9][0-9])
-		basic_machine=hppa1.0-hp
-		;;
-	hp9k2[0-9][0-9] | hp9k31[0-9])
-		basic_machine=m68000-hp
-		;;
-	hp9k3[2-9][0-9])
-		basic_machine=m68k-hp
-		;;
-	hp9k6[0-9][0-9] | hp6[0-9][0-9])
-		basic_machine=hppa1.0-hp
-		;;
-	hp9k7[0-79][0-9] | hp7[0-79][0-9])
-		basic_machine=hppa1.1-hp
-		;;
-	hp9k78[0-9] | hp78[0-9])
-		# FIXME: really hppa2.0-hp
-		basic_machine=hppa1.1-hp
-		;;
-	hp9k8[67]1 | hp8[67]1 | hp9k80[24] | hp80[24] | hp9k8[78]9 | hp8[78]9 | hp9k893 | hp893)
-		# FIXME: really hppa2.0-hp
-		basic_machine=hppa1.1-hp
-		;;
-	hp9k8[0-9][13679] | hp8[0-9][13679])
-		basic_machine=hppa1.1-hp
-		;;
-	hp9k8[0-9][0-9] | hp8[0-9][0-9])
-		basic_machine=hppa1.0-hp
-		;;
-	hppa-next)
-		os=-nextstep3
-		;;
-	hppaosf)
-		basic_machine=hppa1.1-hp
-		os=-osf
-		;;
-	hppro)
-		basic_machine=hppa1.1-hp
-		os=-proelf
-		;;
-	i370-ibm* | ibm*)
-		basic_machine=i370-ibm
-		;;
-# I'm not sure what "Sysv32" means.  Should this be sysv3.2?
-	i*86v32)
-		basic_machine=`echo $1 | sed -e 's/86.*/86-pc/'`
-		os=-sysv32
-		;;
-	i*86v4*)
-		basic_machine=`echo $1 | sed -e 's/86.*/86-pc/'`
-		os=-sysv4
-		;;
-	i*86v)
-		basic_machine=`echo $1 | sed -e 's/86.*/86-pc/'`
-		os=-sysv
-		;;
-	i*86sol2)
-		basic_machine=`echo $1 | sed -e 's/86.*/86-pc/'`
-		os=-solaris2
-		;;
-	i386mach)
-		basic_machine=i386-mach
-		os=-mach
-		;;
-	i386-vsta | vsta)
-		basic_machine=i386-unknown
-		os=-vsta
-		;;
-	iris | iris4d)
-		basic_machine=mips-sgi
-		case $os in
-		    -irix*)
-			;;
-		    *)
-			os=-irix4
-			;;
-		esac
-		;;
-	isi68 | isi)
-		basic_machine=m68k-isi
-		os=-sysv
-		;;
-	m68knommu)
-		basic_machine=m68k-unknown
-		os=-linux
-		;;
-	m68knommu-*)
-		basic_machine=m68k-`echo $basic_machine | sed 's/^[^-]*-//'`
-		os=-linux
-		;;
-	m88k-omron*)
-		basic_machine=m88k-omron
-		;;
-	magnum | m3230)
-		basic_machine=mips-mips
-		os=-sysv
-		;;
-	merlin)
-		basic_machine=ns32k-utek
-		os=-sysv
-		;;
-        microblaze)
-		basic_machine=microblaze-xilinx
-		;;
-	mingw32)
-		basic_machine=i386-pc
-		os=-mingw32
-		;;
-	mingw32ce)
-		basic_machine=arm-unknown
-		os=-mingw32ce
-		;;
-	miniframe)
-		basic_machine=m68000-convergent
-		;;
-	*mint | -mint[0-9]* | *MiNT | *MiNT[0-9]*)
-		basic_machine=m68k-atari
-		os=-mint
-		;;
-	mips3*-*)
-		basic_machine=`echo $basic_machine | sed -e 's/mips3/mips64/'`
-		;;
-	mips3*)
-		basic_machine=`echo $basic_machine | sed -e 's/mips3/mips64/'`-unknown
-		;;
-	monitor)
-		basic_machine=m68k-rom68k
-		os=-coff
-		;;
-	morphos)
-		basic_machine=powerpc-unknown
-		os=-morphos
-		;;
-	msdos)
-		basic_machine=i386-pc
-		os=-msdos
-		;;
-	ms1-*)
-		basic_machine=`echo $basic_machine | sed -e 's/ms1-/mt-/'`
-		;;
-	mvs)
-		basic_machine=i370-ibm
-		os=-mvs
-		;;
-	ncr3000)
-		basic_machine=i486-ncr
-		os=-sysv4
-		;;
-	netbsd386)
-		basic_machine=i386-unknown
-		os=-netbsd
-		;;
-	netwinder)
-		basic_machine=armv4l-rebel
-		os=-linux
-		;;
-	news | news700 | news800 | news900)
-		basic_machine=m68k-sony
-		os=-newsos
-		;;
-	news1000)
-		basic_machine=m68030-sony
-		os=-newsos
-		;;
-	news-3600 | risc-news)
-		basic_machine=mips-sony
-		os=-newsos
-		;;
-	necv70)
-		basic_machine=v70-nec
-		os=-sysv
-		;;
-	next | m*-next )
-		basic_machine=m68k-next
-		case $os in
-		    -nextstep* )
-			;;
-		    -ns2*)
-		      os=-nextstep2
-			;;
-		    *)
-		      os=-nextstep3
-			;;
-		esac
-		;;
-	nh3000)
-		basic_machine=m68k-harris
-		os=-cxux
-		;;
-	nh[45]000)
-		basic_machine=m88k-harris
-		os=-cxux
-		;;
-	nindy960)
-		basic_machine=i960-intel
-		os=-nindy
-		;;
-	mon960)
-		basic_machine=i960-intel
-		os=-mon960
-		;;
-	nonstopux)
-		basic_machine=mips-compaq
-		os=-nonstopux
-		;;
-	np1)
-		basic_machine=np1-gould
-		;;
-	nsr-tandem)
-		basic_machine=nsr-tandem
-		;;
-	op50n-* | op60c-*)
-		basic_machine=hppa1.1-oki
-		os=-proelf
-		;;
-	openrisc | openrisc-*)
-		basic_machine=or32-unknown
-		;;
-	os400)
-		basic_machine=powerpc-ibm
-		os=-os400
-		;;
-	OSE68000 | ose68000)
-		basic_machine=m68000-ericsson
-		os=-ose
-		;;
-	os68k)
-		basic_machine=m68k-none
-		os=-os68k
-		;;
-	pa-hitachi)
-		basic_machine=hppa1.1-hitachi
-		os=-hiuxwe2
-		;;
-	paragon)
-		basic_machine=i860-intel
-		os=-osf
-		;;
-	parisc)
-		basic_machine=hppa-unknown
-		os=-linux
-		;;
-	parisc-*)
-		basic_machine=hppa-`echo $basic_machine | sed 's/^[^-]*-//'`
-		os=-linux
-		;;
-	pbd)
-		basic_machine=sparc-tti
-		;;
-	pbb)
-		basic_machine=m68k-tti
-		;;
-	pc532 | pc532-*)
-		basic_machine=ns32k-pc532
-		;;
-	pc98)
-		basic_machine=i386-pc
-		;;
-	pc98-*)
-		basic_machine=i386-`echo $basic_machine | sed 's/^[^-]*-//'`
-		;;
-	pentium | p5 | k5 | k6 | nexgen | viac3)
-		basic_machine=i586-pc
-		;;
-	pentiumpro | p6 | 6x86 | athlon | athlon_*)
-		basic_machine=i686-pc
-		;;
-	pentiumii | pentium2 | pentiumiii | pentium3)
-		basic_machine=i686-pc
-		;;
-	pentium4)
-		basic_machine=i786-pc
-		;;
-	pentium-* | p5-* | k5-* | k6-* | nexgen-* | viac3-*)
-		basic_machine=i586-`echo $basic_machine | sed 's/^[^-]*-//'`
-		;;
-	pentiumpro-* | p6-* | 6x86-* | athlon-*)
-		basic_machine=i686-`echo $basic_machine | sed 's/^[^-]*-//'`
-		;;
-	pentiumii-* | pentium2-* | pentiumiii-* | pentium3-*)
-		basic_machine=i686-`echo $basic_machine | sed 's/^[^-]*-//'`
-		;;
-	pentium4-*)
-		basic_machine=i786-`echo $basic_machine | sed 's/^[^-]*-//'`
-		;;
-	pn)
-		basic_machine=pn-gould
-		;;
-	power)	basic_machine=power-ibm
-		;;
-	ppc)	basic_machine=powerpc-unknown
-		;;
-	ppc-*)	basic_machine=powerpc-`echo $basic_machine | sed 's/^[^-]*-//'`
-		;;
-	ppcle | powerpclittle | ppc-le | powerpc-little)
-		basic_machine=powerpcle-unknown
-		;;
-	ppcle-* | powerpclittle-*)
-		basic_machine=powerpcle-`echo $basic_machine | sed 's/^[^-]*-//'`
-		;;
-	ppc64)	basic_machine=powerpc64-unknown
-		;;
-	ppc64-*) basic_machine=powerpc64-`echo $basic_machine | sed 's/^[^-]*-//'`
-		;;
-	ppc64le | powerpc64little | ppc64-le | powerpc64-little)
-		basic_machine=powerpc64le-unknown
-		;;
-	ppc64le-* | powerpc64little-*)
-		basic_machine=powerpc64le-`echo $basic_machine | sed 's/^[^-]*-//'`
-		;;
-	ps2)
-		basic_machine=i386-ibm
-		;;
-	pw32)
-		basic_machine=i586-unknown
-		os=-pw32
-		;;
-	rdos)
-		basic_machine=i386-pc
-		os=-rdos
-		;;
-	rom68k)
-		basic_machine=m68k-rom68k
-		os=-coff
-		;;
-	rm[46]00)
-		basic_machine=mips-siemens
-		;;
-	rtpc | rtpc-*)
-		basic_machine=romp-ibm
-		;;
-	s390 | s390-*)
-		basic_machine=s390-ibm
-		;;
-	s390x | s390x-*)
-		basic_machine=s390x-ibm
-		;;
-	sa29200)
-		basic_machine=a29k-amd
-		os=-udi
-		;;
-	sb1)
-		basic_machine=mipsisa64sb1-unknown
-		;;
-	sb1el)
-		basic_machine=mipsisa64sb1el-unknown
-		;;
-	sde)
-		basic_machine=mipsisa32-sde
-		os=-elf
-		;;
-	sei)
-		basic_machine=mips-sei
-		os=-seiux
-		;;
-	sequent)
-		basic_machine=i386-sequent
-		;;
-	sh)
-		basic_machine=sh-hitachi
-		os=-hms
-		;;
-	sh5el)
-		basic_machine=sh5le-unknown
-		;;
-	sh64)
-		basic_machine=sh64-unknown
-		;;
-	sparclite-wrs | simso-wrs)
-		basic_machine=sparclite-wrs
-		os=-vxworks
-		;;
-	sps7)
-		basic_machine=m68k-bull
-		os=-sysv2
-		;;
-	spur)
-		basic_machine=spur-unknown
-		;;
-	st2000)
-		basic_machine=m68k-tandem
-		;;
-	stratus)
-		basic_machine=i860-stratus
-		os=-sysv4
-		;;
-	sun2)
-		basic_machine=m68000-sun
-		;;
-	sun2os3)
-		basic_machine=m68000-sun
-		os=-sunos3
-		;;
-	sun2os4)
-		basic_machine=m68000-sun
-		os=-sunos4
-		;;
-	sun3os3)
-		basic_machine=m68k-sun
-		os=-sunos3
-		;;
-	sun3os4)
-		basic_machine=m68k-sun
-		os=-sunos4
-		;;
-	sun4os3)
-		basic_machine=sparc-sun
-		os=-sunos3
-		;;
-	sun4os4)
-		basic_machine=sparc-sun
-		os=-sunos4
-		;;
-	sun4sol2)
-		basic_machine=sparc-sun
-		os=-solaris2
-		;;
-	sun3 | sun3-*)
-		basic_machine=m68k-sun
-		;;
-	sun4)
-		basic_machine=sparc-sun
-		;;
-	sun386 | sun386i | roadrunner)
-		basic_machine=i386-sun
-		;;
-	sv1)
-		basic_machine=sv1-cray
-		os=-unicos
-		;;
-	symmetry)
-		basic_machine=i386-sequent
-		os=-dynix
-		;;
-	t3e)
-		basic_machine=alphaev5-cray
-		os=-unicos
-		;;
-	t90)
-		basic_machine=t90-cray
-		os=-unicos
-		;;
-	tic54x | c54x*)
-		basic_machine=tic54x-unknown
-		os=-coff
-		;;
-	tic55x | c55x*)
-		basic_machine=tic55x-unknown
-		os=-coff
-		;;
-	tic6x | c6x*)
-		basic_machine=tic6x-unknown
-		os=-coff
-		;;
-        # This must be matched before tile*.
-        tilegx*)
-		basic_machine=tilegx-unknown
-		os=-linux-gnu
-		;;
-	tile*)
-		basic_machine=tile-unknown
-		os=-linux-gnu
-		;;
-	tx39)
-		basic_machine=mipstx39-unknown
-		;;
-	tx39el)
-		basic_machine=mipstx39el-unknown
-		;;
-	toad1)
-		basic_machine=pdp10-xkl
-		os=-tops20
-		;;
-	tower | tower-32)
-		basic_machine=m68k-ncr
-		;;
-	tpf)
-		basic_machine=s390x-ibm
-		os=-tpf
-		;;
-	udi29k)
-		basic_machine=a29k-amd
-		os=-udi
-		;;
-	ultra3)
-		basic_machine=a29k-nyu
-		os=-sym1
-		;;
-	v810 | necv810)
-		basic_machine=v810-nec
-		os=-none
-		;;
-	vaxv)
-		basic_machine=vax-dec
-		os=-sysv
-		;;
-	vms)
-		basic_machine=vax-dec
-		os=-vms
-		;;
-	vpp*|vx|vx-*)
-		basic_machine=f301-fujitsu
-		;;
-	vxworks960)
-		basic_machine=i960-wrs
-		os=-vxworks
-		;;
-	vxworks68)
-		basic_machine=m68k-wrs
-		os=-vxworks
-		;;
-	vxworks29k)
-		basic_machine=a29k-wrs
-		os=-vxworks
-		;;
-	w65*)
-		basic_machine=w65-wdc
-		os=-none
-		;;
-	w89k-*)
-		basic_machine=hppa1.1-winbond
-		os=-proelf
-		;;
-	xbox)
-		basic_machine=i686-pc
-		os=-mingw32
-		;;
-	xps | xps100)
-		basic_machine=xps100-honeywell
-		;;
-	ymp)
-		basic_machine=ymp-cray
-		os=-unicos
-		;;
-	z8k-*-coff)
-		basic_machine=z8k-unknown
-		os=-sim
-		;;
-	z80-*-coff)
-		basic_machine=z80-unknown
-		os=-sim
-		;;
-	none)
-		basic_machine=none-none
-		os=-none
-		;;
-
-# Here we handle the default manufacturer of certain CPU types.  It is in
-# some cases the only manufacturer, in others, it is the most popular.
-	w89k)
-		basic_machine=hppa1.1-winbond
-		;;
-	op50n)
-		basic_machine=hppa1.1-oki
-		;;
-	op60c)
-		basic_machine=hppa1.1-oki
-		;;
-	romp)
-		basic_machine=romp-ibm
-		;;
-	mmix)
-		basic_machine=mmix-knuth
-		;;
-	rs6000)
-		basic_machine=rs6000-ibm
-		;;
-	vax)
-		basic_machine=vax-dec
-		;;
-	pdp10)
-		# there are many clones, so DEC is not a safe bet
-		basic_machine=pdp10-unknown
-		;;
-	pdp11)
-		basic_machine=pdp11-dec
-		;;
-	we32k)
-		basic_machine=we32k-att
-		;;
-	sh[1234] | sh[24]a | sh[24]aeb | sh[34]eb | sh[1234]le | sh[23]ele)
-		basic_machine=sh-unknown
-		;;
-	sparc | sparcv8 | sparcv9 | sparcv9b | sparcv9v)
-		basic_machine=sparc-sun
-		;;
-	cydra)
-		basic_machine=cydra-cydrome
-		;;
-	orion)
-		basic_machine=orion-highlevel
-		;;
-	orion105)
-		basic_machine=clipper-highlevel
-		;;
-	mac | mpw | mac-mpw)
-		basic_machine=m68k-apple
-		;;
-	pmac | pmac-mpw)
-		basic_machine=powerpc-apple
-		;;
-	*-unknown)
-		# Make sure to match an already-canonicalized machine name.
-		;;
-	*)
-		echo Invalid configuration \`$1\': machine \`$basic_machine\' not recognized 1>&2
-		exit 1
-		;;
-esac
-
-# Here we canonicalize certain aliases for manufacturers.
-case $basic_machine in
-	*-digital*)
-		basic_machine=`echo $basic_machine | sed 's/digital.*/dec/'`
-		;;
-	*-commodore*)
-		basic_machine=`echo $basic_machine | sed 's/commodore.*/cbm/'`
-		;;
-	*)
-		;;
-esac
-
-# Decode manufacturer-specific aliases for certain operating systems.
-
-if [ x"$os" != x"" ]
-then
-case $os in
-        # First match some system type aliases
-        # that might get confused with valid system types.
-	# -solaris* is a basic system type, with this one exception.
-        -auroraux)
-	        os=-auroraux
-		;;
-	-solaris1 | -solaris1.*)
-		os=`echo $os | sed -e 's|solaris1|sunos4|'`
-		;;
-	-solaris)
-		os=-solaris2
-		;;
-	-svr4*)
-		os=-sysv4
-		;;
-	-unixware*)
-		os=-sysv4.2uw
-		;;
-	-gnu/linux*)
-		os=`echo $os | sed -e 's|gnu/linux|linux-gnu|'`
-		;;
-	# First accept the basic system types.
-	# The portable systems comes first.
-	# Each alternative MUST END IN A *, to match a version number.
-	# -sysv* is not here because it comes later, after sysvr4.
-	-gnu* | -bsd* | -mach* | -minix* | -genix* | -ultrix* | -irix* \
-	      | -*vms* | -sco* | -esix* | -isc* | -aix* | -cnk* | -sunos | -sunos[34]*\
-	      | -hpux* | -unos* | -osf* | -luna* | -dgux* | -auroraux* | -solaris* \
-	      | -sym* | -kopensolaris* \
-	      | -amigaos* | -amigados* | -msdos* | -newsos* | -unicos* | -aof* \
-	      | -aos* | -aros* \
-	      | -nindy* | -vxsim* | -vxworks* | -ebmon* | -hms* | -mvs* \
-	      | -clix* | -riscos* | -uniplus* | -iris* | -rtu* | -xenix* \
-	      | -hiux* | -386bsd* | -knetbsd* | -mirbsd* | -netbsd* \
-	      | -openbsd* | -solidbsd* \
-	      | -ekkobsd* | -kfreebsd* | -freebsd* | -riscix* | -lynxos* \
-	      | -bosx* | -nextstep* | -cxux* | -aout* | -elf* | -oabi* \
-	      | -ptx* | -coff* | -ecoff* | -winnt* | -domain* | -vsta* \
-	      | -udi* | -eabi* | -lites* | -ieee* | -go32* | -aux* \
-	      | -chorusos* | -chorusrdb* | -cegcc* \
-	      | -cygwin* | -pe* | -psos* | -moss* | -proelf* | -rtems* \
-	      | -mingw32* | -linux-gnu* | -linux-newlib* | -linux-uclibc* \
-	      | -uxpv* | -beos* | -mpeix* | -udk* \
-	      | -interix* | -uwin* | -mks* | -rhapsody* | -darwin* | -opened* \
-	      | -openstep* | -oskit* | -conix* | -pw32* | -nonstopux* \
-	      | -storm-chaos* | -tops10* | -tenex* | -tops20* | -its* \
-	      | -os2* | -vos* | -palmos* | -uclinux* | -nucleus* \
-	      | -morphos* | -superux* | -rtmk* | -rtmk-nova* | -windiss* \
-	      | -powermax* | -dnix* | -nx6 | -nx7 | -sei* | -dragonfly* \
-	      | -skyos* | -haiku* | -rdos* | -toppers* | -drops* | -es*)
-	# Remember, each alternative MUST END IN *, to match a version number.
-		;;
-	-qnx*)
-		case $basic_machine in
-		    x86-* | i*86-*)
-			;;
-		    *)
-			os=-nto$os
-			;;
-		esac
-		;;
-	-nto-qnx*)
-		;;
-	-nto*)
-		os=`echo $os | sed -e 's|nto|nto-qnx|'`
-		;;
-	-sim | -es1800* | -hms* | -xray | -os68k* | -none* | -v88r* \
-	      | -windows* | -osx | -abug | -netware* | -os9* | -beos* | -haiku* \
-	      | -macos* | -mpw* | -magic* | -mmixware* | -mon960* | -lnews*)
-		;;
-	-mac*)
-		os=`echo $os | sed -e 's|mac|macos|'`
-		;;
-	-linux-dietlibc)
-		os=-linux-dietlibc
-		;;
-	-linux*)
-		os=`echo $os | sed -e 's|linux|linux-gnu|'`
-		;;
-	-sunos5*)
-		os=`echo $os | sed -e 's|sunos5|solaris2|'`
-		;;
-	-sunos6*)
-		os=`echo $os | sed -e 's|sunos6|solaris3|'`
-		;;
-	-opened*)
-		os=-openedition
-		;;
-        -os400*)
-		os=-os400
-		;;
-	-wince*)
-		os=-wince
-		;;
-	-osfrose*)
-		os=-osfrose
-		;;
-	-osf*)
-		os=-osf
-		;;
-	-utek*)
-		os=-bsd
-		;;
-	-dynix*)
-		os=-bsd
-		;;
-	-acis*)
-		os=-aos
-		;;
-	-atheos*)
-		os=-atheos
-		;;
-	-syllable*)
-		os=-syllable
-		;;
-	-386bsd)
-		os=-bsd
-		;;
-	-ctix* | -uts*)
-		os=-sysv
-		;;
-	-nova*)
-		os=-rtmk-nova
-		;;
-	-ns2 )
-		os=-nextstep2
-		;;
-	-nsk*)
-		os=-nsk
-		;;
-	# Preserve the version number of sinix5.
-	-sinix5.*)
-		os=`echo $os | sed -e 's|sinix|sysv|'`
-		;;
-	-sinix*)
-		os=-sysv4
-		;;
-        -tpf*)
-		os=-tpf
-		;;
-	-triton*)
-		os=-sysv3
-		;;
-	-oss*)
-		os=-sysv3
-		;;
-	-svr4)
-		os=-sysv4
-		;;
-	-svr3)
-		os=-sysv3
-		;;
-	-sysvr4)
-		os=-sysv4
-		;;
-	# This must come after -sysvr4.
-	-sysv*)
-		;;
-	-ose*)
-		os=-ose
-		;;
-	-es1800*)
-		os=-ose
-		;;
-	-xenix)
-		os=-xenix
-		;;
-	-*mint | -mint[0-9]* | -*MiNT | -MiNT[0-9]*)
-		os=-mint
-		;;
-	-aros*)
-		os=-aros
-		;;
-	-kaos*)
-		os=-kaos
-		;;
-	-zvmoe)
-		os=-zvmoe
-		;;
-	-dicos*)
-		os=-dicos
-		;;
-        -nacl*)
-	        ;;
-	-none)
-		;;
-	*)
-		# Get rid of the `-' at the beginning of $os.
-		os=`echo $os | sed 's/[^-]*-//'`
-		echo Invalid configuration \`$1\': system \`$os\' not recognized 1>&2
-		exit 1
-		;;
-esac
-else
-
-# Here we handle the default operating systems that come with various machines.
-# The value should be what the vendor currently ships out the door with their
-# machine or put another way, the most popular os provided with the machine.
-
-# Note that if you're going to try to match "-MANUFACTURER" here (say,
-# "-sun"), then you have to tell the case statement up towards the top
-# that MANUFACTURER isn't an operating system.  Otherwise, code above
-# will signal an error saying that MANUFACTURER isn't an operating
-# system, and we'll never get to this point.
-
-case $basic_machine in
-        score-*)
-		os=-elf
-		;;
-        spu-*)
-		os=-elf
-		;;
-	*-acorn)
-		os=-riscix1.2
-		;;
-	arm*-rebel)
-		os=-linux
-		;;
-	arm*-semi)
-		os=-aout
-		;;
-        c4x-* | tic4x-*)
-        	os=-coff
-		;;
-	# This must come before the *-dec entry.
-	pdp10-*)
-		os=-tops20
-		;;
-	pdp11-*)
-		os=-none
-		;;
-	*-dec | vax-*)
-		os=-ultrix4.2
-		;;
-	m68*-apollo)
-		os=-domain
-		;;
-	i386-sun)
-		os=-sunos4.0.2
-		;;
-	m68000-sun)
-		os=-sunos3
-		# This also exists in the configure program, but was not the
-		# default.
-		# os=-sunos4
-		;;
-	m68*-cisco)
-		os=-aout
-		;;
-        mep-*)
-		os=-elf
-		;;
-	mips*-cisco)
-		os=-elf
-		;;
-	mips*-*)
-		os=-elf
-		;;
-	or32-*)
-		os=-coff
-		;;
-	*-tti)	# must be before sparc entry or we get the wrong os.
-		os=-sysv3
-		;;
-	sparc-* | *-sun)
-		os=-sunos4.1.1
-		;;
-	*-be)
-		os=-beos
-		;;
-	*-haiku)
-		os=-haiku
-		;;
-	*-ibm)
-		os=-aix
-		;;
-    	*-knuth)
-		os=-mmixware
-		;;
-	*-wec)
-		os=-proelf
-		;;
-	*-winbond)
-		os=-proelf
-		;;
-	*-oki)
-		os=-proelf
-		;;
-	*-hp)
-		os=-hpux
-		;;
-	*-hitachi)
-		os=-hiux
-		;;
-	i860-* | *-att | *-ncr | *-altos | *-motorola | *-convergent)
-		os=-sysv
-		;;
-	*-cbm)
-		os=-amigaos
-		;;
-	*-dg)
-		os=-dgux
-		;;
-	*-dolphin)
-		os=-sysv3
-		;;
-	m68k-ccur)
-		os=-rtu
-		;;
-	m88k-omron*)
-		os=-luna
-		;;
-	*-next )
-		os=-nextstep
-		;;
-	*-sequent)
-		os=-ptx
-		;;
-	*-crds)
-		os=-unos
-		;;
-	*-ns)
-		os=-genix
-		;;
-	i370-*)
-		os=-mvs
-		;;
-	*-next)
-		os=-nextstep3
-		;;
-	*-gould)
-		os=-sysv
-		;;
-	*-highlevel)
-		os=-bsd
-		;;
-	*-encore)
-		os=-bsd
-		;;
-	*-sgi)
-		os=-irix
-		;;
-	*-siemens)
-		os=-sysv4
-		;;
-	*-masscomp)
-		os=-rtu
-		;;
-	f30[01]-fujitsu | f700-fujitsu)
-		os=-uxpv
-		;;
-	*-rom68k)
-		os=-coff
-		;;
-	*-*bug)
-		os=-coff
-		;;
-	*-apple)
-		os=-macos
-		;;
-	*-atari*)
-		os=-mint
-		;;
-	*)
-		os=-none
-		;;
-esac
-fi
-
-# Here we handle the case where we know the os, and the CPU type, but not the
-# manufacturer.  We pick the logical manufacturer.
-vendor=unknown
-case $basic_machine in
-	*-unknown)
-		case $os in
-			-riscix*)
-				vendor=acorn
-				;;
-			-sunos*)
-				vendor=sun
-				;;
-			-cnk*|-aix*)
-				vendor=ibm
-				;;
-			-beos*)
-				vendor=be
-				;;
-			-hpux*)
-				vendor=hp
-				;;
-			-mpeix*)
-				vendor=hp
-				;;
-			-hiux*)
-				vendor=hitachi
-				;;
-			-unos*)
-				vendor=crds
-				;;
-			-dgux*)
-				vendor=dg
-				;;
-			-luna*)
-				vendor=omron
-				;;
-			-genix*)
-				vendor=ns
-				;;
-			-mvs* | -opened*)
-				vendor=ibm
-				;;
-			-os400*)
-				vendor=ibm
-				;;
-			-ptx*)
-				vendor=sequent
-				;;
-			-tpf*)
-				vendor=ibm
-				;;
-			-vxsim* | -vxworks* | -windiss*)
-				vendor=wrs
-				;;
-			-aux*)
-				vendor=apple
-				;;
-			-hms*)
-				vendor=hitachi
-				;;
-			-mpw* | -macos*)
-				vendor=apple
-				;;
-			-*mint | -mint[0-9]* | -*MiNT | -MiNT[0-9]*)
-				vendor=atari
-				;;
-			-vos*)
-				vendor=stratus
-				;;
-		esac
-		basic_machine=`echo $basic_machine | sed "s/unknown/$vendor/"`
-		;;
-esac
-
-echo $basic_machine$os
-exit
-
-# Local variables:
-# eval: (add-hook 'write-file-hooks 'time-stamp)
-# time-stamp-start: "timestamp='"
-# time-stamp-format: "%:y-%02m-%02d"
-# time-stamp-end: "'"
-# End:
diff -Nur dosbox-0.74/configure dosbox-0.74.patch/configure
--- dosbox-0.74/configure	2010-05-10 20:59:04.000000000 +0200
+++ dosbox-0.74.patch/configure	1970-01-01 01:00:00.000000000 +0100
@@ -1,8754 +0,0 @@
-#! /bin/sh
-# Guess values for system-dependent variables and create Makefiles.
-# Generated by GNU Autoconf 2.65 for dosbox 0.74.
-#
-#
-# Copyright (C) 1992, 1993, 1994, 1995, 1996, 1998, 1999, 2000, 2001,
-# 2002, 2003, 2004, 2005, 2006, 2007, 2008, 2009 Free Software Foundation,
-# Inc.
-#
-#
-# This configure script is free software; the Free Software Foundation
-# gives unlimited permission to copy, distribute and modify it.
-## -------------------- ##
-## M4sh Initialization. ##
-## -------------------- ##
-
-# Be more Bourne compatible
-DUALCASE=1; export DUALCASE # for MKS sh
-if test -n "${ZSH_VERSION+set}" && (emulate sh) >/dev/null 2>&1; then :
-  emulate sh
-  NULLCMD=:
-  # Pre-4.2 versions of Zsh do word splitting on ${1+"$@"}, which
-  # is contrary to our usage.  Disable this feature.
-  alias -g '${1+"$@"}'='"$@"'
-  setopt NO_GLOB_SUBST
-else
-  case `(set -o) 2>/dev/null` in #(
-  *posix*) :
-    set -o posix ;; #(
-  *) :
-     ;;
-esac
-fi
-
-
-as_nl='
-'
-export as_nl
-# Printing a long string crashes Solaris 7 /usr/bin/printf.
-as_echo='\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\'
-as_echo=$as_echo$as_echo$as_echo$as_echo$as_echo
-as_echo=$as_echo$as_echo$as_echo$as_echo$as_echo$as_echo
-# Prefer a ksh shell builtin over an external printf program on Solaris,
-# but without wasting forks for bash or zsh.
-if test -z "$BASH_VERSION$ZSH_VERSION" \
-    && (test "X`print -r -- $as_echo`" = "X$as_echo") 2>/dev/null; then
-  as_echo='print -r --'
-  as_echo_n='print -rn --'
-elif (test "X`printf %s $as_echo`" = "X$as_echo") 2>/dev/null; then
-  as_echo='printf %s\n'
-  as_echo_n='printf %s'
-else
-  if test "X`(/usr/ucb/echo -n -n $as_echo) 2>/dev/null`" = "X-n $as_echo"; then
-    as_echo_body='eval /usr/ucb/echo -n "$1$as_nl"'
-    as_echo_n='/usr/ucb/echo -n'
-  else
-    as_echo_body='eval expr "X$1" : "X\\(.*\\)"'
-    as_echo_n_body='eval
-      arg=$1;
-      case $arg in #(
-      *"$as_nl"*)
-	expr "X$arg" : "X\\(.*\\)$as_nl";
-	arg=`expr "X$arg" : ".*$as_nl\\(.*\\)"`;;
-      esac;
-      expr "X$arg" : "X\\(.*\\)" | tr -d "$as_nl"
-    '
-    export as_echo_n_body
-    as_echo_n='sh -c $as_echo_n_body as_echo'
-  fi
-  export as_echo_body
-  as_echo='sh -c $as_echo_body as_echo'
-fi
-
-# The user is always right.
-if test "${PATH_SEPARATOR+set}" != set; then
-  PATH_SEPARATOR=:
-  (PATH='/bin;/bin'; FPATH=$PATH; sh -c :) >/dev/null 2>&1 && {
-    (PATH='/bin:/bin'; FPATH=$PATH; sh -c :) >/dev/null 2>&1 ||
-      PATH_SEPARATOR=';'
-  }
-fi
-
-
-# IFS
-# We need space, tab and new line, in precisely that order.  Quoting is
-# there to prevent editors from complaining about space-tab.
-# (If _AS_PATH_WALK were called with IFS unset, it would disable word
-# splitting by setting IFS to empty value.)
-IFS=" ""	$as_nl"
-
-# Find who we are.  Look in the path if we contain no directory separator.
-case $0 in #((
-  *[\\/]* ) as_myself=$0 ;;
-  *) as_save_IFS=$IFS; IFS=$PATH_SEPARATOR
-for as_dir in $PATH
-do
-  IFS=$as_save_IFS
-  test -z "$as_dir" && as_dir=.
-    test -r "$as_dir/$0" && as_myself=$as_dir/$0 && break
-  done
-IFS=$as_save_IFS
-
-     ;;
-esac
-# We did not find ourselves, most probably we were run as `sh COMMAND'
-# in which case we are not to be found in the path.
-if test "x$as_myself" = x; then
-  as_myself=$0
-fi
-if test ! -f "$as_myself"; then
-  $as_echo "$as_myself: error: cannot find myself; rerun with an absolute file name" >&2
-  exit 1
-fi
-
-# Unset variables that we do not need and which cause bugs (e.g. in
-# pre-3.0 UWIN ksh).  But do not cause bugs in bash 2.01; the "|| exit 1"
-# suppresses any "Segmentation fault" message there.  '((' could
-# trigger a bug in pdksh 5.2.14.
-for as_var in BASH_ENV ENV MAIL MAILPATH
-do eval test x\${$as_var+set} = xset \
-  && ( (unset $as_var) || exit 1) >/dev/null 2>&1 && unset $as_var || :
-done
-PS1='$ '
-PS2='> '
-PS4='+ '
-
-# NLS nuisances.
-LC_ALL=C
-export LC_ALL
-LANGUAGE=C
-export LANGUAGE
-
-# CDPATH.
-(unset CDPATH) >/dev/null 2>&1 && unset CDPATH
-
-if test "x$CONFIG_SHELL" = x; then
-  as_bourne_compatible="if test -n \"\${ZSH_VERSION+set}\" && (emulate sh) >/dev/null 2>&1; then :
-  emulate sh
-  NULLCMD=:
-  # Pre-4.2 versions of Zsh do word splitting on \${1+\"\$@\"}, which
-  # is contrary to our usage.  Disable this feature.
-  alias -g '\${1+\"\$@\"}'='\"\$@\"'
-  setopt NO_GLOB_SUBST
-else
-  case \`(set -o) 2>/dev/null\` in #(
-  *posix*) :
-    set -o posix ;; #(
-  *) :
-     ;;
-esac
-fi
-"
-  as_required="as_fn_return () { (exit \$1); }
-as_fn_success () { as_fn_return 0; }
-as_fn_failure () { as_fn_return 1; }
-as_fn_ret_success () { return 0; }
-as_fn_ret_failure () { return 1; }
-
-exitcode=0
-as_fn_success || { exitcode=1; echo as_fn_success failed.; }
-as_fn_failure && { exitcode=1; echo as_fn_failure succeeded.; }
-as_fn_ret_success || { exitcode=1; echo as_fn_ret_success failed.; }
-as_fn_ret_failure && { exitcode=1; echo as_fn_ret_failure succeeded.; }
-if ( set x; as_fn_ret_success y && test x = \"\$1\" ); then :
-
-else
-  exitcode=1; echo positional parameters were not saved.
-fi
-test x\$exitcode = x0 || exit 1"
-  as_suggested="  as_lineno_1=";as_suggested=$as_suggested$LINENO;as_suggested=$as_suggested" as_lineno_1a=\$LINENO
-  as_lineno_2=";as_suggested=$as_suggested$LINENO;as_suggested=$as_suggested" as_lineno_2a=\$LINENO
-  eval 'test \"x\$as_lineno_1'\$as_run'\" != \"x\$as_lineno_2'\$as_run'\" &&
-  test \"x\`expr \$as_lineno_1'\$as_run' + 1\`\" = \"x\$as_lineno_2'\$as_run'\"' || exit 1
-test \$(( 1 + 1 )) = 2 || exit 1"
-  if (eval "$as_required") 2>/dev/null; then :
-  as_have_required=yes
-else
-  as_have_required=no
-fi
-  if test x$as_have_required = xyes && (eval "$as_suggested") 2>/dev/null; then :
-
-else
-  as_save_IFS=$IFS; IFS=$PATH_SEPARATOR
-as_found=false
-for as_dir in /bin$PATH_SEPARATOR/usr/bin$PATH_SEPARATOR$PATH
-do
-  IFS=$as_save_IFS
-  test -z "$as_dir" && as_dir=.
-  as_found=:
-  case $as_dir in #(
-	 /*)
-	   for as_base in sh bash ksh sh5; do
-	     # Try only shells that exist, to save several forks.
-	     as_shell=$as_dir/$as_base
-	     if { test -f "$as_shell" || test -f "$as_shell.exe"; } &&
-		    { $as_echo "$as_bourne_compatible""$as_required" | as_run=a "$as_shell"; } 2>/dev/null; then :
-  CONFIG_SHELL=$as_shell as_have_required=yes
-		   if { $as_echo "$as_bourne_compatible""$as_suggested" | as_run=a "$as_shell"; } 2>/dev/null; then :
-  break 2
-fi
-fi
-	   done;;
-       esac
-  as_found=false
-done
-$as_found || { if { test -f "$SHELL" || test -f "$SHELL.exe"; } &&
-	      { $as_echo "$as_bourne_compatible""$as_required" | as_run=a "$SHELL"; } 2>/dev/null; then :
-  CONFIG_SHELL=$SHELL as_have_required=yes
-fi; }
-IFS=$as_save_IFS
-
-
-      if test "x$CONFIG_SHELL" != x; then :
-  # We cannot yet assume a decent shell, so we have to provide a
-	# neutralization value for shells without unset; and this also
-	# works around shells that cannot unset nonexistent variables.
-	BASH_ENV=/dev/null
-	ENV=/dev/null
-	(unset BASH_ENV) >/dev/null 2>&1 && unset BASH_ENV ENV
-	export CONFIG_SHELL
-	exec "$CONFIG_SHELL" "$as_myself" ${1+"$@"}
-fi
-
-    if test x$as_have_required = xno; then :
-  $as_echo "$0: This script requires a shell more modern than all"
-  $as_echo "$0: the shells that I found on your system."
-  if test x${ZSH_VERSION+set} = xset ; then
-    $as_echo "$0: In particular, zsh $ZSH_VERSION has bugs and should"
-    $as_echo "$0: be upgraded to zsh 4.3.4 or later."
-  else
-    $as_echo "$0: Please tell bug-autoconf@gnu.org about your system,
-$0: including any error possibly output before this
-$0: message. Then install a modern shell, or manually run
-$0: the script under such a shell if you do have one."
-  fi
-  exit 1
-fi
-fi
-fi
-SHELL=${CONFIG_SHELL-/bin/sh}
-export SHELL
-# Unset more variables known to interfere with behavior of common tools.
-CLICOLOR_FORCE= GREP_OPTIONS=
-unset CLICOLOR_FORCE GREP_OPTIONS
-
-## --------------------- ##
-## M4sh Shell Functions. ##
-## --------------------- ##
-# as_fn_unset VAR
-# ---------------
-# Portably unset VAR.
-as_fn_unset ()
-{
-  { eval $1=; unset $1;}
-}
-as_unset=as_fn_unset
-
-# as_fn_set_status STATUS
-# -----------------------
-# Set $? to STATUS, without forking.
-as_fn_set_status ()
-{
-  return $1
-} # as_fn_set_status
-
-# as_fn_exit STATUS
-# -----------------
-# Exit the shell with STATUS, even in a "trap 0" or "set -e" context.
-as_fn_exit ()
-{
-  set +e
-  as_fn_set_status $1
-  exit $1
-} # as_fn_exit
-
-# as_fn_mkdir_p
-# -------------
-# Create "$as_dir" as a directory, including parents if necessary.
-as_fn_mkdir_p ()
-{
-
-  case $as_dir in #(
-  -*) as_dir=./$as_dir;;
-  esac
-  test -d "$as_dir" || eval $as_mkdir_p || {
-    as_dirs=
-    while :; do
-      case $as_dir in #(
-      *\'*) as_qdir=`$as_echo "$as_dir" | sed "s/'/'\\\\\\\\''/g"`;; #'(
-      *) as_qdir=$as_dir;;
-      esac
-      as_dirs="'$as_qdir' $as_dirs"
-      as_dir=`$as_dirname -- "$as_dir" ||
-$as_expr X"$as_dir" : 'X\(.*[^/]\)//*[^/][^/]*/*$' \| \
-	 X"$as_dir" : 'X\(//\)[^/]' \| \
-	 X"$as_dir" : 'X\(//\)$' \| \
-	 X"$as_dir" : 'X\(/\)' \| . 2>/dev/null ||
-$as_echo X"$as_dir" |
-    sed '/^X\(.*[^/]\)\/\/*[^/][^/]*\/*$/{
-	    s//\1/
-	    q
-	  }
-	  /^X\(\/\/\)[^/].*/{
-	    s//\1/
-	    q
-	  }
-	  /^X\(\/\/\)$/{
-	    s//\1/
-	    q
-	  }
-	  /^X\(\/\).*/{
-	    s//\1/
-	    q
-	  }
-	  s/.*/./; q'`
-      test -d "$as_dir" && break
-    done
-    test -z "$as_dirs" || eval "mkdir $as_dirs"
-  } || test -d "$as_dir" || as_fn_error "cannot create directory $as_dir"
-
-
-} # as_fn_mkdir_p
-# as_fn_append VAR VALUE
-# ----------------------
-# Append the text in VALUE to the end of the definition contained in VAR. Take
-# advantage of any shell optimizations that allow amortized linear growth over
-# repeated appends, instead of the typical quadratic growth present in naive
-# implementations.
-if (eval "as_var=1; as_var+=2; test x\$as_var = x12") 2>/dev/null; then :
-  eval 'as_fn_append ()
-  {
-    eval $1+=\$2
-  }'
-else
-  as_fn_append ()
-  {
-    eval $1=\$$1\$2
-  }
-fi # as_fn_append
-
-# as_fn_arith ARG...
-# ------------------
-# Perform arithmetic evaluation on the ARGs, and store the result in the
-# global $as_val. Take advantage of shells that can avoid forks. The arguments
-# must be portable across $(()) and expr.
-if (eval "test \$(( 1 + 1 )) = 2") 2>/dev/null; then :
-  eval 'as_fn_arith ()
-  {
-    as_val=$(( $* ))
-  }'
-else
-  as_fn_arith ()
-  {
-    as_val=`expr "$@" || test $? -eq 1`
-  }
-fi # as_fn_arith
-
-
-# as_fn_error ERROR [LINENO LOG_FD]
-# ---------------------------------
-# Output "`basename $0`: error: ERROR" to stderr. If LINENO and LOG_FD are
-# provided, also output the error to LOG_FD, referencing LINENO. Then exit the
-# script with status $?, using 1 if that was 0.
-as_fn_error ()
-{
-  as_status=$?; test $as_status -eq 0 && as_status=1
-  if test "$3"; then
-    as_lineno=${as_lineno-"$2"} as_lineno_stack=as_lineno_stack=$as_lineno_stack
-    $as_echo "$as_me:${as_lineno-$LINENO}: error: $1" >&$3
-  fi
-  $as_echo "$as_me: error: $1" >&2
-  as_fn_exit $as_status
-} # as_fn_error
-
-if expr a : '\(a\)' >/dev/null 2>&1 &&
-   test "X`expr 00001 : '.*\(...\)'`" = X001; then
-  as_expr=expr
-else
-  as_expr=false
-fi
-
-if (basename -- /) >/dev/null 2>&1 && test "X`basename -- / 2>&1`" = "X/"; then
-  as_basename=basename
-else
-  as_basename=false
-fi
-
-if (as_dir=`dirname -- /` && test "X$as_dir" = X/) >/dev/null 2>&1; then
-  as_dirname=dirname
-else
-  as_dirname=false
-fi
-
-as_me=`$as_basename -- "$0" ||
-$as_expr X/"$0" : '.*/\([^/][^/]*\)/*$' \| \
-	 X"$0" : 'X\(//\)$' \| \
-	 X"$0" : 'X\(/\)' \| . 2>/dev/null ||
-$as_echo X/"$0" |
-    sed '/^.*\/\([^/][^/]*\)\/*$/{
-	    s//\1/
-	    q
-	  }
-	  /^X\/\(\/\/\)$/{
-	    s//\1/
-	    q
-	  }
-	  /^X\/\(\/\).*/{
-	    s//\1/
-	    q
-	  }
-	  s/.*/./; q'`
-
-# Avoid depending upon Character Ranges.
-as_cr_letters='abcdefghijklmnopqrstuvwxyz'
-as_cr_LETTERS='ABCDEFGHIJKLMNOPQRSTUVWXYZ'
-as_cr_Letters=$as_cr_letters$as_cr_LETTERS
-as_cr_digits='0123456789'
-as_cr_alnum=$as_cr_Letters$as_cr_digits
-
-
-  as_lineno_1=$LINENO as_lineno_1a=$LINENO
-  as_lineno_2=$LINENO as_lineno_2a=$LINENO
-  eval 'test "x$as_lineno_1'$as_run'" != "x$as_lineno_2'$as_run'" &&
-  test "x`expr $as_lineno_1'$as_run' + 1`" = "x$as_lineno_2'$as_run'"' || {
-  # Blame Lee E. McMahon (1931-1989) for sed's syntax.  :-)
-  sed -n '
-    p
-    /[$]LINENO/=
-  ' <$as_myself |
-    sed '
-      s/[$]LINENO.*/&-/
-      t lineno
-      b
-      :lineno
-      N
-      :loop
-      s/[$]LINENO\([^'$as_cr_alnum'_].*\n\)\(.*\)/\2\1\2/
-      t loop
-      s/-\n.*//
-    ' >$as_me.lineno &&
-  chmod +x "$as_me.lineno" ||
-    { $as_echo "$as_me: error: cannot create $as_me.lineno; rerun with a POSIX shell" >&2; as_fn_exit 1; }
-
-  # Don't try to exec as it changes $[0], causing all sort of problems
-  # (the dirname of $[0] is not the place where we might find the
-  # original and so on.  Autoconf is especially sensitive to this).
-  . "./$as_me.lineno"
-  # Exit status is that of the last command.
-  exit
-}
-
-ECHO_C= ECHO_N= ECHO_T=
-case `echo -n x` in #(((((
--n*)
-  case `echo 'xy\c'` in
-  *c*) ECHO_T='	';;	# ECHO_T is single tab character.
-  xy)  ECHO_C='\c';;
-  *)   echo `echo ksh88 bug on AIX 6.1` > /dev/null
-       ECHO_T='	';;
-  esac;;
-*)
-  ECHO_N='-n';;
-esac
-
-rm -f conf$$ conf$$.exe conf$$.file
-if test -d conf$$.dir; then
-  rm -f conf$$.dir/conf$$.file
-else
-  rm -f conf$$.dir
-  mkdir conf$$.dir 2>/dev/null
-fi
-if (echo >conf$$.file) 2>/dev/null; then
-  if ln -s conf$$.file conf$$ 2>/dev/null; then
-    as_ln_s='ln -s'
-    # ... but there are two gotchas:
-    # 1) On MSYS, both `ln -s file dir' and `ln file dir' fail.
-    # 2) DJGPP < 2.04 has no symlinks; `ln -s' creates a wrapper executable.
-    # In both cases, we have to default to `cp -p'.
-    ln -s conf$$.file conf$$.dir 2>/dev/null && test ! -f conf$$.exe ||
-      as_ln_s='cp -p'
-  elif ln conf$$.file conf$$ 2>/dev/null; then
-    as_ln_s=ln
-  else
-    as_ln_s='cp -p'
-  fi
-else
-  as_ln_s='cp -p'
-fi
-rm -f conf$$ conf$$.exe conf$$.dir/conf$$.file conf$$.file
-rmdir conf$$.dir 2>/dev/null
-
-if mkdir -p . 2>/dev/null; then
-  as_mkdir_p='mkdir -p "$as_dir"'
-else
-  test -d ./-p && rmdir ./-p
-  as_mkdir_p=false
-fi
-
-if test -x / >/dev/null 2>&1; then
-  as_test_x='test -x'
-else
-  if ls -dL / >/dev/null 2>&1; then
-    as_ls_L_option=L
-  else
-    as_ls_L_option=
-  fi
-  as_test_x='
-    eval sh -c '\''
-      if test -d "$1"; then
-	test -d "$1/.";
-      else
-	case $1 in #(
-	-*)set "./$1";;
-	esac;
-	case `ls -ld'$as_ls_L_option' "$1" 2>/dev/null` in #((
-	???[sx]*):;;*)false;;esac;fi
-    '\'' sh
-  '
-fi
-as_executable_p=$as_test_x
-
-# Sed expression to map a string onto a valid CPP name.
-as_tr_cpp="eval sed 'y%*$as_cr_letters%P$as_cr_LETTERS%;s%[^_$as_cr_alnum]%_%g'"
-
-# Sed expression to map a string onto a valid variable name.
-as_tr_sh="eval sed 'y%*+%pp%;s%[^_$as_cr_alnum]%_%g'"
-
-
-test -n "$DJDIR" || exec 7<&0 </dev/null
-exec 6>&1
-
-# Name of the host.
-# hostname on some systems (SVR3.2, Linux) returns a bogus exit status,
-# so uname gets run too.
-ac_hostname=`(hostname || uname -n) 2>/dev/null | sed 1q`
-
-#
-# Initializations.
-#
-ac_default_prefix=/usr/local
-ac_clean_files=
-ac_config_libobj_dir=.
-LIBOBJS=
-cross_compiling=no
-subdirs=
-MFLAGS=
-MAKEFLAGS=
-
-# Identity of this package.
-PACKAGE_NAME='dosbox'
-PACKAGE_TARNAME='dosbox'
-PACKAGE_VERSION='0.74'
-PACKAGE_STRING='dosbox 0.74'
-PACKAGE_BUGREPORT=''
-PACKAGE_URL=''
-
-ac_unique_file="README"
-# Factoring default headers for most tests.
-ac_includes_default="\
-#include <stdio.h>
-#ifdef HAVE_SYS_TYPES_H
-# include <sys/types.h>
-#endif
-#ifdef HAVE_SYS_STAT_H
-# include <sys/stat.h>
-#endif
-#ifdef STDC_HEADERS
-# include <stdlib.h>
-# include <stddef.h>
-#else
-# ifdef HAVE_STDLIB_H
-#  include <stdlib.h>
-# endif
-#endif
-#ifdef HAVE_STRING_H
-# if !defined STDC_HEADERS && defined HAVE_MEMORY_H
-#  include <memory.h>
-# endif
-# include <string.h>
-#endif
-#ifdef HAVE_STRINGS_H
-# include <strings.h>
-#endif
-#ifdef HAVE_INTTYPES_H
-# include <inttypes.h>
-#endif
-#ifdef HAVE_STDINT_H
-# include <stdint.h>
-#endif
-#ifdef HAVE_UNISTD_H
-# include <unistd.h>
-#endif"
-
-ac_subst_vars='am__EXEEXT_FALSE
-am__EXEEXT_TRUE
-LTLIBOBJS
-LIBOBJS
-HAVE_WINDRES_FALSE
-HAVE_WINDRES_TRUE
-WINDRES
-ALSA_LIBS
-ALSA_CFLAGS
-EGREP
-GREP
-SDL_LIBS
-SDL_CFLAGS
-SDL_CONFIG
-RANLIB
-am__fastdepCXX_FALSE
-am__fastdepCXX_TRUE
-CXXDEPMODE
-ac_ct_CXX
-CXXFLAGS
-CXX
-CPP
-am__fastdepCC_FALSE
-am__fastdepCC_TRUE
-CCDEPMODE
-AMDEPBACKSLASH
-AMDEP_FALSE
-AMDEP_TRUE
-am__quote
-am__include
-DEPDIR
-OBJEXT
-EXEEXT
-ac_ct_CC
-CPPFLAGS
-LDFLAGS
-CFLAGS
-CC
-am__untar
-am__tar
-AMTAR
-am__leading_dot
-SET_MAKE
-AWK
-mkdir_p
-MKDIR_P
-INSTALL_STRIP_PROGRAM
-STRIP
-install_sh
-MAKEINFO
-AUTOHEADER
-AUTOMAKE
-AUTOCONF
-ACLOCAL
-VERSION
-PACKAGE
-CYGPATH_W
-am__isrc
-INSTALL_DATA
-INSTALL_SCRIPT
-INSTALL_PROGRAM
-host_os
-host_vendor
-host_cpu
-host
-build_os
-build_vendor
-build_cpu
-build
-target_alias
-host_alias
-build_alias
-LIBS
-ECHO_T
-ECHO_N
-ECHO_C
-DEFS
-mandir
-localedir
-libdir
-psdir
-pdfdir
-dvidir
-htmldir
-infodir
-docdir
-oldincludedir
-includedir
-localstatedir
-sharedstatedir
-sysconfdir
-datadir
-datarootdir
-libexecdir
-sbindir
-bindir
-program_transform_name
-prefix
-exec_prefix
-PACKAGE_URL
-PACKAGE_BUGREPORT
-PACKAGE_STRING
-PACKAGE_VERSION
-PACKAGE_TARNAME
-PACKAGE_NAME
-PATH_SEPARATOR
-SHELL'
-ac_subst_files=''
-ac_user_opts='
-enable_option_checking
-enable_dependency_tracking
-with_sdl_prefix
-with_sdl_exec_prefix
-enable_sdltest
-enable_alsa_midi
-with_alsa_prefix
-with_alsa_inc_prefix
-enable_alsatest
-enable_debug
-enable_core_inline
-enable_dynamic_core
-enable_dynamic_x86
-enable_dynrec
-enable_fpu
-enable_fpu_x86
-enable_unaligned_memory
-enable_opengl
-'
-      ac_precious_vars='build_alias
-host_alias
-target_alias
-CC
-CFLAGS
-LDFLAGS
-LIBS
-CPPFLAGS
-CPP
-CXX
-CXXFLAGS
-CCC'
-
-
-# Initialize some variables set by options.
-ac_init_help=
-ac_init_version=false
-ac_unrecognized_opts=
-ac_unrecognized_sep=
-# The variables have the same names as the options, with
-# dashes changed to underlines.
-cache_file=/dev/null
-exec_prefix=NONE
-no_create=
-no_recursion=
-prefix=NONE
-program_prefix=NONE
-program_suffix=NONE
-program_transform_name=s,x,x,
-silent=
-site=
-srcdir=
-verbose=
-x_includes=NONE
-x_libraries=NONE
-
-# Installation directory options.
-# These are left unexpanded so users can "make install exec_prefix=/foo"
-# and all the variables that are supposed to be based on exec_prefix
-# by default will actually change.
-# Use braces instead of parens because sh, perl, etc. also accept them.
-# (The list follows the same order as the GNU Coding Standards.)
-bindir='${exec_prefix}/bin'
-sbindir='${exec_prefix}/sbin'
-libexecdir='${exec_prefix}/libexec'
-datarootdir='${prefix}/share'
-datadir='${datarootdir}'
-sysconfdir='${prefix}/etc'
-sharedstatedir='${prefix}/com'
-localstatedir='${prefix}/var'
-includedir='${prefix}/include'
-oldincludedir='/usr/include'
-docdir='${datarootdir}/doc/${PACKAGE_TARNAME}'
-infodir='${datarootdir}/info'
-htmldir='${docdir}'
-dvidir='${docdir}'
-pdfdir='${docdir}'
-psdir='${docdir}'
-libdir='${exec_prefix}/lib'
-localedir='${datarootdir}/locale'
-mandir='${datarootdir}/man'
-
-ac_prev=
-ac_dashdash=
-for ac_option
-do
-  # If the previous option needs an argument, assign it.
-  if test -n "$ac_prev"; then
-    eval $ac_prev=\$ac_option
-    ac_prev=
-    continue
-  fi
-
-  case $ac_option in
-  *=*)	ac_optarg=`expr "X$ac_option" : '[^=]*=\(.*\)'` ;;
-  *)	ac_optarg=yes ;;
-  esac
-
-  # Accept the important Cygnus configure options, so we can diagnose typos.
-
-  case $ac_dashdash$ac_option in
-  --)
-    ac_dashdash=yes ;;
-
-  -bindir | --bindir | --bindi | --bind | --bin | --bi)
-    ac_prev=bindir ;;
-  -bindir=* | --bindir=* | --bindi=* | --bind=* | --bin=* | --bi=*)
-    bindir=$ac_optarg ;;
-
-  -build | --build | --buil | --bui | --bu)
-    ac_prev=build_alias ;;
-  -build=* | --build=* | --buil=* | --bui=* | --bu=*)
-    build_alias=$ac_optarg ;;
-
-  -cache-file | --cache-file | --cache-fil | --cache-fi \
-  | --cache-f | --cache- | --cache | --cach | --cac | --ca | --c)
-    ac_prev=cache_file ;;
-  -cache-file=* | --cache-file=* | --cache-fil=* | --cache-fi=* \
-  | --cache-f=* | --cache-=* | --cache=* | --cach=* | --cac=* | --ca=* | --c=*)
-    cache_file=$ac_optarg ;;
-
-  --config-cache | -C)
-    cache_file=config.cache ;;
-
-  -datadir | --datadir | --datadi | --datad)
-    ac_prev=datadir ;;
-  -datadir=* | --datadir=* | --datadi=* | --datad=*)
-    datadir=$ac_optarg ;;
-
-  -datarootdir | --datarootdir | --datarootdi | --datarootd | --dataroot \
-  | --dataroo | --dataro | --datar)
-    ac_prev=datarootdir ;;
-  -datarootdir=* | --datarootdir=* | --datarootdi=* | --datarootd=* \
-  | --dataroot=* | --dataroo=* | --dataro=* | --datar=*)
-    datarootdir=$ac_optarg ;;
-
-  -disable-* | --disable-*)
-    ac_useropt=`expr "x$ac_option" : 'x-*disable-\(.*\)'`
-    # Reject names that are not valid shell variable names.
-    expr "x$ac_useropt" : ".*[^-+._$as_cr_alnum]" >/dev/null &&
-      as_fn_error "invalid feature name: $ac_useropt"
-    ac_useropt_orig=$ac_useropt
-    ac_useropt=`$as_echo "$ac_useropt" | sed 's/[-+.]/_/g'`
-    case $ac_user_opts in
-      *"
-"enable_$ac_useropt"
-"*) ;;
-      *) ac_unrecognized_opts="$ac_unrecognized_opts$ac_unrecognized_sep--disable-$ac_useropt_orig"
-	 ac_unrecognized_sep=', ';;
-    esac
-    eval enable_$ac_useropt=no ;;
-
-  -docdir | --docdir | --docdi | --doc | --do)
-    ac_prev=docdir ;;
-  -docdir=* | --docdir=* | --docdi=* | --doc=* | --do=*)
-    docdir=$ac_optarg ;;
-
-  -dvidir | --dvidir | --dvidi | --dvid | --dvi | --dv)
-    ac_prev=dvidir ;;
-  -dvidir=* | --dvidir=* | --dvidi=* | --dvid=* | --dvi=* | --dv=*)
-    dvidir=$ac_optarg ;;
-
-  -enable-* | --enable-*)
-    ac_useropt=`expr "x$ac_option" : 'x-*enable-\([^=]*\)'`
-    # Reject names that are not valid shell variable names.
-    expr "x$ac_useropt" : ".*[^-+._$as_cr_alnum]" >/dev/null &&
-      as_fn_error "invalid feature name: $ac_useropt"
-    ac_useropt_orig=$ac_useropt
-    ac_useropt=`$as_echo "$ac_useropt" | sed 's/[-+.]/_/g'`
-    case $ac_user_opts in
-      *"
-"enable_$ac_useropt"
-"*) ;;
-      *) ac_unrecognized_opts="$ac_unrecognized_opts$ac_unrecognized_sep--enable-$ac_useropt_orig"
-	 ac_unrecognized_sep=', ';;
-    esac
-    eval enable_$ac_useropt=\$ac_optarg ;;
-
-  -exec-prefix | --exec_prefix | --exec-prefix | --exec-prefi \
-  | --exec-pref | --exec-pre | --exec-pr | --exec-p | --exec- \
-  | --exec | --exe | --ex)
-    ac_prev=exec_prefix ;;
-  -exec-prefix=* | --exec_prefix=* | --exec-prefix=* | --exec-prefi=* \
-  | --exec-pref=* | --exec-pre=* | --exec-pr=* | --exec-p=* | --exec-=* \
-  | --exec=* | --exe=* | --ex=*)
-    exec_prefix=$ac_optarg ;;
-
-  -gas | --gas | --ga | --g)
-    # Obsolete; use --with-gas.
-    with_gas=yes ;;
-
-  -help | --help | --hel | --he | -h)
-    ac_init_help=long ;;
-  -help=r* | --help=r* | --hel=r* | --he=r* | -hr*)
-    ac_init_help=recursive ;;
-  -help=s* | --help=s* | --hel=s* | --he=s* | -hs*)
-    ac_init_help=short ;;
-
-  -host | --host | --hos | --ho)
-    ac_prev=host_alias ;;
-  -host=* | --host=* | --hos=* | --ho=*)
-    host_alias=$ac_optarg ;;
-
-  -htmldir | --htmldir | --htmldi | --htmld | --html | --htm | --ht)
-    ac_prev=htmldir ;;
-  -htmldir=* | --htmldir=* | --htmldi=* | --htmld=* | --html=* | --htm=* \
-  | --ht=*)
-    htmldir=$ac_optarg ;;
-
-  -includedir | --includedir | --includedi | --included | --include \
-  | --includ | --inclu | --incl | --inc)
-    ac_prev=includedir ;;
-  -includedir=* | --includedir=* | --includedi=* | --included=* | --include=* \
-  | --includ=* | --inclu=* | --incl=* | --inc=*)
-    includedir=$ac_optarg ;;
-
-  -infodir | --infodir | --infodi | --infod | --info | --inf)
-    ac_prev=infodir ;;
-  -infodir=* | --infodir=* | --infodi=* | --infod=* | --info=* | --inf=*)
-    infodir=$ac_optarg ;;
-
-  -libdir | --libdir | --libdi | --libd)
-    ac_prev=libdir ;;
-  -libdir=* | --libdir=* | --libdi=* | --libd=*)
-    libdir=$ac_optarg ;;
-
-  -libexecdir | --libexecdir | --libexecdi | --libexecd | --libexec \
-  | --libexe | --libex | --libe)
-    ac_prev=libexecdir ;;
-  -libexecdir=* | --libexecdir=* | --libexecdi=* | --libexecd=* | --libexec=* \
-  | --libexe=* | --libex=* | --libe=*)
-    libexecdir=$ac_optarg ;;
-
-  -localedir | --localedir | --localedi | --localed | --locale)
-    ac_prev=localedir ;;
-  -localedir=* | --localedir=* | --localedi=* | --localed=* | --locale=*)
-    localedir=$ac_optarg ;;
-
-  -localstatedir | --localstatedir | --localstatedi | --localstated \
-  | --localstate | --localstat | --localsta | --localst | --locals)
-    ac_prev=localstatedir ;;
-  -localstatedir=* | --localstatedir=* | --localstatedi=* | --localstated=* \
-  | --localstate=* | --localstat=* | --localsta=* | --localst=* | --locals=*)
-    localstatedir=$ac_optarg ;;
-
-  -mandir | --mandir | --mandi | --mand | --man | --ma | --m)
-    ac_prev=mandir ;;
-  -mandir=* | --mandir=* | --mandi=* | --mand=* | --man=* | --ma=* | --m=*)
-    mandir=$ac_optarg ;;
-
-  -nfp | --nfp | --nf)
-    # Obsolete; use --without-fp.
-    with_fp=no ;;
-
-  -no-create | --no-create | --no-creat | --no-crea | --no-cre \
-  | --no-cr | --no-c | -n)
-    no_create=yes ;;
-
-  -no-recursion | --no-recursion | --no-recursio | --no-recursi \
-  | --no-recurs | --no-recur | --no-recu | --no-rec | --no-re | --no-r)
-    no_recursion=yes ;;
-
-  -oldincludedir | --oldincludedir | --oldincludedi | --oldincluded \
-  | --oldinclude | --oldinclud | --oldinclu | --oldincl | --oldinc \
-  | --oldin | --oldi | --old | --ol | --o)
-    ac_prev=oldincludedir ;;
-  -oldincludedir=* | --oldincludedir=* | --oldincludedi=* | --oldincluded=* \
-  | --oldinclude=* | --oldinclud=* | --oldinclu=* | --oldincl=* | --oldinc=* \
-  | --oldin=* | --oldi=* | --old=* | --ol=* | --o=*)
-    oldincludedir=$ac_optarg ;;
-
-  -prefix | --prefix | --prefi | --pref | --pre | --pr | --p)
-    ac_prev=prefix ;;
-  -prefix=* | --prefix=* | --prefi=* | --pref=* | --pre=* | --pr=* | --p=*)
-    prefix=$ac_optarg ;;
-
-  -program-prefix | --program-prefix | --program-prefi | --program-pref \
-  | --program-pre | --program-pr | --program-p)
-    ac_prev=program_prefix ;;
-  -program-prefix=* | --program-prefix=* | --program-prefi=* \
-  | --program-pref=* | --program-pre=* | --program-pr=* | --program-p=*)
-    program_prefix=$ac_optarg ;;
-
-  -program-suffix | --program-suffix | --program-suffi | --program-suff \
-  | --program-suf | --program-su | --program-s)
-    ac_prev=program_suffix ;;
-  -program-suffix=* | --program-suffix=* | --program-suffi=* \
-  | --program-suff=* | --program-suf=* | --program-su=* | --program-s=*)
-    program_suffix=$ac_optarg ;;
-
-  -program-transform-name | --program-transform-name \
-  | --program-transform-nam | --program-transform-na \
-  | --program-transform-n | --program-transform- \
-  | --program-transform | --program-transfor \
-  | --program-transfo | --program-transf \
-  | --program-trans | --program-tran \
-  | --progr-tra | --program-tr | --program-t)
-    ac_prev=program_transform_name ;;
-  -program-transform-name=* | --program-transform-name=* \
-  | --program-transform-nam=* | --program-transform-na=* \
-  | --program-transform-n=* | --program-transform-=* \
-  | --program-transform=* | --program-transfor=* \
-  | --program-transfo=* | --program-transf=* \
-  | --program-trans=* | --program-tran=* \
-  | --progr-tra=* | --program-tr=* | --program-t=*)
-    program_transform_name=$ac_optarg ;;
-
-  -pdfdir | --pdfdir | --pdfdi | --pdfd | --pdf | --pd)
-    ac_prev=pdfdir ;;
-  -pdfdir=* | --pdfdir=* | --pdfdi=* | --pdfd=* | --pdf=* | --pd=*)
-    pdfdir=$ac_optarg ;;
-
-  -psdir | --psdir | --psdi | --psd | --ps)
-    ac_prev=psdir ;;
-  -psdir=* | --psdir=* | --psdi=* | --psd=* | --ps=*)
-    psdir=$ac_optarg ;;
-
-  -q | -quiet | --quiet | --quie | --qui | --qu | --q \
-  | -silent | --silent | --silen | --sile | --sil)
-    silent=yes ;;
-
-  -sbindir | --sbindir | --sbindi | --sbind | --sbin | --sbi | --sb)
-    ac_prev=sbindir ;;
-  -sbindir=* | --sbindir=* | --sbindi=* | --sbind=* | --sbin=* \
-  | --sbi=* | --sb=*)
-    sbindir=$ac_optarg ;;
-
-  -sharedstatedir | --sharedstatedir | --sharedstatedi \
-  | --sharedstated | --sharedstate | --sharedstat | --sharedsta \
-  | --sharedst | --shareds | --shared | --share | --shar \
-  | --sha | --sh)
-    ac_prev=sharedstatedir ;;
-  -sharedstatedir=* | --sharedstatedir=* | --sharedstatedi=* \
-  | --sharedstated=* | --sharedstate=* | --sharedstat=* | --sharedsta=* \
-  | --sharedst=* | --shareds=* | --shared=* | --share=* | --shar=* \
-  | --sha=* | --sh=*)
-    sharedstatedir=$ac_optarg ;;
-
-  -site | --site | --sit)
-    ac_prev=site ;;
-  -site=* | --site=* | --sit=*)
-    site=$ac_optarg ;;
-
-  -srcdir | --srcdir | --srcdi | --srcd | --src | --sr)
-    ac_prev=srcdir ;;
-  -srcdir=* | --srcdir=* | --srcdi=* | --srcd=* | --src=* | --sr=*)
-    srcdir=$ac_optarg ;;
-
-  -sysconfdir | --sysconfdir | --sysconfdi | --sysconfd | --sysconf \
-  | --syscon | --sysco | --sysc | --sys | --sy)
-    ac_prev=sysconfdir ;;
-  -sysconfdir=* | --sysconfdir=* | --sysconfdi=* | --sysconfd=* | --sysconf=* \
-  | --syscon=* | --sysco=* | --sysc=* | --sys=* | --sy=*)
-    sysconfdir=$ac_optarg ;;
-
-  -target | --target | --targe | --targ | --tar | --ta | --t)
-    ac_prev=target_alias ;;
-  -target=* | --target=* | --targe=* | --targ=* | --tar=* | --ta=* | --t=*)
-    target_alias=$ac_optarg ;;
-
-  -v | -verbose | --verbose | --verbos | --verbo | --verb)
-    verbose=yes ;;
-
-  -version | --version | --versio | --versi | --vers | -V)
-    ac_init_version=: ;;
-
-  -with-* | --with-*)
-    ac_useropt=`expr "x$ac_option" : 'x-*with-\([^=]*\)'`
-    # Reject names that are not valid shell variable names.
-    expr "x$ac_useropt" : ".*[^-+._$as_cr_alnum]" >/dev/null &&
-      as_fn_error "invalid package name: $ac_useropt"
-    ac_useropt_orig=$ac_useropt
-    ac_useropt=`$as_echo "$ac_useropt" | sed 's/[-+.]/_/g'`
-    case $ac_user_opts in
-      *"
-"with_$ac_useropt"
-"*) ;;
-      *) ac_unrecognized_opts="$ac_unrecognized_opts$ac_unrecognized_sep--with-$ac_useropt_orig"
-	 ac_unrecognized_sep=', ';;
-    esac
-    eval with_$ac_useropt=\$ac_optarg ;;
-
-  -without-* | --without-*)
-    ac_useropt=`expr "x$ac_option" : 'x-*without-\(.*\)'`
-    # Reject names that are not valid shell variable names.
-    expr "x$ac_useropt" : ".*[^-+._$as_cr_alnum]" >/dev/null &&
-      as_fn_error "invalid package name: $ac_useropt"
-    ac_useropt_orig=$ac_useropt
-    ac_useropt=`$as_echo "$ac_useropt" | sed 's/[-+.]/_/g'`
-    case $ac_user_opts in
-      *"
-"with_$ac_useropt"
-"*) ;;
-      *) ac_unrecognized_opts="$ac_unrecognized_opts$ac_unrecognized_sep--without-$ac_useropt_orig"
-	 ac_unrecognized_sep=', ';;
-    esac
-    eval with_$ac_useropt=no ;;
-
-  --x)
-    # Obsolete; use --with-x.
-    with_x=yes ;;
-
-  -x-includes | --x-includes | --x-include | --x-includ | --x-inclu \
-  | --x-incl | --x-inc | --x-in | --x-i)
-    ac_prev=x_includes ;;
-  -x-includes=* | --x-includes=* | --x-include=* | --x-includ=* | --x-inclu=* \
-  | --x-incl=* | --x-inc=* | --x-in=* | --x-i=*)
-    x_includes=$ac_optarg ;;
-
-  -x-libraries | --x-libraries | --x-librarie | --x-librari \
-  | --x-librar | --x-libra | --x-libr | --x-lib | --x-li | --x-l)
-    ac_prev=x_libraries ;;
-  -x-libraries=* | --x-libraries=* | --x-librarie=* | --x-librari=* \
-  | --x-librar=* | --x-libra=* | --x-libr=* | --x-lib=* | --x-li=* | --x-l=*)
-    x_libraries=$ac_optarg ;;
-
-  -*) as_fn_error "unrecognized option: \`$ac_option'
-Try \`$0 --help' for more information."
-    ;;
-
-  *=*)
-    ac_envvar=`expr "x$ac_option" : 'x\([^=]*\)='`
-    # Reject names that are not valid shell variable names.
-    case $ac_envvar in #(
-      '' | [0-9]* | *[!_$as_cr_alnum]* )
-      as_fn_error "invalid variable name: \`$ac_envvar'" ;;
-    esac
-    eval $ac_envvar=\$ac_optarg
-    export $ac_envvar ;;
-
-  *)
-    # FIXME: should be removed in autoconf 3.0.
-    $as_echo "$as_me: WARNING: you should use --build, --host, --target" >&2
-    expr "x$ac_option" : ".*[^-._$as_cr_alnum]" >/dev/null &&
-      $as_echo "$as_me: WARNING: invalid host type: $ac_option" >&2
-    : ${build_alias=$ac_option} ${host_alias=$ac_option} ${target_alias=$ac_option}
-    ;;
-
-  esac
-done
-
-if test -n "$ac_prev"; then
-  ac_option=--`echo $ac_prev | sed 's/_/-/g'`
-  as_fn_error "missing argument to $ac_option"
-fi
-
-if test -n "$ac_unrecognized_opts"; then
-  case $enable_option_checking in
-    no) ;;
-    fatal) as_fn_error "unrecognized options: $ac_unrecognized_opts" ;;
-    *)     $as_echo "$as_me: WARNING: unrecognized options: $ac_unrecognized_opts" >&2 ;;
-  esac
-fi
-
-# Check all directory arguments for consistency.
-for ac_var in	exec_prefix prefix bindir sbindir libexecdir datarootdir \
-		datadir sysconfdir sharedstatedir localstatedir includedir \
-		oldincludedir docdir infodir htmldir dvidir pdfdir psdir \
-		libdir localedir mandir
-do
-  eval ac_val=\$$ac_var
-  # Remove trailing slashes.
-  case $ac_val in
-    */ )
-      ac_val=`expr "X$ac_val" : 'X\(.*[^/]\)' \| "X$ac_val" : 'X\(.*\)'`
-      eval $ac_var=\$ac_val;;
-  esac
-  # Be sure to have absolute directory names.
-  case $ac_val in
-    [\\/$]* | ?:[\\/]* )  continue;;
-    NONE | '' ) case $ac_var in *prefix ) continue;; esac;;
-  esac
-  as_fn_error "expected an absolute directory name for --$ac_var: $ac_val"
-done
-
-# There might be people who depend on the old broken behavior: `$host'
-# used to hold the argument of --host etc.
-# FIXME: To remove some day.
-build=$build_alias
-host=$host_alias
-target=$target_alias
-
-# FIXME: To remove some day.
-if test "x$host_alias" != x; then
-  if test "x$build_alias" = x; then
-    cross_compiling=maybe
-    $as_echo "$as_me: WARNING: If you wanted to set the --build type, don't use --host.
-    If a cross compiler is detected then cross compile mode will be used." >&2
-  elif test "x$build_alias" != "x$host_alias"; then
-    cross_compiling=yes
-  fi
-fi
-
-ac_tool_prefix=
-test -n "$host_alias" && ac_tool_prefix=$host_alias-
-
-test "$silent" = yes && exec 6>/dev/null
-
-
-ac_pwd=`pwd` && test -n "$ac_pwd" &&
-ac_ls_di=`ls -di .` &&
-ac_pwd_ls_di=`cd "$ac_pwd" && ls -di .` ||
-  as_fn_error "working directory cannot be determined"
-test "X$ac_ls_di" = "X$ac_pwd_ls_di" ||
-  as_fn_error "pwd does not report name of working directory"
-
-
-# Find the source files, if location was not specified.
-if test -z "$srcdir"; then
-  ac_srcdir_defaulted=yes
-  # Try the directory containing this script, then the parent directory.
-  ac_confdir=`$as_dirname -- "$as_myself" ||
-$as_expr X"$as_myself" : 'X\(.*[^/]\)//*[^/][^/]*/*$' \| \
-	 X"$as_myself" : 'X\(//\)[^/]' \| \
-	 X"$as_myself" : 'X\(//\)$' \| \
-	 X"$as_myself" : 'X\(/\)' \| . 2>/dev/null ||
-$as_echo X"$as_myself" |
-    sed '/^X\(.*[^/]\)\/\/*[^/][^/]*\/*$/{
-	    s//\1/
-	    q
-	  }
-	  /^X\(\/\/\)[^/].*/{
-	    s//\1/
-	    q
-	  }
-	  /^X\(\/\/\)$/{
-	    s//\1/
-	    q
-	  }
-	  /^X\(\/\).*/{
-	    s//\1/
-	    q
-	  }
-	  s/.*/./; q'`
-  srcdir=$ac_confdir
-  if test ! -r "$srcdir/$ac_unique_file"; then
-    srcdir=..
-  fi
-else
-  ac_srcdir_defaulted=no
-fi
-if test ! -r "$srcdir/$ac_unique_file"; then
-  test "$ac_srcdir_defaulted" = yes && srcdir="$ac_confdir or .."
-  as_fn_error "cannot find sources ($ac_unique_file) in $srcdir"
-fi
-ac_msg="sources are in $srcdir, but \`cd $srcdir' does not work"
-ac_abs_confdir=`(
-	cd "$srcdir" && test -r "./$ac_unique_file" || as_fn_error "$ac_msg"
-	pwd)`
-# When building in place, set srcdir=.
-if test "$ac_abs_confdir" = "$ac_pwd"; then
-  srcdir=.
-fi
-# Remove unnecessary trailing slashes from srcdir.
-# Double slashes in file names in object file debugging info
-# mess up M-x gdb in Emacs.
-case $srcdir in
-*/) srcdir=`expr "X$srcdir" : 'X\(.*[^/]\)' \| "X$srcdir" : 'X\(.*\)'`;;
-esac
-for ac_var in $ac_precious_vars; do
-  eval ac_env_${ac_var}_set=\${${ac_var}+set}
-  eval ac_env_${ac_var}_value=\$${ac_var}
-  eval ac_cv_env_${ac_var}_set=\${${ac_var}+set}
-  eval ac_cv_env_${ac_var}_value=\$${ac_var}
-done
-
-#
-# Report the --help message.
-#
-if test "$ac_init_help" = "long"; then
-  # Omit some internal or obsolete options to make the list less imposing.
-  # This message is too long to be a string in the A/UX 3.1 sh.
-  cat <<_ACEOF
-\`configure' configures dosbox 0.74 to adapt to many kinds of systems.
-
-Usage: $0 [OPTION]... [VAR=VALUE]...
-
-To assign environment variables (e.g., CC, CFLAGS...), specify them as
-VAR=VALUE.  See below for descriptions of some of the useful variables.
-
-Defaults for the options are specified in brackets.
-
-Configuration:
-  -h, --help              display this help and exit
-      --help=short        display options specific to this package
-      --help=recursive    display the short help of all the included packages
-  -V, --version           display version information and exit
-  -q, --quiet, --silent   do not print \`checking...' messages
-      --cache-file=FILE   cache test results in FILE [disabled]
-  -C, --config-cache      alias for \`--cache-file=config.cache'
-  -n, --no-create         do not create output files
-      --srcdir=DIR        find the sources in DIR [configure dir or \`..']
-
-Installation directories:
-  --prefix=PREFIX         install architecture-independent files in PREFIX
-                          [$ac_default_prefix]
-  --exec-prefix=EPREFIX   install architecture-dependent files in EPREFIX
-                          [PREFIX]
-
-By default, \`make install' will install all the files in
-\`$ac_default_prefix/bin', \`$ac_default_prefix/lib' etc.  You can specify
-an installation prefix other than \`$ac_default_prefix' using \`--prefix',
-for instance \`--prefix=\$HOME'.
-
-For better control, use the options below.
-
-Fine tuning of the installation directories:
-  --bindir=DIR            user executables [EPREFIX/bin]
-  --sbindir=DIR           system admin executables [EPREFIX/sbin]
-  --libexecdir=DIR        program executables [EPREFIX/libexec]
-  --sysconfdir=DIR        read-only single-machine data [PREFIX/etc]
-  --sharedstatedir=DIR    modifiable architecture-independent data [PREFIX/com]
-  --localstatedir=DIR     modifiable single-machine data [PREFIX/var]
-  --libdir=DIR            object code libraries [EPREFIX/lib]
-  --includedir=DIR        C header files [PREFIX/include]
-  --oldincludedir=DIR     C header files for non-gcc [/usr/include]
-  --datarootdir=DIR       read-only arch.-independent data root [PREFIX/share]
-  --datadir=DIR           read-only architecture-independent data [DATAROOTDIR]
-  --infodir=DIR           info documentation [DATAROOTDIR/info]
-  --localedir=DIR         locale-dependent data [DATAROOTDIR/locale]
-  --mandir=DIR            man documentation [DATAROOTDIR/man]
-  --docdir=DIR            documentation root [DATAROOTDIR/doc/dosbox]
-  --htmldir=DIR           html documentation [DOCDIR]
-  --dvidir=DIR            dvi documentation [DOCDIR]
-  --pdfdir=DIR            pdf documentation [DOCDIR]
-  --psdir=DIR             ps documentation [DOCDIR]
-_ACEOF
-
-  cat <<\_ACEOF
-
-Program names:
-  --program-prefix=PREFIX            prepend PREFIX to installed program names
-  --program-suffix=SUFFIX            append SUFFIX to installed program names
-  --program-transform-name=PROGRAM   run sed PROGRAM on installed program names
-
-System types:
-  --build=BUILD     configure for building on BUILD [guessed]
-  --host=HOST       cross-compile to build programs to run on HOST [BUILD]
-_ACEOF
-fi
-
-if test -n "$ac_init_help"; then
-  case $ac_init_help in
-     short | recursive ) echo "Configuration of dosbox 0.74:";;
-   esac
-  cat <<\_ACEOF
-
-Optional Features:
-  --disable-option-checking  ignore unrecognized --enable/--with options
-  --disable-FEATURE       do not include FEATURE (same as --enable-FEATURE=no)
-  --enable-FEATURE[=ARG]  include FEATURE [ARG=yes]
-  --disable-dependency-tracking  speeds up one-time build
-  --enable-dependency-tracking   do not reject slow dependency extractors
-  --disable-sdltest       Do not try to compile and run a test SDL program
-  --enable-alsa-midi      compile with alsa midi support (default yes)
-  --disable-alsatest      Do not try to compile and run a test Alsa program
-  --enable-debug          Enable debug mode
-  --enable-core-inline    Enable inlined memory handling in CPU Core
-  --disable-dynamic-core  Disable all dynamic cores
-  --disable-dynamic-x86   Disable x86 dynamic cpu core
-  --disable-dynrec        Disable recompiling cpu core
-  --disable-fpu           Disable fpu support
-  --disable-fpu-x86       Disable x86 assembly fpu core
-  --disable-unaligned-memory
-                          Disable unaligned memory access
-  --disable-opengl        Disable opengl support
-
-Optional Packages:
-  --with-PACKAGE[=ARG]    use PACKAGE [ARG=yes]
-  --without-PACKAGE       do not use PACKAGE (same as --with-PACKAGE=no)
-  --with-sdl-prefix=PFX   Prefix where SDL is installed (optional)
-  --with-sdl-exec-prefix=PFX Exec prefix where SDL is installed (optional)
-  --with-alsa-prefix=PFX  Prefix where Alsa library is installed(optional)
-  --with-alsa-inc-prefix=PFX  Prefix where include libraries are (optional)
-
-Some influential environment variables:
-  CC          C compiler command
-  CFLAGS      C compiler flags
-  LDFLAGS     linker flags, e.g. -L<lib dir> if you have libraries in a
-              nonstandard directory <lib dir>
-  LIBS        libraries to pass to the linker, e.g. -l<library>
-  CPPFLAGS    (Objective) C/C++ preprocessor flags, e.g. -I<include dir> if
-              you have headers in a nonstandard directory <include dir>
-  CPP         C preprocessor
-  CXX         C++ compiler command
-  CXXFLAGS    C++ compiler flags
-
-Use these variables to override the choices made by `configure' or to help
-it to find libraries and programs with nonstandard names/locations.
-
-Report bugs to the package provider.
-_ACEOF
-ac_status=$?
-fi
-
-if test "$ac_init_help" = "recursive"; then
-  # If there are subdirs, report their specific --help.
-  for ac_dir in : $ac_subdirs_all; do test "x$ac_dir" = x: && continue
-    test -d "$ac_dir" ||
-      { cd "$srcdir" && ac_pwd=`pwd` && srcdir=. && test -d "$ac_dir"; } ||
-      continue
-    ac_builddir=.
-
-case "$ac_dir" in
-.) ac_dir_suffix= ac_top_builddir_sub=. ac_top_build_prefix= ;;
-*)
-  ac_dir_suffix=/`$as_echo "$ac_dir" | sed 's|^\.[\\/]||'`
-  # A ".." for each directory in $ac_dir_suffix.
-  ac_top_builddir_sub=`$as_echo "$ac_dir_suffix" | sed 's|/[^\\/]*|/..|g;s|/||'`
-  case $ac_top_builddir_sub in
-  "") ac_top_builddir_sub=. ac_top_build_prefix= ;;
-  *)  ac_top_build_prefix=$ac_top_builddir_sub/ ;;
-  esac ;;
-esac
-ac_abs_top_builddir=$ac_pwd
-ac_abs_builddir=$ac_pwd$ac_dir_suffix
-# for backward compatibility:
-ac_top_builddir=$ac_top_build_prefix
-
-case $srcdir in
-  .)  # We are building in place.
-    ac_srcdir=.
-    ac_top_srcdir=$ac_top_builddir_sub
-    ac_abs_top_srcdir=$ac_pwd ;;
-  [\\/]* | ?:[\\/]* )  # Absolute name.
-    ac_srcdir=$srcdir$ac_dir_suffix;
-    ac_top_srcdir=$srcdir
-    ac_abs_top_srcdir=$srcdir ;;
-  *) # Relative name.
-    ac_srcdir=$ac_top_build_prefix$srcdir$ac_dir_suffix
-    ac_top_srcdir=$ac_top_build_prefix$srcdir
-    ac_abs_top_srcdir=$ac_pwd/$srcdir ;;
-esac
-ac_abs_srcdir=$ac_abs_top_srcdir$ac_dir_suffix
-
-    cd "$ac_dir" || { ac_status=$?; continue; }
-    # Check for guested configure.
-    if test -f "$ac_srcdir/configure.gnu"; then
-      echo &&
-      $SHELL "$ac_srcdir/configure.gnu" --help=recursive
-    elif test -f "$ac_srcdir/configure"; then
-      echo &&
-      $SHELL "$ac_srcdir/configure" --help=recursive
-    else
-      $as_echo "$as_me: WARNING: no configuration information is in $ac_dir" >&2
-    fi || ac_status=$?
-    cd "$ac_pwd" || { ac_status=$?; break; }
-  done
-fi
-
-test -n "$ac_init_help" && exit $ac_status
-if $ac_init_version; then
-  cat <<\_ACEOF
-dosbox configure 0.74
-generated by GNU Autoconf 2.65
-
-Copyright (C) 2009 Free Software Foundation, Inc.
-This configure script is free software; the Free Software Foundation
-gives unlimited permission to copy, distribute and modify it.
-_ACEOF
-  exit
-fi
-
-## ------------------------ ##
-## Autoconf initialization. ##
-## ------------------------ ##
-
-# ac_fn_c_try_compile LINENO
-# --------------------------
-# Try to compile conftest.$ac_ext, and return whether this succeeded.
-ac_fn_c_try_compile ()
-{
-  as_lineno=${as_lineno-"$1"} as_lineno_stack=as_lineno_stack=$as_lineno_stack
-  rm -f conftest.$ac_objext
-  if { { ac_try="$ac_compile"
-case "(($ac_try" in
-  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
-  *) ac_try_echo=$ac_try;;
-esac
-eval ac_try_echo="\"\$as_me:${as_lineno-$LINENO}: $ac_try_echo\""
-$as_echo "$ac_try_echo"; } >&5
-  (eval "$ac_compile") 2>conftest.err
-  ac_status=$?
-  if test -s conftest.err; then
-    grep -v '^ *+' conftest.err >conftest.er1
-    cat conftest.er1 >&5
-    mv -f conftest.er1 conftest.err
-  fi
-  $as_echo "$as_me:${as_lineno-$LINENO}: \$? = $ac_status" >&5
-  test $ac_status = 0; } && {
-	 test -z "$ac_c_werror_flag" ||
-	 test ! -s conftest.err
-       } && test -s conftest.$ac_objext; then :
-  ac_retval=0
-else
-  $as_echo "$as_me: failed program was:" >&5
-sed 's/^/| /' conftest.$ac_ext >&5
-
-	ac_retval=1
-fi
-  eval $as_lineno_stack; test "x$as_lineno_stack" = x && { as_lineno=; unset as_lineno;}
-  as_fn_set_status $ac_retval
-
-} # ac_fn_c_try_compile
-
-# ac_fn_c_try_cpp LINENO
-# ----------------------
-# Try to preprocess conftest.$ac_ext, and return whether this succeeded.
-ac_fn_c_try_cpp ()
-{
-  as_lineno=${as_lineno-"$1"} as_lineno_stack=as_lineno_stack=$as_lineno_stack
-  if { { ac_try="$ac_cpp conftest.$ac_ext"
-case "(($ac_try" in
-  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
-  *) ac_try_echo=$ac_try;;
-esac
-eval ac_try_echo="\"\$as_me:${as_lineno-$LINENO}: $ac_try_echo\""
-$as_echo "$ac_try_echo"; } >&5
-  (eval "$ac_cpp conftest.$ac_ext") 2>conftest.err
-  ac_status=$?
-  if test -s conftest.err; then
-    grep -v '^ *+' conftest.err >conftest.er1
-    cat conftest.er1 >&5
-    mv -f conftest.er1 conftest.err
-  fi
-  $as_echo "$as_me:${as_lineno-$LINENO}: \$? = $ac_status" >&5
-  test $ac_status = 0; } >/dev/null && {
-	 test -z "$ac_c_preproc_warn_flag$ac_c_werror_flag" ||
-	 test ! -s conftest.err
-       }; then :
-  ac_retval=0
-else
-  $as_echo "$as_me: failed program was:" >&5
-sed 's/^/| /' conftest.$ac_ext >&5
-
-    ac_retval=1
-fi
-  eval $as_lineno_stack; test "x$as_lineno_stack" = x && { as_lineno=; unset as_lineno;}
-  as_fn_set_status $ac_retval
-
-} # ac_fn_c_try_cpp
-
-# ac_fn_cxx_try_compile LINENO
-# ----------------------------
-# Try to compile conftest.$ac_ext, and return whether this succeeded.
-ac_fn_cxx_try_compile ()
-{
-  as_lineno=${as_lineno-"$1"} as_lineno_stack=as_lineno_stack=$as_lineno_stack
-  rm -f conftest.$ac_objext
-  if { { ac_try="$ac_compile"
-case "(($ac_try" in
-  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
-  *) ac_try_echo=$ac_try;;
-esac
-eval ac_try_echo="\"\$as_me:${as_lineno-$LINENO}: $ac_try_echo\""
-$as_echo "$ac_try_echo"; } >&5
-  (eval "$ac_compile") 2>conftest.err
-  ac_status=$?
-  if test -s conftest.err; then
-    grep -v '^ *+' conftest.err >conftest.er1
-    cat conftest.er1 >&5
-    mv -f conftest.er1 conftest.err
-  fi
-  $as_echo "$as_me:${as_lineno-$LINENO}: \$? = $ac_status" >&5
-  test $ac_status = 0; } && {
-	 test -z "$ac_cxx_werror_flag" ||
-	 test ! -s conftest.err
-       } && test -s conftest.$ac_objext; then :
-  ac_retval=0
-else
-  $as_echo "$as_me: failed program was:" >&5
-sed 's/^/| /' conftest.$ac_ext >&5
-
-	ac_retval=1
-fi
-  eval $as_lineno_stack; test "x$as_lineno_stack" = x && { as_lineno=; unset as_lineno;}
-  as_fn_set_status $ac_retval
-
-} # ac_fn_cxx_try_compile
-
-# ac_fn_c_try_run LINENO
-# ----------------------
-# Try to link conftest.$ac_ext, and return whether this succeeded. Assumes
-# that executables *can* be run.
-ac_fn_c_try_run ()
-{
-  as_lineno=${as_lineno-"$1"} as_lineno_stack=as_lineno_stack=$as_lineno_stack
-  if { { ac_try="$ac_link"
-case "(($ac_try" in
-  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
-  *) ac_try_echo=$ac_try;;
-esac
-eval ac_try_echo="\"\$as_me:${as_lineno-$LINENO}: $ac_try_echo\""
-$as_echo "$ac_try_echo"; } >&5
-  (eval "$ac_link") 2>&5
-  ac_status=$?
-  $as_echo "$as_me:${as_lineno-$LINENO}: \$? = $ac_status" >&5
-  test $ac_status = 0; } && { ac_try='./conftest$ac_exeext'
-  { { case "(($ac_try" in
-  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
-  *) ac_try_echo=$ac_try;;
-esac
-eval ac_try_echo="\"\$as_me:${as_lineno-$LINENO}: $ac_try_echo\""
-$as_echo "$ac_try_echo"; } >&5
-  (eval "$ac_try") 2>&5
-  ac_status=$?
-  $as_echo "$as_me:${as_lineno-$LINENO}: \$? = $ac_status" >&5
-  test $ac_status = 0; }; }; then :
-  ac_retval=0
-else
-  $as_echo "$as_me: program exited with status $ac_status" >&5
-       $as_echo "$as_me: failed program was:" >&5
-sed 's/^/| /' conftest.$ac_ext >&5
-
-       ac_retval=$ac_status
-fi
-  rm -rf conftest.dSYM conftest_ipa8_conftest.oo
-  eval $as_lineno_stack; test "x$as_lineno_stack" = x && { as_lineno=; unset as_lineno;}
-  as_fn_set_status $ac_retval
-
-} # ac_fn_c_try_run
-
-# ac_fn_c_try_link LINENO
-# -----------------------
-# Try to link conftest.$ac_ext, and return whether this succeeded.
-ac_fn_c_try_link ()
-{
-  as_lineno=${as_lineno-"$1"} as_lineno_stack=as_lineno_stack=$as_lineno_stack
-  rm -f conftest.$ac_objext conftest$ac_exeext
-  if { { ac_try="$ac_link"
-case "(($ac_try" in
-  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
-  *) ac_try_echo=$ac_try;;
-esac
-eval ac_try_echo="\"\$as_me:${as_lineno-$LINENO}: $ac_try_echo\""
-$as_echo "$ac_try_echo"; } >&5
-  (eval "$ac_link") 2>conftest.err
-  ac_status=$?
-  if test -s conftest.err; then
-    grep -v '^ *+' conftest.err >conftest.er1
-    cat conftest.er1 >&5
-    mv -f conftest.er1 conftest.err
-  fi
-  $as_echo "$as_me:${as_lineno-$LINENO}: \$? = $ac_status" >&5
-  test $ac_status = 0; } && {
-	 test -z "$ac_c_werror_flag" ||
-	 test ! -s conftest.err
-       } && test -s conftest$ac_exeext && {
-	 test "$cross_compiling" = yes ||
-	 $as_test_x conftest$ac_exeext
-       }; then :
-  ac_retval=0
-else
-  $as_echo "$as_me: failed program was:" >&5
-sed 's/^/| /' conftest.$ac_ext >&5
-
-	ac_retval=1
-fi
-  # Delete the IPA/IPO (Inter Procedural Analysis/Optimization) information
-  # created by the PGI compiler (conftest_ipa8_conftest.oo), as it would
-  # interfere with the next link command; also delete a directory that is
-  # left behind by Apple's compiler.  We do this before executing the actions.
-  rm -rf conftest.dSYM conftest_ipa8_conftest.oo
-  eval $as_lineno_stack; test "x$as_lineno_stack" = x && { as_lineno=; unset as_lineno;}
-  as_fn_set_status $ac_retval
-
-} # ac_fn_c_try_link
-
-# ac_fn_c_check_type LINENO TYPE VAR INCLUDES
-# -------------------------------------------
-# Tests whether TYPE exists after having included INCLUDES, setting cache
-# variable VAR accordingly.
-ac_fn_c_check_type ()
-{
-  as_lineno=${as_lineno-"$1"} as_lineno_stack=as_lineno_stack=$as_lineno_stack
-  { $as_echo "$as_me:${as_lineno-$LINENO}: checking for $2" >&5
-$as_echo_n "checking for $2... " >&6; }
-if { as_var=$3; eval "test \"\${$as_var+set}\" = set"; }; then :
-  $as_echo_n "(cached) " >&6
-else
-  eval "$3=no"
-  cat confdefs.h - <<_ACEOF >conftest.$ac_ext
-/* end confdefs.h.  */
-$4
-int
-main ()
-{
-if (sizeof ($2))
-	 return 0;
-  ;
-  return 0;
-}
-_ACEOF
-if ac_fn_c_try_compile "$LINENO"; then :
-  cat confdefs.h - <<_ACEOF >conftest.$ac_ext
-/* end confdefs.h.  */
-$4
-int
-main ()
-{
-if (sizeof (($2)))
-	    return 0;
-  ;
-  return 0;
-}
-_ACEOF
-if ac_fn_c_try_compile "$LINENO"; then :
-
-else
-  eval "$3=yes"
-fi
-rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
-fi
-rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
-fi
-eval ac_res=\$$3
-	       { $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_res" >&5
-$as_echo "$ac_res" >&6; }
-  eval $as_lineno_stack; test "x$as_lineno_stack" = x && { as_lineno=; unset as_lineno;}
-
-} # ac_fn_c_check_type
-
-# ac_fn_c_check_header_compile LINENO HEADER VAR INCLUDES
-# -------------------------------------------------------
-# Tests whether HEADER exists and can be compiled using the include files in
-# INCLUDES, setting the cache variable VAR accordingly.
-ac_fn_c_check_header_compile ()
-{
-  as_lineno=${as_lineno-"$1"} as_lineno_stack=as_lineno_stack=$as_lineno_stack
-  { $as_echo "$as_me:${as_lineno-$LINENO}: checking for $2" >&5
-$as_echo_n "checking for $2... " >&6; }
-if { as_var=$3; eval "test \"\${$as_var+set}\" = set"; }; then :
-  $as_echo_n "(cached) " >&6
-else
-  cat confdefs.h - <<_ACEOF >conftest.$ac_ext
-/* end confdefs.h.  */
-$4
-#include <$2>
-_ACEOF
-if ac_fn_c_try_compile "$LINENO"; then :
-  eval "$3=yes"
-else
-  eval "$3=no"
-fi
-rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
-fi
-eval ac_res=\$$3
-	       { $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_res" >&5
-$as_echo "$ac_res" >&6; }
-  eval $as_lineno_stack; test "x$as_lineno_stack" = x && { as_lineno=; unset as_lineno;}
-
-} # ac_fn_c_check_header_compile
-
-# ac_fn_c_compute_int LINENO EXPR VAR INCLUDES
-# --------------------------------------------
-# Tries to find the compile-time value of EXPR in a program that includes
-# INCLUDES, setting VAR accordingly. Returns whether the value could be
-# computed
-ac_fn_c_compute_int ()
-{
-  as_lineno=${as_lineno-"$1"} as_lineno_stack=as_lineno_stack=$as_lineno_stack
-  if test "$cross_compiling" = yes; then
-    # Depending upon the size, compute the lo and hi bounds.
-cat confdefs.h - <<_ACEOF >conftest.$ac_ext
-/* end confdefs.h.  */
-$4
-int
-main ()
-{
-static int test_array [1 - 2 * !(($2) >= 0)];
-test_array [0] = 0
-
-  ;
-  return 0;
-}
-_ACEOF
-if ac_fn_c_try_compile "$LINENO"; then :
-  ac_lo=0 ac_mid=0
-  while :; do
-    cat confdefs.h - <<_ACEOF >conftest.$ac_ext
-/* end confdefs.h.  */
-$4
-int
-main ()
-{
-static int test_array [1 - 2 * !(($2) <= $ac_mid)];
-test_array [0] = 0
-
-  ;
-  return 0;
-}
-_ACEOF
-if ac_fn_c_try_compile "$LINENO"; then :
-  ac_hi=$ac_mid; break
-else
-  as_fn_arith $ac_mid + 1 && ac_lo=$as_val
-			if test $ac_lo -le $ac_mid; then
-			  ac_lo= ac_hi=
-			  break
-			fi
-			as_fn_arith 2 '*' $ac_mid + 1 && ac_mid=$as_val
-fi
-rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
-  done
-else
-  cat confdefs.h - <<_ACEOF >conftest.$ac_ext
-/* end confdefs.h.  */
-$4
-int
-main ()
-{
-static int test_array [1 - 2 * !(($2) < 0)];
-test_array [0] = 0
-
-  ;
-  return 0;
-}
-_ACEOF
-if ac_fn_c_try_compile "$LINENO"; then :
-  ac_hi=-1 ac_mid=-1
-  while :; do
-    cat confdefs.h - <<_ACEOF >conftest.$ac_ext
-/* end confdefs.h.  */
-$4
-int
-main ()
-{
-static int test_array [1 - 2 * !(($2) >= $ac_mid)];
-test_array [0] = 0
-
-  ;
-  return 0;
-}
-_ACEOF
-if ac_fn_c_try_compile "$LINENO"; then :
-  ac_lo=$ac_mid; break
-else
-  as_fn_arith '(' $ac_mid ')' - 1 && ac_hi=$as_val
-			if test $ac_mid -le $ac_hi; then
-			  ac_lo= ac_hi=
-			  break
-			fi
-			as_fn_arith 2 '*' $ac_mid && ac_mid=$as_val
-fi
-rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
-  done
-else
-  ac_lo= ac_hi=
-fi
-rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
-fi
-rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
-# Binary search between lo and hi bounds.
-while test "x$ac_lo" != "x$ac_hi"; do
-  as_fn_arith '(' $ac_hi - $ac_lo ')' / 2 + $ac_lo && ac_mid=$as_val
-  cat confdefs.h - <<_ACEOF >conftest.$ac_ext
-/* end confdefs.h.  */
-$4
-int
-main ()
-{
-static int test_array [1 - 2 * !(($2) <= $ac_mid)];
-test_array [0] = 0
-
-  ;
-  return 0;
-}
-_ACEOF
-if ac_fn_c_try_compile "$LINENO"; then :
-  ac_hi=$ac_mid
-else
-  as_fn_arith '(' $ac_mid ')' + 1 && ac_lo=$as_val
-fi
-rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
-done
-case $ac_lo in #((
-?*) eval "$3=\$ac_lo"; ac_retval=0 ;;
-'') ac_retval=1 ;;
-esac
-  else
-    cat confdefs.h - <<_ACEOF >conftest.$ac_ext
-/* end confdefs.h.  */
-$4
-static long int longval () { return $2; }
-static unsigned long int ulongval () { return $2; }
-#include <stdio.h>
-#include <stdlib.h>
-int
-main ()
-{
-
-  FILE *f = fopen ("conftest.val", "w");
-  if (! f)
-    return 1;
-  if (($2) < 0)
-    {
-      long int i = longval ();
-      if (i != ($2))
-	return 1;
-      fprintf (f, "%ld", i);
-    }
-  else
-    {
-      unsigned long int i = ulongval ();
-      if (i != ($2))
-	return 1;
-      fprintf (f, "%lu", i);
-    }
-  /* Do not output a trailing newline, as this causes \r\n confusion
-     on some platforms.  */
-  return ferror (f) || fclose (f) != 0;
-
-  ;
-  return 0;
-}
-_ACEOF
-if ac_fn_c_try_run "$LINENO"; then :
-  echo >>conftest.val; read $3 <conftest.val; ac_retval=0
-else
-  ac_retval=1
-fi
-rm -f core *.core core.conftest.* gmon.out bb.out conftest$ac_exeext \
-  conftest.$ac_objext conftest.beam conftest.$ac_ext
-rm -f conftest.val
-
-  fi
-  eval $as_lineno_stack; test "x$as_lineno_stack" = x && { as_lineno=; unset as_lineno;}
-  as_fn_set_status $ac_retval
-
-} # ac_fn_c_compute_int
-
-# ac_fn_c_check_header_mongrel LINENO HEADER VAR INCLUDES
-# -------------------------------------------------------
-# Tests whether HEADER exists, giving a warning if it cannot be compiled using
-# the include files in INCLUDES and setting the cache variable VAR
-# accordingly.
-ac_fn_c_check_header_mongrel ()
-{
-  as_lineno=${as_lineno-"$1"} as_lineno_stack=as_lineno_stack=$as_lineno_stack
-  if { as_var=$3; eval "test \"\${$as_var+set}\" = set"; }; then :
-  { $as_echo "$as_me:${as_lineno-$LINENO}: checking for $2" >&5
-$as_echo_n "checking for $2... " >&6; }
-if { as_var=$3; eval "test \"\${$as_var+set}\" = set"; }; then :
-  $as_echo_n "(cached) " >&6
-fi
-eval ac_res=\$$3
-	       { $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_res" >&5
-$as_echo "$ac_res" >&6; }
-else
-  # Is the header compilable?
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking $2 usability" >&5
-$as_echo_n "checking $2 usability... " >&6; }
-cat confdefs.h - <<_ACEOF >conftest.$ac_ext
-/* end confdefs.h.  */
-$4
-#include <$2>
-_ACEOF
-if ac_fn_c_try_compile "$LINENO"; then :
-  ac_header_compiler=yes
-else
-  ac_header_compiler=no
-fi
-rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_header_compiler" >&5
-$as_echo "$ac_header_compiler" >&6; }
-
-# Is the header present?
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking $2 presence" >&5
-$as_echo_n "checking $2 presence... " >&6; }
-cat confdefs.h - <<_ACEOF >conftest.$ac_ext
-/* end confdefs.h.  */
-#include <$2>
-_ACEOF
-if ac_fn_c_try_cpp "$LINENO"; then :
-  ac_header_preproc=yes
-else
-  ac_header_preproc=no
-fi
-rm -f conftest.err conftest.$ac_ext
-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_header_preproc" >&5
-$as_echo "$ac_header_preproc" >&6; }
-
-# So?  What about this header?
-case $ac_header_compiler:$ac_header_preproc:$ac_c_preproc_warn_flag in #((
-  yes:no: )
-    { $as_echo "$as_me:${as_lineno-$LINENO}: WARNING: $2: accepted by the compiler, rejected by the preprocessor!" >&5
-$as_echo "$as_me: WARNING: $2: accepted by the compiler, rejected by the preprocessor!" >&2;}
-    { $as_echo "$as_me:${as_lineno-$LINENO}: WARNING: $2: proceeding with the compiler's result" >&5
-$as_echo "$as_me: WARNING: $2: proceeding with the compiler's result" >&2;}
-    ;;
-  no:yes:* )
-    { $as_echo "$as_me:${as_lineno-$LINENO}: WARNING: $2: present but cannot be compiled" >&5
-$as_echo "$as_me: WARNING: $2: present but cannot be compiled" >&2;}
-    { $as_echo "$as_me:${as_lineno-$LINENO}: WARNING: $2:     check for missing prerequisite headers?" >&5
-$as_echo "$as_me: WARNING: $2:     check for missing prerequisite headers?" >&2;}
-    { $as_echo "$as_me:${as_lineno-$LINENO}: WARNING: $2: see the Autoconf documentation" >&5
-$as_echo "$as_me: WARNING: $2: see the Autoconf documentation" >&2;}
-    { $as_echo "$as_me:${as_lineno-$LINENO}: WARNING: $2:     section \"Present But Cannot Be Compiled\"" >&5
-$as_echo "$as_me: WARNING: $2:     section \"Present But Cannot Be Compiled\"" >&2;}
-    { $as_echo "$as_me:${as_lineno-$LINENO}: WARNING: $2: proceeding with the compiler's result" >&5
-$as_echo "$as_me: WARNING: $2: proceeding with the compiler's result" >&2;}
-    ;;
-esac
-  { $as_echo "$as_me:${as_lineno-$LINENO}: checking for $2" >&5
-$as_echo_n "checking for $2... " >&6; }
-if { as_var=$3; eval "test \"\${$as_var+set}\" = set"; }; then :
-  $as_echo_n "(cached) " >&6
-else
-  eval "$3=\$ac_header_compiler"
-fi
-eval ac_res=\$$3
-	       { $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_res" >&5
-$as_echo "$ac_res" >&6; }
-fi
-  eval $as_lineno_stack; test "x$as_lineno_stack" = x && { as_lineno=; unset as_lineno;}
-
-} # ac_fn_c_check_header_mongrel
-
-# ac_fn_c_check_func LINENO FUNC VAR
-# ----------------------------------
-# Tests whether FUNC exists, setting the cache variable VAR accordingly
-ac_fn_c_check_func ()
-{
-  as_lineno=${as_lineno-"$1"} as_lineno_stack=as_lineno_stack=$as_lineno_stack
-  { $as_echo "$as_me:${as_lineno-$LINENO}: checking for $2" >&5
-$as_echo_n "checking for $2... " >&6; }
-if { as_var=$3; eval "test \"\${$as_var+set}\" = set"; }; then :
-  $as_echo_n "(cached) " >&6
-else
-  cat confdefs.h - <<_ACEOF >conftest.$ac_ext
-/* end confdefs.h.  */
-/* Define $2 to an innocuous variant, in case <limits.h> declares $2.
-   For example, HP-UX 11i <limits.h> declares gettimeofday.  */
-#define $2 innocuous_$2
-
-/* System header to define __stub macros and hopefully few prototypes,
-    which can conflict with char $2 (); below.
-    Prefer <limits.h> to <assert.h> if __STDC__ is defined, since
-    <limits.h> exists even on freestanding compilers.  */
-
-#ifdef __STDC__
-# include <limits.h>
-#else
-# include <assert.h>
-#endif
-
-#undef $2
-
-/* Override any GCC internal prototype to avoid an error.
-   Use char because int might match the return type of a GCC
-   builtin and then its argument prototype would still apply.  */
-#ifdef __cplusplus
-extern "C"
-#endif
-char $2 ();
-/* The GNU C library defines this for functions which it implements
-    to always fail with ENOSYS.  Some functions are actually named
-    something starting with __ and the normal name is an alias.  */
-#if defined __stub_$2 || defined __stub___$2
-choke me
-#endif
-
-int
-main ()
-{
-return $2 ();
-  ;
-  return 0;
-}
-_ACEOF
-if ac_fn_c_try_link "$LINENO"; then :
-  eval "$3=yes"
-else
-  eval "$3=no"
-fi
-rm -f core conftest.err conftest.$ac_objext \
-    conftest$ac_exeext conftest.$ac_ext
-fi
-eval ac_res=\$$3
-	       { $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_res" >&5
-$as_echo "$ac_res" >&6; }
-  eval $as_lineno_stack; test "x$as_lineno_stack" = x && { as_lineno=; unset as_lineno;}
-
-} # ac_fn_c_check_func
-cat >config.log <<_ACEOF
-This file contains any messages produced by compilers while
-running configure, to aid debugging if configure makes a mistake.
-
-It was created by dosbox $as_me 0.74, which was
-generated by GNU Autoconf 2.65.  Invocation command line was
-
-  $ $0 $@
-
-_ACEOF
-exec 5>>config.log
-{
-cat <<_ASUNAME
-## --------- ##
-## Platform. ##
-## --------- ##
-
-hostname = `(hostname || uname -n) 2>/dev/null | sed 1q`
-uname -m = `(uname -m) 2>/dev/null || echo unknown`
-uname -r = `(uname -r) 2>/dev/null || echo unknown`
-uname -s = `(uname -s) 2>/dev/null || echo unknown`
-uname -v = `(uname -v) 2>/dev/null || echo unknown`
-
-/usr/bin/uname -p = `(/usr/bin/uname -p) 2>/dev/null || echo unknown`
-/bin/uname -X     = `(/bin/uname -X) 2>/dev/null     || echo unknown`
-
-/bin/arch              = `(/bin/arch) 2>/dev/null              || echo unknown`
-/usr/bin/arch -k       = `(/usr/bin/arch -k) 2>/dev/null       || echo unknown`
-/usr/convex/getsysinfo = `(/usr/convex/getsysinfo) 2>/dev/null || echo unknown`
-/usr/bin/hostinfo      = `(/usr/bin/hostinfo) 2>/dev/null      || echo unknown`
-/bin/machine           = `(/bin/machine) 2>/dev/null           || echo unknown`
-/usr/bin/oslevel       = `(/usr/bin/oslevel) 2>/dev/null       || echo unknown`
-/bin/universe          = `(/bin/universe) 2>/dev/null          || echo unknown`
-
-_ASUNAME
-
-as_save_IFS=$IFS; IFS=$PATH_SEPARATOR
-for as_dir in $PATH
-do
-  IFS=$as_save_IFS
-  test -z "$as_dir" && as_dir=.
-    $as_echo "PATH: $as_dir"
-  done
-IFS=$as_save_IFS
-
-} >&5
-
-cat >&5 <<_ACEOF
-
-
-## ----------- ##
-## Core tests. ##
-## ----------- ##
-
-_ACEOF
-
-
-# Keep a trace of the command line.
-# Strip out --no-create and --no-recursion so they do not pile up.
-# Strip out --silent because we don't want to record it for future runs.
-# Also quote any args containing shell meta-characters.
-# Make two passes to allow for proper duplicate-argument suppression.
-ac_configure_args=
-ac_configure_args0=
-ac_configure_args1=
-ac_must_keep_next=false
-for ac_pass in 1 2
-do
-  for ac_arg
-  do
-    case $ac_arg in
-    -no-create | --no-c* | -n | -no-recursion | --no-r*) continue ;;
-    -q | -quiet | --quiet | --quie | --qui | --qu | --q \
-    | -silent | --silent | --silen | --sile | --sil)
-      continue ;;
-    *\'*)
-      ac_arg=`$as_echo "$ac_arg" | sed "s/'/'\\\\\\\\''/g"` ;;
-    esac
-    case $ac_pass in
-    1) as_fn_append ac_configure_args0 " '$ac_arg'" ;;
-    2)
-      as_fn_append ac_configure_args1 " '$ac_arg'"
-      if test $ac_must_keep_next = true; then
-	ac_must_keep_next=false # Got value, back to normal.
-      else
-	case $ac_arg in
-	  *=* | --config-cache | -C | -disable-* | --disable-* \
-	  | -enable-* | --enable-* | -gas | --g* | -nfp | --nf* \
-	  | -q | -quiet | --q* | -silent | --sil* | -v | -verb* \
-	  | -with-* | --with-* | -without-* | --without-* | --x)
-	    case "$ac_configure_args0 " in
-	      "$ac_configure_args1"*" '$ac_arg' "* ) continue ;;
-	    esac
-	    ;;
-	  -* ) ac_must_keep_next=true ;;
-	esac
-      fi
-      as_fn_append ac_configure_args " '$ac_arg'"
-      ;;
-    esac
-  done
-done
-{ ac_configure_args0=; unset ac_configure_args0;}
-{ ac_configure_args1=; unset ac_configure_args1;}
-
-# When interrupted or exit'd, cleanup temporary files, and complete
-# config.log.  We remove comments because anyway the quotes in there
-# would cause problems or look ugly.
-# WARNING: Use '\'' to represent an apostrophe within the trap.
-# WARNING: Do not start the trap code with a newline, due to a FreeBSD 4.0 bug.
-trap 'exit_status=$?
-  # Save into config.log some information that might help in debugging.
-  {
-    echo
-
-    cat <<\_ASBOX
-## ---------------- ##
-## Cache variables. ##
-## ---------------- ##
-_ASBOX
-    echo
-    # The following way of writing the cache mishandles newlines in values,
-(
-  for ac_var in `(set) 2>&1 | sed -n '\''s/^\([a-zA-Z_][a-zA-Z0-9_]*\)=.*/\1/p'\''`; do
-    eval ac_val=\$$ac_var
-    case $ac_val in #(
-    *${as_nl}*)
-      case $ac_var in #(
-      *_cv_*) { $as_echo "$as_me:${as_lineno-$LINENO}: WARNING: cache variable $ac_var contains a newline" >&5
-$as_echo "$as_me: WARNING: cache variable $ac_var contains a newline" >&2;} ;;
-      esac
-      case $ac_var in #(
-      _ | IFS | as_nl) ;; #(
-      BASH_ARGV | BASH_SOURCE) eval $ac_var= ;; #(
-      *) { eval $ac_var=; unset $ac_var;} ;;
-      esac ;;
-    esac
-  done
-  (set) 2>&1 |
-    case $as_nl`(ac_space='\'' '\''; set) 2>&1` in #(
-    *${as_nl}ac_space=\ *)
-      sed -n \
-	"s/'\''/'\''\\\\'\'''\''/g;
-	  s/^\\([_$as_cr_alnum]*_cv_[_$as_cr_alnum]*\\)=\\(.*\\)/\\1='\''\\2'\''/p"
-      ;; #(
-    *)
-      sed -n "/^[_$as_cr_alnum]*_cv_[_$as_cr_alnum]*=/p"
-      ;;
-    esac |
-    sort
-)
-    echo
-
-    cat <<\_ASBOX
-## ----------------- ##
-## Output variables. ##
-## ----------------- ##
-_ASBOX
-    echo
-    for ac_var in $ac_subst_vars
-    do
-      eval ac_val=\$$ac_var
-      case $ac_val in
-      *\'\''*) ac_val=`$as_echo "$ac_val" | sed "s/'\''/'\''\\\\\\\\'\'''\''/g"`;;
-      esac
-      $as_echo "$ac_var='\''$ac_val'\''"
-    done | sort
-    echo
-
-    if test -n "$ac_subst_files"; then
-      cat <<\_ASBOX
-## ------------------- ##
-## File substitutions. ##
-## ------------------- ##
-_ASBOX
-      echo
-      for ac_var in $ac_subst_files
-      do
-	eval ac_val=\$$ac_var
-	case $ac_val in
-	*\'\''*) ac_val=`$as_echo "$ac_val" | sed "s/'\''/'\''\\\\\\\\'\'''\''/g"`;;
-	esac
-	$as_echo "$ac_var='\''$ac_val'\''"
-      done | sort
-      echo
-    fi
-
-    if test -s confdefs.h; then
-      cat <<\_ASBOX
-## ----------- ##
-## confdefs.h. ##
-## ----------- ##
-_ASBOX
-      echo
-      cat confdefs.h
-      echo
-    fi
-    test "$ac_signal" != 0 &&
-      $as_echo "$as_me: caught signal $ac_signal"
-    $as_echo "$as_me: exit $exit_status"
-  } >&5
-  rm -f core *.core core.conftest.* &&
-    rm -f -r conftest* confdefs* conf$$* $ac_clean_files &&
-    exit $exit_status
-' 0
-for ac_signal in 1 2 13 15; do
-  trap 'ac_signal='$ac_signal'; as_fn_exit 1' $ac_signal
-done
-ac_signal=0
-
-# confdefs.h avoids OS command line length limits that DEFS can exceed.
-rm -f -r conftest* confdefs.h
-
-$as_echo "/* confdefs.h */" > confdefs.h
-
-# Predefined preprocessor variables.
-
-cat >>confdefs.h <<_ACEOF
-#define PACKAGE_NAME "$PACKAGE_NAME"
-_ACEOF
-
-cat >>confdefs.h <<_ACEOF
-#define PACKAGE_TARNAME "$PACKAGE_TARNAME"
-_ACEOF
-
-cat >>confdefs.h <<_ACEOF
-#define PACKAGE_VERSION "$PACKAGE_VERSION"
-_ACEOF
-
-cat >>confdefs.h <<_ACEOF
-#define PACKAGE_STRING "$PACKAGE_STRING"
-_ACEOF
-
-cat >>confdefs.h <<_ACEOF
-#define PACKAGE_BUGREPORT "$PACKAGE_BUGREPORT"
-_ACEOF
-
-cat >>confdefs.h <<_ACEOF
-#define PACKAGE_URL "$PACKAGE_URL"
-_ACEOF
-
-
-# Let the site file select an alternate cache file if it wants to.
-# Prefer an explicitly selected file to automatically selected ones.
-ac_site_file1=NONE
-ac_site_file2=NONE
-if test -n "$CONFIG_SITE"; then
-  ac_site_file1=$CONFIG_SITE
-elif test "x$prefix" != xNONE; then
-  ac_site_file1=$prefix/share/config.site
-  ac_site_file2=$prefix/etc/config.site
-else
-  ac_site_file1=$ac_default_prefix/share/config.site
-  ac_site_file2=$ac_default_prefix/etc/config.site
-fi
-for ac_site_file in "$ac_site_file1" "$ac_site_file2"
-do
-  test "x$ac_site_file" = xNONE && continue
-  if test /dev/null != "$ac_site_file" && test -r "$ac_site_file"; then
-    { $as_echo "$as_me:${as_lineno-$LINENO}: loading site script $ac_site_file" >&5
-$as_echo "$as_me: loading site script $ac_site_file" >&6;}
-    sed 's/^/| /' "$ac_site_file" >&5
-    . "$ac_site_file"
-  fi
-done
-
-if test -r "$cache_file"; then
-  # Some versions of bash will fail to source /dev/null (special files
-  # actually), so we avoid doing that.  DJGPP emulates it as a regular file.
-  if test /dev/null != "$cache_file" && test -f "$cache_file"; then
-    { $as_echo "$as_me:${as_lineno-$LINENO}: loading cache $cache_file" >&5
-$as_echo "$as_me: loading cache $cache_file" >&6;}
-    case $cache_file in
-      [\\/]* | ?:[\\/]* ) . "$cache_file";;
-      *)                      . "./$cache_file";;
-    esac
-  fi
-else
-  { $as_echo "$as_me:${as_lineno-$LINENO}: creating cache $cache_file" >&5
-$as_echo "$as_me: creating cache $cache_file" >&6;}
-  >$cache_file
-fi
-
-# Check that the precious variables saved in the cache have kept the same
-# value.
-ac_cache_corrupted=false
-for ac_var in $ac_precious_vars; do
-  eval ac_old_set=\$ac_cv_env_${ac_var}_set
-  eval ac_new_set=\$ac_env_${ac_var}_set
-  eval ac_old_val=\$ac_cv_env_${ac_var}_value
-  eval ac_new_val=\$ac_env_${ac_var}_value
-  case $ac_old_set,$ac_new_set in
-    set,)
-      { $as_echo "$as_me:${as_lineno-$LINENO}: error: \`$ac_var' was set to \`$ac_old_val' in the previous run" >&5
-$as_echo "$as_me: error: \`$ac_var' was set to \`$ac_old_val' in the previous run" >&2;}
-      ac_cache_corrupted=: ;;
-    ,set)
-      { $as_echo "$as_me:${as_lineno-$LINENO}: error: \`$ac_var' was not set in the previous run" >&5
-$as_echo "$as_me: error: \`$ac_var' was not set in the previous run" >&2;}
-      ac_cache_corrupted=: ;;
-    ,);;
-    *)
-      if test "x$ac_old_val" != "x$ac_new_val"; then
-	# differences in whitespace do not lead to failure.
-	ac_old_val_w=`echo x $ac_old_val`
-	ac_new_val_w=`echo x $ac_new_val`
-	if test "$ac_old_val_w" != "$ac_new_val_w"; then
-	  { $as_echo "$as_me:${as_lineno-$LINENO}: error: \`$ac_var' has changed since the previous run:" >&5
-$as_echo "$as_me: error: \`$ac_var' has changed since the previous run:" >&2;}
-	  ac_cache_corrupted=:
-	else
-	  { $as_echo "$as_me:${as_lineno-$LINENO}: warning: ignoring whitespace changes in \`$ac_var' since the previous run:" >&5
-$as_echo "$as_me: warning: ignoring whitespace changes in \`$ac_var' since the previous run:" >&2;}
-	  eval $ac_var=\$ac_old_val
-	fi
-	{ $as_echo "$as_me:${as_lineno-$LINENO}:   former value:  \`$ac_old_val'" >&5
-$as_echo "$as_me:   former value:  \`$ac_old_val'" >&2;}
-	{ $as_echo "$as_me:${as_lineno-$LINENO}:   current value: \`$ac_new_val'" >&5
-$as_echo "$as_me:   current value: \`$ac_new_val'" >&2;}
-      fi;;
-  esac
-  # Pass precious variables to config.status.
-  if test "$ac_new_set" = set; then
-    case $ac_new_val in
-    *\'*) ac_arg=$ac_var=`$as_echo "$ac_new_val" | sed "s/'/'\\\\\\\\''/g"` ;;
-    *) ac_arg=$ac_var=$ac_new_val ;;
-    esac
-    case " $ac_configure_args " in
-      *" '$ac_arg' "*) ;; # Avoid dups.  Use of quotes ensures accuracy.
-      *) as_fn_append ac_configure_args " '$ac_arg'" ;;
-    esac
-  fi
-done
-if $ac_cache_corrupted; then
-  { $as_echo "$as_me:${as_lineno-$LINENO}: error: in \`$ac_pwd':" >&5
-$as_echo "$as_me: error: in \`$ac_pwd':" >&2;}
-  { $as_echo "$as_me:${as_lineno-$LINENO}: error: changes in the environment can compromise the build" >&5
-$as_echo "$as_me: error: changes in the environment can compromise the build" >&2;}
-  as_fn_error "run \`make distclean' and/or \`rm $cache_file' and start over" "$LINENO" 5
-fi
-## -------------------- ##
-## Main body of script. ##
-## -------------------- ##
-
-ac_ext=c
-ac_cpp='$CPP $CPPFLAGS'
-ac_compile='$CC -c $CFLAGS $CPPFLAGS conftest.$ac_ext >&5'
-ac_link='$CC -o conftest$ac_exeext $CFLAGS $CPPFLAGS $LDFLAGS conftest.$ac_ext $LIBS >&5'
-ac_compiler_gnu=$ac_cv_c_compiler_gnu
-
-
-
-
-
-ac_aux_dir=
-for ac_dir in "$srcdir" "$srcdir/.." "$srcdir/../.."; do
-  for ac_t in install-sh install.sh shtool; do
-    if test -f "$ac_dir/$ac_t"; then
-      ac_aux_dir=$ac_dir
-      ac_install_sh="$ac_aux_dir/$ac_t -c"
-      break 2
-    fi
-  done
-done
-if test -z "$ac_aux_dir"; then
-  as_fn_error "cannot find install-sh, install.sh, or shtool in \"$srcdir\" \"$srcdir/..\" \"$srcdir/../..\"" "$LINENO" 5
-fi
-
-# These three variables are undocumented and unsupported,
-# and are intended to be withdrawn in a future Autoconf release.
-# They can cause serious problems if a builder's source tree is in a directory
-# whose full name contains unusual characters.
-ac_config_guess="$SHELL $ac_aux_dir/config.guess"  # Please don't use this var.
-ac_config_sub="$SHELL $ac_aux_dir/config.sub"  # Please don't use this var.
-ac_configure="$SHELL $ac_aux_dir/configure"  # Please don't use this var.
-
-
-# Make sure we can run config.sub.
-$SHELL "$ac_aux_dir/config.sub" sun4 >/dev/null 2>&1 ||
-  as_fn_error "cannot run $SHELL $ac_aux_dir/config.sub" "$LINENO" 5
-
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking build system type" >&5
-$as_echo_n "checking build system type... " >&6; }
-if test "${ac_cv_build+set}" = set; then :
-  $as_echo_n "(cached) " >&6
-else
-  ac_build_alias=$build_alias
-test "x$ac_build_alias" = x &&
-  ac_build_alias=`$SHELL "$ac_aux_dir/config.guess"`
-test "x$ac_build_alias" = x &&
-  as_fn_error "cannot guess build type; you must specify one" "$LINENO" 5
-ac_cv_build=`$SHELL "$ac_aux_dir/config.sub" $ac_build_alias` ||
-  as_fn_error "$SHELL $ac_aux_dir/config.sub $ac_build_alias failed" "$LINENO" 5
-
-fi
-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_build" >&5
-$as_echo "$ac_cv_build" >&6; }
-case $ac_cv_build in
-*-*-*) ;;
-*) as_fn_error "invalid value of canonical build" "$LINENO" 5;;
-esac
-build=$ac_cv_build
-ac_save_IFS=$IFS; IFS='-'
-set x $ac_cv_build
-shift
-build_cpu=$1
-build_vendor=$2
-shift; shift
-# Remember, the first character of IFS is used to create $*,
-# except with old shells:
-build_os=$*
-IFS=$ac_save_IFS
-case $build_os in *\ *) build_os=`echo "$build_os" | sed 's/ /-/g'`;; esac
-
-
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking host system type" >&5
-$as_echo_n "checking host system type... " >&6; }
-if test "${ac_cv_host+set}" = set; then :
-  $as_echo_n "(cached) " >&6
-else
-  if test "x$host_alias" = x; then
-  ac_cv_host=$ac_cv_build
-else
-  ac_cv_host=`$SHELL "$ac_aux_dir/config.sub" $host_alias` ||
-    as_fn_error "$SHELL $ac_aux_dir/config.sub $host_alias failed" "$LINENO" 5
-fi
-
-fi
-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_host" >&5
-$as_echo "$ac_cv_host" >&6; }
-case $ac_cv_host in
-*-*-*) ;;
-*) as_fn_error "invalid value of canonical host" "$LINENO" 5;;
-esac
-host=$ac_cv_host
-ac_save_IFS=$IFS; IFS='-'
-set x $ac_cv_host
-shift
-host_cpu=$1
-host_vendor=$2
-shift; shift
-# Remember, the first character of IFS is used to create $*,
-# except with old shells:
-host_os=$*
-IFS=$ac_save_IFS
-case $host_os in *\ *) host_os=`echo "$host_os" | sed 's/ /-/g'`;; esac
-
-
-
-
-am__api_version='1.11'
-
-# Find a good install program.  We prefer a C program (faster),
-# so one script is as good as another.  But avoid the broken or
-# incompatible versions:
-# SysV /etc/install, /usr/sbin/install
-# SunOS /usr/etc/install
-# IRIX /sbin/install
-# AIX /bin/install
-# AmigaOS /C/install, which installs bootblocks on floppy discs
-# AIX 4 /usr/bin/installbsd, which doesn't work without a -g flag
-# AFS /usr/afsws/bin/install, which mishandles nonexistent args
-# SVR4 /usr/ucb/install, which tries to use the nonexistent group "staff"
-# OS/2's system install, which has a completely different semantic
-# ./install, which can be erroneously created by make from ./install.sh.
-# Reject install programs that cannot install multiple files.
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for a BSD-compatible install" >&5
-$as_echo_n "checking for a BSD-compatible install... " >&6; }
-if test -z "$INSTALL"; then
-if test "${ac_cv_path_install+set}" = set; then :
-  $as_echo_n "(cached) " >&6
-else
-  as_save_IFS=$IFS; IFS=$PATH_SEPARATOR
-for as_dir in $PATH
-do
-  IFS=$as_save_IFS
-  test -z "$as_dir" && as_dir=.
-    # Account for people who put trailing slashes in PATH elements.
-case $as_dir/ in #((
-  ./ | .// | /[cC]/* | \
-  /etc/* | /usr/sbin/* | /usr/etc/* | /sbin/* | /usr/afsws/bin/* | \
-  ?:[\\/]os2[\\/]install[\\/]* | ?:[\\/]OS2[\\/]INSTALL[\\/]* | \
-  /usr/ucb/* ) ;;
-  *)
-    # OSF1 and SCO ODT 3.0 have their own names for install.
-    # Don't use installbsd from OSF since it installs stuff as root
-    # by default.
-    for ac_prog in ginstall scoinst install; do
-      for ac_exec_ext in '' $ac_executable_extensions; do
-	if { test -f "$as_dir/$ac_prog$ac_exec_ext" && $as_test_x "$as_dir/$ac_prog$ac_exec_ext"; }; then
-	  if test $ac_prog = install &&
-	    grep dspmsg "$as_dir/$ac_prog$ac_exec_ext" >/dev/null 2>&1; then
-	    # AIX install.  It has an incompatible calling convention.
-	    :
-	  elif test $ac_prog = install &&
-	    grep pwplus "$as_dir/$ac_prog$ac_exec_ext" >/dev/null 2>&1; then
-	    # program-specific install script used by HP pwplus--don't use.
-	    :
-	  else
-	    rm -rf conftest.one conftest.two conftest.dir
-	    echo one > conftest.one
-	    echo two > conftest.two
-	    mkdir conftest.dir
-	    if "$as_dir/$ac_prog$ac_exec_ext" -c conftest.one conftest.two "`pwd`/conftest.dir" &&
-	      test -s conftest.one && test -s conftest.two &&
-	      test -s conftest.dir/conftest.one &&
-	      test -s conftest.dir/conftest.two
-	    then
-	      ac_cv_path_install="$as_dir/$ac_prog$ac_exec_ext -c"
-	      break 3
-	    fi
-	  fi
-	fi
-      done
-    done
-    ;;
-esac
-
-  done
-IFS=$as_save_IFS
-
-rm -rf conftest.one conftest.two conftest.dir
-
-fi
-  if test "${ac_cv_path_install+set}" = set; then
-    INSTALL=$ac_cv_path_install
-  else
-    # As a last resort, use the slow shell script.  Don't cache a
-    # value for INSTALL within a source directory, because that will
-    # break other packages using the cache if that directory is
-    # removed, or if the value is a relative name.
-    INSTALL=$ac_install_sh
-  fi
-fi
-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $INSTALL" >&5
-$as_echo "$INSTALL" >&6; }
-
-# Use test -z because SunOS4 sh mishandles braces in ${var-val}.
-# It thinks the first close brace ends the variable substitution.
-test -z "$INSTALL_PROGRAM" && INSTALL_PROGRAM='${INSTALL}'
-
-test -z "$INSTALL_SCRIPT" && INSTALL_SCRIPT='${INSTALL}'
-
-test -z "$INSTALL_DATA" && INSTALL_DATA='${INSTALL} -m 644'
-
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking whether build environment is sane" >&5
-$as_echo_n "checking whether build environment is sane... " >&6; }
-# Just in case
-sleep 1
-echo timestamp > conftest.file
-# Reject unsafe characters in $srcdir or the absolute working directory
-# name.  Accept space and tab only in the latter.
-am_lf='
-'
-case `pwd` in
-  *[\\\"\#\$\&\'\`$am_lf]*)
-    as_fn_error "unsafe absolute working directory name" "$LINENO" 5;;
-esac
-case $srcdir in
-  *[\\\"\#\$\&\'\`$am_lf\ \	]*)
-    as_fn_error "unsafe srcdir value: \`$srcdir'" "$LINENO" 5;;
-esac
-
-# Do `set' in a subshell so we don't clobber the current shell's
-# arguments.  Must try -L first in case configure is actually a
-# symlink; some systems play weird games with the mod time of symlinks
-# (eg FreeBSD returns the mod time of the symlink's containing
-# directory).
-if (
-   set X `ls -Lt "$srcdir/configure" conftest.file 2> /dev/null`
-   if test "$*" = "X"; then
-      # -L didn't work.
-      set X `ls -t "$srcdir/configure" conftest.file`
-   fi
-   rm -f conftest.file
-   if test "$*" != "X $srcdir/configure conftest.file" \
-      && test "$*" != "X conftest.file $srcdir/configure"; then
-
-      # If neither matched, then we have a broken ls.  This can happen
-      # if, for instance, CONFIG_SHELL is bash and it inherits a
-      # broken ls alias from the environment.  This has actually
-      # happened.  Such a system could not be considered "sane".
-      as_fn_error "ls -t appears to fail.  Make sure there is not a broken
-alias in your environment" "$LINENO" 5
-   fi
-
-   test "$2" = conftest.file
-   )
-then
-   # Ok.
-   :
-else
-   as_fn_error "newly created file is older than distributed files!
-Check your system clock" "$LINENO" 5
-fi
-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: yes" >&5
-$as_echo "yes" >&6; }
-test "$program_prefix" != NONE &&
-  program_transform_name="s&^&$program_prefix&;$program_transform_name"
-# Use a double $ so make ignores it.
-test "$program_suffix" != NONE &&
-  program_transform_name="s&\$&$program_suffix&;$program_transform_name"
-# Double any \ or $.
-# By default was `s,x,x', remove it if useless.
-ac_script='s/[\\$]/&&/g;s/;s,x,x,$//'
-program_transform_name=`$as_echo "$program_transform_name" | sed "$ac_script"`
-
-# expand $ac_aux_dir to an absolute path
-am_aux_dir=`cd $ac_aux_dir && pwd`
-
-if test x"${MISSING+set}" != xset; then
-  case $am_aux_dir in
-  *\ * | *\	*)
-    MISSING="\${SHELL} \"$am_aux_dir/missing\"" ;;
-  *)
-    MISSING="\${SHELL} $am_aux_dir/missing" ;;
-  esac
-fi
-# Use eval to expand $SHELL
-if eval "$MISSING --run true"; then
-  am_missing_run="$MISSING --run "
-else
-  am_missing_run=
-  { $as_echo "$as_me:${as_lineno-$LINENO}: WARNING: \`missing' script is too old or missing" >&5
-$as_echo "$as_me: WARNING: \`missing' script is too old or missing" >&2;}
-fi
-
-if test x"${install_sh}" != xset; then
-  case $am_aux_dir in
-  *\ * | *\	*)
-    install_sh="\${SHELL} '$am_aux_dir/install-sh'" ;;
-  *)
-    install_sh="\${SHELL} $am_aux_dir/install-sh"
-  esac
-fi
-
-# Installed binaries are usually stripped using `strip' when the user
-# run `make install-strip'.  However `strip' might not be the right
-# tool to use in cross-compilation environments, therefore Automake
-# will honor the `STRIP' environment variable to overrule this program.
-if test "$cross_compiling" != no; then
-  if test -n "$ac_tool_prefix"; then
-  # Extract the first word of "${ac_tool_prefix}strip", so it can be a program name with args.
-set dummy ${ac_tool_prefix}strip; ac_word=$2
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for $ac_word" >&5
-$as_echo_n "checking for $ac_word... " >&6; }
-if test "${ac_cv_prog_STRIP+set}" = set; then :
-  $as_echo_n "(cached) " >&6
-else
-  if test -n "$STRIP"; then
-  ac_cv_prog_STRIP="$STRIP" # Let the user override the test.
-else
-as_save_IFS=$IFS; IFS=$PATH_SEPARATOR
-for as_dir in $PATH
-do
-  IFS=$as_save_IFS
-  test -z "$as_dir" && as_dir=.
-    for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
-    ac_cv_prog_STRIP="${ac_tool_prefix}strip"
-    $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
-    break 2
-  fi
-done
-  done
-IFS=$as_save_IFS
-
-fi
-fi
-STRIP=$ac_cv_prog_STRIP
-if test -n "$STRIP"; then
-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: $STRIP" >&5
-$as_echo "$STRIP" >&6; }
-else
-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
-$as_echo "no" >&6; }
-fi
-
-
-fi
-if test -z "$ac_cv_prog_STRIP"; then
-  ac_ct_STRIP=$STRIP
-  # Extract the first word of "strip", so it can be a program name with args.
-set dummy strip; ac_word=$2
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for $ac_word" >&5
-$as_echo_n "checking for $ac_word... " >&6; }
-if test "${ac_cv_prog_ac_ct_STRIP+set}" = set; then :
-  $as_echo_n "(cached) " >&6
-else
-  if test -n "$ac_ct_STRIP"; then
-  ac_cv_prog_ac_ct_STRIP="$ac_ct_STRIP" # Let the user override the test.
-else
-as_save_IFS=$IFS; IFS=$PATH_SEPARATOR
-for as_dir in $PATH
-do
-  IFS=$as_save_IFS
-  test -z "$as_dir" && as_dir=.
-    for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
-    ac_cv_prog_ac_ct_STRIP="strip"
-    $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
-    break 2
-  fi
-done
-  done
-IFS=$as_save_IFS
-
-fi
-fi
-ac_ct_STRIP=$ac_cv_prog_ac_ct_STRIP
-if test -n "$ac_ct_STRIP"; then
-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_ct_STRIP" >&5
-$as_echo "$ac_ct_STRIP" >&6; }
-else
-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
-$as_echo "no" >&6; }
-fi
-
-  if test "x$ac_ct_STRIP" = x; then
-    STRIP=":"
-  else
-    case $cross_compiling:$ac_tool_warned in
-yes:)
-{ $as_echo "$as_me:${as_lineno-$LINENO}: WARNING: using cross tools not prefixed with host triplet" >&5
-$as_echo "$as_me: WARNING: using cross tools not prefixed with host triplet" >&2;}
-ac_tool_warned=yes ;;
-esac
-    STRIP=$ac_ct_STRIP
-  fi
-else
-  STRIP="$ac_cv_prog_STRIP"
-fi
-
-fi
-INSTALL_STRIP_PROGRAM="\$(install_sh) -c -s"
-
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for a thread-safe mkdir -p" >&5
-$as_echo_n "checking for a thread-safe mkdir -p... " >&6; }
-if test -z "$MKDIR_P"; then
-  if test "${ac_cv_path_mkdir+set}" = set; then :
-  $as_echo_n "(cached) " >&6
-else
-  as_save_IFS=$IFS; IFS=$PATH_SEPARATOR
-for as_dir in $PATH$PATH_SEPARATOR/opt/sfw/bin
-do
-  IFS=$as_save_IFS
-  test -z "$as_dir" && as_dir=.
-    for ac_prog in mkdir gmkdir; do
-	 for ac_exec_ext in '' $ac_executable_extensions; do
-	   { test -f "$as_dir/$ac_prog$ac_exec_ext" && $as_test_x "$as_dir/$ac_prog$ac_exec_ext"; } || continue
-	   case `"$as_dir/$ac_prog$ac_exec_ext" --version 2>&1` in #(
-	     'mkdir (GNU coreutils) '* | \
-	     'mkdir (coreutils) '* | \
-	     'mkdir (fileutils) '4.1*)
-	       ac_cv_path_mkdir=$as_dir/$ac_prog$ac_exec_ext
-	       break 3;;
-	   esac
-	 done
-       done
-  done
-IFS=$as_save_IFS
-
-fi
-
-  test -d ./--version && rmdir ./--version
-  if test "${ac_cv_path_mkdir+set}" = set; then
-    MKDIR_P="$ac_cv_path_mkdir -p"
-  else
-    # As a last resort, use the slow shell script.  Don't cache a
-    # value for MKDIR_P within a source directory, because that will
-    # break other packages using the cache if that directory is
-    # removed, or if the value is a relative name.
-    MKDIR_P="$ac_install_sh -d"
-  fi
-fi
-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $MKDIR_P" >&5
-$as_echo "$MKDIR_P" >&6; }
-
-mkdir_p="$MKDIR_P"
-case $mkdir_p in
-  [\\/$]* | ?:[\\/]*) ;;
-  */*) mkdir_p="\$(top_builddir)/$mkdir_p" ;;
-esac
-
-for ac_prog in gawk mawk nawk awk
-do
-  # Extract the first word of "$ac_prog", so it can be a program name with args.
-set dummy $ac_prog; ac_word=$2
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for $ac_word" >&5
-$as_echo_n "checking for $ac_word... " >&6; }
-if test "${ac_cv_prog_AWK+set}" = set; then :
-  $as_echo_n "(cached) " >&6
-else
-  if test -n "$AWK"; then
-  ac_cv_prog_AWK="$AWK" # Let the user override the test.
-else
-as_save_IFS=$IFS; IFS=$PATH_SEPARATOR
-for as_dir in $PATH
-do
-  IFS=$as_save_IFS
-  test -z "$as_dir" && as_dir=.
-    for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
-    ac_cv_prog_AWK="$ac_prog"
-    $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
-    break 2
-  fi
-done
-  done
-IFS=$as_save_IFS
-
-fi
-fi
-AWK=$ac_cv_prog_AWK
-if test -n "$AWK"; then
-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: $AWK" >&5
-$as_echo "$AWK" >&6; }
-else
-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
-$as_echo "no" >&6; }
-fi
-
-
-  test -n "$AWK" && break
-done
-
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking whether ${MAKE-make} sets \$(MAKE)" >&5
-$as_echo_n "checking whether ${MAKE-make} sets \$(MAKE)... " >&6; }
-set x ${MAKE-make}
-ac_make=`$as_echo "$2" | sed 's/+/p/g; s/[^a-zA-Z0-9_]/_/g'`
-if { as_var=ac_cv_prog_make_${ac_make}_set; eval "test \"\${$as_var+set}\" = set"; }; then :
-  $as_echo_n "(cached) " >&6
-else
-  cat >conftest.make <<\_ACEOF
-SHELL = /bin/sh
-all:
-	@echo '@@@%%%=$(MAKE)=@@@%%%'
-_ACEOF
-# GNU make sometimes prints "make[1]: Entering...", which would confuse us.
-case `${MAKE-make} -f conftest.make 2>/dev/null` in
-  *@@@%%%=?*=@@@%%%*)
-    eval ac_cv_prog_make_${ac_make}_set=yes;;
-  *)
-    eval ac_cv_prog_make_${ac_make}_set=no;;
-esac
-rm -f conftest.make
-fi
-if eval test \$ac_cv_prog_make_${ac_make}_set = yes; then
-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: yes" >&5
-$as_echo "yes" >&6; }
-  SET_MAKE=
-else
-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
-$as_echo "no" >&6; }
-  SET_MAKE="MAKE=${MAKE-make}"
-fi
-
-rm -rf .tst 2>/dev/null
-mkdir .tst 2>/dev/null
-if test -d .tst; then
-  am__leading_dot=.
-else
-  am__leading_dot=_
-fi
-rmdir .tst 2>/dev/null
-
-if test "`cd $srcdir && pwd`" != "`pwd`"; then
-  # Use -I$(srcdir) only when $(srcdir) != ., so that make's output
-  # is not polluted with repeated "-I."
-  am__isrc=' -I$(srcdir)'
-  # test to see if srcdir already configured
-  if test -f $srcdir/config.status; then
-    as_fn_error "source directory already configured; run \"make distclean\" there first" "$LINENO" 5
-  fi
-fi
-
-# test whether we have cygpath
-if test -z "$CYGPATH_W"; then
-  if (cygpath --version) >/dev/null 2>/dev/null; then
-    CYGPATH_W='cygpath -w'
-  else
-    CYGPATH_W=echo
-  fi
-fi
-
-
-# Define the identity of the package.
- PACKAGE='dosbox'
- VERSION='0.74'
-
-
-cat >>confdefs.h <<_ACEOF
-#define PACKAGE "$PACKAGE"
-_ACEOF
-
-
-cat >>confdefs.h <<_ACEOF
-#define VERSION "$VERSION"
-_ACEOF
-
-# Some tools Automake needs.
-
-ACLOCAL=${ACLOCAL-"${am_missing_run}aclocal-${am__api_version}"}
-
-
-AUTOCONF=${AUTOCONF-"${am_missing_run}autoconf"}
-
-
-AUTOMAKE=${AUTOMAKE-"${am_missing_run}automake-${am__api_version}"}
-
-
-AUTOHEADER=${AUTOHEADER-"${am_missing_run}autoheader"}
-
-
-MAKEINFO=${MAKEINFO-"${am_missing_run}makeinfo"}
-
-# We need awk for the "check" target.  The system "awk" is bad on
-# some platforms.
-# Always define AMTAR for backward compatibility.
-
-AMTAR=${AMTAR-"${am_missing_run}tar"}
-
-am__tar='${AMTAR} chof - "$$tardir"'; am__untar='${AMTAR} xf -'
-
-
-
-
-
-ac_config_headers="$ac_config_headers config.h"
-
-
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking whether ${MAKE-make} sets \$(MAKE)" >&5
-$as_echo_n "checking whether ${MAKE-make} sets \$(MAKE)... " >&6; }
-set x ${MAKE-make}
-ac_make=`$as_echo "$2" | sed 's/+/p/g; s/[^a-zA-Z0-9_]/_/g'`
-if { as_var=ac_cv_prog_make_${ac_make}_set; eval "test \"\${$as_var+set}\" = set"; }; then :
-  $as_echo_n "(cached) " >&6
-else
-  cat >conftest.make <<\_ACEOF
-SHELL = /bin/sh
-all:
-	@echo '@@@%%%=$(MAKE)=@@@%%%'
-_ACEOF
-# GNU make sometimes prints "make[1]: Entering...", which would confuse us.
-case `${MAKE-make} -f conftest.make 2>/dev/null` in
-  *@@@%%%=?*=@@@%%%*)
-    eval ac_cv_prog_make_${ac_make}_set=yes;;
-  *)
-    eval ac_cv_prog_make_${ac_make}_set=no;;
-esac
-rm -f conftest.make
-fi
-if eval test \$ac_cv_prog_make_${ac_make}_set = yes; then
-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: yes" >&5
-$as_echo "yes" >&6; }
-  SET_MAKE=
-else
-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
-$as_echo "no" >&6; }
-  SET_MAKE="MAKE=${MAKE-make}"
-fi
-
-ac_ext=c
-ac_cpp='$CPP $CPPFLAGS'
-ac_compile='$CC -c $CFLAGS $CPPFLAGS conftest.$ac_ext >&5'
-ac_link='$CC -o conftest$ac_exeext $CFLAGS $CPPFLAGS $LDFLAGS conftest.$ac_ext $LIBS >&5'
-ac_compiler_gnu=$ac_cv_c_compiler_gnu
-if test -n "$ac_tool_prefix"; then
-  # Extract the first word of "${ac_tool_prefix}gcc", so it can be a program name with args.
-set dummy ${ac_tool_prefix}gcc; ac_word=$2
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for $ac_word" >&5
-$as_echo_n "checking for $ac_word... " >&6; }
-if test "${ac_cv_prog_CC+set}" = set; then :
-  $as_echo_n "(cached) " >&6
-else
-  if test -n "$CC"; then
-  ac_cv_prog_CC="$CC" # Let the user override the test.
-else
-as_save_IFS=$IFS; IFS=$PATH_SEPARATOR
-for as_dir in $PATH
-do
-  IFS=$as_save_IFS
-  test -z "$as_dir" && as_dir=.
-    for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
-    ac_cv_prog_CC="${ac_tool_prefix}gcc"
-    $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
-    break 2
-  fi
-done
-  done
-IFS=$as_save_IFS
-
-fi
-fi
-CC=$ac_cv_prog_CC
-if test -n "$CC"; then
-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: $CC" >&5
-$as_echo "$CC" >&6; }
-else
-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
-$as_echo "no" >&6; }
-fi
-
-
-fi
-if test -z "$ac_cv_prog_CC"; then
-  ac_ct_CC=$CC
-  # Extract the first word of "gcc", so it can be a program name with args.
-set dummy gcc; ac_word=$2
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for $ac_word" >&5
-$as_echo_n "checking for $ac_word... " >&6; }
-if test "${ac_cv_prog_ac_ct_CC+set}" = set; then :
-  $as_echo_n "(cached) " >&6
-else
-  if test -n "$ac_ct_CC"; then
-  ac_cv_prog_ac_ct_CC="$ac_ct_CC" # Let the user override the test.
-else
-as_save_IFS=$IFS; IFS=$PATH_SEPARATOR
-for as_dir in $PATH
-do
-  IFS=$as_save_IFS
-  test -z "$as_dir" && as_dir=.
-    for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
-    ac_cv_prog_ac_ct_CC="gcc"
-    $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
-    break 2
-  fi
-done
-  done
-IFS=$as_save_IFS
-
-fi
-fi
-ac_ct_CC=$ac_cv_prog_ac_ct_CC
-if test -n "$ac_ct_CC"; then
-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_ct_CC" >&5
-$as_echo "$ac_ct_CC" >&6; }
-else
-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
-$as_echo "no" >&6; }
-fi
-
-  if test "x$ac_ct_CC" = x; then
-    CC=""
-  else
-    case $cross_compiling:$ac_tool_warned in
-yes:)
-{ $as_echo "$as_me:${as_lineno-$LINENO}: WARNING: using cross tools not prefixed with host triplet" >&5
-$as_echo "$as_me: WARNING: using cross tools not prefixed with host triplet" >&2;}
-ac_tool_warned=yes ;;
-esac
-    CC=$ac_ct_CC
-  fi
-else
-  CC="$ac_cv_prog_CC"
-fi
-
-if test -z "$CC"; then
-          if test -n "$ac_tool_prefix"; then
-    # Extract the first word of "${ac_tool_prefix}cc", so it can be a program name with args.
-set dummy ${ac_tool_prefix}cc; ac_word=$2
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for $ac_word" >&5
-$as_echo_n "checking for $ac_word... " >&6; }
-if test "${ac_cv_prog_CC+set}" = set; then :
-  $as_echo_n "(cached) " >&6
-else
-  if test -n "$CC"; then
-  ac_cv_prog_CC="$CC" # Let the user override the test.
-else
-as_save_IFS=$IFS; IFS=$PATH_SEPARATOR
-for as_dir in $PATH
-do
-  IFS=$as_save_IFS
-  test -z "$as_dir" && as_dir=.
-    for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
-    ac_cv_prog_CC="${ac_tool_prefix}cc"
-    $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
-    break 2
-  fi
-done
-  done
-IFS=$as_save_IFS
-
-fi
-fi
-CC=$ac_cv_prog_CC
-if test -n "$CC"; then
-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: $CC" >&5
-$as_echo "$CC" >&6; }
-else
-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
-$as_echo "no" >&6; }
-fi
-
-
-  fi
-fi
-if test -z "$CC"; then
-  # Extract the first word of "cc", so it can be a program name with args.
-set dummy cc; ac_word=$2
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for $ac_word" >&5
-$as_echo_n "checking for $ac_word... " >&6; }
-if test "${ac_cv_prog_CC+set}" = set; then :
-  $as_echo_n "(cached) " >&6
-else
-  if test -n "$CC"; then
-  ac_cv_prog_CC="$CC" # Let the user override the test.
-else
-  ac_prog_rejected=no
-as_save_IFS=$IFS; IFS=$PATH_SEPARATOR
-for as_dir in $PATH
-do
-  IFS=$as_save_IFS
-  test -z "$as_dir" && as_dir=.
-    for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
-    if test "$as_dir/$ac_word$ac_exec_ext" = "/usr/ucb/cc"; then
-       ac_prog_rejected=yes
-       continue
-     fi
-    ac_cv_prog_CC="cc"
-    $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
-    break 2
-  fi
-done
-  done
-IFS=$as_save_IFS
-
-if test $ac_prog_rejected = yes; then
-  # We found a bogon in the path, so make sure we never use it.
-  set dummy $ac_cv_prog_CC
-  shift
-  if test $# != 0; then
-    # We chose a different compiler from the bogus one.
-    # However, it has the same basename, so the bogon will be chosen
-    # first if we set CC to just the basename; use the full file name.
-    shift
-    ac_cv_prog_CC="$as_dir/$ac_word${1+' '}$@"
-  fi
-fi
-fi
-fi
-CC=$ac_cv_prog_CC
-if test -n "$CC"; then
-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: $CC" >&5
-$as_echo "$CC" >&6; }
-else
-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
-$as_echo "no" >&6; }
-fi
-
-
-fi
-if test -z "$CC"; then
-  if test -n "$ac_tool_prefix"; then
-  for ac_prog in cl.exe
-  do
-    # Extract the first word of "$ac_tool_prefix$ac_prog", so it can be a program name with args.
-set dummy $ac_tool_prefix$ac_prog; ac_word=$2
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for $ac_word" >&5
-$as_echo_n "checking for $ac_word... " >&6; }
-if test "${ac_cv_prog_CC+set}" = set; then :
-  $as_echo_n "(cached) " >&6
-else
-  if test -n "$CC"; then
-  ac_cv_prog_CC="$CC" # Let the user override the test.
-else
-as_save_IFS=$IFS; IFS=$PATH_SEPARATOR
-for as_dir in $PATH
-do
-  IFS=$as_save_IFS
-  test -z "$as_dir" && as_dir=.
-    for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
-    ac_cv_prog_CC="$ac_tool_prefix$ac_prog"
-    $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
-    break 2
-  fi
-done
-  done
-IFS=$as_save_IFS
-
-fi
-fi
-CC=$ac_cv_prog_CC
-if test -n "$CC"; then
-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: $CC" >&5
-$as_echo "$CC" >&6; }
-else
-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
-$as_echo "no" >&6; }
-fi
-
-
-    test -n "$CC" && break
-  done
-fi
-if test -z "$CC"; then
-  ac_ct_CC=$CC
-  for ac_prog in cl.exe
-do
-  # Extract the first word of "$ac_prog", so it can be a program name with args.
-set dummy $ac_prog; ac_word=$2
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for $ac_word" >&5
-$as_echo_n "checking for $ac_word... " >&6; }
-if test "${ac_cv_prog_ac_ct_CC+set}" = set; then :
-  $as_echo_n "(cached) " >&6
-else
-  if test -n "$ac_ct_CC"; then
-  ac_cv_prog_ac_ct_CC="$ac_ct_CC" # Let the user override the test.
-else
-as_save_IFS=$IFS; IFS=$PATH_SEPARATOR
-for as_dir in $PATH
-do
-  IFS=$as_save_IFS
-  test -z "$as_dir" && as_dir=.
-    for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
-    ac_cv_prog_ac_ct_CC="$ac_prog"
-    $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
-    break 2
-  fi
-done
-  done
-IFS=$as_save_IFS
-
-fi
-fi
-ac_ct_CC=$ac_cv_prog_ac_ct_CC
-if test -n "$ac_ct_CC"; then
-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_ct_CC" >&5
-$as_echo "$ac_ct_CC" >&6; }
-else
-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
-$as_echo "no" >&6; }
-fi
-
-
-  test -n "$ac_ct_CC" && break
-done
-
-  if test "x$ac_ct_CC" = x; then
-    CC=""
-  else
-    case $cross_compiling:$ac_tool_warned in
-yes:)
-{ $as_echo "$as_me:${as_lineno-$LINENO}: WARNING: using cross tools not prefixed with host triplet" >&5
-$as_echo "$as_me: WARNING: using cross tools not prefixed with host triplet" >&2;}
-ac_tool_warned=yes ;;
-esac
-    CC=$ac_ct_CC
-  fi
-fi
-
-fi
-
-
-test -z "$CC" && { { $as_echo "$as_me:${as_lineno-$LINENO}: error: in \`$ac_pwd':" >&5
-$as_echo "$as_me: error: in \`$ac_pwd':" >&2;}
-as_fn_error "no acceptable C compiler found in \$PATH
-See \`config.log' for more details." "$LINENO" 5; }
-
-# Provide some information about the compiler.
-$as_echo "$as_me:${as_lineno-$LINENO}: checking for C compiler version" >&5
-set X $ac_compile
-ac_compiler=$2
-for ac_option in --version -v -V -qversion; do
-  { { ac_try="$ac_compiler $ac_option >&5"
-case "(($ac_try" in
-  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
-  *) ac_try_echo=$ac_try;;
-esac
-eval ac_try_echo="\"\$as_me:${as_lineno-$LINENO}: $ac_try_echo\""
-$as_echo "$ac_try_echo"; } >&5
-  (eval "$ac_compiler $ac_option >&5") 2>conftest.err
-  ac_status=$?
-  if test -s conftest.err; then
-    sed '10a\
-... rest of stderr output deleted ...
-         10q' conftest.err >conftest.er1
-    cat conftest.er1 >&5
-  fi
-  rm -f conftest.er1 conftest.err
-  $as_echo "$as_me:${as_lineno-$LINENO}: \$? = $ac_status" >&5
-  test $ac_status = 0; }
-done
-
-cat confdefs.h - <<_ACEOF >conftest.$ac_ext
-/* end confdefs.h.  */
-
-int
-main ()
-{
-
-  ;
-  return 0;
-}
-_ACEOF
-ac_clean_files_save=$ac_clean_files
-ac_clean_files="$ac_clean_files a.out a.out.dSYM a.exe b.out"
-# Try to create an executable without -o first, disregard a.out.
-# It will help us diagnose broken compilers, and finding out an intuition
-# of exeext.
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking whether the C compiler works" >&5
-$as_echo_n "checking whether the C compiler works... " >&6; }
-ac_link_default=`$as_echo "$ac_link" | sed 's/ -o *conftest[^ ]*//'`
-
-# The possible output files:
-ac_files="a.out conftest.exe conftest a.exe a_out.exe b.out conftest.*"
-
-ac_rmfiles=
-for ac_file in $ac_files
-do
-  case $ac_file in
-    *.$ac_ext | *.xcoff | *.tds | *.d | *.pdb | *.xSYM | *.bb | *.bbg | *.map | *.inf | *.dSYM | *.o | *.obj ) ;;
-    * ) ac_rmfiles="$ac_rmfiles $ac_file";;
-  esac
-done
-rm -f $ac_rmfiles
-
-if { { ac_try="$ac_link_default"
-case "(($ac_try" in
-  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
-  *) ac_try_echo=$ac_try;;
-esac
-eval ac_try_echo="\"\$as_me:${as_lineno-$LINENO}: $ac_try_echo\""
-$as_echo "$ac_try_echo"; } >&5
-  (eval "$ac_link_default") 2>&5
-  ac_status=$?
-  $as_echo "$as_me:${as_lineno-$LINENO}: \$? = $ac_status" >&5
-  test $ac_status = 0; }; then :
-  # Autoconf-2.13 could set the ac_cv_exeext variable to `no'.
-# So ignore a value of `no', otherwise this would lead to `EXEEXT = no'
-# in a Makefile.  We should not override ac_cv_exeext if it was cached,
-# so that the user can short-circuit this test for compilers unknown to
-# Autoconf.
-for ac_file in $ac_files ''
-do
-  test -f "$ac_file" || continue
-  case $ac_file in
-    *.$ac_ext | *.xcoff | *.tds | *.d | *.pdb | *.xSYM | *.bb | *.bbg | *.map | *.inf | *.dSYM | *.o | *.obj )
-	;;
-    [ab].out )
-	# We found the default executable, but exeext='' is most
-	# certainly right.
-	break;;
-    *.* )
-	if test "${ac_cv_exeext+set}" = set && test "$ac_cv_exeext" != no;
-	then :; else
-	   ac_cv_exeext=`expr "$ac_file" : '[^.]*\(\..*\)'`
-	fi
-	# We set ac_cv_exeext here because the later test for it is not
-	# safe: cross compilers may not add the suffix if given an `-o'
-	# argument, so we may need to know it at that point already.
-	# Even if this section looks crufty: it has the advantage of
-	# actually working.
-	break;;
-    * )
-	break;;
-  esac
-done
-test "$ac_cv_exeext" = no && ac_cv_exeext=
-
-else
-  ac_file=''
-fi
-if test -z "$ac_file"; then :
-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
-$as_echo "no" >&6; }
-$as_echo "$as_me: failed program was:" >&5
-sed 's/^/| /' conftest.$ac_ext >&5
-
-{ { $as_echo "$as_me:${as_lineno-$LINENO}: error: in \`$ac_pwd':" >&5
-$as_echo "$as_me: error: in \`$ac_pwd':" >&2;}
-{ as_fn_set_status 77
-as_fn_error "C compiler cannot create executables
-See \`config.log' for more details." "$LINENO" 5; }; }
-else
-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: yes" >&5
-$as_echo "yes" >&6; }
-fi
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for C compiler default output file name" >&5
-$as_echo_n "checking for C compiler default output file name... " >&6; }
-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_file" >&5
-$as_echo "$ac_file" >&6; }
-ac_exeext=$ac_cv_exeext
-
-rm -f -r a.out a.out.dSYM a.exe conftest$ac_cv_exeext b.out
-ac_clean_files=$ac_clean_files_save
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for suffix of executables" >&5
-$as_echo_n "checking for suffix of executables... " >&6; }
-if { { ac_try="$ac_link"
-case "(($ac_try" in
-  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
-  *) ac_try_echo=$ac_try;;
-esac
-eval ac_try_echo="\"\$as_me:${as_lineno-$LINENO}: $ac_try_echo\""
-$as_echo "$ac_try_echo"; } >&5
-  (eval "$ac_link") 2>&5
-  ac_status=$?
-  $as_echo "$as_me:${as_lineno-$LINENO}: \$? = $ac_status" >&5
-  test $ac_status = 0; }; then :
-  # If both `conftest.exe' and `conftest' are `present' (well, observable)
-# catch `conftest.exe'.  For instance with Cygwin, `ls conftest' will
-# work properly (i.e., refer to `conftest.exe'), while it won't with
-# `rm'.
-for ac_file in conftest.exe conftest conftest.*; do
-  test -f "$ac_file" || continue
-  case $ac_file in
-    *.$ac_ext | *.xcoff | *.tds | *.d | *.pdb | *.xSYM | *.bb | *.bbg | *.map | *.inf | *.dSYM | *.o | *.obj ) ;;
-    *.* ) ac_cv_exeext=`expr "$ac_file" : '[^.]*\(\..*\)'`
-	  break;;
-    * ) break;;
-  esac
-done
-else
-  { { $as_echo "$as_me:${as_lineno-$LINENO}: error: in \`$ac_pwd':" >&5
-$as_echo "$as_me: error: in \`$ac_pwd':" >&2;}
-as_fn_error "cannot compute suffix of executables: cannot compile and link
-See \`config.log' for more details." "$LINENO" 5; }
-fi
-rm -f conftest conftest$ac_cv_exeext
-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_exeext" >&5
-$as_echo "$ac_cv_exeext" >&6; }
-
-rm -f conftest.$ac_ext
-EXEEXT=$ac_cv_exeext
-ac_exeext=$EXEEXT
-cat confdefs.h - <<_ACEOF >conftest.$ac_ext
-/* end confdefs.h.  */
-#include <stdio.h>
-int
-main ()
-{
-FILE *f = fopen ("conftest.out", "w");
- return ferror (f) || fclose (f) != 0;
-
-  ;
-  return 0;
-}
-_ACEOF
-ac_clean_files="$ac_clean_files conftest.out"
-# Check that the compiler produces executables we can run.  If not, either
-# the compiler is broken, or we cross compile.
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking whether we are cross compiling" >&5
-$as_echo_n "checking whether we are cross compiling... " >&6; }
-if test "$cross_compiling" != yes; then
-  { { ac_try="$ac_link"
-case "(($ac_try" in
-  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
-  *) ac_try_echo=$ac_try;;
-esac
-eval ac_try_echo="\"\$as_me:${as_lineno-$LINENO}: $ac_try_echo\""
-$as_echo "$ac_try_echo"; } >&5
-  (eval "$ac_link") 2>&5
-  ac_status=$?
-  $as_echo "$as_me:${as_lineno-$LINENO}: \$? = $ac_status" >&5
-  test $ac_status = 0; }
-  if { ac_try='./conftest$ac_cv_exeext'
-  { { case "(($ac_try" in
-  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
-  *) ac_try_echo=$ac_try;;
-esac
-eval ac_try_echo="\"\$as_me:${as_lineno-$LINENO}: $ac_try_echo\""
-$as_echo "$ac_try_echo"; } >&5
-  (eval "$ac_try") 2>&5
-  ac_status=$?
-  $as_echo "$as_me:${as_lineno-$LINENO}: \$? = $ac_status" >&5
-  test $ac_status = 0; }; }; then
-    cross_compiling=no
-  else
-    if test "$cross_compiling" = maybe; then
-	cross_compiling=yes
-    else
-	{ { $as_echo "$as_me:${as_lineno-$LINENO}: error: in \`$ac_pwd':" >&5
-$as_echo "$as_me: error: in \`$ac_pwd':" >&2;}
-as_fn_error "cannot run C compiled programs.
-If you meant to cross compile, use \`--host'.
-See \`config.log' for more details." "$LINENO" 5; }
-    fi
-  fi
-fi
-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $cross_compiling" >&5
-$as_echo "$cross_compiling" >&6; }
-
-rm -f conftest.$ac_ext conftest$ac_cv_exeext conftest.out
-ac_clean_files=$ac_clean_files_save
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for suffix of object files" >&5
-$as_echo_n "checking for suffix of object files... " >&6; }
-if test "${ac_cv_objext+set}" = set; then :
-  $as_echo_n "(cached) " >&6
-else
-  cat confdefs.h - <<_ACEOF >conftest.$ac_ext
-/* end confdefs.h.  */
-
-int
-main ()
-{
-
-  ;
-  return 0;
-}
-_ACEOF
-rm -f conftest.o conftest.obj
-if { { ac_try="$ac_compile"
-case "(($ac_try" in
-  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
-  *) ac_try_echo=$ac_try;;
-esac
-eval ac_try_echo="\"\$as_me:${as_lineno-$LINENO}: $ac_try_echo\""
-$as_echo "$ac_try_echo"; } >&5
-  (eval "$ac_compile") 2>&5
-  ac_status=$?
-  $as_echo "$as_me:${as_lineno-$LINENO}: \$? = $ac_status" >&5
-  test $ac_status = 0; }; then :
-  for ac_file in conftest.o conftest.obj conftest.*; do
-  test -f "$ac_file" || continue;
-  case $ac_file in
-    *.$ac_ext | *.xcoff | *.tds | *.d | *.pdb | *.xSYM | *.bb | *.bbg | *.map | *.inf | *.dSYM ) ;;
-    *) ac_cv_objext=`expr "$ac_file" : '.*\.\(.*\)'`
-       break;;
-  esac
-done
-else
-  $as_echo "$as_me: failed program was:" >&5
-sed 's/^/| /' conftest.$ac_ext >&5
-
-{ { $as_echo "$as_me:${as_lineno-$LINENO}: error: in \`$ac_pwd':" >&5
-$as_echo "$as_me: error: in \`$ac_pwd':" >&2;}
-as_fn_error "cannot compute suffix of object files: cannot compile
-See \`config.log' for more details." "$LINENO" 5; }
-fi
-rm -f conftest.$ac_cv_objext conftest.$ac_ext
-fi
-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_objext" >&5
-$as_echo "$ac_cv_objext" >&6; }
-OBJEXT=$ac_cv_objext
-ac_objext=$OBJEXT
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking whether we are using the GNU C compiler" >&5
-$as_echo_n "checking whether we are using the GNU C compiler... " >&6; }
-if test "${ac_cv_c_compiler_gnu+set}" = set; then :
-  $as_echo_n "(cached) " >&6
-else
-  cat confdefs.h - <<_ACEOF >conftest.$ac_ext
-/* end confdefs.h.  */
-
-int
-main ()
-{
-#ifndef __GNUC__
-       choke me
-#endif
-
-  ;
-  return 0;
-}
-_ACEOF
-if ac_fn_c_try_compile "$LINENO"; then :
-  ac_compiler_gnu=yes
-else
-  ac_compiler_gnu=no
-fi
-rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
-ac_cv_c_compiler_gnu=$ac_compiler_gnu
-
-fi
-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_c_compiler_gnu" >&5
-$as_echo "$ac_cv_c_compiler_gnu" >&6; }
-if test $ac_compiler_gnu = yes; then
-  GCC=yes
-else
-  GCC=
-fi
-ac_test_CFLAGS=${CFLAGS+set}
-ac_save_CFLAGS=$CFLAGS
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking whether $CC accepts -g" >&5
-$as_echo_n "checking whether $CC accepts -g... " >&6; }
-if test "${ac_cv_prog_cc_g+set}" = set; then :
-  $as_echo_n "(cached) " >&6
-else
-  ac_save_c_werror_flag=$ac_c_werror_flag
-   ac_c_werror_flag=yes
-   ac_cv_prog_cc_g=no
-   CFLAGS="-g"
-   cat confdefs.h - <<_ACEOF >conftest.$ac_ext
-/* end confdefs.h.  */
-
-int
-main ()
-{
-
-  ;
-  return 0;
-}
-_ACEOF
-if ac_fn_c_try_compile "$LINENO"; then :
-  ac_cv_prog_cc_g=yes
-else
-  CFLAGS=""
-      cat confdefs.h - <<_ACEOF >conftest.$ac_ext
-/* end confdefs.h.  */
-
-int
-main ()
-{
-
-  ;
-  return 0;
-}
-_ACEOF
-if ac_fn_c_try_compile "$LINENO"; then :
-
-else
-  ac_c_werror_flag=$ac_save_c_werror_flag
-	 CFLAGS="-g"
-	 cat confdefs.h - <<_ACEOF >conftest.$ac_ext
-/* end confdefs.h.  */
-
-int
-main ()
-{
-
-  ;
-  return 0;
-}
-_ACEOF
-if ac_fn_c_try_compile "$LINENO"; then :
-  ac_cv_prog_cc_g=yes
-fi
-rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
-fi
-rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
-fi
-rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
-   ac_c_werror_flag=$ac_save_c_werror_flag
-fi
-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_prog_cc_g" >&5
-$as_echo "$ac_cv_prog_cc_g" >&6; }
-if test "$ac_test_CFLAGS" = set; then
-  CFLAGS=$ac_save_CFLAGS
-elif test $ac_cv_prog_cc_g = yes; then
-  if test "$GCC" = yes; then
-    CFLAGS="-g -O2"
-  else
-    CFLAGS="-g"
-  fi
-else
-  if test "$GCC" = yes; then
-    CFLAGS="-O2"
-  else
-    CFLAGS=
-  fi
-fi
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for $CC option to accept ISO C89" >&5
-$as_echo_n "checking for $CC option to accept ISO C89... " >&6; }
-if test "${ac_cv_prog_cc_c89+set}" = set; then :
-  $as_echo_n "(cached) " >&6
-else
-  ac_cv_prog_cc_c89=no
-ac_save_CC=$CC
-cat confdefs.h - <<_ACEOF >conftest.$ac_ext
-/* end confdefs.h.  */
-#include <stdarg.h>
-#include <stdio.h>
-#include <sys/types.h>
-#include <sys/stat.h>
-/* Most of the following tests are stolen from RCS 5.7's src/conf.sh.  */
-struct buf { int x; };
-FILE * (*rcsopen) (struct buf *, struct stat *, int);
-static char *e (p, i)
-     char **p;
-     int i;
-{
-  return p[i];
-}
-static char *f (char * (*g) (char **, int), char **p, ...)
-{
-  char *s;
-  va_list v;
-  va_start (v,p);
-  s = g (p, va_arg (v,int));
-  va_end (v);
-  return s;
-}
-
-/* OSF 4.0 Compaq cc is some sort of almost-ANSI by default.  It has
-   function prototypes and stuff, but not '\xHH' hex character constants.
-   These don't provoke an error unfortunately, instead are silently treated
-   as 'x'.  The following induces an error, until -std is added to get
-   proper ANSI mode.  Curiously '\x00'!='x' always comes out true, for an
-   array size at least.  It's necessary to write '\x00'==0 to get something
-   that's true only with -std.  */
-int osf4_cc_array ['\x00' == 0 ? 1 : -1];
-
-/* IBM C 6 for AIX is almost-ANSI by default, but it replaces macro parameters
-   inside strings and character constants.  */
-#define FOO(x) 'x'
-int xlc6_cc_array[FOO(a) == 'x' ? 1 : -1];
-
-int test (int i, double x);
-struct s1 {int (*f) (int a);};
-struct s2 {int (*f) (double a);};
-int pairnames (int, char **, FILE *(*)(struct buf *, struct stat *, int), int, int);
-int argc;
-char **argv;
-int
-main ()
-{
-return f (e, argv, 0) != argv[0]  ||  f (e, argv, 1) != argv[1];
-  ;
-  return 0;
-}
-_ACEOF
-for ac_arg in '' -qlanglvl=extc89 -qlanglvl=ansi -std \
-	-Ae "-Aa -D_HPUX_SOURCE" "-Xc -D__EXTENSIONS__"
-do
-  CC="$ac_save_CC $ac_arg"
-  if ac_fn_c_try_compile "$LINENO"; then :
-  ac_cv_prog_cc_c89=$ac_arg
-fi
-rm -f core conftest.err conftest.$ac_objext
-  test "x$ac_cv_prog_cc_c89" != "xno" && break
-done
-rm -f conftest.$ac_ext
-CC=$ac_save_CC
-
-fi
-# AC_CACHE_VAL
-case "x$ac_cv_prog_cc_c89" in
-  x)
-    { $as_echo "$as_me:${as_lineno-$LINENO}: result: none needed" >&5
-$as_echo "none needed" >&6; } ;;
-  xno)
-    { $as_echo "$as_me:${as_lineno-$LINENO}: result: unsupported" >&5
-$as_echo "unsupported" >&6; } ;;
-  *)
-    CC="$CC $ac_cv_prog_cc_c89"
-    { $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_prog_cc_c89" >&5
-$as_echo "$ac_cv_prog_cc_c89" >&6; } ;;
-esac
-if test "x$ac_cv_prog_cc_c89" != xno; then :
-
-fi
-
-ac_ext=c
-ac_cpp='$CPP $CPPFLAGS'
-ac_compile='$CC -c $CFLAGS $CPPFLAGS conftest.$ac_ext >&5'
-ac_link='$CC -o conftest$ac_exeext $CFLAGS $CPPFLAGS $LDFLAGS conftest.$ac_ext $LIBS >&5'
-ac_compiler_gnu=$ac_cv_c_compiler_gnu
-DEPDIR="${am__leading_dot}deps"
-
-ac_config_commands="$ac_config_commands depfiles"
-
-
-am_make=${MAKE-make}
-cat > confinc << 'END'
-am__doit:
-	@echo this is the am__doit target
-.PHONY: am__doit
-END
-# If we don't find an include directive, just comment out the code.
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for style of include used by $am_make" >&5
-$as_echo_n "checking for style of include used by $am_make... " >&6; }
-am__include="#"
-am__quote=
-_am_result=none
-# First try GNU make style include.
-echo "include confinc" > confmf
-# Ignore all kinds of additional output from `make'.
-case `$am_make -s -f confmf 2> /dev/null` in #(
-*the\ am__doit\ target*)
-  am__include=include
-  am__quote=
-  _am_result=GNU
-  ;;
-esac
-# Now try BSD make style include.
-if test "$am__include" = "#"; then
-   echo '.include "confinc"' > confmf
-   case `$am_make -s -f confmf 2> /dev/null` in #(
-   *the\ am__doit\ target*)
-     am__include=.include
-     am__quote="\""
-     _am_result=BSD
-     ;;
-   esac
-fi
-
-
-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $_am_result" >&5
-$as_echo "$_am_result" >&6; }
-rm -f confinc confmf
-
-# Check whether --enable-dependency-tracking was given.
-if test "${enable_dependency_tracking+set}" = set; then :
-  enableval=$enable_dependency_tracking;
-fi
-
-if test "x$enable_dependency_tracking" != xno; then
-  am_depcomp="$ac_aux_dir/depcomp"
-  AMDEPBACKSLASH='\'
-fi
- if test "x$enable_dependency_tracking" != xno; then
-  AMDEP_TRUE=
-  AMDEP_FALSE='#'
-else
-  AMDEP_TRUE='#'
-  AMDEP_FALSE=
-fi
-
-
-
-depcc="$CC"   am_compiler_list=
-
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking dependency style of $depcc" >&5
-$as_echo_n "checking dependency style of $depcc... " >&6; }
-if test "${am_cv_CC_dependencies_compiler_type+set}" = set; then :
-  $as_echo_n "(cached) " >&6
-else
-  if test -z "$AMDEP_TRUE" && test -f "$am_depcomp"; then
-  # We make a subdir and do the tests there.  Otherwise we can end up
-  # making bogus files that we don't know about and never remove.  For
-  # instance it was reported that on HP-UX the gcc test will end up
-  # making a dummy file named `D' -- because `-MD' means `put the output
-  # in D'.
-  mkdir conftest.dir
-  # Copy depcomp to subdir because otherwise we won't find it if we're
-  # using a relative directory.
-  cp "$am_depcomp" conftest.dir
-  cd conftest.dir
-  # We will build objects and dependencies in a subdirectory because
-  # it helps to detect inapplicable dependency modes.  For instance
-  # both Tru64's cc and ICC support -MD to output dependencies as a
-  # side effect of compilation, but ICC will put the dependencies in
-  # the current directory while Tru64 will put them in the object
-  # directory.
-  mkdir sub
-
-  am_cv_CC_dependencies_compiler_type=none
-  if test "$am_compiler_list" = ""; then
-     am_compiler_list=`sed -n 's/^#*\([a-zA-Z0-9]*\))$/\1/p' < ./depcomp`
-  fi
-  am__universal=false
-  case " $depcc " in #(
-     *\ -arch\ *\ -arch\ *) am__universal=true ;;
-     esac
-
-  for depmode in $am_compiler_list; do
-    # Setup a source with many dependencies, because some compilers
-    # like to wrap large dependency lists on column 80 (with \), and
-    # we should not choose a depcomp mode which is confused by this.
-    #
-    # We need to recreate these files for each test, as the compiler may
-    # overwrite some of them when testing with obscure command lines.
-    # This happens at least with the AIX C compiler.
-    : > sub/conftest.c
-    for i in 1 2 3 4 5 6; do
-      echo '#include "conftst'$i'.h"' >> sub/conftest.c
-      # Using `: > sub/conftst$i.h' creates only sub/conftst1.h with
-      # Solaris 8's {/usr,}/bin/sh.
-      touch sub/conftst$i.h
-    done
-    echo "${am__include} ${am__quote}sub/conftest.Po${am__quote}" > confmf
-
-    # We check with `-c' and `-o' for the sake of the "dashmstdout"
-    # mode.  It turns out that the SunPro C++ compiler does not properly
-    # handle `-M -o', and we need to detect this.  Also, some Intel
-    # versions had trouble with output in subdirs
-    am__obj=sub/conftest.${OBJEXT-o}
-    am__minus_obj="-o $am__obj"
-    case $depmode in
-    gcc)
-      # This depmode causes a compiler race in universal mode.
-      test "$am__universal" = false || continue
-      ;;
-    nosideeffect)
-      # after this tag, mechanisms are not by side-effect, so they'll
-      # only be used when explicitly requested
-      if test "x$enable_dependency_tracking" = xyes; then
-	continue
-      else
-	break
-      fi
-      ;;
-    msvisualcpp | msvcmsys)
-      # This compiler won't grok `-c -o', but also, the minuso test has
-      # not run yet.  These depmodes are late enough in the game, and
-      # so weak that their functioning should not be impacted.
-      am__obj=conftest.${OBJEXT-o}
-      am__minus_obj=
-      ;;
-    none) break ;;
-    esac
-    if depmode=$depmode \
-       source=sub/conftest.c object=$am__obj \
-       depfile=sub/conftest.Po tmpdepfile=sub/conftest.TPo \
-       $SHELL ./depcomp $depcc -c $am__minus_obj sub/conftest.c \
-         >/dev/null 2>conftest.err &&
-       grep sub/conftst1.h sub/conftest.Po > /dev/null 2>&1 &&
-       grep sub/conftst6.h sub/conftest.Po > /dev/null 2>&1 &&
-       grep $am__obj sub/conftest.Po > /dev/null 2>&1 &&
-       ${MAKE-make} -s -f confmf > /dev/null 2>&1; then
-      # icc doesn't choke on unknown options, it will just issue warnings
-      # or remarks (even with -Werror).  So we grep stderr for any message
-      # that says an option was ignored or not supported.
-      # When given -MP, icc 7.0 and 7.1 complain thusly:
-      #   icc: Command line warning: ignoring option '-M'; no argument required
-      # The diagnosis changed in icc 8.0:
-      #   icc: Command line remark: option '-MP' not supported
-      if (grep 'ignoring option' conftest.err ||
-          grep 'not supported' conftest.err) >/dev/null 2>&1; then :; else
-        am_cv_CC_dependencies_compiler_type=$depmode
-        break
-      fi
-    fi
-  done
-
-  cd ..
-  rm -rf conftest.dir
-else
-  am_cv_CC_dependencies_compiler_type=none
-fi
-
-fi
-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $am_cv_CC_dependencies_compiler_type" >&5
-$as_echo "$am_cv_CC_dependencies_compiler_type" >&6; }
-CCDEPMODE=depmode=$am_cv_CC_dependencies_compiler_type
-
- if
-  test "x$enable_dependency_tracking" != xno \
-  && test "$am_cv_CC_dependencies_compiler_type" = gcc3; then
-  am__fastdepCC_TRUE=
-  am__fastdepCC_FALSE='#'
-else
-  am__fastdepCC_TRUE='#'
-  am__fastdepCC_FALSE=
-fi
-
-
-ac_ext=c
-ac_cpp='$CPP $CPPFLAGS'
-ac_compile='$CC -c $CFLAGS $CPPFLAGS conftest.$ac_ext >&5'
-ac_link='$CC -o conftest$ac_exeext $CFLAGS $CPPFLAGS $LDFLAGS conftest.$ac_ext $LIBS >&5'
-ac_compiler_gnu=$ac_cv_c_compiler_gnu
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking how to run the C preprocessor" >&5
-$as_echo_n "checking how to run the C preprocessor... " >&6; }
-# On Suns, sometimes $CPP names a directory.
-if test -n "$CPP" && test -d "$CPP"; then
-  CPP=
-fi
-if test -z "$CPP"; then
-  if test "${ac_cv_prog_CPP+set}" = set; then :
-  $as_echo_n "(cached) " >&6
-else
-      # Double quotes because CPP needs to be expanded
-    for CPP in "$CC -E" "$CC -E -traditional-cpp" "/lib/cpp"
-    do
-      ac_preproc_ok=false
-for ac_c_preproc_warn_flag in '' yes
-do
-  # Use a header file that comes with gcc, so configuring glibc
-  # with a fresh cross-compiler works.
-  # Prefer <limits.h> to <assert.h> if __STDC__ is defined, since
-  # <limits.h> exists even on freestanding compilers.
-  # On the NeXT, cc -E runs the code through the compiler's parser,
-  # not just through cpp. "Syntax error" is here to catch this case.
-  cat confdefs.h - <<_ACEOF >conftest.$ac_ext
-/* end confdefs.h.  */
-#ifdef __STDC__
-# include <limits.h>
-#else
-# include <assert.h>
-#endif
-		     Syntax error
-_ACEOF
-if ac_fn_c_try_cpp "$LINENO"; then :
-
-else
-  # Broken: fails on valid input.
-continue
-fi
-rm -f conftest.err conftest.$ac_ext
-
-  # OK, works on sane cases.  Now check whether nonexistent headers
-  # can be detected and how.
-  cat confdefs.h - <<_ACEOF >conftest.$ac_ext
-/* end confdefs.h.  */
-#include <ac_nonexistent.h>
-_ACEOF
-if ac_fn_c_try_cpp "$LINENO"; then :
-  # Broken: success on invalid input.
-continue
-else
-  # Passes both tests.
-ac_preproc_ok=:
-break
-fi
-rm -f conftest.err conftest.$ac_ext
-
-done
-# Because of `break', _AC_PREPROC_IFELSE's cleaning code was skipped.
-rm -f conftest.err conftest.$ac_ext
-if $ac_preproc_ok; then :
-  break
-fi
-
-    done
-    ac_cv_prog_CPP=$CPP
-
-fi
-  CPP=$ac_cv_prog_CPP
-else
-  ac_cv_prog_CPP=$CPP
-fi
-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $CPP" >&5
-$as_echo "$CPP" >&6; }
-ac_preproc_ok=false
-for ac_c_preproc_warn_flag in '' yes
-do
-  # Use a header file that comes with gcc, so configuring glibc
-  # with a fresh cross-compiler works.
-  # Prefer <limits.h> to <assert.h> if __STDC__ is defined, since
-  # <limits.h> exists even on freestanding compilers.
-  # On the NeXT, cc -E runs the code through the compiler's parser,
-  # not just through cpp. "Syntax error" is here to catch this case.
-  cat confdefs.h - <<_ACEOF >conftest.$ac_ext
-/* end confdefs.h.  */
-#ifdef __STDC__
-# include <limits.h>
-#else
-# include <assert.h>
-#endif
-		     Syntax error
-_ACEOF
-if ac_fn_c_try_cpp "$LINENO"; then :
-
-else
-  # Broken: fails on valid input.
-continue
-fi
-rm -f conftest.err conftest.$ac_ext
-
-  # OK, works on sane cases.  Now check whether nonexistent headers
-  # can be detected and how.
-  cat confdefs.h - <<_ACEOF >conftest.$ac_ext
-/* end confdefs.h.  */
-#include <ac_nonexistent.h>
-_ACEOF
-if ac_fn_c_try_cpp "$LINENO"; then :
-  # Broken: success on invalid input.
-continue
-else
-  # Passes both tests.
-ac_preproc_ok=:
-break
-fi
-rm -f conftest.err conftest.$ac_ext
-
-done
-# Because of `break', _AC_PREPROC_IFELSE's cleaning code was skipped.
-rm -f conftest.err conftest.$ac_ext
-if $ac_preproc_ok; then :
-
-else
-  { { $as_echo "$as_me:${as_lineno-$LINENO}: error: in \`$ac_pwd':" >&5
-$as_echo "$as_me: error: in \`$ac_pwd':" >&2;}
-as_fn_error "C preprocessor \"$CPP\" fails sanity check
-See \`config.log' for more details." "$LINENO" 5; }
-fi
-
-ac_ext=c
-ac_cpp='$CPP $CPPFLAGS'
-ac_compile='$CC -c $CFLAGS $CPPFLAGS conftest.$ac_ext >&5'
-ac_link='$CC -o conftest$ac_exeext $CFLAGS $CPPFLAGS $LDFLAGS conftest.$ac_ext $LIBS >&5'
-ac_compiler_gnu=$ac_cv_c_compiler_gnu
-
-ac_ext=cpp
-ac_cpp='$CXXCPP $CPPFLAGS'
-ac_compile='$CXX -c $CXXFLAGS $CPPFLAGS conftest.$ac_ext >&5'
-ac_link='$CXX -o conftest$ac_exeext $CXXFLAGS $CPPFLAGS $LDFLAGS conftest.$ac_ext $LIBS >&5'
-ac_compiler_gnu=$ac_cv_cxx_compiler_gnu
-if test -z "$CXX"; then
-  if test -n "$CCC"; then
-    CXX=$CCC
-  else
-    if test -n "$ac_tool_prefix"; then
-  for ac_prog in g++ c++ gpp aCC CC cxx cc++ cl.exe FCC KCC RCC xlC_r xlC
-  do
-    # Extract the first word of "$ac_tool_prefix$ac_prog", so it can be a program name with args.
-set dummy $ac_tool_prefix$ac_prog; ac_word=$2
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for $ac_word" >&5
-$as_echo_n "checking for $ac_word... " >&6; }
-if test "${ac_cv_prog_CXX+set}" = set; then :
-  $as_echo_n "(cached) " >&6
-else
-  if test -n "$CXX"; then
-  ac_cv_prog_CXX="$CXX" # Let the user override the test.
-else
-as_save_IFS=$IFS; IFS=$PATH_SEPARATOR
-for as_dir in $PATH
-do
-  IFS=$as_save_IFS
-  test -z "$as_dir" && as_dir=.
-    for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
-    ac_cv_prog_CXX="$ac_tool_prefix$ac_prog"
-    $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
-    break 2
-  fi
-done
-  done
-IFS=$as_save_IFS
-
-fi
-fi
-CXX=$ac_cv_prog_CXX
-if test -n "$CXX"; then
-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: $CXX" >&5
-$as_echo "$CXX" >&6; }
-else
-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
-$as_echo "no" >&6; }
-fi
-
-
-    test -n "$CXX" && break
-  done
-fi
-if test -z "$CXX"; then
-  ac_ct_CXX=$CXX
-  for ac_prog in g++ c++ gpp aCC CC cxx cc++ cl.exe FCC KCC RCC xlC_r xlC
-do
-  # Extract the first word of "$ac_prog", so it can be a program name with args.
-set dummy $ac_prog; ac_word=$2
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for $ac_word" >&5
-$as_echo_n "checking for $ac_word... " >&6; }
-if test "${ac_cv_prog_ac_ct_CXX+set}" = set; then :
-  $as_echo_n "(cached) " >&6
-else
-  if test -n "$ac_ct_CXX"; then
-  ac_cv_prog_ac_ct_CXX="$ac_ct_CXX" # Let the user override the test.
-else
-as_save_IFS=$IFS; IFS=$PATH_SEPARATOR
-for as_dir in $PATH
-do
-  IFS=$as_save_IFS
-  test -z "$as_dir" && as_dir=.
-    for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
-    ac_cv_prog_ac_ct_CXX="$ac_prog"
-    $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
-    break 2
-  fi
-done
-  done
-IFS=$as_save_IFS
-
-fi
-fi
-ac_ct_CXX=$ac_cv_prog_ac_ct_CXX
-if test -n "$ac_ct_CXX"; then
-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_ct_CXX" >&5
-$as_echo "$ac_ct_CXX" >&6; }
-else
-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
-$as_echo "no" >&6; }
-fi
-
-
-  test -n "$ac_ct_CXX" && break
-done
-
-  if test "x$ac_ct_CXX" = x; then
-    CXX="g++"
-  else
-    case $cross_compiling:$ac_tool_warned in
-yes:)
-{ $as_echo "$as_me:${as_lineno-$LINENO}: WARNING: using cross tools not prefixed with host triplet" >&5
-$as_echo "$as_me: WARNING: using cross tools not prefixed with host triplet" >&2;}
-ac_tool_warned=yes ;;
-esac
-    CXX=$ac_ct_CXX
-  fi
-fi
-
-  fi
-fi
-# Provide some information about the compiler.
-$as_echo "$as_me:${as_lineno-$LINENO}: checking for C++ compiler version" >&5
-set X $ac_compile
-ac_compiler=$2
-for ac_option in --version -v -V -qversion; do
-  { { ac_try="$ac_compiler $ac_option >&5"
-case "(($ac_try" in
-  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
-  *) ac_try_echo=$ac_try;;
-esac
-eval ac_try_echo="\"\$as_me:${as_lineno-$LINENO}: $ac_try_echo\""
-$as_echo "$ac_try_echo"; } >&5
-  (eval "$ac_compiler $ac_option >&5") 2>conftest.err
-  ac_status=$?
-  if test -s conftest.err; then
-    sed '10a\
-... rest of stderr output deleted ...
-         10q' conftest.err >conftest.er1
-    cat conftest.er1 >&5
-  fi
-  rm -f conftest.er1 conftest.err
-  $as_echo "$as_me:${as_lineno-$LINENO}: \$? = $ac_status" >&5
-  test $ac_status = 0; }
-done
-
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking whether we are using the GNU C++ compiler" >&5
-$as_echo_n "checking whether we are using the GNU C++ compiler... " >&6; }
-if test "${ac_cv_cxx_compiler_gnu+set}" = set; then :
-  $as_echo_n "(cached) " >&6
-else
-  cat confdefs.h - <<_ACEOF >conftest.$ac_ext
-/* end confdefs.h.  */
-
-int
-main ()
-{
-#ifndef __GNUC__
-       choke me
-#endif
-
-  ;
-  return 0;
-}
-_ACEOF
-if ac_fn_cxx_try_compile "$LINENO"; then :
-  ac_compiler_gnu=yes
-else
-  ac_compiler_gnu=no
-fi
-rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
-ac_cv_cxx_compiler_gnu=$ac_compiler_gnu
-
-fi
-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_cxx_compiler_gnu" >&5
-$as_echo "$ac_cv_cxx_compiler_gnu" >&6; }
-if test $ac_compiler_gnu = yes; then
-  GXX=yes
-else
-  GXX=
-fi
-ac_test_CXXFLAGS=${CXXFLAGS+set}
-ac_save_CXXFLAGS=$CXXFLAGS
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking whether $CXX accepts -g" >&5
-$as_echo_n "checking whether $CXX accepts -g... " >&6; }
-if test "${ac_cv_prog_cxx_g+set}" = set; then :
-  $as_echo_n "(cached) " >&6
-else
-  ac_save_cxx_werror_flag=$ac_cxx_werror_flag
-   ac_cxx_werror_flag=yes
-   ac_cv_prog_cxx_g=no
-   CXXFLAGS="-g"
-   cat confdefs.h - <<_ACEOF >conftest.$ac_ext
-/* end confdefs.h.  */
-
-int
-main ()
-{
-
-  ;
-  return 0;
-}
-_ACEOF
-if ac_fn_cxx_try_compile "$LINENO"; then :
-  ac_cv_prog_cxx_g=yes
-else
-  CXXFLAGS=""
-      cat confdefs.h - <<_ACEOF >conftest.$ac_ext
-/* end confdefs.h.  */
-
-int
-main ()
-{
-
-  ;
-  return 0;
-}
-_ACEOF
-if ac_fn_cxx_try_compile "$LINENO"; then :
-
-else
-  ac_cxx_werror_flag=$ac_save_cxx_werror_flag
-	 CXXFLAGS="-g"
-	 cat confdefs.h - <<_ACEOF >conftest.$ac_ext
-/* end confdefs.h.  */
-
-int
-main ()
-{
-
-  ;
-  return 0;
-}
-_ACEOF
-if ac_fn_cxx_try_compile "$LINENO"; then :
-  ac_cv_prog_cxx_g=yes
-fi
-rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
-fi
-rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
-fi
-rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
-   ac_cxx_werror_flag=$ac_save_cxx_werror_flag
-fi
-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_prog_cxx_g" >&5
-$as_echo "$ac_cv_prog_cxx_g" >&6; }
-if test "$ac_test_CXXFLAGS" = set; then
-  CXXFLAGS=$ac_save_CXXFLAGS
-elif test $ac_cv_prog_cxx_g = yes; then
-  if test "$GXX" = yes; then
-    CXXFLAGS="-g -O2"
-  else
-    CXXFLAGS="-g"
-  fi
-else
-  if test "$GXX" = yes; then
-    CXXFLAGS="-O2"
-  else
-    CXXFLAGS=
-  fi
-fi
-ac_ext=c
-ac_cpp='$CPP $CPPFLAGS'
-ac_compile='$CC -c $CFLAGS $CPPFLAGS conftest.$ac_ext >&5'
-ac_link='$CC -o conftest$ac_exeext $CFLAGS $CPPFLAGS $LDFLAGS conftest.$ac_ext $LIBS >&5'
-ac_compiler_gnu=$ac_cv_c_compiler_gnu
-
-depcc="$CXX"  am_compiler_list=
-
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking dependency style of $depcc" >&5
-$as_echo_n "checking dependency style of $depcc... " >&6; }
-if test "${am_cv_CXX_dependencies_compiler_type+set}" = set; then :
-  $as_echo_n "(cached) " >&6
-else
-  if test -z "$AMDEP_TRUE" && test -f "$am_depcomp"; then
-  # We make a subdir and do the tests there.  Otherwise we can end up
-  # making bogus files that we don't know about and never remove.  For
-  # instance it was reported that on HP-UX the gcc test will end up
-  # making a dummy file named `D' -- because `-MD' means `put the output
-  # in D'.
-  mkdir conftest.dir
-  # Copy depcomp to subdir because otherwise we won't find it if we're
-  # using a relative directory.
-  cp "$am_depcomp" conftest.dir
-  cd conftest.dir
-  # We will build objects and dependencies in a subdirectory because
-  # it helps to detect inapplicable dependency modes.  For instance
-  # both Tru64's cc and ICC support -MD to output dependencies as a
-  # side effect of compilation, but ICC will put the dependencies in
-  # the current directory while Tru64 will put them in the object
-  # directory.
-  mkdir sub
-
-  am_cv_CXX_dependencies_compiler_type=none
-  if test "$am_compiler_list" = ""; then
-     am_compiler_list=`sed -n 's/^#*\([a-zA-Z0-9]*\))$/\1/p' < ./depcomp`
-  fi
-  am__universal=false
-  case " $depcc " in #(
-     *\ -arch\ *\ -arch\ *) am__universal=true ;;
-     esac
-
-  for depmode in $am_compiler_list; do
-    # Setup a source with many dependencies, because some compilers
-    # like to wrap large dependency lists on column 80 (with \), and
-    # we should not choose a depcomp mode which is confused by this.
-    #
-    # We need to recreate these files for each test, as the compiler may
-    # overwrite some of them when testing with obscure command lines.
-    # This happens at least with the AIX C compiler.
-    : > sub/conftest.c
-    for i in 1 2 3 4 5 6; do
-      echo '#include "conftst'$i'.h"' >> sub/conftest.c
-      # Using `: > sub/conftst$i.h' creates only sub/conftst1.h with
-      # Solaris 8's {/usr,}/bin/sh.
-      touch sub/conftst$i.h
-    done
-    echo "${am__include} ${am__quote}sub/conftest.Po${am__quote}" > confmf
-
-    # We check with `-c' and `-o' for the sake of the "dashmstdout"
-    # mode.  It turns out that the SunPro C++ compiler does not properly
-    # handle `-M -o', and we need to detect this.  Also, some Intel
-    # versions had trouble with output in subdirs
-    am__obj=sub/conftest.${OBJEXT-o}
-    am__minus_obj="-o $am__obj"
-    case $depmode in
-    gcc)
-      # This depmode causes a compiler race in universal mode.
-      test "$am__universal" = false || continue
-      ;;
-    nosideeffect)
-      # after this tag, mechanisms are not by side-effect, so they'll
-      # only be used when explicitly requested
-      if test "x$enable_dependency_tracking" = xyes; then
-	continue
-      else
-	break
-      fi
-      ;;
-    msvisualcpp | msvcmsys)
-      # This compiler won't grok `-c -o', but also, the minuso test has
-      # not run yet.  These depmodes are late enough in the game, and
-      # so weak that their functioning should not be impacted.
-      am__obj=conftest.${OBJEXT-o}
-      am__minus_obj=
-      ;;
-    none) break ;;
-    esac
-    if depmode=$depmode \
-       source=sub/conftest.c object=$am__obj \
-       depfile=sub/conftest.Po tmpdepfile=sub/conftest.TPo \
-       $SHELL ./depcomp $depcc -c $am__minus_obj sub/conftest.c \
-         >/dev/null 2>conftest.err &&
-       grep sub/conftst1.h sub/conftest.Po > /dev/null 2>&1 &&
-       grep sub/conftst6.h sub/conftest.Po > /dev/null 2>&1 &&
-       grep $am__obj sub/conftest.Po > /dev/null 2>&1 &&
-       ${MAKE-make} -s -f confmf > /dev/null 2>&1; then
-      # icc doesn't choke on unknown options, it will just issue warnings
-      # or remarks (even with -Werror).  So we grep stderr for any message
-      # that says an option was ignored or not supported.
-      # When given -MP, icc 7.0 and 7.1 complain thusly:
-      #   icc: Command line warning: ignoring option '-M'; no argument required
-      # The diagnosis changed in icc 8.0:
-      #   icc: Command line remark: option '-MP' not supported
-      if (grep 'ignoring option' conftest.err ||
-          grep 'not supported' conftest.err) >/dev/null 2>&1; then :; else
-        am_cv_CXX_dependencies_compiler_type=$depmode
-        break
-      fi
-    fi
-  done
-
-  cd ..
-  rm -rf conftest.dir
-else
-  am_cv_CXX_dependencies_compiler_type=none
-fi
-
-fi
-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $am_cv_CXX_dependencies_compiler_type" >&5
-$as_echo "$am_cv_CXX_dependencies_compiler_type" >&6; }
-CXXDEPMODE=depmode=$am_cv_CXX_dependencies_compiler_type
-
- if
-  test "x$enable_dependency_tracking" != xno \
-  && test "$am_cv_CXX_dependencies_compiler_type" = gcc3; then
-  am__fastdepCXX_TRUE=
-  am__fastdepCXX_FALSE='#'
-else
-  am__fastdepCXX_TRUE='#'
-  am__fastdepCXX_FALSE=
-fi
-
-
-
-if test -n "$ac_tool_prefix"; then
-  # Extract the first word of "${ac_tool_prefix}ranlib", so it can be a program name with args.
-set dummy ${ac_tool_prefix}ranlib; ac_word=$2
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for $ac_word" >&5
-$as_echo_n "checking for $ac_word... " >&6; }
-if test "${ac_cv_prog_RANLIB+set}" = set; then :
-  $as_echo_n "(cached) " >&6
-else
-  if test -n "$RANLIB"; then
-  ac_cv_prog_RANLIB="$RANLIB" # Let the user override the test.
-else
-as_save_IFS=$IFS; IFS=$PATH_SEPARATOR
-for as_dir in $PATH
-do
-  IFS=$as_save_IFS
-  test -z "$as_dir" && as_dir=.
-    for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
-    ac_cv_prog_RANLIB="${ac_tool_prefix}ranlib"
-    $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
-    break 2
-  fi
-done
-  done
-IFS=$as_save_IFS
-
-fi
-fi
-RANLIB=$ac_cv_prog_RANLIB
-if test -n "$RANLIB"; then
-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: $RANLIB" >&5
-$as_echo "$RANLIB" >&6; }
-else
-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
-$as_echo "no" >&6; }
-fi
-
-
-fi
-if test -z "$ac_cv_prog_RANLIB"; then
-  ac_ct_RANLIB=$RANLIB
-  # Extract the first word of "ranlib", so it can be a program name with args.
-set dummy ranlib; ac_word=$2
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for $ac_word" >&5
-$as_echo_n "checking for $ac_word... " >&6; }
-if test "${ac_cv_prog_ac_ct_RANLIB+set}" = set; then :
-  $as_echo_n "(cached) " >&6
-else
-  if test -n "$ac_ct_RANLIB"; then
-  ac_cv_prog_ac_ct_RANLIB="$ac_ct_RANLIB" # Let the user override the test.
-else
-as_save_IFS=$IFS; IFS=$PATH_SEPARATOR
-for as_dir in $PATH
-do
-  IFS=$as_save_IFS
-  test -z "$as_dir" && as_dir=.
-    for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
-    ac_cv_prog_ac_ct_RANLIB="ranlib"
-    $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
-    break 2
-  fi
-done
-  done
-IFS=$as_save_IFS
-
-fi
-fi
-ac_ct_RANLIB=$ac_cv_prog_ac_ct_RANLIB
-if test -n "$ac_ct_RANLIB"; then
-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_ct_RANLIB" >&5
-$as_echo "$ac_ct_RANLIB" >&6; }
-else
-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
-$as_echo "no" >&6; }
-fi
-
-  if test "x$ac_ct_RANLIB" = x; then
-    RANLIB=":"
-  else
-    case $cross_compiling:$ac_tool_warned in
-yes:)
-{ $as_echo "$as_me:${as_lineno-$LINENO}: WARNING: using cross tools not prefixed with host triplet" >&5
-$as_echo "$as_me: WARNING: using cross tools not prefixed with host triplet" >&2;}
-ac_tool_warned=yes ;;
-esac
-    RANLIB=$ac_ct_RANLIB
-  fi
-else
-  RANLIB="$ac_cv_prog_RANLIB"
-fi
-
-
-if test x$host = xi386-pc-os2-emx ; then
-    CXXFLAGS="$CXXFLAGS -Zmt"
-    LDFLAGS="$LDFLAGS -Zomf -Zmt"
-    LIBS="$LIBS -los2me"
-fi
-
-SDL_VERSION=1.2.0
-
-
-# Check whether --with-sdl-prefix was given.
-if test "${with_sdl_prefix+set}" = set; then :
-  withval=$with_sdl_prefix; sdl_prefix="$withval"
-else
-  sdl_prefix=""
-fi
-
-
-# Check whether --with-sdl-exec-prefix was given.
-if test "${with_sdl_exec_prefix+set}" = set; then :
-  withval=$with_sdl_exec_prefix; sdl_exec_prefix="$withval"
-else
-  sdl_exec_prefix=""
-fi
-
-# Check whether --enable-sdltest was given.
-if test "${enable_sdltest+set}" = set; then :
-  enableval=$enable_sdltest;
-else
-  enable_sdltest=yes
-fi
-
-
-  if test x$sdl_exec_prefix != x ; then
-     sdl_args="$sdl_args --exec-prefix=$sdl_exec_prefix"
-     if test x${SDL_CONFIG+set} != xset ; then
-        SDL_CONFIG=$sdl_exec_prefix/bin/sdl-config
-     fi
-  fi
-  if test x$sdl_prefix != x ; then
-     sdl_args="$sdl_args --prefix=$sdl_prefix"
-     if test x${SDL_CONFIG+set} != xset ; then
-        SDL_CONFIG=$sdl_prefix/bin/sdl-config
-     fi
-  fi
-
-  # Extract the first word of "sdl-config", so it can be a program name with args.
-set dummy sdl-config; ac_word=$2
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for $ac_word" >&5
-$as_echo_n "checking for $ac_word... " >&6; }
-if test "${ac_cv_path_SDL_CONFIG+set}" = set; then :
-  $as_echo_n "(cached) " >&6
-else
-  case $SDL_CONFIG in
-  [\\/]* | ?:[\\/]*)
-  ac_cv_path_SDL_CONFIG="$SDL_CONFIG" # Let the user override the test with a path.
-  ;;
-  *)
-  as_save_IFS=$IFS; IFS=$PATH_SEPARATOR
-for as_dir in $PATH
-do
-  IFS=$as_save_IFS
-  test -z "$as_dir" && as_dir=.
-    for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
-    ac_cv_path_SDL_CONFIG="$as_dir/$ac_word$ac_exec_ext"
-    $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
-    break 2
-  fi
-done
-  done
-IFS=$as_save_IFS
-
-  test -z "$ac_cv_path_SDL_CONFIG" && ac_cv_path_SDL_CONFIG="no"
-  ;;
-esac
-fi
-SDL_CONFIG=$ac_cv_path_SDL_CONFIG
-if test -n "$SDL_CONFIG"; then
-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: $SDL_CONFIG" >&5
-$as_echo "$SDL_CONFIG" >&6; }
-else
-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
-$as_echo "no" >&6; }
-fi
-
-
-  min_sdl_version=$SDL_VERSION
-  { $as_echo "$as_me:${as_lineno-$LINENO}: checking for SDL - version >= $min_sdl_version" >&5
-$as_echo_n "checking for SDL - version >= $min_sdl_version... " >&6; }
-  no_sdl=""
-  if test "$SDL_CONFIG" = "no" ; then
-    no_sdl=yes
-  else
-    SDL_CFLAGS=`$SDL_CONFIG $sdlconf_args --cflags`
-    SDL_LIBS=`$SDL_CONFIG $sdlconf_args --libs`
-
-    sdl_major_version=`$SDL_CONFIG $sdl_args --version | \
-           sed 's/\([0-9]*\).\([0-9]*\).\([0-9]*\)/\1/'`
-    sdl_minor_version=`$SDL_CONFIG $sdl_args --version | \
-           sed 's/\([0-9]*\).\([0-9]*\).\([0-9]*\)/\2/'`
-    sdl_micro_version=`$SDL_CONFIG $sdl_config_args --version | \
-           sed 's/\([0-9]*\).\([0-9]*\).\([0-9]*\)/\3/'`
-    if test "x$enable_sdltest" = "xyes" ; then
-      ac_save_CFLAGS="$CFLAGS"
-      ac_save_LIBS="$LIBS"
-      CFLAGS="$CFLAGS $SDL_CFLAGS"
-      LIBS="$LIBS $SDL_LIBS"
-      rm -f conf.sdltest
-      if test "$cross_compiling" = yes; then :
-  echo $ac_n "cross compiling; assumed OK... $ac_c"
-else
-  cat confdefs.h - <<_ACEOF >conftest.$ac_ext
-/* end confdefs.h.  */
-
-#include <stdio.h>
-#include <stdlib.h>
-#include <string.h>
-#include "SDL.h"
-
-char*
-my_strdup (char *str)
-{
-  char *new_str;
-
-  if (str)
-    {
-      new_str = (char *)malloc ((strlen (str) + 1) * sizeof(char));
-      strcpy (new_str, str);
-    }
-  else
-    new_str = NULL;
-
-  return new_str;
-}
-
-int main (int argc, char *argv[])
-{
-  int major, minor, micro;
-  char *tmp_version;
-
-  /* This hangs on some systems (?)
-  system ("touch conf.sdltest");
-  */
-  { FILE *fp = fopen("conf.sdltest", "a"); if ( fp ) fclose(fp); }
-
-  /* HP/UX 9 (%@#!) writes to sscanf strings */
-  tmp_version = my_strdup("$min_sdl_version");
-  if (sscanf(tmp_version, "%d.%d.%d", &major, &minor, &micro) != 3) {
-     printf("%s, bad version string\n", "$min_sdl_version");
-     exit(1);
-   }
-
-   if (($sdl_major_version > major) ||
-      (($sdl_major_version == major) && ($sdl_minor_version > minor)) ||
-      (($sdl_major_version == major) && ($sdl_minor_version == minor) && ($sdl_micro_version >= micro)))
-    {
-      return 0;
-    }
-  else
-    {
-      printf("\n*** 'sdl-config --version' returned %d.%d.%d, but the minimum version\n", $sdl_major_version, $sdl_minor_version, $sdl_micro_version);
-      printf("*** of SDL required is %d.%d.%d. If sdl-config is correct, then it is\n", major, minor, micro);
-      printf("*** best to upgrade to the required version.\n");
-      printf("*** If sdl-config was wrong, set the environment variable SDL_CONFIG\n");
-      printf("*** to point to the correct copy of sdl-config, and remove the file\n");
-      printf("*** config.cache before re-running configure\n");
-      return 1;
-    }
-}
-
-
-_ACEOF
-if ac_fn_c_try_run "$LINENO"; then :
-
-else
-  no_sdl=yes
-fi
-rm -f core *.core core.conftest.* gmon.out bb.out conftest$ac_exeext \
-  conftest.$ac_objext conftest.beam conftest.$ac_ext
-fi
-
-       CFLAGS="$ac_save_CFLAGS"
-       LIBS="$ac_save_LIBS"
-     fi
-  fi
-  if test "x$no_sdl" = x ; then
-     { $as_echo "$as_me:${as_lineno-$LINENO}: result: yes" >&5
-$as_echo "yes" >&6; }
-     :
-  else
-     { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
-$as_echo "no" >&6; }
-     if test "$SDL_CONFIG" = "no" ; then
-       echo "*** The sdl-config script installed by SDL could not be found"
-       echo "*** If SDL was installed in PREFIX, make sure PREFIX/bin is in"
-       echo "*** your path, or set the SDL_CONFIG environment variable to the"
-       echo "*** full path to sdl-config."
-     else
-       if test -f conf.sdltest ; then
-        :
-       else
-          echo "*** Could not run SDL test program, checking why..."
-          CFLAGS="$CFLAGS $SDL_CFLAGS"
-          LIBS="$LIBS $SDL_LIBS"
-          cat confdefs.h - <<_ACEOF >conftest.$ac_ext
-/* end confdefs.h.  */
-
-#include <stdio.h>
-#include "SDL.h"
-
-int
-main ()
-{
- return 0;
-  ;
-  return 0;
-}
-_ACEOF
-if ac_fn_c_try_link "$LINENO"; then :
-   echo "*** The test program compiled, but did not run. This usually means"
-          echo "*** that the run-time linker is not finding SDL or finding the wrong"
-          echo "*** version of SDL. If it is not finding SDL, you'll need to set your"
-          echo "*** LD_LIBRARY_PATH environment variable, or edit /etc/ld.so.conf to point"
-          echo "*** to the installed location  Also, make sure you have run ldconfig if that"
-          echo "*** is required on your system"
-	  echo "***"
-          echo "*** If you have an old version installed, it is best to remove it, although"
-          echo "*** you may also be able to get things to work by modifying LD_LIBRARY_PATH"
-else
-   echo "*** The test program failed to compile or link. See the file config.log for the"
-          echo "*** exact error that occured. This usually means SDL was incorrectly installed"
-          echo "*** or that you have moved SDL since it was installed. In the latter case, you"
-          echo "*** may want to edit the sdl-config script: $SDL_CONFIG"
-fi
-rm -f core conftest.err conftest.$ac_objext \
-    conftest$ac_exeext conftest.$ac_ext
-          CFLAGS="$ac_save_CFLAGS"
-          LIBS="$ac_save_LIBS"
-       fi
-     fi
-     SDL_CFLAGS=""
-     SDL_LIBS=""
-     as_fn_error "*** SDL version $SDL_VERSION not found!" "$LINENO" 5
-
-  fi
-
-
-  rm -f conf.sdltest
-
-LIBS="$LIBS $SDL_LIBS"
-CPPFLAGS="$CPPFLAGS $SDL_CFLAGS"
-
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking SDL version only being 1.2.X" >&5
-$as_echo_n "checking SDL version only being 1.2.X... " >&6; }
-cat confdefs.h - <<_ACEOF >conftest.$ac_ext
-/* end confdefs.h.  */
-
-#include "SDL.h"
-void blah(){
-#if SDL_MINOR_VERSION != 2
-#error "Only SDL 1.2 supported"
-#endif
-;
-}
-
-_ACEOF
-if ac_fn_c_try_compile "$LINENO"; then :
-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: yes" >&5
-$as_echo "yes" >&6; }
-else
-
- { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
-$as_echo "no" >&6; }
- as_fn_error "Only libSDL 1.2.X supported" "$LINENO" 5
-fi
-rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
-
-
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for an ANSI C-conforming const" >&5
-$as_echo_n "checking for an ANSI C-conforming const... " >&6; }
-if test "${ac_cv_c_const+set}" = set; then :
-  $as_echo_n "(cached) " >&6
-else
-  cat confdefs.h - <<_ACEOF >conftest.$ac_ext
-/* end confdefs.h.  */
-
-int
-main ()
-{
-/* FIXME: Include the comments suggested by Paul. */
-#ifndef __cplusplus
-  /* Ultrix mips cc rejects this.  */
-  typedef int charset[2];
-  const charset cs;
-  /* SunOS 4.1.1 cc rejects this.  */
-  char const *const *pcpcc;
-  char **ppc;
-  /* NEC SVR4.0.2 mips cc rejects this.  */
-  struct point {int x, y;};
-  static struct point const zero = {0,0};
-  /* AIX XL C 1.02.0.0 rejects this.
-     It does not let you subtract one const X* pointer from another in
-     an arm of an if-expression whose if-part is not a constant
-     expression */
-  const char *g = "string";
-  pcpcc = &g + (g ? g-g : 0);
-  /* HPUX 7.0 cc rejects these. */
-  ++pcpcc;
-  ppc = (char**) pcpcc;
-  pcpcc = (char const *const *) ppc;
-  { /* SCO 3.2v4 cc rejects this.  */
-    char *t;
-    char const *s = 0 ? (char *) 0 : (char const *) 0;
-
-    *t++ = 0;
-    if (s) return 0;
-  }
-  { /* Someone thinks the Sun supposedly-ANSI compiler will reject this.  */
-    int x[] = {25, 17};
-    const int *foo = &x[0];
-    ++foo;
-  }
-  { /* Sun SC1.0 ANSI compiler rejects this -- but not the above. */
-    typedef const int *iptr;
-    iptr p = 0;
-    ++p;
-  }
-  { /* AIX XL C 1.02.0.0 rejects this saying
-       "k.c", line 2.27: 1506-025 (S) Operand must be a modifiable lvalue. */
-    struct s { int j; const int *ap[3]; };
-    struct s *b; b->j = 5;
-  }
-  { /* ULTRIX-32 V3.1 (Rev 9) vcc rejects this */
-    const int foo = 10;
-    if (!foo) return 0;
-  }
-  return !cs[0] && !zero.x;
-#endif
-
-  ;
-  return 0;
-}
-_ACEOF
-if ac_fn_c_try_compile "$LINENO"; then :
-  ac_cv_c_const=yes
-else
-  ac_cv_c_const=no
-fi
-rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
-fi
-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_c_const" >&5
-$as_echo "$ac_cv_c_const" >&6; }
-if test $ac_cv_c_const = no; then
-
-$as_echo "#define const /**/" >>confdefs.h
-
-fi
-
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for inline" >&5
-$as_echo_n "checking for inline... " >&6; }
-if test "${ac_cv_c_inline+set}" = set; then :
-  $as_echo_n "(cached) " >&6
-else
-  ac_cv_c_inline=no
-for ac_kw in inline __inline__ __inline; do
-  cat confdefs.h - <<_ACEOF >conftest.$ac_ext
-/* end confdefs.h.  */
-#ifndef __cplusplus
-typedef int foo_t;
-static $ac_kw foo_t static_foo () {return 0; }
-$ac_kw foo_t foo () {return 0; }
-#endif
-
-_ACEOF
-if ac_fn_c_try_compile "$LINENO"; then :
-  ac_cv_c_inline=$ac_kw
-fi
-rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
-  test "$ac_cv_c_inline" != no && break
-done
-
-fi
-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_c_inline" >&5
-$as_echo "$ac_cv_c_inline" >&6; }
-
-case $ac_cv_c_inline in
-  inline | yes) ;;
-  *)
-    case $ac_cv_c_inline in
-      no) ac_val=;;
-      *) ac_val=$ac_cv_c_inline;;
-    esac
-    cat >>confdefs.h <<_ACEOF
-#ifndef __cplusplus
-#define inline $ac_val
-#endif
-_ACEOF
-    ;;
-esac
-
-
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for grep that handles long lines and -e" >&5
-$as_echo_n "checking for grep that handles long lines and -e... " >&6; }
-if test "${ac_cv_path_GREP+set}" = set; then :
-  $as_echo_n "(cached) " >&6
-else
-  if test -z "$GREP"; then
-  ac_path_GREP_found=false
-  # Loop through the user's path and test for each of PROGNAME-LIST
-  as_save_IFS=$IFS; IFS=$PATH_SEPARATOR
-for as_dir in $PATH$PATH_SEPARATOR/usr/xpg4/bin
-do
-  IFS=$as_save_IFS
-  test -z "$as_dir" && as_dir=.
-    for ac_prog in grep ggrep; do
-    for ac_exec_ext in '' $ac_executable_extensions; do
-      ac_path_GREP="$as_dir/$ac_prog$ac_exec_ext"
-      { test -f "$ac_path_GREP" && $as_test_x "$ac_path_GREP"; } || continue
-# Check for GNU ac_path_GREP and select it if it is found.
-  # Check for GNU $ac_path_GREP
-case `"$ac_path_GREP" --version 2>&1` in
-*GNU*)
-  ac_cv_path_GREP="$ac_path_GREP" ac_path_GREP_found=:;;
-*)
-  ac_count=0
-  $as_echo_n 0123456789 >"conftest.in"
-  while :
-  do
-    cat "conftest.in" "conftest.in" >"conftest.tmp"
-    mv "conftest.tmp" "conftest.in"
-    cp "conftest.in" "conftest.nl"
-    $as_echo 'GREP' >> "conftest.nl"
-    "$ac_path_GREP" -e 'GREP$' -e '-(cannot match)-' < "conftest.nl" >"conftest.out" 2>/dev/null || break
-    diff "conftest.out" "conftest.nl" >/dev/null 2>&1 || break
-    as_fn_arith $ac_count + 1 && ac_count=$as_val
-    if test $ac_count -gt ${ac_path_GREP_max-0}; then
-      # Best one so far, save it but keep looking for a better one
-      ac_cv_path_GREP="$ac_path_GREP"
-      ac_path_GREP_max=$ac_count
-    fi
-    # 10*(2^10) chars as input seems more than enough
-    test $ac_count -gt 10 && break
-  done
-  rm -f conftest.in conftest.tmp conftest.nl conftest.out;;
-esac
-
-      $ac_path_GREP_found && break 3
-    done
-  done
-  done
-IFS=$as_save_IFS
-  if test -z "$ac_cv_path_GREP"; then
-    as_fn_error "no acceptable grep could be found in $PATH$PATH_SEPARATOR/usr/xpg4/bin" "$LINENO" 5
-  fi
-else
-  ac_cv_path_GREP=$GREP
-fi
-
-fi
-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_path_GREP" >&5
-$as_echo "$ac_cv_path_GREP" >&6; }
- GREP="$ac_cv_path_GREP"
-
-
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for egrep" >&5
-$as_echo_n "checking for egrep... " >&6; }
-if test "${ac_cv_path_EGREP+set}" = set; then :
-  $as_echo_n "(cached) " >&6
-else
-  if echo a | $GREP -E '(a|b)' >/dev/null 2>&1
-   then ac_cv_path_EGREP="$GREP -E"
-   else
-     if test -z "$EGREP"; then
-  ac_path_EGREP_found=false
-  # Loop through the user's path and test for each of PROGNAME-LIST
-  as_save_IFS=$IFS; IFS=$PATH_SEPARATOR
-for as_dir in $PATH$PATH_SEPARATOR/usr/xpg4/bin
-do
-  IFS=$as_save_IFS
-  test -z "$as_dir" && as_dir=.
-    for ac_prog in egrep; do
-    for ac_exec_ext in '' $ac_executable_extensions; do
-      ac_path_EGREP="$as_dir/$ac_prog$ac_exec_ext"
-      { test -f "$ac_path_EGREP" && $as_test_x "$ac_path_EGREP"; } || continue
-# Check for GNU ac_path_EGREP and select it if it is found.
-  # Check for GNU $ac_path_EGREP
-case `"$ac_path_EGREP" --version 2>&1` in
-*GNU*)
-  ac_cv_path_EGREP="$ac_path_EGREP" ac_path_EGREP_found=:;;
-*)
-  ac_count=0
-  $as_echo_n 0123456789 >"conftest.in"
-  while :
-  do
-    cat "conftest.in" "conftest.in" >"conftest.tmp"
-    mv "conftest.tmp" "conftest.in"
-    cp "conftest.in" "conftest.nl"
-    $as_echo 'EGREP' >> "conftest.nl"
-    "$ac_path_EGREP" 'EGREP$' < "conftest.nl" >"conftest.out" 2>/dev/null || break
-    diff "conftest.out" "conftest.nl" >/dev/null 2>&1 || break
-    as_fn_arith $ac_count + 1 && ac_count=$as_val
-    if test $ac_count -gt ${ac_path_EGREP_max-0}; then
-      # Best one so far, save it but keep looking for a better one
-      ac_cv_path_EGREP="$ac_path_EGREP"
-      ac_path_EGREP_max=$ac_count
-    fi
-    # 10*(2^10) chars as input seems more than enough
-    test $ac_count -gt 10 && break
-  done
-  rm -f conftest.in conftest.tmp conftest.nl conftest.out;;
-esac
-
-      $ac_path_EGREP_found && break 3
-    done
-  done
-  done
-IFS=$as_save_IFS
-  if test -z "$ac_cv_path_EGREP"; then
-    as_fn_error "no acceptable egrep could be found in $PATH$PATH_SEPARATOR/usr/xpg4/bin" "$LINENO" 5
-  fi
-else
-  ac_cv_path_EGREP=$EGREP
-fi
-
-   fi
-fi
-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_path_EGREP" >&5
-$as_echo "$ac_cv_path_EGREP" >&6; }
- EGREP="$ac_cv_path_EGREP"
-
-
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for ANSI C header files" >&5
-$as_echo_n "checking for ANSI C header files... " >&6; }
-if test "${ac_cv_header_stdc+set}" = set; then :
-  $as_echo_n "(cached) " >&6
-else
-  cat confdefs.h - <<_ACEOF >conftest.$ac_ext
-/* end confdefs.h.  */
-#include <stdlib.h>
-#include <stdarg.h>
-#include <string.h>
-#include <float.h>
-
-int
-main ()
-{
-
-  ;
-  return 0;
-}
-_ACEOF
-if ac_fn_c_try_compile "$LINENO"; then :
-  ac_cv_header_stdc=yes
-else
-  ac_cv_header_stdc=no
-fi
-rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
-
-if test $ac_cv_header_stdc = yes; then
-  # SunOS 4.x string.h does not declare mem*, contrary to ANSI.
-  cat confdefs.h - <<_ACEOF >conftest.$ac_ext
-/* end confdefs.h.  */
-#include <string.h>
-
-_ACEOF
-if (eval "$ac_cpp conftest.$ac_ext") 2>&5 |
-  $EGREP "memchr" >/dev/null 2>&1; then :
-
-else
-  ac_cv_header_stdc=no
-fi
-rm -f conftest*
-
-fi
-
-if test $ac_cv_header_stdc = yes; then
-  # ISC 2.0.2 stdlib.h does not declare free, contrary to ANSI.
-  cat confdefs.h - <<_ACEOF >conftest.$ac_ext
-/* end confdefs.h.  */
-#include <stdlib.h>
-
-_ACEOF
-if (eval "$ac_cpp conftest.$ac_ext") 2>&5 |
-  $EGREP "free" >/dev/null 2>&1; then :
-
-else
-  ac_cv_header_stdc=no
-fi
-rm -f conftest*
-
-fi
-
-if test $ac_cv_header_stdc = yes; then
-  # /bin/cc in Irix-4.0.5 gets non-ANSI ctype macros unless using -ansi.
-  if test "$cross_compiling" = yes; then :
-  :
-else
-  cat confdefs.h - <<_ACEOF >conftest.$ac_ext
-/* end confdefs.h.  */
-#include <ctype.h>
-#include <stdlib.h>
-#if ((' ' & 0x0FF) == 0x020)
-# define ISLOWER(c) ('a' <= (c) && (c) <= 'z')
-# define TOUPPER(c) (ISLOWER(c) ? 'A' + ((c) - 'a') : (c))
-#else
-# define ISLOWER(c) \
-		   (('a' <= (c) && (c) <= 'i') \
-		     || ('j' <= (c) && (c) <= 'r') \
-		     || ('s' <= (c) && (c) <= 'z'))
-# define TOUPPER(c) (ISLOWER(c) ? ((c) | 0x40) : (c))
-#endif
-
-#define XOR(e, f) (((e) && !(f)) || (!(e) && (f)))
-int
-main ()
-{
-  int i;
-  for (i = 0; i < 256; i++)
-    if (XOR (islower (i), ISLOWER (i))
-	|| toupper (i) != TOUPPER (i))
-      return 2;
-  return 0;
-}
-_ACEOF
-if ac_fn_c_try_run "$LINENO"; then :
-
-else
-  ac_cv_header_stdc=no
-fi
-rm -f core *.core core.conftest.* gmon.out bb.out conftest$ac_exeext \
-  conftest.$ac_objext conftest.beam conftest.$ac_ext
-fi
-
-fi
-fi
-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_header_stdc" >&5
-$as_echo "$ac_cv_header_stdc" >&6; }
-if test $ac_cv_header_stdc = yes; then
-
-$as_echo "#define STDC_HEADERS 1" >>confdefs.h
-
-fi
-
-# On IRIX 5.3, sys/types and inttypes.h are conflicting.
-for ac_header in sys/types.h sys/stat.h stdlib.h string.h memory.h strings.h \
-		  inttypes.h stdint.h unistd.h
-do :
-  as_ac_Header=`$as_echo "ac_cv_header_$ac_header" | $as_tr_sh`
-ac_fn_c_check_header_compile "$LINENO" "$ac_header" "$as_ac_Header" "$ac_includes_default
-"
-eval as_val=\$$as_ac_Header
-   if test "x$as_val" = x""yes; then :
-  cat >>confdefs.h <<_ACEOF
-#define `$as_echo "HAVE_$ac_header" | $as_tr_cpp` 1
-_ACEOF
-
-fi
-
-done
-
-
-ac_fn_c_check_type "$LINENO" "size_t" "ac_cv_type_size_t" "$ac_includes_default"
-if test "x$ac_cv_type_size_t" = x""yes; then :
-
-else
-
-cat >>confdefs.h <<_ACEOF
-#define size_t unsigned int
-_ACEOF
-
-fi
-
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking whether struct tm is in sys/time.h or time.h" >&5
-$as_echo_n "checking whether struct tm is in sys/time.h or time.h... " >&6; }
-if test "${ac_cv_struct_tm+set}" = set; then :
-  $as_echo_n "(cached) " >&6
-else
-  cat confdefs.h - <<_ACEOF >conftest.$ac_ext
-/* end confdefs.h.  */
-#include <sys/types.h>
-#include <time.h>
-
-int
-main ()
-{
-struct tm tm;
-				     int *p = &tm.tm_sec;
-				     return !p;
-  ;
-  return 0;
-}
-_ACEOF
-if ac_fn_c_try_compile "$LINENO"; then :
-  ac_cv_struct_tm=time.h
-else
-  ac_cv_struct_tm=sys/time.h
-fi
-rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
-fi
-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_struct_tm" >&5
-$as_echo "$ac_cv_struct_tm" >&6; }
-if test $ac_cv_struct_tm = sys/time.h; then
-
-$as_echo "#define TM_IN_SYS_TIME 1" >>confdefs.h
-
-fi
-
-# The cast to long int works around a bug in the HP C Compiler
-# version HP92453-01 B.11.11.23709.GP, which incorrectly rejects
-# declarations like `int a3[[(sizeof (unsigned char)) >= 0]];'.
-# This bug is HP SR number 8606223364.
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking size of unsigned char" >&5
-$as_echo_n "checking size of unsigned char... " >&6; }
-if test "${ac_cv_sizeof_unsigned_char+set}" = set; then :
-  $as_echo_n "(cached) " >&6
-else
-  if ac_fn_c_compute_int "$LINENO" "(long int) (sizeof (unsigned char))" "ac_cv_sizeof_unsigned_char"        "$ac_includes_default"; then :
-
-else
-  if test "$ac_cv_type_unsigned_char" = yes; then
-     { { $as_echo "$as_me:${as_lineno-$LINENO}: error: in \`$ac_pwd':" >&5
-$as_echo "$as_me: error: in \`$ac_pwd':" >&2;}
-{ as_fn_set_status 77
-as_fn_error "cannot compute sizeof (unsigned char)
-See \`config.log' for more details." "$LINENO" 5; }; }
-   else
-     ac_cv_sizeof_unsigned_char=0
-   fi
-fi
-
-fi
-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_sizeof_unsigned_char" >&5
-$as_echo "$ac_cv_sizeof_unsigned_char" >&6; }
-
-
-
-cat >>confdefs.h <<_ACEOF
-#define SIZEOF_UNSIGNED_CHAR $ac_cv_sizeof_unsigned_char
-_ACEOF
-
-
-# The cast to long int works around a bug in the HP C Compiler
-# version HP92453-01 B.11.11.23709.GP, which incorrectly rejects
-# declarations like `int a3[[(sizeof (unsigned char)) >= 0]];'.
-# This bug is HP SR number 8606223364.
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking size of unsigned short" >&5
-$as_echo_n "checking size of unsigned short... " >&6; }
-if test "${ac_cv_sizeof_unsigned_short+set}" = set; then :
-  $as_echo_n "(cached) " >&6
-else
-  if ac_fn_c_compute_int "$LINENO" "(long int) (sizeof (unsigned short))" "ac_cv_sizeof_unsigned_short"        "$ac_includes_default"; then :
-
-else
-  if test "$ac_cv_type_unsigned_short" = yes; then
-     { { $as_echo "$as_me:${as_lineno-$LINENO}: error: in \`$ac_pwd':" >&5
-$as_echo "$as_me: error: in \`$ac_pwd':" >&2;}
-{ as_fn_set_status 77
-as_fn_error "cannot compute sizeof (unsigned short)
-See \`config.log' for more details." "$LINENO" 5; }; }
-   else
-     ac_cv_sizeof_unsigned_short=0
-   fi
-fi
-
-fi
-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_sizeof_unsigned_short" >&5
-$as_echo "$ac_cv_sizeof_unsigned_short" >&6; }
-
-
-
-cat >>confdefs.h <<_ACEOF
-#define SIZEOF_UNSIGNED_SHORT $ac_cv_sizeof_unsigned_short
-_ACEOF
-
-
-# The cast to long int works around a bug in the HP C Compiler
-# version HP92453-01 B.11.11.23709.GP, which incorrectly rejects
-# declarations like `int a3[[(sizeof (unsigned char)) >= 0]];'.
-# This bug is HP SR number 8606223364.
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking size of unsigned int" >&5
-$as_echo_n "checking size of unsigned int... " >&6; }
-if test "${ac_cv_sizeof_unsigned_int+set}" = set; then :
-  $as_echo_n "(cached) " >&6
-else
-  if ac_fn_c_compute_int "$LINENO" "(long int) (sizeof (unsigned int))" "ac_cv_sizeof_unsigned_int"        "$ac_includes_default"; then :
-
-else
-  if test "$ac_cv_type_unsigned_int" = yes; then
-     { { $as_echo "$as_me:${as_lineno-$LINENO}: error: in \`$ac_pwd':" >&5
-$as_echo "$as_me: error: in \`$ac_pwd':" >&2;}
-{ as_fn_set_status 77
-as_fn_error "cannot compute sizeof (unsigned int)
-See \`config.log' for more details." "$LINENO" 5; }; }
-   else
-     ac_cv_sizeof_unsigned_int=0
-   fi
-fi
-
-fi
-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_sizeof_unsigned_int" >&5
-$as_echo "$ac_cv_sizeof_unsigned_int" >&6; }
-
-
-
-cat >>confdefs.h <<_ACEOF
-#define SIZEOF_UNSIGNED_INT $ac_cv_sizeof_unsigned_int
-_ACEOF
-
-
-# The cast to long int works around a bug in the HP C Compiler
-# version HP92453-01 B.11.11.23709.GP, which incorrectly rejects
-# declarations like `int a3[[(sizeof (unsigned char)) >= 0]];'.
-# This bug is HP SR number 8606223364.
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking size of unsigned long" >&5
-$as_echo_n "checking size of unsigned long... " >&6; }
-if test "${ac_cv_sizeof_unsigned_long+set}" = set; then :
-  $as_echo_n "(cached) " >&6
-else
-  if ac_fn_c_compute_int "$LINENO" "(long int) (sizeof (unsigned long))" "ac_cv_sizeof_unsigned_long"        "$ac_includes_default"; then :
-
-else
-  if test "$ac_cv_type_unsigned_long" = yes; then
-     { { $as_echo "$as_me:${as_lineno-$LINENO}: error: in \`$ac_pwd':" >&5
-$as_echo "$as_me: error: in \`$ac_pwd':" >&2;}
-{ as_fn_set_status 77
-as_fn_error "cannot compute sizeof (unsigned long)
-See \`config.log' for more details." "$LINENO" 5; }; }
-   else
-     ac_cv_sizeof_unsigned_long=0
-   fi
-fi
-
-fi
-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_sizeof_unsigned_long" >&5
-$as_echo "$ac_cv_sizeof_unsigned_long" >&6; }
-
-
-
-cat >>confdefs.h <<_ACEOF
-#define SIZEOF_UNSIGNED_LONG $ac_cv_sizeof_unsigned_long
-_ACEOF
-
-
-# The cast to long int works around a bug in the HP C Compiler
-# version HP92453-01 B.11.11.23709.GP, which incorrectly rejects
-# declarations like `int a3[[(sizeof (unsigned char)) >= 0]];'.
-# This bug is HP SR number 8606223364.
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking size of unsigned long long" >&5
-$as_echo_n "checking size of unsigned long long... " >&6; }
-if test "${ac_cv_sizeof_unsigned_long_long+set}" = set; then :
-  $as_echo_n "(cached) " >&6
-else
-  if ac_fn_c_compute_int "$LINENO" "(long int) (sizeof (unsigned long long))" "ac_cv_sizeof_unsigned_long_long"        "$ac_includes_default"; then :
-
-else
-  if test "$ac_cv_type_unsigned_long_long" = yes; then
-     { { $as_echo "$as_me:${as_lineno-$LINENO}: error: in \`$ac_pwd':" >&5
-$as_echo "$as_me: error: in \`$ac_pwd':" >&2;}
-{ as_fn_set_status 77
-as_fn_error "cannot compute sizeof (unsigned long long)
-See \`config.log' for more details." "$LINENO" 5; }; }
-   else
-     ac_cv_sizeof_unsigned_long_long=0
-   fi
-fi
-
-fi
-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_sizeof_unsigned_long_long" >&5
-$as_echo "$ac_cv_sizeof_unsigned_long_long" >&6; }
-
-
-
-cat >>confdefs.h <<_ACEOF
-#define SIZEOF_UNSIGNED_LONG_LONG $ac_cv_sizeof_unsigned_long_long
-_ACEOF
-
-
-# The cast to long int works around a bug in the HP C Compiler
-# version HP92453-01 B.11.11.23709.GP, which incorrectly rejects
-# declarations like `int a3[[(sizeof (unsigned char)) >= 0]];'.
-# This bug is HP SR number 8606223364.
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking size of int *" >&5
-$as_echo_n "checking size of int *... " >&6; }
-if test "${ac_cv_sizeof_int_p+set}" = set; then :
-  $as_echo_n "(cached) " >&6
-else
-  if ac_fn_c_compute_int "$LINENO" "(long int) (sizeof (int *))" "ac_cv_sizeof_int_p"        "$ac_includes_default"; then :
-
-else
-  if test "$ac_cv_type_int_p" = yes; then
-     { { $as_echo "$as_me:${as_lineno-$LINENO}: error: in \`$ac_pwd':" >&5
-$as_echo "$as_me: error: in \`$ac_pwd':" >&2;}
-{ as_fn_set_status 77
-as_fn_error "cannot compute sizeof (int *)
-See \`config.log' for more details." "$LINENO" 5; }; }
-   else
-     ac_cv_sizeof_int_p=0
-   fi
-fi
-
-fi
-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_sizeof_int_p" >&5
-$as_echo "$ac_cv_sizeof_int_p" >&6; }
-
-
-
-cat >>confdefs.h <<_ACEOF
-#define SIZEOF_INT_P $ac_cv_sizeof_int_p
-_ACEOF
-
-
-
-for ac_header in stdlib.h sys/types.h
-do :
-  as_ac_Header=`$as_echo "ac_cv_header_$ac_header" | $as_tr_sh`
-ac_fn_c_check_header_mongrel "$LINENO" "$ac_header" "$as_ac_Header" "$ac_includes_default"
-eval as_val=\$$as_ac_Header
-   if test "x$as_val" = x""yes; then :
-  cat >>confdefs.h <<_ACEOF
-#define `$as_echo "HAVE_$ac_header" | $as_tr_cpp` 1
-_ACEOF
-
-fi
-
-done
-
-for ac_header in sys/socket.h  netinet/in.h pwd.h
-do :
-  as_ac_Header=`$as_echo "ac_cv_header_$ac_header" | $as_tr_sh`
-ac_fn_c_check_header_compile "$LINENO" "$ac_header" "$as_ac_Header" "#include <stdio.h>
-#ifdef STDC_HEADERS
-# include <stdlib.h>
-# include <stddef.h>
-#else
-# ifdef HAVE_STDLIB_H
-#  include <stdlib.h>
-# endif
-#endif
-#ifdef HAVE_SYS_TYPES_H
-# include <sys/types.h>
-#endif
-
-"
-eval as_val=\$$as_ac_Header
-   if test "x$as_val" = x""yes; then :
-  cat >>confdefs.h <<_ACEOF
-#define `$as_echo "HAVE_$ac_header" | $as_tr_cpp` 1
-_ACEOF
-
-fi
-
-done
-
-
-cat confdefs.h - <<_ACEOF >conftest.$ac_ext
-/* end confdefs.h.  */
-
-#include <stdio.h>
-#ifdef STDC_HEADERS
-# include <stdlib.h>
-# include <stddef.h>
-#else
-# ifdef HAVE_STDLIB_H
-#  include <stdlib.h>
-# endif
-#endif
-#ifdef HAVE_SYS_TYPES_H
-# include <sys/types.h>
-#endif
-#ifdef HAVE_SYS_SOCKET_H
-#include <sys/socket.h>
-#endif
-
-_ACEOF
-if ac_fn_c_try_compile "$LINENO"; then :
-
-else
-
-$as_echo "#define socklen_t int" >>confdefs.h
-
-fi
-rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
-
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking if environ can be included" >&5
-$as_echo_n "checking if environ can be included... " >&6; }
-cat confdefs.h - <<_ACEOF >conftest.$ac_ext
-/* end confdefs.h.  */
-
-#include <unistd.h>
-#include <stdlib.h>
-int
-main ()
-{
-*environ;
-  ;
-  return 0;
-}
-_ACEOF
-if ac_fn_c_try_link "$LINENO"; then :
-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: yes" >&5
-$as_echo "yes" >&6; };
-$as_echo "#define ENVIRON_INCLUDED 1" >>confdefs.h
-
-else
-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
-$as_echo "no" >&6; }
-fi
-rm -f core conftest.err conftest.$ac_objext \
-    conftest$ac_exeext conftest.$ac_ext
-
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking if environ can be linked" >&5
-$as_echo_n "checking if environ can be linked... " >&6; }
-cat confdefs.h - <<_ACEOF >conftest.$ac_ext
-/* end confdefs.h.  */
-extern char ** environ;
-int
-main ()
-{
-*environ;
-  ;
-  return 0;
-}
-_ACEOF
-if ac_fn_c_try_link "$LINENO"; then :
-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: yes" >&5
-$as_echo "yes" >&6; };
-$as_echo "#define ENVIRON_LINKED 1" >>confdefs.h
-
-else
-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
-$as_echo "no" >&6; }
-fi
-rm -f core conftest.err conftest.$ac_objext \
-    conftest$ac_exeext conftest.$ac_ext
-
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking if dirent includes d_type" >&5
-$as_echo_n "checking if dirent includes d_type... " >&6; }
-cat confdefs.h - <<_ACEOF >conftest.$ac_ext
-/* end confdefs.h.  */
-
-#include <sys/types.h>
-#include <dirent.h>
-void blah(){
-struct dirent d_test;
-d_test.d_type = 0;
-}
-_ACEOF
-if ac_fn_c_try_compile "$LINENO"; then :
-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: yes" >&5
-$as_echo "yes" >&6; };
-$as_echo "#define DIRENT_HAS_D_TYPE 1" >>confdefs.h
-
-else
-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
-$as_echo "no" >&6; }
-fi
-rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
-
-
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for powf in libm" >&5
-$as_echo_n "checking for powf in libm... " >&6; };
-LIBS_BACKUP=$LIBS;
-LIBS="$LIBS -lm";
-cat confdefs.h - <<_ACEOF >conftest.$ac_ext
-/* end confdefs.h.  */
-#include <math.h>
-int
-main ()
-{
-
-        powf(1.0f, 1.0f);
-
-  ;
-  return 0;
-}
-_ACEOF
-if ac_fn_c_try_link "$LINENO"; then :
-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: yes" >&5
-$as_echo "yes" >&6; }
-else
-
-$as_echo "#define DB_HAVE_NO_POWF 1" >>confdefs.h
-
-fi
-rm -f core conftest.err conftest.$ac_objext \
-    conftest$ac_exeext conftest.$ac_ext
-LIBS=$LIBS_BACKUP
-
-
-
-#Check if the compiler support attributes
-
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking if compiler allows __attribute__" >&5
-$as_echo_n "checking if compiler allows __attribute__... " >&6; }
-cat confdefs.h - <<_ACEOF >conftest.$ac_ext
-/* end confdefs.h.  */
-
-typedef struct { } __attribute__((packed)) junk;
-int
-main ()
-{
-
-  ;
-  return 0;
-}
-_ACEOF
-if ac_fn_c_try_compile "$LINENO"; then :
-   { $as_echo "$as_me:${as_lineno-$LINENO}: result: yes" >&5
-$as_echo "yes" >&6; };$as_echo "#define C_HAS_ATTRIBUTE 1" >>confdefs.h
-
-else
-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
-$as_echo "no" >&6; }
-fi
-rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
-
-
-#Check if the compiler supports certain attributes
-OLDCFLAGS="$CFLAGS"
-CFLAGS="-Werror"
-
-
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking if compiler allows __attribute__((always_inline)) " >&5
-$as_echo_n "checking if compiler allows __attribute__((always_inline)) ... " >&6; }
-cat confdefs.h - <<_ACEOF >conftest.$ac_ext
-/* end confdefs.h.  */
- void __attribute__((always_inline)) test(){}
-
-_ACEOF
-if ac_fn_c_try_compile "$LINENO"; then :
-   { $as_echo "$as_me:${as_lineno-$LINENO}: result: yes" >&5
-$as_echo "yes" >&6; };$as_echo "#define C_ATTRIBUTE_ALWAYS_INLINE 1" >>confdefs.h
-
-else
-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
-$as_echo "no" >&6; }
-fi
-rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
-
-
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking if compiler allows __attribute__((fastcall)) " >&5
-$as_echo_n "checking if compiler allows __attribute__((fastcall)) ... " >&6; }
-cat confdefs.h - <<_ACEOF >conftest.$ac_ext
-/* end confdefs.h.  */
- void __attribute__((fastcall)) test(){}
-
-_ACEOF
-if ac_fn_c_try_compile "$LINENO"; then :
-   { $as_echo "$as_me:${as_lineno-$LINENO}: result: yes" >&5
-$as_echo "yes" >&6; };$as_echo "#define C_ATTRIBUTE_FASTCALL 1" >>confdefs.h
-
-else
-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
-$as_echo "no" >&6; }
-fi
-rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
-
-
-CFLAGS="$OLDCFLAGS"
-
-
-#Check if the compiler supports __builtin_expect
-#Switch language to c++
-ac_ext=cpp
-ac_cpp='$CXXCPP $CPPFLAGS'
-ac_compile='$CXX -c $CXXFLAGS $CPPFLAGS conftest.$ac_ext >&5'
-ac_link='$CXX -o conftest$ac_exeext $CXXFLAGS $CPPFLAGS $LDFLAGS conftest.$ac_ext $LIBS >&5'
-ac_compiler_gnu=$ac_cv_cxx_compiler_gnu
-
-
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking if compiler allows __builtin_expect" >&5
-$as_echo_n "checking if compiler allows __builtin_expect... " >&6; }
-
-cat confdefs.h - <<_ACEOF >conftest.$ac_ext
-/* end confdefs.h.  */
-
-int
-main ()
-{
-
-int x=10;if( __builtin_expect ((x==1),0) ) ;
-
-  ;
-  return 0;
-}
-_ACEOF
-if ac_fn_cxx_try_compile "$LINENO"; then :
-   { $as_echo "$as_me:${as_lineno-$LINENO}: result: yes" >&5
-$as_echo "yes" >&6; };$as_echo "#define C_HAS_BUILTIN_EXPECT 1" >>confdefs.h
-
-else
-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
-$as_echo "no" >&6; }
-fi
-rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
-#switch language back
-ac_ext=c
-ac_cpp='$CPP $CPPFLAGS'
-ac_compile='$CC -c $CFLAGS $CPPFLAGS conftest.$ac_ext >&5'
-ac_link='$CC -o conftest$ac_exeext $CFLAGS $CPPFLAGS $LDFLAGS conftest.$ac_ext $LIBS >&5'
-ac_compiler_gnu=$ac_cv_c_compiler_gnu
-
-
-# Check whether --enable-alsa-midi was given.
-if test "${enable_alsa_midi+set}" = set; then :
-  enableval=$enable_alsa_midi;  case "${enableval}" in
- yes) alsa_midi=true;;
- no)  alsa_midi=false;;
-esac
-else
-  alsa_midi=true
-fi
-
-if test x$alsa_midi = xtrue ; then
-  alsa_save_CFLAGS="$CFLAGS"
-alsa_save_LDFLAGS="$LDFLAGS"
-alsa_save_LIBS="$LIBS"
-alsa_found=yes
-
-
-# Check whether --with-alsa-prefix was given.
-if test "${with_alsa_prefix+set}" = set; then :
-  withval=$with_alsa_prefix; alsa_prefix="$withval"
-else
-  alsa_prefix=""
-fi
-
-
-
-# Check whether --with-alsa-inc-prefix was given.
-if test "${with_alsa_inc_prefix+set}" = set; then :
-  withval=$with_alsa_inc_prefix; alsa_inc_prefix="$withval"
-else
-  alsa_inc_prefix=""
-fi
-
-
-# Check whether --enable-alsatest was given.
-if test "${enable_alsatest+set}" = set; then :
-  enableval=$enable_alsatest; enable_alsatest=no
-else
-  enable_alsatest=yes
-fi
-
-
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for ALSA CFLAGS" >&5
-$as_echo_n "checking for ALSA CFLAGS... " >&6; }
-if test "$alsa_inc_prefix" != "" ; then
-	ALSA_CFLAGS="$ALSA_CFLAGS -I$alsa_inc_prefix"
-	CFLAGS="$CFLAGS -I$alsa_inc_prefix"
-fi
-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ALSA_CFLAGS" >&5
-$as_echo "$ALSA_CFLAGS" >&6; }
-
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for ALSA LDFLAGS" >&5
-$as_echo_n "checking for ALSA LDFLAGS... " >&6; }
-if test "$alsa_prefix" != "" ; then
-	ALSA_LIBS="$ALSA_LIBS -L$alsa_prefix"
-	LDFLAGS="$LDFLAGS $ALSA_LIBS"
-fi
-
-ALSA_LIBS="$ALSA_LIBS -lasound -lm -ldl -lpthread"
-LIBS=`echo $LIBS | sed 's/-lm//'`
-LIBS=`echo $LIBS | sed 's/-ldl//'`
-LIBS=`echo $LIBS | sed 's/-lpthread//'`
-LIBS=`echo $LIBS | sed 's/  //'`
-LIBS="$ALSA_LIBS $LIBS"
-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ALSA_LIBS" >&5
-$as_echo "$ALSA_LIBS" >&6; }
-
-min_alsa_version=0.9.0
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for libasound headers version >= $min_alsa_version" >&5
-$as_echo_n "checking for libasound headers version >= $min_alsa_version... " >&6; }
-no_alsa=""
-    alsa_min_major_version=`echo $min_alsa_version | \
-           sed 's/\([0-9]*\).\([0-9]*\).\([0-9]*\)/\1/'`
-    alsa_min_minor_version=`echo $min_alsa_version | \
-           sed 's/\([0-9]*\).\([0-9]*\).\([0-9]*\)/\2/'`
-    alsa_min_micro_version=`echo $min_alsa_version | \
-           sed 's/\([0-9]*\).\([0-9]*\).\([0-9]*\)/\3/'`
-
-
-ac_ext=c
-ac_cpp='$CPP $CPPFLAGS'
-ac_compile='$CC -c $CFLAGS $CPPFLAGS conftest.$ac_ext >&5'
-ac_link='$CC -o conftest$ac_exeext $CFLAGS $CPPFLAGS $LDFLAGS conftest.$ac_ext $LIBS >&5'
-ac_compiler_gnu=$ac_cv_c_compiler_gnu
-
-cat confdefs.h - <<_ACEOF >conftest.$ac_ext
-/* end confdefs.h.  */
-
-#include <alsa/asoundlib.h>
-
-int
-main ()
-{
-
-/* ensure backward compatibility */
-#if !defined(SND_LIB_MAJOR) && defined(SOUNDLIB_VERSION_MAJOR)
-#define SND_LIB_MAJOR SOUNDLIB_VERSION_MAJOR
-#endif
-#if !defined(SND_LIB_MINOR) && defined(SOUNDLIB_VERSION_MINOR)
-#define SND_LIB_MINOR SOUNDLIB_VERSION_MINOR
-#endif
-#if !defined(SND_LIB_SUBMINOR) && defined(SOUNDLIB_VERSION_SUBMINOR)
-#define SND_LIB_SUBMINOR SOUNDLIB_VERSION_SUBMINOR
-#endif
-
-#  if(SND_LIB_MAJOR > $alsa_min_major_version)
-  exit(0);
-#  else
-#    if(SND_LIB_MAJOR < $alsa_min_major_version)
-#       error not present
-#    endif
-
-#   if(SND_LIB_MINOR > $alsa_min_minor_version)
-  exit(0);
-#   else
-#     if(SND_LIB_MINOR < $alsa_min_minor_version)
-#          error not present
-#      endif
-
-#      if(SND_LIB_SUBMINOR < $alsa_min_micro_version)
-#        error not present
-#      endif
-#    endif
-#  endif
-exit(0);
-
-  ;
-  return 0;
-}
-_ACEOF
-if ac_fn_c_try_compile "$LINENO"; then :
-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: found." >&5
-$as_echo "found." >&6; }
-else
-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: not present." >&5
-$as_echo "not present." >&6; }
-
-   alsa_found=no
-
-fi
-rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
-ac_ext=c
-ac_cpp='$CPP $CPPFLAGS'
-ac_compile='$CC -c $CFLAGS $CPPFLAGS conftest.$ac_ext >&5'
-ac_link='$CC -o conftest$ac_exeext $CFLAGS $CPPFLAGS $LDFLAGS conftest.$ac_ext $LIBS >&5'
-ac_compiler_gnu=$ac_cv_c_compiler_gnu
-
-
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for snd_ctl_open in -lasound" >&5
-$as_echo_n "checking for snd_ctl_open in -lasound... " >&6; }
-if test "${ac_cv_lib_asound_snd_ctl_open+set}" = set; then :
-  $as_echo_n "(cached) " >&6
-else
-  ac_check_lib_save_LIBS=$LIBS
-LIBS="-lasound  $LIBS"
-cat confdefs.h - <<_ACEOF >conftest.$ac_ext
-/* end confdefs.h.  */
-
-/* Override any GCC internal prototype to avoid an error.
-   Use char because int might match the return type of a GCC
-   builtin and then its argument prototype would still apply.  */
-#ifdef __cplusplus
-extern "C"
-#endif
-char snd_ctl_open ();
-int
-main ()
-{
-return snd_ctl_open ();
-  ;
-  return 0;
-}
-_ACEOF
-if ac_fn_c_try_link "$LINENO"; then :
-  ac_cv_lib_asound_snd_ctl_open=yes
-else
-  ac_cv_lib_asound_snd_ctl_open=no
-fi
-rm -f core conftest.err conftest.$ac_objext \
-    conftest$ac_exeext conftest.$ac_ext
-LIBS=$ac_check_lib_save_LIBS
-fi
-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_lib_asound_snd_ctl_open" >&5
-$as_echo "$ac_cv_lib_asound_snd_ctl_open" >&6; }
-if test "x$ac_cv_lib_asound_snd_ctl_open" = x""yes; then :
-  cat >>confdefs.h <<_ACEOF
-#define HAVE_LIBASOUND 1
-_ACEOF
-
-  LIBS="-lasound $LIBS"
-
-else
-
-	 alsa_found=no
-
-fi
-
-
-if test "x$alsa_found" = "xyes" ; then
-
-$as_echo "#define HAVE_ALSA 1" >>confdefs.h
-
-   LIBS=`echo $LIBS | sed 's/-lasound//g'`
-   LIBS=`echo $LIBS | sed 's/  //'`
-   LIBS="-lasound $LIBS"
-fi
-if test "x$alsa_found" = "xno" ; then
-   :
-   CFLAGS="$alsa_save_CFLAGS"
-   LDFLAGS="$alsa_save_LDFLAGS"
-   LIBS="$alsa_save_LIBS"
-   ALSA_CFLAGS=""
-   ALSA_LIBS=""
-fi
-
-
-
-
-  CXXFLAGS="$CXXFLAGS $ALSA_CFLAGS"
-fi
-
-#Check for big endian machine, should #define WORDS_BIGENDIAN if so
- { $as_echo "$as_me:${as_lineno-$LINENO}: checking whether byte ordering is bigendian" >&5
-$as_echo_n "checking whether byte ordering is bigendian... " >&6; }
-if test "${ac_cv_c_bigendian+set}" = set; then :
-  $as_echo_n "(cached) " >&6
-else
-  ac_cv_c_bigendian=unknown
-    # See if we're dealing with a universal compiler.
-    cat confdefs.h - <<_ACEOF >conftest.$ac_ext
-/* end confdefs.h.  */
-#ifndef __APPLE_CC__
-	       not a universal capable compiler
-	     #endif
-	     typedef int dummy;
-
-_ACEOF
-if ac_fn_c_try_compile "$LINENO"; then :
-
-	# Check for potential -arch flags.  It is not universal unless
-	# there are at least two -arch flags with different values.
-	ac_arch=
-	ac_prev=
-	for ac_word in $CC $CFLAGS $CPPFLAGS $LDFLAGS; do
-	 if test -n "$ac_prev"; then
-	   case $ac_word in
-	     i?86 | x86_64 | ppc | ppc64)
-	       if test -z "$ac_arch" || test "$ac_arch" = "$ac_word"; then
-		 ac_arch=$ac_word
-	       else
-		 ac_cv_c_bigendian=universal
-		 break
-	       fi
-	       ;;
-	   esac
-	   ac_prev=
-	 elif test "x$ac_word" = "x-arch"; then
-	   ac_prev=arch
-	 fi
-       done
-fi
-rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
-    if test $ac_cv_c_bigendian = unknown; then
-      # See if sys/param.h defines the BYTE_ORDER macro.
-      cat confdefs.h - <<_ACEOF >conftest.$ac_ext
-/* end confdefs.h.  */
-#include <sys/types.h>
-	     #include <sys/param.h>
-
-int
-main ()
-{
-#if ! (defined BYTE_ORDER && defined BIG_ENDIAN \
-		     && defined LITTLE_ENDIAN && BYTE_ORDER && BIG_ENDIAN \
-		     && LITTLE_ENDIAN)
-	      bogus endian macros
-	     #endif
-
-  ;
-  return 0;
-}
-_ACEOF
-if ac_fn_c_try_compile "$LINENO"; then :
-  # It does; now see whether it defined to BIG_ENDIAN or not.
-	 cat confdefs.h - <<_ACEOF >conftest.$ac_ext
-/* end confdefs.h.  */
-#include <sys/types.h>
-		#include <sys/param.h>
-
-int
-main ()
-{
-#if BYTE_ORDER != BIG_ENDIAN
-		 not big endian
-		#endif
-
-  ;
-  return 0;
-}
-_ACEOF
-if ac_fn_c_try_compile "$LINENO"; then :
-  ac_cv_c_bigendian=yes
-else
-  ac_cv_c_bigendian=no
-fi
-rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
-fi
-rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
-    fi
-    if test $ac_cv_c_bigendian = unknown; then
-      # See if <limits.h> defines _LITTLE_ENDIAN or _BIG_ENDIAN (e.g., Solaris).
-      cat confdefs.h - <<_ACEOF >conftest.$ac_ext
-/* end confdefs.h.  */
-#include <limits.h>
-
-int
-main ()
-{
-#if ! (defined _LITTLE_ENDIAN || defined _BIG_ENDIAN)
-	      bogus endian macros
-	     #endif
-
-  ;
-  return 0;
-}
-_ACEOF
-if ac_fn_c_try_compile "$LINENO"; then :
-  # It does; now see whether it defined to _BIG_ENDIAN or not.
-	 cat confdefs.h - <<_ACEOF >conftest.$ac_ext
-/* end confdefs.h.  */
-#include <limits.h>
-
-int
-main ()
-{
-#ifndef _BIG_ENDIAN
-		 not big endian
-		#endif
-
-  ;
-  return 0;
-}
-_ACEOF
-if ac_fn_c_try_compile "$LINENO"; then :
-  ac_cv_c_bigendian=yes
-else
-  ac_cv_c_bigendian=no
-fi
-rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
-fi
-rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
-    fi
-    if test $ac_cv_c_bigendian = unknown; then
-      # Compile a test program.
-      if test "$cross_compiling" = yes; then :
-  # Try to guess by grepping values from an object file.
-	 cat confdefs.h - <<_ACEOF >conftest.$ac_ext
-/* end confdefs.h.  */
-short int ascii_mm[] =
-		  { 0x4249, 0x4765, 0x6E44, 0x6961, 0x6E53, 0x7953, 0 };
-		short int ascii_ii[] =
-		  { 0x694C, 0x5454, 0x656C, 0x6E45, 0x6944, 0x6E61, 0 };
-		int use_ascii (int i) {
-		  return ascii_mm[i] + ascii_ii[i];
-		}
-		short int ebcdic_ii[] =
-		  { 0x89D3, 0xE3E3, 0x8593, 0x95C5, 0x89C4, 0x9581, 0 };
-		short int ebcdic_mm[] =
-		  { 0xC2C9, 0xC785, 0x95C4, 0x8981, 0x95E2, 0xA8E2, 0 };
-		int use_ebcdic (int i) {
-		  return ebcdic_mm[i] + ebcdic_ii[i];
-		}
-		extern int foo;
-
-int
-main ()
-{
-return use_ascii (foo) == use_ebcdic (foo);
-  ;
-  return 0;
-}
-_ACEOF
-if ac_fn_c_try_compile "$LINENO"; then :
-  if grep BIGenDianSyS conftest.$ac_objext >/dev/null; then
-	      ac_cv_c_bigendian=yes
-	    fi
-	    if grep LiTTleEnDian conftest.$ac_objext >/dev/null ; then
-	      if test "$ac_cv_c_bigendian" = unknown; then
-		ac_cv_c_bigendian=no
-	      else
-		# finding both strings is unlikely to happen, but who knows?
-		ac_cv_c_bigendian=unknown
-	      fi
-	    fi
-fi
-rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
-else
-  cat confdefs.h - <<_ACEOF >conftest.$ac_ext
-/* end confdefs.h.  */
-$ac_includes_default
-int
-main ()
-{
-
-	     /* Are we little or big endian?  From Harbison&Steele.  */
-	     union
-	     {
-	       long int l;
-	       char c[sizeof (long int)];
-	     } u;
-	     u.l = 1;
-	     return u.c[sizeof (long int) - 1] == 1;
-
-  ;
-  return 0;
-}
-_ACEOF
-if ac_fn_c_try_run "$LINENO"; then :
-  ac_cv_c_bigendian=no
-else
-  ac_cv_c_bigendian=yes
-fi
-rm -f core *.core core.conftest.* gmon.out bb.out conftest$ac_exeext \
-  conftest.$ac_objext conftest.beam conftest.$ac_ext
-fi
-
-    fi
-fi
-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_c_bigendian" >&5
-$as_echo "$ac_cv_c_bigendian" >&6; }
- case $ac_cv_c_bigendian in #(
-   yes)
-     $as_echo "#define WORDS_BIGENDIAN 1" >>confdefs.h
-;; #(
-   no)
-      ;; #(
-   universal)
-
-$as_echo "#define AC_APPLE_UNIVERSAL_BUILD 1" >>confdefs.h
-
-     ;; #(
-   *)
-     as_fn_error "unknown endianness
- presetting ac_cv_c_bigendian=no (or yes) will help" "$LINENO" 5 ;;
- esac
-
-
-#Features to enable/disable
-
-
-# Check whether --enable-debug was given.
-if test "${enable_debug+set}" = set; then :
-  enableval=$enable_debug;
-   ac_fn_c_check_header_mongrel "$LINENO" "curses.h" "ac_cv_header_curses_h" "$ac_includes_default"
-if test "x$ac_cv_header_curses_h" = x""yes; then :
-  have_curses_h=yes
-fi
-
-
-   { $as_echo "$as_me:${as_lineno-$LINENO}: checking for initscr in -lcurses" >&5
-$as_echo_n "checking for initscr in -lcurses... " >&6; }
-if test "${ac_cv_lib_curses_initscr+set}" = set; then :
-  $as_echo_n "(cached) " >&6
-else
-  ac_check_lib_save_LIBS=$LIBS
-LIBS="-lcurses  $LIBS"
-cat confdefs.h - <<_ACEOF >conftest.$ac_ext
-/* end confdefs.h.  */
-
-/* Override any GCC internal prototype to avoid an error.
-   Use char because int might match the return type of a GCC
-   builtin and then its argument prototype would still apply.  */
-#ifdef __cplusplus
-extern "C"
-#endif
-char initscr ();
-int
-main ()
-{
-return initscr ();
-  ;
-  return 0;
-}
-_ACEOF
-if ac_fn_c_try_link "$LINENO"; then :
-  ac_cv_lib_curses_initscr=yes
-else
-  ac_cv_lib_curses_initscr=no
-fi
-rm -f core conftest.err conftest.$ac_objext \
-    conftest$ac_exeext conftest.$ac_ext
-LIBS=$ac_check_lib_save_LIBS
-fi
-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_lib_curses_initscr" >&5
-$as_echo "$ac_cv_lib_curses_initscr" >&6; }
-if test "x$ac_cv_lib_curses_initscr" = x""yes; then :
-  have_curses_lib=yes
-fi
-
-   { $as_echo "$as_me:${as_lineno-$LINENO}: checking for initscr in -lncurses" >&5
-$as_echo_n "checking for initscr in -lncurses... " >&6; }
-if test "${ac_cv_lib_ncurses_initscr+set}" = set; then :
-  $as_echo_n "(cached) " >&6
-else
-  ac_check_lib_save_LIBS=$LIBS
-LIBS="-lncurses  $LIBS"
-cat confdefs.h - <<_ACEOF >conftest.$ac_ext
-/* end confdefs.h.  */
-
-/* Override any GCC internal prototype to avoid an error.
-   Use char because int might match the return type of a GCC
-   builtin and then its argument prototype would still apply.  */
-#ifdef __cplusplus
-extern "C"
-#endif
-char initscr ();
-int
-main ()
-{
-return initscr ();
-  ;
-  return 0;
-}
-_ACEOF
-if ac_fn_c_try_link "$LINENO"; then :
-  ac_cv_lib_ncurses_initscr=yes
-else
-  ac_cv_lib_ncurses_initscr=no
-fi
-rm -f core conftest.err conftest.$ac_objext \
-    conftest$ac_exeext conftest.$ac_ext
-LIBS=$ac_check_lib_save_LIBS
-fi
-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_lib_ncurses_initscr" >&5
-$as_echo "$ac_cv_lib_ncurses_initscr" >&6; }
-if test "x$ac_cv_lib_ncurses_initscr" = x""yes; then :
-  have_ncurses_lib=yes
-fi
-
-   { $as_echo "$as_me:${as_lineno-$LINENO}: checking for initscr in -lpdcurses" >&5
-$as_echo_n "checking for initscr in -lpdcurses... " >&6; }
-if test "${ac_cv_lib_pdcurses_initscr+set}" = set; then :
-  $as_echo_n "(cached) " >&6
-else
-  ac_check_lib_save_LIBS=$LIBS
-LIBS="-lpdcurses  $LIBS"
-cat confdefs.h - <<_ACEOF >conftest.$ac_ext
-/* end confdefs.h.  */
-
-/* Override any GCC internal prototype to avoid an error.
-   Use char because int might match the return type of a GCC
-   builtin and then its argument prototype would still apply.  */
-#ifdef __cplusplus
-extern "C"
-#endif
-char initscr ();
-int
-main ()
-{
-return initscr ();
-  ;
-  return 0;
-}
-_ACEOF
-if ac_fn_c_try_link "$LINENO"; then :
-  ac_cv_lib_pdcurses_initscr=yes
-else
-  ac_cv_lib_pdcurses_initscr=no
-fi
-rm -f core conftest.err conftest.$ac_objext \
-    conftest$ac_exeext conftest.$ac_ext
-LIBS=$ac_check_lib_save_LIBS
-fi
-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_lib_pdcurses_initscr" >&5
-$as_echo "$ac_cv_lib_pdcurses_initscr" >&6; }
-if test "x$ac_cv_lib_pdcurses_initscr" = x""yes; then :
-  have_pdcurses_lib=yes
-fi
-
-
-   if test x$enable_debug = xno; then
-     { $as_echo "$as_me:${as_lineno-$LINENO}: result: Debugger not enabled" >&5
-$as_echo "Debugger not enabled" >&6; }
-   elif test x$have_curses_lib = xyes -a x$have_curses_h = xyes ; then
-     LIBS="$LIBS -lcurses"
-     $as_echo "#define C_DEBUG 1" >>confdefs.h
-
-     if test x$enable_debug = xheavy ; then
-       $as_echo "#define C_HEAVY_DEBUG 1" >>confdefs.h
-
-     fi
-   elif test x$have_ncurses_lib = xyes -a x$have_curses_h = xyes ; then
-     LIBS="$LIBS -lncurses"
-     $as_echo "#define C_DEBUG 1" >>confdefs.h
-
-     if test x$enable_debug = xheavy ; then
-       $as_echo "#define C_HEAVY_DEBUG 1" >>confdefs.h
-
-     fi
-   elif test x$have_pdcurses_lib = xyes -a x$have_curses_h = xyes ; then
-     LIBS="$LIBS -lpdcurses"
-     $as_echo "#define C_DEBUG 1" >>confdefs.h
-
-     if test x$enable_debug = xheavy ; then
-       $as_echo "#define C_HEAVY_DEBUG 1" >>confdefs.h
-
-     fi
-   else
-     as_fn_error "Can't find curses, which is required for debug mode" "$LINENO" 5
-   fi
-
-fi
-
-
-
-# Check whether --enable-core-inline was given.
-if test "${enable_core_inline+set}" = set; then :
-  enableval=$enable_core_inline;
-  if test x$enable_core_inline = xyes ; then
-    { $as_echo "$as_me:${as_lineno-$LINENO}: result: enabling inlined memory handling in CPU Core" >&5
-$as_echo "enabling inlined memory handling in CPU Core" >&6; }
-    $as_echo "#define C_CORE_INLINE 1" >>confdefs.h
-
-  fi
-
-fi
-
-
-
-
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for target cpu type" >&5
-$as_echo_n "checking for target cpu type... " >&6; }
-case "$host_cpu" in
-  x86_64 | amd64)
-    $as_echo "#define C_TARGETCPU X86_64" >>confdefs.h
-
-    { $as_echo "$as_me:${as_lineno-$LINENO}: result: x86-64 bit compatible" >&5
-$as_echo "x86-64 bit compatible" >&6; }
-    c_targetcpu="x86_64"
-    c_unalignedmemory=yes
-    ;;
-  i?86)
-    $as_echo "#define C_TARGETCPU X86" >>confdefs.h
-
-    { $as_echo "$as_me:${as_lineno-$LINENO}: result: x86 compatible" >&5
-$as_echo "x86 compatible" >&6; }
-    c_targetcpu="x86"
-    c_unalignedmemory=yes
-    ;;
-   powerpc*)
-    $as_echo "#define C_TARGETCPU POWERPC" >>confdefs.h
-
-    { $as_echo "$as_me:${as_lineno-$LINENO}: result: Power PC" >&5
-$as_echo "Power PC" >&6; }
-    c_targetcpu="powerpc"
-    c_unalignedmemory=yes
-    ;;
-   m68k*)
-    $as_echo "#define C_TARGETCPU M68K" >>confdefs.h
-
-    { $as_echo "$as_me:${as_lineno-$LINENO}: result: Motorola 68000" >&5
-$as_echo "Motorola 68000" >&6; }
-    c_targetcpu="m68k"
-    c_unalignedmemory=yes
-    ;;
-   *)
-    $as_echo "#define C_TARGETCPU UNKNOWN" >>confdefs.h
-
-    { $as_echo "$as_me:${as_lineno-$LINENO}: result: unknown" >&5
-$as_echo "unknown" >&6; }
-    c_unalignedmemory=no
-    ;;
-esac
-
-# Check whether --enable-dynamic-core was given.
-if test "${enable_dynamic_core+set}" = set; then :
-  enableval=$enable_dynamic_core;
-else
-  enable_dynamic_core=yes
-fi
-
-
-
-# Check whether --enable-dynamic-x86 was given.
-if test "${enable_dynamic_x86+set}" = set; then :
-  enableval=$enable_dynamic_x86;
-else
-  enable_dynamic_x86=yes
-fi
-
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking whether x86 dynamic cpu core will be enabled" >&5
-$as_echo_n "checking whether x86 dynamic cpu core will be enabled... " >&6; }
-if test x$enable_dynamic_x86 = xno -o x$enable_dynamic_core = xno; then
-   { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
-$as_echo "no" >&6; }
-else
-  if test x$c_targetcpu = xx86 ; then
-      $as_echo "#define C_DYNAMIC_X86 1" >>confdefs.h
-
-      { $as_echo "$as_me:${as_lineno-$LINENO}: result: yes" >&5
-$as_echo "yes" >&6; }
-  else
-      { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
-$as_echo "no" >&6; }
-  fi
-fi
-
-
-# Check whether --enable-dynrec was given.
-if test "${enable_dynrec+set}" = set; then :
-  enableval=$enable_dynrec;
-else
-  enable_dynrec=yes
-fi
-
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking whether recompiling cpu core will be enabled" >&5
-$as_echo_n "checking whether recompiling cpu core will be enabled... " >&6; }
-if test x$enable_dynrec = xno -o x$enable_dynamic_core = xno; then
-   { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
-$as_echo "no" >&6; }
-else
-  if test x$c_targetcpu = xx86 ; then
-    if test x$enable_dynamic_x86 = xno ; then
-        $as_echo "#define C_DYNREC 1" >>confdefs.h
-
-        { $as_echo "$as_me:${as_lineno-$LINENO}: result: yes" >&5
-$as_echo "yes" >&6; }
-    else
-        { $as_echo "$as_me:${as_lineno-$LINENO}: result: no, using dynamic-x86" >&5
-$as_echo "no, using dynamic-x86" >&6; }
-    fi
-  else
-    if test x$c_targetcpu = xx86_64 ; then
-        $as_echo "#define C_DYNREC 1" >>confdefs.h
-
-        { $as_echo "$as_me:${as_lineno-$LINENO}: result: yes" >&5
-$as_echo "yes" >&6; }
-    else
-      { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
-$as_echo "no" >&6; }
-    fi
-  fi
-fi
-
-
-# Check whether --enable-fpu was given.
-if test "${enable_fpu+set}" = set; then :
-  enableval=$enable_fpu;
-else
-  enable_fpu=yes
-fi
-
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking whether fpu emulation will be enabled" >&5
-$as_echo_n "checking whether fpu emulation will be enabled... " >&6; }
-if test x$enable_fpu = xyes ; then
-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: yes" >&5
-$as_echo "yes" >&6; }
-  $as_echo "#define C_FPU 1" >>confdefs.h
-
-else
-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
-$as_echo "no" >&6; }
-fi
-
-
-# Check whether --enable-fpu-x86 was given.
-if test "${enable_fpu_x86+set}" = set; then :
-  enableval=$enable_fpu_x86;
-else
-  enable_fpu_x86=yes
-fi
-
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking whether x86 assembly fpu core will be enabled" >&5
-$as_echo_n "checking whether x86 assembly fpu core will be enabled... " >&6; }
-if test x$enable_fpu_x86 = xno ; then
-   { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
-$as_echo "no" >&6; }
-else
-  if test x$enable_fpu = xyes; then
-    if test x$c_targetcpu = xx86 ; then
-        $as_echo "#define C_FPU_X86 1" >>confdefs.h
-
-        { $as_echo "$as_me:${as_lineno-$LINENO}: result: yes" >&5
-$as_echo "yes" >&6; }
-    else
-        { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
-$as_echo "no" >&6; }
-    fi
-  else
-      { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
-$as_echo "no" >&6; }
-  fi
-fi
-
-
-# Check whether --enable-unaligned_memory was given.
-if test "${enable_unaligned_memory+set}" = set; then :
-  enableval=$enable_unaligned_memory;
-else
-  enable_unaligned_memory=yes
-fi
-
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking whether to enable unaligned memory access" >&5
-$as_echo_n "checking whether to enable unaligned memory access... " >&6; }
-if test x$enable_unaligned_memory = xyes -a x$c_unalignedmemory = xyes; then
-  $as_echo "#define C_UNALIGNED_MEMORY 1" >>confdefs.h
-
-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: yes" >&5
-$as_echo "yes" >&6; }
-else
-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
-$as_echo "no" >&6; }
-fi
-
-
-ac_fn_c_check_header_mongrel "$LINENO" "png.h" "ac_cv_header_png_h" "$ac_includes_default"
-if test "x$ac_cv_header_png_h" = x""yes; then :
-  have_png_h=yes
-fi
-
-
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for png_get_io_ptr in -lpng" >&5
-$as_echo_n "checking for png_get_io_ptr in -lpng... " >&6; }
-if test "${ac_cv_lib_png_png_get_io_ptr+set}" = set; then :
-  $as_echo_n "(cached) " >&6
-else
-  ac_check_lib_save_LIBS=$LIBS
-LIBS="-lpng -lz $LIBS"
-cat confdefs.h - <<_ACEOF >conftest.$ac_ext
-/* end confdefs.h.  */
-
-/* Override any GCC internal prototype to avoid an error.
-   Use char because int might match the return type of a GCC
-   builtin and then its argument prototype would still apply.  */
-#ifdef __cplusplus
-extern "C"
-#endif
-char png_get_io_ptr ();
-int
-main ()
-{
-return png_get_io_ptr ();
-  ;
-  return 0;
-}
-_ACEOF
-if ac_fn_c_try_link "$LINENO"; then :
-  ac_cv_lib_png_png_get_io_ptr=yes
-else
-  ac_cv_lib_png_png_get_io_ptr=no
-fi
-rm -f core conftest.err conftest.$ac_objext \
-    conftest$ac_exeext conftest.$ac_ext
-LIBS=$ac_check_lib_save_LIBS
-fi
-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_lib_png_png_get_io_ptr" >&5
-$as_echo "$ac_cv_lib_png_png_get_io_ptr" >&6; }
-if test "x$ac_cv_lib_png_png_get_io_ptr" = x""yes; then :
-  have_png_lib=yes
-fi
-
-if test x$have_png_lib = xyes -a x$have_png_h = xyes ; then
-  LIBS="$LIBS -lpng -lz"
-  $as_echo "#define C_SSHOT 1" >>confdefs.h
-
-else
-  { $as_echo "$as_me:${as_lineno-$LINENO}: WARNING: Can't find libpng, screenshot support disabled" >&5
-$as_echo "$as_me: WARNING: Can't find libpng, screenshot support disabled" >&2;}
-fi
-
-
-
-ac_fn_c_check_header_mongrel "$LINENO" "SDL_net.h" "ac_cv_header_SDL_net_h" "$ac_includes_default"
-if test "x$ac_cv_header_SDL_net_h" = x""yes; then :
-  have_sdl_net_h=yes
-fi
-
-
-
-if test x$host = xi386-pc-os2-emx ; then
-  { $as_echo "$as_me:${as_lineno-$LINENO}: checking for SDLNet_Init in SDL_net" >&5
-$as_echo_n "checking for SDLNet_Init in SDL_net... " >&6; };
-  LIBS_BACKUP=$LIBS;
-  LIBS="$LIBS -lSDL_Net";
-  cat confdefs.h - <<_ACEOF >conftest.$ac_ext
-/* end confdefs.h.  */
-#include <SDL_Net.h>
-int
-main ()
-{
-
-	SDLNet_Init ();
-
-  ;
-  return 0;
-}
-_ACEOF
-if ac_fn_c_try_link "$LINENO"; then :
-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: yes" >&5
-$as_echo "yes" >&6; }; have_sdl_net_lib=yes
-else
-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
-$as_echo "no" >&6; }
-fi
-rm -f core conftest.err conftest.$ac_objext \
-    conftest$ac_exeext conftest.$ac_ext
-  LIBS=$LIBS_BACKUP
-else
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for SDLNet_Init in -lSDL_net" >&5
-$as_echo_n "checking for SDLNet_Init in -lSDL_net... " >&6; }
-if test "${ac_cv_lib_SDL_net_SDLNet_Init+set}" = set; then :
-  $as_echo_n "(cached) " >&6
-else
-  ac_check_lib_save_LIBS=$LIBS
-LIBS="-lSDL_net  $LIBS"
-cat confdefs.h - <<_ACEOF >conftest.$ac_ext
-/* end confdefs.h.  */
-
-/* Override any GCC internal prototype to avoid an error.
-   Use char because int might match the return type of a GCC
-   builtin and then its argument prototype would still apply.  */
-#ifdef __cplusplus
-extern "C"
-#endif
-char SDLNet_Init ();
-int
-main ()
-{
-return SDLNet_Init ();
-  ;
-  return 0;
-}
-_ACEOF
-if ac_fn_c_try_link "$LINENO"; then :
-  ac_cv_lib_SDL_net_SDLNet_Init=yes
-else
-  ac_cv_lib_SDL_net_SDLNet_Init=no
-fi
-rm -f core conftest.err conftest.$ac_objext \
-    conftest$ac_exeext conftest.$ac_ext
-LIBS=$ac_check_lib_save_LIBS
-fi
-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_lib_SDL_net_SDLNet_Init" >&5
-$as_echo "$ac_cv_lib_SDL_net_SDLNet_Init" >&6; }
-if test "x$ac_cv_lib_SDL_net_SDLNet_Init" = x""yes; then :
-  have_sdl_net_lib=yes
-fi
-
-fi
-if test x$have_sdl_net_lib = xyes -a x$have_sdl_net_h = xyes ; then
-   LIBS="$LIBS -lSDL_net"
-   $as_echo "#define C_MODEM 1" >>confdefs.h
-
-   $as_echo "#define C_IPX 1" >>confdefs.h
-
-else
-   { $as_echo "$as_me:${as_lineno-$LINENO}: WARNING: Can't find SDL_net, internal modem and ipx disabled" >&5
-$as_echo "$as_me: WARNING: Can't find SDL_net, internal modem and ipx disabled" >&2;}
-fi
-
-
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for main in -lX11" >&5
-$as_echo_n "checking for main in -lX11... " >&6; }
-if test "${ac_cv_lib_X11_main+set}" = set; then :
-  $as_echo_n "(cached) " >&6
-else
-  ac_check_lib_save_LIBS=$LIBS
-LIBS="-lX11  $LIBS"
-cat confdefs.h - <<_ACEOF >conftest.$ac_ext
-/* end confdefs.h.  */
-
-
-int
-main ()
-{
-return main ();
-  ;
-  return 0;
-}
-_ACEOF
-if ac_fn_c_try_link "$LINENO"; then :
-  ac_cv_lib_X11_main=yes
-else
-  ac_cv_lib_X11_main=no
-fi
-rm -f core conftest.err conftest.$ac_objext \
-    conftest$ac_exeext conftest.$ac_ext
-LIBS=$ac_check_lib_save_LIBS
-fi
-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_lib_X11_main" >&5
-$as_echo "$ac_cv_lib_X11_main" >&6; }
-if test "x$ac_cv_lib_X11_main" = x""yes; then :
-  have_x11_lib=yes
-else
-  have_x11_lib=no
-fi
-
-ac_fn_c_check_header_mongrel "$LINENO" "X11/XKBlib.h" "ac_cv_header_X11_XKBlib_h" "$ac_includes_default"
-if test "x$ac_cv_header_X11_XKBlib_h" = x""yes; then :
-  have_x11_h=yes
-else
-  have_x11_h=no
-fi
-
-
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for XKBlib support" >&5
-$as_echo_n "checking for XKBlib support... " >&6; }
-if test x$have_x11_lib = xyes -a x$have_x11_h = xyes ; then
-   LIBS="$LIBS -lX11"
-   $as_echo "#define C_X11_XKB 1" >>confdefs.h
-
-   { $as_echo "$as_me:${as_lineno-$LINENO}: result: yes" >&5
-$as_echo "yes" >&6; }
-else
-   { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
-$as_echo "no" >&6; }
-fi
-
-
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for main in -lGL" >&5
-$as_echo_n "checking for main in -lGL... " >&6; }
-if test "${ac_cv_lib_GL_main+set}" = set; then :
-  $as_echo_n "(cached) " >&6
-else
-  ac_check_lib_save_LIBS=$LIBS
-LIBS="-lGL  $LIBS"
-cat confdefs.h - <<_ACEOF >conftest.$ac_ext
-/* end confdefs.h.  */
-
-
-int
-main ()
-{
-return main ();
-  ;
-  return 0;
-}
-_ACEOF
-if ac_fn_c_try_link "$LINENO"; then :
-  ac_cv_lib_GL_main=yes
-else
-  ac_cv_lib_GL_main=no
-fi
-rm -f core conftest.err conftest.$ac_objext \
-    conftest$ac_exeext conftest.$ac_ext
-LIBS=$ac_check_lib_save_LIBS
-fi
-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_lib_GL_main" >&5
-$as_echo "$ac_cv_lib_GL_main" >&6; }
-if test "x$ac_cv_lib_GL_main" = x""yes; then :
-  have_gl_lib=yes
-else
-  have_gl_lib=no
-fi
-
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for main in -lopengl32" >&5
-$as_echo_n "checking for main in -lopengl32... " >&6; }
-if test "${ac_cv_lib_opengl32_main+set}" = set; then :
-  $as_echo_n "(cached) " >&6
-else
-  ac_check_lib_save_LIBS=$LIBS
-LIBS="-lopengl32  $LIBS"
-cat confdefs.h - <<_ACEOF >conftest.$ac_ext
-/* end confdefs.h.  */
-
-
-int
-main ()
-{
-return main ();
-  ;
-  return 0;
-}
-_ACEOF
-if ac_fn_c_try_link "$LINENO"; then :
-  ac_cv_lib_opengl32_main=yes
-else
-  ac_cv_lib_opengl32_main=no
-fi
-rm -f core conftest.err conftest.$ac_objext \
-    conftest$ac_exeext conftest.$ac_ext
-LIBS=$ac_check_lib_save_LIBS
-fi
-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_lib_opengl32_main" >&5
-$as_echo "$ac_cv_lib_opengl32_main" >&6; }
-if test "x$ac_cv_lib_opengl32_main" = x""yes; then :
-  have_opengl32_lib=yes
-else
-  have_opengl32_lib=no
-fi
-
-ac_fn_c_check_header_mongrel "$LINENO" "GL/gl.h" "ac_cv_header_GL_gl_h" "$ac_includes_default"
-if test "x$ac_cv_header_GL_gl_h" = x""yes; then :
-  have_gl_h=yes
-else
-  have_gl_h=no
-fi
-
-
-# Check whether --enable-opengl was given.
-if test "${enable_opengl+set}" = set; then :
-  enableval=$enable_opengl;
-else
-  enable_opengl=yes
-fi
-
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking whether opengl display output will be enabled" >&5
-$as_echo_n "checking whether opengl display output will be enabled... " >&6; }
-if test x$enable_opengl = xyes; then
-case "$host" in
-    *-*-darwin*)
-       { $as_echo "$as_me:${as_lineno-$LINENO}: result: yes" >&5
-$as_echo "yes" >&6; }
-       LIBS="$LIBS -framework OpenGL"
-       $as_echo "#define C_OPENGL 1" >>confdefs.h
-
-       ;;
-    *)
-       if test x$have_gl_h = xyes -a x$have_gl_lib = xyes ; then
-         { $as_echo "$as_me:${as_lineno-$LINENO}: result: yes" >&5
-$as_echo "yes" >&6; }
-         LIBS="$LIBS -lGL"
-         $as_echo "#define C_OPENGL 1" >>confdefs.h
-
-       elif test x$have_gl_h = xyes -a x$have_opengl32_lib = xyes ; then
-         { $as_echo "$as_me:${as_lineno-$LINENO}: result: yes" >&5
-$as_echo "yes" >&6; }
-         LIBS="$LIBS -lopengl32"
-         $as_echo "#define C_OPENGL 1" >>confdefs.h
-
-       else
-         { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
-$as_echo "no" >&6; }
-       fi
-       ;;
-esac
-fi
-
-
-ac_fn_c_check_header_mongrel "$LINENO" "SDL_sound.h" "ac_cv_header_SDL_sound_h" "$ac_includes_default"
-if test "x$ac_cv_header_SDL_sound_h" = x""yes; then :
-  have_SDL_sound_h=yes
-fi
-
-
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for Sound_Init in -lSDL_sound" >&5
-$as_echo_n "checking for Sound_Init in -lSDL_sound... " >&6; }
-if test "${ac_cv_lib_SDL_sound_Sound_Init+set}" = set; then :
-  $as_echo_n "(cached) " >&6
-else
-  ac_check_lib_save_LIBS=$LIBS
-LIBS="-lSDL_sound  $LIBS"
-cat confdefs.h - <<_ACEOF >conftest.$ac_ext
-/* end confdefs.h.  */
-
-/* Override any GCC internal prototype to avoid an error.
-   Use char because int might match the return type of a GCC
-   builtin and then its argument prototype would still apply.  */
-#ifdef __cplusplus
-extern "C"
-#endif
-char Sound_Init ();
-int
-main ()
-{
-return Sound_Init ();
-  ;
-  return 0;
-}
-_ACEOF
-if ac_fn_c_try_link "$LINENO"; then :
-  ac_cv_lib_SDL_sound_Sound_Init=yes
-else
-  ac_cv_lib_SDL_sound_Sound_Init=no
-fi
-rm -f core conftest.err conftest.$ac_objext \
-    conftest$ac_exeext conftest.$ac_ext
-LIBS=$ac_check_lib_save_LIBS
-fi
-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_lib_SDL_sound_Sound_Init" >&5
-$as_echo "$ac_cv_lib_SDL_sound_Sound_Init" >&6; }
-if test "x$ac_cv_lib_SDL_sound_Sound_Init" = x""yes; then :
-  have_SDL_sound_init=yes
-fi
-
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for Sound_Seek in -lSDL_sound" >&5
-$as_echo_n "checking for Sound_Seek in -lSDL_sound... " >&6; }
-if test "${ac_cv_lib_SDL_sound_Sound_Seek+set}" = set; then :
-  $as_echo_n "(cached) " >&6
-else
-  ac_check_lib_save_LIBS=$LIBS
-LIBS="-lSDL_sound  $LIBS"
-cat confdefs.h - <<_ACEOF >conftest.$ac_ext
-/* end confdefs.h.  */
-
-/* Override any GCC internal prototype to avoid an error.
-   Use char because int might match the return type of a GCC
-   builtin and then its argument prototype would still apply.  */
-#ifdef __cplusplus
-extern "C"
-#endif
-char Sound_Seek ();
-int
-main ()
-{
-return Sound_Seek ();
-  ;
-  return 0;
-}
-_ACEOF
-if ac_fn_c_try_link "$LINENO"; then :
-  ac_cv_lib_SDL_sound_Sound_Seek=yes
-else
-  ac_cv_lib_SDL_sound_Sound_Seek=no
-fi
-rm -f core conftest.err conftest.$ac_objext \
-    conftest$ac_exeext conftest.$ac_ext
-LIBS=$ac_check_lib_save_LIBS
-fi
-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_lib_SDL_sound_Sound_Seek" >&5
-$as_echo "$ac_cv_lib_SDL_sound_Sound_Seek" >&6; }
-if test "x$ac_cv_lib_SDL_sound_Sound_Seek" = x""yes; then :
-  have_SDL_sound_seek=yes
-fi
-
-if test x$have_SDL_sound_h = xyes -a x$have_SDL_sound_init = xyes ; then
-  if test x$have_SDL_sound_seek = xyes ; then
-    LIBS="-lSDL_sound $LIBS"
-    $as_echo "#define C_SDL_SOUND 1" >>confdefs.h
-
-   else
-     { $as_echo "$as_me:${as_lineno-$LINENO}: WARNING: Can't find SoundSeek in libSDL_Sound, libSDL_sound support disabled" >&5
-$as_echo "$as_me: WARNING: Can't find SoundSeek in libSDL_Sound, libSDL_sound support disabled" >&2;}
-   fi
-else
-  { $as_echo "$as_me:${as_lineno-$LINENO}: WARNING: Can't find libSDL_sound, libSDL_sound support disabled" >&5
-$as_echo "$as_me: WARNING: Can't find libSDL_sound, libSDL_sound support disabled" >&2;}
-fi
-
-
-ac_fn_c_check_header_mongrel "$LINENO" "sys/mman.h" "ac_cv_header_sys_mman_h" "$ac_includes_default"
-if test "x$ac_cv_header_sys_mman_h" = x""yes; then :
-
-ac_fn_c_check_func "$LINENO" "mprotect" "ac_cv_func_mprotect"
-if test "x$ac_cv_func_mprotect" = x""yes; then :
-  $as_echo "#define C_HAVE_MPROTECT 1" >>confdefs.h
-
-fi
-
-
-fi
-
-
-
-
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for setpriority support" >&5
-$as_echo_n "checking for setpriority support... " >&6; }
-cat confdefs.h - <<_ACEOF >conftest.$ac_ext
-/* end confdefs.h.  */
-
-#include <sys/resource.h>
-int main(int argc,char * argv) {
-	return setpriority (PRIO_PROCESS, 0,PRIO_MIN+PRIO_MAX);
-};
-
-_ACEOF
-if ac_fn_c_try_link "$LINENO"; then :
-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: yes" >&5
-$as_echo "yes" >&6; };$as_echo "#define C_SET_PRIORITY 1" >>confdefs.h
-
-else
-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
-$as_echo "no" >&6; }
-fi
-rm -f core conftest.err conftest.$ac_objext \
-    conftest$ac_exeext conftest.$ac_ext
-
-
-case "$host" in
-    *-*-cygwin* | *-*-mingw32*)
-       LIBS="$LIBS -lwinmm"
-       for ac_header in ddraw.h
-do :
-  ac_fn_c_check_header_mongrel "$LINENO" "ddraw.h" "ac_cv_header_ddraw_h" "$ac_includes_default"
-if test "x$ac_cv_header_ddraw_h" = x""yes; then :
-  cat >>confdefs.h <<_ACEOF
-#define HAVE_DDRAW_H 1
-_ACEOF
-
-fi
-
-done
-
-
-$as_echo "#define C_DIRECTSERIAL 1" >>confdefs.h
-
-       if test x$have_sdl_net_lib = xyes -a x$have_sdl_net_h = xyes ; then
-         LIBS="$LIBS -lws2_32"
-       fi
-       ;;
-    *-*-darwin*)
-
-$as_echo "#define MACOSX 1" >>confdefs.h
-
-       LIBS="$LIBS -framework CoreMIDI -framework AudioUnit -framework AudioToolbox"
-
-$as_echo "#define C_DIRECTSERIAL 1" >>confdefs.h
-
-       ;;
-    *-*-linux*)
-
-$as_echo "#define LINUX 1" >>confdefs.h
-
-
-$as_echo "#define C_DIRECTSERIAL 1" >>confdefs.h
-
-       ;;
-    *-*-freebsd* | *-*-dragonfly* | *-*-netbsd* | *-*-openbsd*)
-
-$as_echo "#define BSD 1" >>confdefs.h
-
-
-$as_echo "#define C_DIRECTSERIAL 1" >>confdefs.h
-
-       ;;
-    *-*-os2-emx*)
-
-$as_echo "#define OS2 1" >>confdefs.h
-
-
-$as_echo "#define C_DIRECTSERIAL 1" >>confdefs.h
-
-       ;;
-esac
-
-case "$host" in
-    *-*-cygwin* | *-*-mingw32*)
-              if test -n "$ac_tool_prefix"; then
-  # Extract the first word of "${ac_tool_prefix}windres", so it can be a program name with args.
-set dummy ${ac_tool_prefix}windres; ac_word=$2
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for $ac_word" >&5
-$as_echo_n "checking for $ac_word... " >&6; }
-if test "${ac_cv_prog_WINDRES+set}" = set; then :
-  $as_echo_n "(cached) " >&6
-else
-  if test -n "$WINDRES"; then
-  ac_cv_prog_WINDRES="$WINDRES" # Let the user override the test.
-else
-as_save_IFS=$IFS; IFS=$PATH_SEPARATOR
-for as_dir in $PATH
-do
-  IFS=$as_save_IFS
-  test -z "$as_dir" && as_dir=.
-    for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
-    ac_cv_prog_WINDRES="${ac_tool_prefix}windres"
-    $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
-    break 2
-  fi
-done
-  done
-IFS=$as_save_IFS
-
-fi
-fi
-WINDRES=$ac_cv_prog_WINDRES
-if test -n "$WINDRES"; then
-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: $WINDRES" >&5
-$as_echo "$WINDRES" >&6; }
-else
-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
-$as_echo "no" >&6; }
-fi
-
-
-fi
-if test -z "$ac_cv_prog_WINDRES"; then
-  ac_ct_WINDRES=$WINDRES
-  # Extract the first word of "windres", so it can be a program name with args.
-set dummy windres; ac_word=$2
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for $ac_word" >&5
-$as_echo_n "checking for $ac_word... " >&6; }
-if test "${ac_cv_prog_ac_ct_WINDRES+set}" = set; then :
-  $as_echo_n "(cached) " >&6
-else
-  if test -n "$ac_ct_WINDRES"; then
-  ac_cv_prog_ac_ct_WINDRES="$ac_ct_WINDRES" # Let the user override the test.
-else
-as_save_IFS=$IFS; IFS=$PATH_SEPARATOR
-for as_dir in $PATH
-do
-  IFS=$as_save_IFS
-  test -z "$as_dir" && as_dir=.
-    for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
-    ac_cv_prog_ac_ct_WINDRES="windres"
-    $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
-    break 2
-  fi
-done
-  done
-IFS=$as_save_IFS
-
-fi
-fi
-ac_ct_WINDRES=$ac_cv_prog_ac_ct_WINDRES
-if test -n "$ac_ct_WINDRES"; then
-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_ct_WINDRES" >&5
-$as_echo "$ac_ct_WINDRES" >&6; }
-else
-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
-$as_echo "no" >&6; }
-fi
-
-  if test "x$ac_ct_WINDRES" = x; then
-    WINDRES=":"
-  else
-    case $cross_compiling:$ac_tool_warned in
-yes:)
-{ $as_echo "$as_me:${as_lineno-$LINENO}: WARNING: using cross tools not prefixed with host triplet" >&5
-$as_echo "$as_me: WARNING: using cross tools not prefixed with host triplet" >&2;}
-ac_tool_warned=yes ;;
-esac
-    WINDRES=$ac_ct_WINDRES
-  fi
-else
-  WINDRES="$ac_cv_prog_WINDRES"
-fi
-
-    ;;
-    *)
-       WINDRES=":"
-    ;;
-esac
-        if test "x$WINDRES" != "x:"; then
-  HAVE_WINDRES_TRUE=
-  HAVE_WINDRES_FALSE='#'
-else
-  HAVE_WINDRES_TRUE='#'
-  HAVE_WINDRES_FALSE=
-fi
-
-
-
-
-ac_config_files="$ac_config_files Makefile src/Makefile src/cpu/Makefile src/cpu/core_full/Makefile src/cpu/core_normal/Makefile src/cpu/core_dyn_x86/Makefile src/cpu/core_dynrec/Makefile src/debug/Makefile src/dos/Makefile src/fpu/Makefile src/gui/Makefile src/hardware/Makefile src/hardware/serialport/Makefile src/ints/Makefile src/libs/Makefile src/libs/zmbv/Makefile src/libs/gui_tk/Makefile src/misc/Makefile src/shell/Makefile src/platform/Makefile src/platform/visualc/Makefile visualc_net/Makefile include/Makefile docs/Makefile"
-
-cat >confcache <<\_ACEOF
-# This file is a shell script that caches the results of configure
-# tests run on this system so they can be shared between configure
-# scripts and configure runs, see configure's option --config-cache.
-# It is not useful on other systems.  If it contains results you don't
-# want to keep, you may remove or edit it.
-#
-# config.status only pays attention to the cache file if you give it
-# the --recheck option to rerun configure.
-#
-# `ac_cv_env_foo' variables (set or unset) will be overridden when
-# loading this file, other *unset* `ac_cv_foo' will be assigned the
-# following values.
-
-_ACEOF
-
-# The following way of writing the cache mishandles newlines in values,
-# but we know of no workaround that is simple, portable, and efficient.
-# So, we kill variables containing newlines.
-# Ultrix sh set writes to stderr and can't be redirected directly,
-# and sets the high bit in the cache file unless we assign to the vars.
-(
-  for ac_var in `(set) 2>&1 | sed -n 's/^\([a-zA-Z_][a-zA-Z0-9_]*\)=.*/\1/p'`; do
-    eval ac_val=\$$ac_var
-    case $ac_val in #(
-    *${as_nl}*)
-      case $ac_var in #(
-      *_cv_*) { $as_echo "$as_me:${as_lineno-$LINENO}: WARNING: cache variable $ac_var contains a newline" >&5
-$as_echo "$as_me: WARNING: cache variable $ac_var contains a newline" >&2;} ;;
-      esac
-      case $ac_var in #(
-      _ | IFS | as_nl) ;; #(
-      BASH_ARGV | BASH_SOURCE) eval $ac_var= ;; #(
-      *) { eval $ac_var=; unset $ac_var;} ;;
-      esac ;;
-    esac
-  done
-
-  (set) 2>&1 |
-    case $as_nl`(ac_space=' '; set) 2>&1` in #(
-    *${as_nl}ac_space=\ *)
-      # `set' does not quote correctly, so add quotes: double-quote
-      # substitution turns \\\\ into \\, and sed turns \\ into \.
-      sed -n \
-	"s/'/'\\\\''/g;
-	  s/^\\([_$as_cr_alnum]*_cv_[_$as_cr_alnum]*\\)=\\(.*\\)/\\1='\\2'/p"
-      ;; #(
-    *)
-      # `set' quotes correctly as required by POSIX, so do not add quotes.
-      sed -n "/^[_$as_cr_alnum]*_cv_[_$as_cr_alnum]*=/p"
-      ;;
-    esac |
-    sort
-) |
-  sed '
-     /^ac_cv_env_/b end
-     t clear
-     :clear
-     s/^\([^=]*\)=\(.*[{}].*\)$/test "${\1+set}" = set || &/
-     t end
-     s/^\([^=]*\)=\(.*\)$/\1=${\1=\2}/
-     :end' >>confcache
-if diff "$cache_file" confcache >/dev/null 2>&1; then :; else
-  if test -w "$cache_file"; then
-    test "x$cache_file" != "x/dev/null" &&
-      { $as_echo "$as_me:${as_lineno-$LINENO}: updating cache $cache_file" >&5
-$as_echo "$as_me: updating cache $cache_file" >&6;}
-    cat confcache >$cache_file
-  else
-    { $as_echo "$as_me:${as_lineno-$LINENO}: not updating unwritable cache $cache_file" >&5
-$as_echo "$as_me: not updating unwritable cache $cache_file" >&6;}
-  fi
-fi
-rm -f confcache
-
-test "x$prefix" = xNONE && prefix=$ac_default_prefix
-# Let make expand exec_prefix.
-test "x$exec_prefix" = xNONE && exec_prefix='${prefix}'
-
-DEFS=-DHAVE_CONFIG_H
-
-ac_libobjs=
-ac_ltlibobjs=
-for ac_i in : $LIBOBJS; do test "x$ac_i" = x: && continue
-  # 1. Remove the extension, and $U if already installed.
-  ac_script='s/\$U\././;s/\.o$//;s/\.obj$//'
-  ac_i=`$as_echo "$ac_i" | sed "$ac_script"`
-  # 2. Prepend LIBOBJDIR.  When used with automake>=1.10 LIBOBJDIR
-  #    will be set to the directory where LIBOBJS objects are built.
-  as_fn_append ac_libobjs " \${LIBOBJDIR}$ac_i\$U.$ac_objext"
-  as_fn_append ac_ltlibobjs " \${LIBOBJDIR}$ac_i"'$U.lo'
-done
-LIBOBJS=$ac_libobjs
-
-LTLIBOBJS=$ac_ltlibobjs
-
-
- if test -n "$EXEEXT"; then
-  am__EXEEXT_TRUE=
-  am__EXEEXT_FALSE='#'
-else
-  am__EXEEXT_TRUE='#'
-  am__EXEEXT_FALSE=
-fi
-
-if test -z "${AMDEP_TRUE}" && test -z "${AMDEP_FALSE}"; then
-  as_fn_error "conditional \"AMDEP\" was never defined.
-Usually this means the macro was only invoked conditionally." "$LINENO" 5
-fi
-if test -z "${am__fastdepCC_TRUE}" && test -z "${am__fastdepCC_FALSE}"; then
-  as_fn_error "conditional \"am__fastdepCC\" was never defined.
-Usually this means the macro was only invoked conditionally." "$LINENO" 5
-fi
-if test -z "${am__fastdepCXX_TRUE}" && test -z "${am__fastdepCXX_FALSE}"; then
-  as_fn_error "conditional \"am__fastdepCXX\" was never defined.
-Usually this means the macro was only invoked conditionally." "$LINENO" 5
-fi
-
-if test -z "${HAVE_WINDRES_TRUE}" && test -z "${HAVE_WINDRES_FALSE}"; then
-  as_fn_error "conditional \"HAVE_WINDRES\" was never defined.
-Usually this means the macro was only invoked conditionally." "$LINENO" 5
-fi
-
-: ${CONFIG_STATUS=./config.status}
-ac_write_fail=0
-ac_clean_files_save=$ac_clean_files
-ac_clean_files="$ac_clean_files $CONFIG_STATUS"
-{ $as_echo "$as_me:${as_lineno-$LINENO}: creating $CONFIG_STATUS" >&5
-$as_echo "$as_me: creating $CONFIG_STATUS" >&6;}
-as_write_fail=0
-cat >$CONFIG_STATUS <<_ASEOF || as_write_fail=1
-#! $SHELL
-# Generated by $as_me.
-# Run this file to recreate the current configuration.
-# Compiler output produced by configure, useful for debugging
-# configure, is in config.log if it exists.
-
-debug=false
-ac_cs_recheck=false
-ac_cs_silent=false
-
-SHELL=\${CONFIG_SHELL-$SHELL}
-export SHELL
-_ASEOF
-cat >>$CONFIG_STATUS <<\_ASEOF || as_write_fail=1
-## -------------------- ##
-## M4sh Initialization. ##
-## -------------------- ##
-
-# Be more Bourne compatible
-DUALCASE=1; export DUALCASE # for MKS sh
-if test -n "${ZSH_VERSION+set}" && (emulate sh) >/dev/null 2>&1; then :
-  emulate sh
-  NULLCMD=:
-  # Pre-4.2 versions of Zsh do word splitting on ${1+"$@"}, which
-  # is contrary to our usage.  Disable this feature.
-  alias -g '${1+"$@"}'='"$@"'
-  setopt NO_GLOB_SUBST
-else
-  case `(set -o) 2>/dev/null` in #(
-  *posix*) :
-    set -o posix ;; #(
-  *) :
-     ;;
-esac
-fi
-
-
-as_nl='
-'
-export as_nl
-# Printing a long string crashes Solaris 7 /usr/bin/printf.
-as_echo='\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\'
-as_echo=$as_echo$as_echo$as_echo$as_echo$as_echo
-as_echo=$as_echo$as_echo$as_echo$as_echo$as_echo$as_echo
-# Prefer a ksh shell builtin over an external printf program on Solaris,
-# but without wasting forks for bash or zsh.
-if test -z "$BASH_VERSION$ZSH_VERSION" \
-    && (test "X`print -r -- $as_echo`" = "X$as_echo") 2>/dev/null; then
-  as_echo='print -r --'
-  as_echo_n='print -rn --'
-elif (test "X`printf %s $as_echo`" = "X$as_echo") 2>/dev/null; then
-  as_echo='printf %s\n'
-  as_echo_n='printf %s'
-else
-  if test "X`(/usr/ucb/echo -n -n $as_echo) 2>/dev/null`" = "X-n $as_echo"; then
-    as_echo_body='eval /usr/ucb/echo -n "$1$as_nl"'
-    as_echo_n='/usr/ucb/echo -n'
-  else
-    as_echo_body='eval expr "X$1" : "X\\(.*\\)"'
-    as_echo_n_body='eval
-      arg=$1;
-      case $arg in #(
-      *"$as_nl"*)
-	expr "X$arg" : "X\\(.*\\)$as_nl";
-	arg=`expr "X$arg" : ".*$as_nl\\(.*\\)"`;;
-      esac;
-      expr "X$arg" : "X\\(.*\\)" | tr -d "$as_nl"
-    '
-    export as_echo_n_body
-    as_echo_n='sh -c $as_echo_n_body as_echo'
-  fi
-  export as_echo_body
-  as_echo='sh -c $as_echo_body as_echo'
-fi
-
-# The user is always right.
-if test "${PATH_SEPARATOR+set}" != set; then
-  PATH_SEPARATOR=:
-  (PATH='/bin;/bin'; FPATH=$PATH; sh -c :) >/dev/null 2>&1 && {
-    (PATH='/bin:/bin'; FPATH=$PATH; sh -c :) >/dev/null 2>&1 ||
-      PATH_SEPARATOR=';'
-  }
-fi
-
-
-# IFS
-# We need space, tab and new line, in precisely that order.  Quoting is
-# there to prevent editors from complaining about space-tab.
-# (If _AS_PATH_WALK were called with IFS unset, it would disable word
-# splitting by setting IFS to empty value.)
-IFS=" ""	$as_nl"
-
-# Find who we are.  Look in the path if we contain no directory separator.
-case $0 in #((
-  *[\\/]* ) as_myself=$0 ;;
-  *) as_save_IFS=$IFS; IFS=$PATH_SEPARATOR
-for as_dir in $PATH
-do
-  IFS=$as_save_IFS
-  test -z "$as_dir" && as_dir=.
-    test -r "$as_dir/$0" && as_myself=$as_dir/$0 && break
-  done
-IFS=$as_save_IFS
-
-     ;;
-esac
-# We did not find ourselves, most probably we were run as `sh COMMAND'
-# in which case we are not to be found in the path.
-if test "x$as_myself" = x; then
-  as_myself=$0
-fi
-if test ! -f "$as_myself"; then
-  $as_echo "$as_myself: error: cannot find myself; rerun with an absolute file name" >&2
-  exit 1
-fi
-
-# Unset variables that we do not need and which cause bugs (e.g. in
-# pre-3.0 UWIN ksh).  But do not cause bugs in bash 2.01; the "|| exit 1"
-# suppresses any "Segmentation fault" message there.  '((' could
-# trigger a bug in pdksh 5.2.14.
-for as_var in BASH_ENV ENV MAIL MAILPATH
-do eval test x\${$as_var+set} = xset \
-  && ( (unset $as_var) || exit 1) >/dev/null 2>&1 && unset $as_var || :
-done
-PS1='$ '
-PS2='> '
-PS4='+ '
-
-# NLS nuisances.
-LC_ALL=C
-export LC_ALL
-LANGUAGE=C
-export LANGUAGE
-
-# CDPATH.
-(unset CDPATH) >/dev/null 2>&1 && unset CDPATH
-
-
-# as_fn_error ERROR [LINENO LOG_FD]
-# ---------------------------------
-# Output "`basename $0`: error: ERROR" to stderr. If LINENO and LOG_FD are
-# provided, also output the error to LOG_FD, referencing LINENO. Then exit the
-# script with status $?, using 1 if that was 0.
-as_fn_error ()
-{
-  as_status=$?; test $as_status -eq 0 && as_status=1
-  if test "$3"; then
-    as_lineno=${as_lineno-"$2"} as_lineno_stack=as_lineno_stack=$as_lineno_stack
-    $as_echo "$as_me:${as_lineno-$LINENO}: error: $1" >&$3
-  fi
-  $as_echo "$as_me: error: $1" >&2
-  as_fn_exit $as_status
-} # as_fn_error
-
-
-# as_fn_set_status STATUS
-# -----------------------
-# Set $? to STATUS, without forking.
-as_fn_set_status ()
-{
-  return $1
-} # as_fn_set_status
-
-# as_fn_exit STATUS
-# -----------------
-# Exit the shell with STATUS, even in a "trap 0" or "set -e" context.
-as_fn_exit ()
-{
-  set +e
-  as_fn_set_status $1
-  exit $1
-} # as_fn_exit
-
-# as_fn_unset VAR
-# ---------------
-# Portably unset VAR.
-as_fn_unset ()
-{
-  { eval $1=; unset $1;}
-}
-as_unset=as_fn_unset
-# as_fn_append VAR VALUE
-# ----------------------
-# Append the text in VALUE to the end of the definition contained in VAR. Take
-# advantage of any shell optimizations that allow amortized linear growth over
-# repeated appends, instead of the typical quadratic growth present in naive
-# implementations.
-if (eval "as_var=1; as_var+=2; test x\$as_var = x12") 2>/dev/null; then :
-  eval 'as_fn_append ()
-  {
-    eval $1+=\$2
-  }'
-else
-  as_fn_append ()
-  {
-    eval $1=\$$1\$2
-  }
-fi # as_fn_append
-
-# as_fn_arith ARG...
-# ------------------
-# Perform arithmetic evaluation on the ARGs, and store the result in the
-# global $as_val. Take advantage of shells that can avoid forks. The arguments
-# must be portable across $(()) and expr.
-if (eval "test \$(( 1 + 1 )) = 2") 2>/dev/null; then :
-  eval 'as_fn_arith ()
-  {
-    as_val=$(( $* ))
-  }'
-else
-  as_fn_arith ()
-  {
-    as_val=`expr "$@" || test $? -eq 1`
-  }
-fi # as_fn_arith
-
-
-if expr a : '\(a\)' >/dev/null 2>&1 &&
-   test "X`expr 00001 : '.*\(...\)'`" = X001; then
-  as_expr=expr
-else
-  as_expr=false
-fi
-
-if (basename -- /) >/dev/null 2>&1 && test "X`basename -- / 2>&1`" = "X/"; then
-  as_basename=basename
-else
-  as_basename=false
-fi
-
-if (as_dir=`dirname -- /` && test "X$as_dir" = X/) >/dev/null 2>&1; then
-  as_dirname=dirname
-else
-  as_dirname=false
-fi
-
-as_me=`$as_basename -- "$0" ||
-$as_expr X/"$0" : '.*/\([^/][^/]*\)/*$' \| \
-	 X"$0" : 'X\(//\)$' \| \
-	 X"$0" : 'X\(/\)' \| . 2>/dev/null ||
-$as_echo X/"$0" |
-    sed '/^.*\/\([^/][^/]*\)\/*$/{
-	    s//\1/
-	    q
-	  }
-	  /^X\/\(\/\/\)$/{
-	    s//\1/
-	    q
-	  }
-	  /^X\/\(\/\).*/{
-	    s//\1/
-	    q
-	  }
-	  s/.*/./; q'`
-
-# Avoid depending upon Character Ranges.
-as_cr_letters='abcdefghijklmnopqrstuvwxyz'
-as_cr_LETTERS='ABCDEFGHIJKLMNOPQRSTUVWXYZ'
-as_cr_Letters=$as_cr_letters$as_cr_LETTERS
-as_cr_digits='0123456789'
-as_cr_alnum=$as_cr_Letters$as_cr_digits
-
-ECHO_C= ECHO_N= ECHO_T=
-case `echo -n x` in #(((((
--n*)
-  case `echo 'xy\c'` in
-  *c*) ECHO_T='	';;	# ECHO_T is single tab character.
-  xy)  ECHO_C='\c';;
-  *)   echo `echo ksh88 bug on AIX 6.1` > /dev/null
-       ECHO_T='	';;
-  esac;;
-*)
-  ECHO_N='-n';;
-esac
-
-rm -f conf$$ conf$$.exe conf$$.file
-if test -d conf$$.dir; then
-  rm -f conf$$.dir/conf$$.file
-else
-  rm -f conf$$.dir
-  mkdir conf$$.dir 2>/dev/null
-fi
-if (echo >conf$$.file) 2>/dev/null; then
-  if ln -s conf$$.file conf$$ 2>/dev/null; then
-    as_ln_s='ln -s'
-    # ... but there are two gotchas:
-    # 1) On MSYS, both `ln -s file dir' and `ln file dir' fail.
-    # 2) DJGPP < 2.04 has no symlinks; `ln -s' creates a wrapper executable.
-    # In both cases, we have to default to `cp -p'.
-    ln -s conf$$.file conf$$.dir 2>/dev/null && test ! -f conf$$.exe ||
-      as_ln_s='cp -p'
-  elif ln conf$$.file conf$$ 2>/dev/null; then
-    as_ln_s=ln
-  else
-    as_ln_s='cp -p'
-  fi
-else
-  as_ln_s='cp -p'
-fi
-rm -f conf$$ conf$$.exe conf$$.dir/conf$$.file conf$$.file
-rmdir conf$$.dir 2>/dev/null
-
-
-# as_fn_mkdir_p
-# -------------
-# Create "$as_dir" as a directory, including parents if necessary.
-as_fn_mkdir_p ()
-{
-
-  case $as_dir in #(
-  -*) as_dir=./$as_dir;;
-  esac
-  test -d "$as_dir" || eval $as_mkdir_p || {
-    as_dirs=
-    while :; do
-      case $as_dir in #(
-      *\'*) as_qdir=`$as_echo "$as_dir" | sed "s/'/'\\\\\\\\''/g"`;; #'(
-      *) as_qdir=$as_dir;;
-      esac
-      as_dirs="'$as_qdir' $as_dirs"
-      as_dir=`$as_dirname -- "$as_dir" ||
-$as_expr X"$as_dir" : 'X\(.*[^/]\)//*[^/][^/]*/*$' \| \
-	 X"$as_dir" : 'X\(//\)[^/]' \| \
-	 X"$as_dir" : 'X\(//\)$' \| \
-	 X"$as_dir" : 'X\(/\)' \| . 2>/dev/null ||
-$as_echo X"$as_dir" |
-    sed '/^X\(.*[^/]\)\/\/*[^/][^/]*\/*$/{
-	    s//\1/
-	    q
-	  }
-	  /^X\(\/\/\)[^/].*/{
-	    s//\1/
-	    q
-	  }
-	  /^X\(\/\/\)$/{
-	    s//\1/
-	    q
-	  }
-	  /^X\(\/\).*/{
-	    s//\1/
-	    q
-	  }
-	  s/.*/./; q'`
-      test -d "$as_dir" && break
-    done
-    test -z "$as_dirs" || eval "mkdir $as_dirs"
-  } || test -d "$as_dir" || as_fn_error "cannot create directory $as_dir"
-
-
-} # as_fn_mkdir_p
-if mkdir -p . 2>/dev/null; then
-  as_mkdir_p='mkdir -p "$as_dir"'
-else
-  test -d ./-p && rmdir ./-p
-  as_mkdir_p=false
-fi
-
-if test -x / >/dev/null 2>&1; then
-  as_test_x='test -x'
-else
-  if ls -dL / >/dev/null 2>&1; then
-    as_ls_L_option=L
-  else
-    as_ls_L_option=
-  fi
-  as_test_x='
-    eval sh -c '\''
-      if test -d "$1"; then
-	test -d "$1/.";
-      else
-	case $1 in #(
-	-*)set "./$1";;
-	esac;
-	case `ls -ld'$as_ls_L_option' "$1" 2>/dev/null` in #((
-	???[sx]*):;;*)false;;esac;fi
-    '\'' sh
-  '
-fi
-as_executable_p=$as_test_x
-
-# Sed expression to map a string onto a valid CPP name.
-as_tr_cpp="eval sed 'y%*$as_cr_letters%P$as_cr_LETTERS%;s%[^_$as_cr_alnum]%_%g'"
-
-# Sed expression to map a string onto a valid variable name.
-as_tr_sh="eval sed 'y%*+%pp%;s%[^_$as_cr_alnum]%_%g'"
-
-
-exec 6>&1
-## ----------------------------------- ##
-## Main body of $CONFIG_STATUS script. ##
-## ----------------------------------- ##
-_ASEOF
-test $as_write_fail = 0 && chmod +x $CONFIG_STATUS || ac_write_fail=1
-
-cat >>$CONFIG_STATUS <<\_ACEOF || ac_write_fail=1
-# Save the log message, to keep $0 and so on meaningful, and to
-# report actual input values of CONFIG_FILES etc. instead of their
-# values after options handling.
-ac_log="
-This file was extended by dosbox $as_me 0.74, which was
-generated by GNU Autoconf 2.65.  Invocation command line was
-
-  CONFIG_FILES    = $CONFIG_FILES
-  CONFIG_HEADERS  = $CONFIG_HEADERS
-  CONFIG_LINKS    = $CONFIG_LINKS
-  CONFIG_COMMANDS = $CONFIG_COMMANDS
-  $ $0 $@
-
-on `(hostname || uname -n) 2>/dev/null | sed 1q`
-"
-
-_ACEOF
-
-case $ac_config_files in *"
-"*) set x $ac_config_files; shift; ac_config_files=$*;;
-esac
-
-case $ac_config_headers in *"
-"*) set x $ac_config_headers; shift; ac_config_headers=$*;;
-esac
-
-
-cat >>$CONFIG_STATUS <<_ACEOF || ac_write_fail=1
-# Files that config.status was made for.
-config_files="$ac_config_files"
-config_headers="$ac_config_headers"
-config_commands="$ac_config_commands"
-
-_ACEOF
-
-cat >>$CONFIG_STATUS <<\_ACEOF || ac_write_fail=1
-ac_cs_usage="\
-\`$as_me' instantiates files and other configuration actions
-from templates according to the current configuration.  Unless the files
-and actions are specified as TAGs, all are instantiated by default.
-
-Usage: $0 [OPTION]... [TAG]...
-
-  -h, --help       print this help, then exit
-  -V, --version    print version number and configuration settings, then exit
-      --config     print configuration, then exit
-  -q, --quiet, --silent
-                   do not print progress messages
-  -d, --debug      don't remove temporary files
-      --recheck    update $as_me by reconfiguring in the same conditions
-      --file=FILE[:TEMPLATE]
-                   instantiate the configuration file FILE
-      --header=FILE[:TEMPLATE]
-                   instantiate the configuration header FILE
-
-Configuration files:
-$config_files
-
-Configuration headers:
-$config_headers
-
-Configuration commands:
-$config_commands
-
-Report bugs to the package provider."
-
-_ACEOF
-cat >>$CONFIG_STATUS <<_ACEOF || ac_write_fail=1
-ac_cs_config="`$as_echo "$ac_configure_args" | sed 's/^ //; s/[\\""\`\$]/\\\\&/g'`"
-ac_cs_version="\\
-dosbox config.status 0.74
-configured by $0, generated by GNU Autoconf 2.65,
-  with options \\"\$ac_cs_config\\"
-
-Copyright (C) 2009 Free Software Foundation, Inc.
-This config.status script is free software; the Free Software Foundation
-gives unlimited permission to copy, distribute and modify it."
-
-ac_pwd='$ac_pwd'
-srcdir='$srcdir'
-INSTALL='$INSTALL'
-MKDIR_P='$MKDIR_P'
-AWK='$AWK'
-test -n "\$AWK" || AWK=awk
-_ACEOF
-
-cat >>$CONFIG_STATUS <<\_ACEOF || ac_write_fail=1
-# The default lists apply if the user does not specify any file.
-ac_need_defaults=:
-while test $# != 0
-do
-  case $1 in
-  --*=*)
-    ac_option=`expr "X$1" : 'X\([^=]*\)='`
-    ac_optarg=`expr "X$1" : 'X[^=]*=\(.*\)'`
-    ac_shift=:
-    ;;
-  *)
-    ac_option=$1
-    ac_optarg=$2
-    ac_shift=shift
-    ;;
-  esac
-
-  case $ac_option in
-  # Handling of the options.
-  -recheck | --recheck | --rechec | --reche | --rech | --rec | --re | --r)
-    ac_cs_recheck=: ;;
-  --version | --versio | --versi | --vers | --ver | --ve | --v | -V )
-    $as_echo "$ac_cs_version"; exit ;;
-  --config | --confi | --conf | --con | --co | --c )
-    $as_echo "$ac_cs_config"; exit ;;
-  --debug | --debu | --deb | --de | --d | -d )
-    debug=: ;;
-  --file | --fil | --fi | --f )
-    $ac_shift
-    case $ac_optarg in
-    *\'*) ac_optarg=`$as_echo "$ac_optarg" | sed "s/'/'\\\\\\\\''/g"` ;;
-    esac
-    as_fn_append CONFIG_FILES " '$ac_optarg'"
-    ac_need_defaults=false;;
-  --header | --heade | --head | --hea )
-    $ac_shift
-    case $ac_optarg in
-    *\'*) ac_optarg=`$as_echo "$ac_optarg" | sed "s/'/'\\\\\\\\''/g"` ;;
-    esac
-    as_fn_append CONFIG_HEADERS " '$ac_optarg'"
-    ac_need_defaults=false;;
-  --he | --h)
-    # Conflict between --help and --header
-    as_fn_error "ambiguous option: \`$1'
-Try \`$0 --help' for more information.";;
-  --help | --hel | -h )
-    $as_echo "$ac_cs_usage"; exit ;;
-  -q | -quiet | --quiet | --quie | --qui | --qu | --q \
-  | -silent | --silent | --silen | --sile | --sil | --si | --s)
-    ac_cs_silent=: ;;
-
-  # This is an error.
-  -*) as_fn_error "unrecognized option: \`$1'
-Try \`$0 --help' for more information." ;;
-
-  *) as_fn_append ac_config_targets " $1"
-     ac_need_defaults=false ;;
-
-  esac
-  shift
-done
-
-ac_configure_extra_args=
-
-if $ac_cs_silent; then
-  exec 6>/dev/null
-  ac_configure_extra_args="$ac_configure_extra_args --silent"
-fi
-
-_ACEOF
-cat >>$CONFIG_STATUS <<_ACEOF || ac_write_fail=1
-if \$ac_cs_recheck; then
-  set X '$SHELL' '$0' $ac_configure_args \$ac_configure_extra_args --no-create --no-recursion
-  shift
-  \$as_echo "running CONFIG_SHELL=$SHELL \$*" >&6
-  CONFIG_SHELL='$SHELL'
-  export CONFIG_SHELL
-  exec "\$@"
-fi
-
-_ACEOF
-cat >>$CONFIG_STATUS <<\_ACEOF || ac_write_fail=1
-exec 5>>config.log
-{
-  echo
-  sed 'h;s/./-/g;s/^.../## /;s/...$/ ##/;p;x;p;x' <<_ASBOX
-## Running $as_me. ##
-_ASBOX
-  $as_echo "$ac_log"
-} >&5
-
-_ACEOF
-cat >>$CONFIG_STATUS <<_ACEOF || ac_write_fail=1
-#
-# INIT-COMMANDS
-#
-AMDEP_TRUE="$AMDEP_TRUE" ac_aux_dir="$ac_aux_dir"
-
-_ACEOF
-
-cat >>$CONFIG_STATUS <<\_ACEOF || ac_write_fail=1
-
-# Handling of arguments.
-for ac_config_target in $ac_config_targets
-do
-  case $ac_config_target in
-    "config.h") CONFIG_HEADERS="$CONFIG_HEADERS config.h" ;;
-    "depfiles") CONFIG_COMMANDS="$CONFIG_COMMANDS depfiles" ;;
-    "Makefile") CONFIG_FILES="$CONFIG_FILES Makefile" ;;
-    "src/Makefile") CONFIG_FILES="$CONFIG_FILES src/Makefile" ;;
-    "src/cpu/Makefile") CONFIG_FILES="$CONFIG_FILES src/cpu/Makefile" ;;
-    "src/cpu/core_full/Makefile") CONFIG_FILES="$CONFIG_FILES src/cpu/core_full/Makefile" ;;
-    "src/cpu/core_normal/Makefile") CONFIG_FILES="$CONFIG_FILES src/cpu/core_normal/Makefile" ;;
-    "src/cpu/core_dyn_x86/Makefile") CONFIG_FILES="$CONFIG_FILES src/cpu/core_dyn_x86/Makefile" ;;
-    "src/cpu/core_dynrec/Makefile") CONFIG_FILES="$CONFIG_FILES src/cpu/core_dynrec/Makefile" ;;
-    "src/debug/Makefile") CONFIG_FILES="$CONFIG_FILES src/debug/Makefile" ;;
-    "src/dos/Makefile") CONFIG_FILES="$CONFIG_FILES src/dos/Makefile" ;;
-    "src/fpu/Makefile") CONFIG_FILES="$CONFIG_FILES src/fpu/Makefile" ;;
-    "src/gui/Makefile") CONFIG_FILES="$CONFIG_FILES src/gui/Makefile" ;;
-    "src/hardware/Makefile") CONFIG_FILES="$CONFIG_FILES src/hardware/Makefile" ;;
-    "src/hardware/serialport/Makefile") CONFIG_FILES="$CONFIG_FILES src/hardware/serialport/Makefile" ;;
-    "src/ints/Makefile") CONFIG_FILES="$CONFIG_FILES src/ints/Makefile" ;;
-    "src/libs/Makefile") CONFIG_FILES="$CONFIG_FILES src/libs/Makefile" ;;
-    "src/libs/zmbv/Makefile") CONFIG_FILES="$CONFIG_FILES src/libs/zmbv/Makefile" ;;
-    "src/libs/gui_tk/Makefile") CONFIG_FILES="$CONFIG_FILES src/libs/gui_tk/Makefile" ;;
-    "src/misc/Makefile") CONFIG_FILES="$CONFIG_FILES src/misc/Makefile" ;;
-    "src/shell/Makefile") CONFIG_FILES="$CONFIG_FILES src/shell/Makefile" ;;
-    "src/platform/Makefile") CONFIG_FILES="$CONFIG_FILES src/platform/Makefile" ;;
-    "src/platform/visualc/Makefile") CONFIG_FILES="$CONFIG_FILES src/platform/visualc/Makefile" ;;
-    "visualc_net/Makefile") CONFIG_FILES="$CONFIG_FILES visualc_net/Makefile" ;;
-    "include/Makefile") CONFIG_FILES="$CONFIG_FILES include/Makefile" ;;
-    "docs/Makefile") CONFIG_FILES="$CONFIG_FILES docs/Makefile" ;;
-
-  *) as_fn_error "invalid argument: \`$ac_config_target'" "$LINENO" 5;;
-  esac
-done
-
-
-# If the user did not use the arguments to specify the items to instantiate,
-# then the envvar interface is used.  Set only those that are not.
-# We use the long form for the default assignment because of an extremely
-# bizarre bug on SunOS 4.1.3.
-if $ac_need_defaults; then
-  test "${CONFIG_FILES+set}" = set || CONFIG_FILES=$config_files
-  test "${CONFIG_HEADERS+set}" = set || CONFIG_HEADERS=$config_headers
-  test "${CONFIG_COMMANDS+set}" = set || CONFIG_COMMANDS=$config_commands
-fi
-
-# Have a temporary directory for convenience.  Make it in the build tree
-# simply because there is no reason against having it here, and in addition,
-# creating and moving files from /tmp can sometimes cause problems.
-# Hook for its removal unless debugging.
-# Note that there is a small window in which the directory will not be cleaned:
-# after its creation but before its name has been assigned to `$tmp'.
-$debug ||
-{
-  tmp=
-  trap 'exit_status=$?
-  { test -z "$tmp" || test ! -d "$tmp" || rm -fr "$tmp"; } && exit $exit_status
-' 0
-  trap 'as_fn_exit 1' 1 2 13 15
-}
-# Create a (secure) tmp directory for tmp files.
-
-{
-  tmp=`(umask 077 && mktemp -d "./confXXXXXX") 2>/dev/null` &&
-  test -n "$tmp" && test -d "$tmp"
-}  ||
-{
-  tmp=./conf$$-$RANDOM
-  (umask 077 && mkdir "$tmp")
-} || as_fn_error "cannot create a temporary directory in ." "$LINENO" 5
-
-# Set up the scripts for CONFIG_FILES section.
-# No need to generate them if there are no CONFIG_FILES.
-# This happens for instance with `./config.status config.h'.
-if test -n "$CONFIG_FILES"; then
-
-
-ac_cr=`echo X | tr X '\015'`
-# On cygwin, bash can eat \r inside `` if the user requested igncr.
-# But we know of no other shell where ac_cr would be empty at this
-# point, so we can use a bashism as a fallback.
-if test "x$ac_cr" = x; then
-  eval ac_cr=\$\'\\r\'
-fi
-ac_cs_awk_cr=`$AWK 'BEGIN { print "a\rb" }' </dev/null 2>/dev/null`
-if test "$ac_cs_awk_cr" = "a${ac_cr}b"; then
-  ac_cs_awk_cr='\r'
-else
-  ac_cs_awk_cr=$ac_cr
-fi
-
-echo 'BEGIN {' >"$tmp/subs1.awk" &&
-_ACEOF
-
-
-{
-  echo "cat >conf$$subs.awk <<_ACEOF" &&
-  echo "$ac_subst_vars" | sed 's/.*/&!$&$ac_delim/' &&
-  echo "_ACEOF"
-} >conf$$subs.sh ||
-  as_fn_error "could not make $CONFIG_STATUS" "$LINENO" 5
-ac_delim_num=`echo "$ac_subst_vars" | grep -c '$'`
-ac_delim='%!_!# '
-for ac_last_try in false false false false false :; do
-  . ./conf$$subs.sh ||
-    as_fn_error "could not make $CONFIG_STATUS" "$LINENO" 5
-
-  ac_delim_n=`sed -n "s/.*$ac_delim\$/X/p" conf$$subs.awk | grep -c X`
-  if test $ac_delim_n = $ac_delim_num; then
-    break
-  elif $ac_last_try; then
-    as_fn_error "could not make $CONFIG_STATUS" "$LINENO" 5
-  else
-    ac_delim="$ac_delim!$ac_delim _$ac_delim!! "
-  fi
-done
-rm -f conf$$subs.sh
-
-cat >>$CONFIG_STATUS <<_ACEOF || ac_write_fail=1
-cat >>"\$tmp/subs1.awk" <<\\_ACAWK &&
-_ACEOF
-sed -n '
-h
-s/^/S["/; s/!.*/"]=/
-p
-g
-s/^[^!]*!//
-:repl
-t repl
-s/'"$ac_delim"'$//
-t delim
-:nl
-h
-s/\(.\{148\}\)..*/\1/
-t more1
-s/["\\]/\\&/g; s/^/"/; s/$/\\n"\\/
-p
-n
-b repl
-:more1
-s/["\\]/\\&/g; s/^/"/; s/$/"\\/
-p
-g
-s/.\{148\}//
-t nl
-:delim
-h
-s/\(.\{148\}\)..*/\1/
-t more2
-s/["\\]/\\&/g; s/^/"/; s/$/"/
-p
-b
-:more2
-s/["\\]/\\&/g; s/^/"/; s/$/"\\/
-p
-g
-s/.\{148\}//
-t delim
-' <conf$$subs.awk | sed '
-/^[^""]/{
-  N
-  s/\n//
-}
-' >>$CONFIG_STATUS || ac_write_fail=1
-rm -f conf$$subs.awk
-cat >>$CONFIG_STATUS <<_ACEOF || ac_write_fail=1
-_ACAWK
-cat >>"\$tmp/subs1.awk" <<_ACAWK &&
-  for (key in S) S_is_set[key] = 1
-  FS = ""
-
-}
-{
-  line = $ 0
-  nfields = split(line, field, "@")
-  substed = 0
-  len = length(field[1])
-  for (i = 2; i < nfields; i++) {
-    key = field[i]
-    keylen = length(key)
-    if (S_is_set[key]) {
-      value = S[key]
-      line = substr(line, 1, len) "" value "" substr(line, len + keylen + 3)
-      len += length(value) + length(field[++i])
-      substed = 1
-    } else
-      len += 1 + keylen
-  }
-
-  print line
-}
-
-_ACAWK
-_ACEOF
-cat >>$CONFIG_STATUS <<\_ACEOF || ac_write_fail=1
-if sed "s/$ac_cr//" < /dev/null > /dev/null 2>&1; then
-  sed "s/$ac_cr\$//; s/$ac_cr/$ac_cs_awk_cr/g"
-else
-  cat
-fi < "$tmp/subs1.awk" > "$tmp/subs.awk" \
-  || as_fn_error "could not setup config files machinery" "$LINENO" 5
-_ACEOF
-
-# VPATH may cause trouble with some makes, so we remove $(srcdir),
-# ${srcdir} and @srcdir@ from VPATH if srcdir is ".", strip leading and
-# trailing colons and then remove the whole line if VPATH becomes empty
-# (actually we leave an empty line to preserve line numbers).
-if test "x$srcdir" = x.; then
-  ac_vpsub='/^[	 ]*VPATH[	 ]*=/{
-s/:*\$(srcdir):*/:/
-s/:*\${srcdir}:*/:/
-s/:*@srcdir@:*/:/
-s/^\([^=]*=[	 ]*\):*/\1/
-s/:*$//
-s/^[^=]*=[	 ]*$//
-}'
-fi
-
-cat >>$CONFIG_STATUS <<\_ACEOF || ac_write_fail=1
-fi # test -n "$CONFIG_FILES"
-
-# Set up the scripts for CONFIG_HEADERS section.
-# No need to generate them if there are no CONFIG_HEADERS.
-# This happens for instance with `./config.status Makefile'.
-if test -n "$CONFIG_HEADERS"; then
-cat >"$tmp/defines.awk" <<\_ACAWK ||
-BEGIN {
-_ACEOF
-
-# Transform confdefs.h into an awk script `defines.awk', embedded as
-# here-document in config.status, that substitutes the proper values into
-# config.h.in to produce config.h.
-
-# Create a delimiter string that does not exist in confdefs.h, to ease
-# handling of long lines.
-ac_delim='%!_!# '
-for ac_last_try in false false :; do
-  ac_t=`sed -n "/$ac_delim/p" confdefs.h`
-  if test -z "$ac_t"; then
-    break
-  elif $ac_last_try; then
-    as_fn_error "could not make $CONFIG_HEADERS" "$LINENO" 5
-  else
-    ac_delim="$ac_delim!$ac_delim _$ac_delim!! "
-  fi
-done
-
-# For the awk script, D is an array of macro values keyed by name,
-# likewise P contains macro parameters if any.  Preserve backslash
-# newline sequences.
-
-ac_word_re=[_$as_cr_Letters][_$as_cr_alnum]*
-sed -n '
-s/.\{148\}/&'"$ac_delim"'/g
-t rset
-:rset
-s/^[	 ]*#[	 ]*define[	 ][	 ]*/ /
-t def
-d
-:def
-s/\\$//
-t bsnl
-s/["\\]/\\&/g
-s/^ \('"$ac_word_re"'\)\(([^()]*)\)[	 ]*\(.*\)/P["\1"]="\2"\
-D["\1"]=" \3"/p
-s/^ \('"$ac_word_re"'\)[	 ]*\(.*\)/D["\1"]=" \2"/p
-d
-:bsnl
-s/["\\]/\\&/g
-s/^ \('"$ac_word_re"'\)\(([^()]*)\)[	 ]*\(.*\)/P["\1"]="\2"\
-D["\1"]=" \3\\\\\\n"\\/p
-t cont
-s/^ \('"$ac_word_re"'\)[	 ]*\(.*\)/D["\1"]=" \2\\\\\\n"\\/p
-t cont
-d
-:cont
-n
-s/.\{148\}/&'"$ac_delim"'/g
-t clear
-:clear
-s/\\$//
-t bsnlc
-s/["\\]/\\&/g; s/^/"/; s/$/"/p
-d
-:bsnlc
-s/["\\]/\\&/g; s/^/"/; s/$/\\\\\\n"\\/p
-b cont
-' <confdefs.h | sed '
-s/'"$ac_delim"'/"\\\
-"/g' >>$CONFIG_STATUS || ac_write_fail=1
-
-cat >>$CONFIG_STATUS <<_ACEOF || ac_write_fail=1
-  for (key in D) D_is_set[key] = 1
-  FS = ""
-}
-/^[\t ]*#[\t ]*(define|undef)[\t ]+$ac_word_re([\t (]|\$)/ {
-  line = \$ 0
-  split(line, arg, " ")
-  if (arg[1] == "#") {
-    defundef = arg[2]
-    mac1 = arg[3]
-  } else {
-    defundef = substr(arg[1], 2)
-    mac1 = arg[2]
-  }
-  split(mac1, mac2, "(") #)
-  macro = mac2[1]
-  prefix = substr(line, 1, index(line, defundef) - 1)
-  if (D_is_set[macro]) {
-    # Preserve the white space surrounding the "#".
-    print prefix "define", macro P[macro] D[macro]
-    next
-  } else {
-    # Replace #undef with comments.  This is necessary, for example,
-    # in the case of _POSIX_SOURCE, which is predefined and required
-    # on some systems where configure will not decide to define it.
-    if (defundef == "undef") {
-      print "/*", prefix defundef, macro, "*/"
-      next
-    }
-  }
-}
-{ print }
-_ACAWK
-_ACEOF
-cat >>$CONFIG_STATUS <<\_ACEOF || ac_write_fail=1
-  as_fn_error "could not setup config headers machinery" "$LINENO" 5
-fi # test -n "$CONFIG_HEADERS"
-
-
-eval set X "  :F $CONFIG_FILES  :H $CONFIG_HEADERS    :C $CONFIG_COMMANDS"
-shift
-for ac_tag
-do
-  case $ac_tag in
-  :[FHLC]) ac_mode=$ac_tag; continue;;
-  esac
-  case $ac_mode$ac_tag in
-  :[FHL]*:*);;
-  :L* | :C*:*) as_fn_error "invalid tag \`$ac_tag'" "$LINENO" 5;;
-  :[FH]-) ac_tag=-:-;;
-  :[FH]*) ac_tag=$ac_tag:$ac_tag.in;;
-  esac
-  ac_save_IFS=$IFS
-  IFS=:
-  set x $ac_tag
-  IFS=$ac_save_IFS
-  shift
-  ac_file=$1
-  shift
-
-  case $ac_mode in
-  :L) ac_source=$1;;
-  :[FH])
-    ac_file_inputs=
-    for ac_f
-    do
-      case $ac_f in
-      -) ac_f="$tmp/stdin";;
-      *) # Look for the file first in the build tree, then in the source tree
-	 # (if the path is not absolute).  The absolute path cannot be DOS-style,
-	 # because $ac_f cannot contain `:'.
-	 test -f "$ac_f" ||
-	   case $ac_f in
-	   [\\/$]*) false;;
-	   *) test -f "$srcdir/$ac_f" && ac_f="$srcdir/$ac_f";;
-	   esac ||
-	   as_fn_error "cannot find input file: \`$ac_f'" "$LINENO" 5;;
-      esac
-      case $ac_f in *\'*) ac_f=`$as_echo "$ac_f" | sed "s/'/'\\\\\\\\''/g"`;; esac
-      as_fn_append ac_file_inputs " '$ac_f'"
-    done
-
-    # Let's still pretend it is `configure' which instantiates (i.e., don't
-    # use $as_me), people would be surprised to read:
-    #    /* config.h.  Generated by config.status.  */
-    configure_input='Generated from '`
-	  $as_echo "$*" | sed 's|^[^:]*/||;s|:[^:]*/|, |g'
-	`' by configure.'
-    if test x"$ac_file" != x-; then
-      configure_input="$ac_file.  $configure_input"
-      { $as_echo "$as_me:${as_lineno-$LINENO}: creating $ac_file" >&5
-$as_echo "$as_me: creating $ac_file" >&6;}
-    fi
-    # Neutralize special characters interpreted by sed in replacement strings.
-    case $configure_input in #(
-    *\&* | *\|* | *\\* )
-       ac_sed_conf_input=`$as_echo "$configure_input" |
-       sed 's/[\\\\&|]/\\\\&/g'`;; #(
-    *) ac_sed_conf_input=$configure_input;;
-    esac
-
-    case $ac_tag in
-    *:-:* | *:-) cat >"$tmp/stdin" \
-      || as_fn_error "could not create $ac_file" "$LINENO" 5 ;;
-    esac
-    ;;
-  esac
-
-  ac_dir=`$as_dirname -- "$ac_file" ||
-$as_expr X"$ac_file" : 'X\(.*[^/]\)//*[^/][^/]*/*$' \| \
-	 X"$ac_file" : 'X\(//\)[^/]' \| \
-	 X"$ac_file" : 'X\(//\)$' \| \
-	 X"$ac_file" : 'X\(/\)' \| . 2>/dev/null ||
-$as_echo X"$ac_file" |
-    sed '/^X\(.*[^/]\)\/\/*[^/][^/]*\/*$/{
-	    s//\1/
-	    q
-	  }
-	  /^X\(\/\/\)[^/].*/{
-	    s//\1/
-	    q
-	  }
-	  /^X\(\/\/\)$/{
-	    s//\1/
-	    q
-	  }
-	  /^X\(\/\).*/{
-	    s//\1/
-	    q
-	  }
-	  s/.*/./; q'`
-  as_dir="$ac_dir"; as_fn_mkdir_p
-  ac_builddir=.
-
-case "$ac_dir" in
-.) ac_dir_suffix= ac_top_builddir_sub=. ac_top_build_prefix= ;;
-*)
-  ac_dir_suffix=/`$as_echo "$ac_dir" | sed 's|^\.[\\/]||'`
-  # A ".." for each directory in $ac_dir_suffix.
-  ac_top_builddir_sub=`$as_echo "$ac_dir_suffix" | sed 's|/[^\\/]*|/..|g;s|/||'`
-  case $ac_top_builddir_sub in
-  "") ac_top_builddir_sub=. ac_top_build_prefix= ;;
-  *)  ac_top_build_prefix=$ac_top_builddir_sub/ ;;
-  esac ;;
-esac
-ac_abs_top_builddir=$ac_pwd
-ac_abs_builddir=$ac_pwd$ac_dir_suffix
-# for backward compatibility:
-ac_top_builddir=$ac_top_build_prefix
-
-case $srcdir in
-  .)  # We are building in place.
-    ac_srcdir=.
-    ac_top_srcdir=$ac_top_builddir_sub
-    ac_abs_top_srcdir=$ac_pwd ;;
-  [\\/]* | ?:[\\/]* )  # Absolute name.
-    ac_srcdir=$srcdir$ac_dir_suffix;
-    ac_top_srcdir=$srcdir
-    ac_abs_top_srcdir=$srcdir ;;
-  *) # Relative name.
-    ac_srcdir=$ac_top_build_prefix$srcdir$ac_dir_suffix
-    ac_top_srcdir=$ac_top_build_prefix$srcdir
-    ac_abs_top_srcdir=$ac_pwd/$srcdir ;;
-esac
-ac_abs_srcdir=$ac_abs_top_srcdir$ac_dir_suffix
-
-
-  case $ac_mode in
-  :F)
-  #
-  # CONFIG_FILE
-  #
-
-  case $INSTALL in
-  [\\/$]* | ?:[\\/]* ) ac_INSTALL=$INSTALL ;;
-  *) ac_INSTALL=$ac_top_build_prefix$INSTALL ;;
-  esac
-  ac_MKDIR_P=$MKDIR_P
-  case $MKDIR_P in
-  [\\/$]* | ?:[\\/]* ) ;;
-  */*) ac_MKDIR_P=$ac_top_build_prefix$MKDIR_P ;;
-  esac
-_ACEOF
-
-cat >>$CONFIG_STATUS <<\_ACEOF || ac_write_fail=1
-# If the template does not know about datarootdir, expand it.
-# FIXME: This hack should be removed a few years after 2.60.
-ac_datarootdir_hack=; ac_datarootdir_seen=
-ac_sed_dataroot='
-/datarootdir/ {
-  p
-  q
-}
-/@datadir@/p
-/@docdir@/p
-/@infodir@/p
-/@localedir@/p
-/@mandir@/p'
-case `eval "sed -n \"\$ac_sed_dataroot\" $ac_file_inputs"` in
-*datarootdir*) ac_datarootdir_seen=yes;;
-*@datadir@*|*@docdir@*|*@infodir@*|*@localedir@*|*@mandir@*)
-  { $as_echo "$as_me:${as_lineno-$LINENO}: WARNING: $ac_file_inputs seems to ignore the --datarootdir setting" >&5
-$as_echo "$as_me: WARNING: $ac_file_inputs seems to ignore the --datarootdir setting" >&2;}
-_ACEOF
-cat >>$CONFIG_STATUS <<_ACEOF || ac_write_fail=1
-  ac_datarootdir_hack='
-  s&@datadir@&$datadir&g
-  s&@docdir@&$docdir&g
-  s&@infodir@&$infodir&g
-  s&@localedir@&$localedir&g
-  s&@mandir@&$mandir&g
-  s&\\\${datarootdir}&$datarootdir&g' ;;
-esac
-_ACEOF
-
-# Neutralize VPATH when `$srcdir' = `.'.
-# Shell code in configure.ac might set extrasub.
-# FIXME: do we really want to maintain this feature?
-cat >>$CONFIG_STATUS <<_ACEOF || ac_write_fail=1
-ac_sed_extra="$ac_vpsub
-$extrasub
-_ACEOF
-cat >>$CONFIG_STATUS <<\_ACEOF || ac_write_fail=1
-:t
-/@[a-zA-Z_][a-zA-Z_0-9]*@/!b
-s|@configure_input@|$ac_sed_conf_input|;t t
-s&@top_builddir@&$ac_top_builddir_sub&;t t
-s&@top_build_prefix@&$ac_top_build_prefix&;t t
-s&@srcdir@&$ac_srcdir&;t t
-s&@abs_srcdir@&$ac_abs_srcdir&;t t
-s&@top_srcdir@&$ac_top_srcdir&;t t
-s&@abs_top_srcdir@&$ac_abs_top_srcdir&;t t
-s&@builddir@&$ac_builddir&;t t
-s&@abs_builddir@&$ac_abs_builddir&;t t
-s&@abs_top_builddir@&$ac_abs_top_builddir&;t t
-s&@INSTALL@&$ac_INSTALL&;t t
-s&@MKDIR_P@&$ac_MKDIR_P&;t t
-$ac_datarootdir_hack
-"
-eval sed \"\$ac_sed_extra\" "$ac_file_inputs" | $AWK -f "$tmp/subs.awk" >$tmp/out \
-  || as_fn_error "could not create $ac_file" "$LINENO" 5
-
-test -z "$ac_datarootdir_hack$ac_datarootdir_seen" &&
-  { ac_out=`sed -n '/\${datarootdir}/p' "$tmp/out"`; test -n "$ac_out"; } &&
-  { ac_out=`sed -n '/^[	 ]*datarootdir[	 ]*:*=/p' "$tmp/out"`; test -z "$ac_out"; } &&
-  { $as_echo "$as_me:${as_lineno-$LINENO}: WARNING: $ac_file contains a reference to the variable \`datarootdir'
-which seems to be undefined.  Please make sure it is defined." >&5
-$as_echo "$as_me: WARNING: $ac_file contains a reference to the variable \`datarootdir'
-which seems to be undefined.  Please make sure it is defined." >&2;}
-
-  rm -f "$tmp/stdin"
-  case $ac_file in
-  -) cat "$tmp/out" && rm -f "$tmp/out";;
-  *) rm -f "$ac_file" && mv "$tmp/out" "$ac_file";;
-  esac \
-  || as_fn_error "could not create $ac_file" "$LINENO" 5
- ;;
-  :H)
-  #
-  # CONFIG_HEADER
-  #
-  if test x"$ac_file" != x-; then
-    {
-      $as_echo "/* $configure_input  */" \
-      && eval '$AWK -f "$tmp/defines.awk"' "$ac_file_inputs"
-    } >"$tmp/config.h" \
-      || as_fn_error "could not create $ac_file" "$LINENO" 5
-    if diff "$ac_file" "$tmp/config.h" >/dev/null 2>&1; then
-      { $as_echo "$as_me:${as_lineno-$LINENO}: $ac_file is unchanged" >&5
-$as_echo "$as_me: $ac_file is unchanged" >&6;}
-    else
-      rm -f "$ac_file"
-      mv "$tmp/config.h" "$ac_file" \
-	|| as_fn_error "could not create $ac_file" "$LINENO" 5
-    fi
-  else
-    $as_echo "/* $configure_input  */" \
-      && eval '$AWK -f "$tmp/defines.awk"' "$ac_file_inputs" \
-      || as_fn_error "could not create -" "$LINENO" 5
-  fi
-# Compute "$ac_file"'s index in $config_headers.
-_am_arg="$ac_file"
-_am_stamp_count=1
-for _am_header in $config_headers :; do
-  case $_am_header in
-    $_am_arg | $_am_arg:* )
-      break ;;
-    * )
-      _am_stamp_count=`expr $_am_stamp_count + 1` ;;
-  esac
-done
-echo "timestamp for $_am_arg" >`$as_dirname -- "$_am_arg" ||
-$as_expr X"$_am_arg" : 'X\(.*[^/]\)//*[^/][^/]*/*$' \| \
-	 X"$_am_arg" : 'X\(//\)[^/]' \| \
-	 X"$_am_arg" : 'X\(//\)$' \| \
-	 X"$_am_arg" : 'X\(/\)' \| . 2>/dev/null ||
-$as_echo X"$_am_arg" |
-    sed '/^X\(.*[^/]\)\/\/*[^/][^/]*\/*$/{
-	    s//\1/
-	    q
-	  }
-	  /^X\(\/\/\)[^/].*/{
-	    s//\1/
-	    q
-	  }
-	  /^X\(\/\/\)$/{
-	    s//\1/
-	    q
-	  }
-	  /^X\(\/\).*/{
-	    s//\1/
-	    q
-	  }
-	  s/.*/./; q'`/stamp-h$_am_stamp_count
- ;;
-
-  :C)  { $as_echo "$as_me:${as_lineno-$LINENO}: executing $ac_file commands" >&5
-$as_echo "$as_me: executing $ac_file commands" >&6;}
- ;;
-  esac
-
-
-  case $ac_file$ac_mode in
-    "depfiles":C) test x"$AMDEP_TRUE" != x"" || {
-  # Autoconf 2.62 quotes --file arguments for eval, but not when files
-  # are listed without --file.  Let's play safe and only enable the eval
-  # if we detect the quoting.
-  case $CONFIG_FILES in
-  *\'*) eval set x "$CONFIG_FILES" ;;
-  *)   set x $CONFIG_FILES ;;
-  esac
-  shift
-  for mf
-  do
-    # Strip MF so we end up with the name of the file.
-    mf=`echo "$mf" | sed -e 's/:.*$//'`
-    # Check whether this is an Automake generated Makefile or not.
-    # We used to match only the files named `Makefile.in', but
-    # some people rename them; so instead we look at the file content.
-    # Grep'ing the first line is not enough: some people post-process
-    # each Makefile.in and add a new line on top of each file to say so.
-    # Grep'ing the whole file is not good either: AIX grep has a line
-    # limit of 2048, but all sed's we know have understand at least 4000.
-    if sed -n 's,^#.*generated by automake.*,X,p' "$mf" | grep X >/dev/null 2>&1; then
-      dirpart=`$as_dirname -- "$mf" ||
-$as_expr X"$mf" : 'X\(.*[^/]\)//*[^/][^/]*/*$' \| \
-	 X"$mf" : 'X\(//\)[^/]' \| \
-	 X"$mf" : 'X\(//\)$' \| \
-	 X"$mf" : 'X\(/\)' \| . 2>/dev/null ||
-$as_echo X"$mf" |
-    sed '/^X\(.*[^/]\)\/\/*[^/][^/]*\/*$/{
-	    s//\1/
-	    q
-	  }
-	  /^X\(\/\/\)[^/].*/{
-	    s//\1/
-	    q
-	  }
-	  /^X\(\/\/\)$/{
-	    s//\1/
-	    q
-	  }
-	  /^X\(\/\).*/{
-	    s//\1/
-	    q
-	  }
-	  s/.*/./; q'`
-    else
-      continue
-    fi
-    # Extract the definition of DEPDIR, am__include, and am__quote
-    # from the Makefile without running `make'.
-    DEPDIR=`sed -n 's/^DEPDIR = //p' < "$mf"`
-    test -z "$DEPDIR" && continue
-    am__include=`sed -n 's/^am__include = //p' < "$mf"`
-    test -z "am__include" && continue
-    am__quote=`sed -n 's/^am__quote = //p' < "$mf"`
-    # When using ansi2knr, U may be empty or an underscore; expand it
-    U=`sed -n 's/^U = //p' < "$mf"`
-    # Find all dependency output files, they are included files with
-    # $(DEPDIR) in their names.  We invoke sed twice because it is the
-    # simplest approach to changing $(DEPDIR) to its actual value in the
-    # expansion.
-    for file in `sed -n "
-      s/^$am__include $am__quote\(.*(DEPDIR).*\)$am__quote"'$/\1/p' <"$mf" | \
-	 sed -e 's/\$(DEPDIR)/'"$DEPDIR"'/g' -e 's/\$U/'"$U"'/g'`; do
-      # Make sure the directory exists.
-      test -f "$dirpart/$file" && continue
-      fdir=`$as_dirname -- "$file" ||
-$as_expr X"$file" : 'X\(.*[^/]\)//*[^/][^/]*/*$' \| \
-	 X"$file" : 'X\(//\)[^/]' \| \
-	 X"$file" : 'X\(//\)$' \| \
-	 X"$file" : 'X\(/\)' \| . 2>/dev/null ||
-$as_echo X"$file" |
-    sed '/^X\(.*[^/]\)\/\/*[^/][^/]*\/*$/{
-	    s//\1/
-	    q
-	  }
-	  /^X\(\/\/\)[^/].*/{
-	    s//\1/
-	    q
-	  }
-	  /^X\(\/\/\)$/{
-	    s//\1/
-	    q
-	  }
-	  /^X\(\/\).*/{
-	    s//\1/
-	    q
-	  }
-	  s/.*/./; q'`
-      as_dir=$dirpart/$fdir; as_fn_mkdir_p
-      # echo "creating $dirpart/$file"
-      echo '# dummy' > "$dirpart/$file"
-    done
-  done
-}
- ;;
-
-  esac
-done # for ac_tag
-
-
-as_fn_exit 0
-_ACEOF
-ac_clean_files=$ac_clean_files_save
-
-test $ac_write_fail = 0 ||
-  as_fn_error "write failure creating $CONFIG_STATUS" "$LINENO" 5
-
-
-# configure is writing to config.log, and then calls config.status.
-# config.status does its own redirection, appending to config.log.
-# Unfortunately, on DOS this fails, as config.log is still kept open
-# by configure, so config.status won't be able to write to it; its
-# output is simply discarded.  So we exec the FD to /dev/null,
-# effectively closing config.log, so it can be properly (re)opened and
-# appended to by config.status.  When coming back to configure, we
-# need to make the FD available again.
-if test "$no_create" != yes; then
-  ac_cs_success=:
-  ac_config_status_args=
-  test "$silent" = yes &&
-    ac_config_status_args="$ac_config_status_args --quiet"
-  exec 5>/dev/null
-  $SHELL $CONFIG_STATUS $ac_config_status_args || ac_cs_success=false
-  exec 5>>config.log
-  # Use ||, not &&, to avoid exiting from the if with $? = 1, which
-  # would make configure fail if this is the last instruction.
-  $ac_cs_success || as_fn_exit $?
-fi
-if test -n "$ac_unrecognized_opts" && test "$enable_option_checking" != no; then
-  { $as_echo "$as_me:${as_lineno-$LINENO}: WARNING: unrecognized options: $ac_unrecognized_opts" >&5
-$as_echo "$as_me: WARNING: unrecognized options: $ac_unrecognized_opts" >&2;}
-fi
-
diff -Nur dosbox-0.74/configure.ac dosbox-0.74.patch/configure.ac
--- dosbox-0.74/configure.ac	1970-01-01 01:00:00.000000000 +0100
+++ dosbox-0.74.patch/configure.ac	2016-12-11 18:35:15.490284007 +0100
@@ -0,0 +1,528 @@
+dnl Init.
+AC_INIT(dosbox,SVN)
+AC_PREREQ(2.50)
+AC_CONFIG_SRCDIR(README)
+
+dnl Detect the canonical host and target build environment
+AC_CANONICAL_HOST
+AC_CANONICAL_BUILD
+
+dnl Setup for automake
+AM_INIT_AUTOMAKE
+AC_CONFIG_HEADER(config.h)
+
+dnl Checks for programs.
+AC_PROG_MAKE_SET
+AC_PROG_CC
+AC_PROG_CPP
+AC_PROG_CXX
+AC_PROG_INSTALL
+AC_PROG_RANLIB
+
+dnl Some needed libaries for OS2
+dnl perharps join this with the other target depended checks. move them upwards
+if test x$host = xi386-pc-os2-emx ; then
+    CXXFLAGS="$CXXFLAGS -Zmt"
+    LDFLAGS="$LDFLAGS -Zomf -Zmt"
+    LIBS="$LIBS -los2me"
+fi
+
+dnl Check for SDL
+SDL_VERSION=1.2.0
+AM_PATH_SDL($SDL_VERSION,
+            :,
+	    AC_MSG_ERROR([*** SDL version $SDL_VERSION not found!])
+)
+LIBS="$LIBS $SDL_LIBS"
+CPPFLAGS="$CPPFLAGS $SDL_CFLAGS"
+
+dnl Check if SDL is 1.2.x (1.3 not supported)
+AC_MSG_CHECKING([SDL version only being 1.2.X])
+AC_COMPILE_IFELSE([AC_LANG_SOURCE([
+#include "SDL.h"
+void blah(){
+#if SDL_MINOR_VERSION != 2
+#error "Only SDL 1.2 supported"
+#endif
+;
+}
+])],AC_MSG_RESULT([yes]),[
+ AC_MSG_RESULT([no]) 
+ AC_MSG_ERROR([Only libSDL 1.2.X supported])])
+
+dnl Checks for header files.
+
+dnl Checks for typedefs, structures, and compiler characteristics.
+AC_C_CONST
+AC_C_INLINE
+AC_TYPE_SIZE_T
+AC_STRUCT_TM
+AC_CHECK_SIZEOF(unsigned char)
+AC_CHECK_SIZEOF(unsigned short)
+AC_CHECK_SIZEOF(unsigned int)
+AC_CHECK_SIZEOF(unsigned long)
+AC_CHECK_SIZEOF(unsigned long long)
+AC_CHECK_SIZEOF(int *)
+
+dnl some semi complex check for sys/socket so it works on darwin as well
+AC_CHECK_HEADERS([stdlib.h sys/types.h])
+AC_CHECK_HEADERS([sys/socket.h  netinet/in.h pwd.h], [], [],
+[#include <stdio.h>
+#ifdef STDC_HEADERS
+# include <stdlib.h>
+# include <stddef.h>
+#else
+# ifdef HAVE_STDLIB_H
+#  include <stdlib.h>
+# endif
+#endif
+#ifdef HAVE_SYS_TYPES_H
+# include <sys/types.h>
+#endif
+])
+
+dnl check for the socklen_t (darwin doesn't always have it)
+AC_COMPILE_IFELSE([AC_LANG_SOURCE([
+#include <stdio.h>
+#ifdef STDC_HEADERS
+# include <stdlib.h>
+# include <stddef.h>
+#else
+# ifdef HAVE_STDLIB_H
+#  include <stdlib.h>
+# endif
+#endif
+#ifdef HAVE_SYS_TYPES_H
+# include <sys/types.h>
+#endif
+#ifdef HAVE_SYS_SOCKET_H
+#include <sys/socket.h>
+#endif
+])],[],[AC_DEFINE([socklen_t],[int],[Define to `int` if you don't have socklen_t])])
+
+AC_MSG_CHECKING(if environ can be included)
+AC_LINK_IFELSE([AC_LANG_PROGRAM([[
+#include <unistd.h>
+#include <stdlib.h>]],[[*environ;]])],
+[AC_MSG_RESULT(yes);AC_DEFINE(ENVIRON_INCLUDED,1,[environ can be included])],AC_MSG_RESULT(no))
+
+AC_MSG_CHECKING(if environ can be linked)
+AC_LINK_IFELSE([AC_LANG_PROGRAM([[extern char ** environ;]],[[*environ;]])],
+[AC_MSG_RESULT(yes);AC_DEFINE(ENVIRON_LINKED,1,[environ can be linked])],AC_MSG_RESULT(no))
+
+AC_MSG_CHECKING([if dirent includes d_type])
+AC_COMPILE_IFELSE([AC_LANG_SOURCE([
+#include <sys/types.h>
+#include <dirent.h>
+void blah(){
+struct dirent d_test;
+d_test.d_type = 0;
+}])],[AC_MSG_RESULT(yes);AC_DEFINE(DIRENT_HAS_D_TYPE,1,[struct dirent has d_type])],AC_MSG_RESULT(no))
+
+
+dnl Check for powf
+AC_MSG_CHECKING(for powf in libm);
+LIBS_BACKUP=$LIBS;
+LIBS="$LIBS -lm";
+AC_LINK_IFELSE([AC_LANG_PROGRAM([[#include <math.h>]],[[
+        powf(1.0f, 1.0f);
+]])], [AC_MSG_RESULT(yes)], [AC_DEFINE([DB_HAVE_NO_POWF],[1],[libm doesn't include powf])])
+LIBS=$LIBS_BACKUP
+
+
+dnl Checks for libraries.
+
+#Check if the compiler support attributes
+AH_TEMPLATE([C_HAS_ATTRIBUTE],[Determines if the compilers supports attributes for structures.])
+AC_MSG_CHECKING(if compiler allows __attribute__)
+AC_COMPILE_IFELSE([AC_LANG_PROGRAM([[
+typedef struct { } __attribute__((packed)) junk;]],
+[[ ]])],[ AC_MSG_RESULT(yes);AC_DEFINE(C_HAS_ATTRIBUTE)],AC_MSG_RESULT(no))
+
+
+#Check if the compiler supports certain attributes
+OLDCFLAGS="$CFLAGS"
+CFLAGS="-Werror"
+
+AH_TEMPLATE([C_ATTRIBUTE_ALWAYS_INLINE],[Determines if the compilers supports always_inline attribute.])
+AC_MSG_CHECKING(if compiler allows __attribute__((always_inline)) )
+AC_COMPILE_IFELSE([AC_LANG_SOURCE([ void __attribute__((always_inline)) test(){}
+])],[ AC_MSG_RESULT(yes);AC_DEFINE(C_ATTRIBUTE_ALWAYS_INLINE)],AC_MSG_RESULT(no))
+
+AH_TEMPLATE([C_ATTRIBUTE_FASTCALL],[Determines if the compilers supports fastcall attribute.])
+AC_MSG_CHECKING(if compiler allows __attribute__((fastcall)) )
+AC_COMPILE_IFELSE([AC_LANG_SOURCE([ void __attribute__((fastcall)) test(){}
+])],[ AC_MSG_RESULT(yes);AC_DEFINE(C_ATTRIBUTE_FASTCALL)],AC_MSG_RESULT(no))
+
+
+CFLAGS="$OLDCFLAGS"
+
+
+#Check if the compiler supports __builtin_expect
+#Switch language to c++
+AC_LANG_PUSH(C++)
+AH_TEMPLATE([C_HAS_BUILTIN_EXPECT],[Determines if the compilers supports __builtin_expect for branch prediction.])
+AC_MSG_CHECKING(if compiler allows __builtin_expect)
+AC_COMPILE_IFELSE([AC_LANG_PROGRAM([[]],[[
+int x=10;if( __builtin_expect ((x==1),0) ) ;
+]])], [ AC_MSG_RESULT(yes);AC_DEFINE(C_HAS_BUILTIN_EXPECT)],AC_MSG_RESULT(no))
+#switch language back
+AC_LANG_POP(C++)
+
+dnl enable disable alsa and pass it's cflags to CXXFLAGS
+AC_ARG_ENABLE(alsa-midi,
+AC_HELP_STRING([--enable-alsa-midi],[compile with alsa midi support (default yes)]),
+[ case "${enableval}" in
+ yes) alsa_midi=true;;
+ no)  alsa_midi=false;;
+esac],
+[alsa_midi=true])
+if test x$alsa_midi = xtrue ; then 
+  AM_PATH_ALSA(0.9.0, AC_DEFINE(HAVE_ALSA,1,[Define to 1 to use ALSA for MIDI]) , : )
+  CXXFLAGS="$CXXFLAGS $ALSA_CFLAGS"
+fi
+
+#Check for big endian machine, should #define WORDS_BIGENDIAN if so
+AC_C_BIGENDIAN
+
+#Features to enable/disable
+AH_TEMPLATE(C_DEBUG,[Define to 1 to enable internal debugger, requires libcurses])
+AH_TEMPLATE(C_HEAVY_DEBUG,[Define to 1 to enable heavy debugging, also have to enable C_DEBUG])
+AC_ARG_ENABLE(debug,AC_HELP_STRING([--enable-debug],[Enable debug mode]),[
+   AC_CHECK_HEADER(curses.h,have_curses_h=yes,)
+   AC_CHECK_LIB(curses, initscr, have_curses_lib=yes, , )
+   AC_CHECK_LIB(ncurses, initscr, have_ncurses_lib=yes, , )
+   AC_CHECK_LIB(pdcurses, initscr, have_pdcurses_lib=yes, , )
+
+   if test x$enable_debug = xno; then
+     AC_MSG_RESULT([Debugger not enabled])
+   elif test x$have_curses_lib = xyes -a x$have_curses_h = xyes ; then
+     LIBS="$LIBS -lcurses"
+     AC_DEFINE(C_DEBUG,1)
+     if test x$enable_debug = xheavy ; then 
+       AC_DEFINE(C_HEAVY_DEBUG,1)
+     fi
+   elif test x$have_ncurses_lib = xyes -a x$have_curses_h = xyes ; then
+     LIBS="$LIBS -lncurses"
+     AC_DEFINE(C_DEBUG,1)
+     if test x$enable_debug = xheavy ; then 
+       AC_DEFINE(C_HEAVY_DEBUG,1)
+     fi
+   elif test x$have_pdcurses_lib = xyes -a x$have_curses_h = xyes ; then
+     LIBS="$LIBS -lpdcurses"
+     AC_DEFINE(C_DEBUG,1)
+     if test x$enable_debug = xheavy ; then 
+       AC_DEFINE(C_HEAVY_DEBUG,1)
+     fi
+   else 
+     AC_MSG_ERROR([Can't find curses, which is required for debug mode])
+   fi
+],)
+
+AH_TEMPLATE(C_CORE_INLINE,[Define to 1 to use inlined memory functions in cpu core])
+AC_ARG_ENABLE(core-inline,AC_HELP_STRING([--enable-core-inline],[Enable inlined memory handling in CPU Core]),[
+  if test x$enable_core_inline = xyes ; then 
+    AC_MSG_RESULT([enabling inlined memory handling in CPU Core])
+    AC_DEFINE(C_CORE_INLINE,1)
+  fi
+],)
+
+
+dnl The target cpu checks for dynamic cores
+AH_TEMPLATE(C_TARGETCPU,[The type of cpu this target has])
+AC_MSG_CHECKING(for target cpu type) 
+case "$host_cpu" in
+  x86_64 | amd64)
+    AC_DEFINE(C_TARGETCPU,X86_64)
+    AC_MSG_RESULT(x86-64 bit compatible)
+    c_targetcpu="x86_64"
+    c_unalignedmemory=yes
+    ;;
+  i?86)
+    AC_DEFINE(C_TARGETCPU,X86)
+    AC_MSG_RESULT(x86 compatible)
+    c_targetcpu="x86"
+    c_unalignedmemory=yes
+    ;;
+   powerpc*)
+    AC_DEFINE(C_TARGETCPU,POWERPC)
+    AC_MSG_RESULT(Power PC)
+    c_targetcpu="powerpc"
+    c_unalignedmemory=yes
+    ;;
+   m68k*)
+    AC_DEFINE(C_TARGETCPU,M68K)
+    AC_MSG_RESULT(Motorola 68000)
+    c_targetcpu="m68k"
+    c_unalignedmemory=yes
+    ;;
+   *)
+    AC_DEFINE(C_TARGETCPU,UNKNOWN)
+    AC_MSG_RESULT(unknown)
+    c_unalignedmemory=no
+    ;;
+esac
+
+AC_ARG_ENABLE(dynamic-core,AC_HELP_STRING([--disable-dynamic-core],[Disable all dynamic cores]),,enable_dynamic_core=yes)
+
+AH_TEMPLATE(C_DYNAMIC_X86,[Define to 1 to use x86 dynamic cpu core])
+AC_ARG_ENABLE(dynamic-x86,AC_HELP_STRING([--disable-dynamic-x86],[Disable x86 dynamic cpu core]),,enable_dynamic_x86=yes)
+AC_MSG_CHECKING(whether x86 dynamic cpu core will be enabled) 
+if test x$enable_dynamic_x86 = xno -o x$enable_dynamic_core = xno; then 
+   AC_MSG_RESULT(no)
+else
+  if test x$c_targetcpu = xx86 ; then
+      AC_DEFINE(C_DYNAMIC_X86,1)
+      AC_MSG_RESULT(yes)
+  else
+      AC_MSG_RESULT(no)
+  fi
+fi
+
+AH_TEMPLATE(C_DYNREC,[Define to 1 to use recompiling cpu core. Can not be used together with the dynamic-x86 core])
+AC_ARG_ENABLE(dynrec,AC_HELP_STRING([--disable-dynrec],[Disable recompiling cpu core]),,enable_dynrec=yes)
+AC_MSG_CHECKING(whether recompiling cpu core will be enabled) 
+if test x$enable_dynrec = xno -o x$enable_dynamic_core = xno; then 
+   AC_MSG_RESULT(no)
+else
+dnl x86 only enable it if dynamic-x86 is disabled.
+  if test x$c_targetcpu = xx86 ; then
+    if test x$enable_dynamic_x86 = xno ; then
+        AC_DEFINE(C_DYNREC,1)
+        AC_MSG_RESULT(yes)
+    else
+        AC_MSG_RESULT([no, using dynamic-x86])
+    fi
+  else 
+    if test x$c_targetcpu = xx86_64 ; then
+        AC_DEFINE(C_DYNREC,1)
+        AC_MSG_RESULT(yes)
+    else      
+      AC_MSG_RESULT(no)
+    fi
+  fi
+fi
+
+AH_TEMPLATE(C_FPU,[Define to 1 to enable floating point emulation])
+AC_ARG_ENABLE(fpu,AC_HELP_STRING([--disable-fpu],[Disable fpu support]),,enable_fpu=yes)
+AC_MSG_CHECKING(whether fpu emulation will be enabled) 
+if test x$enable_fpu = xyes ; then 
+  AC_MSG_RESULT(yes)
+  AC_DEFINE(C_FPU,1)
+else 
+  AC_MSG_RESULT(no)
+fi 
+
+AH_TEMPLATE(C_FPU_X86,[Define to 1 to use a x86 assembly fpu core])
+AC_ARG_ENABLE(fpu-x86,AC_HELP_STRING([--disable-fpu-x86],[Disable x86 assembly fpu core]),,enable_fpu_x86=yes)
+AC_MSG_CHECKING(whether x86 assembly fpu core will be enabled) 
+if test x$enable_fpu_x86 = xno ; then 
+   AC_MSG_RESULT(no)
+else
+  if test x$enable_fpu = xyes; then
+    if test x$c_targetcpu = xx86 -o x$c_targetcpu = xx86_64; then
+        AC_DEFINE(C_FPU_X86,1)
+        AC_MSG_RESULT(yes)
+    else
+        AC_MSG_RESULT(no)
+    fi
+  else
+      AC_MSG_RESULT(no)
+  fi
+fi
+
+AH_TEMPLATE(C_UNALIGNED_MEMORY,[Define to 1 to use a unaligned memory access])
+AC_ARG_ENABLE(unaligned_memory,AC_HELP_STRING([--disable-unaligned-memory],[Disable unaligned memory access]),,enable_unaligned_memory=yes)
+AC_MSG_CHECKING(whether to enable unaligned memory access) 
+if test x$enable_unaligned_memory = xyes -a x$c_unalignedmemory = xyes; then 
+  AC_DEFINE(C_UNALIGNED_MEMORY,1)
+  AC_MSG_RESULT(yes)
+else
+  AC_MSG_RESULT(no)
+fi
+
+AH_TEMPLATE(C_SSHOT,[Define to 1 to enable screenshots, requires libpng])
+AC_CHECK_HEADER(png.h,have_png_h=yes,)
+AC_CHECK_LIB(png, png_get_io_ptr, have_png_lib=yes, ,-lz)
+if test x$have_png_lib = xyes -a x$have_png_h = xyes ; then
+  LIBS="$LIBS -lpng -lz"
+  AC_DEFINE(C_SSHOT,1)
+else
+  AC_MSG_WARN([Can't find libpng, screenshot support disabled])
+fi
+
+AH_TEMPLATE(C_MODEM,[Define to 1 to enable internal modem support, requires SDL_net])
+AH_TEMPLATE(C_IPX,[Define to 1 to enable IPX over Internet networking, requires SDL_net])
+AC_CHECK_HEADER(SDL_net.h,have_sdl_net_h=yes,)
+
+if test x$host = xi386-pc-os2-emx ; then
+  AC_MSG_CHECKING(for SDLNet_Init in SDL_net);
+  LIBS_BACKUP=$LIBS;
+  LIBS="$LIBS -lSDL_Net";
+  AC_LINK_IFELSE([AC_LANG_PROGRAM([[#include <SDL_Net.h>]],[[
+	SDLNet_Init ();
+  ]])], [AC_MSG_RESULT(yes); have_sdl_net_lib=yes], AC_MSG_RESULT(no))
+  LIBS=$LIBS_BACKUP
+else
+AC_CHECK_LIB(SDL_net, SDLNet_Init, have_sdl_net_lib=yes, , )
+fi
+if test x$have_sdl_net_lib = xyes -a x$have_sdl_net_h = xyes ; then
+   LIBS="$LIBS -lSDL_net"
+   AC_DEFINE(C_MODEM,1)
+   AC_DEFINE(C_IPX,1)
+else 
+   AC_MSG_WARN([Can't find SDL_net, internal modem and ipx disabled])
+fi
+
+AH_TEMPLATE(C_X11_XKB,[define to 1 if you have XKBlib.h and X11 lib])
+AC_CHECK_LIB(X11, main, have_x11_lib=yes, have_x11_lib=no, )
+AC_CHECK_HEADER(X11/XKBlib.h, have_x11_h=yes, have_x11_h=no, )
+AC_MSG_CHECKING(for XKBlib support)
+if test x$have_x11_lib = xyes -a x$have_x11_h = xyes ; then
+   LIBS="$LIBS -lX11"
+   AC_DEFINE(C_X11_XKB,1)
+   AC_MSG_RESULT(yes)
+else
+   AC_MSG_RESULT(no)
+fi
+
+AH_TEMPLATE(C_OPENGL,[Define to 1 to use opengl display output support])
+AC_CHECK_LIB(GL, main, have_gl_lib=yes, have_gl_lib=no , )
+AC_CHECK_LIB(opengl32, main, have_opengl32_lib=yes,have_opengl32_lib=no , )
+AC_CHECK_HEADER(GL/gl.h, have_gl_h=yes , have_gl_h=no , )
+AC_ARG_ENABLE(opengl,AC_HELP_STRING([--disable-opengl],[Disable opengl support]),,enable_opengl=yes)
+AC_MSG_CHECKING(whether opengl display output will be enabled) 
+if test x$enable_opengl = xyes; then
+case "$host" in
+    *-*-darwin*)
+       AC_MSG_RESULT(yes)
+       LIBS="$LIBS -framework OpenGL"
+       AC_DEFINE(C_OPENGL,1)
+       ;;
+    *)
+       if test x$have_gl_h = xyes -a x$have_gl_lib = xyes ; then 
+         AC_MSG_RESULT(yes)
+         LIBS="$LIBS -lGL"
+         AC_DEFINE(C_OPENGL,1)
+       elif test x$have_gl_h = xyes -a x$have_opengl32_lib = xyes ; then 
+         AC_MSG_RESULT(yes)
+         LIBS="$LIBS -lopengl32"
+         AC_DEFINE(C_OPENGL,1)
+       else
+         AC_MSG_RESULT(no)
+       fi
+       ;;
+esac
+fi
+
+AH_TEMPLATE(C_SDL_SOUND,[Define to 1 to enable SDL_sound support])
+AC_CHECK_HEADER(SDL_sound.h,have_SDL_sound_h=yes,)
+AC_CHECK_LIB(SDL_sound, Sound_Init, have_SDL_sound_init=yes,,)
+AC_CHECK_LIB(SDL_sound, Sound_Seek, have_SDL_sound_seek=yes,,)
+if test x$have_SDL_sound_h = xyes -a x$have_SDL_sound_init = xyes ; then
+  if test x$have_SDL_sound_seek = xyes ; then
+    LIBS="-lSDL_sound $LIBS"
+    AC_DEFINE(C_SDL_SOUND,1)
+   else 
+     AC_MSG_WARN([Can't find SoundSeek in libSDL_Sound, libSDL_sound support disabled])
+   fi
+else
+  AC_MSG_WARN([Can't find libSDL_sound, libSDL_sound support disabled])
+fi
+
+dnl Check for mprotect. Needed for 64 bits linux 
+AH_TEMPLATE(C_HAVE_MPROTECT,[Define to 1 if you have the mprotect function])
+AC_CHECK_HEADER([sys/mman.h], [
+AC_CHECK_FUNC([mprotect],[AC_DEFINE(C_HAVE_MPROTECT,1)])
+])
+
+dnl Setpriority
+AH_TEMPLATE(C_SET_PRIORITY,[Define to 1 if you have setpriority support])
+AC_MSG_CHECKING(for setpriority support)
+AC_LINK_IFELSE([AC_LANG_SOURCE([
+#include <sys/resource.h>
+int main(int argc,char * argv[]) {
+	return setpriority (PRIO_PROCESS, 0,PRIO_MIN+PRIO_MAX);
+};
+])],AC_MSG_RESULT(yes);AC_DEFINE(C_SET_PRIORITY,1),AC_MSG_RESULT(no))
+
+
+dnl Some target detection and actions for them
+case "$host" in
+    *-*-cygwin* | *-*-mingw32*)
+       LIBS="$LIBS -lwinmm"
+       AC_CHECK_HEADERS(ddraw.h)
+       AC_DEFINE(C_DIRECTSERIAL, 1, [ Define to 1 if you want serial passthrough support (Win32, Posix and OS/2 only).])
+       if test x$have_sdl_net_lib = xyes -a x$have_sdl_net_h = xyes ; then
+         LIBS="$LIBS -lws2_32"
+       fi
+       ;;
+    *-*-darwin*)
+       dnl We have a problem here: both Mac OS X and Darwin report 
+       dnl the same signature "powerpc-apple-darwin*" - so we have
+       dnl to do more to distinguish them.
+       dnl For now I am lazy and do not add proper detection code.
+       AC_DEFINE(MACOSX, 1, [Compiling on Mac OS X])
+       LIBS="$LIBS -framework CoreMIDI -framework AudioUnit -framework AudioToolbox"
+       AC_DEFINE(C_DIRECTSERIAL, 1, [ Define to 1 if you want serial passthrough support (Win32, Posix and OS/2).])
+       ;;
+    *-*-linux*)
+       AC_DEFINE(LINUX, 1, [Compiling on GNU/Linux])
+       AC_DEFINE(C_DIRECTSERIAL, 1, [ Define to 1 if you want serial passthrough support (Win32, Posix and OS/2).])
+       ;;
+    *-*-freebsd* | *-*-dragonfly* | *-*-netbsd* | *-*-openbsd*)
+       dnl Disabled directserial for now. It doesn't do anything without
+       dnl specifying an extra ifdef in directserial_posix.*
+       dnl directserial detection should be rewritten to test for the needed
+       dnl functions and headers. I currently do not know 
+       dnl which ones are needed for BSD
+       AC_DEFINE(BSD, 1, [Compiling on BSD])
+       AC_DEFINE(C_DIRECTSERIAL, 1, [ Define to 1 if you want serial passthrough support (Win32, Posix and OS/2).])
+       ;;
+    *-*-os2-emx*)
+       AC_DEFINE(OS2, 1, [Compiling on OS/2 EMX])
+       AC_DEFINE(C_DIRECTSERIAL, 1, [ Define to 1 if you want serial passthrough support (Win32, Posix and OS/2).])
+       ;;
+esac
+
+dnl Some stuff for the icon.
+case "$host" in
+    *-*-cygwin* | *-*-mingw32*)
+       dnl Some stuff for the ico
+       AC_CHECK_TOOL(WINDRES, windres, :)
+    ;;
+    *)
+       WINDRES=":"
+    ;;
+esac
+       AM_CONDITIONAL(HAVE_WINDRES, test "x$WINDRES" != "x:")
+       AC_SUBST(WINDRES)
+
+
+AC_CONFIG_FILES([ 
+Makefile
+src/Makefile
+src/cpu/Makefile
+src/cpu/core_full/Makefile
+src/cpu/core_normal/Makefile
+src/cpu/core_dyn_x86/Makefile
+src/cpu/core_dynrec/Makefile
+src/debug/Makefile
+src/dos/Makefile
+src/fpu/Makefile
+src/gui/Makefile
+src/hardware/Makefile
+src/hardware/serialport/Makefile
+src/ints/Makefile
+src/libs/Makefile
+src/libs/zmbv/Makefile
+src/libs/gui_tk/Makefile
+src/misc/Makefile
+src/shell/Makefile
+src/platform/Makefile
+src/platform/visualc/Makefile
+visualc_net/Makefile
+include/Makefile
+docs/Makefile
+])
+AC_OUTPUT
diff -Nur dosbox-0.74/configure.in dosbox-0.74.patch/configure.in
--- dosbox-0.74/configure.in	2010-05-10 20:58:57.000000000 +0200
+++ dosbox-0.74.patch/configure.in	1970-01-01 01:00:00.000000000 +0100
@@ -1,528 +0,0 @@
-dnl Init.
-AC_INIT(dosbox,0.74)
-AC_PREREQ(2.50)
-AC_CONFIG_SRCDIR(README)
-
-dnl Detect the canonical host and target build environment
-AC_CANONICAL_HOST
-AC_CANONICAL_BUILD
-
-dnl Setup for automake
-AM_INIT_AUTOMAKE
-AM_CONFIG_HEADER(config.h)
-
-dnl Checks for programs.
-AC_PROG_MAKE_SET
-AC_PROG_CC
-AC_PROG_CPP
-AC_PROG_CXX
-AC_PROG_INSTALL
-AC_PROG_RANLIB
-
-dnl Some needed libaries for OS2
-dnl perharps join this with the other target depended checks. move them upwards
-if test x$host = xi386-pc-os2-emx ; then
-    CXXFLAGS="$CXXFLAGS -Zmt"
-    LDFLAGS="$LDFLAGS -Zomf -Zmt"
-    LIBS="$LIBS -los2me"
-fi
-
-dnl Check for SDL
-SDL_VERSION=1.2.0
-AM_PATH_SDL($SDL_VERSION,
-            :,
-	    AC_MSG_ERROR([*** SDL version $SDL_VERSION not found!])
-)
-LIBS="$LIBS $SDL_LIBS"
-CPPFLAGS="$CPPFLAGS $SDL_CFLAGS"
-
-dnl Check if SDL is 1.2.x (1.3 not supported)
-AC_MSG_CHECKING([SDL version only being 1.2.X])
-AC_COMPILE_IFELSE([
-#include "SDL.h"
-void blah(){
-#if SDL_MINOR_VERSION != 2
-#error "Only SDL 1.2 supported"
-#endif
-;
-}
-],AC_MSG_RESULT([yes]),[
- AC_MSG_RESULT([no]) 
- AC_MSG_ERROR([Only libSDL 1.2.X supported])])
-
-dnl Checks for header files.
-
-dnl Checks for typedefs, structures, and compiler characteristics.
-AC_C_CONST
-AC_C_INLINE
-AC_TYPE_SIZE_T
-AC_STRUCT_TM
-AC_CHECK_SIZEOF(unsigned char)
-AC_CHECK_SIZEOF(unsigned short)
-AC_CHECK_SIZEOF(unsigned int)
-AC_CHECK_SIZEOF(unsigned long)
-AC_CHECK_SIZEOF(unsigned long long)
-AC_CHECK_SIZEOF(int *)
-
-dnl some semi complex check for sys/socket so it works on darwin as well
-AC_CHECK_HEADERS([stdlib.h sys/types.h])
-AC_CHECK_HEADERS([sys/socket.h  netinet/in.h pwd.h], [], [],
-[#include <stdio.h>
-#ifdef STDC_HEADERS
-# include <stdlib.h>
-# include <stddef.h>
-#else
-# ifdef HAVE_STDLIB_H
-#  include <stdlib.h>
-# endif
-#endif
-#ifdef HAVE_SYS_TYPES_H
-# include <sys/types.h>
-#endif
-])
-
-dnl check for the socklen_t (darwin doesn't always have it)
-AC_COMPILE_IFELSE([
-#include <stdio.h>
-#ifdef STDC_HEADERS
-# include <stdlib.h>
-# include <stddef.h>
-#else
-# ifdef HAVE_STDLIB_H
-#  include <stdlib.h>
-# endif
-#endif
-#ifdef HAVE_SYS_TYPES_H
-# include <sys/types.h>
-#endif
-#ifdef HAVE_SYS_SOCKET_H
-#include <sys/socket.h>
-#endif
-],[],[AC_DEFINE([socklen_t],[int],[Define to `int` if you don't have socklen_t])])
-
-AC_MSG_CHECKING(if environ can be included)
-AC_LINK_IFELSE([AC_LANG_PROGRAM([[
-#include <unistd.h>
-#include <stdlib.h>]],[[*environ;]])],
-[AC_MSG_RESULT(yes);AC_DEFINE(ENVIRON_INCLUDED,1,[environ can be included])],AC_MSG_RESULT(no))
-
-AC_MSG_CHECKING(if environ can be linked)
-AC_LINK_IFELSE([AC_LANG_PROGRAM([[extern char ** environ;]],[[*environ;]])],
-[AC_MSG_RESULT(yes);AC_DEFINE(ENVIRON_LINKED,1,[environ can be linked])],AC_MSG_RESULT(no))
-
-AC_MSG_CHECKING([if dirent includes d_type])
-AC_COMPILE_IFELSE([
-#include <sys/types.h>
-#include <dirent.h>
-void blah(){
-struct dirent d_test;
-d_test.d_type = 0;
-}],[AC_MSG_RESULT(yes);AC_DEFINE(DIRENT_HAS_D_TYPE,1,[struct dirent has d_type])],AC_MSG_RESULT(no))
-
-
-dnl Check for powf
-AC_MSG_CHECKING(for powf in libm);
-LIBS_BACKUP=$LIBS;
-LIBS="$LIBS -lm";
-AC_LINK_IFELSE([AC_LANG_PROGRAM([[#include <math.h>]],[[
-        powf(1.0f, 1.0f);
-]])], [AC_MSG_RESULT(yes)], [AC_DEFINE([DB_HAVE_NO_POWF],[1],[libm doesn't include powf])])
-LIBS=$LIBS_BACKUP
-
-
-dnl Checks for libraries.
-
-#Check if the compiler support attributes
-AH_TEMPLATE([C_HAS_ATTRIBUTE],[Determines if the compilers supports attributes for structures.])
-AC_MSG_CHECKING(if compiler allows __attribute__)
-AC_COMPILE_IFELSE([AC_LANG_PROGRAM([[
-typedef struct { } __attribute__((packed)) junk;]],
-[[ ]])],[ AC_MSG_RESULT(yes);AC_DEFINE(C_HAS_ATTRIBUTE)],AC_MSG_RESULT(no))
-
-
-#Check if the compiler supports certain attributes
-OLDCFLAGS="$CFLAGS"
-CFLAGS="-Werror"
-
-AH_TEMPLATE([C_ATTRIBUTE_ALWAYS_INLINE],[Determines if the compilers supports always_inline attribute.])
-AC_MSG_CHECKING(if compiler allows __attribute__((always_inline)) )
-AC_COMPILE_IFELSE([ void __attribute__((always_inline)) test(){}
-],[ AC_MSG_RESULT(yes);AC_DEFINE(C_ATTRIBUTE_ALWAYS_INLINE)],AC_MSG_RESULT(no))
-
-AH_TEMPLATE([C_ATTRIBUTE_FASTCALL],[Determines if the compilers supports fastcall attribute.])
-AC_MSG_CHECKING(if compiler allows __attribute__((fastcall)) )
-AC_COMPILE_IFELSE([ void __attribute__((fastcall)) test(){}
-],[ AC_MSG_RESULT(yes);AC_DEFINE(C_ATTRIBUTE_FASTCALL)],AC_MSG_RESULT(no))
-
-
-CFLAGS="$OLDCFLAGS"
-
-
-#Check if the compiler supports __builtin_expect
-#Switch language to c++
-AC_LANG_PUSH(C++)
-AH_TEMPLATE([C_HAS_BUILTIN_EXPECT],[Determines if the compilers supports __builtin_expect for branch prediction.])
-AC_MSG_CHECKING(if compiler allows __builtin_expect)
-AC_COMPILE_IFELSE([AC_LANG_PROGRAM([[]],[[
-int x=10;if( __builtin_expect ((x==1),0) ) ;
-]])], [ AC_MSG_RESULT(yes);AC_DEFINE(C_HAS_BUILTIN_EXPECT)],AC_MSG_RESULT(no))
-#switch language back
-AC_LANG_POP(C++)
-
-dnl enable disable alsa and pass it's cflags to CXXFLAGS
-AC_ARG_ENABLE(alsa-midi,
-AC_HELP_STRING([--enable-alsa-midi],[compile with alsa midi support (default yes)]),
-[ case "${enableval}" in
- yes) alsa_midi=true;;
- no)  alsa_midi=false;;
-esac],
-[alsa_midi=true])
-if test x$alsa_midi = xtrue ; then 
-  AM_PATH_ALSA(0.9.0, AC_DEFINE(HAVE_ALSA,1,[Define to 1 to use ALSA for MIDI]) , : )
-  CXXFLAGS="$CXXFLAGS $ALSA_CFLAGS"
-fi
-
-#Check for big endian machine, should #define WORDS_BIGENDIAN if so
-AC_C_BIGENDIAN
-
-#Features to enable/disable
-AH_TEMPLATE(C_DEBUG,[Define to 1 to enable internal debugger, requires libcurses])
-AH_TEMPLATE(C_HEAVY_DEBUG,[Define to 1 to enable heavy debugging, also have to enable C_DEBUG])
-AC_ARG_ENABLE(debug,AC_HELP_STRING([--enable-debug],[Enable debug mode]),[
-   AC_CHECK_HEADER(curses.h,have_curses_h=yes,)
-   AC_CHECK_LIB(curses, initscr, have_curses_lib=yes, , )
-   AC_CHECK_LIB(ncurses, initscr, have_ncurses_lib=yes, , )
-   AC_CHECK_LIB(pdcurses, initscr, have_pdcurses_lib=yes, , )
-
-   if test x$enable_debug = xno; then
-     AC_MSG_RESULT([Debugger not enabled])
-   elif test x$have_curses_lib = xyes -a x$have_curses_h = xyes ; then
-     LIBS="$LIBS -lcurses"
-     AC_DEFINE(C_DEBUG,1)
-     if test x$enable_debug = xheavy ; then 
-       AC_DEFINE(C_HEAVY_DEBUG,1)
-     fi
-   elif test x$have_ncurses_lib = xyes -a x$have_curses_h = xyes ; then
-     LIBS="$LIBS -lncurses"
-     AC_DEFINE(C_DEBUG,1)
-     if test x$enable_debug = xheavy ; then 
-       AC_DEFINE(C_HEAVY_DEBUG,1)
-     fi
-   elif test x$have_pdcurses_lib = xyes -a x$have_curses_h = xyes ; then
-     LIBS="$LIBS -lpdcurses"
-     AC_DEFINE(C_DEBUG,1)
-     if test x$enable_debug = xheavy ; then 
-       AC_DEFINE(C_HEAVY_DEBUG,1)
-     fi
-   else 
-     AC_MSG_ERROR([Can't find curses, which is required for debug mode])
-   fi
-],)
-
-AH_TEMPLATE(C_CORE_INLINE,[Define to 1 to use inlined memory functions in cpu core])
-AC_ARG_ENABLE(core-inline,AC_HELP_STRING([--enable-core-inline],[Enable inlined memory handling in CPU Core]),[
-  if test x$enable_core_inline = xyes ; then 
-    AC_MSG_RESULT([enabling inlined memory handling in CPU Core])
-    AC_DEFINE(C_CORE_INLINE,1)
-  fi
-],)
-
-
-dnl The target cpu checks for dynamic cores
-AH_TEMPLATE(C_TARGETCPU,[The type of cpu this target has])
-AC_MSG_CHECKING(for target cpu type) 
-case "$host_cpu" in
-  x86_64 | amd64)
-    AC_DEFINE(C_TARGETCPU,X86_64)
-    AC_MSG_RESULT(x86-64 bit compatible)
-    c_targetcpu="x86_64"
-    c_unalignedmemory=yes
-    ;;
-  i?86)
-    AC_DEFINE(C_TARGETCPU,X86)
-    AC_MSG_RESULT(x86 compatible)
-    c_targetcpu="x86"
-    c_unalignedmemory=yes
-    ;;
-   powerpc*)
-    AC_DEFINE(C_TARGETCPU,POWERPC)
-    AC_MSG_RESULT(Power PC)
-    c_targetcpu="powerpc"
-    c_unalignedmemory=yes
-    ;;
-   m68k*)
-    AC_DEFINE(C_TARGETCPU,M68K)
-    AC_MSG_RESULT(Motorola 68000)
-    c_targetcpu="m68k"
-    c_unalignedmemory=yes
-    ;;
-   *)
-    AC_DEFINE(C_TARGETCPU,UNKNOWN)
-    AC_MSG_RESULT(unknown)
-    c_unalignedmemory=no
-    ;;
-esac
-
-AC_ARG_ENABLE(dynamic-core,AC_HELP_STRING([--disable-dynamic-core],[Disable all dynamic cores]),,enable_dynamic_core=yes)
-
-AH_TEMPLATE(C_DYNAMIC_X86,[Define to 1 to use x86 dynamic cpu core])
-AC_ARG_ENABLE(dynamic-x86,AC_HELP_STRING([--disable-dynamic-x86],[Disable x86 dynamic cpu core]),,enable_dynamic_x86=yes)
-AC_MSG_CHECKING(whether x86 dynamic cpu core will be enabled) 
-if test x$enable_dynamic_x86 = xno -o x$enable_dynamic_core = xno; then 
-   AC_MSG_RESULT(no)
-else
-  if test x$c_targetcpu = xx86 ; then
-      AC_DEFINE(C_DYNAMIC_X86,1)
-      AC_MSG_RESULT(yes)
-  else
-      AC_MSG_RESULT(no)
-  fi
-fi
-
-AH_TEMPLATE(C_DYNREC,[Define to 1 to use recompiling cpu core. Can not be used together with the dynamic-x86 core])
-AC_ARG_ENABLE(dynrec,AC_HELP_STRING([--disable-dynrec],[Disable recompiling cpu core]),,enable_dynrec=yes)
-AC_MSG_CHECKING(whether recompiling cpu core will be enabled) 
-if test x$enable_dynrec = xno -o x$enable_dynamic_core = xno; then 
-   AC_MSG_RESULT(no)
-else
-dnl x86 only enable it if dynamic-x86 is disabled.
-  if test x$c_targetcpu = xx86 ; then
-    if test x$enable_dynamic_x86 = xno ; then
-        AC_DEFINE(C_DYNREC,1)
-        AC_MSG_RESULT(yes)
-    else
-        AC_MSG_RESULT([no, using dynamic-x86])
-    fi
-  else 
-    if test x$c_targetcpu = xx86_64 ; then
-        AC_DEFINE(C_DYNREC,1)
-        AC_MSG_RESULT(yes)
-    else      
-      AC_MSG_RESULT(no)
-    fi
-  fi
-fi
-
-AH_TEMPLATE(C_FPU,[Define to 1 to enable floating point emulation])
-AC_ARG_ENABLE(fpu,AC_HELP_STRING([--disable-fpu],[Disable fpu support]),,enable_fpu=yes)
-AC_MSG_CHECKING(whether fpu emulation will be enabled) 
-if test x$enable_fpu = xyes ; then 
-  AC_MSG_RESULT(yes)
-  AC_DEFINE(C_FPU,1)
-else 
-  AC_MSG_RESULT(no)
-fi 
-
-AH_TEMPLATE(C_FPU_X86,[Define to 1 to use a x86 assembly fpu core])
-AC_ARG_ENABLE(fpu-x86,AC_HELP_STRING([--disable-fpu-x86],[Disable x86 assembly fpu core]),,enable_fpu_x86=yes)
-AC_MSG_CHECKING(whether x86 assembly fpu core will be enabled) 
-if test x$enable_fpu_x86 = xno ; then 
-   AC_MSG_RESULT(no)
-else
-  if test x$enable_fpu = xyes; then
-    if test x$c_targetcpu = xx86 ; then
-        AC_DEFINE(C_FPU_X86,1)
-        AC_MSG_RESULT(yes)
-    else
-        AC_MSG_RESULT(no)
-    fi
-  else
-      AC_MSG_RESULT(no)
-  fi
-fi
-
-AH_TEMPLATE(C_UNALIGNED_MEMORY,[Define to 1 to use a unaligned memory access])
-AC_ARG_ENABLE(unaligned_memory,AC_HELP_STRING([--disable-unaligned-memory],[Disable unaligned memory access]),,enable_unaligned_memory=yes)
-AC_MSG_CHECKING(whether to enable unaligned memory access) 
-if test x$enable_unaligned_memory = xyes -a x$c_unalignedmemory = xyes; then 
-  AC_DEFINE(C_UNALIGNED_MEMORY,1)
-  AC_MSG_RESULT(yes)
-else
-  AC_MSG_RESULT(no)
-fi
-
-AH_TEMPLATE(C_SSHOT,[Define to 1 to enable screenshots, requires libpng])
-AC_CHECK_HEADER(png.h,have_png_h=yes,)
-AC_CHECK_LIB(png, png_get_io_ptr, have_png_lib=yes, ,-lz)
-if test x$have_png_lib = xyes -a x$have_png_h = xyes ; then
-  LIBS="$LIBS -lpng -lz"
-  AC_DEFINE(C_SSHOT,1)
-else
-  AC_MSG_WARN([Can't find libpng, screenshot support disabled])
-fi
-
-AH_TEMPLATE(C_MODEM,[Define to 1 to enable internal modem support, requires SDL_net])
-AH_TEMPLATE(C_IPX,[Define to 1 to enable IPX over Internet networking, requires SDL_net])
-AC_CHECK_HEADER(SDL_net.h,have_sdl_net_h=yes,)
-
-if test x$host = xi386-pc-os2-emx ; then
-  AC_MSG_CHECKING(for SDLNet_Init in SDL_net);
-  LIBS_BACKUP=$LIBS;
-  LIBS="$LIBS -lSDL_Net";
-  AC_LINK_IFELSE([AC_LANG_PROGRAM([[#include <SDL_Net.h>]],[[
-	SDLNet_Init ();
-  ]])], [AC_MSG_RESULT(yes); have_sdl_net_lib=yes], AC_MSG_RESULT(no))
-  LIBS=$LIBS_BACKUP
-else
-AC_CHECK_LIB(SDL_net, SDLNet_Init, have_sdl_net_lib=yes, , )
-fi
-if test x$have_sdl_net_lib = xyes -a x$have_sdl_net_h = xyes ; then
-   LIBS="$LIBS -lSDL_net"
-   AC_DEFINE(C_MODEM,1)
-   AC_DEFINE(C_IPX,1)
-else 
-   AC_MSG_WARN([Can't find SDL_net, internal modem and ipx disabled])
-fi
-
-AH_TEMPLATE(C_X11_XKB,[define to 1 if you have XKBlib.h and X11 lib])
-AC_CHECK_LIB(X11, main, have_x11_lib=yes, have_x11_lib=no, )
-AC_CHECK_HEADER(X11/XKBlib.h, have_x11_h=yes, have_x11_h=no, )
-AC_MSG_CHECKING(for XKBlib support)
-if test x$have_x11_lib = xyes -a x$have_x11_h = xyes ; then
-   LIBS="$LIBS -lX11"
-   AC_DEFINE(C_X11_XKB,1)
-   AC_MSG_RESULT(yes)
-else
-   AC_MSG_RESULT(no)
-fi
-
-AH_TEMPLATE(C_OPENGL,[Define to 1 to use opengl display output support])
-AC_CHECK_LIB(GL, main, have_gl_lib=yes, have_gl_lib=no , )
-AC_CHECK_LIB(opengl32, main, have_opengl32_lib=yes,have_opengl32_lib=no , )
-AC_CHECK_HEADER(GL/gl.h, have_gl_h=yes , have_gl_h=no , )
-AC_ARG_ENABLE(opengl,AC_HELP_STRING([--disable-opengl],[Disable opengl support]),,enable_opengl=yes)
-AC_MSG_CHECKING(whether opengl display output will be enabled) 
-if test x$enable_opengl = xyes; then
-case "$host" in
-    *-*-darwin*)
-       AC_MSG_RESULT(yes)
-       LIBS="$LIBS -framework OpenGL"
-       AC_DEFINE(C_OPENGL,1)
-       ;;
-    *)
-       if test x$have_gl_h = xyes -a x$have_gl_lib = xyes ; then 
-         AC_MSG_RESULT(yes)
-         LIBS="$LIBS -lGL"
-         AC_DEFINE(C_OPENGL,1)
-       elif test x$have_gl_h = xyes -a x$have_opengl32_lib = xyes ; then 
-         AC_MSG_RESULT(yes)
-         LIBS="$LIBS -lopengl32"
-         AC_DEFINE(C_OPENGL,1)
-       else
-         AC_MSG_RESULT(no)
-       fi
-       ;;
-esac
-fi
-
-AH_TEMPLATE(C_SDL_SOUND,[Define to 1 to enable SDL_sound support])
-AC_CHECK_HEADER(SDL_sound.h,have_SDL_sound_h=yes,)
-AC_CHECK_LIB(SDL_sound, Sound_Init, have_SDL_sound_init=yes,,)
-AC_CHECK_LIB(SDL_sound, Sound_Seek, have_SDL_sound_seek=yes,,)
-if test x$have_SDL_sound_h = xyes -a x$have_SDL_sound_init = xyes ; then
-  if test x$have_SDL_sound_seek = xyes ; then
-    LIBS="-lSDL_sound $LIBS"
-    AC_DEFINE(C_SDL_SOUND,1)
-   else 
-     AC_MSG_WARN([Can't find SoundSeek in libSDL_Sound, libSDL_sound support disabled])
-   fi
-else
-  AC_MSG_WARN([Can't find libSDL_sound, libSDL_sound support disabled])
-fi
-
-dnl Check for mprotect. Needed for 64 bits linux 
-AH_TEMPLATE(C_HAVE_MPROTECT,[Define to 1 if you have the mprotect function])
-AC_CHECK_HEADER([sys/mman.h], [
-AC_CHECK_FUNC([mprotect],[AC_DEFINE(C_HAVE_MPROTECT,1)])
-])
-
-dnl Setpriority
-AH_TEMPLATE(C_SET_PRIORITY,[Define to 1 if you have setpriority support])
-AC_MSG_CHECKING(for setpriority support)
-AC_LINK_IFELSE([
-#include <sys/resource.h>
-int main(int argc,char * argv[]) {
-	return setpriority (PRIO_PROCESS, 0,PRIO_MIN+PRIO_MAX);
-};
-],AC_MSG_RESULT(yes);AC_DEFINE(C_SET_PRIORITY,1),AC_MSG_RESULT(no))
-
-
-dnl Some target detection and actions for them
-case "$host" in
-    *-*-cygwin* | *-*-mingw32*)
-       LIBS="$LIBS -lwinmm"
-       AC_CHECK_HEADERS(ddraw.h)
-       AC_DEFINE(C_DIRECTSERIAL, 1, [ Define to 1 if you want serial passthrough support (Win32, Posix and OS/2 only).])
-       if test x$have_sdl_net_lib = xyes -a x$have_sdl_net_h = xyes ; then
-         LIBS="$LIBS -lws2_32"
-       fi
-       ;;
-    *-*-darwin*)
-       dnl We have a problem here: both Mac OS X and Darwin report 
-       dnl the same signature "powerpc-apple-darwin*" - so we have
-       dnl to do more to distinguish them.
-       dnl For now I am lazy and do not add proper detection code.
-       AC_DEFINE(MACOSX, 1, [Compiling on Mac OS X])
-       LIBS="$LIBS -framework CoreMIDI -framework AudioUnit -framework AudioToolbox"
-       AC_DEFINE(C_DIRECTSERIAL, 1, [ Define to 1 if you want serial passthrough support (Win32, Posix and OS/2).])
-       ;;
-    *-*-linux*)
-       AC_DEFINE(LINUX, 1, [Compiling on GNU/Linux])
-       AC_DEFINE(C_DIRECTSERIAL, 1, [ Define to 1 if you want serial passthrough support (Win32, Posix and OS/2).])
-       ;;
-    *-*-freebsd* | *-*-dragonfly* | *-*-netbsd* | *-*-openbsd*)
-       dnl Disabled directserial for now. It doesn't do anything without
-       dnl specifying an extra ifdef in directserial_posix.*
-       dnl directserial detection should be rewritten to test for the needed
-       dnl functions and headers. I currently do not know 
-       dnl which ones are needed for BSD
-       AC_DEFINE(BSD, 1, [Compiling on BSD])
-       AC_DEFINE(C_DIRECTSERIAL, 1, [ Define to 1 if you want serial passthrough support (Win32, Posix and OS/2).])
-       ;;
-    *-*-os2-emx*)
-       AC_DEFINE(OS2, 1, [Compiling on OS/2 EMX])
-       AC_DEFINE(C_DIRECTSERIAL, 1, [ Define to 1 if you want serial passthrough support (Win32, Posix and OS/2).])
-       ;;
-esac
-
-dnl Some stuff for the icon.
-case "$host" in
-    *-*-cygwin* | *-*-mingw32*)
-       dnl Some stuff for the ico
-       AC_CHECK_TOOL(WINDRES, windres, :)
-    ;;
-    *)
-       WINDRES=":"
-    ;;
-esac
-       AM_CONDITIONAL(HAVE_WINDRES, test "x$WINDRES" != "x:")
-       AC_SUBST(WINDRES)
-
-
-AC_CONFIG_FILES([ 
-Makefile
-src/Makefile
-src/cpu/Makefile
-src/cpu/core_full/Makefile
-src/cpu/core_normal/Makefile
-src/cpu/core_dyn_x86/Makefile
-src/cpu/core_dynrec/Makefile
-src/debug/Makefile
-src/dos/Makefile
-src/fpu/Makefile
-src/gui/Makefile
-src/hardware/Makefile
-src/hardware/serialport/Makefile
-src/ints/Makefile
-src/libs/Makefile
-src/libs/zmbv/Makefile
-src/libs/gui_tk/Makefile
-src/misc/Makefile
-src/shell/Makefile
-src/platform/Makefile
-src/platform/visualc/Makefile
-visualc_net/Makefile
-include/Makefile
-docs/Makefile
-])
-AC_OUTPUT
diff -Nur dosbox-0.74/depcomp dosbox-0.74.patch/depcomp
--- dosbox-0.74/depcomp	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/depcomp	1970-01-01 01:00:00.000000000 +0100
@@ -1,630 +0,0 @@
-#! /bin/sh
-# depcomp - compile a program generating dependencies as side-effects
-
-scriptversion=2009-04-28.21; # UTC
-
-# Copyright (C) 1999, 2000, 2003, 2004, 2005, 2006, 2007, 2009 Free
-# Software Foundation, Inc.
-
-# This program is free software; you can redistribute it and/or modify
-# it under the terms of the GNU General Public License as published by
-# the Free Software Foundation; either version 2, or (at your option)
-# any later version.
-
-# This program is distributed in the hope that it will be useful,
-# but WITHOUT ANY WARRANTY; without even the implied warranty of
-# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-# GNU General Public License for more details.
-
-# You should have received a copy of the GNU General Public License
-# along with this program.  If not, see <http://www.gnu.org/licenses/>.
-
-# As a special exception to the GNU General Public License, if you
-# distribute this file as part of a program that contains a
-# configuration script generated by Autoconf, you may include it under
-# the same distribution terms that you use for the rest of that program.
-
-# Originally written by Alexandre Oliva <oliva@dcc.unicamp.br>.
-
-case $1 in
-  '')
-     echo "$0: No command.  Try \`$0 --help' for more information." 1>&2
-     exit 1;
-     ;;
-  -h | --h*)
-    cat <<\EOF
-Usage: depcomp [--help] [--version] PROGRAM [ARGS]
-
-Run PROGRAMS ARGS to compile a file, generating dependencies
-as side-effects.
-
-Environment variables:
-  depmode     Dependency tracking mode.
-  source      Source file read by `PROGRAMS ARGS'.
-  object      Object file output by `PROGRAMS ARGS'.
-  DEPDIR      directory where to store dependencies.
-  depfile     Dependency file to output.
-  tmpdepfile  Temporary file to use when outputing dependencies.
-  libtool     Whether libtool is used (yes/no).
-
-Report bugs to <bug-automake@gnu.org>.
-EOF
-    exit $?
-    ;;
-  -v | --v*)
-    echo "depcomp $scriptversion"
-    exit $?
-    ;;
-esac
-
-if test -z "$depmode" || test -z "$source" || test -z "$object"; then
-  echo "depcomp: Variables source, object and depmode must be set" 1>&2
-  exit 1
-fi
-
-# Dependencies for sub/bar.o or sub/bar.obj go into sub/.deps/bar.Po.
-depfile=${depfile-`echo "$object" |
-  sed 's|[^\\/]*$|'${DEPDIR-.deps}'/&|;s|\.\([^.]*\)$|.P\1|;s|Pobj$|Po|'`}
-tmpdepfile=${tmpdepfile-`echo "$depfile" | sed 's/\.\([^.]*\)$/.T\1/'`}
-
-rm -f "$tmpdepfile"
-
-# Some modes work just like other modes, but use different flags.  We
-# parameterize here, but still list the modes in the big case below,
-# to make depend.m4 easier to write.  Note that we *cannot* use a case
-# here, because this file can only contain one case statement.
-if test "$depmode" = hp; then
-  # HP compiler uses -M and no extra arg.
-  gccflag=-M
-  depmode=gcc
-fi
-
-if test "$depmode" = dashXmstdout; then
-   # This is just like dashmstdout with a different argument.
-   dashmflag=-xM
-   depmode=dashmstdout
-fi
-
-cygpath_u="cygpath -u -f -"
-if test "$depmode" = msvcmsys; then
-   # This is just like msvisualcpp but w/o cygpath translation.
-   # Just convert the backslash-escaped backslashes to single forward
-   # slashes to satisfy depend.m4
-   cygpath_u="sed s,\\\\\\\\,/,g"
-   depmode=msvisualcpp
-fi
-
-case "$depmode" in
-gcc3)
-## gcc 3 implements dependency tracking that does exactly what
-## we want.  Yay!  Note: for some reason libtool 1.4 doesn't like
-## it if -MD -MP comes after the -MF stuff.  Hmm.
-## Unfortunately, FreeBSD c89 acceptance of flags depends upon
-## the command line argument order; so add the flags where they
-## appear in depend2.am.  Note that the slowdown incurred here
-## affects only configure: in makefiles, %FASTDEP% shortcuts this.
-  for arg
-  do
-    case $arg in
-    -c) set fnord "$@" -MT "$object" -MD -MP -MF "$tmpdepfile" "$arg" ;;
-    *)  set fnord "$@" "$arg" ;;
-    esac
-    shift # fnord
-    shift # $arg
-  done
-  "$@"
-  stat=$?
-  if test $stat -eq 0; then :
-  else
-    rm -f "$tmpdepfile"
-    exit $stat
-  fi
-  mv "$tmpdepfile" "$depfile"
-  ;;
-
-gcc)
-## There are various ways to get dependency output from gcc.  Here's
-## why we pick this rather obscure method:
-## - Don't want to use -MD because we'd like the dependencies to end
-##   up in a subdir.  Having to rename by hand is ugly.
-##   (We might end up doing this anyway to support other compilers.)
-## - The DEPENDENCIES_OUTPUT environment variable makes gcc act like
-##   -MM, not -M (despite what the docs say).
-## - Using -M directly means running the compiler twice (even worse
-##   than renaming).
-  if test -z "$gccflag"; then
-    gccflag=-MD,
-  fi
-  "$@" -Wp,"$gccflag$tmpdepfile"
-  stat=$?
-  if test $stat -eq 0; then :
-  else
-    rm -f "$tmpdepfile"
-    exit $stat
-  fi
-  rm -f "$depfile"
-  echo "$object : \\" > "$depfile"
-  alpha=ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz
-## The second -e expression handles DOS-style file names with drive letters.
-  sed -e 's/^[^:]*: / /' \
-      -e 's/^['$alpha']:\/[^:]*: / /' < "$tmpdepfile" >> "$depfile"
-## This next piece of magic avoids the `deleted header file' problem.
-## The problem is that when a header file which appears in a .P file
-## is deleted, the dependency causes make to die (because there is
-## typically no way to rebuild the header).  We avoid this by adding
-## dummy dependencies for each header file.  Too bad gcc doesn't do
-## this for us directly.
-  tr ' ' '
-' < "$tmpdepfile" |
-## Some versions of gcc put a space before the `:'.  On the theory
-## that the space means something, we add a space to the output as
-## well.
-## Some versions of the HPUX 10.20 sed can't process this invocation
-## correctly.  Breaking it into two sed invocations is a workaround.
-    sed -e 's/^\\$//' -e '/^$/d' -e '/:$/d' | sed -e 's/$/ :/' >> "$depfile"
-  rm -f "$tmpdepfile"
-  ;;
-
-hp)
-  # This case exists only to let depend.m4 do its work.  It works by
-  # looking at the text of this script.  This case will never be run,
-  # since it is checked for above.
-  exit 1
-  ;;
-
-sgi)
-  if test "$libtool" = yes; then
-    "$@" "-Wp,-MDupdate,$tmpdepfile"
-  else
-    "$@" -MDupdate "$tmpdepfile"
-  fi
-  stat=$?
-  if test $stat -eq 0; then :
-  else
-    rm -f "$tmpdepfile"
-    exit $stat
-  fi
-  rm -f "$depfile"
-
-  if test -f "$tmpdepfile"; then  # yes, the sourcefile depend on other files
-    echo "$object : \\" > "$depfile"
-
-    # Clip off the initial element (the dependent).  Don't try to be
-    # clever and replace this with sed code, as IRIX sed won't handle
-    # lines with more than a fixed number of characters (4096 in
-    # IRIX 6.2 sed, 8192 in IRIX 6.5).  We also remove comment lines;
-    # the IRIX cc adds comments like `#:fec' to the end of the
-    # dependency line.
-    tr ' ' '
-' < "$tmpdepfile" \
-    | sed -e 's/^.*\.o://' -e 's/#.*$//' -e '/^$/ d' | \
-    tr '
-' ' ' >> "$depfile"
-    echo >> "$depfile"
-
-    # The second pass generates a dummy entry for each header file.
-    tr ' ' '
-' < "$tmpdepfile" \
-   | sed -e 's/^.*\.o://' -e 's/#.*$//' -e '/^$/ d' -e 's/$/:/' \
-   >> "$depfile"
-  else
-    # The sourcefile does not contain any dependencies, so just
-    # store a dummy comment line, to avoid errors with the Makefile
-    # "include basename.Plo" scheme.
-    echo "#dummy" > "$depfile"
-  fi
-  rm -f "$tmpdepfile"
-  ;;
-
-aix)
-  # The C for AIX Compiler uses -M and outputs the dependencies
-  # in a .u file.  In older versions, this file always lives in the
-  # current directory.  Also, the AIX compiler puts `$object:' at the
-  # start of each line; $object doesn't have directory information.
-  # Version 6 uses the directory in both cases.
-  dir=`echo "$object" | sed -e 's|/[^/]*$|/|'`
-  test "x$dir" = "x$object" && dir=
-  base=`echo "$object" | sed -e 's|^.*/||' -e 's/\.o$//' -e 's/\.lo$//'`
-  if test "$libtool" = yes; then
-    tmpdepfile1=$dir$base.u
-    tmpdepfile2=$base.u
-    tmpdepfile3=$dir.libs/$base.u
-    "$@" -Wc,-M
-  else
-    tmpdepfile1=$dir$base.u
-    tmpdepfile2=$dir$base.u
-    tmpdepfile3=$dir$base.u
-    "$@" -M
-  fi
-  stat=$?
-
-  if test $stat -eq 0; then :
-  else
-    rm -f "$tmpdepfile1" "$tmpdepfile2" "$tmpdepfile3"
-    exit $stat
-  fi
-
-  for tmpdepfile in "$tmpdepfile1" "$tmpdepfile2" "$tmpdepfile3"
-  do
-    test -f "$tmpdepfile" && break
-  done
-  if test -f "$tmpdepfile"; then
-    # Each line is of the form `foo.o: dependent.h'.
-    # Do two passes, one to just change these to
-    # `$object: dependent.h' and one to simply `dependent.h:'.
-    sed -e "s,^.*\.[a-z]*:,$object:," < "$tmpdepfile" > "$depfile"
-    # That's a tab and a space in the [].
-    sed -e 's,^.*\.[a-z]*:[	 ]*,,' -e 's,$,:,' < "$tmpdepfile" >> "$depfile"
-  else
-    # The sourcefile does not contain any dependencies, so just
-    # store a dummy comment line, to avoid errors with the Makefile
-    # "include basename.Plo" scheme.
-    echo "#dummy" > "$depfile"
-  fi
-  rm -f "$tmpdepfile"
-  ;;
-
-icc)
-  # Intel's C compiler understands `-MD -MF file'.  However on
-  #    icc -MD -MF foo.d -c -o sub/foo.o sub/foo.c
-  # ICC 7.0 will fill foo.d with something like
-  #    foo.o: sub/foo.c
-  #    foo.o: sub/foo.h
-  # which is wrong.  We want:
-  #    sub/foo.o: sub/foo.c
-  #    sub/foo.o: sub/foo.h
-  #    sub/foo.c:
-  #    sub/foo.h:
-  # ICC 7.1 will output
-  #    foo.o: sub/foo.c sub/foo.h
-  # and will wrap long lines using \ :
-  #    foo.o: sub/foo.c ... \
-  #     sub/foo.h ... \
-  #     ...
-
-  "$@" -MD -MF "$tmpdepfile"
-  stat=$?
-  if test $stat -eq 0; then :
-  else
-    rm -f "$tmpdepfile"
-    exit $stat
-  fi
-  rm -f "$depfile"
-  # Each line is of the form `foo.o: dependent.h',
-  # or `foo.o: dep1.h dep2.h \', or ` dep3.h dep4.h \'.
-  # Do two passes, one to just change these to
-  # `$object: dependent.h' and one to simply `dependent.h:'.
-  sed "s,^[^:]*:,$object :," < "$tmpdepfile" > "$depfile"
-  # Some versions of the HPUX 10.20 sed can't process this invocation
-  # correctly.  Breaking it into two sed invocations is a workaround.
-  sed 's,^[^:]*: \(.*\)$,\1,;s/^\\$//;/^$/d;/:$/d' < "$tmpdepfile" |
-    sed -e 's/$/ :/' >> "$depfile"
-  rm -f "$tmpdepfile"
-  ;;
-
-hp2)
-  # The "hp" stanza above does not work with aCC (C++) and HP's ia64
-  # compilers, which have integrated preprocessors.  The correct option
-  # to use with these is +Maked; it writes dependencies to a file named
-  # 'foo.d', which lands next to the object file, wherever that
-  # happens to be.
-  # Much of this is similar to the tru64 case; see comments there.
-  dir=`echo "$object" | sed -e 's|/[^/]*$|/|'`
-  test "x$dir" = "x$object" && dir=
-  base=`echo "$object" | sed -e 's|^.*/||' -e 's/\.o$//' -e 's/\.lo$//'`
-  if test "$libtool" = yes; then
-    tmpdepfile1=$dir$base.d
-    tmpdepfile2=$dir.libs/$base.d
-    "$@" -Wc,+Maked
-  else
-    tmpdepfile1=$dir$base.d
-    tmpdepfile2=$dir$base.d
-    "$@" +Maked
-  fi
-  stat=$?
-  if test $stat -eq 0; then :
-  else
-     rm -f "$tmpdepfile1" "$tmpdepfile2"
-     exit $stat
-  fi
-
-  for tmpdepfile in "$tmpdepfile1" "$tmpdepfile2"
-  do
-    test -f "$tmpdepfile" && break
-  done
-  if test -f "$tmpdepfile"; then
-    sed -e "s,^.*\.[a-z]*:,$object:," "$tmpdepfile" > "$depfile"
-    # Add `dependent.h:' lines.
-    sed -ne '2,${
-	       s/^ *//
-	       s/ \\*$//
-	       s/$/:/
-	       p
-	     }' "$tmpdepfile" >> "$depfile"
-  else
-    echo "#dummy" > "$depfile"
-  fi
-  rm -f "$tmpdepfile" "$tmpdepfile2"
-  ;;
-
-tru64)
-   # The Tru64 compiler uses -MD to generate dependencies as a side
-   # effect.  `cc -MD -o foo.o ...' puts the dependencies into `foo.o.d'.
-   # At least on Alpha/Redhat 6.1, Compaq CCC V6.2-504 seems to put
-   # dependencies in `foo.d' instead, so we check for that too.
-   # Subdirectories are respected.
-   dir=`echo "$object" | sed -e 's|/[^/]*$|/|'`
-   test "x$dir" = "x$object" && dir=
-   base=`echo "$object" | sed -e 's|^.*/||' -e 's/\.o$//' -e 's/\.lo$//'`
-
-   if test "$libtool" = yes; then
-      # With Tru64 cc, shared objects can also be used to make a
-      # static library.  This mechanism is used in libtool 1.4 series to
-      # handle both shared and static libraries in a single compilation.
-      # With libtool 1.4, dependencies were output in $dir.libs/$base.lo.d.
-      #
-      # With libtool 1.5 this exception was removed, and libtool now
-      # generates 2 separate objects for the 2 libraries.  These two
-      # compilations output dependencies in $dir.libs/$base.o.d and
-      # in $dir$base.o.d.  We have to check for both files, because
-      # one of the two compilations can be disabled.  We should prefer
-      # $dir$base.o.d over $dir.libs/$base.o.d because the latter is
-      # automatically cleaned when .libs/ is deleted, while ignoring
-      # the former would cause a distcleancheck panic.
-      tmpdepfile1=$dir.libs/$base.lo.d   # libtool 1.4
-      tmpdepfile2=$dir$base.o.d          # libtool 1.5
-      tmpdepfile3=$dir.libs/$base.o.d    # libtool 1.5
-      tmpdepfile4=$dir.libs/$base.d      # Compaq CCC V6.2-504
-      "$@" -Wc,-MD
-   else
-      tmpdepfile1=$dir$base.o.d
-      tmpdepfile2=$dir$base.d
-      tmpdepfile3=$dir$base.d
-      tmpdepfile4=$dir$base.d
-      "$@" -MD
-   fi
-
-   stat=$?
-   if test $stat -eq 0; then :
-   else
-      rm -f "$tmpdepfile1" "$tmpdepfile2" "$tmpdepfile3" "$tmpdepfile4"
-      exit $stat
-   fi
-
-   for tmpdepfile in "$tmpdepfile1" "$tmpdepfile2" "$tmpdepfile3" "$tmpdepfile4"
-   do
-     test -f "$tmpdepfile" && break
-   done
-   if test -f "$tmpdepfile"; then
-      sed -e "s,^.*\.[a-z]*:,$object:," < "$tmpdepfile" > "$depfile"
-      # That's a tab and a space in the [].
-      sed -e 's,^.*\.[a-z]*:[	 ]*,,' -e 's,$,:,' < "$tmpdepfile" >> "$depfile"
-   else
-      echo "#dummy" > "$depfile"
-   fi
-   rm -f "$tmpdepfile"
-   ;;
-
-#nosideeffect)
-  # This comment above is used by automake to tell side-effect
-  # dependency tracking mechanisms from slower ones.
-
-dashmstdout)
-  # Important note: in order to support this mode, a compiler *must*
-  # always write the preprocessed file to stdout, regardless of -o.
-  "$@" || exit $?
-
-  # Remove the call to Libtool.
-  if test "$libtool" = yes; then
-    while test "X$1" != 'X--mode=compile'; do
-      shift
-    done
-    shift
-  fi
-
-  # Remove `-o $object'.
-  IFS=" "
-  for arg
-  do
-    case $arg in
-    -o)
-      shift
-      ;;
-    $object)
-      shift
-      ;;
-    *)
-      set fnord "$@" "$arg"
-      shift # fnord
-      shift # $arg
-      ;;
-    esac
-  done
-
-  test -z "$dashmflag" && dashmflag=-M
-  # Require at least two characters before searching for `:'
-  # in the target name.  This is to cope with DOS-style filenames:
-  # a dependency such as `c:/foo/bar' could be seen as target `c' otherwise.
-  "$@" $dashmflag |
-    sed 's:^[  ]*[^: ][^:][^:]*\:[    ]*:'"$object"'\: :' > "$tmpdepfile"
-  rm -f "$depfile"
-  cat < "$tmpdepfile" > "$depfile"
-  tr ' ' '
-' < "$tmpdepfile" | \
-## Some versions of the HPUX 10.20 sed can't process this invocation
-## correctly.  Breaking it into two sed invocations is a workaround.
-    sed -e 's/^\\$//' -e '/^$/d' -e '/:$/d' | sed -e 's/$/ :/' >> "$depfile"
-  rm -f "$tmpdepfile"
-  ;;
-
-dashXmstdout)
-  # This case only exists to satisfy depend.m4.  It is never actually
-  # run, as this mode is specially recognized in the preamble.
-  exit 1
-  ;;
-
-makedepend)
-  "$@" || exit $?
-  # Remove any Libtool call
-  if test "$libtool" = yes; then
-    while test "X$1" != 'X--mode=compile'; do
-      shift
-    done
-    shift
-  fi
-  # X makedepend
-  shift
-  cleared=no eat=no
-  for arg
-  do
-    case $cleared in
-    no)
-      set ""; shift
-      cleared=yes ;;
-    esac
-    if test $eat = yes; then
-      eat=no
-      continue
-    fi
-    case "$arg" in
-    -D*|-I*)
-      set fnord "$@" "$arg"; shift ;;
-    # Strip any option that makedepend may not understand.  Remove
-    # the object too, otherwise makedepend will parse it as a source file.
-    -arch)
-      eat=yes ;;
-    -*|$object)
-      ;;
-    *)
-      set fnord "$@" "$arg"; shift ;;
-    esac
-  done
-  obj_suffix=`echo "$object" | sed 's/^.*\././'`
-  touch "$tmpdepfile"
-  ${MAKEDEPEND-makedepend} -o"$obj_suffix" -f"$tmpdepfile" "$@"
-  rm -f "$depfile"
-  cat < "$tmpdepfile" > "$depfile"
-  sed '1,2d' "$tmpdepfile" | tr ' ' '
-' | \
-## Some versions of the HPUX 10.20 sed can't process this invocation
-## correctly.  Breaking it into two sed invocations is a workaround.
-    sed -e 's/^\\$//' -e '/^$/d' -e '/:$/d' | sed -e 's/$/ :/' >> "$depfile"
-  rm -f "$tmpdepfile" "$tmpdepfile".bak
-  ;;
-
-cpp)
-  # Important note: in order to support this mode, a compiler *must*
-  # always write the preprocessed file to stdout.
-  "$@" || exit $?
-
-  # Remove the call to Libtool.
-  if test "$libtool" = yes; then
-    while test "X$1" != 'X--mode=compile'; do
-      shift
-    done
-    shift
-  fi
-
-  # Remove `-o $object'.
-  IFS=" "
-  for arg
-  do
-    case $arg in
-    -o)
-      shift
-      ;;
-    $object)
-      shift
-      ;;
-    *)
-      set fnord "$@" "$arg"
-      shift # fnord
-      shift # $arg
-      ;;
-    esac
-  done
-
-  "$@" -E |
-    sed -n -e '/^# [0-9][0-9]* "\([^"]*\)".*/ s:: \1 \\:p' \
-       -e '/^#line [0-9][0-9]* "\([^"]*\)".*/ s:: \1 \\:p' |
-    sed '$ s: \\$::' > "$tmpdepfile"
-  rm -f "$depfile"
-  echo "$object : \\" > "$depfile"
-  cat < "$tmpdepfile" >> "$depfile"
-  sed < "$tmpdepfile" '/^$/d;s/^ //;s/ \\$//;s/$/ :/' >> "$depfile"
-  rm -f "$tmpdepfile"
-  ;;
-
-msvisualcpp)
-  # Important note: in order to support this mode, a compiler *must*
-  # always write the preprocessed file to stdout.
-  "$@" || exit $?
-
-  # Remove the call to Libtool.
-  if test "$libtool" = yes; then
-    while test "X$1" != 'X--mode=compile'; do
-      shift
-    done
-    shift
-  fi
-
-  IFS=" "
-  for arg
-  do
-    case "$arg" in
-    -o)
-      shift
-      ;;
-    $object)
-      shift
-      ;;
-    "-Gm"|"/Gm"|"-Gi"|"/Gi"|"-ZI"|"/ZI")
-	set fnord "$@"
-	shift
-	shift
-	;;
-    *)
-	set fnord "$@" "$arg"
-	shift
-	shift
-	;;
-    esac
-  done
-  "$@" -E 2>/dev/null |
-  sed -n '/^#line [0-9][0-9]* "\([^"]*\)"/ s::\1:p' | $cygpath_u | sort -u > "$tmpdepfile"
-  rm -f "$depfile"
-  echo "$object : \\" > "$depfile"
-  sed < "$tmpdepfile" -n -e 's% %\\ %g' -e '/^\(.*\)$/ s::	\1 \\:p' >> "$depfile"
-  echo "	" >> "$depfile"
-  sed < "$tmpdepfile" -n -e 's% %\\ %g' -e '/^\(.*\)$/ s::\1\::p' >> "$depfile"
-  rm -f "$tmpdepfile"
-  ;;
-
-msvcmsys)
-  # This case exists only to let depend.m4 do its work.  It works by
-  # looking at the text of this script.  This case will never be run,
-  # since it is checked for above.
-  exit 1
-  ;;
-
-none)
-  exec "$@"
-  ;;
-
-*)
-  echo "Unknown depmode $depmode" 1>&2
-  exit 1
-  ;;
-esac
-
-exit 0
-
-# Local Variables:
-# mode: shell-script
-# sh-indentation: 2
-# eval: (add-hook 'write-file-hooks 'time-stamp)
-# time-stamp-start: "scriptversion="
-# time-stamp-format: "%:y-%02m-%02d.%02H"
-# time-stamp-time-zone: "UTC"
-# time-stamp-end: "; # UTC"
-# End:
diff -Nur dosbox-0.74/docs/dosbox.1 dosbox-0.74.patch/docs/dosbox.1
--- dosbox-0.74/docs/dosbox.1	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/docs/dosbox.1	2016-12-11 18:35:15.490284007 +0100
@@ -111,7 +111,7 @@
 .RI " move to second " program " if the first one fails to start."
 .TP
 .BI \-opencaptures " program"
-.RI "calls " program " with as  first paramater the location of the captures folder."
+.RI "calls " program " with as  first parameter the location of the captures folder."
 .TP
 .B \-printconf
 prints the location of the default configuration file.
@@ -205,7 +205,7 @@
 .RS
 .TP
 .B \-securemode
-.RB Switches dosbox " to a more secure mode. In this mode the"
+.RB "Switches " dosbox " to a more secure mode. In this mode the"
 .RI "internal commands " MOUNT ", " IMGMOUNT " and " BOOT " won\'t work."
 It\'s not possible
 either to create a new configfile or languagefile in this mode.
@@ -216,9 +216,9 @@
 The configuration file controls various settings of 
 .BR dosbox ": The amount of emulated memory,"
 the emulated soundcards and many
-.RI "more things. It futher allows acces to " AUTOEXEC.BAT .
+.RI "more things. It further allows access to " AUTOEXEC.BAT .
 .LP
-The language file controls all visible ouput of the internal commands and
+The language file controls all visible output of the internal commands and
 the internal dos. 
 .RB "See the section " FILES " for more information."
 .TP 
@@ -242,11 +242,21 @@
 Frees all memory eaten up by loadfix.
 .RE
 .TP
-.B RESCAN
+.B RESCAN [\-All] [Drive:]
 .LP
 .RB "Make " dosbox " reread the directory structure. Useful if you changed
 .RB "something on a mounted drive outside " dosbox ".(CTRL\-F4 does"
 this as well!)
+.RS
+.TP
+.B \-All
+.R Reread directory structure for all drives.
+.TP
+.B Drive:
+.RB "Reread directory structure for drive " Drive:
+.RE
+.LP
+.RB "If both " \-All " and " Drive: " are missing, then the current drive is used.
 .TP
 .B IMGMOUNT
 .LP
@@ -335,7 +345,7 @@
 capacity, it will produce the same effect as slowing down the emulation.
 This maximum will vary from computer to computer, there is no standard.
 .SH "SYSTEM REQUIREMENTS"
-Fast machine. My guess would be pentium\-2 400+ to get decent emulation
+Fast machine. My guess would be Pentium\-2 400+ to get decent emulation
 of games written for an 286 machine.
 For protected mode games a 1 Ghz machine is recommended and don't expect
 them to run fast though!! Be sure to read the next section on how to speed
diff -Nur dosbox-0.74/docs/Makefile.in dosbox-0.74.patch/docs/Makefile.in
--- dosbox-0.74/docs/Makefile.in	2010-05-12 11:57:43.000000000 +0200
+++ dosbox-0.74.patch/docs/Makefile.in	1970-01-01 01:00:00.000000000 +0100
@@ -1,421 +0,0 @@
-# Makefile.in generated by automake 1.11.1 from Makefile.am.
-# @configure_input@
-
-# Copyright (C) 1994, 1995, 1996, 1997, 1998, 1999, 2000, 2001, 2002,
-# 2003, 2004, 2005, 2006, 2007, 2008, 2009  Free Software Foundation,
-# Inc.
-# This Makefile.in is free software; the Free Software Foundation
-# gives unlimited permission to copy and/or distribute it,
-# with or without modifications, as long as this notice is preserved.
-
-# This program is distributed in the hope that it will be useful,
-# but WITHOUT ANY WARRANTY, to the extent permitted by law; without
-# even the implied warranty of MERCHANTABILITY or FITNESS FOR A
-# PARTICULAR PURPOSE.
-
-@SET_MAKE@
-
-# Main Makefile for DOSBox
-VPATH = @srcdir@
-pkgdatadir = $(datadir)/@PACKAGE@
-pkgincludedir = $(includedir)/@PACKAGE@
-pkglibdir = $(libdir)/@PACKAGE@
-pkglibexecdir = $(libexecdir)/@PACKAGE@
-am__cd = CDPATH="$${ZSH_VERSION+.}$(PATH_SEPARATOR)" && cd
-install_sh_DATA = $(install_sh) -c -m 644
-install_sh_PROGRAM = $(install_sh) -c
-install_sh_SCRIPT = $(install_sh) -c
-INSTALL_HEADER = $(INSTALL_DATA)
-transform = $(program_transform_name)
-NORMAL_INSTALL = :
-PRE_INSTALL = :
-POST_INSTALL = :
-NORMAL_UNINSTALL = :
-PRE_UNINSTALL = :
-POST_UNINSTALL = :
-build_triplet = @build@
-host_triplet = @host@
-subdir = docs
-DIST_COMMON = $(srcdir)/Makefile.am $(srcdir)/Makefile.in
-ACLOCAL_M4 = $(top_srcdir)/aclocal.m4
-am__aclocal_m4_deps = $(top_srcdir)/acinclude.m4 \
-	$(top_srcdir)/configure.in
-am__configure_deps = $(am__aclocal_m4_deps) $(CONFIGURE_DEPENDENCIES) \
-	$(ACLOCAL_M4)
-mkinstalldirs = $(install_sh) -d
-CONFIG_HEADER = $(top_builddir)/config.h
-CONFIG_CLEAN_FILES =
-CONFIG_CLEAN_VPATH_FILES =
-SOURCES =
-DIST_SOURCES =
-am__vpath_adj_setup = srcdirstrip=`echo "$(srcdir)" | sed 's|.|.|g'`;
-am__vpath_adj = case $$p in \
-    $(srcdir)/*) f=`echo "$$p" | sed "s|^$$srcdirstrip/||"`;; \
-    *) f=$$p;; \
-  esac;
-am__strip_dir = f=`echo $$p | sed -e 's|^.*/||'`;
-am__install_max = 40
-am__nobase_strip_setup = \
-  srcdirstrip=`echo "$(srcdir)" | sed 's/[].[^$$\\*|]/\\\\&/g'`
-am__nobase_strip = \
-  for p in $$list; do echo "$$p"; done | sed -e "s|$$srcdirstrip/||"
-am__nobase_list = $(am__nobase_strip_setup); \
-  for p in $$list; do echo "$$p $$p"; done | \
-  sed "s| $$srcdirstrip/| |;"' / .*\//!s/ .*/ ./; s,\( .*\)/[^/]*$$,\1,' | \
-  $(AWK) 'BEGIN { files["."] = "" } { files[$$2] = files[$$2] " " $$1; \
-    if (++n[$$2] == $(am__install_max)) \
-      { print $$2, files[$$2]; n[$$2] = 0; files[$$2] = "" } } \
-    END { for (dir in files) print dir, files[dir] }'
-am__base_list = \
-  sed '$$!N;$$!N;$$!N;$$!N;$$!N;$$!N;$$!N;s/\n/ /g' | \
-  sed '$$!N;$$!N;$$!N;$$!N;s/\n/ /g'
-man1dir = $(mandir)/man1
-am__installdirs = "$(DESTDIR)$(man1dir)"
-NROFF = nroff
-MANS = $(man_MANS)
-DISTFILES = $(DIST_COMMON) $(DIST_SOURCES) $(TEXINFOS) $(EXTRA_DIST)
-ACLOCAL = @ACLOCAL@
-ALSA_CFLAGS = @ALSA_CFLAGS@
-ALSA_LIBS = @ALSA_LIBS@
-AMTAR = @AMTAR@
-AUTOCONF = @AUTOCONF@
-AUTOHEADER = @AUTOHEADER@
-AUTOMAKE = @AUTOMAKE@
-AWK = @AWK@
-CC = @CC@
-CCDEPMODE = @CCDEPMODE@
-CFLAGS = @CFLAGS@
-CPP = @CPP@
-CPPFLAGS = @CPPFLAGS@
-CXX = @CXX@
-CXXDEPMODE = @CXXDEPMODE@
-CXXFLAGS = @CXXFLAGS@
-CYGPATH_W = @CYGPATH_W@
-DEFS = @DEFS@
-DEPDIR = @DEPDIR@
-ECHO_C = @ECHO_C@
-ECHO_N = @ECHO_N@
-ECHO_T = @ECHO_T@
-EGREP = @EGREP@
-EXEEXT = @EXEEXT@
-GREP = @GREP@
-INSTALL = @INSTALL@
-INSTALL_DATA = @INSTALL_DATA@
-INSTALL_PROGRAM = @INSTALL_PROGRAM@
-INSTALL_SCRIPT = @INSTALL_SCRIPT@
-INSTALL_STRIP_PROGRAM = @INSTALL_STRIP_PROGRAM@
-LDFLAGS = @LDFLAGS@
-LIBOBJS = @LIBOBJS@
-LIBS = @LIBS@
-LTLIBOBJS = @LTLIBOBJS@
-MAKEINFO = @MAKEINFO@
-MKDIR_P = @MKDIR_P@
-OBJEXT = @OBJEXT@
-PACKAGE = @PACKAGE@
-PACKAGE_BUGREPORT = @PACKAGE_BUGREPORT@
-PACKAGE_NAME = @PACKAGE_NAME@
-PACKAGE_STRING = @PACKAGE_STRING@
-PACKAGE_TARNAME = @PACKAGE_TARNAME@
-PACKAGE_URL = @PACKAGE_URL@
-PACKAGE_VERSION = @PACKAGE_VERSION@
-PATH_SEPARATOR = @PATH_SEPARATOR@
-RANLIB = @RANLIB@
-SDL_CFLAGS = @SDL_CFLAGS@
-SDL_CONFIG = @SDL_CONFIG@
-SDL_LIBS = @SDL_LIBS@
-SET_MAKE = @SET_MAKE@
-SHELL = @SHELL@
-STRIP = @STRIP@
-VERSION = @VERSION@
-WINDRES = @WINDRES@
-abs_builddir = @abs_builddir@
-abs_srcdir = @abs_srcdir@
-abs_top_builddir = @abs_top_builddir@
-abs_top_srcdir = @abs_top_srcdir@
-ac_ct_CC = @ac_ct_CC@
-ac_ct_CXX = @ac_ct_CXX@
-am__include = @am__include@
-am__leading_dot = @am__leading_dot@
-am__quote = @am__quote@
-am__tar = @am__tar@
-am__untar = @am__untar@
-bindir = @bindir@
-build = @build@
-build_alias = @build_alias@
-build_cpu = @build_cpu@
-build_os = @build_os@
-build_vendor = @build_vendor@
-builddir = @builddir@
-datadir = @datadir@
-datarootdir = @datarootdir@
-docdir = @docdir@
-dvidir = @dvidir@
-exec_prefix = @exec_prefix@
-host = @host@
-host_alias = @host_alias@
-host_cpu = @host_cpu@
-host_os = @host_os@
-host_vendor = @host_vendor@
-htmldir = @htmldir@
-includedir = @includedir@
-infodir = @infodir@
-install_sh = @install_sh@
-libdir = @libdir@
-libexecdir = @libexecdir@
-localedir = @localedir@
-localstatedir = @localstatedir@
-mandir = @mandir@
-mkdir_p = @mkdir_p@
-oldincludedir = @oldincludedir@
-pdfdir = @pdfdir@
-prefix = @prefix@
-program_transform_name = @program_transform_name@
-psdir = @psdir@
-sbindir = @sbindir@
-sharedstatedir = @sharedstatedir@
-srcdir = @srcdir@
-sysconfdir = @sysconfdir@
-target_alias = @target_alias@
-top_build_prefix = @top_build_prefix@
-top_builddir = @top_builddir@
-top_srcdir = @top_srcdir@
-man_MANS = dosbox.1 
-EXTRA_DIST = $(man_MANS) README.video PORTING
-all: all-am
-
-.SUFFIXES:
-$(srcdir)/Makefile.in:  $(srcdir)/Makefile.am  $(am__configure_deps)
-	@for dep in $?; do \
-	  case '$(am__configure_deps)' in \
-	    *$$dep*) \
-	      ( cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh ) \
-	        && { if test -f $@; then exit 0; else break; fi; }; \
-	      exit 1;; \
-	  esac; \
-	done; \
-	echo ' cd $(top_srcdir) && $(AUTOMAKE) --gnu docs/Makefile'; \
-	$(am__cd) $(top_srcdir) && \
-	  $(AUTOMAKE) --gnu docs/Makefile
-.PRECIOUS: Makefile
-Makefile: $(srcdir)/Makefile.in $(top_builddir)/config.status
-	@case '$?' in \
-	  *config.status*) \
-	    cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh;; \
-	  *) \
-	    echo ' cd $(top_builddir) && $(SHELL) ./config.status $(subdir)/$@ $(am__depfiles_maybe)'; \
-	    cd $(top_builddir) && $(SHELL) ./config.status $(subdir)/$@ $(am__depfiles_maybe);; \
-	esac;
-
-$(top_builddir)/config.status: $(top_srcdir)/configure $(CONFIG_STATUS_DEPENDENCIES)
-	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
-
-$(top_srcdir)/configure:  $(am__configure_deps)
-	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
-$(ACLOCAL_M4):  $(am__aclocal_m4_deps)
-	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
-$(am__aclocal_m4_deps):
-install-man1: $(man_MANS)
-	@$(NORMAL_INSTALL)
-	test -z "$(man1dir)" || $(MKDIR_P) "$(DESTDIR)$(man1dir)"
-	@list=''; test -n "$(man1dir)" || exit 0; \
-	{ for i in $$list; do echo "$$i"; done; \
-	l2='$(man_MANS)'; for i in $$l2; do echo "$$i"; done | \
-	  sed -n '/\.1[a-z]*$$/p'; \
-	} | while read p; do \
-	  if test -f $$p; then d=; else d="$(srcdir)/"; fi; \
-	  echo "$$d$$p"; echo "$$p"; \
-	done | \
-	sed -e 'n;s,.*/,,;p;h;s,.*\.,,;s,^[^1][0-9a-z]*$$,1,;x' \
-	      -e 's,\.[0-9a-z]*$$,,;$(transform);G;s,\n,.,' | \
-	sed 'N;N;s,\n, ,g' | { \
-	list=; while read file base inst; do \
-	  if test "$$base" = "$$inst"; then list="$$list $$file"; else \
-	    echo " $(INSTALL_DATA) '$$file' '$(DESTDIR)$(man1dir)/$$inst'"; \
-	    $(INSTALL_DATA) "$$file" "$(DESTDIR)$(man1dir)/$$inst" || exit $$?; \
-	  fi; \
-	done; \
-	for i in $$list; do echo "$$i"; done | $(am__base_list) | \
-	while read files; do \
-	  test -z "$$files" || { \
-	    echo " $(INSTALL_DATA) $$files '$(DESTDIR)$(man1dir)'"; \
-	    $(INSTALL_DATA) $$files "$(DESTDIR)$(man1dir)" || exit $$?; }; \
-	done; }
-
-uninstall-man1:
-	@$(NORMAL_UNINSTALL)
-	@list=''; test -n "$(man1dir)" || exit 0; \
-	files=`{ for i in $$list; do echo "$$i"; done; \
-	l2='$(man_MANS)'; for i in $$l2; do echo "$$i"; done | \
-	  sed -n '/\.1[a-z]*$$/p'; \
-	} | sed -e 's,.*/,,;h;s,.*\.,,;s,^[^1][0-9a-z]*$$,1,;x' \
-	      -e 's,\.[0-9a-z]*$$,,;$(transform);G;s,\n,.,'`; \
-	test -z "$$files" || { \
-	  echo " ( cd '$(DESTDIR)$(man1dir)' && rm -f" $$files ")"; \
-	  cd "$(DESTDIR)$(man1dir)" && rm -f $$files; }
-tags: TAGS
-TAGS:
-
-ctags: CTAGS
-CTAGS:
-
-
-distdir: $(DISTFILES)
-	@list='$(MANS)'; if test -n "$$list"; then \
-	  list=`for p in $$list; do \
-	    if test -f $$p; then d=; else d="$(srcdir)/"; fi; \
-	    if test -f "$$d$$p"; then echo "$$d$$p"; else :; fi; done`; \
-	  if test -n "$$list" && \
-	    grep 'ab help2man is required to generate this page' $$list >/dev/null; then \
-	    echo "error: found man pages containing the \`missing help2man' replacement text:" >&2; \
-	    grep -l 'ab help2man is required to generate this page' $$list | sed 's/^/         /' >&2; \
-	    echo "       to fix them, install help2man, remove and regenerate the man pages;" >&2; \
-	    echo "       typically \`make maintainer-clean' will remove them" >&2; \
-	    exit 1; \
-	  else :; fi; \
-	else :; fi
-	@srcdirstrip=`echo "$(srcdir)" | sed 's/[].[^$$\\*]/\\\\&/g'`; \
-	topsrcdirstrip=`echo "$(top_srcdir)" | sed 's/[].[^$$\\*]/\\\\&/g'`; \
-	list='$(DISTFILES)'; \
-	  dist_files=`for file in $$list; do echo $$file; done | \
-	  sed -e "s|^$$srcdirstrip/||;t" \
-	      -e "s|^$$topsrcdirstrip/|$(top_builddir)/|;t"`; \
-	case $$dist_files in \
-	  */*) $(MKDIR_P) `echo "$$dist_files" | \
-			   sed '/\//!d;s|^|$(distdir)/|;s,/[^/]*$$,,' | \
-			   sort -u` ;; \
-	esac; \
-	for file in $$dist_files; do \
-	  if test -f $$file || test -d $$file; then d=.; else d=$(srcdir); fi; \
-	  if test -d $$d/$$file; then \
-	    dir=`echo "/$$file" | sed -e 's,/[^/]*$$,,'`; \
-	    if test -d "$(distdir)/$$file"; then \
-	      find "$(distdir)/$$file" -type d ! -perm -700 -exec chmod u+rwx {} \;; \
-	    fi; \
-	    if test -d $(srcdir)/$$file && test $$d != $(srcdir); then \
-	      cp -fpR $(srcdir)/$$file "$(distdir)$$dir" || exit 1; \
-	      find "$(distdir)/$$file" -type d ! -perm -700 -exec chmod u+rwx {} \;; \
-	    fi; \
-	    cp -fpR $$d/$$file "$(distdir)$$dir" || exit 1; \
-	  else \
-	    test -f "$(distdir)/$$file" \
-	    || cp -p $$d/$$file "$(distdir)/$$file" \
-	    || exit 1; \
-	  fi; \
-	done
-check-am: all-am
-check: check-am
-all-am: Makefile $(MANS)
-installdirs:
-	for dir in "$(DESTDIR)$(man1dir)"; do \
-	  test -z "$$dir" || $(MKDIR_P) "$$dir"; \
-	done
-install: install-am
-install-exec: install-exec-am
-install-data: install-data-am
-uninstall: uninstall-am
-
-install-am: all-am
-	@$(MAKE) $(AM_MAKEFLAGS) install-exec-am install-data-am
-
-installcheck: installcheck-am
-install-strip:
-	$(MAKE) $(AM_MAKEFLAGS) INSTALL_PROGRAM="$(INSTALL_STRIP_PROGRAM)" \
-	  install_sh_PROGRAM="$(INSTALL_STRIP_PROGRAM)" INSTALL_STRIP_FLAG=-s \
-	  `test -z '$(STRIP)' || \
-	    echo "INSTALL_PROGRAM_ENV=STRIPPROG='$(STRIP)'"` install
-mostlyclean-generic:
-
-clean-generic:
-
-distclean-generic:
-	-test -z "$(CONFIG_CLEAN_FILES)" || rm -f $(CONFIG_CLEAN_FILES)
-	-test . = "$(srcdir)" || test -z "$(CONFIG_CLEAN_VPATH_FILES)" || rm -f $(CONFIG_CLEAN_VPATH_FILES)
-
-maintainer-clean-generic:
-	@echo "This command is intended for maintainers to use"
-	@echo "it deletes files that may require special tools to rebuild."
-clean: clean-am
-
-clean-am: clean-generic mostlyclean-am
-
-distclean: distclean-am
-	-rm -f Makefile
-distclean-am: clean-am distclean-generic
-
-dvi: dvi-am
-
-dvi-am:
-
-html: html-am
-
-html-am:
-
-info: info-am
-
-info-am:
-
-install-data-am: install-man
-
-install-dvi: install-dvi-am
-
-install-dvi-am:
-
-install-exec-am:
-
-install-html: install-html-am
-
-install-html-am:
-
-install-info: install-info-am
-
-install-info-am:
-
-install-man: install-man1
-
-install-pdf: install-pdf-am
-
-install-pdf-am:
-
-install-ps: install-ps-am
-
-install-ps-am:
-
-installcheck-am:
-
-maintainer-clean: maintainer-clean-am
-	-rm -f Makefile
-maintainer-clean-am: distclean-am maintainer-clean-generic
-
-mostlyclean: mostlyclean-am
-
-mostlyclean-am: mostlyclean-generic
-
-pdf: pdf-am
-
-pdf-am:
-
-ps: ps-am
-
-ps-am:
-
-uninstall-am: uninstall-man
-
-uninstall-man: uninstall-man1
-
-.MAKE: install-am install-strip
-
-.PHONY: all all-am check check-am clean clean-generic distclean \
-	distclean-generic distdir dvi dvi-am html html-am info info-am \
-	install install-am install-data install-data-am install-dvi \
-	install-dvi-am install-exec install-exec-am install-html \
-	install-html-am install-info install-info-am install-man \
-	install-man1 install-pdf install-pdf-am install-ps \
-	install-ps-am install-strip installcheck installcheck-am \
-	installdirs maintainer-clean maintainer-clean-generic \
-	mostlyclean mostlyclean-generic pdf pdf-am ps ps-am uninstall \
-	uninstall-am uninstall-man uninstall-man1
-
-
-# Tell versions [3.59,3.63) of GNU make to not export all variables.
-# Otherwise a system limit (for SysV at least) may be exceeded.
-.NOEXPORT:
diff -Nur dosbox-0.74/include/bios_disk.h dosbox-0.74.patch/include/bios_disk.h
--- dosbox-0.74/include/bios_disk.h	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/include/bios_disk.h	2016-12-11 18:35:15.490284007 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -65,9 +65,11 @@
 
 	Bit32u sector_size;
 	Bit32u heads,cylinders,sectors;
+	Bit32u current_fpos;
 };
 
 void updateDPT(void);
+void incrementFDD(void);
 
 #define MAX_HDD_IMAGES 2
 
diff -Nur dosbox-0.74/include/bios.h dosbox-0.74.patch/include/bios.h
--- dosbox-0.74/include/bios.h	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/include/bios.h	2016-12-11 18:35:15.490284007 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -106,6 +106,7 @@
 #define BIOS_DEFAULT_IRQ0_LOCATION		(RealMake(0xf000,0xfea5))
 #define BIOS_DEFAULT_IRQ1_LOCATION		(RealMake(0xf000,0xe987))
 #define BIOS_DEFAULT_IRQ2_LOCATION		(RealMake(0xf000,0xff55))
+#define BIOS_DEFAULT_RESET_LOCATION		(RealMake(0xf000,0xe05b))
 
 /* maximum of scancodes handled by keyboard bios routines */
 #define MAX_SCAN_CODE 0x58
diff -Nur dosbox-0.74/include/callback.h dosbox-0.74.patch/include/callback.h
--- dosbox-0.74/include/callback.h	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/include/callback.h	2016-12-11 18:35:15.490284007 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: callback.h,v 1.26 2009-08-23 17:24:54 c2woody Exp $ */
 
 #ifndef DOSBOX_CALLBACK_H
 #define DOSBOX_CALLBACK_H
@@ -31,7 +30,7 @@
 enum { CB_RETN,CB_RETF,CB_RETF8,CB_IRET,CB_IRETD,CB_IRET_STI,CB_IRET_EOI_PIC1,
 		CB_IRQ0,CB_IRQ1,CB_IRQ9,CB_IRQ12,CB_IRQ12_RET,CB_IRQ6_PCJR,CB_MOUSE,
 		CB_INT29,CB_INT16,CB_HOOKABLE,CB_TDE_IRET,CB_IPXESR,CB_IPXESR_RET,
-		CB_INT21 };
+		CB_INT21,CB_INT13 };
 
 #define CB_MAX		128
 #define CB_SIZE		32
@@ -96,6 +95,8 @@
 	void Install(CallBack_Handler handler,Bitu type,const char* description);
 	void Install(CallBack_Handler handler,Bitu type,PhysPt addr,const char* description);
 
+	void Uninstall();
+
 	//Only allocate a callback number
 	void Allocate(CallBack_Handler handler,const char* description=0);
 	Bit16u Get_callback() {
diff -Nur dosbox-0.74/include/control.h dosbox-0.74.patch/include/control.h
--- dosbox-0.74/include/control.h	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/include/control.h	2016-12-11 18:35:15.490284007 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: control.h,v 1.2 2009-05-27 09:15:40 qbix79 Exp $ */
 
 #ifndef DOSBOX_CONTROL_H
 #define DOSBOX_CONTROL_H
@@ -63,7 +62,14 @@
 	void (* _start_function)(void);
 	bool secure_mode; //Sandbox mode
 public:
-	Config(CommandLine * cmd):cmdline(cmd),secure_mode(false){}
+	bool initialised;
+	std::vector<std::string> startup_params;
+	std::vector<std::string> configfiles;
+	Config(CommandLine * cmd):cmdline(cmd),secure_mode(false) {
+		startup_params.push_back(cmdline->GetFileName());
+		cmdline->FillVector(startup_params);
+		initialised=false;
+	}
 	~Config();
 
 	Section_line * AddSection_line(char const * const _name,void (*_initfunction)(Section*));
diff -Nur dosbox-0.74/include/cpu.h dosbox-0.74.patch/include/cpu.h
--- dosbox-0.74/include/cpu.h	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/include/cpu.h	2016-12-11 18:35:15.490284007 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: cpu.h,v 1.57 2009-05-27 09:15:40 qbix79 Exp $ */
 
 #ifndef DOSBOX_CPU_H
 #define DOSBOX_CPU_H
diff -Nur dosbox-0.74/include/cross.h dosbox-0.74.patch/include/cross.h
--- dosbox-0.74/include/cross.h	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/include/cross.h	2016-12-11 18:35:15.490284007 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: cross.h,v 1.21 2009-03-14 18:02:34 qbix79 Exp $ */
 
 #ifndef DOSBOX_CROSS_H
 #define DOSBOX_CROSS_H
@@ -74,6 +73,7 @@
 	static void CreatePlatformConfigDir(std::string& in);
 	static void ResolveHomedir(std::string & temp_line);
 	static void CreateDir(std::string const& temp);
+	static bool IsPathAbsolute(std::string const& in);
 };
 
 
diff -Nur dosbox-0.74/include/debug.h dosbox-0.74.patch/include/debug.h
--- dosbox-0.74/include/debug.h	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/include/debug.h	2016-12-11 18:35:15.490284007 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
diff -Nur dosbox-0.74/include/dma.h dosbox-0.74.patch/include/dma.h
--- dosbox-0.74/include/dma.h	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/include/dma.h	2016-12-11 18:35:15.494284007 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: dma.h,v 1.20 2009-07-24 09:56:14 c2woody Exp $ */
 
 #ifndef DOSBOX_DMA_H
 #define DOSBOX_DMA_H
@@ -114,6 +113,6 @@
 void CloseSecondDMAController(void);
 bool SecondDMAControllerAvailable(void);
 
-static Bit32u dma_wrapping = 0xffff;
+void DMA_SetWrapping(Bitu wrap);
 
 #endif
diff -Nur dosbox-0.74/include/dosbox.h dosbox-0.74.patch/include/dosbox.h
--- dosbox-0.74/include/dosbox.h	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/include/dosbox.h	2016-12-11 18:35:15.494284007 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,17 +16,16 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: dosbox.h,v 1.32 2009-05-27 09:15:41 qbix79 Exp $ */
 
 #ifndef DOSBOX_DOSBOX_H
 #define DOSBOX_DOSBOX_H
 
 #include "config.h"
 
-void E_Exit(const char * message,...) GCC_ATTRIBUTE( __format__(__printf__, 1, 2));
+GCC_ATTRIBUTE(noreturn) void E_Exit(const char * message,...) GCC_ATTRIBUTE( __format__(__printf__, 1, 2));
 
-void MSG_Add(const char*,const char*); //add messages to the internal langaugefile
-const char* MSG_Get(char const *);     //get messages from the internal langaugafile
+void MSG_Add(const char*,const char*); //add messages to the internal languagefile
+const char* MSG_Get(char const *);     //get messages from the internal languagefile
 
 class Section;
 
diff -Nur dosbox-0.74/include/dos_inc.h dosbox-0.74.patch/include/dos_inc.h
--- dosbox-0.74/include/dos_inc.h	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/include/dos_inc.h	2016-12-11 18:35:15.494284007 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: dos_inc.h,v 1.83 2009-10-28 21:45:12 qbix79 Exp $ */
 
 #ifndef DOSBOX_DOS_INC_H
 #define DOSBOX_DOS_INC_H
@@ -28,6 +27,8 @@
 #include "mem.h"
 #endif
 
+#include <stddef.h> //for offsetof
+
 #ifdef _MSC_VER
 #pragma pack (1)
 #endif
@@ -176,8 +177,8 @@
 bool DOS_FCBFindNext(Bit16u seg,Bit16u offset);
 Bit8u DOS_FCBRead(Bit16u seg,Bit16u offset, Bit16u numBlocks);
 Bit8u DOS_FCBWrite(Bit16u seg,Bit16u offset,Bit16u numBlocks);
-Bit8u DOS_FCBRandomRead(Bit16u seg,Bit16u offset,Bit16u numRec,bool restore);
-Bit8u DOS_FCBRandomWrite(Bit16u seg,Bit16u offset,Bit16u numRec,bool restore);
+Bit8u DOS_FCBRandomRead(Bit16u seg,Bit16u offset,Bit16u * numRec,bool restore);
+Bit8u DOS_FCBRandomWrite(Bit16u seg,Bit16u offset,Bit16u * numRec,bool restore);
 bool DOS_FCBGetFileSize(Bit16u seg,Bit16u offset);
 bool DOS_FCBDeleteFile(Bit16u seg,Bit16u offset);
 bool DOS_FCBRenameFile(Bit16u seg, Bit16u offset);
@@ -506,6 +507,7 @@
 	bool Extended(void);
 	void GetAttr(Bit8u & attr);
 	void SetAttr(Bit8u attr);
+	void SetResultAttr(Bit8u attr);
 	bool Valid(void);
 private:
 	bool extended;
@@ -636,7 +638,7 @@
 
 extern DOS_Block dos;
 
-static Bit8u RealHandle(Bit16u handle) {
+static INLINE Bit8u RealHandle(Bit16u handle) {
 	DOS_PSP psp(dos.psp());	
 	return psp.GetFileHandle(handle);
 }
diff -Nur dosbox-0.74/include/dos_system.h dosbox-0.74.patch/include/dos_system.h
--- dosbox-0.74/include/dos_system.h	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/include/dos_system.h	2016-12-11 18:35:15.494284007 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: dos_system.h,v 1.47 2009-03-04 21:08:22 c2woody Exp $ */
 
 #ifndef DOSBOX_DOS_SYSTEM_H
 #define DOSBOX_DOS_SYSTEM_H
@@ -156,8 +155,9 @@
 	public:
 		CFileInfo(void) {
 			orgname[0] = shortname[0] = 0;
-			nextEntry = shortNr = 0;
 			isDir = false;
+			id = MAX_OPENDIRS;
+			nextEntry = shortNr = 0;
 		}
 		~CFileInfo(void) {
 			for (Bit32u i=0; i<fileList.size(); i++) delete fileList[i];
@@ -167,6 +167,7 @@
 		char		orgname		[CROSS_LEN];
 		char		shortname	[DOS_NAMELENGTH_ASCII];
 		bool		isDir;
+		Bit16u		id;
 		Bitu		nextEntry;
 		Bitu		shortNr;
 		// contents
@@ -175,6 +176,8 @@
 	};
 
 private:
+	void ClearFileInfo(CFileInfo *dir);
+	void DeleteFileInfo(CFileInfo *dir);
 
 	bool		RemoveTrailingDot	(char* shortname);
 	Bits		GetLongName		(CFileInfo* info, char* shortname);
@@ -203,7 +206,6 @@
 	Bit16u		srchNr;
 	CFileInfo*	dirSearch			[MAX_OPENDIRS];
 	char		dirSearchName		[MAX_OPENDIRS];
-	bool		free				[MAX_OPENDIRS];
 	CFileInfo*	dirFindFirst		[MAX_OPENDIRS];
 	Bit16u		nextFreeFindFirst;
 
@@ -247,7 +249,7 @@
 	virtual void Activate(void) {};
 };
 
-enum { OPEN_READ=0,OPEN_WRITE=1,OPEN_READWRITE=2, DOS_NOT_INHERIT=128};
+enum { OPEN_READ=0, OPEN_WRITE=1, OPEN_READWRITE=2, OPEN_READ_NO_MOD=4, DOS_NOT_INHERIT=128};
 enum { DOS_SEEK_SET=0,DOS_SEEK_CUR=1,DOS_SEEK_END=2};
 
 
diff -Nur dosbox-0.74/include/fpu.h dosbox-0.74.patch/include/fpu.h
--- dosbox-0.74/include/fpu.h	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/include/fpu.h	2016-12-11 18:35:15.494284007 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -86,7 +86,7 @@
 	FPU_Tag		tags[9];
 	Bit16u		cw,cw_mask_all;
 	Bit16u		sw;
-	Bitu		top;
+	Bit32u		top;
 	FPU_Round	round;
 } FPU_rec;
 
diff -Nur dosbox-0.74/include/hardware.h dosbox-0.74.patch/include/hardware.h
--- dosbox-0.74/include/hardware.h	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/include/hardware.h	2016-12-11 18:35:15.494284007 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: hardware.h,v 1.17 2009-06-23 17:46:05 c2woody Exp $ */
 
 #ifndef DOSBOX_HARDWARE_H
 #define DOSBOX_HARDWARE_H
diff -Nur dosbox-0.74/include/inout.h dosbox-0.74.patch/include/inout.h
--- dosbox-0.74/include/inout.h	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/include/inout.h	2016-12-11 18:35:15.494284007 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: inout.h,v 1.13 2009-05-27 09:15:41 qbix79 Exp $ */
 
 #ifndef DOSBOX_INOUT_H
 #define DOSBOX_INOUT_H
@@ -60,11 +59,13 @@
 class IO_ReadHandleObject: private IO_Base{
 public:
 	void Install(Bitu port,IO_ReadHandler * handler,Bitu mask,Bitu range=1);
+	void Uninstall();
 	~IO_ReadHandleObject();
 };
 class IO_WriteHandleObject: private IO_Base{
 public:
 	void Install(Bitu port,IO_WriteHandler * handler,Bitu mask,Bitu range=1);
+	void Uninstall();
 	~IO_WriteHandleObject();
 };
 
diff -Nur dosbox-0.74/include/ipx.h dosbox-0.74.patch/include/ipx.h
--- dosbox-0.74/include/ipx.h	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/include/ipx.h	2016-12-11 18:35:15.494284007 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: ipx.h,v 1.13 2009-05-27 09:15:41 qbix79 Exp $ */
 
 #ifndef DOSBOX_IPX_H
 #define DOSBOX_IPX_H
diff -Nur dosbox-0.74/include/ipxserver.h dosbox-0.74.patch/include/ipxserver.h
--- dosbox-0.74/include/ipxserver.h	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/include/ipxserver.h	2016-12-11 18:35:15.494284007 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
diff -Nur dosbox-0.74/include/joystick.h dosbox-0.74.patch/include/joystick.h
--- dosbox-0.74/include/joystick.h	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/include/joystick.h	2016-12-11 18:35:15.494284007 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: joystick.h,v 1.13 2009-05-27 09:15:41 qbix79 Exp $ */
 #ifndef DOSBOX_JOYSTICK_H
 #define DOSBOX_JOYSTICK_H
 void JOYSTICK_Enable(Bitu which,bool enabled);
diff -Nur dosbox-0.74/include/keyboard.h dosbox-0.74.patch/include/keyboard.h
--- dosbox-0.74/include/keyboard.h	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/include/keyboard.h	2016-12-11 18:35:15.494284007 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
diff -Nur dosbox-0.74/include/logging.h dosbox-0.74.patch/include/logging.h
--- dosbox-0.74/include/logging.h	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/include/logging.h	2016-12-11 18:35:15.494284007 +0100
@@ -1,3 +1,21 @@
+/*
+ *  Copyright (C) 2002-2013  The DOSBox Team
+ *
+ *  This program is free software; you can redistribute it and/or modify
+ *  it under the terms of the GNU General Public License as published by
+ *  the Free Software Foundation; either version 2 of the License, or
+ *  (at your option) any later version.
+ *
+ *  This program is distributed in the hope that it will be useful,
+ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *  GNU General Public License for more details.
+ *
+ *  You should have received a copy of the GNU General Public License
+ *  along with this program; if not, write to the Free Software
+ *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+ */
+
 #ifndef DOSBOX_LOGGING_H
 #define DOSBOX_LOGGING_H
 enum LOG_TYPES {
@@ -9,6 +27,7 @@
 	LOG_PIT,LOG_KEYBOARD,LOG_PIC,
 	LOG_MOUSE,LOG_BIOS,LOG_GUI,LOG_MISC,
 	LOG_IO,
+	LOG_PCI,
 	LOG_MAX
 };
 
@@ -47,6 +66,10 @@
 	void operator()(char const* , double , double , double )					{ }
 	void operator()(char const* , double , double , double , double )					{ }
 	void operator()(char const* , double , double , double , double , double )					{ }
+	void operator()(char const* , double , double , double , double , double , double )					{ }
+	void operator()(char const* , double , double , double , double , double , double , double)					{ }
+
+
 
 	void operator()(char const* , char const* )									{ }
 	void operator()(char const* , char const* , double )							{ }
@@ -55,7 +78,7 @@
 	void operator()(char const* , double , double, char const* )						{ }
 	void operator()(char const* , char const*, char const*)				{ }
 
-
+	void operator()(char const* , double , double , double , char const* )					{ }
 }; //add missing operators to here
 	//try to avoid anything smaller than bit32...
 void GFX_ShowMsg(char const* format,...) GCC_ATTRIBUTE(__format__(__printf__, 1, 2));
diff -Nur dosbox-0.74/include/Makefile.am dosbox-0.74.patch/include/Makefile.am
--- dosbox-0.74/include/Makefile.am	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/include/Makefile.am	2016-12-11 18:35:15.494284007 +0100
@@ -20,10 +20,12 @@
 logging.h \
 mapper.h \
 mem.h \
+midi.h \
 mixer.h \
 modules.h \
 mouse.h \
 paging.h \
+pci_bus.h \
 pic.h \
 programs.h \
 render.h \
diff -Nur dosbox-0.74/include/Makefile.in dosbox-0.74.patch/include/Makefile.in
--- dosbox-0.74/include/Makefile.in	2010-05-12 11:57:43.000000000 +0200
+++ dosbox-0.74.patch/include/Makefile.in	1970-01-01 01:00:00.000000000 +0100
@@ -1,426 +0,0 @@
-# Makefile.in generated by automake 1.11.1 from Makefile.am.
-# @configure_input@
-
-# Copyright (C) 1994, 1995, 1996, 1997, 1998, 1999, 2000, 2001, 2002,
-# 2003, 2004, 2005, 2006, 2007, 2008, 2009  Free Software Foundation,
-# Inc.
-# This Makefile.in is free software; the Free Software Foundation
-# gives unlimited permission to copy and/or distribute it,
-# with or without modifications, as long as this notice is preserved.
-
-# This program is distributed in the hope that it will be useful,
-# but WITHOUT ANY WARRANTY, to the extent permitted by law; without
-# even the implied warranty of MERCHANTABILITY or FITNESS FOR A
-# PARTICULAR PURPOSE.
-
-@SET_MAKE@
-
-VPATH = @srcdir@
-pkgdatadir = $(datadir)/@PACKAGE@
-pkgincludedir = $(includedir)/@PACKAGE@
-pkglibdir = $(libdir)/@PACKAGE@
-pkglibexecdir = $(libexecdir)/@PACKAGE@
-am__cd = CDPATH="$${ZSH_VERSION+.}$(PATH_SEPARATOR)" && cd
-install_sh_DATA = $(install_sh) -c -m 644
-install_sh_PROGRAM = $(install_sh) -c
-install_sh_SCRIPT = $(install_sh) -c
-INSTALL_HEADER = $(INSTALL_DATA)
-transform = $(program_transform_name)
-NORMAL_INSTALL = :
-PRE_INSTALL = :
-POST_INSTALL = :
-NORMAL_UNINSTALL = :
-PRE_UNINSTALL = :
-POST_UNINSTALL = :
-build_triplet = @build@
-host_triplet = @host@
-subdir = include
-DIST_COMMON = $(noinst_HEADERS) $(srcdir)/Makefile.am \
-	$(srcdir)/Makefile.in
-ACLOCAL_M4 = $(top_srcdir)/aclocal.m4
-am__aclocal_m4_deps = $(top_srcdir)/acinclude.m4 \
-	$(top_srcdir)/configure.in
-am__configure_deps = $(am__aclocal_m4_deps) $(CONFIGURE_DEPENDENCIES) \
-	$(ACLOCAL_M4)
-mkinstalldirs = $(install_sh) -d
-CONFIG_HEADER = $(top_builddir)/config.h
-CONFIG_CLEAN_FILES =
-CONFIG_CLEAN_VPATH_FILES =
-SOURCES =
-DIST_SOURCES =
-HEADERS = $(noinst_HEADERS)
-ETAGS = etags
-CTAGS = ctags
-DISTFILES = $(DIST_COMMON) $(DIST_SOURCES) $(TEXINFOS) $(EXTRA_DIST)
-ACLOCAL = @ACLOCAL@
-ALSA_CFLAGS = @ALSA_CFLAGS@
-ALSA_LIBS = @ALSA_LIBS@
-AMTAR = @AMTAR@
-AUTOCONF = @AUTOCONF@
-AUTOHEADER = @AUTOHEADER@
-AUTOMAKE = @AUTOMAKE@
-AWK = @AWK@
-CC = @CC@
-CCDEPMODE = @CCDEPMODE@
-CFLAGS = @CFLAGS@
-CPP = @CPP@
-CPPFLAGS = @CPPFLAGS@
-CXX = @CXX@
-CXXDEPMODE = @CXXDEPMODE@
-CXXFLAGS = @CXXFLAGS@
-CYGPATH_W = @CYGPATH_W@
-DEFS = @DEFS@
-DEPDIR = @DEPDIR@
-ECHO_C = @ECHO_C@
-ECHO_N = @ECHO_N@
-ECHO_T = @ECHO_T@
-EGREP = @EGREP@
-EXEEXT = @EXEEXT@
-GREP = @GREP@
-INSTALL = @INSTALL@
-INSTALL_DATA = @INSTALL_DATA@
-INSTALL_PROGRAM = @INSTALL_PROGRAM@
-INSTALL_SCRIPT = @INSTALL_SCRIPT@
-INSTALL_STRIP_PROGRAM = @INSTALL_STRIP_PROGRAM@
-LDFLAGS = @LDFLAGS@
-LIBOBJS = @LIBOBJS@
-LIBS = @LIBS@
-LTLIBOBJS = @LTLIBOBJS@
-MAKEINFO = @MAKEINFO@
-MKDIR_P = @MKDIR_P@
-OBJEXT = @OBJEXT@
-PACKAGE = @PACKAGE@
-PACKAGE_BUGREPORT = @PACKAGE_BUGREPORT@
-PACKAGE_NAME = @PACKAGE_NAME@
-PACKAGE_STRING = @PACKAGE_STRING@
-PACKAGE_TARNAME = @PACKAGE_TARNAME@
-PACKAGE_URL = @PACKAGE_URL@
-PACKAGE_VERSION = @PACKAGE_VERSION@
-PATH_SEPARATOR = @PATH_SEPARATOR@
-RANLIB = @RANLIB@
-SDL_CFLAGS = @SDL_CFLAGS@
-SDL_CONFIG = @SDL_CONFIG@
-SDL_LIBS = @SDL_LIBS@
-SET_MAKE = @SET_MAKE@
-SHELL = @SHELL@
-STRIP = @STRIP@
-VERSION = @VERSION@
-WINDRES = @WINDRES@
-abs_builddir = @abs_builddir@
-abs_srcdir = @abs_srcdir@
-abs_top_builddir = @abs_top_builddir@
-abs_top_srcdir = @abs_top_srcdir@
-ac_ct_CC = @ac_ct_CC@
-ac_ct_CXX = @ac_ct_CXX@
-am__include = @am__include@
-am__leading_dot = @am__leading_dot@
-am__quote = @am__quote@
-am__tar = @am__tar@
-am__untar = @am__untar@
-bindir = @bindir@
-build = @build@
-build_alias = @build_alias@
-build_cpu = @build_cpu@
-build_os = @build_os@
-build_vendor = @build_vendor@
-builddir = @builddir@
-datadir = @datadir@
-datarootdir = @datarootdir@
-docdir = @docdir@
-dvidir = @dvidir@
-exec_prefix = @exec_prefix@
-host = @host@
-host_alias = @host_alias@
-host_cpu = @host_cpu@
-host_os = @host_os@
-host_vendor = @host_vendor@
-htmldir = @htmldir@
-includedir = @includedir@
-infodir = @infodir@
-install_sh = @install_sh@
-libdir = @libdir@
-libexecdir = @libexecdir@
-localedir = @localedir@
-localstatedir = @localstatedir@
-mandir = @mandir@
-mkdir_p = @mkdir_p@
-oldincludedir = @oldincludedir@
-pdfdir = @pdfdir@
-prefix = @prefix@
-program_transform_name = @program_transform_name@
-psdir = @psdir@
-sbindir = @sbindir@
-sharedstatedir = @sharedstatedir@
-srcdir = @srcdir@
-sysconfdir = @sysconfdir@
-target_alias = @target_alias@
-top_build_prefix = @top_build_prefix@
-top_builddir = @top_builddir@
-top_srcdir = @top_srcdir@
-noinst_HEADERS = \
-bios.h \
-bios_disk.h \
-callback.h \
-cpu.h \
-cross.h \
-control.h \
-debug.h \
-dma.h \
-dos_inc.h \
-dos_system.h \
-dosbox.h \
-fpu.h \
-hardware.h \
-inout.h \
-joystick.h \
-ipx.h \
-ipxserver.h \
-keyboard.h \
-logging.h \
-mapper.h \
-mem.h \
-mixer.h \
-modules.h \
-mouse.h \
-paging.h \
-pic.h \
-programs.h \
-render.h \
-regs.h \
-render.h \
-serialport.h \
-setup.h \
-shell.h \
-support.h \
-timer.h \
-vga.h \
-video.h
-
-all: all-am
-
-.SUFFIXES:
-$(srcdir)/Makefile.in:  $(srcdir)/Makefile.am  $(am__configure_deps)
-	@for dep in $?; do \
-	  case '$(am__configure_deps)' in \
-	    *$$dep*) \
-	      ( cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh ) \
-	        && { if test -f $@; then exit 0; else break; fi; }; \
-	      exit 1;; \
-	  esac; \
-	done; \
-	echo ' cd $(top_srcdir) && $(AUTOMAKE) --gnu include/Makefile'; \
-	$(am__cd) $(top_srcdir) && \
-	  $(AUTOMAKE) --gnu include/Makefile
-.PRECIOUS: Makefile
-Makefile: $(srcdir)/Makefile.in $(top_builddir)/config.status
-	@case '$?' in \
-	  *config.status*) \
-	    cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh;; \
-	  *) \
-	    echo ' cd $(top_builddir) && $(SHELL) ./config.status $(subdir)/$@ $(am__depfiles_maybe)'; \
-	    cd $(top_builddir) && $(SHELL) ./config.status $(subdir)/$@ $(am__depfiles_maybe);; \
-	esac;
-
-$(top_builddir)/config.status: $(top_srcdir)/configure $(CONFIG_STATUS_DEPENDENCIES)
-	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
-
-$(top_srcdir)/configure:  $(am__configure_deps)
-	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
-$(ACLOCAL_M4):  $(am__aclocal_m4_deps)
-	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
-$(am__aclocal_m4_deps):
-
-ID: $(HEADERS) $(SOURCES) $(LISP) $(TAGS_FILES)
-	list='$(SOURCES) $(HEADERS) $(LISP) $(TAGS_FILES)'; \
-	unique=`for i in $$list; do \
-	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
-	  done | \
-	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
-	      END { if (nonempty) { for (i in files) print i; }; }'`; \
-	mkid -fID $$unique
-tags: TAGS
-
-TAGS:  $(HEADERS) $(SOURCES)  $(TAGS_DEPENDENCIES) \
-		$(TAGS_FILES) $(LISP)
-	set x; \
-	here=`pwd`; \
-	list='$(SOURCES) $(HEADERS)  $(LISP) $(TAGS_FILES)'; \
-	unique=`for i in $$list; do \
-	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
-	  done | \
-	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
-	      END { if (nonempty) { for (i in files) print i; }; }'`; \
-	shift; \
-	if test -z "$(ETAGS_ARGS)$$*$$unique"; then :; else \
-	  test -n "$$unique" || unique=$$empty_fix; \
-	  if test $$# -gt 0; then \
-	    $(ETAGS) $(ETAGSFLAGS) $(AM_ETAGSFLAGS) $(ETAGS_ARGS) \
-	      "$$@" $$unique; \
-	  else \
-	    $(ETAGS) $(ETAGSFLAGS) $(AM_ETAGSFLAGS) $(ETAGS_ARGS) \
-	      $$unique; \
-	  fi; \
-	fi
-ctags: CTAGS
-CTAGS:  $(HEADERS) $(SOURCES)  $(TAGS_DEPENDENCIES) \
-		$(TAGS_FILES) $(LISP)
-	list='$(SOURCES) $(HEADERS)  $(LISP) $(TAGS_FILES)'; \
-	unique=`for i in $$list; do \
-	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
-	  done | \
-	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
-	      END { if (nonempty) { for (i in files) print i; }; }'`; \
-	test -z "$(CTAGS_ARGS)$$unique" \
-	  || $(CTAGS) $(CTAGSFLAGS) $(AM_CTAGSFLAGS) $(CTAGS_ARGS) \
-	     $$unique
-
-GTAGS:
-	here=`$(am__cd) $(top_builddir) && pwd` \
-	  && $(am__cd) $(top_srcdir) \
-	  && gtags -i $(GTAGS_ARGS) "$$here"
-
-distclean-tags:
-	-rm -f TAGS ID GTAGS GRTAGS GSYMS GPATH tags
-
-distdir: $(DISTFILES)
-	@srcdirstrip=`echo "$(srcdir)" | sed 's/[].[^$$\\*]/\\\\&/g'`; \
-	topsrcdirstrip=`echo "$(top_srcdir)" | sed 's/[].[^$$\\*]/\\\\&/g'`; \
-	list='$(DISTFILES)'; \
-	  dist_files=`for file in $$list; do echo $$file; done | \
-	  sed -e "s|^$$srcdirstrip/||;t" \
-	      -e "s|^$$topsrcdirstrip/|$(top_builddir)/|;t"`; \
-	case $$dist_files in \
-	  */*) $(MKDIR_P) `echo "$$dist_files" | \
-			   sed '/\//!d;s|^|$(distdir)/|;s,/[^/]*$$,,' | \
-			   sort -u` ;; \
-	esac; \
-	for file in $$dist_files; do \
-	  if test -f $$file || test -d $$file; then d=.; else d=$(srcdir); fi; \
-	  if test -d $$d/$$file; then \
-	    dir=`echo "/$$file" | sed -e 's,/[^/]*$$,,'`; \
-	    if test -d "$(distdir)/$$file"; then \
-	      find "$(distdir)/$$file" -type d ! -perm -700 -exec chmod u+rwx {} \;; \
-	    fi; \
-	    if test -d $(srcdir)/$$file && test $$d != $(srcdir); then \
-	      cp -fpR $(srcdir)/$$file "$(distdir)$$dir" || exit 1; \
-	      find "$(distdir)/$$file" -type d ! -perm -700 -exec chmod u+rwx {} \;; \
-	    fi; \
-	    cp -fpR $$d/$$file "$(distdir)$$dir" || exit 1; \
-	  else \
-	    test -f "$(distdir)/$$file" \
-	    || cp -p $$d/$$file "$(distdir)/$$file" \
-	    || exit 1; \
-	  fi; \
-	done
-check-am: all-am
-check: check-am
-all-am: Makefile $(HEADERS)
-installdirs:
-install: install-am
-install-exec: install-exec-am
-install-data: install-data-am
-uninstall: uninstall-am
-
-install-am: all-am
-	@$(MAKE) $(AM_MAKEFLAGS) install-exec-am install-data-am
-
-installcheck: installcheck-am
-install-strip:
-	$(MAKE) $(AM_MAKEFLAGS) INSTALL_PROGRAM="$(INSTALL_STRIP_PROGRAM)" \
-	  install_sh_PROGRAM="$(INSTALL_STRIP_PROGRAM)" INSTALL_STRIP_FLAG=-s \
-	  `test -z '$(STRIP)' || \
-	    echo "INSTALL_PROGRAM_ENV=STRIPPROG='$(STRIP)'"` install
-mostlyclean-generic:
-
-clean-generic:
-
-distclean-generic:
-	-test -z "$(CONFIG_CLEAN_FILES)" || rm -f $(CONFIG_CLEAN_FILES)
-	-test . = "$(srcdir)" || test -z "$(CONFIG_CLEAN_VPATH_FILES)" || rm -f $(CONFIG_CLEAN_VPATH_FILES)
-
-maintainer-clean-generic:
-	@echo "This command is intended for maintainers to use"
-	@echo "it deletes files that may require special tools to rebuild."
-clean: clean-am
-
-clean-am: clean-generic mostlyclean-am
-
-distclean: distclean-am
-	-rm -f Makefile
-distclean-am: clean-am distclean-generic distclean-tags
-
-dvi: dvi-am
-
-dvi-am:
-
-html: html-am
-
-html-am:
-
-info: info-am
-
-info-am:
-
-install-data-am:
-
-install-dvi: install-dvi-am
-
-install-dvi-am:
-
-install-exec-am:
-
-install-html: install-html-am
-
-install-html-am:
-
-install-info: install-info-am
-
-install-info-am:
-
-install-man:
-
-install-pdf: install-pdf-am
-
-install-pdf-am:
-
-install-ps: install-ps-am
-
-install-ps-am:
-
-installcheck-am:
-
-maintainer-clean: maintainer-clean-am
-	-rm -f Makefile
-maintainer-clean-am: distclean-am maintainer-clean-generic
-
-mostlyclean: mostlyclean-am
-
-mostlyclean-am: mostlyclean-generic
-
-pdf: pdf-am
-
-pdf-am:
-
-ps: ps-am
-
-ps-am:
-
-uninstall-am:
-
-.MAKE: install-am install-strip
-
-.PHONY: CTAGS GTAGS all all-am check check-am clean clean-generic \
-	ctags distclean distclean-generic distclean-tags distdir dvi \
-	dvi-am html html-am info info-am install install-am \
-	install-data install-data-am install-dvi install-dvi-am \
-	install-exec install-exec-am install-html install-html-am \
-	install-info install-info-am install-man install-pdf \
-	install-pdf-am install-ps install-ps-am install-strip \
-	installcheck installcheck-am installdirs maintainer-clean \
-	maintainer-clean-generic mostlyclean mostlyclean-generic pdf \
-	pdf-am ps ps-am tags uninstall uninstall-am
-
-
-# Tell versions [3.59,3.63) of GNU make to not export all variables.
-# Otherwise a system limit (for SysV at least) may be exceeded.
-.NOEXPORT:
diff -Nur dosbox-0.74/include/mapper.h dosbox-0.74.patch/include/mapper.h
--- dosbox-0.74/include/mapper.h	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/include/mapper.h	2016-12-11 18:35:15.494284007 +0100
@@ -1,5 +1,5 @@
  /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -21,7 +21,7 @@
 
 enum MapKeys {
 	MK_f1,MK_f2,MK_f3,MK_f4,MK_f5,MK_f6,MK_f7,MK_f8,MK_f9,MK_f10,MK_f11,MK_f12,
-	MK_return,MK_kpminus,MK_scrolllock,MK_printscreen,MK_pause
+	MK_return,MK_kpminus,MK_scrolllock,MK_printscreen,MK_pause,MK_home
 
 };
 
diff -Nur dosbox-0.74/include/mem.h dosbox-0.74.patch/include/mem.h
--- dosbox-0.74/include/mem.h	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/include/mem.h	2016-12-11 18:35:15.494284007 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
diff -Nur dosbox-0.74/include/midi.h dosbox-0.74.patch/include/midi.h
--- dosbox-0.74/include/midi.h	1970-01-01 01:00:00.000000000 +0100
+++ dosbox-0.74.patch/include/midi.h	2016-12-11 18:35:15.494284007 +0100
@@ -0,0 +1,60 @@
+/*
+ *  Copyright (C) 2002-2013  The DOSBox Team
+ *
+ *  This program is free software; you can redistribute it and/or modify
+ *  it under the terms of the GNU General Public License as published by
+ *  the Free Software Foundation; either version 2 of the License, or
+ *  (at your option) any later version.
+ *
+ *  This program is distributed in the hope that it will be useful,
+ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *  GNU General Public License for more details.
+ *
+ *  You should have received a copy of the GNU General Public License
+ *  along with this program; if not, write to the Free Software
+ *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+ */
+
+
+#ifndef DOSBOX_MIDI_H
+#define DOSBOX_MIDI_H
+
+#ifndef DOSBOX_PROGRAMS_H
+#include "programs.h"
+#endif
+
+class MidiHandler {
+public:
+	MidiHandler();
+	virtual bool Open(const char * /*conf*/) { return true; };
+	virtual void Close(void) {};
+	virtual void PlayMsg(Bit8u * /*msg*/) {};
+	virtual void PlaySysex(Bit8u * /*sysex*/,Bitu /*len*/) {};
+	virtual const char * GetName(void) { return "none"; };
+	virtual void ListAll(Program * base) {};
+	virtual ~MidiHandler() { };
+	MidiHandler * next;
+};
+
+
+#define SYSEX_SIZE 1024
+struct DB_Midi {
+	Bitu status;
+	Bitu cmd_len;
+	Bitu cmd_pos;
+	Bit8u cmd_buf[8];
+	Bit8u rt_buf[8];
+	struct {
+		Bit8u buf[SYSEX_SIZE];
+		Bitu used;
+		Bitu delay;
+		Bit32u start;
+	} sysex;
+	bool available;
+	MidiHandler * handler;
+};
+
+extern DB_Midi midi;
+
+#endif
diff -Nur dosbox-0.74/include/mixer.h dosbox-0.74.patch/include/mixer.h
--- dosbox-0.74/include/mixer.h	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/include/mixer.h	2016-12-11 18:35:15.494284007 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: mixer.h,v 1.19 2009-04-28 21:48:24 harekiet Exp $ */
 
 #ifndef DOSBOX_MIXER_H
 #define DOSBOX_MIXER_H
diff -Nur dosbox-0.74/include/mouse.h dosbox-0.74.patch/include/mouse.h
--- dosbox-0.74/include/mouse.h	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/include/mouse.h	2016-12-11 18:35:15.498284007 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: mouse.h,v 1.15 2009-05-27 09:15:41 qbix79 Exp $ */
 
 
 #ifndef DOSBOX_MOUSE_H
diff -Nur dosbox-0.74/include/paging.h dosbox-0.74.patch/include/paging.h
--- dosbox-0.74/include/paging.h	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/include/paging.h	2016-12-11 18:35:15.498284007 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: paging.h,v 1.33 2009-05-27 09:15:41 qbix79 Exp $ */
 
 #ifndef DOSBOX_PAGING_H
 #define DOSBOX_PAGING_H
diff -Nur dosbox-0.74/include/pci_bus.h dosbox-0.74.patch/include/pci_bus.h
--- dosbox-0.74/include/pci_bus.h	1970-01-01 01:00:00.000000000 +0100
+++ dosbox-0.74.patch/include/pci_bus.h	2016-12-11 18:35:15.498284007 +0100
@@ -0,0 +1,86 @@
+/*
+ *  Copyright (C) 2002-2013  The DOSBox Team
+ *
+ *  This program is free software; you can redistribute it and/or modify
+ *  it under the terms of the GNU General Public License as published by
+ *  the Free Software Foundation; either version 2 of the License, or
+ *  (at your option) any later version.
+ *
+ *  This program is distributed in the hope that it will be useful,
+ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *  GNU General Public License for more details.
+ *
+ *  You should have received a copy of the GNU General Public License
+ *  along with this program; if not, write to the Free Software
+ *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+ */
+
+#ifndef DOSBOX_PCI_H
+#define DOSBOX_PCI_H
+
+//#define PCI_FUNCTIONALITY_ENABLED 0
+
+#if defined PCI_FUNCTIONALITY_ENABLED
+
+#define PCI_MAX_PCIDEVICES		10
+#define PCI_MAX_PCIFUNCTIONS	8
+
+
+class PCI_Device {
+private:
+	Bits pci_id, pci_subfunction;
+	Bit16u vendor_id, device_id;
+
+	// subdevices declarations, they will respond to pci functions 1 to 7
+	// (main device is attached to function 0)
+	Bitu num_subdevices;
+	PCI_Device* subdevices[PCI_MAX_PCIFUNCTIONS-1];
+
+public:
+	PCI_Device(Bit16u vendor, Bit16u device);
+
+	Bits PCIId(void) {
+		return pci_id;
+	}
+	Bits PCISubfunction(void) {
+		return pci_subfunction;
+	}
+	Bit16u VendorID(void) {
+		return vendor_id;
+	}
+	Bit16u DeviceID(void) {
+		return device_id;
+	}
+
+	void SetPCIId(Bitu number, Bits subfct);
+
+	bool AddSubdevice(PCI_Device* dev);
+	void RemoveSubdevice(Bits subfct);
+
+	PCI_Device* GetSubdevice(Bits subfct);
+
+	Bit16u NumSubdevices(void) {
+		if (num_subdevices>PCI_MAX_PCIFUNCTIONS-1) return (Bit16u)(PCI_MAX_PCIFUNCTIONS-1);
+		return (Bit16u)num_subdevices;
+	}
+
+	Bits GetNextSubdeviceNumber(void) {
+		if (num_subdevices>=PCI_MAX_PCIFUNCTIONS-1) return -1;
+		return (Bits)num_subdevices+1;
+	}
+
+	virtual Bits ParseReadRegister(Bit8u regnum)=0;
+	virtual bool OverrideReadRegister(Bit8u regnum, Bit8u* rval, Bit8u* rval_mask)=0;
+	virtual Bits ParseWriteRegister(Bit8u regnum,Bit8u value)=0;
+	virtual bool InitializeRegisters(Bit8u registers[256])=0;
+
+};
+
+bool PCI_IsInitialized();
+
+RealPt PCI_GetPModeInterface(void);
+
+#endif
+
+#endif
diff -Nur dosbox-0.74/include/pic.h dosbox-0.74.patch/include/pic.h
--- dosbox-0.74/include/pic.h	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/include/pic.h	2016-12-11 18:35:15.498284007 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -29,11 +29,7 @@
 typedef void (* PIC_EventHandler)(Bitu val);
 
 
-#define PIC_MAXIRQ 15
-#define PIC_NOIRQ 0xFF
-
 extern Bitu PIC_IRQCheck;
-extern Bitu PIC_IRQActive;
 extern Bitu PIC_Ticks;
 
 static INLINE float PIC_TickIndex(void) {
diff -Nur dosbox-0.74/include/programs.h dosbox-0.74.patch/include/programs.h
--- dosbox-0.74/include/programs.h	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/include/programs.h	2016-12-11 18:35:15.498284007 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: programs.h,v 1.19 2009-05-27 09:15:41 qbix79 Exp $ */
 
 #ifndef DOSBOX_PROGRAMS_H
 #define DOSBOX_PROGRAMS_H
@@ -51,7 +50,10 @@
 	bool FindCommand(unsigned int which,std::string & value);
 	bool FindStringBegin(char const * const begin,std::string & value, bool remove=false);
 	bool FindStringRemain(char const * const name,std::string & value);
+	bool FindStringRemainBegin(char const * const name,std::string & value);
 	bool GetStringRemain(std::string & value);
+	int GetParameterFromList(const char* const params[], std::vector<std::string> & output);
+	void FillVector(std::vector<std::string> & vector);
 	unsigned int GetCount(void);
 	void Shift(unsigned int amount=1);
 	Bit16u Get_arglength();
diff -Nur dosbox-0.74/include/regs.h dosbox-0.74.patch/include/regs.h
--- dosbox-0.74/include/regs.h	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/include/regs.h	2016-12-11 18:35:15.498284007 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -41,7 +41,7 @@
 #define FLAG_ID		0x00200000
 
 #define FMASK_TEST		(FLAG_CF | FLAG_PF | FLAG_AF | FLAG_ZF | FLAG_SF | FLAG_OF)
-#define FMASK_NORMAL	(FMASK_TEST | FLAG_DF | FLAG_TF | FLAG_IF | FLAG_AC )	
+#define FMASK_NORMAL	(FMASK_TEST | FLAG_DF | FLAG_TF | FLAG_IF )	
 #define FMASK_ALL		(FMASK_NORMAL | FLAG_IOPL | FLAG_NT)
 
 #define SETFLAGBIT(TYPE,TEST) if (TEST) reg_flags|=FLAG_ ## TYPE; else reg_flags&=~FLAG_ ## TYPE
diff -Nur dosbox-0.74/include/render.h dosbox-0.74.patch/include/render.h
--- dosbox-0.74/include/render.h	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/include/render.h	2016-12-11 18:35:15.498284007 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
diff -Nur dosbox-0.74/include/serialport.h dosbox-0.74.patch/include/serialport.h
--- dosbox-0.74/include/serialport.h	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/include/serialport.h	2016-12-11 18:35:15.498284007 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: serialport.h,v 1.18 2009-09-25 23:40:48 h-a-l-9000 Exp $ */
 
 #ifndef DOSBOX_SERIALPORT_H
 #define DOSBOX_SERIALPORT_H
diff -Nur dosbox-0.74/include/setup.h dosbox-0.74.patch/include/setup.h
--- dosbox-0.74/include/setup.h	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/include/setup.h	2016-12-11 18:35:15.498284007 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: setup.h,v 1.41 2009-05-27 09:15:41 qbix79 Exp $ */
 
 #ifndef DOSBOX_SETUP_H
 #define DOSBOX_SETUP_H
@@ -42,6 +41,11 @@
 #include <string>
 #endif
 
+#ifndef CH_CSTDIO
+#define CH_CSTDIO
+#include <cstdio>
+#endif
+
 
 class Hex {
 private:
@@ -99,18 +103,18 @@
 	operator int () const throw(WrongType);
 	operator double () const throw(WrongType);
 	operator char const* () const throw(WrongType);
-	void SetValue(std::string const& in,Etype _type = V_CURRENT) throw(WrongType);
+	bool SetValue(std::string const& in,Etype _type = V_CURRENT) throw(WrongType);
 	std::string ToString() const;
 
 private:
 	void destroy() throw();
 	Value& copy(Value const& in) throw(WrongType);
 	void plaincopy(Value const& in) throw();
-	void set_hex(std::string const& in);
-	void set_int(std::string const&in);
-	void set_bool(std::string const& in);
+	bool set_hex(std::string const& in);
+	bool set_int(std::string const&in);
+	bool set_bool(std::string const& in);
 	void set_string(std::string const& in);
-	void set_double(std::string const& in);
+	bool set_double(std::string const& in);
 };
 
 class Property {
@@ -122,7 +126,7 @@
 	void Set_values(const char * const * in);
 	void Set_help(std::string const& str);
 	char const* Get_help();
-	virtual	void SetValue(std::string const& str)=0;
+	virtual	bool SetValue(std::string const& str)=0;
 	Value const& GetValue() const { return value;}
 	Value const& Get_Default_Value() const { return default_value; }
 	//CheckValue returns true  if value is in suggested_values;
@@ -130,10 +134,12 @@
 	//specific features.
 	virtual bool CheckValue(Value const& in, bool warn);
 	//Set interval value to in or default if in is invalid. force always sets the value.
-	void SetVal(Value const& in, bool forced,bool warn=true) {if(forced || CheckValue(in,warn)) value = in; else value = default_value;}
+	bool SetVal(Value const& in, bool forced,bool warn=true) {
+		if(forced || CheckValue(in,warn)) {value = in; return true;} else { value = default_value; return false;}}
 	virtual ~Property(){ } 
 	virtual const std::vector<Value>& GetValues() const;
 	Value::Etype Get_type(){return default_value.type;}
+	Changeable::Value getChange() {return change;}
 
 protected:
 	Value value;
@@ -156,8 +162,10 @@
 		min = _min;
 		max = _max;
 	}
+	int getMin() { return min;}
+	int getMax() { return max;}
 	void SetMinMax(Value const& min,Value const& max) {this->min = min; this->max=max;}
-	void SetValue(std::string const& in);
+	bool SetValue(std::string const& in);
 	~Prop_int(){ }
 	virtual bool CheckValue(Value const& in, bool warn);
 private:
@@ -170,7 +178,7 @@
 		:Property(_propname,when){
 		default_value = value = _value;
 	}
-	void SetValue(std::string const& input);
+	bool SetValue(std::string const& input);
 	~Prop_double(){ }
 };
 
@@ -180,7 +188,7 @@
 		:Property(_propname,when) { 
 		default_value = value = _value;
 	}
-	void SetValue(std::string const& in);
+	bool SetValue(std::string const& in);
 	~Prop_bool(){ }
 };
 
@@ -190,7 +198,7 @@
 		:Property(_propname,when) { 
 		default_value = value = _value;
 	}
-	void SetValue(std::string const& in);
+	bool SetValue(std::string const& in);
 	virtual bool CheckValue(Value const& in, bool warn);
 	~Prop_string(){ }
 };
@@ -202,7 +210,7 @@
 		default_value = value = _value;
 		realpath = _value;
 	}
-	void SetValue(std::string const& in);
+	bool SetValue(std::string const& in);
 	~Prop_path(){ }
 };
 
@@ -212,7 +220,7 @@
 		:Property(_propname,when) { 
 		default_value = value = _value;
 	}
-	void SetValue(std::string const& in);
+	bool SetValue(std::string const& in);
 	~Prop_hex(){ }
 };
 
@@ -243,7 +251,7 @@
 	const char* GetName() const {return sectionname.c_str();}
 
 	virtual std::string GetPropValue(std::string const& _property) const =0;
-	virtual void HandleInputline(std::string const& _line)=0;
+	virtual bool HandleInputline(std::string const& _line)=0;
 	virtual void PrintData(FILE* outfile) const =0;
 	virtual ~Section() { /*Children must call executedestroy ! */}
 };
@@ -276,7 +284,7 @@
 	Prop_path* Get_path(std::string const& _propname) const;
 	Prop_multival* Get_multival(std::string const& _propname) const;
 	Prop_multival_remain* Get_multivalremain(std::string const& _propname) const;
-	void HandleInputline(std::string const& gegevens);
+	bool HandleInputline(std::string const& gegevens);
 	void PrintData(FILE* outfile) const;
 	virtual std::string GetPropValue(std::string const& _property) const;
 	//ExecuteDestroy should be here else the destroy functions use destroyed properties
@@ -294,7 +302,7 @@
 	}
 	Section_prop *GetSection() { return section; }
 	const Section_prop *GetSection() const { return section; }
-	virtual void SetValue(std::string const& input);
+	virtual bool SetValue(std::string const& input);
 	virtual const std::vector<Value>& GetValues() const;
 	~Prop_multival() { delete section; }
 }; //value bevat totale string. setvalue zet elk van de sub properties en checked die.
@@ -303,7 +311,7 @@
 public:
 	Prop_multival_remain(std::string const& _propname, Changeable::Value when,std::string const& sep):Prop_multival(_propname,when,sep){ }
 
-	virtual void SetValue(std::string const& input);
+	virtual bool SetValue(std::string const& input);
 };
 
    
@@ -311,7 +319,7 @@
 public:
 	Section_line(std::string const& _sectionname):Section(_sectionname){}
 	~Section_line(){ExecuteDestroy(true);}
-	void HandleInputline(std::string const& gegevens);
+	bool HandleInputline(std::string const& gegevens);
 	void PrintData(FILE* outfile) const;
 	virtual std::string GetPropValue(std::string const& _property) const;
 	std::string data;
diff -Nur dosbox-0.74/include/shell.h dosbox-0.74.patch/include/shell.h
--- dosbox-0.74/include/shell.h	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/include/shell.h	2016-12-11 18:35:15.498284007 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: shell.h,v 1.28 2009-07-03 19:36:57 qbix79 Exp $ */
 
 #ifndef DOSBOX_SHELL_H
 #define DOSBOX_SHELL_H
@@ -88,6 +87,8 @@
 	void CMD_HELP(char * args);
 	void CMD_CLS(char * args);
 	void CMD_COPY(char * args);
+	void CMD_DATE(char * args);
+	void CMD_TIME(char * args);
 	void CMD_DIR(char * args);
 	void CMD_DELETE(char * args);
 	void CMD_ECHO(char * args);
diff -Nur dosbox-0.74/include/support.h dosbox-0.74.patch/include/support.h
--- dosbox-0.74/include/support.h	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/include/support.h	2016-12-11 18:35:15.498284007 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: support.h,v 1.18 2009-05-27 09:15:41 qbix79 Exp $ */
 
 #ifndef DOSBOX_SUPPORT_H
 #define DOSBOX_SUPPORT_H
diff -Nur dosbox-0.74/include/timer.h dosbox-0.74.patch/include/timer.h
--- dosbox-0.74/include/timer.h	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/include/timer.h	2016-12-11 18:35:15.498284007 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
diff -Nur dosbox-0.74/include/vga.h dosbox-0.74.patch/include/vga.h
--- dosbox-0.74/include/vga.h	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/include/vga.h	2016-12-11 18:35:15.498284007 +0100
@@ -1,5 +1,5 @@
  /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: vga.h,v 1.48 2009-11-03 21:06:59 h-a-l-9000 Exp $ */
 
 #ifndef DOSBOX_VGA_H
 #define DOSBOX_VGA_H
@@ -114,7 +113,7 @@
 typedef enum {
 	PART,
 	LINE,
-	//EGALINE
+	EGALINE
 } Drawmode;
 
 typedef struct {
@@ -157,6 +156,8 @@
 	Bit8u font[64*1024];
 	Bit8u * font_tables[2];
 	Bitu blinking;
+	bool blink;
+	bool char9dot;
 	struct {
 		Bitu address;
 		Bit8u sline,eline;
@@ -165,14 +166,15 @@
 	} cursor;
 	Drawmode mode;
 	bool vret_triggered;
+	bool vga_override;
 } VGA_Draw;
 
 typedef struct {
 	Bit8u curmode;
 	Bit16u originx, originy;
 	Bit8u fstackpos, bstackpos;
-	Bit8u forestack[3];
-	Bit8u backstack[3];
+	Bit8u forestack[4];
+	Bit8u backstack[4];
 	Bit16u startaddr;
 	Bit8u posx, posy;
 	Bit8u mc[64][64];
@@ -425,6 +427,10 @@
 void VGA_DAC_SetEntry(Bitu entry,Bit8u red,Bit8u green,Bit8u blue);
 void VGA_ATTR_SetPalette(Bit8u index,Bit8u val);
 
+typedef enum {CGA, EGA, MONO} EGAMonitorMode;
+
+void VGA_ATTR_SetEGAMonitorPalette(EGAMonitorMode m);
+
 /* The VGA Subfunction startups */
 void VGA_SetupAttr(void);
 void VGA_SetupMemory(Section* sec);
@@ -447,6 +453,8 @@
 void VGA_ActivateHardwareCursor(void);
 void VGA_KillDrawing(void);
 
+void VGA_SetOverride(bool vga_override);
+
 extern VGA_Type vga;
 
 /* Support for modular SVGA implementation */
diff -Nur dosbox-0.74/include/video.h dosbox-0.74.patch/include/video.h
--- dosbox-0.74/include/video.h	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/include/video.h	2016-12-11 18:35:15.498284007 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: video.h,v 1.26 2009-05-27 09:15:41 qbix79 Exp $ */
 
 #ifndef DOSBOX_VIDEO_H
 #define DOSBOX_VIDEO_H
diff -Nur dosbox-0.74/INSTALL dosbox-0.74.patch/INSTALL
--- dosbox-0.74/INSTALL	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/INSTALL	2016-12-11 18:35:15.498284007 +0100
@@ -43,11 +43,11 @@
     for Alsa support under linux. Part of the linux kernel sources
     Licensed under LGPL
 
-If you want compile from the CVS under a unix system, you'll also need 
+If you want compile from developer sources (SVN) under a unix system, you'll also need 
 automake (>=1.6), autoconf(>=2.50). Should be available at http://www.gnu.org
 
 For building on unix systems.
-If you are building from the cvs run ./autogen.sh first before doing the following.
+If you are building from developer sources run ./autogen.sh first before doing the following.
 
 1. ./configure
 2. make
@@ -101,4 +101,4 @@
 
 Build instructions for VC++6 
 Don't use VC++ 6: it creates faulty code in core_normal.cpp
-Later Visual Studio versions work fine (vs2003/.net, vs2005, vs2008)
+Later Visual Studio versions work fine (vs2003/.net up to vs2010)
diff -Nur dosbox-0.74/install-sh dosbox-0.74.patch/install-sh
--- dosbox-0.74/install-sh	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/install-sh	1970-01-01 01:00:00.000000000 +0100
@@ -1,520 +0,0 @@
-#!/bin/sh
-# install - install a program, script, or datafile
-
-scriptversion=2009-04-28.21; # UTC
-
-# This originates from X11R5 (mit/util/scripts/install.sh), which was
-# later released in X11R6 (xc/config/util/install.sh) with the
-# following copyright and license.
-#
-# Copyright (C) 1994 X Consortium
-#
-# Permission is hereby granted, free of charge, to any person obtaining a copy
-# of this software and associated documentation files (the "Software"), to
-# deal in the Software without restriction, including without limitation the
-# rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
-# sell copies of the Software, and to permit persons to whom the Software is
-# furnished to do so, subject to the following conditions:
-#
-# The above copyright notice and this permission notice shall be included in
-# all copies or substantial portions of the Software.
-#
-# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
-# IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
-# FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL THE
-# X CONSORTIUM BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN
-# AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNEC-
-# TION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
-#
-# Except as contained in this notice, the name of the X Consortium shall not
-# be used in advertising or otherwise to promote the sale, use or other deal-
-# ings in this Software without prior written authorization from the X Consor-
-# tium.
-#
-#
-# FSF changes to this file are in the public domain.
-#
-# Calling this script install-sh is preferred over install.sh, to prevent
-# `make' implicit rules from creating a file called install from it
-# when there is no Makefile.
-#
-# This script is compatible with the BSD install script, but was written
-# from scratch.
-
-nl='
-'
-IFS=" ""	$nl"
-
-# set DOITPROG to echo to test this script
-
-# Don't use :- since 4.3BSD and earlier shells don't like it.
-doit=${DOITPROG-}
-if test -z "$doit"; then
-  doit_exec=exec
-else
-  doit_exec=$doit
-fi
-
-# Put in absolute file names if you don't have them in your path;
-# or use environment vars.
-
-chgrpprog=${CHGRPPROG-chgrp}
-chmodprog=${CHMODPROG-chmod}
-chownprog=${CHOWNPROG-chown}
-cmpprog=${CMPPROG-cmp}
-cpprog=${CPPROG-cp}
-mkdirprog=${MKDIRPROG-mkdir}
-mvprog=${MVPROG-mv}
-rmprog=${RMPROG-rm}
-stripprog=${STRIPPROG-strip}
-
-posix_glob='?'
-initialize_posix_glob='
-  test "$posix_glob" != "?" || {
-    if (set -f) 2>/dev/null; then
-      posix_glob=
-    else
-      posix_glob=:
-    fi
-  }
-'
-
-posix_mkdir=
-
-# Desired mode of installed file.
-mode=0755
-
-chgrpcmd=
-chmodcmd=$chmodprog
-chowncmd=
-mvcmd=$mvprog
-rmcmd="$rmprog -f"
-stripcmd=
-
-src=
-dst=
-dir_arg=
-dst_arg=
-
-copy_on_change=false
-no_target_directory=
-
-usage="\
-Usage: $0 [OPTION]... [-T] SRCFILE DSTFILE
-   or: $0 [OPTION]... SRCFILES... DIRECTORY
-   or: $0 [OPTION]... -t DIRECTORY SRCFILES...
-   or: $0 [OPTION]... -d DIRECTORIES...
-
-In the 1st form, copy SRCFILE to DSTFILE.
-In the 2nd and 3rd, copy all SRCFILES to DIRECTORY.
-In the 4th, create DIRECTORIES.
-
-Options:
-     --help     display this help and exit.
-     --version  display version info and exit.
-
-  -c            (ignored)
-  -C            install only if different (preserve the last data modification time)
-  -d            create directories instead of installing files.
-  -g GROUP      $chgrpprog installed files to GROUP.
-  -m MODE       $chmodprog installed files to MODE.
-  -o USER       $chownprog installed files to USER.
-  -s            $stripprog installed files.
-  -t DIRECTORY  install into DIRECTORY.
-  -T            report an error if DSTFILE is a directory.
-
-Environment variables override the default commands:
-  CHGRPPROG CHMODPROG CHOWNPROG CMPPROG CPPROG MKDIRPROG MVPROG
-  RMPROG STRIPPROG
-"
-
-while test $# -ne 0; do
-  case $1 in
-    -c) ;;
-
-    -C) copy_on_change=true;;
-
-    -d) dir_arg=true;;
-
-    -g) chgrpcmd="$chgrpprog $2"
-	shift;;
-
-    --help) echo "$usage"; exit $?;;
-
-    -m) mode=$2
-	case $mode in
-	  *' '* | *'	'* | *'
-'*	  | *'*'* | *'?'* | *'['*)
-	    echo "$0: invalid mode: $mode" >&2
-	    exit 1;;
-	esac
-	shift;;
-
-    -o) chowncmd="$chownprog $2"
-	shift;;
-
-    -s) stripcmd=$stripprog;;
-
-    -t) dst_arg=$2
-	shift;;
-
-    -T) no_target_directory=true;;
-
-    --version) echo "$0 $scriptversion"; exit $?;;
-
-    --)	shift
-	break;;
-
-    -*)	echo "$0: invalid option: $1" >&2
-	exit 1;;
-
-    *)  break;;
-  esac
-  shift
-done
-
-if test $# -ne 0 && test -z "$dir_arg$dst_arg"; then
-  # When -d is used, all remaining arguments are directories to create.
-  # When -t is used, the destination is already specified.
-  # Otherwise, the last argument is the destination.  Remove it from $@.
-  for arg
-  do
-    if test -n "$dst_arg"; then
-      # $@ is not empty: it contains at least $arg.
-      set fnord "$@" "$dst_arg"
-      shift # fnord
-    fi
-    shift # arg
-    dst_arg=$arg
-  done
-fi
-
-if test $# -eq 0; then
-  if test -z "$dir_arg"; then
-    echo "$0: no input file specified." >&2
-    exit 1
-  fi
-  # It's OK to call `install-sh -d' without argument.
-  # This can happen when creating conditional directories.
-  exit 0
-fi
-
-if test -z "$dir_arg"; then
-  trap '(exit $?); exit' 1 2 13 15
-
-  # Set umask so as not to create temps with too-generous modes.
-  # However, 'strip' requires both read and write access to temps.
-  case $mode in
-    # Optimize common cases.
-    *644) cp_umask=133;;
-    *755) cp_umask=22;;
-
-    *[0-7])
-      if test -z "$stripcmd"; then
-	u_plus_rw=
-      else
-	u_plus_rw='% 200'
-      fi
-      cp_umask=`expr '(' 777 - $mode % 1000 ')' $u_plus_rw`;;
-    *)
-      if test -z "$stripcmd"; then
-	u_plus_rw=
-      else
-	u_plus_rw=,u+rw
-      fi
-      cp_umask=$mode$u_plus_rw;;
-  esac
-fi
-
-for src
-do
-  # Protect names starting with `-'.
-  case $src in
-    -*) src=./$src;;
-  esac
-
-  if test -n "$dir_arg"; then
-    dst=$src
-    dstdir=$dst
-    test -d "$dstdir"
-    dstdir_status=$?
-  else
-
-    # Waiting for this to be detected by the "$cpprog $src $dsttmp" command
-    # might cause directories to be created, which would be especially bad
-    # if $src (and thus $dsttmp) contains '*'.
-    if test ! -f "$src" && test ! -d "$src"; then
-      echo "$0: $src does not exist." >&2
-      exit 1
-    fi
-
-    if test -z "$dst_arg"; then
-      echo "$0: no destination specified." >&2
-      exit 1
-    fi
-
-    dst=$dst_arg
-    # Protect names starting with `-'.
-    case $dst in
-      -*) dst=./$dst;;
-    esac
-
-    # If destination is a directory, append the input filename; won't work
-    # if double slashes aren't ignored.
-    if test -d "$dst"; then
-      if test -n "$no_target_directory"; then
-	echo "$0: $dst_arg: Is a directory" >&2
-	exit 1
-      fi
-      dstdir=$dst
-      dst=$dstdir/`basename "$src"`
-      dstdir_status=0
-    else
-      # Prefer dirname, but fall back on a substitute if dirname fails.
-      dstdir=`
-	(dirname "$dst") 2>/dev/null ||
-	expr X"$dst" : 'X\(.*[^/]\)//*[^/][^/]*/*$' \| \
-	     X"$dst" : 'X\(//\)[^/]' \| \
-	     X"$dst" : 'X\(//\)$' \| \
-	     X"$dst" : 'X\(/\)' \| . 2>/dev/null ||
-	echo X"$dst" |
-	    sed '/^X\(.*[^/]\)\/\/*[^/][^/]*\/*$/{
-		   s//\1/
-		   q
-		 }
-		 /^X\(\/\/\)[^/].*/{
-		   s//\1/
-		   q
-		 }
-		 /^X\(\/\/\)$/{
-		   s//\1/
-		   q
-		 }
-		 /^X\(\/\).*/{
-		   s//\1/
-		   q
-		 }
-		 s/.*/./; q'
-      `
-
-      test -d "$dstdir"
-      dstdir_status=$?
-    fi
-  fi
-
-  obsolete_mkdir_used=false
-
-  if test $dstdir_status != 0; then
-    case $posix_mkdir in
-      '')
-	# Create intermediate dirs using mode 755 as modified by the umask.
-	# This is like FreeBSD 'install' as of 1997-10-28.
-	umask=`umask`
-	case $stripcmd.$umask in
-	  # Optimize common cases.
-	  *[2367][2367]) mkdir_umask=$umask;;
-	  .*0[02][02] | .[02][02] | .[02]) mkdir_umask=22;;
-
-	  *[0-7])
-	    mkdir_umask=`expr $umask + 22 \
-	      - $umask % 100 % 40 + $umask % 20 \
-	      - $umask % 10 % 4 + $umask % 2
-	    `;;
-	  *) mkdir_umask=$umask,go-w;;
-	esac
-
-	# With -d, create the new directory with the user-specified mode.
-	# Otherwise, rely on $mkdir_umask.
-	if test -n "$dir_arg"; then
-	  mkdir_mode=-m$mode
-	else
-	  mkdir_mode=
-	fi
-
-	posix_mkdir=false
-	case $umask in
-	  *[123567][0-7][0-7])
-	    # POSIX mkdir -p sets u+wx bits regardless of umask, which
-	    # is incompatible with FreeBSD 'install' when (umask & 300) != 0.
-	    ;;
-	  *)
-	    tmpdir=${TMPDIR-/tmp}/ins$RANDOM-$$
-	    trap 'ret=$?; rmdir "$tmpdir/d" "$tmpdir" 2>/dev/null; exit $ret' 0
-
-	    if (umask $mkdir_umask &&
-		exec $mkdirprog $mkdir_mode -p -- "$tmpdir/d") >/dev/null 2>&1
-	    then
-	      if test -z "$dir_arg" || {
-		   # Check for POSIX incompatibilities with -m.
-		   # HP-UX 11.23 and IRIX 6.5 mkdir -m -p sets group- or
-		   # other-writeable bit of parent directory when it shouldn't.
-		   # FreeBSD 6.1 mkdir -m -p sets mode of existing directory.
-		   ls_ld_tmpdir=`ls -ld "$tmpdir"`
-		   case $ls_ld_tmpdir in
-		     d????-?r-*) different_mode=700;;
-		     d????-?--*) different_mode=755;;
-		     *) false;;
-		   esac &&
-		   $mkdirprog -m$different_mode -p -- "$tmpdir" && {
-		     ls_ld_tmpdir_1=`ls -ld "$tmpdir"`
-		     test "$ls_ld_tmpdir" = "$ls_ld_tmpdir_1"
-		   }
-		 }
-	      then posix_mkdir=:
-	      fi
-	      rmdir "$tmpdir/d" "$tmpdir"
-	    else
-	      # Remove any dirs left behind by ancient mkdir implementations.
-	      rmdir ./$mkdir_mode ./-p ./-- 2>/dev/null
-	    fi
-	    trap '' 0;;
-	esac;;
-    esac
-
-    if
-      $posix_mkdir && (
-	umask $mkdir_umask &&
-	$doit_exec $mkdirprog $mkdir_mode -p -- "$dstdir"
-      )
-    then :
-    else
-
-      # The umask is ridiculous, or mkdir does not conform to POSIX,
-      # or it failed possibly due to a race condition.  Create the
-      # directory the slow way, step by step, checking for races as we go.
-
-      case $dstdir in
-	/*) prefix='/';;
-	-*) prefix='./';;
-	*)  prefix='';;
-      esac
-
-      eval "$initialize_posix_glob"
-
-      oIFS=$IFS
-      IFS=/
-      $posix_glob set -f
-      set fnord $dstdir
-      shift
-      $posix_glob set +f
-      IFS=$oIFS
-
-      prefixes=
-
-      for d
-      do
-	test -z "$d" && continue
-
-	prefix=$prefix$d
-	if test -d "$prefix"; then
-	  prefixes=
-	else
-	  if $posix_mkdir; then
-	    (umask=$mkdir_umask &&
-	     $doit_exec $mkdirprog $mkdir_mode -p -- "$dstdir") && break
-	    # Don't fail if two instances are running concurrently.
-	    test -d "$prefix" || exit 1
-	  else
-	    case $prefix in
-	      *\'*) qprefix=`echo "$prefix" | sed "s/'/'\\\\\\\\''/g"`;;
-	      *) qprefix=$prefix;;
-	    esac
-	    prefixes="$prefixes '$qprefix'"
-	  fi
-	fi
-	prefix=$prefix/
-      done
-
-      if test -n "$prefixes"; then
-	# Don't fail if two instances are running concurrently.
-	(umask $mkdir_umask &&
-	 eval "\$doit_exec \$mkdirprog $prefixes") ||
-	  test -d "$dstdir" || exit 1
-	obsolete_mkdir_used=true
-      fi
-    fi
-  fi
-
-  if test -n "$dir_arg"; then
-    { test -z "$chowncmd" || $doit $chowncmd "$dst"; } &&
-    { test -z "$chgrpcmd" || $doit $chgrpcmd "$dst"; } &&
-    { test "$obsolete_mkdir_used$chowncmd$chgrpcmd" = false ||
-      test -z "$chmodcmd" || $doit $chmodcmd $mode "$dst"; } || exit 1
-  else
-
-    # Make a couple of temp file names in the proper directory.
-    dsttmp=$dstdir/_inst.$$_
-    rmtmp=$dstdir/_rm.$$_
-
-    # Trap to clean up those temp files at exit.
-    trap 'ret=$?; rm -f "$dsttmp" "$rmtmp" && exit $ret' 0
-
-    # Copy the file name to the temp name.
-    (umask $cp_umask && $doit_exec $cpprog "$src" "$dsttmp") &&
-
-    # and set any options; do chmod last to preserve setuid bits.
-    #
-    # If any of these fail, we abort the whole thing.  If we want to
-    # ignore errors from any of these, just make sure not to ignore
-    # errors from the above "$doit $cpprog $src $dsttmp" command.
-    #
-    { test -z "$chowncmd" || $doit $chowncmd "$dsttmp"; } &&
-    { test -z "$chgrpcmd" || $doit $chgrpcmd "$dsttmp"; } &&
-    { test -z "$stripcmd" || $doit $stripcmd "$dsttmp"; } &&
-    { test -z "$chmodcmd" || $doit $chmodcmd $mode "$dsttmp"; } &&
-
-    # If -C, don't bother to copy if it wouldn't change the file.
-    if $copy_on_change &&
-       old=`LC_ALL=C ls -dlL "$dst"	2>/dev/null` &&
-       new=`LC_ALL=C ls -dlL "$dsttmp"	2>/dev/null` &&
-
-       eval "$initialize_posix_glob" &&
-       $posix_glob set -f &&
-       set X $old && old=:$2:$4:$5:$6 &&
-       set X $new && new=:$2:$4:$5:$6 &&
-       $posix_glob set +f &&
-
-       test "$old" = "$new" &&
-       $cmpprog "$dst" "$dsttmp" >/dev/null 2>&1
-    then
-      rm -f "$dsttmp"
-    else
-      # Rename the file to the real destination.
-      $doit $mvcmd -f "$dsttmp" "$dst" 2>/dev/null ||
-
-      # The rename failed, perhaps because mv can't rename something else
-      # to itself, or perhaps because mv is so ancient that it does not
-      # support -f.
-      {
-	# Now remove or move aside any old file at destination location.
-	# We try this two ways since rm can't unlink itself on some
-	# systems and the destination file might be busy for other
-	# reasons.  In this case, the final cleanup might fail but the new
-	# file should still install successfully.
-	{
-	  test ! -f "$dst" ||
-	  $doit $rmcmd -f "$dst" 2>/dev/null ||
-	  { $doit $mvcmd -f "$dst" "$rmtmp" 2>/dev/null &&
-	    { $doit $rmcmd -f "$rmtmp" 2>/dev/null; :; }
-	  } ||
-	  { echo "$0: cannot unlink or rename $dst" >&2
-	    (exit 1); exit 1
-	  }
-	} &&
-
-	# Now rename the file to the real destination.
-	$doit $mvcmd "$dsttmp" "$dst"
-      }
-    fi || exit 1
-
-    trap '' 0
-  fi
-done
-
-# Local variables:
-# eval: (add-hook 'write-file-hooks 'time-stamp)
-# time-stamp-start: "scriptversion="
-# time-stamp-format: "%:y-%02m-%02d.%02H"
-# time-stamp-time-zone: "UTC"
-# time-stamp-end: "; # UTC"
-# End:
diff -Nur dosbox-0.74/Makefile.in dosbox-0.74.patch/Makefile.in
--- dosbox-0.74/Makefile.in	2010-05-12 11:57:44.000000000 +0200
+++ dosbox-0.74.patch/Makefile.in	1970-01-01 01:00:00.000000000 +0100
@@ -1,700 +0,0 @@
-# Makefile.in generated by automake 1.11.1 from Makefile.am.
-# @configure_input@
-
-# Copyright (C) 1994, 1995, 1996, 1997, 1998, 1999, 2000, 2001, 2002,
-# 2003, 2004, 2005, 2006, 2007, 2008, 2009  Free Software Foundation,
-# Inc.
-# This Makefile.in is free software; the Free Software Foundation
-# gives unlimited permission to copy and/or distribute it,
-# with or without modifications, as long as this notice is preserved.
-
-# This program is distributed in the hope that it will be useful,
-# but WITHOUT ANY WARRANTY, to the extent permitted by law; without
-# even the implied warranty of MERCHANTABILITY or FITNESS FOR A
-# PARTICULAR PURPOSE.
-
-@SET_MAKE@
-
-# Main Makefile for DOSBox
-VPATH = @srcdir@
-pkgdatadir = $(datadir)/@PACKAGE@
-pkgincludedir = $(includedir)/@PACKAGE@
-pkglibdir = $(libdir)/@PACKAGE@
-pkglibexecdir = $(libexecdir)/@PACKAGE@
-am__cd = CDPATH="$${ZSH_VERSION+.}$(PATH_SEPARATOR)" && cd
-install_sh_DATA = $(install_sh) -c -m 644
-install_sh_PROGRAM = $(install_sh) -c
-install_sh_SCRIPT = $(install_sh) -c
-INSTALL_HEADER = $(INSTALL_DATA)
-transform = $(program_transform_name)
-NORMAL_INSTALL = :
-PRE_INSTALL = :
-POST_INSTALL = :
-NORMAL_UNINSTALL = :
-PRE_UNINSTALL = :
-POST_UNINSTALL = :
-build_triplet = @build@
-host_triplet = @host@
-subdir = .
-DIST_COMMON = README $(am__configure_deps) $(srcdir)/Makefile.am \
-	$(srcdir)/Makefile.in $(srcdir)/config.h.in \
-	$(top_srcdir)/configure AUTHORS COPYING ChangeLog INSTALL NEWS \
-	THANKS config.guess config.sub depcomp install-sh missing
-ACLOCAL_M4 = $(top_srcdir)/aclocal.m4
-am__aclocal_m4_deps = $(top_srcdir)/acinclude.m4 \
-	$(top_srcdir)/configure.in
-am__configure_deps = $(am__aclocal_m4_deps) $(CONFIGURE_DEPENDENCIES) \
-	$(ACLOCAL_M4)
-am__CONFIG_DISTCLEAN_FILES = config.status config.cache config.log \
- configure.lineno config.status.lineno
-mkinstalldirs = $(install_sh) -d
-CONFIG_HEADER = config.h
-CONFIG_CLEAN_FILES =
-CONFIG_CLEAN_VPATH_FILES =
-SOURCES =
-DIST_SOURCES =
-RECURSIVE_TARGETS = all-recursive check-recursive dvi-recursive \
-	html-recursive info-recursive install-data-recursive \
-	install-dvi-recursive install-exec-recursive \
-	install-html-recursive install-info-recursive \
-	install-pdf-recursive install-ps-recursive install-recursive \
-	installcheck-recursive installdirs-recursive pdf-recursive \
-	ps-recursive uninstall-recursive
-RECURSIVE_CLEAN_TARGETS = mostlyclean-recursive clean-recursive	\
-  distclean-recursive maintainer-clean-recursive
-AM_RECURSIVE_TARGETS = $(RECURSIVE_TARGETS:-recursive=) \
-	$(RECURSIVE_CLEAN_TARGETS:-recursive=) tags TAGS ctags CTAGS \
-	distdir dist dist-all distcheck
-ETAGS = etags
-CTAGS = ctags
-DIST_SUBDIRS = $(SUBDIRS)
-DISTFILES = $(DIST_COMMON) $(DIST_SOURCES) $(TEXINFOS) $(EXTRA_DIST)
-distdir = $(PACKAGE)-$(VERSION)
-top_distdir = $(distdir)
-am__remove_distdir = \
-  { test ! -d "$(distdir)" \
-    || { find "$(distdir)" -type d ! -perm -200 -exec chmod u+w {} ';' \
-         && rm -fr "$(distdir)"; }; }
-am__relativize = \
-  dir0=`pwd`; \
-  sed_first='s,^\([^/]*\)/.*$$,\1,'; \
-  sed_rest='s,^[^/]*/*,,'; \
-  sed_last='s,^.*/\([^/]*\)$$,\1,'; \
-  sed_butlast='s,/*[^/]*$$,,'; \
-  while test -n "$$dir1"; do \
-    first=`echo "$$dir1" | sed -e "$$sed_first"`; \
-    if test "$$first" != "."; then \
-      if test "$$first" = ".."; then \
-        dir2=`echo "$$dir0" | sed -e "$$sed_last"`/"$$dir2"; \
-        dir0=`echo "$$dir0" | sed -e "$$sed_butlast"`; \
-      else \
-        first2=`echo "$$dir2" | sed -e "$$sed_first"`; \
-        if test "$$first2" = "$$first"; then \
-          dir2=`echo "$$dir2" | sed -e "$$sed_rest"`; \
-        else \
-          dir2="../$$dir2"; \
-        fi; \
-        dir0="$$dir0"/"$$first"; \
-      fi; \
-    fi; \
-    dir1=`echo "$$dir1" | sed -e "$$sed_rest"`; \
-  done; \
-  reldir="$$dir2"
-DIST_ARCHIVES = $(distdir).tar.gz
-GZIP_ENV = --best
-distuninstallcheck_listfiles = find . -type f -print
-distcleancheck_listfiles = find . -type f -print
-ACLOCAL = @ACLOCAL@
-ALSA_CFLAGS = @ALSA_CFLAGS@
-ALSA_LIBS = @ALSA_LIBS@
-AMTAR = @AMTAR@
-AUTOCONF = @AUTOCONF@
-AUTOHEADER = @AUTOHEADER@
-AUTOMAKE = @AUTOMAKE@
-AWK = @AWK@
-CC = @CC@
-CCDEPMODE = @CCDEPMODE@
-CFLAGS = @CFLAGS@
-CPP = @CPP@
-CPPFLAGS = @CPPFLAGS@
-CXX = @CXX@
-CXXDEPMODE = @CXXDEPMODE@
-CXXFLAGS = @CXXFLAGS@
-CYGPATH_W = @CYGPATH_W@
-DEFS = @DEFS@
-DEPDIR = @DEPDIR@
-ECHO_C = @ECHO_C@
-ECHO_N = @ECHO_N@
-ECHO_T = @ECHO_T@
-EGREP = @EGREP@
-EXEEXT = @EXEEXT@
-GREP = @GREP@
-INSTALL = @INSTALL@
-INSTALL_DATA = @INSTALL_DATA@
-INSTALL_PROGRAM = @INSTALL_PROGRAM@
-INSTALL_SCRIPT = @INSTALL_SCRIPT@
-INSTALL_STRIP_PROGRAM = @INSTALL_STRIP_PROGRAM@
-LDFLAGS = @LDFLAGS@
-LIBOBJS = @LIBOBJS@
-LIBS = @LIBS@
-LTLIBOBJS = @LTLIBOBJS@
-MAKEINFO = @MAKEINFO@
-MKDIR_P = @MKDIR_P@
-OBJEXT = @OBJEXT@
-PACKAGE = @PACKAGE@
-PACKAGE_BUGREPORT = @PACKAGE_BUGREPORT@
-PACKAGE_NAME = @PACKAGE_NAME@
-PACKAGE_STRING = @PACKAGE_STRING@
-PACKAGE_TARNAME = @PACKAGE_TARNAME@
-PACKAGE_URL = @PACKAGE_URL@
-PACKAGE_VERSION = @PACKAGE_VERSION@
-PATH_SEPARATOR = @PATH_SEPARATOR@
-RANLIB = @RANLIB@
-SDL_CFLAGS = @SDL_CFLAGS@
-SDL_CONFIG = @SDL_CONFIG@
-SDL_LIBS = @SDL_LIBS@
-SET_MAKE = @SET_MAKE@
-SHELL = @SHELL@
-STRIP = @STRIP@
-VERSION = @VERSION@
-WINDRES = @WINDRES@
-abs_builddir = @abs_builddir@
-abs_srcdir = @abs_srcdir@
-abs_top_builddir = @abs_top_builddir@
-abs_top_srcdir = @abs_top_srcdir@
-ac_ct_CC = @ac_ct_CC@
-ac_ct_CXX = @ac_ct_CXX@
-am__include = @am__include@
-am__leading_dot = @am__leading_dot@
-am__quote = @am__quote@
-am__tar = @am__tar@
-am__untar = @am__untar@
-bindir = @bindir@
-build = @build@
-build_alias = @build_alias@
-build_cpu = @build_cpu@
-build_os = @build_os@
-build_vendor = @build_vendor@
-builddir = @builddir@
-datadir = @datadir@
-datarootdir = @datarootdir@
-docdir = @docdir@
-dvidir = @dvidir@
-exec_prefix = @exec_prefix@
-host = @host@
-host_alias = @host_alias@
-host_cpu = @host_cpu@
-host_os = @host_os@
-host_vendor = @host_vendor@
-htmldir = @htmldir@
-includedir = @includedir@
-infodir = @infodir@
-install_sh = @install_sh@
-libdir = @libdir@
-libexecdir = @libexecdir@
-localedir = @localedir@
-localstatedir = @localstatedir@
-mandir = @mandir@
-mkdir_p = @mkdir_p@
-oldincludedir = @oldincludedir@
-pdfdir = @pdfdir@
-prefix = @prefix@
-program_transform_name = @program_transform_name@
-psdir = @psdir@
-sbindir = @sbindir@
-sharedstatedir = @sharedstatedir@
-srcdir = @srcdir@
-sysconfdir = @sysconfdir@
-target_alias = @target_alias@
-top_build_prefix = @top_build_prefix@
-top_builddir = @top_builddir@
-top_srcdir = @top_srcdir@
-EXTRA_DIST = autogen.sh
-SUBDIRS = src include docs visualc_net
-all: config.h
-	$(MAKE) $(AM_MAKEFLAGS) all-recursive
-
-.SUFFIXES:
-am--refresh:
-	@:
-$(srcdir)/Makefile.in:  $(srcdir)/Makefile.am  $(am__configure_deps)
-	@for dep in $?; do \
-	  case '$(am__configure_deps)' in \
-	    *$$dep*) \
-	      echo ' cd $(srcdir) && $(AUTOMAKE) --gnu'; \
-	      $(am__cd) $(srcdir) && $(AUTOMAKE) --gnu \
-		&& exit 0; \
-	      exit 1;; \
-	  esac; \
-	done; \
-	echo ' cd $(top_srcdir) && $(AUTOMAKE) --gnu Makefile'; \
-	$(am__cd) $(top_srcdir) && \
-	  $(AUTOMAKE) --gnu Makefile
-.PRECIOUS: Makefile
-Makefile: $(srcdir)/Makefile.in $(top_builddir)/config.status
-	@case '$?' in \
-	  *config.status*) \
-	    echo ' $(SHELL) ./config.status'; \
-	    $(SHELL) ./config.status;; \
-	  *) \
-	    echo ' cd $(top_builddir) && $(SHELL) ./config.status $@ $(am__depfiles_maybe)'; \
-	    cd $(top_builddir) && $(SHELL) ./config.status $@ $(am__depfiles_maybe);; \
-	esac;
-
-$(top_builddir)/config.status: $(top_srcdir)/configure $(CONFIG_STATUS_DEPENDENCIES)
-	$(SHELL) ./config.status --recheck
-
-$(top_srcdir)/configure:  $(am__configure_deps)
-	$(am__cd) $(srcdir) && $(AUTOCONF)
-$(ACLOCAL_M4):  $(am__aclocal_m4_deps)
-	$(am__cd) $(srcdir) && $(ACLOCAL) $(ACLOCAL_AMFLAGS)
-$(am__aclocal_m4_deps):
-
-config.h: stamp-h1
-	@if test ! -f $@; then \
-	  rm -f stamp-h1; \
-	  $(MAKE) $(AM_MAKEFLAGS) stamp-h1; \
-	else :; fi
-
-stamp-h1: $(srcdir)/config.h.in $(top_builddir)/config.status
-	@rm -f stamp-h1
-	cd $(top_builddir) && $(SHELL) ./config.status config.h
-$(srcdir)/config.h.in:  $(am__configure_deps) 
-	($(am__cd) $(top_srcdir) && $(AUTOHEADER))
-	rm -f stamp-h1
-	touch $@
-
-distclean-hdr:
-	-rm -f config.h stamp-h1
-
-# This directory's subdirectories are mostly independent; you can cd
-# into them and run `make' without going through this Makefile.
-# To change the values of `make' variables: instead of editing Makefiles,
-# (1) if the variable is set in `config.status', edit `config.status'
-#     (which will cause the Makefiles to be regenerated when you run `make');
-# (2) otherwise, pass the desired values on the `make' command line.
-$(RECURSIVE_TARGETS):
-	@fail= failcom='exit 1'; \
-	for f in x $$MAKEFLAGS; do \
-	  case $$f in \
-	    *=* | --[!k]*);; \
-	    *k*) failcom='fail=yes';; \
-	  esac; \
-	done; \
-	dot_seen=no; \
-	target=`echo $@ | sed s/-recursive//`; \
-	list='$(SUBDIRS)'; for subdir in $$list; do \
-	  echo "Making $$target in $$subdir"; \
-	  if test "$$subdir" = "."; then \
-	    dot_seen=yes; \
-	    local_target="$$target-am"; \
-	  else \
-	    local_target="$$target"; \
-	  fi; \
-	  ($(am__cd) $$subdir && $(MAKE) $(AM_MAKEFLAGS) $$local_target) \
-	  || eval $$failcom; \
-	done; \
-	if test "$$dot_seen" = "no"; then \
-	  $(MAKE) $(AM_MAKEFLAGS) "$$target-am" || exit 1; \
-	fi; test -z "$$fail"
-
-$(RECURSIVE_CLEAN_TARGETS):
-	@fail= failcom='exit 1'; \
-	for f in x $$MAKEFLAGS; do \
-	  case $$f in \
-	    *=* | --[!k]*);; \
-	    *k*) failcom='fail=yes';; \
-	  esac; \
-	done; \
-	dot_seen=no; \
-	case "$@" in \
-	  distclean-* | maintainer-clean-*) list='$(DIST_SUBDIRS)' ;; \
-	  *) list='$(SUBDIRS)' ;; \
-	esac; \
-	rev=''; for subdir in $$list; do \
-	  if test "$$subdir" = "."; then :; else \
-	    rev="$$subdir $$rev"; \
-	  fi; \
-	done; \
-	rev="$$rev ."; \
-	target=`echo $@ | sed s/-recursive//`; \
-	for subdir in $$rev; do \
-	  echo "Making $$target in $$subdir"; \
-	  if test "$$subdir" = "."; then \
-	    local_target="$$target-am"; \
-	  else \
-	    local_target="$$target"; \
-	  fi; \
-	  ($(am__cd) $$subdir && $(MAKE) $(AM_MAKEFLAGS) $$local_target) \
-	  || eval $$failcom; \
-	done && test -z "$$fail"
-tags-recursive:
-	list='$(SUBDIRS)'; for subdir in $$list; do \
-	  test "$$subdir" = . || ($(am__cd) $$subdir && $(MAKE) $(AM_MAKEFLAGS) tags); \
-	done
-ctags-recursive:
-	list='$(SUBDIRS)'; for subdir in $$list; do \
-	  test "$$subdir" = . || ($(am__cd) $$subdir && $(MAKE) $(AM_MAKEFLAGS) ctags); \
-	done
-
-ID: $(HEADERS) $(SOURCES) $(LISP) $(TAGS_FILES)
-	list='$(SOURCES) $(HEADERS) $(LISP) $(TAGS_FILES)'; \
-	unique=`for i in $$list; do \
-	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
-	  done | \
-	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
-	      END { if (nonempty) { for (i in files) print i; }; }'`; \
-	mkid -fID $$unique
-tags: TAGS
-
-TAGS: tags-recursive $(HEADERS) $(SOURCES) config.h.in $(TAGS_DEPENDENCIES) \
-		$(TAGS_FILES) $(LISP)
-	set x; \
-	here=`pwd`; \
-	if ($(ETAGS) --etags-include --version) >/dev/null 2>&1; then \
-	  include_option=--etags-include; \
-	  empty_fix=.; \
-	else \
-	  include_option=--include; \
-	  empty_fix=; \
-	fi; \
-	list='$(SUBDIRS)'; for subdir in $$list; do \
-	  if test "$$subdir" = .; then :; else \
-	    test ! -f $$subdir/TAGS || \
-	      set "$$@" "$$include_option=$$here/$$subdir/TAGS"; \
-	  fi; \
-	done; \
-	list='$(SOURCES) $(HEADERS) config.h.in $(LISP) $(TAGS_FILES)'; \
-	unique=`for i in $$list; do \
-	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
-	  done | \
-	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
-	      END { if (nonempty) { for (i in files) print i; }; }'`; \
-	shift; \
-	if test -z "$(ETAGS_ARGS)$$*$$unique"; then :; else \
-	  test -n "$$unique" || unique=$$empty_fix; \
-	  if test $$# -gt 0; then \
-	    $(ETAGS) $(ETAGSFLAGS) $(AM_ETAGSFLAGS) $(ETAGS_ARGS) \
-	      "$$@" $$unique; \
-	  else \
-	    $(ETAGS) $(ETAGSFLAGS) $(AM_ETAGSFLAGS) $(ETAGS_ARGS) \
-	      $$unique; \
-	  fi; \
-	fi
-ctags: CTAGS
-CTAGS: ctags-recursive $(HEADERS) $(SOURCES) config.h.in $(TAGS_DEPENDENCIES) \
-		$(TAGS_FILES) $(LISP)
-	list='$(SOURCES) $(HEADERS) config.h.in $(LISP) $(TAGS_FILES)'; \
-	unique=`for i in $$list; do \
-	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
-	  done | \
-	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
-	      END { if (nonempty) { for (i in files) print i; }; }'`; \
-	test -z "$(CTAGS_ARGS)$$unique" \
-	  || $(CTAGS) $(CTAGSFLAGS) $(AM_CTAGSFLAGS) $(CTAGS_ARGS) \
-	     $$unique
-
-GTAGS:
-	here=`$(am__cd) $(top_builddir) && pwd` \
-	  && $(am__cd) $(top_srcdir) \
-	  && gtags -i $(GTAGS_ARGS) "$$here"
-
-distclean-tags:
-	-rm -f TAGS ID GTAGS GRTAGS GSYMS GPATH tags
-
-distdir: $(DISTFILES)
-	$(am__remove_distdir)
-	test -d "$(distdir)" || mkdir "$(distdir)"
-	@srcdirstrip=`echo "$(srcdir)" | sed 's/[].[^$$\\*]/\\\\&/g'`; \
-	topsrcdirstrip=`echo "$(top_srcdir)" | sed 's/[].[^$$\\*]/\\\\&/g'`; \
-	list='$(DISTFILES)'; \
-	  dist_files=`for file in $$list; do echo $$file; done | \
-	  sed -e "s|^$$srcdirstrip/||;t" \
-	      -e "s|^$$topsrcdirstrip/|$(top_builddir)/|;t"`; \
-	case $$dist_files in \
-	  */*) $(MKDIR_P) `echo "$$dist_files" | \
-			   sed '/\//!d;s|^|$(distdir)/|;s,/[^/]*$$,,' | \
-			   sort -u` ;; \
-	esac; \
-	for file in $$dist_files; do \
-	  if test -f $$file || test -d $$file; then d=.; else d=$(srcdir); fi; \
-	  if test -d $$d/$$file; then \
-	    dir=`echo "/$$file" | sed -e 's,/[^/]*$$,,'`; \
-	    if test -d "$(distdir)/$$file"; then \
-	      find "$(distdir)/$$file" -type d ! -perm -700 -exec chmod u+rwx {} \;; \
-	    fi; \
-	    if test -d $(srcdir)/$$file && test $$d != $(srcdir); then \
-	      cp -fpR $(srcdir)/$$file "$(distdir)$$dir" || exit 1; \
-	      find "$(distdir)/$$file" -type d ! -perm -700 -exec chmod u+rwx {} \;; \
-	    fi; \
-	    cp -fpR $$d/$$file "$(distdir)$$dir" || exit 1; \
-	  else \
-	    test -f "$(distdir)/$$file" \
-	    || cp -p $$d/$$file "$(distdir)/$$file" \
-	    || exit 1; \
-	  fi; \
-	done
-	@list='$(DIST_SUBDIRS)'; for subdir in $$list; do \
-	  if test "$$subdir" = .; then :; else \
-	    test -d "$(distdir)/$$subdir" \
-	    || $(MKDIR_P) "$(distdir)/$$subdir" \
-	    || exit 1; \
-	  fi; \
-	done
-	@list='$(DIST_SUBDIRS)'; for subdir in $$list; do \
-	  if test "$$subdir" = .; then :; else \
-	    dir1=$$subdir; dir2="$(distdir)/$$subdir"; \
-	    $(am__relativize); \
-	    new_distdir=$$reldir; \
-	    dir1=$$subdir; dir2="$(top_distdir)"; \
-	    $(am__relativize); \
-	    new_top_distdir=$$reldir; \
-	    echo " (cd $$subdir && $(MAKE) $(AM_MAKEFLAGS) top_distdir="$$new_top_distdir" distdir="$$new_distdir" \\"; \
-	    echo "     am__remove_distdir=: am__skip_length_check=: am__skip_mode_fix=: distdir)"; \
-	    ($(am__cd) $$subdir && \
-	      $(MAKE) $(AM_MAKEFLAGS) \
-	        top_distdir="$$new_top_distdir" \
-	        distdir="$$new_distdir" \
-		am__remove_distdir=: \
-		am__skip_length_check=: \
-		am__skip_mode_fix=: \
-	        distdir) \
-	      || exit 1; \
-	  fi; \
-	done
-	-test -n "$(am__skip_mode_fix)" \
-	|| find "$(distdir)" -type d ! -perm -755 \
-		-exec chmod u+rwx,go+rx {} \; -o \
-	  ! -type d ! -perm -444 -links 1 -exec chmod a+r {} \; -o \
-	  ! -type d ! -perm -400 -exec chmod a+r {} \; -o \
-	  ! -type d ! -perm -444 -exec $(install_sh) -c -m a+r {} {} \; \
-	|| chmod -R a+r "$(distdir)"
-dist-gzip: distdir
-	tardir=$(distdir) && $(am__tar) | GZIP=$(GZIP_ENV) gzip -c >$(distdir).tar.gz
-	$(am__remove_distdir)
-
-dist-bzip2: distdir
-	tardir=$(distdir) && $(am__tar) | bzip2 -9 -c >$(distdir).tar.bz2
-	$(am__remove_distdir)
-
-dist-lzma: distdir
-	tardir=$(distdir) && $(am__tar) | lzma -9 -c >$(distdir).tar.lzma
-	$(am__remove_distdir)
-
-dist-xz: distdir
-	tardir=$(distdir) && $(am__tar) | xz -c >$(distdir).tar.xz
-	$(am__remove_distdir)
-
-dist-tarZ: distdir
-	tardir=$(distdir) && $(am__tar) | compress -c >$(distdir).tar.Z
-	$(am__remove_distdir)
-
-dist-shar: distdir
-	shar $(distdir) | GZIP=$(GZIP_ENV) gzip -c >$(distdir).shar.gz
-	$(am__remove_distdir)
-
-dist-zip: distdir
-	-rm -f $(distdir).zip
-	zip -rq $(distdir).zip $(distdir)
-	$(am__remove_distdir)
-
-dist dist-all: distdir
-	tardir=$(distdir) && $(am__tar) | GZIP=$(GZIP_ENV) gzip -c >$(distdir).tar.gz
-	$(am__remove_distdir)
-
-# This target untars the dist file and tries a VPATH configuration.  Then
-# it guarantees that the distribution is self-contained by making another
-# tarfile.
-distcheck: dist
-	case '$(DIST_ARCHIVES)' in \
-	*.tar.gz*) \
-	  GZIP=$(GZIP_ENV) gzip -dc $(distdir).tar.gz | $(am__untar) ;;\
-	*.tar.bz2*) \
-	  bzip2 -dc $(distdir).tar.bz2 | $(am__untar) ;;\
-	*.tar.lzma*) \
-	  lzma -dc $(distdir).tar.lzma | $(am__untar) ;;\
-	*.tar.xz*) \
-	  xz -dc $(distdir).tar.xz | $(am__untar) ;;\
-	*.tar.Z*) \
-	  uncompress -c $(distdir).tar.Z | $(am__untar) ;;\
-	*.shar.gz*) \
-	  GZIP=$(GZIP_ENV) gzip -dc $(distdir).shar.gz | unshar ;;\
-	*.zip*) \
-	  unzip $(distdir).zip ;;\
-	esac
-	chmod -R a-w $(distdir); chmod a+w $(distdir)
-	mkdir $(distdir)/_build
-	mkdir $(distdir)/_inst
-	chmod a-w $(distdir)
-	test -d $(distdir)/_build || exit 0; \
-	dc_install_base=`$(am__cd) $(distdir)/_inst && pwd | sed -e 's,^[^:\\/]:[\\/],/,'` \
-	  && dc_destdir="$${TMPDIR-/tmp}/am-dc-$$$$/" \
-	  && am__cwd=`pwd` \
-	  && $(am__cd) $(distdir)/_build \
-	  && ../configure --srcdir=.. --prefix="$$dc_install_base" \
-	    $(DISTCHECK_CONFIGURE_FLAGS) \
-	  && $(MAKE) $(AM_MAKEFLAGS) \
-	  && $(MAKE) $(AM_MAKEFLAGS) dvi \
-	  && $(MAKE) $(AM_MAKEFLAGS) check \
-	  && $(MAKE) $(AM_MAKEFLAGS) install \
-	  && $(MAKE) $(AM_MAKEFLAGS) installcheck \
-	  && $(MAKE) $(AM_MAKEFLAGS) uninstall \
-	  && $(MAKE) $(AM_MAKEFLAGS) distuninstallcheck_dir="$$dc_install_base" \
-	        distuninstallcheck \
-	  && chmod -R a-w "$$dc_install_base" \
-	  && ({ \
-	       (cd ../.. && umask 077 && mkdir "$$dc_destdir") \
-	       && $(MAKE) $(AM_MAKEFLAGS) DESTDIR="$$dc_destdir" install \
-	       && $(MAKE) $(AM_MAKEFLAGS) DESTDIR="$$dc_destdir" uninstall \
-	       && $(MAKE) $(AM_MAKEFLAGS) DESTDIR="$$dc_destdir" \
-	            distuninstallcheck_dir="$$dc_destdir" distuninstallcheck; \
-	      } || { rm -rf "$$dc_destdir"; exit 1; }) \
-	  && rm -rf "$$dc_destdir" \
-	  && $(MAKE) $(AM_MAKEFLAGS) dist \
-	  && rm -rf $(DIST_ARCHIVES) \
-	  && $(MAKE) $(AM_MAKEFLAGS) distcleancheck \
-	  && cd "$$am__cwd" \
-	  || exit 1
-	$(am__remove_distdir)
-	@(echo "$(distdir) archives ready for distribution: "; \
-	  list='$(DIST_ARCHIVES)'; for i in $$list; do echo $$i; done) | \
-	  sed -e 1h -e 1s/./=/g -e 1p -e 1x -e '$$p' -e '$$x'
-distuninstallcheck:
-	@$(am__cd) '$(distuninstallcheck_dir)' \
-	&& test `$(distuninstallcheck_listfiles) | wc -l` -le 1 \
-	   || { echo "ERROR: files left after uninstall:" ; \
-	        if test -n "$(DESTDIR)"; then \
-	          echo "  (check DESTDIR support)"; \
-	        fi ; \
-	        $(distuninstallcheck_listfiles) ; \
-	        exit 1; } >&2
-distcleancheck: distclean
-	@if test '$(srcdir)' = . ; then \
-	  echo "ERROR: distcleancheck can only run from a VPATH build" ; \
-	  exit 1 ; \
-	fi
-	@test `$(distcleancheck_listfiles) | wc -l` -eq 0 \
-	  || { echo "ERROR: files left in build directory after distclean:" ; \
-	       $(distcleancheck_listfiles) ; \
-	       exit 1; } >&2
-check-am: all-am
-check: check-recursive
-all-am: Makefile config.h
-installdirs: installdirs-recursive
-installdirs-am:
-install: install-recursive
-install-exec: install-exec-recursive
-install-data: install-data-recursive
-uninstall: uninstall-recursive
-
-install-am: all-am
-	@$(MAKE) $(AM_MAKEFLAGS) install-exec-am install-data-am
-
-installcheck: installcheck-recursive
-install-strip:
-	$(MAKE) $(AM_MAKEFLAGS) INSTALL_PROGRAM="$(INSTALL_STRIP_PROGRAM)" \
-	  install_sh_PROGRAM="$(INSTALL_STRIP_PROGRAM)" INSTALL_STRIP_FLAG=-s \
-	  `test -z '$(STRIP)' || \
-	    echo "INSTALL_PROGRAM_ENV=STRIPPROG='$(STRIP)'"` install
-mostlyclean-generic:
-
-clean-generic:
-
-distclean-generic:
-	-test -z "$(CONFIG_CLEAN_FILES)" || rm -f $(CONFIG_CLEAN_FILES)
-	-test . = "$(srcdir)" || test -z "$(CONFIG_CLEAN_VPATH_FILES)" || rm -f $(CONFIG_CLEAN_VPATH_FILES)
-
-maintainer-clean-generic:
-	@echo "This command is intended for maintainers to use"
-	@echo "it deletes files that may require special tools to rebuild."
-clean: clean-recursive
-
-clean-am: clean-generic mostlyclean-am
-
-distclean: distclean-recursive
-	-rm -f $(am__CONFIG_DISTCLEAN_FILES)
-	-rm -f Makefile
-distclean-am: clean-am distclean-generic distclean-hdr distclean-tags
-
-dvi: dvi-recursive
-
-dvi-am:
-
-html: html-recursive
-
-html-am:
-
-info: info-recursive
-
-info-am:
-
-install-data-am:
-
-install-dvi: install-dvi-recursive
-
-install-dvi-am:
-
-install-exec-am:
-
-install-html: install-html-recursive
-
-install-html-am:
-
-install-info: install-info-recursive
-
-install-info-am:
-
-install-man:
-
-install-pdf: install-pdf-recursive
-
-install-pdf-am:
-
-install-ps: install-ps-recursive
-
-install-ps-am:
-
-installcheck-am:
-
-maintainer-clean: maintainer-clean-recursive
-	-rm -f $(am__CONFIG_DISTCLEAN_FILES)
-	-rm -rf $(top_srcdir)/autom4te.cache
-	-rm -f Makefile
-maintainer-clean-am: distclean-am maintainer-clean-generic
-
-mostlyclean: mostlyclean-recursive
-
-mostlyclean-am: mostlyclean-generic
-
-pdf: pdf-recursive
-
-pdf-am:
-
-ps: ps-recursive
-
-ps-am:
-
-uninstall-am:
-
-.MAKE: $(RECURSIVE_CLEAN_TARGETS) $(RECURSIVE_TARGETS) all \
-	ctags-recursive install-am install-strip tags-recursive
-
-.PHONY: $(RECURSIVE_CLEAN_TARGETS) $(RECURSIVE_TARGETS) CTAGS GTAGS \
-	all all-am am--refresh check check-am clean clean-generic \
-	ctags ctags-recursive dist dist-all dist-bzip2 dist-gzip \
-	dist-lzma dist-shar dist-tarZ dist-xz dist-zip distcheck \
-	distclean distclean-generic distclean-hdr distclean-tags \
-	distcleancheck distdir distuninstallcheck dvi dvi-am html \
-	html-am info info-am install install-am install-data \
-	install-data-am install-dvi install-dvi-am install-exec \
-	install-exec-am install-html install-html-am install-info \
-	install-info-am install-man install-pdf install-pdf-am \
-	install-ps install-ps-am install-strip installcheck \
-	installcheck-am installdirs installdirs-am maintainer-clean \
-	maintainer-clean-generic mostlyclean mostlyclean-generic pdf \
-	pdf-am ps ps-am tags tags-recursive uninstall uninstall-am
-
-
-# Tell versions [3.59,3.63) of GNU make to not export all variables.
-# Otherwise a system limit (for SysV at least) may be exceeded.
-.NOEXPORT:
diff -Nur dosbox-0.74/missing dosbox-0.74.patch/missing
--- dosbox-0.74/missing	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/missing	1970-01-01 01:00:00.000000000 +0100
@@ -1,376 +0,0 @@
-#! /bin/sh
-# Common stub for a few missing GNU programs while installing.
-
-scriptversion=2009-04-28.21; # UTC
-
-# Copyright (C) 1996, 1997, 1999, 2000, 2002, 2003, 2004, 2005, 2006,
-# 2008, 2009 Free Software Foundation, Inc.
-# Originally by Fran,cois Pinard <pinard@iro.umontreal.ca>, 1996.
-
-# This program is free software; you can redistribute it and/or modify
-# it under the terms of the GNU General Public License as published by
-# the Free Software Foundation; either version 2, or (at your option)
-# any later version.
-
-# This program is distributed in the hope that it will be useful,
-# but WITHOUT ANY WARRANTY; without even the implied warranty of
-# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-# GNU General Public License for more details.
-
-# You should have received a copy of the GNU General Public License
-# along with this program.  If not, see <http://www.gnu.org/licenses/>.
-
-# As a special exception to the GNU General Public License, if you
-# distribute this file as part of a program that contains a
-# configuration script generated by Autoconf, you may include it under
-# the same distribution terms that you use for the rest of that program.
-
-if test $# -eq 0; then
-  echo 1>&2 "Try \`$0 --help' for more information"
-  exit 1
-fi
-
-run=:
-sed_output='s/.* --output[ =]\([^ ]*\).*/\1/p'
-sed_minuso='s/.* -o \([^ ]*\).*/\1/p'
-
-# In the cases where this matters, `missing' is being run in the
-# srcdir already.
-if test -f configure.ac; then
-  configure_ac=configure.ac
-else
-  configure_ac=configure.in
-fi
-
-msg="missing on your system"
-
-case $1 in
---run)
-  # Try to run requested program, and just exit if it succeeds.
-  run=
-  shift
-  "$@" && exit 0
-  # Exit code 63 means version mismatch.  This often happens
-  # when the user try to use an ancient version of a tool on
-  # a file that requires a minimum version.  In this case we
-  # we should proceed has if the program had been absent, or
-  # if --run hadn't been passed.
-  if test $? = 63; then
-    run=:
-    msg="probably too old"
-  fi
-  ;;
-
-  -h|--h|--he|--hel|--help)
-    echo "\
-$0 [OPTION]... PROGRAM [ARGUMENT]...
-
-Handle \`PROGRAM [ARGUMENT]...' for when PROGRAM is missing, or return an
-error status if there is no known handling for PROGRAM.
-
-Options:
-  -h, --help      display this help and exit
-  -v, --version   output version information and exit
-  --run           try to run the given command, and emulate it if it fails
-
-Supported PROGRAM values:
-  aclocal      touch file \`aclocal.m4'
-  autoconf     touch file \`configure'
-  autoheader   touch file \`config.h.in'
-  autom4te     touch the output file, or create a stub one
-  automake     touch all \`Makefile.in' files
-  bison        create \`y.tab.[ch]', if possible, from existing .[ch]
-  flex         create \`lex.yy.c', if possible, from existing .c
-  help2man     touch the output file
-  lex          create \`lex.yy.c', if possible, from existing .c
-  makeinfo     touch the output file
-  tar          try tar, gnutar, gtar, then tar without non-portable flags
-  yacc         create \`y.tab.[ch]', if possible, from existing .[ch]
-
-Version suffixes to PROGRAM as well as the prefixes \`gnu-', \`gnu', and
-\`g' are ignored when checking the name.
-
-Send bug reports to <bug-automake@gnu.org>."
-    exit $?
-    ;;
-
-  -v|--v|--ve|--ver|--vers|--versi|--versio|--version)
-    echo "missing $scriptversion (GNU Automake)"
-    exit $?
-    ;;
-
-  -*)
-    echo 1>&2 "$0: Unknown \`$1' option"
-    echo 1>&2 "Try \`$0 --help' for more information"
-    exit 1
-    ;;
-
-esac
-
-# normalize program name to check for.
-program=`echo "$1" | sed '
-  s/^gnu-//; t
-  s/^gnu//; t
-  s/^g//; t'`
-
-# Now exit if we have it, but it failed.  Also exit now if we
-# don't have it and --version was passed (most likely to detect
-# the program).  This is about non-GNU programs, so use $1 not
-# $program.
-case $1 in
-  lex*|yacc*)
-    # Not GNU programs, they don't have --version.
-    ;;
-
-  tar*)
-    if test -n "$run"; then
-       echo 1>&2 "ERROR: \`tar' requires --run"
-       exit 1
-    elif test "x$2" = "x--version" || test "x$2" = "x--help"; then
-       exit 1
-    fi
-    ;;
-
-  *)
-    if test -z "$run" && ($1 --version) > /dev/null 2>&1; then
-       # We have it, but it failed.
-       exit 1
-    elif test "x$2" = "x--version" || test "x$2" = "x--help"; then
-       # Could not run --version or --help.  This is probably someone
-       # running `$TOOL --version' or `$TOOL --help' to check whether
-       # $TOOL exists and not knowing $TOOL uses missing.
-       exit 1
-    fi
-    ;;
-esac
-
-# If it does not exist, or fails to run (possibly an outdated version),
-# try to emulate it.
-case $program in
-  aclocal*)
-    echo 1>&2 "\
-WARNING: \`$1' is $msg.  You should only need it if
-         you modified \`acinclude.m4' or \`${configure_ac}'.  You might want
-         to install the \`Automake' and \`Perl' packages.  Grab them from
-         any GNU archive site."
-    touch aclocal.m4
-    ;;
-
-  autoconf*)
-    echo 1>&2 "\
-WARNING: \`$1' is $msg.  You should only need it if
-         you modified \`${configure_ac}'.  You might want to install the
-         \`Autoconf' and \`GNU m4' packages.  Grab them from any GNU
-         archive site."
-    touch configure
-    ;;
-
-  autoheader*)
-    echo 1>&2 "\
-WARNING: \`$1' is $msg.  You should only need it if
-         you modified \`acconfig.h' or \`${configure_ac}'.  You might want
-         to install the \`Autoconf' and \`GNU m4' packages.  Grab them
-         from any GNU archive site."
-    files=`sed -n 's/^[ ]*A[CM]_CONFIG_HEADER(\([^)]*\)).*/\1/p' ${configure_ac}`
-    test -z "$files" && files="config.h"
-    touch_files=
-    for f in $files; do
-      case $f in
-      *:*) touch_files="$touch_files "`echo "$f" |
-				       sed -e 's/^[^:]*://' -e 's/:.*//'`;;
-      *) touch_files="$touch_files $f.in";;
-      esac
-    done
-    touch $touch_files
-    ;;
-
-  automake*)
-    echo 1>&2 "\
-WARNING: \`$1' is $msg.  You should only need it if
-         you modified \`Makefile.am', \`acinclude.m4' or \`${configure_ac}'.
-         You might want to install the \`Automake' and \`Perl' packages.
-         Grab them from any GNU archive site."
-    find . -type f -name Makefile.am -print |
-	   sed 's/\.am$/.in/' |
-	   while read f; do touch "$f"; done
-    ;;
-
-  autom4te*)
-    echo 1>&2 "\
-WARNING: \`$1' is needed, but is $msg.
-         You might have modified some files without having the
-         proper tools for further handling them.
-         You can get \`$1' as part of \`Autoconf' from any GNU
-         archive site."
-
-    file=`echo "$*" | sed -n "$sed_output"`
-    test -z "$file" && file=`echo "$*" | sed -n "$sed_minuso"`
-    if test -f "$file"; then
-	touch $file
-    else
-	test -z "$file" || exec >$file
-	echo "#! /bin/sh"
-	echo "# Created by GNU Automake missing as a replacement of"
-	echo "#  $ $@"
-	echo "exit 0"
-	chmod +x $file
-	exit 1
-    fi
-    ;;
-
-  bison*|yacc*)
-    echo 1>&2 "\
-WARNING: \`$1' $msg.  You should only need it if
-         you modified a \`.y' file.  You may need the \`Bison' package
-         in order for those modifications to take effect.  You can get
-         \`Bison' from any GNU archive site."
-    rm -f y.tab.c y.tab.h
-    if test $# -ne 1; then
-        eval LASTARG="\${$#}"
-	case $LASTARG in
-	*.y)
-	    SRCFILE=`echo "$LASTARG" | sed 's/y$/c/'`
-	    if test -f "$SRCFILE"; then
-	         cp "$SRCFILE" y.tab.c
-	    fi
-	    SRCFILE=`echo "$LASTARG" | sed 's/y$/h/'`
-	    if test -f "$SRCFILE"; then
-	         cp "$SRCFILE" y.tab.h
-	    fi
-	  ;;
-	esac
-    fi
-    if test ! -f y.tab.h; then
-	echo >y.tab.h
-    fi
-    if test ! -f y.tab.c; then
-	echo 'main() { return 0; }' >y.tab.c
-    fi
-    ;;
-
-  lex*|flex*)
-    echo 1>&2 "\
-WARNING: \`$1' is $msg.  You should only need it if
-         you modified a \`.l' file.  You may need the \`Flex' package
-         in order for those modifications to take effect.  You can get
-         \`Flex' from any GNU archive site."
-    rm -f lex.yy.c
-    if test $# -ne 1; then
-        eval LASTARG="\${$#}"
-	case $LASTARG in
-	*.l)
-	    SRCFILE=`echo "$LASTARG" | sed 's/l$/c/'`
-	    if test -f "$SRCFILE"; then
-	         cp "$SRCFILE" lex.yy.c
-	    fi
-	  ;;
-	esac
-    fi
-    if test ! -f lex.yy.c; then
-	echo 'main() { return 0; }' >lex.yy.c
-    fi
-    ;;
-
-  help2man*)
-    echo 1>&2 "\
-WARNING: \`$1' is $msg.  You should only need it if
-	 you modified a dependency of a manual page.  You may need the
-	 \`Help2man' package in order for those modifications to take
-	 effect.  You can get \`Help2man' from any GNU archive site."
-
-    file=`echo "$*" | sed -n "$sed_output"`
-    test -z "$file" && file=`echo "$*" | sed -n "$sed_minuso"`
-    if test -f "$file"; then
-	touch $file
-    else
-	test -z "$file" || exec >$file
-	echo ".ab help2man is required to generate this page"
-	exit $?
-    fi
-    ;;
-
-  makeinfo*)
-    echo 1>&2 "\
-WARNING: \`$1' is $msg.  You should only need it if
-         you modified a \`.texi' or \`.texinfo' file, or any other file
-         indirectly affecting the aspect of the manual.  The spurious
-         call might also be the consequence of using a buggy \`make' (AIX,
-         DU, IRIX).  You might want to install the \`Texinfo' package or
-         the \`GNU make' package.  Grab either from any GNU archive site."
-    # The file to touch is that specified with -o ...
-    file=`echo "$*" | sed -n "$sed_output"`
-    test -z "$file" && file=`echo "$*" | sed -n "$sed_minuso"`
-    if test -z "$file"; then
-      # ... or it is the one specified with @setfilename ...
-      infile=`echo "$*" | sed 's/.* \([^ ]*\) *$/\1/'`
-      file=`sed -n '
-	/^@setfilename/{
-	  s/.* \([^ ]*\) *$/\1/
-	  p
-	  q
-	}' $infile`
-      # ... or it is derived from the source name (dir/f.texi becomes f.info)
-      test -z "$file" && file=`echo "$infile" | sed 's,.*/,,;s,.[^.]*$,,'`.info
-    fi
-    # If the file does not exist, the user really needs makeinfo;
-    # let's fail without touching anything.
-    test -f $file || exit 1
-    touch $file
-    ;;
-
-  tar*)
-    shift
-
-    # We have already tried tar in the generic part.
-    # Look for gnutar/gtar before invocation to avoid ugly error
-    # messages.
-    if (gnutar --version > /dev/null 2>&1); then
-       gnutar "$@" && exit 0
-    fi
-    if (gtar --version > /dev/null 2>&1); then
-       gtar "$@" && exit 0
-    fi
-    firstarg="$1"
-    if shift; then
-	case $firstarg in
-	*o*)
-	    firstarg=`echo "$firstarg" | sed s/o//`
-	    tar "$firstarg" "$@" && exit 0
-	    ;;
-	esac
-	case $firstarg in
-	*h*)
-	    firstarg=`echo "$firstarg" | sed s/h//`
-	    tar "$firstarg" "$@" && exit 0
-	    ;;
-	esac
-    fi
-
-    echo 1>&2 "\
-WARNING: I can't seem to be able to run \`tar' with the given arguments.
-         You may want to install GNU tar or Free paxutils, or check the
-         command line arguments."
-    exit 1
-    ;;
-
-  *)
-    echo 1>&2 "\
-WARNING: \`$1' is needed, and is $msg.
-         You might have modified some files without having the
-         proper tools for further handling them.  Check the \`README' file,
-         it often tells you about the needed prerequisites for installing
-         this package.  You may also peek at any GNU archive site, in case
-         some other package would contain this missing \`$1' program."
-    exit 1
-    ;;
-esac
-
-exit 0
-
-# Local variables:
-# eval: (add-hook 'write-file-hooks 'time-stamp)
-# time-stamp-start: "scriptversion="
-# time-stamp-format: "%:y-%02m-%02d.%02H"
-# time-stamp-time-zone: "UTC"
-# time-stamp-end: "; # UTC"
-# End:
diff -Nur dosbox-0.74/README dosbox-0.74.patch/README
--- dosbox-0.74/README	2010-05-10 20:58:07.000000000 +0200
+++ dosbox-0.74.patch/README	2016-12-11 18:35:15.502284007 +0100
@@ -46,7 +46,7 @@
 It is essential that you get familiar with the idea of mounting, DOSBox does not
 automatically make any drive (or a part of it) accessible to the emulation. See
 the FAQ entry "How to start?" as well as the description of the MOUNT command
-(section 4: "Internal Programs"). If you have your game on a cdrom you may try
+(Section 4: "Internal Programs"). If you have your game on a cdrom you may try
 this guide: http://vogons.zetafleet.com/viewtopic.php?t=8933
 
 
@@ -92,7 +92,7 @@
 AUTOMATION: Do I always have to type these commands?
     In the DOSBox configuration file is an [autoexec] section. The commands
     present there are run when DOSBox starts, so you can use this section
-    for the mounting. Look at Section 13: The configuration (options) file
+    for the mounting. Look at Section 13: "The configuration (options) file".
 
 
 FULLSCREEN: How do I change to fullscreen?
@@ -116,11 +116,11 @@
       To enable SDL-support (does not include low-level CD access!):
         - mount d f:\ -t cdrom -usecd 0 -noioctl
       To enable ioctl access using digital audio extraction for CD audio
-      (windows-only, useful for Vista):
+      (Windows-only, useful for Vista):
         - mount d f:\ -t cdrom -ioctl_dx
-      To enable ioctl access using MCI for CD audio (windows-only):
+      To enable ioctl access using MCI for CD audio (Windows-only):
         - mount d f:\ -t cdrom -ioctl_mci
-      To force ioctl-only access (windows-only):
+      To force ioctl-only access (Windows-only):
         - mount d f:\ -t cdrom -ioctl_dio
       To enable low-level aspi-support (win98 with aspi-layer installed):
         - mount d f:\ -t cdrom -aspi
@@ -143,7 +143,7 @@
     Under Windows you can specify -ioctl, -aspi or -noioctl. Look at the
     description of the mount command in Section 4: "Internal programs"
     for their meaning and the
-    additional audio-CD related options -ioctl_dx, ioctl_mci, ioctl_dio.
+    additional audio-CD related options -ioctl_dx, -ioctl_mci, -ioctl_dio.
 
     Try creating a CD-ROM image (preferably CUE/BIN pair) and use the
     DOSBox's internal IMGMOUNT tool to mount the image (the CUE sheet).
@@ -161,7 +161,7 @@
     Be sure that the sound is correctly configured in the game. This might be
     done during the installation or with a setup/setsound utility that
     accompanies the game. First see if an autodetection option is provided. If
-    there is none try selecting Soundblaster or Soundblaster 16 with the default
+    there is none try selecting SoundBlaster or SoundBlaster 16 with the default
     settings being "address=220 irq=7 dma=1" (sometimes highdma=5). You might
     also want to select Sound Canvas/SCC/MPU-401/General MIDI/Wave Blaster
     at "address=330 IRQ=2" as music device.
@@ -171,8 +171,8 @@
     configuration and use some lower fixed cycles value (like cycles=2000). Also
     assure that your host operating sound does provide sound.
     In certain cases it might be useful to use a different emulated sound device
-    like a soundblaster pro (sbtype=sbpro1 in the DOSBox configuration file) or
-    the gravis ultrasound (gus=true).
+    like a SoundBlaster Pro (sbtype=sbpro1 in the DOSBox configuration file) or
+    the Gravis Ultrasound (gus=true).
 
 
 SOUND: What sound hardware does DOSBox presently emulate?
@@ -182,21 +182,21 @@
       digital sound output through the internal speaker.
     - Creative CMS/Gameblaster
       The is the first card released by Creative Labs(R).  The default
-      configuration places it on address 220. It is disabled as default.
+      configuration places it on address 220. It is disabled by default.
     - Tandy 3 voice
       The emulation of this sound hardware is complete with the exception of
       the noise channel. The noise channel is not very well documented and as
       such is only a best guess as to the sound's accuracy. It is disabled as
       default.
     - Tandy DAC
-      Some games may require turning off sound blaster emulation (sbtype=none)
-      for better tandy DAC sound support. Don't forget to set the sbtype back to
-      sb16 if you don't use tandy sound.
+      Some games may require turning off SoundBlaster emulation (sbtype=none)
+      for better Tandy DAC sound support. Don't forget to set the sbtype back to
+      sb16 if you don't use Tandy sound.
     - Adlib
       This emulation is almost perfect and includes the Adlib's ability to
       almost play digitized sound. Placed at address 220 (also on 388).
     - SoundBlaster 16 / SoundBlaster Pro I & II / SoundBlaster I & II
-      By default DOSBox provides Soundblaster 16 level 16-bit stereo sound.
+      By default DOSBox provides SoundBlaster 16 level 16-bit stereo sound.
       You can select a different SoundBlaster version in the configuration of
       DOSBox. AWE32 music is not emulated as you can use MPU-401 instead
       (see below).
@@ -207,24 +207,25 @@
       The emulation of this hardware is nearly complete, though the MIDI
       capabilities have been left out, since an MPU-401 has been emulated
       in other code. For Gravis music you also have to install Gravis drivers
-      inside DOSBox. It is disabled as default.
+      inside DOSBox. It is disabled by default.
     - MPU-401
       A MIDI passthrough interface is also emulated. This method of sound
       output will only work when used with external device/emulator.
-      Every Windows XP/Vista/7 and MAC OS has got a default emulator compatible
-      with: Sound Canvas/SCC/General Standard/General MIDI/Wave Blaster.
-      A different device/emulator is needed for Roland LAPC/CM-32L/MT-32
-      compatibility.
+      Every Windows XP/Vista/7 and Mac OS X has got a default emulator 
+      compatible with: Sound Canvas/SCC/General Standard/General MIDI/Wave 
+      Blaster. A different device/emulator is needed for 
+      Roland LAPC/CM-32L/MT-32 compatibility.
 
 
 SOUND: The sound stutters or sounds stretched/weird.
     You may be using too much CPU power to keep DOSBox running at the current
     speed. You can lower the cycles, skip frames, reduce the sampling rate of
-    the respective sound device, increase the prebuffer. See section 13: "The
-    configuration (options) file"
-    If you are using cycles=max or =auto, then make sure that there is no
-    background processes interfering! (especially if they access the harddisk)
-    Also look at Section 10. "How to speed up/slow down DOSBox"
+    the respective sound device, increase the prebuffer. See Section 13: "The
+    configuration (options) file".
+    If you are using 'cycles=max' or 'cycles=auto', then make sure that there is
+    no background processes interfering! (especially if they access the harddisk)
+    Also look at Section 10: "How to speed up/slow down DOSBox" as well as
+    Section 11: "Troubleshooting".
 
 
 KEYBOARD: I can't type \ or : in DOSBox.
@@ -233,7 +234,7 @@
     detected), or the key mapping is wrong.
     Some possible fixes:
       1. Use / instead, or ALT-58 for : and ALT-92 for \.
-      2. Change the DOS keyboard layout (see Section 8: Keyboard Layout).
+      2. Change the DOS keyboard layout (see Section 8: "Keyboard Layout").
       3. Add the commands you want to execute to the [autoexec] section
          of the DOSBox configuration file.
       4. Open the DOSBox configuration file and change the usescancodes entry.
@@ -274,16 +275,16 @@
 
 
 SPEED: The game/application runs much too slow/too fast!
-    Look at the section 10: "How to speed up/slow down DOSBox" for more
+    Look at Section 10: "How to speed up/slow down DOSBox" for more
     information.
 
 
 CRASH: The game/application does not run at all/crashes!
-    Look at Section 11: Troubleshooting
+    Look at Section 11: "Troubleshooting".
 
 
-CRASH: DOSBox crashes on startup!.
-    Look at Section 11: Troubleshooting
+CRASH: DOSBox crashes on startup!
+    Look at Section 11: "Troubleshooting".
 
 
 GAME: My Build game(Duke3D/Blood/Shadow Warrior) has problems.
@@ -302,7 +303,7 @@
 
 
 OPTIONS: I would like to change DOSBox's options.
-    Look at Section 13. "The configuration (options) file"
+    Look at Section 13: "The configuration (options) file".
 
 
 HELP: Great Manual, but I still don't get it.
@@ -319,12 +320,12 @@
 
 An overview of the command line options you can give to DOSBox. Although
 in most cases it is easier to use DOSBox's configuration file instead.
-See: Section 13. "The configuration (options) file"
+See Section 13: "The configuration (options) file".
 
 To be able to use Command Line Parameters:
 (Windows)  open cmd.exe or command.com or edit the shortcut to dosbox.exe
 (Linux)    use console
-(MAC OS X) start terminal.app and navigate to:
+(Mac OS X) start terminal.app and navigate to:
            /applications/dosbox.app/contents/macos/dosbox
 
 The options are valid for all operating systems unless noted in the option
@@ -368,24 +369,24 @@
   -conf configfilelocation
         Start DOSBox with the options specified in "configfilelocation".
         Multiple -conf options may be present.
-        See Section 13 for more details.
+        See Section 13: "The configuration (options) file" for more details.
 
   -lang languagefilelocation
         Start DOSBox using the language specified in "languagefilelocation".
-        See Section 14 for more details.
+        See Section 14: "The Language File" for more details.
 
   -machine machinetype
         Setup DOSBox to emulate a specific type of machine. Valid choices are:
         hercules, cga, ega, pcjr, tandy, svga_s3 (default) as well as
-        the additional svga chipsets listed in the DOSBox configuration file.
-        svga_s3 enables vesa emulation as well.
-        For some special vga effects the machinetype vgaonly can be used,
-        note that this disables svga capabilities and might be slower due to the
+        the additional SVGA chipsets listed in the DOSBox configuration file.
+        svga_s3 enables VESA emulation as well.
+        For some special VGA effects the machinetype vgaonly can be used,
+        note that this disables SVGA capabilities and might be slower due to the
         higher emulation precision.
         The machinetype affects the video card and the available sound cards.
 
   -noconsole (Windows Only)
-        Start DOSBox without showing DOSBox Status Window (console).
+        Start DOSBox without showing the DOSBox status window (console).
         Output will be redirected to stdout.txt and stderr.txt
 
   -startmapper
@@ -525,7 +526,7 @@
         Forces use of the SDL CD-ROM layer. Valid on all systems.
 
   -usecd number
-        Valid on all systems, under windows the -noioctl switch has to be
+        Valid on all systems, under Windows the -noioctl switch has to be
         present to make use of the -usecd switch.
         Enables to select the drive that should be used by SDL. Use this if
         the wrong or no CD-ROM drive is mounted while using the SDL CD-ROM
@@ -621,7 +622,19 @@
 
 
 CONFIG -writeconf filelocation
+CONFIG -writeconf
+CONFIG -wcp filelocation
+CONFIG -wcd
 CONFIG -writelang filelocation
+CONFIG -axadd
+CONFIG -axclear
+CONFIG -axtype
+CONFIG -r [parameters]
+CONFIG -l
+CONFIG -help
+CONFIG -help sections
+CONFIG -help section
+CONFIG -help section property
 CONFIG -securemode
 CONFIG -set "section property=value"
 CONFIG -get "section property"
@@ -632,20 +645,74 @@
   be found in Section 13: "The configuration (options) file".
 
   -writeconf filelocation
-     Write the current configuration settings to a file in a specified location.
-    "filelocation" is located on the local drive, not a mounted drive in DOSBox.
+     (or -wc filelocation)
+     Write the current configuration settings to a file in a specified location
+     relative to the DOSBox config directory. Relative and absolute paths are 
+     possible. "filelocation" is located on the local drive, not a mounted 
+     drive in DOSBox.
+     
      The configuration file controls various settings of DOSBox:
      the amount of emulated memory, the emulated sound cards and many more
      things. It allows access to AUTOEXEC.BAT as well.
      See Section 13: "The configuration (options) file" for more information.
 
+  -writeconf
+     (or -wc)
+     Write the configuration to the primary loaded config file.
+
+  -wcp filelocation
+     Write the current configuration settings to the specified file in or 
+     relative to the DOSBox program start directory. Realtive and absolute 
+     paths are possible. This is located on a drive on the host, not a mounted
+     drive in DOSBox. It is useful if you keep DOSBox on a removable media.
+     If file is omitted, the configuration will be written to dosbox.conf.
+     
+  -wcd
+     Write the current configuration to the default config file.
+        
+     
   -writelang filelocation
+     (or -wl filelocation)
      Write the current language settings to a file in a specified location.
      "filelocation" is located on the local drive, not a mounted drive
      in DOSBox. The language file controls all visible output of the internal
      commands and the internal DOS.
      See Section 14: "The Language File" for more information.
 
+  -axadd "line1" "line2" ...
+     Adds a command line to the autoexec section.
+
+  -axclear
+     Clears the autoexec section.
+     
+  -axtype
+     Prints the content of the autoexec section.
+
+  -r [parameters]
+     Restart DOSBox, either with the parameters that were used to start the
+     current instance or any that are appended.
+
+  -l 
+     lists DOSBox parameters:
+     - the configuration directory
+     - the config files that were used when starting this session
+     - the command line parameters DOSBox was started with
+
+  -h, -help, -?
+     Displays an overvie of the config commands.
+
+  -h, -help, -? sections
+     Displays the list of sections in the config file.
+  
+  -h, -help, -? section
+     Displays the list of properties contained in the specified section.
+     
+  -h, -help, -? section property
+     Shows information about the specified property in the specified section:
+     - purpose of the property
+     - possible values, current value, default value
+     - wether it can definitely not be changed at runtime
+       
   -securemode
      Switches DOSBox to a more secure mode. In this mode the internal
      commands MOUNT, IMGMOUNT and BOOT won't work. It's not possible either
@@ -654,7 +721,6 @@
 
   -set "section property=value"
      CONFIG will attempt to set the property to new value.
-     Currently CONFIG can not report whether the command succeeded or not.
 
   -get "section property"
      The current value of the property is reported and stored in the
@@ -670,11 +736,26 @@
         config -writeconf c:\dosgames\dosbox.conf
     2. To set the cpu cycles to 10000:
         config -set "cpu cycles=10000"
-    3. To turn ems memory emulation off:
-        config -set "dos ems=off"
+    3. To turn EMS memory emulation off:
+        config -set "dos ems=false"
     4. To check which cpu core is being used.
         config -get "cpu core"
-
+    5. To view the list of possible cpu cores:
+        config -help cpu core
+    6. To change the machine type and restart:
+        config -set "machine cga"
+        config -wc -r
+    7. To configure the autoexec section to auto-mount a directory at start:
+        config -axadd "mount c c:\dosgames" "c:"
+        config -wc
+    8. To create a specific config file in the config directory:
+        config -set "dos ems=false"
+        config -set "cpu cycles=10000"
+        config -set "core dynamic"
+        config -axadd "mount c c:\dosgames" "c:" "cd my_game" "my_game"
+        config -wc my_config.conf
+    9. To restart DOSBox from a specific config file in the config directory:
+        config -r -conf my_config.conf
 
 LOADFIX [-size] [program] [program-parameters]
 LOADFIX -f
@@ -697,10 +778,19 @@
        loadfix -f
 
 
-RESCAN
+RESCAN [Drive:] [-All]
   Make DOSBox reread the directory structure. Useful if you changed something
   on a mounted drive outside of DOSBox. (CTRL - F4 does this as well!)
-
+  
+  Drive: 
+        Drive to refresh.
+
+  -All
+        Refresh all drives.
+
+  if both a Drive: and -All are missing, then the current drive will be 
+  refreshed.
+  
 
 MIXER
   Makes DOSBox display its current volume settings.
@@ -922,7 +1012,7 @@
 KEYB [keyboardlayoutcode [codepage [codepagefile]]]
 
   Change the keyboard layout. For detailed information about keyboard layouts
-  please see Section 8: "Keyboard Layout"
+  please see Section 8: "Keyboard Layout".
 
   [keyboardlayoutcode] is a string consisting of five or less characters,
      examples are PL214 (Polish typists) or PL457 (Polish programmers).
@@ -984,8 +1074,9 @@
 CTRL-F11      Slow down emulation (Decrease DOSBox Cycles).
 CTRL-F12      Speed up emulation (Increase DOSBox Cycles)*.
 ALT-F12       Unlock speed (turbo button/fast forward)**.
-F11, ALT-F11  (machine=cga) change tint in NTSC output modes***
-F11           (machine=hercules) cycle through amber, green, white colouring***
+CTRL-ALT-HOME Restart DOSBox.
+F11, ALT-F11  (machine=cga) change tint in NTSC output modes***.
+F11           (machine=hercules) cycle through amber, green, white colouring***.
 
 *NOTE: Once you increase your DOSBox cycles beyond your computer CPU resources,
        it will produce the same effect as slowing down the emulation.
@@ -999,15 +1090,16 @@
          a different machine type. So either reassign them or reset the mapper.
 
 These are the default keybindings. They can be changed in the keymapper
-(see Section 7: KeyMapper). 
+(see Section 7: "KeyMapper"). 
 
-In MAC OS you can try using cmd(applekey) together with Ctrl if the key doesn't
-work eg. cmd-ctrl-F1, but some keys may still need remapping (in Linux too).
+In Mac OS X you can try using cmd(applekey) together with Ctrl (and/or ) Fn, 
+if the key doesn't work i.e. fn-cmd-ctrl-F1, but some keys may still need 
+remapping (in Linux too).
 
 Saved/recorded files can be found in:
    (Windows)    "Start/WinLogo Menu"->"All Programs"->DOSBox-0.74->Extras
    (Linux)      ~/.dosbox/capture
-   (MAC OS X)   "~/Library/Preferences/capture"
+   (Mac OS X)   "~/Library/Preferences/capture"
 This can be changed in the DOSBox configuration file.
 
 
@@ -1040,17 +1132,12 @@
         than one button at the same time.
 
 You also have to configure controller properly inside the game.
-
 It is important to remember that if you saved the mapperfile without joystick
-
-connected, or with a different joystick setting, your new setting will 
-not work
-properly, 
-or not work at all, until you reset DOSBox's mapperfile.
-
+connected, or with a different joystick setting, your new setting will not work
+properly, or not work at all, until you reset DOSBox's mapperfile.
 
 If controller is working properly outside DOSBox, but doesn't calibrate properly
-inside DOSBox, try different 'timed' setting in DOSBox's configuration file.
+inside DOSBox, try a different 'timed' setting in DOSBox's configuration file.
 
 
 
@@ -1058,8 +1145,8 @@
 7. KeyMapper:
 =============
 
-You start the DOSBox mapper either with CTRL-F1 (see section 5. Special Keys)
-or -startmapper (see Section 3. Command Line Parameters). 
+Start the DOSBox mapper either with CTRL-F1 (see Section 5: "Special Keys") or
+-startmapper (see Section 3: "Command Line Parameters"). 
 You are presented with a virtual keyboard and a virtual joystick.
 
 These virtual devices correspond to the keys and events DOSBox will
@@ -1115,7 +1202,7 @@
         mapped key X. Click "Del".
 
 
-Examples about remapping the joystick:
+Examples of remapping the joystick:
   You have a joystick attached, it is working fine under DOSBox and you
   want to play some keyboard-only game with the joystick (it is assumed
   that the game is controlled by the arrows on the keyboard):
@@ -1137,7 +1224,7 @@
 
   If you want to remap anything to your d-pad/hat you will have to change
   'joysticktype=auto' to 'joysticktype=fcs' in configuration file. Maybe this
-  will be improved in the next dosbox version.
+  will be improved in the next DOSBox version.
 
 
 If you change the default mapping, you can save your changes by clicking on
@@ -1152,12 +1239,12 @@
 ===================
 
 To switch to a different keyboard layout, either the entry "keyboardlayout"
-in the [dos] section of the DOSBox configuration file can be used, or the
-internal DOSBox program keyb.com (Section 4: Internal Programs)
-Both accept DOS conforming language codes (see below),
-but only by using keyb.com a custom codepage can be specified.
+in the [dos] section of the DOSBox configuration file or the internal DOSBox
+program keyb.com (Section 4: "Internal Programs") can be used. Both accept
+DOS conforming language codes (see below), but only by using keyb.com a
+custom codepage can be specified.
 
-The default keyboardlayout=auto currently works under windows only. The language
+The default keyboardlayout=auto currently works under Windows only. The language
 is chosen according to the OS language, but the keyboard layout is not detected.
 
 Layout switching
@@ -1230,7 +1317,7 @@
  * port:         - TCP port number. Default: 23
  * rxdelay:      - how long (milliseconds) to delay received data if the
                    interface is not ready. Increase this value if you encounter
-                   overrun errors in the DOSBox Status Window. Default: 100
+                   overrun errors in the DOSBox status window. Default: 100
  * txdelay:      - how long to gather data before sending a packet. Default: 12
                    (reduces Network overhead)
  * server:       - This nullmodem will be a client connecting to the specified
@@ -1269,8 +1356,8 @@
   a different setting in the DOSBox's configuration file.
 
   You can force the slow or fast behavior by setting a fixed amount of cycles
-  in the DOSBox's configuration file. If you for example set cycles=10000, then
-  DOSBox window will display a line "Cpu Speed: fixed 10000 cycles" at the top.
+  in the DOSBox's configuration file. If you set for example cycles=10000, the
+  DOSBox window will display a line "CPU speed: fixed 10000 cycles" at the top.
   In this mode you can reduce the amount of cycles even more by hitting CTRL-F11
   (you can go as low as you want) or raise it by hitting CTRL-F12 as much as you
   want, but you will be limited by the power of one core of your computer's CPU.
@@ -1285,8 +1372,8 @@
 
   You can also force the fast behavior by setting cycles=max in the DOSBox
   configuration file. The DOSBox window will display a line
-  "Cpu Speed: max 100% cycles" at the top then. This time you won't have to care
-  how much free time your real CPU's cores have, because DOSBox will always use
+  "CPU speed: max 100% cycles" at the top then. This time you won't have to care
+  how much free time your real CPU cores have, because DOSBox will always use
   100% of your real CPU's one core. In this mode you can reduce the amount
   of your real CPU's core usage by CTRL-F11 or raise it with CTRL-F12.
 
@@ -1336,7 +1423,7 @@
 ====================
 
 General tip:
-  Check messages in DOSBox Status Window. See section 12. "DOSBox Status Window"
+  Check messages in the DOSBox status window. See Section 12: "DOSBox Status Window".
 
 DOSBox crashes right after starting it:
   - use different values for the output= entry in your DOSBox
@@ -1382,14 +1469,14 @@
 12. DOSBox Status Window:
 =========================
 
-DOSBox's Staus window contains many useful information about your currant
-configuration, your actions in DOSBox, errors that happened and more.
-Whenever you have any problem with DOSBox check these messages.
-
-To start DOSBox Status Window:
-  (Windows)  Status Window is being started together with main DOSBox window.
-  (Linux)    You may have to start DOSBox from a console to see Status Window.
-  (MAC OS X) Right click on DOSBox.app, choose "Show Package Contents"->
+DOSBox's status window contains useful information about your current
+configuration, your actions in DOSBox, errors which occurred and more.
+Check these messages in case you encounter any problems with DOSBox.
+
+To display the DOSBox status window:
+  (Windows)  The status window is being started together with main DOSBox window.
+  (Linux)    You may have to start DOSBox from a console to see the status window.
+  (Mac OS X) Right click on DOSBox.app, choose "Show Package Contents"->
              ->enter "Contents"->enter "MacOS"->run "DOSBox"
 
 
@@ -1402,7 +1489,7 @@
 The file can be found in:
    (Windows)  "Start/WinLogo Menu"->"All Programs"->DOSBox-0.74->Options
    (Linux)    ~/.dosbox/dosbox-0.74.conf
-   (MAC OS X) "~/Library/Preferences/DOSBox 0.74 Preferences"
+   (Mac OS X) "~/Library/Preferences/DOSBox 0.74 Preferences"
 The file is divided into several sections. Each section starts with a
 [section name] line. The settings are the property=value lines where value can
 be altered to customize DOSBox.
diff -Nur dosbox-0.74/scripts/captures.bat dosbox-0.74.patch/scripts/captures.bat
--- dosbox-0.74/scripts/captures.bat	1970-01-01 01:00:00.000000000 +0100
+++ dosbox-0.74.patch/scripts/captures.bat	2016-12-11 18:35:15.502284007 +0100
@@ -0,0 +1 @@
+DOSBox.exe -opencaptures explorer.exe
\ Kein Zeilenumbruch am Dateiende.
diff -Nur dosbox-0.74/scripts/dosbox-installer.nsi dosbox-0.74.patch/scripts/dosbox-installer.nsi
--- dosbox-0.74/scripts/dosbox-installer.nsi	1970-01-01 01:00:00.000000000 +0100
+++ dosbox-0.74.patch/scripts/dosbox-installer.nsi	2016-12-11 18:35:15.502284007 +0100
@@ -0,0 +1,184 @@
+!define VER_MAYOR 0
+!define VER_MINOR 74
+!define APP_NAME "DOSBox ${VER_MAYOR}.${VER_MINOR} Installer"
+!define COMP_NAME "DOSBox Team"
+!define COPYRIGHT "Copyright  2002-2013 DOSBox Team"
+!define DESCRIPTION "DOSBox Installer"
+
+VIProductVersion "${VER_MAYOR}.${VER_MINOR}.0.0"
+VIAddVersionKey  "ProductName"  "${APP_NAME}"
+VIAddVersionKey  "CompanyName"  "${COMP_NAME}"
+VIAddVersionKey  "FileDescription"  "${DESCRIPTION}"
+VIAddVersionKey  "FileVersion"  "${VER_MAYOR}.${VER_MINOR}.0.0"
+VIAddVersionKey  "ProductVersion"  "${VER_MAYOR}, ${VER_MINOR}, 0, 0"
+VIAddVersionKey  "LegalCopyright"  "${COPYRIGHT}"
+
+; The name of the installer
+Name "${APP_NAME}"
+
+; The file to write
+OutFile "DOSBox${VER_MAYOR}.${VER_MINOR}-win32-installer.exe"
+
+; The default installation directory
+InstallDir "$PROGRAMFILES\DOSBox-${VER_MAYOR}.${VER_MINOR}"
+
+; The text to prompt the user to enter a directory
+DirText "This will install DOSBox v${VER_MAYOR}.${VER_MINOR} on your computer. Choose a directory"
+SetCompressor /solid lzma
+
+
+LicenseData COPYING
+LicenseText "DOSBox v${VER_MAYOR}.${VER_MINOR} License" "Next >"
+
+; Else vista enables compatibility mode
+RequestExecutionLevel admin
+; Shortcuts in all users
+
+ComponentText "Select components for DOSBox"
+; The stuff to install
+Section "!Core files" Core
+SetShellVarContext all
+
+  ; Set output path to the installation directory.
+  ClearErrors
+  SetOutPath $INSTDIR
+  IfErrors error_createdir
+  SectionIn RO
+
+  ; Put file there
+  
+  CreateDirectory "$INSTDIR\Video Codec"
+  CreateDirectory "$INSTDIR\Documentation"
+  SetOutPath "$INSTDIR\Documentation"
+  File /oname=README.txt README
+  File /oname=COPYING.txt COPYING
+  File /oname=THANKS.txt THANKS
+  File /oname=NEWS.txt NEWS
+  File /oname=AUTHORS.txt AUTHORS
+  File /oname=INSTALL.txt INSTALL
+  SetOutPath "$INSTDIR"
+
+  File "/oname=DOSBox ${VER_MAYOR}.${VER_MINOR} Manual.txt" README
+  File "/oname=DOSBox.exe" DOSBox.exe
+  File SDL.dll
+  File SDL_net.dll
+  File "/oname=Video Codec\zmbv.dll" zmbv.dll
+  File "/oname=Video Codec\zmbv.inf" zmbv.inf
+  File "/oname=Video Codec\Video Instructions.txt" README.video
+  File "/oname=DOSBox ${VER_MAYOR}.${VER_MINOR} Options.bat" editconf.bat
+  File "/oname=Reset KeyMapper.bat" resetmapper.bat
+  File "/oname=Reset Options.bat" resetconf.bat
+  File "/oname=Screenshots & Recordings.bat" captures.bat
+  
+  CreateDirectory "$SMPROGRAMS\DOSBox-${VER_MAYOR}.${VER_MINOR}"
+  CreateDirectory "$SMPROGRAMS\DOSBox-${VER_MAYOR}.${VER_MINOR}\Extras"
+  CreateDirectory "$SMPROGRAMS\DOSBox-${VER_MAYOR}.${VER_MINOR}\Extras\Video"
+  CreateDirectory "$SMPROGRAMS\DOSBox-${VER_MAYOR}.${VER_MINOR}\Options"
+  CreateShortCut "$SMPROGRAMS\DOSBox-${VER_MAYOR}.${VER_MINOR}\DOSBox ${VER_MAYOR}.${VER_MINOR}.lnk" "$INSTDIR\DOSBox.exe" "-userconf" "$INSTDIR\DOSBox.exe" 0
+  CreateShortCut "$SMPROGRAMS\DOSBox-${VER_MAYOR}.${VER_MINOR}\DOSBox ${VER_MAYOR}.${VER_MINOR} Manual.lnk" "$INSTDIR\Documentation\README.txt"
+  CreateShortCut "$SMPROGRAMS\DOSBox-${VER_MAYOR}.${VER_MINOR}\Extras\DOSBox ${VER_MAYOR}.${VER_MINOR} (noconsole).lnk" "$INSTDIR\DOSBox.exe" "-noconsole -userconf" "$INSTDIR\DOSBox.exe" 0
+  CreateShortCut "$SMPROGRAMS\DOSBox-${VER_MAYOR}.${VER_MINOR}\Extras\Uninstall.lnk" "$INSTDIR\uninstall.exe" "" "$INSTDIR\uninstall.exe" 0
+  CreateShortCut "$SMPROGRAMS\DOSBox-${VER_MAYOR}.${VER_MINOR}\Extras\Screenshots & Recordings.lnk" "$INSTDIR\DOSBox.exe" "-opencaptures explorer.exe"
+
+  CreateShortCut "$SMPROGRAMS\DOSBox-${VER_MAYOR}.${VER_MINOR}\Options\DOSBox ${VER_MAYOR}.${VER_MINOR} Options.lnk" "$INSTDIR\DOSBox.exe" "-editconf notepad.exe -editconf $\"%SystemRoot%\system32\notepad.exe$\" -editconf $\"%WINDIR%\notepad.exe$\""
+  CreateShortCut "$SMPROGRAMS\DOSBox-${VER_MAYOR}.${VER_MINOR}\Options\Reset Options.lnk" "$INSTDIR\DOSBox.exe" "-eraseconf"
+  CreateShortCut "$SMPROGRAMS\DOSBox-${VER_MAYOR}.${VER_MINOR}\Options\Reset KeyMapper.lnk" "$INSTDIR\DOSBox.exe" "-erasemapper"
+
+  CreateShortCut "$SMPROGRAMS\DOSBox-${VER_MAYOR}.${VER_MINOR}\Extras\Video\Video instructions.lnk" "$INSTDIR\Video Codec\Video Instructions.txt"
+;change outpath so the working directory gets set to zmbv
+SetOutPath "$INSTDIR\Video Codec"
+  ; Shortcut creation depends on wether we are 9x of NT
+  ClearErrors
+  ReadRegStr $R0 HKLM "SOFTWARE\Microsoft\Windows NT\CurrentVersion" CurrentVersion
+  IfErrors we_9x we_nt
+we_nt:
+  ;shortcut for win NT
+  CreateShortCut "$SMPROGRAMS\DOSBox-${VER_MAYOR}.${VER_MINOR}\Extras\Video\Install movie codec.lnk" "rundll32" "setupapi,InstallHinfSection DefaultInstall 128 $INSTDIR\Video Codec\zmbv.inf"
+  goto end
+we_9x:
+  ;shortcut for we_9x
+  CreateShortCut "$SMPROGRAMS\DOSBox-${VER_MAYOR}.${VER_MINOR}\Extras\Video\Install movie codec.lnk" "rundll" "setupx.dll,InstallHinfSection DefaultInstall 128 $INSTDIR\Video Codec\zmbv.inf"
+end:
+SetOutPath $INSTDIR
+WriteUninstaller "uninstall.exe"
+
+  goto end_section
+
+error_createdir:
+  MessageBox MB_OK "Can't create DOSBox program directory, aborting."
+  Abort
+  goto end_section
+
+end_section:
+SectionEnd ; end the section
+
+Section "Desktop Shortcut" SecDesktop
+SetShellVarContext all
+
+CreateShortCut "$DESKTOP\DOSBox ${VER_MAYOR}.${VER_MINOR}.lnk" "$INSTDIR\DOSBox.exe" "-userconf" "$INSTDIR\DOSBox.exe" 0
+
+SectionEnd ; end the section 
+
+
+UninstallText "This will uninstall DOSBox  v${VER_MAYOR}.${VER_MINOR}. Hit next to continue."
+
+Section "Uninstall"
+
+; Shortcuts in all users
+SetShellVarContext all
+
+  Delete "$DESKTOP\DOSBox ${VER_MAYOR}.${VER_MINOR}.lnk"
+  ; remove registry keys
+  ; remove files
+  Delete $INSTDIR\Documentation\README.txt
+  Delete $INSTDIR\Documentation\COPYING.txt
+  Delete $INSTDIR\Documentation\THANKS.txt
+  Delete $INSTDIR\Documentation\NEWS.txt
+  Delete $INSTDIR\Documentation\AUTHORS.txt
+  Delete $INSTDIR\Documentation\INSTALL.txt
+  Delete "$INSTDIR\DOSBox ${VER_MAYOR}.${VER_MINOR} Manual.txt"
+  Delete "$INSTDIR\DOSBox.exe"
+  Delete $INSTDIR\SDL.dll
+  Delete $INSTDIR\SDL_net.dll
+  Delete "$INSTDIR\Video Codec\zmbv.dll"
+  Delete "$INSTDIR\Video Codec\zmbv.inf"
+  Delete "$INSTDIR\Video Codec\Video Instructions.txt"
+  ;Files left by sdl taking over the console
+  Delete $INSTDIR\stdout.txt
+  Delete $INSTDIR\stderr.txt
+  Delete "$INSTDIR\DOSBox ${VER_MAYOR}.${VER_MINOR} Options.bat"
+  Delete "$INSTDIR\Reset KeyMapper.bat"
+  Delete "$INSTDIR\Reset Options.bat"
+  Delete "$INSTDIR\Screenshots & Recordings.bat"
+
+  ; MUST REMOVE UNINSTALLER, too
+  Delete $INSTDIR\uninstall.exe
+
+
+  Delete "$SMPROGRAMS\DOSBox-${VER_MAYOR}.${VER_MINOR}\DOSBox ${VER_MAYOR}.${VER_MINOR}.lnk"
+  Delete "$SMPROGRAMS\DOSBox-${VER_MAYOR}.${VER_MINOR}\DOSBox ${VER_MAYOR}.${VER_MINOR} Manual.lnk"
+  Delete "$SMPROGRAMS\DOSBox-${VER_MAYOR}.${VER_MINOR}\Extras\DOSBox ${VER_MAYOR}.${VER_MINOR} (noconsole).lnk"
+  Delete "$SMPROGRAMS\DOSBox-${VER_MAYOR}.${VER_MINOR}\Extras\Uninstall.lnk"
+  Delete "$SMPROGRAMS\DOSBox-${VER_MAYOR}.${VER_MINOR}\Extras\Screenshots & Recordings.lnk"
+
+  Delete "$SMPROGRAMS\DOSBox-${VER_MAYOR}.${VER_MINOR}\Options\DOSBox ${VER_MAYOR}.${VER_MINOR} Options.lnk"
+  Delete "$SMPROGRAMS\DOSBox-${VER_MAYOR}.${VER_MINOR}\Options\Reset Options.lnk"
+  Delete "$SMPROGRAMS\DOSBox-${VER_MAYOR}.${VER_MINOR}\Options\Reset KeyMapper.lnk"
+
+  Delete "$SMPROGRAMS\DOSBox-${VER_MAYOR}.${VER_MINOR}\Extras\Video\Video instructions.lnk"
+  Delete "$SMPROGRAMS\DOSBox-${VER_MAYOR}.${VER_MINOR}\Extras\Video\Install movie codec.lnk"
+
+
+
+; remove shortcuts, if any.
+; remove directories used.
+  RMDir "$INSTDIR\Documentation"
+  RMDir "$INSTDIR\Video Codec"
+  RMDir "$INSTDIR"
+  RMDir "$SMPROGRAMS\DOSBox-${VER_MAYOR}.${VER_MINOR}\Options"
+  RMDir "$SMPROGRAMS\DOSBox-${VER_MAYOR}.${VER_MINOR}\Extras\Video"
+  RMDir "$SMPROGRAMS\DOSBox-${VER_MAYOR}.${VER_MINOR}\Extras"
+  RMDir "$SMPROGRAMS\DOSBox-${VER_MAYOR}.${VER_MINOR}"
+SectionEnd
+
+; eof
diff -Nur dosbox-0.74/scripts/editconf.bat dosbox-0.74.patch/scripts/editconf.bat
--- dosbox-0.74/scripts/editconf.bat	1970-01-01 01:00:00.000000000 +0100
+++ dosbox-0.74.patch/scripts/editconf.bat	2016-12-11 18:35:15.502284007 +0100
@@ -0,0 +1 @@
+DOSBox.exe -editconf notepad.exe -editconf %SystemRoot%\system32\notepad.exe -editconf %WINDIR%\notepad.exe
\ Kein Zeilenumbruch am Dateiende.
diff -Nur dosbox-0.74/scripts/ega-switch.pl dosbox-0.74.patch/scripts/ega-switch.pl
--- dosbox-0.74/scripts/ega-switch.pl	1970-01-01 01:00:00.000000000 +0100
+++ dosbox-0.74.patch/scripts/ega-switch.pl	2016-12-11 18:35:15.502284007 +0100
@@ -0,0 +1,32 @@
+#!/usr/bin/perl
+use integer;
+open (THEFILE,'>','../src/hardware/ega-switch.h')
+	or die "Can't open my file $!";
+
+print THEFILE "switch (bit_mask) {\n";
+for ($i = 0; $i < 256; $i++) {
+	print THEFILE "\tcase $i:\n";
+	$b=128;
+	$add=0;
+	do  {
+		if ($i & $b) {
+			print THEFILE "\t{\n";
+			print THEFILE "\t\tBit8u color=0;\n";
+			print THEFILE "\t\tif (pixels.b[0] & $b) color|=1;\n";
+			print THEFILE "\t\tif (pixels.b[1] & $b) color|=2;\n";
+			print THEFILE "\t\tif (pixels.b[2] & $b) color|=4;\n";
+			print THEFILE "\t\tif (pixels.b[3] & $b) color|=8;\n";
+			print THEFILE "\t\t*(write_pixels+$add)=color;\n";
+			print THEFILE "\t\t*(write_pixels+$add+512*1024)=color;\n";
+			print THEFILE "\t}\n";
+		}
+
+		$b=$b >> 1;
+		$add=$add+1;
+	} until ($b == 0);
+	print THEFILE "\tbreak;\n";
+} 
+print THEFILE "}\n";
+
+
+close (THEFILE);
diff -Nur dosbox-0.74/scripts/font-switch.pl dosbox-0.74.patch/scripts/font-switch.pl
--- dosbox-0.74/scripts/font-switch.pl	1970-01-01 01:00:00.000000000 +0100
+++ dosbox-0.74.patch/scripts/font-switch.pl	2016-12-11 18:35:15.502284007 +0100
@@ -0,0 +1,25 @@
+#!/usr/bin/perl
+use integer;
+open (THEFILE,'>','../src/hardware/font-switch.h')
+	or die "Can't open my file $!";
+
+print THEFILE "switch (bit_mask) {\n";
+for ($i = 0; $i < 256; $i++) {
+	print THEFILE "\tcase $i:\n";
+	$b=128;
+	$add=0;
+	do  {
+		if ($i & $b) {
+			print THEFILE "\t\t*(draw+$add)=fg;\n";
+		} else {
+			print THEFILE "\t\t*(draw+$add)=bg;\n";
+		}
+		$b=$b >> 1;
+		$add=$add+1;
+	} until ($b == 0);
+	print THEFILE "\tbreak;\n";
+} 
+print THEFILE "}\n";
+
+
+close (THEFILE);
diff -Nur dosbox-0.74/scripts/resetconf.bat dosbox-0.74.patch/scripts/resetconf.bat
--- dosbox-0.74/scripts/resetconf.bat	1970-01-01 01:00:00.000000000 +0100
+++ dosbox-0.74.patch/scripts/resetconf.bat	2016-12-11 18:35:15.502284007 +0100
@@ -0,0 +1 @@
+DOSBox.exe -resetconf
\ Kein Zeilenumbruch am Dateiende.
diff -Nur dosbox-0.74/scripts/resetmapper.bat dosbox-0.74.patch/scripts/resetmapper.bat
--- dosbox-0.74/scripts/resetmapper.bat	1970-01-01 01:00:00.000000000 +0100
+++ dosbox-0.74.patch/scripts/resetmapper.bat	2016-12-11 18:35:15.502284007 +0100
@@ -0,0 +1 @@
+DOSBox.exe -resetmapper
\ Kein Zeilenumbruch am Dateiende.
diff -Nur dosbox-0.74/src/cpu/callback.cpp dosbox-0.74.patch/src/cpu/callback.cpp
--- dosbox-0.74/src/cpu/callback.cpp	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/cpu/callback.cpp	2016-12-11 18:35:15.502284007 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: callback.cpp,v 1.42 2009-08-23 17:24:54 c2woody Exp $ */
 
 #include <stdlib.h>
 #include <string.h>
@@ -46,7 +45,7 @@
 	for (Bitu i=1;(i<CB_MAX);i++) {
 		if (CallBack_Handlers[i]==&illegal_handler) {
 			CallBack_Handlers[i]=0;
-			return i;	
+			return i;
 		}
 	}
 	E_Exit("CALLBACK:Can't allocate handler.");
@@ -57,7 +56,7 @@
 	CallBack_Handlers[in]=&illegal_handler;
 }
 
-	
+
 void CALLBACK_Idle(void) {
 /* this makes the cpu execute instructions to handle irq's and then come back */
 	Bitu oldIF=GETFLAG(IF);
@@ -65,12 +64,12 @@
 	Bit16u oldcs=SegValue(cs);
 	Bit32u oldeip=reg_eip;
 	SegSet16(cs,CB_SEG);
-	reg_eip=call_idle*CB_SIZE;
+	reg_eip=CB_SOFFSET+call_idle*CB_SIZE;
 	DOSBOX_RunMachine();
 	reg_eip=oldeip;
 	SegSet16(cs,oldcs);
 	SETFLAGBIT(IF,oldIF);
-	if (!CPU_CycleAutoAdjust && CPU_Cycles>0) 
+	if (!CPU_CycleAutoAdjust && CPU_Cycles>0)
 		CPU_Cycles=0;
 }
 
@@ -109,24 +108,24 @@
 }
 
 void CALLBACK_SZF(bool val) {
-	Bit16u tempf = mem_readw(SegPhys(ss)+reg_sp+4); 
-	if (val) tempf |= FLAG_ZF; 
-	else tempf &= ~FLAG_ZF; 
-	mem_writew(SegPhys(ss)+reg_sp+4,tempf); 
+	Bit16u tempf = mem_readw(SegPhys(ss)+reg_sp+4);
+	if (val) tempf |= FLAG_ZF;
+	else tempf &= ~FLAG_ZF;
+	mem_writew(SegPhys(ss)+reg_sp+4,tempf);
 }
 
 void CALLBACK_SCF(bool val) {
-	Bit16u tempf = mem_readw(SegPhys(ss)+reg_sp+4); 
-	if (val) tempf |= FLAG_CF; 
-	else tempf &= ~FLAG_CF; 
-	mem_writew(SegPhys(ss)+reg_sp+4,tempf); 
+	Bit16u tempf = mem_readw(SegPhys(ss)+reg_sp+4);
+	if (val) tempf |= FLAG_CF;
+	else tempf &= ~FLAG_CF;
+	mem_writew(SegPhys(ss)+reg_sp+4,tempf);
 }
 
 void CALLBACK_SIF(bool val) {
-	Bit16u tempf = mem_readw(SegPhys(ss)+reg_sp+4); 
-	if (val) tempf |= FLAG_IF; 
-	else tempf &= ~FLAG_IF; 
-	mem_writew(SegPhys(ss)+reg_sp+4,tempf); 
+	Bit16u tempf = mem_readw(SegPhys(ss)+reg_sp+4);
+	if (val) tempf |= FLAG_IF;
+	else tempf &= ~FLAG_IF;
+	mem_writew(SegPhys(ss)+reg_sp+4,tempf);
 }
 
 void CALLBACK_SetDescription(Bitu nr, const char* descr) {
@@ -143,7 +142,7 @@
 }
 
 Bitu CALLBACK_SetupExtra(Bitu callback, Bitu type, PhysPt physAddress, bool use_cb=true) {
-	if (callback>=CB_MAX) 
+	if (callback>=CB_MAX)
 		return 0;
 	switch (type) {
 	case CB_RETN:
@@ -219,24 +218,25 @@
 		phys_writeb(physAddress+0x06,(Bit8u)0xcf);		//An IRET Instruction
 		return (use_cb?0x0b:0x07);
 	case CB_IRQ0:	// timer int8
+		phys_writeb(physAddress+0x00,(Bit8u)0xFB);		//STI
 		if (use_cb) {
-			phys_writeb(physAddress+0x00,(Bit8u)0xFE);	//GRP 4
-			phys_writeb(physAddress+0x01,(Bit8u)0x38);	//Extra Callback instruction
-			phys_writew(physAddress+0x02,(Bit16u)callback);		//The immediate word
+			phys_writeb(physAddress+0x01,(Bit8u)0xFE);	//GRP 4
+			phys_writeb(physAddress+0x02,(Bit8u)0x38);	//Extra Callback instruction
+			phys_writew(physAddress+0x03,(Bit16u)callback);		//The immediate word
 			physAddress+=4;
 		}
-		phys_writeb(physAddress+0x00,(Bit8u)0x50);		// push ax
-		phys_writeb(physAddress+0x01,(Bit8u)0x52);		// push dx
-		phys_writeb(physAddress+0x02,(Bit8u)0x1e);		// push ds
-		phys_writew(physAddress+0x03,(Bit16u)0x1ccd);	// int 1c
-		phys_writeb(physAddress+0x05,(Bit8u)0xfa);		// cli
-		phys_writeb(physAddress+0x06,(Bit8u)0x1f);		// pop ds
-		phys_writeb(physAddress+0x07,(Bit8u)0x5a);		// pop dx
-		phys_writew(physAddress+0x08,(Bit16u)0x20b0);	// mov al, 0x20
-		phys_writew(physAddress+0x0a,(Bit16u)0x20e6);	// out 0x20, al
+		phys_writeb(physAddress+0x01,(Bit8u)0x1e);		// push ds
+		phys_writeb(physAddress+0x02,(Bit8u)0x50);		// push ax
+		phys_writeb(physAddress+0x03,(Bit8u)0x52);		// push dx
+		phys_writew(physAddress+0x04,(Bit16u)0x1ccd);	// int 1c
+		phys_writeb(physAddress+0x06,(Bit8u)0xfa);		// cli
+		phys_writew(physAddress+0x07,(Bit16u)0x20b0);	// mov al, 0x20
+		phys_writew(physAddress+0x09,(Bit16u)0x20e6);	// out 0x20, al
+		phys_writeb(physAddress+0x0b,(Bit8u)0x5a);		// pop dx
 		phys_writeb(physAddress+0x0c,(Bit8u)0x58);		// pop ax
-		phys_writeb(physAddress+0x0d,(Bit8u)0xcf);		//An IRET Instruction
-		return (use_cb?0x12:0x0e);
+		phys_writeb(physAddress+0x0d,(Bit8u)0x1f);		// pop ds
+		phys_writeb(physAddress+0x0e,(Bit8u)0xcf);		//An IRET Instruction
+		return (use_cb?0x13:0x0f);
 	case CB_IRQ1:	// keyboard int9
 		phys_writeb(physAddress+0x00,(Bit8u)0x50);			// push ax
 		phys_writew(physAddress+0x01,(Bit16u)0x60e4);		// in al, 0x60
@@ -351,12 +351,16 @@
 			phys_writew(physAddress+0x02,(Bit16u)callback);		//The immediate word
 			physAddress+=4;
 		}
-		phys_writeb(physAddress+0x00,(Bit8u)0x50);		// push ax
-		phys_writew(physAddress+0x01,(Bit16u)0x0eb4);	// mov ah, 0x0e
-		phys_writew(physAddress+0x03,(Bit16u)0x10cd);	// int 10
-		phys_writeb(physAddress+0x05,(Bit8u)0x58);		// pop ax
-		phys_writeb(physAddress+0x06,(Bit8u)0xcf);		//An IRET Instruction
-		return (use_cb?0x0b:0x07);
+		phys_writeb(physAddress+0x00,(Bit8u)0x50);	// push ax
+		phys_writeb(physAddress+0x01,(Bit8u)0x53);	// push bx
+		phys_writew(physAddress+0x02,(Bit16u)0x0eb4);	// mov ah, 0x0e
+		phys_writeb(physAddress+0x04,(Bit8u)0xbb);	// mov bx,
+		phys_writew(physAddress+0x05,(Bit16u)0x0007);	// 0x0007
+		phys_writew(physAddress+0x07,(Bit16u)0x10cd);	// int 10
+		phys_writeb(physAddress+0x09,(Bit8u)0x5b);	// pop bx
+		phys_writeb(physAddress+0x0a,(Bit8u)0x58);	// pop ax
+		phys_writeb(physAddress+0x0b,(Bit8u)0xcf);	//An IRET Instruction
+		return (use_cb?0x10:0x0c);
 	case CB_HOOKABLE:
 		phys_writeb(physAddress+0x00,(Bit8u)0xEB);		//jump near
 		phys_writeb(physAddress+0x01,(Bit8u)0x03);		//offset
@@ -430,7 +434,18 @@
 		phys_writeb(physAddress+0x09,(Bit8u)0x59);		// pop cx
 		phys_writeb(physAddress+0x0A,(Bit8u)0xCF);		//An IRET Instruction
 		return (use_cb?15:11);
-
+	case CB_INT13:
+		phys_writeb(physAddress+0x00,(Bit8u)0xFB);		//STI
+		if (use_cb) {
+			phys_writeb(physAddress+0x01,(Bit8u)0xFE);	//GRP 4
+			phys_writeb(physAddress+0x02,(Bit8u)0x38);	//Extra Callback instruction
+			phys_writew(physAddress+0x03,(Bit16u)callback);	//The immediate word
+			physAddress+=4;
+		}
+		phys_writeb(physAddress+0x01,(Bit8u)0xCF);		//An IRET Instruction
+		phys_writew(physAddress+0x02,(Bit16u)0x0ECD);		// int 0e
+		phys_writeb(physAddress+0x04,(Bit8u)0xCF);		//An IRET Instruction
+		return (use_cb?9:5);
 	default:
 		E_Exit("CALLBACK:Setup:Illegal type %d",type);
 	}
@@ -456,19 +471,19 @@
 }
 
 void CALLBACK_RemoveSetup(Bitu callback) {
-	for (Bitu i = 0;i < 16;i++) {
+	for (Bitu i = 0;i < CB_SIZE;i++) {
 		phys_writeb(CALLBACK_PhysPointer(callback)+i ,(Bit8u) 0x00);
 	}
 }
 
-CALLBACK_HandlerObject::~CALLBACK_HandlerObject(){
+void CALLBACK_HandlerObject::Uninstall(){
 	if(!installed) return;
 	if(m_type == CALLBACK_HandlerObject::SETUP) {
 		if(vectorhandler.installed){
 			//See if we are the current handler. if so restore the old one
 			if(RealGetVec(vectorhandler.interrupt) == Get_RealPointer()) {
 				RealSetVec(vectorhandler.interrupt,vectorhandler.old_vector);
-			} else 
+			} else
 				LOG(LOG_MISC,LOG_WARN)("Interrupt vector changed on %X %s",vectorhandler.interrupt,CALLBACK_GetDescription(m_callback));
 		}
 		CALLBACK_RemoveSetup(m_callback);
@@ -480,6 +495,11 @@
 	if(CallBack_Description[m_callback]) delete [] CallBack_Description[m_callback];
 	CallBack_Description[m_callback] = 0;
 	CALLBACK_DeAllocate(m_callback);
+	installed=false;
+}
+
+CALLBACK_HandlerObject::~CALLBACK_HandlerObject(){
+	Uninstall();
 }
 
 void CALLBACK_HandlerObject::Install(CallBack_Handler handler,Bitu type,const char* description){
@@ -488,7 +508,7 @@
 		m_type=SETUP;
 		m_callback=CALLBACK_Allocate();
 		CALLBACK_Setup(m_callback,handler,type,description);
-	} else E_Exit("Allready installed");
+	} else E_Exit("Callback handler object already installed");
 }
 void CALLBACK_HandlerObject::Install(CallBack_Handler handler,Bitu type,PhysPt addr,const char* description){
 	if(!installed) {
@@ -496,7 +516,7 @@
 		m_type=SETUP;
 		m_callback=CALLBACK_Allocate();
 		CALLBACK_Setup(m_callback,handler,type,addr,description);
-	} else E_Exit("Allready installed");
+	} else E_Exit("Callback handler object already installed");
 }
 
 void CALLBACK_HandlerObject::Allocate(CallBack_Handler handler,const char* description) {
@@ -506,7 +526,7 @@
 		m_callback=CALLBACK_Allocate();
 		CALLBACK_SetDescription(m_callback,description);
 		CallBack_Handlers[m_callback]=handler;
-	} else E_Exit("Allready installed");
+	} else E_Exit("Callback handler object already installed");
 }
 
 void CALLBACK_HandlerObject::Set_RealVec(Bit8u vec){
@@ -545,7 +565,7 @@
 	CALLBACK_Setup(call_default,&default_handler,CB_IRET,"default");
 	call_default2=CALLBACK_Allocate();
 	CALLBACK_Setup(call_default2,&default_handler,CB_IRET,"default");
-   
+
 	/* Only setup default handler for first part of interrupt table */
 	for (Bit16u ct=0;ct<0x60;ct++) {
 		real_writed(0,ct*4,CALLBACK_RealPointer(call_default));
diff -Nur dosbox-0.74/src/cpu/core_dynrec/cache.h dosbox-0.74.patch/src/cpu/core_dynrec/cache.h
--- dosbox-0.74/src/cpu/core_dynrec/cache.h	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/cpu/core_dynrec/cache.h	2016-12-11 18:35:15.502284007 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -53,7 +53,7 @@
 		CacheBlockDynRec * to;		// this block can transfer control to the to-block
 		CacheBlockDynRec * next;
 		CacheBlockDynRec * from;	// the from-block can transfer control to this block
-	} link[2];	// maximal two links (conditional jumps)
+	} link[2];	// maximum two links (conditional jumps)
 	CacheBlockDynRec * crossblock;
 };
 
@@ -596,7 +596,7 @@
 			if(!cache_code_start_ptr) E_Exit("Allocating dynamic cache failed");
 
 			// align the cache at a page boundary
-			cache_code=(Bit8u*)(((long)cache_code_start_ptr + PAGESIZE_TEMP-1) & ~(PAGESIZE_TEMP-1)); //MEM LEAK. store old pointer if you want to free it.
+			cache_code=(Bit8u*)(((Bitu)cache_code_start_ptr + PAGESIZE_TEMP-1) & ~(PAGESIZE_TEMP-1));//Bitu is same size as a pointer.
 
 			cache_code_link_blocks=cache_code;
 			cache_code=cache_code+PAGESIZE_TEMP;
diff -Nur dosbox-0.74/src/cpu/core_dynrec/decoder_basic.h dosbox-0.74.patch/src/cpu/core_dynrec/decoder_basic.h
--- dosbox-0.74/src/cpu/core_dynrec/decoder_basic.h	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/cpu/core_dynrec/decoder_basic.h	2016-12-11 18:35:15.502284007 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: decoder_basic.h,v 1.16 2009-10-08 20:01:31 c2woody Exp $ */
 
 
 /*
@@ -491,7 +490,8 @@
 
 // set reg_eip to the start of the next instruction plus an offset (imm)
 static INLINE void dyn_set_eip_end(HostReg reg,Bit32u imm=0) {
-	gen_mov_word_to_reg(reg,&reg_eip,decode.big_op);
+	gen_mov_word_to_reg(reg,&reg_eip,true); //get_extend_word will mask off the upper bits
+	//gen_mov_word_to_reg(reg,&reg_eip,decode.big_op);
 	gen_add_imm(reg,(Bit32u)(decode.code-decode.code_start+imm));
 	if (!decode.big_op) gen_extend_word(false,reg);
 }
diff -Nur dosbox-0.74/src/cpu/core_dynrec/decoder.h dosbox-0.74.patch/src/cpu/core_dynrec/decoder.h
--- dosbox-0.74/src/cpu/core_dynrec/decoder.h	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/cpu/core_dynrec/decoder.h	2016-12-11 18:35:15.502284007 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: decoder.h,v 1.8 2009-10-18 17:52:10 c2woody Exp $ */
 
 
 #include "decoder_basic.h"
@@ -27,7 +26,7 @@
 
 /*
 	The function CreateCacheBlock translates the instruction stream
-	until either an unhandled instruction is found, the maximal
+	until either an unhandled instruction is found, the maximum
 	number of translated instructions is reached or some critical
 	instruction is encountered.
 */
@@ -242,7 +241,9 @@
 				case 0xbf:dyn_movx_ev_gw(true);break;
 
 				default:
-//					DYN_LOG("Unhandled dual opcode 0F%02X",dual_code);
+#if DYN_LOG
+//					LOG_MSG("Unhandled dual opcode 0F%02X",dual_code);
+#endif
 					goto illegalopcode;
 			}
 			break;
@@ -579,11 +580,13 @@
 			break;
 
 		default:
-//			DYN_LOG("Dynrec unhandled opcode %X",opcode);
+#if DYN_LOG
+//			LOG_MSG("Dynrec unhandled opcode %X",opcode);
+#endif
 			goto illegalopcode;
 		}
 	}
-	// link to next block because the maximal number of opcodes has been reached
+	// link to next block because the maximum number of opcodes has been reached
 	dyn_set_eip_end();
 	dyn_reduce_cycles();
 	gen_jmp_ptr(&decode.block->link[0].to,offsetof(CacheBlockDynRec,cache.start));
diff -Nur dosbox-0.74/src/cpu/core_dynrec/decoder_opcodes.h dosbox-0.74.patch/src/cpu/core_dynrec/decoder_opcodes.h
--- dosbox-0.74/src/cpu/core_dynrec/decoder_opcodes.h	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/cpu/core_dynrec/decoder_opcodes.h	2016-12-11 18:35:15.502284007 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: decoder_opcodes.h,v 1.10 2009-10-18 17:52:10 c2woody Exp $ */
 
 
 /*
diff -Nur dosbox-0.74/src/cpu/core_dynrec/dyn_fpu.h dosbox-0.74.patch/src/cpu/core_dynrec/dyn_fpu.h
--- dosbox-0.74/src/cpu/core_dynrec/dyn_fpu.h	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/cpu/core_dynrec/dyn_fpu.h	2016-12-11 18:35:15.502284007 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: dyn_fpu.h,v 1.8 2009-09-23 20:55:19 c2woody Exp $ */
 
 
 #include "dosbox.h"
@@ -535,7 +534,7 @@
 			gen_mov_word_to_reg(FC_OP1,(void*)(&TOP),true);
 			gen_call_function_R((void*)&FPU_SET_TOP,FC_OP1);
 			dyn_fill_ea(FC_OP1); 
-			gen_mov_word_to_reg(FC_OP2,(void*)(&fpu.sw),true);
+			gen_mov_word_to_reg(FC_OP2,(void*)(&fpu.sw),false);
 			gen_call_function_RR((void*)&mem_writew,FC_OP1,FC_OP2);
 			break;
 		default:
diff -Nur dosbox-0.74/src/cpu/core_dynrec/Makefile.am dosbox-0.74.patch/src/cpu/core_dynrec/Makefile.am
--- dosbox-0.74/src/cpu/core_dynrec/Makefile.am	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/cpu/core_dynrec/Makefile.am	2016-12-11 18:35:15.502284007 +0100
@@ -1,5 +1,5 @@
 noinst_HEADERS = cache.h decoder.h decoder_basic.h decoder_opcodes.h \
                  dyn_fpu.h operators.h risc_x64.h risc_x86.h risc_mipsel32.h \
                  risc_armv4le.h risc_armv4le-common.h \
-                 risc_armv4le-s3.h risc_armv4le-o3.h risc_armv4le-thumb.h \
+                 risc_armv4le-o3.h risc_armv4le-thumb.h \
                  risc_armv4le-thumb-iw.h risc_armv4le-thumb-niw.h
diff -Nur dosbox-0.74/src/cpu/core_dynrec/Makefile.in dosbox-0.74.patch/src/cpu/core_dynrec/Makefile.in
--- dosbox-0.74/src/cpu/core_dynrec/Makefile.in	2010-05-12 11:57:43.000000000 +0200
+++ dosbox-0.74.patch/src/cpu/core_dynrec/Makefile.in	1970-01-01 01:00:00.000000000 +0100
@@ -1,393 +0,0 @@
-# Makefile.in generated by automake 1.11.1 from Makefile.am.
-# @configure_input@
-
-# Copyright (C) 1994, 1995, 1996, 1997, 1998, 1999, 2000, 2001, 2002,
-# 2003, 2004, 2005, 2006, 2007, 2008, 2009  Free Software Foundation,
-# Inc.
-# This Makefile.in is free software; the Free Software Foundation
-# gives unlimited permission to copy and/or distribute it,
-# with or without modifications, as long as this notice is preserved.
-
-# This program is distributed in the hope that it will be useful,
-# but WITHOUT ANY WARRANTY, to the extent permitted by law; without
-# even the implied warranty of MERCHANTABILITY or FITNESS FOR A
-# PARTICULAR PURPOSE.
-
-@SET_MAKE@
-
-VPATH = @srcdir@
-pkgdatadir = $(datadir)/@PACKAGE@
-pkgincludedir = $(includedir)/@PACKAGE@
-pkglibdir = $(libdir)/@PACKAGE@
-pkglibexecdir = $(libexecdir)/@PACKAGE@
-am__cd = CDPATH="$${ZSH_VERSION+.}$(PATH_SEPARATOR)" && cd
-install_sh_DATA = $(install_sh) -c -m 644
-install_sh_PROGRAM = $(install_sh) -c
-install_sh_SCRIPT = $(install_sh) -c
-INSTALL_HEADER = $(INSTALL_DATA)
-transform = $(program_transform_name)
-NORMAL_INSTALL = :
-PRE_INSTALL = :
-POST_INSTALL = :
-NORMAL_UNINSTALL = :
-PRE_UNINSTALL = :
-POST_UNINSTALL = :
-build_triplet = @build@
-host_triplet = @host@
-subdir = src/cpu/core_dynrec
-DIST_COMMON = $(noinst_HEADERS) $(srcdir)/Makefile.am \
-	$(srcdir)/Makefile.in
-ACLOCAL_M4 = $(top_srcdir)/aclocal.m4
-am__aclocal_m4_deps = $(top_srcdir)/acinclude.m4 \
-	$(top_srcdir)/configure.in
-am__configure_deps = $(am__aclocal_m4_deps) $(CONFIGURE_DEPENDENCIES) \
-	$(ACLOCAL_M4)
-mkinstalldirs = $(install_sh) -d
-CONFIG_HEADER = $(top_builddir)/config.h
-CONFIG_CLEAN_FILES =
-CONFIG_CLEAN_VPATH_FILES =
-SOURCES =
-DIST_SOURCES =
-HEADERS = $(noinst_HEADERS)
-ETAGS = etags
-CTAGS = ctags
-DISTFILES = $(DIST_COMMON) $(DIST_SOURCES) $(TEXINFOS) $(EXTRA_DIST)
-ACLOCAL = @ACLOCAL@
-ALSA_CFLAGS = @ALSA_CFLAGS@
-ALSA_LIBS = @ALSA_LIBS@
-AMTAR = @AMTAR@
-AUTOCONF = @AUTOCONF@
-AUTOHEADER = @AUTOHEADER@
-AUTOMAKE = @AUTOMAKE@
-AWK = @AWK@
-CC = @CC@
-CCDEPMODE = @CCDEPMODE@
-CFLAGS = @CFLAGS@
-CPP = @CPP@
-CPPFLAGS = @CPPFLAGS@
-CXX = @CXX@
-CXXDEPMODE = @CXXDEPMODE@
-CXXFLAGS = @CXXFLAGS@
-CYGPATH_W = @CYGPATH_W@
-DEFS = @DEFS@
-DEPDIR = @DEPDIR@
-ECHO_C = @ECHO_C@
-ECHO_N = @ECHO_N@
-ECHO_T = @ECHO_T@
-EGREP = @EGREP@
-EXEEXT = @EXEEXT@
-GREP = @GREP@
-INSTALL = @INSTALL@
-INSTALL_DATA = @INSTALL_DATA@
-INSTALL_PROGRAM = @INSTALL_PROGRAM@
-INSTALL_SCRIPT = @INSTALL_SCRIPT@
-INSTALL_STRIP_PROGRAM = @INSTALL_STRIP_PROGRAM@
-LDFLAGS = @LDFLAGS@
-LIBOBJS = @LIBOBJS@
-LIBS = @LIBS@
-LTLIBOBJS = @LTLIBOBJS@
-MAKEINFO = @MAKEINFO@
-MKDIR_P = @MKDIR_P@
-OBJEXT = @OBJEXT@
-PACKAGE = @PACKAGE@
-PACKAGE_BUGREPORT = @PACKAGE_BUGREPORT@
-PACKAGE_NAME = @PACKAGE_NAME@
-PACKAGE_STRING = @PACKAGE_STRING@
-PACKAGE_TARNAME = @PACKAGE_TARNAME@
-PACKAGE_URL = @PACKAGE_URL@
-PACKAGE_VERSION = @PACKAGE_VERSION@
-PATH_SEPARATOR = @PATH_SEPARATOR@
-RANLIB = @RANLIB@
-SDL_CFLAGS = @SDL_CFLAGS@
-SDL_CONFIG = @SDL_CONFIG@
-SDL_LIBS = @SDL_LIBS@
-SET_MAKE = @SET_MAKE@
-SHELL = @SHELL@
-STRIP = @STRIP@
-VERSION = @VERSION@
-WINDRES = @WINDRES@
-abs_builddir = @abs_builddir@
-abs_srcdir = @abs_srcdir@
-abs_top_builddir = @abs_top_builddir@
-abs_top_srcdir = @abs_top_srcdir@
-ac_ct_CC = @ac_ct_CC@
-ac_ct_CXX = @ac_ct_CXX@
-am__include = @am__include@
-am__leading_dot = @am__leading_dot@
-am__quote = @am__quote@
-am__tar = @am__tar@
-am__untar = @am__untar@
-bindir = @bindir@
-build = @build@
-build_alias = @build_alias@
-build_cpu = @build_cpu@
-build_os = @build_os@
-build_vendor = @build_vendor@
-builddir = @builddir@
-datadir = @datadir@
-datarootdir = @datarootdir@
-docdir = @docdir@
-dvidir = @dvidir@
-exec_prefix = @exec_prefix@
-host = @host@
-host_alias = @host_alias@
-host_cpu = @host_cpu@
-host_os = @host_os@
-host_vendor = @host_vendor@
-htmldir = @htmldir@
-includedir = @includedir@
-infodir = @infodir@
-install_sh = @install_sh@
-libdir = @libdir@
-libexecdir = @libexecdir@
-localedir = @localedir@
-localstatedir = @localstatedir@
-mandir = @mandir@
-mkdir_p = @mkdir_p@
-oldincludedir = @oldincludedir@
-pdfdir = @pdfdir@
-prefix = @prefix@
-program_transform_name = @program_transform_name@
-psdir = @psdir@
-sbindir = @sbindir@
-sharedstatedir = @sharedstatedir@
-srcdir = @srcdir@
-sysconfdir = @sysconfdir@
-target_alias = @target_alias@
-top_build_prefix = @top_build_prefix@
-top_builddir = @top_builddir@
-top_srcdir = @top_srcdir@
-noinst_HEADERS = cache.h decoder.h decoder_basic.h decoder_opcodes.h \
-                 dyn_fpu.h operators.h risc_x64.h risc_x86.h risc_mipsel32.h \
-                 risc_armv4le.h risc_armv4le-common.h \
-                 risc_armv4le-s3.h risc_armv4le-o3.h risc_armv4le-thumb.h \
-                 risc_armv4le-thumb-iw.h risc_armv4le-thumb-niw.h
-
-all: all-am
-
-.SUFFIXES:
-$(srcdir)/Makefile.in:  $(srcdir)/Makefile.am  $(am__configure_deps)
-	@for dep in $?; do \
-	  case '$(am__configure_deps)' in \
-	    *$$dep*) \
-	      ( cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh ) \
-	        && { if test -f $@; then exit 0; else break; fi; }; \
-	      exit 1;; \
-	  esac; \
-	done; \
-	echo ' cd $(top_srcdir) && $(AUTOMAKE) --gnu src/cpu/core_dynrec/Makefile'; \
-	$(am__cd) $(top_srcdir) && \
-	  $(AUTOMAKE) --gnu src/cpu/core_dynrec/Makefile
-.PRECIOUS: Makefile
-Makefile: $(srcdir)/Makefile.in $(top_builddir)/config.status
-	@case '$?' in \
-	  *config.status*) \
-	    cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh;; \
-	  *) \
-	    echo ' cd $(top_builddir) && $(SHELL) ./config.status $(subdir)/$@ $(am__depfiles_maybe)'; \
-	    cd $(top_builddir) && $(SHELL) ./config.status $(subdir)/$@ $(am__depfiles_maybe);; \
-	esac;
-
-$(top_builddir)/config.status: $(top_srcdir)/configure $(CONFIG_STATUS_DEPENDENCIES)
-	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
-
-$(top_srcdir)/configure:  $(am__configure_deps)
-	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
-$(ACLOCAL_M4):  $(am__aclocal_m4_deps)
-	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
-$(am__aclocal_m4_deps):
-
-ID: $(HEADERS) $(SOURCES) $(LISP) $(TAGS_FILES)
-	list='$(SOURCES) $(HEADERS) $(LISP) $(TAGS_FILES)'; \
-	unique=`for i in $$list; do \
-	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
-	  done | \
-	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
-	      END { if (nonempty) { for (i in files) print i; }; }'`; \
-	mkid -fID $$unique
-tags: TAGS
-
-TAGS:  $(HEADERS) $(SOURCES)  $(TAGS_DEPENDENCIES) \
-		$(TAGS_FILES) $(LISP)
-	set x; \
-	here=`pwd`; \
-	list='$(SOURCES) $(HEADERS)  $(LISP) $(TAGS_FILES)'; \
-	unique=`for i in $$list; do \
-	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
-	  done | \
-	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
-	      END { if (nonempty) { for (i in files) print i; }; }'`; \
-	shift; \
-	if test -z "$(ETAGS_ARGS)$$*$$unique"; then :; else \
-	  test -n "$$unique" || unique=$$empty_fix; \
-	  if test $$# -gt 0; then \
-	    $(ETAGS) $(ETAGSFLAGS) $(AM_ETAGSFLAGS) $(ETAGS_ARGS) \
-	      "$$@" $$unique; \
-	  else \
-	    $(ETAGS) $(ETAGSFLAGS) $(AM_ETAGSFLAGS) $(ETAGS_ARGS) \
-	      $$unique; \
-	  fi; \
-	fi
-ctags: CTAGS
-CTAGS:  $(HEADERS) $(SOURCES)  $(TAGS_DEPENDENCIES) \
-		$(TAGS_FILES) $(LISP)
-	list='$(SOURCES) $(HEADERS)  $(LISP) $(TAGS_FILES)'; \
-	unique=`for i in $$list; do \
-	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
-	  done | \
-	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
-	      END { if (nonempty) { for (i in files) print i; }; }'`; \
-	test -z "$(CTAGS_ARGS)$$unique" \
-	  || $(CTAGS) $(CTAGSFLAGS) $(AM_CTAGSFLAGS) $(CTAGS_ARGS) \
-	     $$unique
-
-GTAGS:
-	here=`$(am__cd) $(top_builddir) && pwd` \
-	  && $(am__cd) $(top_srcdir) \
-	  && gtags -i $(GTAGS_ARGS) "$$here"
-
-distclean-tags:
-	-rm -f TAGS ID GTAGS GRTAGS GSYMS GPATH tags
-
-distdir: $(DISTFILES)
-	@srcdirstrip=`echo "$(srcdir)" | sed 's/[].[^$$\\*]/\\\\&/g'`; \
-	topsrcdirstrip=`echo "$(top_srcdir)" | sed 's/[].[^$$\\*]/\\\\&/g'`; \
-	list='$(DISTFILES)'; \
-	  dist_files=`for file in $$list; do echo $$file; done | \
-	  sed -e "s|^$$srcdirstrip/||;t" \
-	      -e "s|^$$topsrcdirstrip/|$(top_builddir)/|;t"`; \
-	case $$dist_files in \
-	  */*) $(MKDIR_P) `echo "$$dist_files" | \
-			   sed '/\//!d;s|^|$(distdir)/|;s,/[^/]*$$,,' | \
-			   sort -u` ;; \
-	esac; \
-	for file in $$dist_files; do \
-	  if test -f $$file || test -d $$file; then d=.; else d=$(srcdir); fi; \
-	  if test -d $$d/$$file; then \
-	    dir=`echo "/$$file" | sed -e 's,/[^/]*$$,,'`; \
-	    if test -d "$(distdir)/$$file"; then \
-	      find "$(distdir)/$$file" -type d ! -perm -700 -exec chmod u+rwx {} \;; \
-	    fi; \
-	    if test -d $(srcdir)/$$file && test $$d != $(srcdir); then \
-	      cp -fpR $(srcdir)/$$file "$(distdir)$$dir" || exit 1; \
-	      find "$(distdir)/$$file" -type d ! -perm -700 -exec chmod u+rwx {} \;; \
-	    fi; \
-	    cp -fpR $$d/$$file "$(distdir)$$dir" || exit 1; \
-	  else \
-	    test -f "$(distdir)/$$file" \
-	    || cp -p $$d/$$file "$(distdir)/$$file" \
-	    || exit 1; \
-	  fi; \
-	done
-check-am: all-am
-check: check-am
-all-am: Makefile $(HEADERS)
-installdirs:
-install: install-am
-install-exec: install-exec-am
-install-data: install-data-am
-uninstall: uninstall-am
-
-install-am: all-am
-	@$(MAKE) $(AM_MAKEFLAGS) install-exec-am install-data-am
-
-installcheck: installcheck-am
-install-strip:
-	$(MAKE) $(AM_MAKEFLAGS) INSTALL_PROGRAM="$(INSTALL_STRIP_PROGRAM)" \
-	  install_sh_PROGRAM="$(INSTALL_STRIP_PROGRAM)" INSTALL_STRIP_FLAG=-s \
-	  `test -z '$(STRIP)' || \
-	    echo "INSTALL_PROGRAM_ENV=STRIPPROG='$(STRIP)'"` install
-mostlyclean-generic:
-
-clean-generic:
-
-distclean-generic:
-	-test -z "$(CONFIG_CLEAN_FILES)" || rm -f $(CONFIG_CLEAN_FILES)
-	-test . = "$(srcdir)" || test -z "$(CONFIG_CLEAN_VPATH_FILES)" || rm -f $(CONFIG_CLEAN_VPATH_FILES)
-
-maintainer-clean-generic:
-	@echo "This command is intended for maintainers to use"
-	@echo "it deletes files that may require special tools to rebuild."
-clean: clean-am
-
-clean-am: clean-generic mostlyclean-am
-
-distclean: distclean-am
-	-rm -f Makefile
-distclean-am: clean-am distclean-generic distclean-tags
-
-dvi: dvi-am
-
-dvi-am:
-
-html: html-am
-
-html-am:
-
-info: info-am
-
-info-am:
-
-install-data-am:
-
-install-dvi: install-dvi-am
-
-install-dvi-am:
-
-install-exec-am:
-
-install-html: install-html-am
-
-install-html-am:
-
-install-info: install-info-am
-
-install-info-am:
-
-install-man:
-
-install-pdf: install-pdf-am
-
-install-pdf-am:
-
-install-ps: install-ps-am
-
-install-ps-am:
-
-installcheck-am:
-
-maintainer-clean: maintainer-clean-am
-	-rm -f Makefile
-maintainer-clean-am: distclean-am maintainer-clean-generic
-
-mostlyclean: mostlyclean-am
-
-mostlyclean-am: mostlyclean-generic
-
-pdf: pdf-am
-
-pdf-am:
-
-ps: ps-am
-
-ps-am:
-
-uninstall-am:
-
-.MAKE: install-am install-strip
-
-.PHONY: CTAGS GTAGS all all-am check check-am clean clean-generic \
-	ctags distclean distclean-generic distclean-tags distdir dvi \
-	dvi-am html html-am info info-am install install-am \
-	install-data install-data-am install-dvi install-dvi-am \
-	install-exec install-exec-am install-html install-html-am \
-	install-info install-info-am install-man install-pdf \
-	install-pdf-am install-ps install-ps-am install-strip \
-	installcheck installcheck-am installdirs maintainer-clean \
-	maintainer-clean-generic mostlyclean mostlyclean-generic pdf \
-	pdf-am ps ps-am tags uninstall uninstall-am
-
-
-# Tell versions [3.59,3.63) of GNU make to not export all variables.
-# Otherwise a system limit (for SysV at least) may be exceeded.
-.NOEXPORT:
diff -Nur dosbox-0.74/src/cpu/core_dynrec/operators.h dosbox-0.74.patch/src/cpu/core_dynrec/operators.h
--- dosbox-0.74/src/cpu/core_dynrec/operators.h	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/cpu/core_dynrec/operators.h	2016-12-11 18:35:15.506284007 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: operators.h,v 1.8 2009-06-25 19:31:43 c2woody Exp $ */
 
 
 static Bit8u DRC_CALL_CONV dynrec_add_byte(Bit8u op1,Bit8u op2) DRC_FC;
diff -Nur dosbox-0.74/src/cpu/core_dynrec/risc_armv4le-common.h dosbox-0.74.patch/src/cpu/core_dynrec/risc_armv4le-common.h
--- dosbox-0.74/src/cpu/core_dynrec/risc_armv4le-common.h	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/cpu/core_dynrec/risc_armv4le-common.h	2016-12-11 18:35:15.506284007 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: risc_armv4le-common.h,v 1.3 2009-05-16 21:52:47 c2woody Exp $ */
 
 
 /* ARMv4 (little endian) backend by M-HT (common data/functions) */
diff -Nur dosbox-0.74/src/cpu/core_dynrec/risc_armv4le.h dosbox-0.74.patch/src/cpu/core_dynrec/risc_armv4le.h
--- dosbox-0.74/src/cpu/core_dynrec/risc_armv4le.h	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/cpu/core_dynrec/risc_armv4le.h	2016-12-11 18:35:15.506284007 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,16 +16,21 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: risc_armv4le.h,v 1.3 2009-05-27 09:15:41 qbix79 Exp $ */
 
 
-/* ARMv4 (little endian) backend (switcher) by M-HT */
+/* ARMv4/ARMv7 (little endian) backend (switcher) by M-HT */
 
 #include "risc_armv4le-common.h"
 
 // choose your destiny:
-#include "risc_armv4le-thumb-niw.h"
-//#include "risc_armv4le-thumb-iw.h"
-//#include "risc_armv4le-thumb.h"
-//#include "risc_armv4le-s3.h"
-//#include "risc_armv4le-o3.h"
+#if C_TARGETCPU == ARMV7LE
+	#include "risc_armv4le-o3.h"
+#else
+	#if defined(__THUMB_INTERWORK__)
+		#include "risc_armv4le-thumb-iw.h"
+	#else
+		#include "risc_armv4le-o3.h"
+//		#include "risc_armv4le-thumb-niw.h"
+//		#include "risc_armv4le-thumb.h"
+	#endif
+#endif
diff -Nur dosbox-0.74/src/cpu/core_dynrec/risc_armv4le-o3.h dosbox-0.74.patch/src/cpu/core_dynrec/risc_armv4le-o3.h
--- dosbox-0.74/src/cpu/core_dynrec/risc_armv4le-o3.h	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/cpu/core_dynrec/risc_armv4le-o3.h	2016-12-11 18:35:15.506284007 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,10 +16,9 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: risc_armv4le-o3.h,v 1.6 2009-06-27 12:51:10 c2woody Exp $ */
 
 
-/* ARMv4 (little endian) backend by M-HT (size-tweaked arm version) */
+/* ARMv4/ARMv7 (little endian) backend by M-HT (arm version) */
 
 
 // temporary registers
@@ -51,15 +50,14 @@
 // temporary register for LEA
 #define TEMP_REG_DRC HOST_v2
 
-#ifdef DRC_USE_REGS_ADDR
 // used to hold the address of "cpu_regs" - preferably filled in function gen_run_code
 #define FC_REGS_ADDR HOST_v7
-#endif
 
-#ifdef DRC_USE_SEGS_ADDR
 // used to hold the address of "Segs" - preferably filled in function gen_run_code
 #define FC_SEGS_ADDR HOST_v8
-#endif
+
+// used to hold the address of "core_dynrec.readdata" - filled in function gen_run_code
+#define readdata_addr HOST_v5
 
 
 // helper macro
@@ -89,6 +87,12 @@
 #define MOV_REG_ROR_REG(dst, src, rreg) (0xe1a00070 + ((dst) << 12) + (src) + ((rreg) << 8) )
 // mvn dst, #(imm ror rimm)		@	0 <= imm <= 255	&	rimm mod 2 = 0
 #define MVN_IMM(dst, imm, rimm) (0xe3e00000 + ((dst) << 12) + (imm) + ((rimm) << 7) )
+#if C_TARGETCPU == ARMV7LE
+// movw dst, #imm		@	0 <= imm <= 65535
+#define MOVW(dst, imm) (0xe3000000 + ((dst) << 12) + (((imm) & 0xf000) << 4) + ((imm) & 0x0fff) )
+// movt dst, #imm		@	0 <= imm <= 65535
+#define MOVT(dst, imm) (0xe3400000 + ((dst) << 12) + (((imm) & 0xf000) << 4) + ((imm) & 0x0fff) )
+#endif
 
 // arithmetic
 // add dst, src, #(imm ror rimm)		@	0 <= imm <= 255	&	rimm mod 2 = 0
@@ -104,7 +108,11 @@
 // cmp src, #(imm ror rimm)		@	0 <= imm <= 255	&	rimm mod 2 = 0
 #define CMP_IMM(src, imm, rimm) (0xe3500000 + ((src) << 16) + (imm) + ((rimm) << 7) )
 // nop
+#if C_TARGETCPU == ARMV7LE
+#define NOP (0xe320f000)
+#else
 #define NOP MOV_REG_LSL_IMM(HOST_r0, HOST_r0, 0)
+#endif
 
 // logical
 // tst src, #(imm ror rimm)		@	0 <= imm <= 255	&	rimm mod 2 = 0
@@ -123,34 +131,70 @@
 #define EOR_REG_LSL_IMM(dst, src1, src2, imm) (0xe0200000 + ((dst) << 12) + ((src1) << 16) + (src2) + ((imm) << 7) )
 // bic dst, src, #(imm ror rimm)		@	0 <= imm <= 255	&	rimm mod 2 = 0
 #define BIC_IMM(dst, src, imm, rimm) (0xe3c00000 + ((dst) << 12) + ((src) << 16) + (imm) + ((rimm) << 7) )
+// bic dst, src1, src2, lsl #imm		@	0 <= imm <= 31
+#define BIC_REG_LSL_IMM(dst, src1, src2, imm) (0xe1c00000 + ((dst) << 12) + ((src1) << 16) + (src2) + ((imm) << 7) )
 
 // load
 // ldr reg, [addr, #imm]		@	0 <= imm < 4096
 #define LDR_IMM(reg, addr, imm) (0xe5900000 + ((reg) << 12) + ((addr) << 16) + (imm) )
+// ldr reg, [addr, #-(imm)]		@	0 <= imm < 4096
+#define LDR_IMM_M(reg, addr, imm) (0xe5100000 + ((reg) << 12) + ((addr) << 16) + (imm) )
 // ldrh reg, [addr, #imm]		@	0 <= imm < 256
 #define LDRH_IMM(reg, addr, imm) (0xe1d000b0 + ((reg) << 12) + ((addr) << 16) + (((imm) & 0xf0) << 4) + ((imm) & 0x0f) )
+// ldrh reg, [addr, #-(imm)]		@	0 <= imm < 256
+#define LDRH_IMM_M(reg, addr, imm) (0xe15000b0 + ((reg) << 12) + ((addr) << 16) + (((imm) & 0xf0) << 4) + ((imm) & 0x0f) )
 // ldrb reg, [addr, #imm]		@	0 <= imm < 4096
 #define LDRB_IMM(reg, addr, imm) (0xe5d00000 + ((reg) << 12) + ((addr) << 16) + (imm) )
+// ldrb reg, [addr, #-(imm)]		@	0 <= imm < 4096
+#define LDRB_IMM_M(reg, addr, imm) (0xe5500000 + ((reg) << 12) + ((addr) << 16) + (imm) )
+// ldr reg, [addr1, addr2, lsl #imm]		@	0 <= imm < 31
+#define LDR_REG_LSL_IMM(reg, addr1, addr2, imm) (0xe7900000 + ((reg) << 12) + ((addr1) << 16) + (addr2) + ((imm) << 7) )
 
 // store
 // str reg, [addr, #imm]		@	0 <= imm < 4096
 #define STR_IMM(reg, addr, imm) (0xe5800000 + ((reg) << 12) + ((addr) << 16) + (imm) )
+// str reg, [addr, #-(imm)]		@	0 <= imm < 4096
+#define STR_IMM_M(reg, addr, imm) (0xe5000000 + ((reg) << 12) + ((addr) << 16) + (imm) )
 // strh reg, [addr, #imm]		@	0 <= imm < 256
 #define STRH_IMM(reg, addr, imm) (0xe1c000b0 + ((reg) << 12) + ((addr) << 16) + (((imm) & 0xf0) << 4) + ((imm) & 0x0f) )
+// strh reg, [addr, #-(imm)]		@	0 <= imm < 256
+#define STRH_IMM_M(reg, addr, imm) (0xe14000b0 + ((reg) << 12) + ((addr) << 16) + (((imm) & 0xf0) << 4) + ((imm) & 0x0f) )
 // strb reg, [addr, #imm]		@	0 <= imm < 4096
 #define STRB_IMM(reg, addr, imm) (0xe5c00000 + ((reg) << 12) + ((addr) << 16) + (imm) )
+// strb reg, [addr, #-(imm)]		@	0 <= imm < 4096
+#define STRB_IMM_M(reg, addr, imm) (0xe5400000 + ((reg) << 12) + ((addr) << 16) + (imm) )
 
 // branch
 // beq pc+imm		@	0 <= imm < 32M	&	imm mod 4 = 0
 #define BEQ_FWD(imm) (0x0a000000 + ((imm) >> 2) )
 // bne pc+imm		@	0 <= imm < 32M	&	imm mod 4 = 0
 #define BNE_FWD(imm) (0x1a000000 + ((imm) >> 2) )
-// bgt pc+imm		@	0 <= imm < 32M	&	imm mod 4 = 0
-#define BGT_FWD(imm) (0xca000000 + ((imm) >> 2) )
+// ble pc+imm		@	0 <= imm < 32M	&	imm mod 4 = 0
+#define BLE_FWD(imm) (0xda000000 + ((imm) >> 2) )
 // b pc+imm		@	0 <= imm < 32M	&	imm mod 4 = 0
 #define B_FWD(imm) (0xea000000 + ((imm) >> 2) )
 // bx reg
 #define BX(reg) (0xe12fff10 + (reg) )
+#if C_TARGETCPU == ARMV7LE
+// blx reg
+#define BLX_REG(reg) (0xe12fff30 + (reg) )
+
+// extend
+// sxth dst, src, ror #rimm		@	rimm = 0 | 8 | 16 | 24
+#define SXTH(dst, src, rimm) (0xe6bf0070 + ((dst) << 12) + (src) + (((rimm) & 24) << 7) )
+// sxtb dst, src, ror #rimm		@	rimm = 0 | 8 | 16 | 24
+#define SXTB(dst, src, rimm) (0xe6af0070 + ((dst) << 12) + (src) + (((rimm) & 24) << 7) )
+// uxth dst, src, ror #rimm		@	rimm = 0 | 8 | 16 | 24
+#define UXTH(dst, src, rimm) (0xe6ff0070 + ((dst) << 12) + (src) + (((rimm) & 24) << 7) )
+// uxtb dst, src, ror #rimm		@	rimm = 0 | 8 | 16 | 24
+#define UXTB(dst, src, rimm) (0xe6ef0070 + ((dst) << 12) + (src) + (((rimm) & 24) << 7) )
+
+// bit field
+// bfi dst, src, #lsb, #width		@	lsb >= 0, width >= 1, lsb+width <= 32
+#define BFI(dst, src, lsb, width) (0xe7c00010 + ((dst) << 12) + (src) + ((lsb) << 7) + (((lsb) + (width) - 1) << 16) )
+// bfc dst, #lsb, #width		@	lsb >= 0, width >= 1, lsb+width <= 32
+#define BFC(dst, lsb, width) (0xe7c0001f + ((dst) << 12) + ((lsb) << 7) + (((lsb) + (width) - 1) << 16) )
+#endif
 
 
 // move a full register from reg_src to reg_dst
@@ -160,6 +204,28 @@
 }
 
 // helper function
+static bool val_is_operand2(Bit32u value, Bit32u *val_shift) {
+	Bit32u shift;
+
+	if (GCC_UNLIKELY(value == 0)) {
+		*val_shift = 0;
+		return true;
+	}
+
+	shift = 0;
+	while ((value & 3) == 0) {
+		value>>=2;
+		shift+=2;
+	}
+
+	if ((value >> 8) != 0) return false;
+
+	*val_shift = shift;
+	return true;
+}
+
+#if C_TARGETCPU != ARMV7LE
+// helper function
 static Bits get_imm_gen_len(Bit32u imm) {
 	Bits ret;
 	if (imm == 0) {
@@ -178,79 +244,44 @@
 }
 
 // helper function
-static Bits get_method_imm_gen_len(Bit32u imm, Bits preffer00, Bits *num) {
-	Bits num00, num15, numadd, numsub, numret, ret;
-	num00 = get_imm_gen_len(imm);
-	num15 = get_imm_gen_len(~imm);
-	numadd = get_imm_gen_len(imm - ((Bit32u)cache.pos+8));
-	numsub = get_imm_gen_len(((Bit32u)cache.pos+8) - imm);
-	if (numsub < numadd && numsub < num00 && numsub < num15) {
-		ret = 0;
-		numret = numsub;
-	} else if (numadd < num00 && numadd < num15) {
-		ret = 1;
-		numret = numadd;
-	} else if (num00 < num15 || (num00 == num15 && preffer00)) {
-		ret = 2;
-		numret = num00;
-	} else {
-		ret = 3;
-		numret = num15;
-	}
-	if (num != NULL) *num = numret;
-	return ret;
+static Bits get_min_imm_gen_len(Bit32u imm) {
+	Bits num1, num2;
+
+	num1 = get_imm_gen_len(imm);
+	num2 = get_imm_gen_len(~imm);
+
+	return (num1 <= num2)?num1:num2;
 }
+#endif
 
 // move a 32bit constant value into dest_reg
 static void gen_mov_dword_to_reg_imm(HostReg dest_reg,Bit32u imm) {
-	Bits first, method, scale;
-	Bit32u imm2, dist;
-	if (imm == 0) {
-		cache_addd( MOV_IMM(dest_reg, 0, 0) );      // mov dest_reg, #0
-	} else if (imm == 0xffffffff) {
-		cache_addd( MVN_IMM(dest_reg, 0, 0) );      // mvn dest_reg, #0
+#if C_TARGETCPU == ARMV7LE
+	Bit32u scale;
+
+	if ( val_is_operand2(imm, &scale) ) {
+		cache_addd( MOV_IMM(dest_reg, imm >> scale, ROTATE_SCALE(scale)) );      // mov dest_reg, #imm
+	} else if ( val_is_operand2(~imm, &scale) ) {
+		cache_addd( MVN_IMM(dest_reg, (~imm) >> scale, ROTATE_SCALE(scale)) );      // mvn dest_reg, #~imm
 	} else {
-		method = get_method_imm_gen_len(imm, 1, NULL);
+		cache_addd( MOVW(dest_reg, imm & 0xffff) );      // movw dest_reg, #(imm & 0xffff)
 
-		scale = 0;
-		first = 1;
-		if (method == 0) {
-			dist = ((Bit32u)cache.pos+8) - imm;
-			while (dist) {
-				while ((dist & 3) == 0) {
-					dist>>=2;
-					scale+=2;
-				}
-				if (first) {
-					cache_addd( SUB_IMM(dest_reg, HOST_pc, dist & 0xff, ROTATE_SCALE(scale)) );      // sub dest_reg, pc, #((dist & 0xff) << scale)
-					first = 0;
-				} else {
-					cache_addd( SUB_IMM(dest_reg, dest_reg, dist & 0xff, ROTATE_SCALE(scale)) );      // sub dest_reg, dest_reg, #((dist & 0xff) << scale)
-				}
-				dist>>=8;
-				scale+=8;
-			}
-		} else if (method == 1) {
-			dist = imm - ((Bit32u)cache.pos+8);
-			if (dist == 0) {
-				cache_addd( MOV_REG_LSL_IMM(dest_reg, HOST_pc, 0) );      // mov dest_reg, pc
-			} else {
-				while (dist) {
-					while ((dist & 3) == 0) {
-						dist>>=2;
-						scale+=2;
-					}
-					if (first) {
-						cache_addd( ADD_IMM(dest_reg, HOST_pc, dist & 0xff, ROTATE_SCALE(scale)) );      // add dest_reg, pc, #((dist & 0xff) << scale)
-						first = 0;
-					} else {
-						cache_addd( ADD_IMM(dest_reg, dest_reg, dist & 0xff, ROTATE_SCALE(scale)) );      // add dest_reg, dest_reg, #((dist & 0xff) << scale)
-					}
-					dist>>=8;
-					scale+=8;
-				}
-			}
-		} else if (method == 2) {
+		if (imm >= 0x10000)
+		{
+			cache_addd( MOVT(dest_reg, imm >> 16) );      // movt dest_reg, #(imm >> 16)
+		}
+	}
+#else
+	Bit32u imm2, first, scale;
+
+	scale = 0;
+	first = 1;
+	imm2 = ~imm;
+
+	if (get_imm_gen_len(imm) <= get_imm_gen_len(imm2)) {
+		if (imm == 0) {
+			cache_addd( MOV_IMM(dest_reg, 0, 0) );      // mov dest_reg, #0
+		} else {
 			while (imm) {
 				while ((imm & 3) == 0) {
 					imm>>=2;
@@ -265,8 +296,11 @@
 				imm>>=8;
 				scale+=8;
 			}
+		}
+	} else {
+		if (imm2 == 0) {
+			cache_addd( MVN_IMM(dest_reg, 0, 0) );      // mvn dest_reg, #0
 		} else {
-			imm2 = ~imm;
 			while (imm2) {
 				while ((imm2 & 3) == 0) {
 					imm2>>=2;
@@ -283,12 +317,67 @@
 			}
 		}
 	}
+#endif
+}
+
+// helper function
+static bool gen_mov_memval_to_reg_helper(HostReg dest_reg, Bit32u data, Bitu size, HostReg addr_reg, Bit32u addr_data) {
+	switch (size) {
+		case 4:
+#if !(defined(C_UNALIGNED_MEMORY) || (C_TARGETCPU == ARMV7LE))
+			if ((data & 3) == 0)
+#endif
+			{
+				if ((data >= addr_data) && (data < addr_data + 4096)) {
+					cache_addd( LDR_IMM(dest_reg, addr_reg, data - addr_data) );      // ldr dest_reg, [addr_reg, #(data - addr_data)]
+					return true;
+				} else if ((data < addr_data) && (data > addr_data - 4096)) {
+					cache_addd( LDR_IMM_M(dest_reg, addr_reg, addr_data - data) );      // ldr dest_reg, [addr_reg, #-(addr_data - data)]
+					return true;
+				}
+			}
+			break;
+		case 2:
+#if !(defined(C_UNALIGNED_MEMORY) || (C_TARGETCPU == ARMV7LE))
+			if ((data & 1) == 0)
+#endif
+			{
+				if ((data >= addr_data) && (data < addr_data + 256)) {
+					cache_addd( LDRH_IMM(dest_reg, addr_reg, data - addr_data) );      // ldrh dest_reg, [addr_reg, #(data - addr_data)]
+					return true;
+				} else if ((data < addr_data) && (data > addr_data - 256)) {
+					cache_addd( LDRH_IMM_M(dest_reg, addr_reg, addr_data - data) );      // ldrh dest_reg, [addr_reg, #-(addr_data - data)]
+					return true;
+				}
+			}
+			break;
+		case 1:
+			if ((data >= addr_data) && (data < addr_data + 4096)) {
+				cache_addd( LDRB_IMM(dest_reg, addr_reg, data - addr_data) );      // ldrb dest_reg, [addr_reg, #(data - addr_data)]
+				return true;
+			} else if ((data < addr_data) && (data > addr_data - 4096)) {
+				cache_addd( LDRB_IMM_M(dest_reg, addr_reg, addr_data - data) );      // ldrb dest_reg, [addr_reg, #-(addr_data - data)]
+				return true;
+			}
+		default:
+			break;
+	}
+	return false;
+}
+
+// helper function
+static bool gen_mov_memval_to_reg(HostReg dest_reg, void *data, Bitu size) {
+	if (gen_mov_memval_to_reg_helper(dest_reg, (Bit32u)data, size, FC_REGS_ADDR, (Bit32u)&cpu_regs)) return true;
+	if (gen_mov_memval_to_reg_helper(dest_reg, (Bit32u)data, size, readdata_addr, (Bit32u)&core_dynrec.readdata)) return true;
+	if (gen_mov_memval_to_reg_helper(dest_reg, (Bit32u)data, size, FC_SEGS_ADDR, (Bit32u)&Segs)) return true;
+	return false;
 }
 
 // helper function for gen_mov_word_to_reg
 static void gen_mov_word_to_reg_helper(HostReg dest_reg,void* data,bool dword,HostReg data_reg) {
 	// alignment....
 	if (dword) {
+#if !(defined(C_UNALIGNED_MEMORY) || (C_TARGETCPU == ARMV7LE))
 		if ((Bit32u)data & 3) {
 			if ( ((Bit32u)data & 3) == 2 ) {
 				cache_addd( LDRH_IMM(dest_reg, data_reg, 0) );      // ldrh dest_reg, [data_reg]
@@ -301,15 +390,20 @@
 				cache_addd( LDRB_IMM(temp2, data_reg, 3) );      // ldrb temp2, [data_reg, #3]
 				cache_addd( ORR_REG_LSL_IMM(dest_reg, dest_reg, temp2, 24) );      // orr dest_reg, dest_reg, temp2, lsl #24
 			}
-		} else {
+		} else
+#endif
+		{
 			cache_addd( LDR_IMM(dest_reg, data_reg, 0) );      // ldr dest_reg, [data_reg]
 		}
 	} else {
+#if !(defined(C_UNALIGNED_MEMORY) || (C_TARGETCPU == ARMV7LE))
 		if ((Bit32u)data & 1) {
 			cache_addd( LDRB_IMM(dest_reg, data_reg, 0) );      // ldrb dest_reg, [data_reg]
 			cache_addd( LDRB_IMM(temp2, data_reg, 1) );      // ldrb temp2, [data_reg, #1]
 			cache_addd( ORR_REG_LSL_IMM(dest_reg, dest_reg, temp2, 8) );      // orr dest_reg, dest_reg, temp2, lsl #8
-		} else {
+		} else
+#endif
+		{
 			cache_addd( LDRH_IMM(dest_reg, data_reg, 0) );      // ldrh dest_reg, [data_reg]
 		}
 	}
@@ -318,42 +412,76 @@
 // move a 32bit (dword==true) or 16bit (dword==false) value from memory into dest_reg
 // 16bit moves may destroy the upper 16bit of the destination register
 static void gen_mov_word_to_reg(HostReg dest_reg,void* data,bool dword) {
-	gen_mov_dword_to_reg_imm(temp1, (Bit32u)data);
-	gen_mov_word_to_reg_helper(dest_reg, data, dword, temp1);
+	if (!gen_mov_memval_to_reg(dest_reg, data, (dword)?4:2)) {
+		gen_mov_dword_to_reg_imm(temp1, (Bit32u)data);
+		gen_mov_word_to_reg_helper(dest_reg, data, dword, temp1);
+	}
 }
 
 // move a 16bit constant value into dest_reg
 // the upper 16bit of the destination register may be destroyed
-static void gen_mov_word_to_reg_imm(HostReg dest_reg,Bit16u imm) {
-	Bits first, scale;
-	Bit32u imm2;
-	if (imm == 0) {
-		cache_addd( MOV_IMM(dest_reg, 0, 0) );      // mov dest_reg, #0
-	} else {
-		scale = 0;
-		first = 1;
-		imm2 = (Bit32u)imm;
-		while (imm2) {
-			while ((imm2 & 3) == 0) {
-				imm2>>=2;
-				scale+=2;
+static void INLINE gen_mov_word_to_reg_imm(HostReg dest_reg,Bit16u imm) {
+	gen_mov_dword_to_reg_imm(dest_reg, (Bit32u)imm);
+}
+
+// helper function
+static bool gen_mov_memval_from_reg_helper(HostReg src_reg, Bit32u data, Bitu size, HostReg addr_reg, Bit32u addr_data) {
+	switch (size) {
+		case 4:
+#if !(defined(C_UNALIGNED_MEMORY) || (C_TARGETCPU == ARMV7LE))
+			if ((data & 3) == 0)
+#endif
+			{
+				if ((data >= addr_data) && (data < addr_data + 4096)) {
+					cache_addd( STR_IMM(src_reg, addr_reg, data - addr_data) );      // str src_reg, [addr_reg, #(data - addr_data)]
+					return true;
+				} else if ((data < addr_data) && (data > addr_data - 4096)) {
+					cache_addd( STR_IMM_M(src_reg, addr_reg, addr_data - data) );      // str src_reg, [addr_reg, #-(addr_data - data)]
+					return true;
+				}
 			}
-			if (first) {
-				cache_addd( MOV_IMM(dest_reg, imm2 & 0xff, ROTATE_SCALE(scale)) );      // mov dest_reg, #((imm2 & 0xff) << scale)
-				first = 0;
-			} else {
-				cache_addd( ORR_IMM(dest_reg, dest_reg, imm2 & 0xff, ROTATE_SCALE(scale)) );      // orr dest_reg, dest_reg, #((imm2 & 0xff) << scale)
+			break;
+		case 2:
+#if !(defined(C_UNALIGNED_MEMORY) || (C_TARGETCPU == ARMV7LE))
+			if ((data & 1) == 0)
+#endif
+			{
+				if ((data >= addr_data) && (data < addr_data + 256)) {
+					cache_addd( STRH_IMM(src_reg, addr_reg, data - addr_data) );      // strh src_reg, [addr_reg, #(data - addr_data)]
+					return true;
+				} else if ((data < addr_data) && (data > addr_data - 256)) {
+					cache_addd( STRH_IMM_M(src_reg, addr_reg, addr_data - data) );      // strh src_reg, [addr_reg, #-(addr_data - data)]
+					return true;
+				}
 			}
-			imm2>>=8;
-			scale+=8;
-		}
+			break;
+		case 1:
+			if ((data >= addr_data) && (data < addr_data + 4096)) {
+				cache_addd( STRB_IMM(src_reg, addr_reg, data - addr_data) );      // strb src_reg, [addr_reg, #(data - addr_data)]
+				return true;
+			} else if ((data < addr_data) && (data > addr_data - 4096)) {
+				cache_addd( STRB_IMM_M(src_reg, addr_reg, addr_data - data) );      // strb src_reg, [addr_reg, #-(addr_data - data)]
+				return true;
+			}
+		default:
+			break;
 	}
+	return false;
+}
+
+// helper function
+static bool gen_mov_memval_from_reg(HostReg src_reg, void *dest, Bitu size) {
+	if (gen_mov_memval_from_reg_helper(src_reg, (Bit32u)dest, size, FC_REGS_ADDR, (Bit32u)&cpu_regs)) return true;
+	if (gen_mov_memval_from_reg_helper(src_reg, (Bit32u)dest, size, readdata_addr, (Bit32u)&core_dynrec.readdata)) return true;
+	if (gen_mov_memval_from_reg_helper(src_reg, (Bit32u)dest, size, FC_SEGS_ADDR, (Bit32u)&Segs)) return true;
+	return false;
 }
 
 // helper function for gen_mov_word_from_reg
 static void gen_mov_word_from_reg_helper(HostReg src_reg,void* dest,bool dword, HostReg data_reg) {
 	// alignment....
 	if (dword) {
+#if !(defined(C_UNALIGNED_MEMORY) || (C_TARGETCPU == ARMV7LE))
 		if ((Bit32u)dest & 3) {
 			if ( ((Bit32u)dest & 3) == 2 ) {
 				cache_addd( STRH_IMM(src_reg, data_reg, 0) );      // strh src_reg, [data_reg]
@@ -366,15 +494,20 @@
 				cache_addd( MOV_REG_LSR_IMM(temp2, temp2, 16) );      // mov temp2, temp2, lsr #16
 				cache_addd( STRB_IMM(temp2, data_reg, 3) );      // strb temp2, [data_reg, #3]
 			}
-		} else {
+		} else
+#endif
+		{
 			cache_addd( STR_IMM(src_reg, data_reg, 0) );      // str src_reg, [data_reg]
 		}
 	} else {
+#if !(defined(C_UNALIGNED_MEMORY) || (C_TARGETCPU == ARMV7LE))
 		if ((Bit32u)dest & 1) {
 			cache_addd( STRB_IMM(src_reg, data_reg, 0) );      // strb src_reg, [data_reg]
 			cache_addd( MOV_REG_LSR_IMM(temp2, src_reg, 8) );      // mov temp2, src_reg, lsr #8
 			cache_addd( STRB_IMM(temp2, data_reg, 1) );      // strb temp2, [data_reg, #1]
-		} else {
+		} else
+#endif
+		{
 			cache_addd( STRH_IMM(src_reg, data_reg, 0) );      // strh src_reg, [data_reg]
 		}
 	}
@@ -382,8 +515,10 @@
 
 // move 32bit (dword==true) or 16bit (dword==false) of a register into memory
 static void gen_mov_word_from_reg(HostReg src_reg,void* dest,bool dword) {
-	gen_mov_dword_to_reg_imm(temp1, (Bit32u)dest);
-	gen_mov_word_from_reg_helper(src_reg, dest, dword, temp1);
+	if (!gen_mov_memval_from_reg(src_reg, dest, (dword)?4:2)) {
+		gen_mov_dword_to_reg_imm(temp1, (Bit32u)dest);
+		gen_mov_word_from_reg_helper(src_reg, dest, dword, temp1);
+	}
 }
 
 // move an 8bit value from memory into dest_reg
@@ -391,8 +526,10 @@
 // this function does not use FC_OP1/FC_OP2 as dest_reg as these
 // registers might not be directly byte-accessible on some architectures
 static void gen_mov_byte_to_reg_low(HostReg dest_reg,void* data) {
-	gen_mov_dword_to_reg_imm(temp1, (Bit32u)data);
-	cache_addd( LDRB_IMM(dest_reg, temp1, 0) );      // ldrb dest_reg, [temp1]
+	if (!gen_mov_memval_to_reg(dest_reg, data, 1)) {
+		gen_mov_dword_to_reg_imm(temp1, (Bit32u)data);
+		cache_addd( LDRB_IMM(dest_reg, temp1, 0) );      // ldrb dest_reg, [temp1]
+	}
 }
 
 // move an 8bit value from memory into dest_reg
@@ -421,8 +558,10 @@
 
 // move the lowest 8bit of a register into memory
 static void gen_mov_byte_from_reg_low(HostReg src_reg,void* dest) {
-	gen_mov_dword_to_reg_imm(temp1, (Bit32u)dest);
-	cache_addd( STRB_IMM(src_reg, temp1, 0) );      // strb src_reg, [temp1]
+	if (!gen_mov_memval_from_reg(src_reg, dest, 1)) {
+		gen_mov_dword_to_reg_imm(temp1, (Bit32u)dest);
+		cache_addd( STRB_IMM(src_reg, temp1, 0) );      // strb src_reg, [temp1]
+	}
 }
 
 
@@ -431,10 +570,18 @@
 // the register is zero-extended (sign==false) or sign-extended (sign==true)
 static void gen_extend_byte(bool sign,HostReg reg) {
 	if (sign) {
+#if C_TARGETCPU == ARMV7LE
+		cache_addd( SXTB(reg, reg, 0) );      // sxtb reg, reg
+#else
 		cache_addd( MOV_REG_LSL_IMM(reg, reg, 24) );      // mov reg, reg, lsl #24
 		cache_addd( MOV_REG_ASR_IMM(reg, reg, 24) );      // mov reg, reg, asr #24
+#endif
 	} else {
+#if C_TARGETCPU == ARMV7LE
+		cache_addd( UXTB(reg, reg, 0) );      // uxtb reg, reg
+#else
 		cache_addd( AND_IMM(reg, reg, 0xff, 0) );      // and reg, reg, #0xff
+#endif
 	}
 }
 
@@ -442,11 +589,19 @@
 // the register is zero-extended (sign==false) or sign-extended (sign==true)
 static void gen_extend_word(bool sign,HostReg reg) {
 	if (sign) {
+#if C_TARGETCPU == ARMV7LE
+		cache_addd( SXTH(reg, reg, 0) );      // sxth reg, reg
+#else
 		cache_addd( MOV_REG_LSL_IMM(reg, reg, 16) );      // mov reg, reg, lsl #16
 		cache_addd( MOV_REG_ASR_IMM(reg, reg, 16) );      // mov reg, reg, asr #16
+#endif
 	} else {
+#if C_TARGETCPU == ARMV7LE
+		cache_addd( UXTH(reg, reg, 0) );      // uxth reg, reg
+#else
 		cache_addd( MOV_REG_LSL_IMM(reg, reg, 16) );      // mov reg, reg, lsl #16
 		cache_addd( MOV_REG_LSR_IMM(reg, reg, 16) );      // mov reg, reg, lsr #16
+#endif
 	}
 }
 
@@ -458,72 +613,57 @@
 
 // add a 32bit constant value to a full register
 static void gen_add_imm(HostReg reg,Bit32u imm) {
-	Bits method1, method2, num1, num2, scale, sub;
+	Bit32u imm2, scale;
+
 	if(!imm) return;
-	if (imm == 1) {
-		cache_addd( ADD_IMM(reg, reg, 1, 0) );      // add reg, reg, #1
-	} else if (imm == 0xffffffff) {
-		cache_addd( SUB_IMM(reg, reg, 1, 0) );      // sub reg, reg, #1
+
+	imm2 = (Bit32u) (-((Bit32s)imm));
+
+	if ( val_is_operand2(imm, &scale) ) {
+		cache_addd( ADD_IMM(reg, reg, imm >> scale, ROTATE_SCALE(scale)) );      // add reg, reg, #imm
+	} else if ( val_is_operand2(imm2, &scale) ) {
+		cache_addd( SUB_IMM(reg, reg, imm2 >> scale, ROTATE_SCALE(scale)) );      // sub reg, reg, #(-imm)
+#if C_TARGETCPU == ARMV7LE
+	} else if (imm2 < 0x10000) {
+		cache_addd( MOVW(temp2, imm2) );      // movw temp2, #(-imm)
+		cache_addd( SUB_REG_LSL_IMM(reg, reg, temp2, 0) );      // sub reg, reg, temp2
+#endif
 	} else {
-		method1 = get_method_imm_gen_len(imm, 1, &num1);
-		method2 = get_method_imm_gen_len(-((Bit32s)imm), 1, &num2);
-		if (num2 < num1) {
-			method1 = method2;
-			imm = (Bit32u)(-((Bit32s)imm));
-			sub = 1;
-		} else sub = 0;
-
-		if (method1 != 2) {
-			gen_mov_dword_to_reg_imm(temp3, imm);
-			if (sub) {
-				cache_addd( SUB_REG_LSL_IMM(reg, reg, temp3, 0) );      // sub reg, reg, temp3
-			} else {
-				cache_addd( ADD_REG_LSL_IMM(reg, reg, temp3, 0) );      // add reg, reg, temp3
-			}
+#if C_TARGETCPU != ARMV7LE
+		if (get_min_imm_gen_len(imm) <= get_min_imm_gen_len(imm2)) {
+#endif
+			gen_mov_dword_to_reg_imm(temp2, imm);
+			cache_addd( ADD_REG_LSL_IMM(reg, reg, temp2, 0) );      // add reg, reg, temp2
+#if C_TARGETCPU != ARMV7LE
 		} else {
-			scale = 0;
-			while (imm) {
-				while ((imm & 3) == 0) {
-					imm>>=2;
-					scale+=2;
-				}
-				if (sub) {
-					cache_addd( SUB_IMM(reg, reg, imm & 0xff, ROTATE_SCALE(scale)) );      // sub reg, reg, #((imm & 0xff) << scale)
-				} else {
-					cache_addd( ADD_IMM(reg, reg, imm & 0xff, ROTATE_SCALE(scale)) );      // add reg, reg, #((imm & 0xff) << scale)
-				}
-				imm>>=8;
-				scale+=8;
-			}
+			gen_mov_dword_to_reg_imm(temp2, imm2);
+			cache_addd( SUB_REG_LSL_IMM(reg, reg, temp2, 0) );      // sub reg, reg, temp2
 		}
+#endif
 	}
 }
 
 // and a 32bit constant value with a full register
 static void gen_and_imm(HostReg reg,Bit32u imm) {
-	Bits method, scale;
-	Bit32u imm2;
+	Bit32u imm2, scale;
+
 	imm2 = ~imm;
 	if(!imm2) return;
+
 	if (!imm) {
 		cache_addd( MOV_IMM(reg, 0, 0) );      // mov reg, #0
+	} else if ( val_is_operand2(imm, &scale) ) {
+		cache_addd( AND_IMM(reg, reg, imm >> scale, ROTATE_SCALE(scale)) );      // and reg, reg, #imm
+	} else if ( val_is_operand2(imm2, &scale) ) {
+		cache_addd( BIC_IMM(reg, reg, imm2 >> scale, ROTATE_SCALE(scale)) );      // bic reg, reg, #(~imm)
+#if C_TARGETCPU == ARMV7LE
+	} else if (imm2 < 0x10000) {
+		cache_addd( MOVW(temp2, imm2) );      // movw temp2, #(~imm)
+		cache_addd( BIC_REG_LSL_IMM(reg, reg, temp2, 0) );      // bic reg, reg, temp2
+#endif
 	} else {
-		method = get_method_imm_gen_len(imm, 0, NULL);
-		if (method != 3) {
-			gen_mov_dword_to_reg_imm(temp3, imm);
-			cache_addd( AND_REG_LSL_IMM(reg, reg, temp3, 0) );      // and reg, reg, temp3
-		} else {
-			scale = 0;
-			while (imm2) {
-				while ((imm2 & 3) == 0) {
-					imm2>>=2;
-					scale+=2;
-				}
-				cache_addd( BIC_IMM(reg, reg, imm2 & 0xff, ROTATE_SCALE(scale)) );      // bic reg, reg, #((imm2 & 0xff) << scale)
-				imm2>>=8;
-				scale+=8;
-			}
-		}
+		gen_mov_dword_to_reg_imm(temp2, imm);
+		cache_addd( AND_REG_LSL_IMM(reg, reg, temp2, 0) );      // and reg, reg, temp2
 	}
 }
 
@@ -539,68 +679,71 @@
 	gen_mov_direct_dword(dest,(Bit32u)imm);
 }
 
-// add an 8bit constant value to a dword memory value
-static void gen_add_direct_byte(void* dest,Bit8s imm) {
-	if(!imm) return;
-	gen_mov_dword_to_reg_imm(temp1, (Bit32u)dest);
-	gen_mov_word_to_reg_helper(temp3, dest, 1, temp1);
-	if (imm >= 0) {
-		cache_addd( ADD_IMM(temp3, temp3, (Bit32s)imm, 0) );      // add temp3, temp3, #(imm)
-	} else {
-		cache_addd( SUB_IMM(temp3, temp3, -((Bit32s)imm), 0) );      // sub temp3, temp3, #(-imm)
-	}
-	gen_mov_word_from_reg_helper(temp3, dest, 1, temp1);
-}
-
 // add a 32bit (dword==true) or 16bit (dword==false) constant value to a memory value
 static void gen_add_direct_word(void* dest,Bit32u imm,bool dword) {
+	if (!dword) imm &= 0xffff;
 	if(!imm) return;
-	if (dword && ( (imm<128) || (imm>=0xffffff80) ) ) {
-		gen_add_direct_byte(dest,(Bit8s)imm);
-		return;
-	}
-	gen_mov_dword_to_reg_imm(temp1, (Bit32u)dest);
-	gen_mov_word_to_reg_helper(temp3, dest, dword, temp1);
-	// maybe use function gen_add_imm
-	if (dword) {
-		gen_mov_dword_to_reg_imm(temp2, imm);
-	} else {
-		gen_mov_word_to_reg_imm(temp2, (Bit16u)imm);
+
+	if (!gen_mov_memval_to_reg(temp3, dest, (dword)?4:2)) {
+		gen_mov_dword_to_reg_imm(temp1, (Bit32u)dest);
+		gen_mov_word_to_reg_helper(temp3, dest, dword, temp1);
+	}
+	gen_add_imm(temp3, imm);
+	if (!gen_mov_memval_from_reg(temp3, dest, (dword)?4:2)) {
+		gen_mov_word_from_reg_helper(temp3, dest, dword, temp1);
 	}
-	cache_addd( ADD_REG_LSL_IMM(temp3, temp3, temp2, 0) );      // add temp3, temp3, temp2
-	gen_mov_word_from_reg_helper(temp3, dest, dword, temp1);
 }
 
-// subtract an 8bit constant value from a dword memory value
-static void gen_sub_direct_byte(void* dest,Bit8s imm) {
-	if(!imm) return;
-	gen_mov_dword_to_reg_imm(temp1, (Bit32u)dest);
-	gen_mov_word_to_reg_helper(temp3, dest, 1, temp1);
-	if (imm >= 0) {
-		cache_addd( SUB_IMM(temp3, temp3, (Bit32s)imm, 0) );      // sub temp3, temp3, #(imm)
-	} else {
-		cache_addd( ADD_IMM(temp3, temp3, -((Bit32s)imm), 0) );      // add temp3, temp3, #(-imm)
-	}
-	gen_mov_word_from_reg_helper(temp3, dest, 1, temp1);
+// add an 8bit constant value to a dword memory value
+static void gen_add_direct_byte(void* dest,Bit8s imm) {
+	gen_add_direct_word(dest, (Bit32s)imm, 1);
 }
 
 // subtract a 32bit (dword==true) or 16bit (dword==false) constant value from a memory value
 static void gen_sub_direct_word(void* dest,Bit32u imm,bool dword) {
+	Bit32u imm2, scale;
+
+	if (!dword) imm &= 0xffff;
 	if(!imm) return;
-	if (dword && ( (imm<128) || (imm>=0xffffff80) ) ) {
-		gen_sub_direct_byte(dest,(Bit8s)imm);
-		return;
-	}
-	gen_mov_dword_to_reg_imm(temp1, (Bit32u)dest);
-	gen_mov_word_to_reg_helper(temp3, dest, dword, temp1);
-	// maybe use function gen_add_imm/gen_sub_imm
-	if (dword) {
-		gen_mov_dword_to_reg_imm(temp2, imm);
+
+	if (!gen_mov_memval_to_reg(temp3, dest, (dword)?4:2)) {
+		gen_mov_dword_to_reg_imm(temp1, (Bit32u)dest);
+		gen_mov_word_to_reg_helper(temp3, dest, dword, temp1);
+	}
+
+	imm2 = (Bit32u) (-((Bit32s)imm));
+
+	if ( val_is_operand2(imm, &scale) ) {
+		cache_addd( SUB_IMM(temp3, temp3, imm >> scale, ROTATE_SCALE(scale)) );      // sub temp3, temp3, #imm
+	} else if ( val_is_operand2(imm2, &scale) ) {
+		cache_addd( ADD_IMM(temp3, temp3, imm2 >> scale, ROTATE_SCALE(scale)) );      // add temp3, temp3, #(-imm)
+#if C_TARGETCPU == ARMV7LE
+	} else if (imm2 < 0x10000) {
+		cache_addd( MOVW(temp2, imm2) );      // movw temp2, #(-imm)
+		cache_addd( ADD_REG_LSL_IMM(temp3, temp3, temp2, 0) );      // add temp3, temp3, temp2
+#endif
 	} else {
-		gen_mov_word_to_reg_imm(temp2, (Bit16u)imm);
+#if C_TARGETCPU != ARMV7LE
+		if (get_min_imm_gen_len(imm) <= get_min_imm_gen_len(imm2)) {
+#endif
+			gen_mov_dword_to_reg_imm(temp2, imm);
+			cache_addd( SUB_REG_LSL_IMM(temp3, temp3, temp2, 0) );      // sub temp3, temp3, temp2
+#if C_TARGETCPU != ARMV7LE
+		} else {
+			gen_mov_dword_to_reg_imm(temp2, imm2);
+			cache_addd( ADD_REG_LSL_IMM(temp3, temp3, temp2, 0) );      // add temp3, temp3, temp2
+		}
+#endif
+	}
+
+	if (!gen_mov_memval_from_reg(temp3, dest, (dword)?4:2)) {
+		gen_mov_word_from_reg_helper(temp3, dest, dword, temp1);
 	}
-	cache_addd( SUB_REG_LSL_IMM(temp3, temp3, temp2, 0) );      // sub temp3, temp3, temp2
-	gen_mov_word_from_reg_helper(temp3, dest, dword, temp1);
+}
+
+// subtract an 8bit constant value from a dword memory value
+static void gen_sub_direct_byte(void* dest,Bit8s imm) {
+	gen_sub_direct_word(dest, (Bit32s)imm, 1);
 }
 
 // effective address calculation, destination is dest_reg
@@ -623,10 +766,16 @@
 
 // generate a call to a parameterless function
 static void INLINE gen_call_function_raw(void * func) {
+#if C_TARGETCPU == ARMV7LE
+	cache_addd( MOVW(temp1, ((Bit32u)func) & 0xffff) );      // movw temp1, #(func & 0xffff)
+	cache_addd( MOVT(temp1, ((Bit32u)func) >> 16) );      // movt temp1, #(func >> 16)
+	cache_addd( BLX_REG(temp1) );      // blx temp1
+#else
 	cache_addd( LDR_IMM(temp1, HOST_pc, 4) );      // ldr temp1, [pc, #4]
 	cache_addd( ADD_IMM(HOST_lr, HOST_pc, 4, 0) );      // add lr, pc, #4
 	cache_addd( BX(temp1) );      // bx temp1
 	cache_addd((Bit32u)func);      // .int func
+#endif
 }
 
 // generate a call to a function with paramcount parameters
@@ -666,43 +815,24 @@
 
 // jump to an address pointed at by ptr, offset is in imm
 static void gen_jmp_ptr(void * ptr,Bits imm=0) {
-	Bits num1, num2, scale, sub;
-	Bitu imm2;
-	gen_mov_word_to_reg(temp3, ptr, 1);
+	Bit32u scale;
 
-	if (imm) {
-		num1 = get_imm_gen_len(imm);
-		num2 = get_imm_gen_len(-imm);
-
-		if (num2 < num1) {
-			imm = -imm;
-			sub = 1;
-		} else sub = 0;
-
-		scale = 0;
-		imm2 = (Bitu)imm;
-		while (imm2) {
-			while ((imm2 & 3) == 0) {
-				imm2>>=2;
-				scale+=2;
-			}
-			if (sub) {
-				cache_addd( SUB_IMM(temp3, temp3, imm2 & 0xff, ROTATE_SCALE(scale)) );      // sub temp3, temp3, #((imm2 & 0xff) << scale)
-			} else {
-				cache_addd( ADD_IMM(temp3, temp3, imm2 & 0xff, ROTATE_SCALE(scale)) );      // add temp3, temp3, #((imm2 & 0xff) << scale)
-			}
-			imm2>>=8;
-			scale+=8;
-		}
-	}
+	gen_mov_word_to_reg(temp3, ptr, 1);
 
-#if (1)
-// (*ptr) should be word aligned 
+#if !(defined(C_UNALIGNED_MEMORY) || (C_TARGETCPU == ARMV7LE))
+// (*ptr) should be word aligned
 	if ((imm & 0x03) == 0) {
-		cache_addd( LDR_IMM(temp1, temp3, 0) );      // ldr temp1, [temp3]
-	} else
 #endif
-	{
+		if ((imm >= 0) && (imm < 4096)) {
+			cache_addd( LDR_IMM(temp1, temp3, imm) );      // ldr temp1, [temp3, #imm]
+		} else {
+			gen_mov_dword_to_reg_imm(temp2, imm);
+			cache_addd( LDR_REG_LSL_IMM(temp1, temp3, temp2, 0) );      // ldr temp1, [temp3, temp2]
+		}
+#if !(defined(C_UNALIGNED_MEMORY) || (C_TARGETCPU == ARMV7LE))
+	} else {
+		gen_add_imm(temp3, imm);
+
 		cache_addd( LDRB_IMM(temp1, temp3, 0) );      // ldrb temp1, [temp3]
 		cache_addd( LDRB_IMM(temp2, temp3, 1) );      // ldrb temp2, [temp3, #1]
 		cache_addd( ORR_REG_LSL_IMM(temp1, temp1, temp2, 8) );      // orr temp1, temp1, temp2, lsl #8
@@ -711,6 +841,7 @@
 		cache_addd( LDRB_IMM(temp2, temp3, 3) );      // ldrb temp2, [temp3, #3]
 		cache_addd( ORR_REG_LSL_IMM(temp1, temp1, temp2, 24) );      // orr temp1, temp1, temp2, lsl #24
 	}
+#endif
 
 	cache_addd( BX(temp1) );      // bx temp1
 }
@@ -758,67 +889,74 @@
 	} else {
 		cache_addd( TST_IMM(reg, 0xff, 0) );      // tst reg, #0xff
 	}
-	cache_addd( BEQ_FWD(8) );      // beq nobranch (pc +8)
-	cache_addd( LDR_IMM(temp1, HOST_pc, 0) );      // ldr temp1, [pc, #0]
-	cache_addd( BX(temp1) );      // bx temp1
-	cache_addd(0);      // fill j
-	// nobranch:
+	cache_addd( BNE_FWD(0) );      // bne j
 	return ((Bit32u)cache.pos-4);
 }
 
 // compare 32bit-register against zero and jump if value less/equal than zero
 static Bit32u gen_create_branch_long_leqzero(HostReg reg) {
 	cache_addd( CMP_IMM(reg, 0, 0) );      // cmp reg, #0
-	cache_addd( BGT_FWD(8) );      // bgt nobranch (pc+8)
-	cache_addd( LDR_IMM(temp1, HOST_pc, 0) );      // ldr temp1, [pc, #0]
-	cache_addd( BX(temp1) );      // bx temp1
-	cache_addd(0);      // fill j
-	// nobranch:
+	cache_addd( BLE_FWD(0) );      // ble j
 	return ((Bit32u)cache.pos-4);
 }
 
 // calculate long relative offset and fill it into the location pointed to by data
 static void INLINE gen_fill_branch_long(Bit32u data) {
-	// this is an absolute branch
-	*(Bit32u*)data=(Bit32u)cache.pos;
+	*(Bit32u*)data=( (*(Bit32u*)data) & 0xff000000 ) | ( ( ((Bit32u)cache.pos - (data+8)) >> 2 ) & 0x00ffffff );
 }
 
 static void gen_run_code(void) {
-	cache_addd(0xe92d4000);			// stmfd sp!, {lr}
-	cache_addd(0xe92d0cf0);			// stmfd sp!, {v1-v4,v7,v8}
+#if C_TARGETCPU == ARMV7LE
+	cache_addd(0xe92d4df0);			// stmfd sp!, {v1-v5,v7,v8,lr}
+
+	cache_addd( MOVW(FC_SEGS_ADDR, ((Bit32u)&Segs) & 0xffff) );      // movw FC_SEGS_ADDR, #(&Segs & 0xffff)
+	cache_addd( MOVT(FC_SEGS_ADDR, ((Bit32u)&Segs) >> 16) );      // movt FC_SEGS_ADDR, #(&Segs >> 16)
 
-	// adr: 8
-	cache_addd( LDR_IMM(FC_SEGS_ADDR, HOST_pc, 64 - (8 + 8)) );      // ldr FC_SEGS_ADDR, [pc, #(&Segs)]
-	// adr: 12
-	cache_addd( LDR_IMM(FC_REGS_ADDR, HOST_pc, 68 - (12 + 8)) );      // ldr FC_REGS_ADDR, [pc, #(&cpu_regs)]
-
-	cache_addd( ADD_IMM(HOST_lr, HOST_pc, 4, 0) );			// add lr, pc, #4
-	cache_addd(0xe92d4000);			// stmfd sp!, {lr}
-	cache_addd( BX(HOST_r0) );			// bx r0	
-
-	cache_addd(0xe8bd0cf0);			// ldmfd sp!, {v1-v4,v7,v8}
-
-	cache_addd(0xe8bd4000);			// ldmfd sp!, {lr}
-	cache_addd( BX(HOST_lr) );			// bx lr
-
-	// fill up to 64 bytes
-	cache_addd( NOP );			// nop
-	cache_addd( NOP );			// nop
-	cache_addd( NOP );			// nop
-	cache_addd( NOP );			// nop
-	cache_addd( NOP );			// nop
-	cache_addd( NOP );			// nop
+	cache_addd( MOVW(FC_REGS_ADDR, ((Bit32u)&cpu_regs) & 0xffff) );      // movw FC_REGS_ADDR, #(&cpu_regs & 0xffff)
+	cache_addd( MOVT(FC_REGS_ADDR, ((Bit32u)&cpu_regs) >> 16) );      // movt FC_REGS_ADDR, #(&cpu_regs >> 16)
+
+	cache_addd( MOVW(readdata_addr, ((Bitu)&core_dynrec.readdata) & 0xffff) );      // movw readdata_addr, #(&core_dynrec.readdata & 0xffff)
+	cache_addd( MOVT(readdata_addr, ((Bitu)&core_dynrec.readdata) >> 16) );      // movt readdata_addr, #(&core_dynrec.readdata >> 16)
+
+	cache_addd( BX(HOST_r0) );			// bx r0
+#else
+	Bit8u *pos1, *pos2, *pos3;
+
+	cache_addd(0xe92d4df0);			// stmfd sp!, {v1-v5,v7,v8,lr}
+
+	pos1 = cache.pos;
+	cache_addd( 0 );
+	pos2 = cache.pos;
+	cache_addd( 0 );
+	pos3 = cache.pos;
+	cache_addd( 0 );
+
+	cache_addd( BX(HOST_r0) );			// bx r0
+
+	// align cache.pos to 32 bytes
+	if ((((Bitu)cache.pos) & 0x1f) != 0) {
+		cache.pos = cache.pos + (32 - (((Bitu)cache.pos) & 0x1f));
+	}
 
-	// adr: 64
+	*(Bit32u*)pos1 = LDR_IMM(FC_SEGS_ADDR, HOST_pc, cache.pos - (pos1 + 8));      // ldr FC_SEGS_ADDR, [pc, #(&Segs)]
 	cache_addd((Bit32u)&Segs);      // address of "Segs"
-	// adr: 68
+
+	*(Bit32u*)pos2 = LDR_IMM(FC_REGS_ADDR, HOST_pc, cache.pos - (pos2 + 8));      // ldr FC_REGS_ADDR, [pc, #(&cpu_regs)]
 	cache_addd((Bit32u)&cpu_regs);  // address of "cpu_regs"
+
+	*(Bit32u*)pos3 = LDR_IMM(readdata_addr, HOST_pc, cache.pos - (pos3 + 8));      // ldr readdata_addr, [pc, #(&core_dynrec.readdata)]
+	cache_addd((Bit32u)&core_dynrec.readdata);  // address of "core_dynrec.readdata"
+
+	// align cache.pos to 32 bytes
+	if ((((Bitu)cache.pos) & 0x1f) != 0) {
+		cache.pos = cache.pos + (32 - (((Bitu)cache.pos) & 0x1f));
+	}
+#endif
 }
 
 // return from a function
 static void gen_return_function(void) {
-	cache_addd(0xe8bd4000);			// ldmfd sp!, {lr}
-	cache_addd( BX(HOST_lr) );			// bx lr
+	cache_addd(0xe8bd8df0);			// ldmfd sp!, {v1-v5,v7,v8,pc}
 }
 
 #ifdef DRC_FLAGS_INVALIDATION
@@ -832,42 +970,52 @@
 		case t_ADDb:
 		case t_ADDw:
 		case t_ADDd:
-			*(Bit32u*)pos=ADD_REG_LSL_IMM(FC_RETOP, HOST_a1, HOST_a2, 0);	// add FC_RETOP, a1, a2
+			*(Bit32u*)pos=NOP;					// nop
 			*(Bit32u*)(pos+4)=NOP;				// nop
-			*(Bit32u*)(pos+8)=NOP;				// nop
+			*(Bit32u*)(pos+8)=ADD_REG_LSL_IMM(FC_RETOP, HOST_a1, HOST_a2, 0);	// add FC_RETOP, a1, a2
+#if C_TARGETCPU != ARMV7LE
 			*(Bit32u*)(pos+12)=NOP;				// nop
+#endif
 			break;
 		case t_ORb:
 		case t_ORw:
 		case t_ORd:
-			*(Bit32u*)pos=ORR_REG_LSL_IMM(FC_RETOP, HOST_a1, HOST_a2, 0);	// orr FC_RETOP, a1, a2
+			*(Bit32u*)pos=NOP;					// nop
 			*(Bit32u*)(pos+4)=NOP;				// nop
-			*(Bit32u*)(pos+8)=NOP;				// nop
+			*(Bit32u*)(pos+8)=ORR_REG_LSL_IMM(FC_RETOP, HOST_a1, HOST_a2, 0);	// orr FC_RETOP, a1, a2
+#if C_TARGETCPU != ARMV7LE
 			*(Bit32u*)(pos+12)=NOP;				// nop
+#endif
 			break;
 		case t_ANDb:
 		case t_ANDw:
 		case t_ANDd:
-			*(Bit32u*)pos=AND_REG_LSL_IMM(FC_RETOP, HOST_a1, HOST_a2, 0);	// and FC_RETOP, a1, a2
+			*(Bit32u*)pos=NOP;					// nop
 			*(Bit32u*)(pos+4)=NOP;				// nop
-			*(Bit32u*)(pos+8)=NOP;				// nop
+			*(Bit32u*)(pos+8)=AND_REG_LSL_IMM(FC_RETOP, HOST_a1, HOST_a2, 0);	// and FC_RETOP, a1, a2
+#if C_TARGETCPU != ARMV7LE
 			*(Bit32u*)(pos+12)=NOP;				// nop
+#endif
 			break;
 		case t_SUBb:
 		case t_SUBw:
 		case t_SUBd:
-			*(Bit32u*)pos=SUB_REG_LSL_IMM(FC_RETOP, HOST_a1, HOST_a2, 0);	// sub FC_RETOP, a1, a2
+			*(Bit32u*)pos=NOP;					// nop
 			*(Bit32u*)(pos+4)=NOP;				// nop
-			*(Bit32u*)(pos+8)=NOP;				// nop
+			*(Bit32u*)(pos+8)=SUB_REG_LSL_IMM(FC_RETOP, HOST_a1, HOST_a2, 0);	// sub FC_RETOP, a1, a2
+#if C_TARGETCPU != ARMV7LE
 			*(Bit32u*)(pos+12)=NOP;				// nop
+#endif
 			break;
 		case t_XORb:
 		case t_XORw:
 		case t_XORd:
-			*(Bit32u*)pos=EOR_REG_LSL_IMM(FC_RETOP, HOST_a1, HOST_a2, 0);	// eor FC_RETOP, a1, a2
+			*(Bit32u*)pos=NOP;					// nop
 			*(Bit32u*)(pos+4)=NOP;				// nop
-			*(Bit32u*)(pos+8)=NOP;				// nop
+			*(Bit32u*)(pos+8)=EOR_REG_LSL_IMM(FC_RETOP, HOST_a1, HOST_a2, 0);	// eor FC_RETOP, a1, a2
+#if C_TARGETCPU != ARMV7LE
 			*(Bit32u*)(pos+12)=NOP;				// nop
+#endif
 			break;
 		case t_CMPb:
 		case t_CMPw:
@@ -875,114 +1023,185 @@
 		case t_TESTb:
 		case t_TESTw:
 		case t_TESTd:
-			*(Bit32u*)pos=B_FWD(8);				// b (pc+2*4)
+			*(Bit32u*)pos=NOP;					// nop
+			*(Bit32u*)(pos+4)=NOP;				// nop
+			*(Bit32u*)(pos+8)=NOP;				// nop
+#if C_TARGETCPU != ARMV7LE
+			*(Bit32u*)(pos+12)=NOP;				// nop
+#endif
 			break;
 		case t_INCb:
 		case t_INCw:
 		case t_INCd:
-			*(Bit32u*)pos=ADD_IMM(FC_RETOP, HOST_a1, 1, 0);	// add FC_RETOP, a1, #1
+			*(Bit32u*)pos=NOP;					// nop
 			*(Bit32u*)(pos+4)=NOP;				// nop
-			*(Bit32u*)(pos+8)=NOP;				// nop
+			*(Bit32u*)(pos+8)=ADD_IMM(FC_RETOP, HOST_a1, 1, 0);	// add FC_RETOP, a1, #1
+#if C_TARGETCPU != ARMV7LE
 			*(Bit32u*)(pos+12)=NOP;				// nop
+#endif
 			break;
 		case t_DECb:
 		case t_DECw:
 		case t_DECd:
-			*(Bit32u*)pos=SUB_IMM(FC_RETOP, HOST_a1, 1, 0);	// sub FC_RETOP, a1, #1
+			*(Bit32u*)pos=NOP;					// nop
 			*(Bit32u*)(pos+4)=NOP;				// nop
-			*(Bit32u*)(pos+8)=NOP;				// nop
+			*(Bit32u*)(pos+8)=SUB_IMM(FC_RETOP, HOST_a1, 1, 0);	// sub FC_RETOP, a1, #1
+#if C_TARGETCPU != ARMV7LE
 			*(Bit32u*)(pos+12)=NOP;				// nop
+#endif
 			break;
 		case t_SHLb:
 		case t_SHLw:
 		case t_SHLd:
-			*(Bit32u*)pos=MOV_REG_LSL_REG(FC_RETOP, HOST_a1, HOST_a2);	// mov FC_RETOP, a1, lsl a2
+			*(Bit32u*)pos=NOP;					// nop
 			*(Bit32u*)(pos+4)=NOP;				// nop
-			*(Bit32u*)(pos+8)=NOP;				// nop
+			*(Bit32u*)(pos+8)=MOV_REG_LSL_REG(FC_RETOP, HOST_a1, HOST_a2);	// mov FC_RETOP, a1, lsl a2
+#if C_TARGETCPU != ARMV7LE
 			*(Bit32u*)(pos+12)=NOP;				// nop
+#endif
 			break;
 		case t_SHRb:
-			*(Bit32u*)pos=AND_IMM(FC_RETOP, HOST_a1, 0xff, 0);				// and FC_RETOP, a1, #0xff
-			*(Bit32u*)(pos+4)=MOV_REG_LSR_REG(FC_RETOP, FC_RETOP, HOST_a2);	// mov FC_RETOP, FC_RETOP, lsr a2
-			*(Bit32u*)(pos+8)=NOP;				// nop
-			*(Bit32u*)(pos+12)=NOP;				// nop
+			*(Bit32u*)pos=NOP;					// nop
+#if C_TARGETCPU == ARMV7LE
+			*(Bit32u*)(pos+4)=BFC(HOST_a1, 8, 24);	// bfc a1, 8, 24
+			*(Bit32u*)(pos+8)=MOV_REG_LSR_REG(FC_RETOP, HOST_a1, HOST_a2);	// mov FC_RETOP, a1, lsr a2
+#else
+			*(Bit32u*)(pos+4)=NOP;				// nop
+			*(Bit32u*)(pos+8)=AND_IMM(FC_RETOP, HOST_a1, 0xff, 0);				// and FC_RETOP, a1, #0xff
+			*(Bit32u*)(pos+12)=MOV_REG_LSR_REG(FC_RETOP, FC_RETOP, HOST_a2);	// mov FC_RETOP, FC_RETOP, lsr a2
+#endif
 			break;
 		case t_SHRw:
-			*(Bit32u*)pos=MOV_REG_LSL_IMM(FC_RETOP, HOST_a1, 16);			// mov FC_RETOP, a1, lsl #16
-			*(Bit32u*)(pos+4)=MOV_REG_LSR_IMM(FC_RETOP, FC_RETOP, 16);		// mov FC_RETOP, FC_RETOP, lsr #16
-			*(Bit32u*)(pos+8)=MOV_REG_LSR_REG(FC_RETOP, FC_RETOP, HOST_a2);	// mov FC_RETOP, FC_RETOP, lsr a2
-			*(Bit32u*)(pos+12)=NOP;				// nop
+			*(Bit32u*)pos=NOP;					// nop
+#if C_TARGETCPU == ARMV7LE
+			*(Bit32u*)(pos+4)=BFC(HOST_a1, 16, 16);	// bfc a1, 16, 16
+			*(Bit32u*)(pos+8)=MOV_REG_LSR_REG(FC_RETOP, HOST_a1, HOST_a2);	// mov FC_RETOP, a1, lsr a2
+#else
+			*(Bit32u*)(pos+4)=MOV_REG_LSL_IMM(FC_RETOP, HOST_a1, 16);			// mov FC_RETOP, a1, lsl #16
+			*(Bit32u*)(pos+8)=MOV_REG_LSR_IMM(FC_RETOP, FC_RETOP, 16);			// mov FC_RETOP, FC_RETOP, lsr #16
+			*(Bit32u*)(pos+12)=MOV_REG_LSR_REG(FC_RETOP, FC_RETOP, HOST_a2);	// mov FC_RETOP, FC_RETOP, lsr a2
+#endif
 			break;
 		case t_SHRd:
-			*(Bit32u*)pos=MOV_REG_LSR_REG(FC_RETOP, HOST_a1, HOST_a2);	// mov FC_RETOP, a1, lsr a2
+			*(Bit32u*)pos=NOP;					// nop
 			*(Bit32u*)(pos+4)=NOP;				// nop
-			*(Bit32u*)(pos+8)=NOP;				// nop
+			*(Bit32u*)(pos+8)=MOV_REG_LSR_REG(FC_RETOP, HOST_a1, HOST_a2);	// mov FC_RETOP, a1, lsr a2
+#if C_TARGETCPU != ARMV7LE
 			*(Bit32u*)(pos+12)=NOP;				// nop
+#endif
 			break;
 		case t_SARb:
-			*(Bit32u*)pos=MOV_REG_LSL_IMM(FC_RETOP, HOST_a1, 24);			// mov FC_RETOP, a1, lsl #24
-			*(Bit32u*)(pos+4)=MOV_REG_ASR_IMM(FC_RETOP, FC_RETOP, 24);		// mov FC_RETOP, FC_RETOP, asr #24
+			*(Bit32u*)pos=NOP;					// nop
+#if C_TARGETCPU == ARMV7LE
+			*(Bit32u*)(pos+4)=SXTB(FC_RETOP, HOST_a1, 0);					// sxtb FC_RETOP, a1
 			*(Bit32u*)(pos+8)=MOV_REG_ASR_REG(FC_RETOP, FC_RETOP, HOST_a2);	// mov FC_RETOP, FC_RETOP, asr a2
-			*(Bit32u*)(pos+12)=NOP;				// nop
+#else
+			*(Bit32u*)(pos+4)=MOV_REG_LSL_IMM(FC_RETOP, HOST_a1, 24);			// mov FC_RETOP, a1, lsl #24
+			*(Bit32u*)(pos+8)=MOV_REG_ASR_IMM(FC_RETOP, FC_RETOP, 24);			// mov FC_RETOP, FC_RETOP, asr #24
+			*(Bit32u*)(pos+12)=MOV_REG_ASR_REG(FC_RETOP, FC_RETOP, HOST_a2);	// mov FC_RETOP, FC_RETOP, asr a2
+#endif
 			break;
 		case t_SARw:
-			*(Bit32u*)pos=MOV_REG_LSL_IMM(FC_RETOP, HOST_a1, 16);			// mov FC_RETOP, a1, lsl #16
-			*(Bit32u*)(pos+4)=MOV_REG_ASR_IMM(FC_RETOP, FC_RETOP, 16);		// mov FC_RETOP, FC_RETOP, asr #16
+			*(Bit32u*)pos=NOP;					// nop
+#if C_TARGETCPU == ARMV7LE
+			*(Bit32u*)(pos+4)=SXTH(FC_RETOP, HOST_a1, 0);					// sxth FC_RETOP, a1
 			*(Bit32u*)(pos+8)=MOV_REG_ASR_REG(FC_RETOP, FC_RETOP, HOST_a2);	// mov FC_RETOP, FC_RETOP, asr a2
-			*(Bit32u*)(pos+12)=NOP;				// nop
+#else
+			*(Bit32u*)(pos+4)=MOV_REG_LSL_IMM(FC_RETOP, HOST_a1, 16);			// mov FC_RETOP, a1, lsl #16
+			*(Bit32u*)(pos+8)=MOV_REG_ASR_IMM(FC_RETOP, FC_RETOP, 16);			// mov FC_RETOP, FC_RETOP, asr #16
+			*(Bit32u*)(pos+12)=MOV_REG_ASR_REG(FC_RETOP, FC_RETOP, HOST_a2);	// mov FC_RETOP, FC_RETOP, asr a2
+#endif
 			break;
 		case t_SARd:
-			*(Bit32u*)pos=MOV_REG_ASR_REG(FC_RETOP, HOST_a1, HOST_a2);	// mov FC_RETOP, a1, asr a2
+			*(Bit32u*)pos=NOP;					// nop
 			*(Bit32u*)(pos+4)=NOP;				// nop
-			*(Bit32u*)(pos+8)=NOP;				// nop
+			*(Bit32u*)(pos+8)=MOV_REG_ASR_REG(FC_RETOP, HOST_a1, HOST_a2);	// mov FC_RETOP, a1, asr a2
+#if C_TARGETCPU != ARMV7LE
 			*(Bit32u*)(pos+12)=NOP;				// nop
+#endif
 			break;
 		case t_RORb:
+#if C_TARGETCPU == ARMV7LE
+			*(Bit32u*)pos=BFI(HOST_a1, HOST_a1, 8, 8);						// bfi a1, a1, 8, 8
+			*(Bit32u*)(pos+4)=BFI(HOST_a1, HOST_a1, 16, 16);				// bfi a1, a1, 16, 16
+			*(Bit32u*)(pos+8)=MOV_REG_ROR_REG(FC_RETOP, HOST_a1, HOST_a2);	// mov FC_RETOP, a1, ror a2
+#else
 			*(Bit32u*)pos=MOV_REG_LSL_IMM(FC_RETOP, HOST_a1, 24);					// mov FC_RETOP, a1, lsl #24
 			*(Bit32u*)(pos+4)=ORR_REG_LSR_IMM(FC_RETOP, FC_RETOP, FC_RETOP, 8);		// orr FC_RETOP, FC_RETOP, FC_RETOP, lsr #8
 			*(Bit32u*)(pos+8)=ORR_REG_LSR_IMM(FC_RETOP, FC_RETOP, FC_RETOP, 16);	// orr FC_RETOP, FC_RETOP, FC_RETOP, lsr #16
 			*(Bit32u*)(pos+12)=MOV_REG_ROR_REG(FC_RETOP, FC_RETOP, HOST_a2);		// mov FC_RETOP, FC_RETOP, ror a2
+#endif
 			break;
 		case t_RORw:
-			*(Bit32u*)pos=MOV_REG_LSL_IMM(FC_RETOP, HOST_a1, 16);					// mov FC_RETOP, a1, lsl #16
-			*(Bit32u*)(pos+4)=ORR_REG_LSR_IMM(FC_RETOP, FC_RETOP, FC_RETOP, 16);	// orr FC_RETOP, FC_RETOP, FC_RETOP, lsr #16
-			*(Bit32u*)(pos+8)=MOV_REG_ROR_REG(FC_RETOP, FC_RETOP, HOST_a2);			// mov FC_RETOP, FC_RETOP, ror a2
-			*(Bit32u*)(pos+12)=NOP;				// nop
+			*(Bit32u*)pos=NOP;					// nop
+#if C_TARGETCPU == ARMV7LE
+			*(Bit32u*)(pos+4)=BFI(HOST_a1, HOST_a1, 16, 16);				// bfi a1, a1, 16, 16
+			*(Bit32u*)(pos+8)=MOV_REG_ROR_REG(FC_RETOP, HOST_a1, HOST_a2);	// mov FC_RETOP, a1, ror a2
+#else
+			*(Bit32u*)(pos+4)=MOV_REG_LSL_IMM(FC_RETOP, HOST_a1, 16);				// mov FC_RETOP, a1, lsl #16
+			*(Bit32u*)(pos+8)=ORR_REG_LSR_IMM(FC_RETOP, FC_RETOP, FC_RETOP, 16);	// orr FC_RETOP, FC_RETOP, FC_RETOP, lsr #16
+			*(Bit32u*)(pos+12)=MOV_REG_ROR_REG(FC_RETOP, FC_RETOP, HOST_a2);		// mov FC_RETOP, FC_RETOP, ror a2
+#endif
 			break;
 		case t_RORd:
-			*(Bit32u*)pos=MOV_REG_ROR_REG(FC_RETOP, HOST_a1, HOST_a2);	// mov FC_RETOP, a1, ror a2
+			*(Bit32u*)pos=NOP;					// nop
 			*(Bit32u*)(pos+4)=NOP;				// nop
-			*(Bit32u*)(pos+8)=NOP;				// nop
+			*(Bit32u*)(pos+8)=MOV_REG_ROR_REG(FC_RETOP, HOST_a1, HOST_a2);	// mov FC_RETOP, a1, ror a2
+#if C_TARGETCPU != ARMV7LE
 			*(Bit32u*)(pos+12)=NOP;				// nop
+#endif
 			break;
 		case t_ROLw:
+#if C_TARGETCPU == ARMV7LE
+			*(Bit32u*)pos=BFI(HOST_a1, HOST_a1, 16, 16);					// bfi a1, a1, 16, 16
+			*(Bit32u*)(pos+4)=RSB_IMM(HOST_a2, HOST_a2, 32, 0);				// rsb a2, a2, #32
+			*(Bit32u*)(pos+8)=MOV_REG_ROR_REG(FC_RETOP, HOST_a1, HOST_a2);	// mov FC_RETOP, a1, ror a2
+#else
 			*(Bit32u*)pos=MOV_REG_LSL_IMM(FC_RETOP, HOST_a1, 16);					// mov FC_RETOP, a1, lsl #16
 			*(Bit32u*)(pos+4)=RSB_IMM(HOST_a2, HOST_a2, 32, 0);						// rsb a2, a2, #32
 			*(Bit32u*)(pos+8)=ORR_REG_LSR_IMM(FC_RETOP, FC_RETOP, FC_RETOP, 16);	// orr FC_RETOP, FC_RETOP, FC_RETOP, lsr #16
 			*(Bit32u*)(pos+12)=MOV_REG_ROR_REG(FC_RETOP, FC_RETOP, HOST_a2);		// mov FC_RETOP, FC_RETOP, ror a2
+#endif
 			break;
 		case t_ROLd:
-			*(Bit32u*)pos=RSB_IMM(HOST_a2, HOST_a2, 32, 0);					// rsb a2, a2, #32
-			*(Bit32u*)(pos+4)=MOV_REG_ROR_REG(FC_RETOP, HOST_a1, HOST_a2);	// mov FC_RETOP, a1, ror a2
-			*(Bit32u*)(pos+8)=NOP;				// nop
-			*(Bit32u*)(pos+12)=NOP;				// nop
+			*(Bit32u*)pos=NOP;					// nop
+#if C_TARGETCPU == ARMV7LE
+			*(Bit32u*)(pos+4)=RSB_IMM(HOST_a2, HOST_a2, 32, 0);				// rsb a2, a2, #32
+			*(Bit32u*)(pos+8)=MOV_REG_ROR_REG(FC_RETOP, HOST_a1, HOST_a2);	// mov FC_RETOP, a1, ror a2
+#else
+			*(Bit32u*)(pos+4)=NOP;				// nop
+			*(Bit32u*)(pos+8)=RSB_IMM(HOST_a2, HOST_a2, 32, 0);				// rsb a2, a2, #32
+			*(Bit32u*)(pos+12)=MOV_REG_ROR_REG(FC_RETOP, HOST_a1, HOST_a2);	// mov FC_RETOP, a1, ror a2
+#endif
 			break;
 		case t_NEGb:
 		case t_NEGw:
 		case t_NEGd:
-			*(Bit32u*)pos=RSB_IMM(FC_RETOP, HOST_a1, 0, 0);	// rsb FC_RETOP, a1, #0
+			*(Bit32u*)pos=NOP;					// nop
 			*(Bit32u*)(pos+4)=NOP;				// nop
-			*(Bit32u*)(pos+8)=NOP;				// nop
+			*(Bit32u*)(pos+8)=RSB_IMM(FC_RETOP, HOST_a1, 0, 0);	// rsb FC_RETOP, a1, #0
+#if C_TARGETCPU != ARMV7LE
 			*(Bit32u*)(pos+12)=NOP;				// nop
+#endif
 			break;
 		default:
+#if C_TARGETCPU == ARMV7LE
+			*(Bit32u*)pos=MOVW(temp1, ((Bit32u)fct_ptr) & 0xffff);      // movw temp1, #(fct_ptr & 0xffff)
+			*(Bit32u*)(pos+4)=MOVT(temp1, ((Bit32u)fct_ptr) >> 16);      // movt temp1, #(fct_ptr >> 16)
+#else
 			*(Bit32u*)(pos+12)=(Bit32u)fct_ptr;		// simple_func
+#endif
 			break;
 
 	}
 #else
+#if C_TARGETCPU == ARMV7LE
+	*(Bit32u*)pos=MOVW(temp1, ((Bit32u)fct_ptr) & 0xffff);      // movw temp1, #(fct_ptr & 0xffff)
+	*(Bit32u*)(pos+4)=MOVT(temp1, ((Bit32u)fct_ptr) >> 16);      // movt temp1, #(fct_ptr >> 16)
+#else
 	*(Bit32u*)(pos+12)=(Bit32u)fct_ptr;		// simple_func
 #endif
+#endif
 }
 #endif
 
@@ -1044,7 +1263,7 @@
 // the upper 24bit of the destination register can be destroyed
 // this function can use FC_OP1/FC_OP2 as dest_reg which are
 // not directly byte-accessible on some architectures
-static void INLINE gen_mov_regbyte_to_reg_low_canuseword(HostReg dest_reg,Bitu index) {
+static void gen_mov_regbyte_to_reg_low_canuseword(HostReg dest_reg,Bitu index) {
 	cache_addd( LDRB_IMM(dest_reg, FC_REGS_ADDR, index) );      // ldrb dest_reg, [FC_REGS_ADDR, #index]
 }
 
diff -Nur dosbox-0.74/src/cpu/core_dynrec/risc_armv4le-s3.h dosbox-0.74.patch/src/cpu/core_dynrec/risc_armv4le-s3.h
--- dosbox-0.74/src/cpu/core_dynrec/risc_armv4le-s3.h	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/cpu/core_dynrec/risc_armv4le-s3.h	1970-01-01 01:00:00.000000000 +0100
@@ -1,919 +0,0 @@
-/*
- *  Copyright (C) 2002-2010  The DOSBox Team
- *
- *  This program is free software; you can redistribute it and/or modify
- *  it under the terms of the GNU General Public License as published by
- *  the Free Software Foundation; either version 2 of the License, or
- *  (at your option) any later version.
- *
- *  This program is distributed in the hope that it will be useful,
- *  but WITHOUT ANY WARRANTY; without even the implied warranty of
- *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
- *  GNU General Public License for more details.
- *
- *  You should have received a copy of the GNU General Public License
- *  along with this program; if not, write to the Free Software
- *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
- */
-
-/* $Id: risc_armv4le-s3.h,v 1.6 2009-06-27 12:51:10 c2woody Exp $ */
-
-
-/* ARMv4 (little endian) backend by M-HT (speed-tweaked arm version) */
-
-
-// temporary registers
-#define temp1 HOST_ip
-#define temp2 HOST_v3
-#define temp3 HOST_v4
-
-// register that holds function return values
-#define FC_RETOP HOST_a1
-
-// register used for address calculations,
-#define FC_ADDR HOST_v1			// has to be saved across calls, see DRC_PROTECT_ADDR_REG
-
-// register that holds the first parameter
-#define FC_OP1 HOST_a1
-
-// register that holds the second parameter
-#define FC_OP2 HOST_a2
-
-// special register that holds the third parameter for _R3 calls (byte accessible)
-#define FC_OP3 HOST_v2
-
-// register that holds byte-accessible temporary values
-#define FC_TMP_BA1 HOST_a1
-
-// register that holds byte-accessible temporary values
-#define FC_TMP_BA2 HOST_a2
-
-// temporary register for LEA
-#define TEMP_REG_DRC HOST_v2
-
-#ifdef DRC_USE_REGS_ADDR
-// used to hold the address of "cpu_regs" - preferably filled in function gen_run_code
-#define FC_REGS_ADDR HOST_v7
-#endif
-
-#ifdef DRC_USE_SEGS_ADDR
-// used to hold the address of "Segs" - preferably filled in function gen_run_code
-#define FC_SEGS_ADDR HOST_v8
-#endif
-
-
-// helper macro
-#define ROTATE_SCALE(x) ( (x)?(32 - x):(0) )
-
-
-// instruction encodings
-
-// move
-// mov dst, #(imm ror rimm)		@	0 <= imm <= 255	&	rimm mod 2 = 0
-#define MOV_IMM(dst, imm, rimm) (0xe3a00000 + ((dst) << 12) + (imm) + ((rimm) << 7) )
-// mov dst, src, lsl #imm
-#define MOV_REG_LSL_IMM(dst, src, imm) (0xe1a00000 + ((dst) << 12) + (src) + ((imm) << 7) )
-// movs dst, src, lsl #imm
-#define MOVS_REG_LSL_IMM(dst, src, imm) (0xe1b00000 + ((dst) << 12) + (src) + ((imm) << 7) )
-// mov dst, src, lsr #imm
-#define MOV_REG_LSR_IMM(dst, src, imm) (0xe1a00020 + ((dst) << 12) + (src) + ((imm) << 7) )
-// mov dst, src, asr #imm
-#define MOV_REG_ASR_IMM(dst, src, imm) (0xe1a00040 + ((dst) << 12) + (src) + ((imm) << 7) )
-// mov dst, src, lsl rreg
-#define MOV_REG_LSL_REG(dst, src, rreg) (0xe1a00010 + ((dst) << 12) + (src) + ((rreg) << 8) )
-// mov dst, src, lsr rreg
-#define MOV_REG_LSR_REG(dst, src, rreg) (0xe1a00030 + ((dst) << 12) + (src) + ((rreg) << 8) )
-// mov dst, src, asr rreg
-#define MOV_REG_ASR_REG(dst, src, rreg) (0xe1a00050 + ((dst) << 12) + (src) + ((rreg) << 8) )
-// mov dst, src, ror rreg
-#define MOV_REG_ROR_REG(dst, src, rreg) (0xe1a00070 + ((dst) << 12) + (src) + ((rreg) << 8) )
-// mvn dst, #(imm ror rimm)		@	0 <= imm <= 255	&	rimm mod 2 = 0
-#define MVN_IMM(dst, imm, rimm) (0xe3e00000 + ((dst) << 12) + (imm) + ((rimm) << 7) )
-
-// arithmetic
-// add dst, src, #(imm ror rimm)		@	0 <= imm <= 255	&	rimm mod 2 = 0
-#define ADD_IMM(dst, src, imm, rimm) (0xe2800000 + ((dst) << 12) + ((src) << 16) + (imm) + ((rimm) << 7) )
-// add dst, src1, src2, lsl #imm
-#define ADD_REG_LSL_IMM(dst, src1, src2, imm) (0xe0800000 + ((dst) << 12) + ((src1) << 16) + (src2) + ((imm) << 7) )
-// sub dst, src, #(imm ror rimm)		@	0 <= imm <= 255	&	rimm mod 2 = 0
-#define SUB_IMM(dst, src, imm, rimm) (0xe2400000 + ((dst) << 12) + ((src) << 16) + (imm) + ((rimm) << 7) )
-// sub dst, src1, src2, lsl #imm
-#define SUB_REG_LSL_IMM(dst, src1, src2, imm) (0xe0400000 + ((dst) << 12) + ((src1) << 16) + (src2) + ((imm) << 7) )
-// rsb dst, src, #(imm ror rimm)		@	0 <= imm <= 255	&	rimm mod 2 = 0
-#define RSB_IMM(dst, src, imm, rimm) (0xe2600000 + ((dst) << 12) + ((src) << 16) + (imm) + ((rimm) << 7) )
-// cmp src, #(imm ror rimm)		@	0 <= imm <= 255	&	rimm mod 2 = 0
-#define CMP_IMM(src, imm, rimm) (0xe3500000 + ((src) << 16) + (imm) + ((rimm) << 7) )
-// nop
-#define NOP MOV_REG_LSL_IMM(HOST_r0, HOST_r0, 0)
-
-// logical
-// tst src, #(imm ror rimm)		@	0 <= imm <= 255	&	rimm mod 2 = 0
-#define TST_IMM(src, imm, rimm) (0xe3100000 + ((src) << 16) + (imm) + ((rimm) << 7) )
-// and dst, src, #(imm ror rimm)		@	0 <= imm <= 255	&	rimm mod 2 = 0
-#define AND_IMM(dst, src, imm, rimm) (0xe2000000 + ((dst) << 12) + ((src) << 16) + (imm) + ((rimm) << 7) )
-// and dst, src1, src2, lsl #imm
-#define AND_REG_LSL_IMM(dst, src1, src2, imm) (0xe0000000 + ((dst) << 12) + ((src1) << 16) + (src2) + ((imm) << 7) )
-// orr dst, src, #(imm ror rimm)		@	0 <= imm <= 255	&	rimm mod 2 = 0
-#define ORR_IMM(dst, src, imm, rimm) (0xe3800000 + ((dst) << 12) + ((src) << 16) + (imm) + ((rimm) << 7) )
-// orr dst, src1, src2, lsl #imm
-#define ORR_REG_LSL_IMM(dst, src1, src2, imm) (0xe1800000 + ((dst) << 12) + ((src1) << 16) + (src2) + ((imm) << 7) )
-// orr dst, src1, src2, lsr #imm
-#define ORR_REG_LSR_IMM(dst, src1, src2, imm) (0xe1800020 + ((dst) << 12) + ((src1) << 16) + (src2) + ((imm) << 7) )
-// eor dst, src1, src2, lsl #imm
-#define EOR_REG_LSL_IMM(dst, src1, src2, imm) (0xe0200000 + ((dst) << 12) + ((src1) << 16) + (src2) + ((imm) << 7) )
-// bic dst, src, #(imm ror rimm)		@	0 <= imm <= 255	&	rimm mod 2 = 0
-#define BIC_IMM(dst, src, imm, rimm) (0xe3c00000 + ((dst) << 12) + ((src) << 16) + (imm) + ((rimm) << 7) )
-
-// load
-// ldr reg, [addr, #imm]		@	0 <= imm < 4096
-#define LDR_IMM(reg, addr, imm) (0xe5900000 + ((reg) << 12) + ((addr) << 16) + (imm) )
-// ldrh reg, [addr, #imm]		@	0 <= imm < 256
-#define LDRH_IMM(reg, addr, imm) (0xe1d000b0 + ((reg) << 12) + ((addr) << 16) + (((imm) & 0xf0) << 4) + ((imm) & 0x0f) )
-// ldrb reg, [addr, #imm]		@	0 <= imm < 4096
-#define LDRB_IMM(reg, addr, imm) (0xe5d00000 + ((reg) << 12) + ((addr) << 16) + (imm) )
-
-// store
-// str reg, [addr, #imm]		@	0 <= imm < 4096
-#define STR_IMM(reg, addr, imm) (0xe5800000 + ((reg) << 12) + ((addr) << 16) + (imm) )
-// strh reg, [addr, #imm]		@	0 <= imm < 256
-#define STRH_IMM(reg, addr, imm) (0xe1c000b0 + ((reg) << 12) + ((addr) << 16) + (((imm) & 0xf0) << 4) + ((imm) & 0x0f) )
-// strb reg, [addr, #imm]		@	0 <= imm < 4096
-#define STRB_IMM(reg, addr, imm) (0xe5c00000 + ((reg) << 12) + ((addr) << 16) + (imm) )
-
-// branch
-// beq pc+imm		@	0 <= imm < 32M	&	imm mod 4 = 0
-#define BEQ_FWD(imm) (0x0a000000 + ((imm) >> 2) )
-// bne pc+imm		@	0 <= imm < 32M	&	imm mod 4 = 0
-#define BNE_FWD(imm) (0x1a000000 + ((imm) >> 2) )
-// bgt pc+imm		@	0 <= imm < 32M	&	imm mod 4 = 0
-#define BGT_FWD(imm) (0xca000000 + ((imm) >> 2) )
-// b pc+imm		@	0 <= imm < 32M	&	imm mod 4 = 0
-#define B_FWD(imm) (0xea000000 + ((imm) >> 2) )
-// bx reg
-#define BX(reg) (0xe12fff10 + (reg) )
-
-
-// move a full register from reg_src to reg_dst
-static void gen_mov_regs(HostReg reg_dst,HostReg reg_src) {
-	if(reg_src == reg_dst) return;
-	cache_addd( MOV_REG_LSL_IMM(reg_dst, reg_src, 0) );      // mov reg_dst, reg_src
-}
-
-// move a 32bit constant value into dest_reg
-static void gen_mov_dword_to_reg_imm(HostReg dest_reg,Bit32u imm) {
-	Bits first, scale;
-	if (imm == 0) {
-		cache_addd( MOV_IMM(dest_reg, 0, 0) );      // mov dest_reg, #0
-	} else {
-		scale = 0;
-		first = 1;
-		while (imm) {
-			while ((imm & 3) == 0) {
-				imm>>=2;
-				scale+=2;
-			}
-			if (first) {
-				cache_addd( MOV_IMM(dest_reg, imm & 0xff, ROTATE_SCALE(scale)) );      // mov dest_reg, #((imm & 0xff) << scale)
-				first = 0;
-			} else {
-				cache_addd( ORR_IMM(dest_reg, dest_reg, imm & 0xff, ROTATE_SCALE(scale)) );      // orr dest_reg, dest_reg, #((imm & 0xff) << scale)
-			}
-			imm>>=8;
-			scale+=8;
-		}
-	}
-}
-
-// helper function for gen_mov_word_to_reg
-static void gen_mov_word_to_reg_helper(HostReg dest_reg,void* data,bool dword,HostReg data_reg) {
-	// alignment....
-	if (dword) {
-		if ((Bit32u)data & 3) {
-			if ( ((Bit32u)data & 3) == 2 ) {
-				cache_addd( LDRH_IMM(dest_reg, data_reg, 0) );      // ldrh dest_reg, [data_reg]
-				cache_addd( LDRH_IMM(temp2, data_reg, 2) );      // ldrh temp2, [data_reg, #2]
-				cache_addd( ORR_REG_LSL_IMM(dest_reg, dest_reg, temp2, 16) );      // orr dest_reg, dest_reg, temp2, lsl #16
-			} else {
-				cache_addd( LDRB_IMM(dest_reg, data_reg, 0) );      // ldrb dest_reg, [data_reg]
-				cache_addd( LDRH_IMM(temp2, data_reg, 1) );      // ldrh temp2, [data_reg, #1]
-				cache_addd( ORR_REG_LSL_IMM(dest_reg, dest_reg, temp2, 8) );      // orr dest_reg, dest_reg, temp2, lsl #8
-				cache_addd( LDRB_IMM(temp2, data_reg, 3) );      // ldrb temp2, [data_reg, #3]
-				cache_addd( ORR_REG_LSL_IMM(dest_reg, dest_reg, temp2, 24) );      // orr dest_reg, dest_reg, temp2, lsl #24
-			}
-		} else {
-			cache_addd( LDR_IMM(dest_reg, data_reg, 0) );      // ldr dest_reg, [data_reg]
-		}
-	} else {
-		if ((Bit32u)data & 1) {
-			cache_addd( LDRB_IMM(dest_reg, data_reg, 0) );      // ldrb dest_reg, [data_reg]
-			cache_addd( LDRB_IMM(temp2, data_reg, 1) );      // ldrb temp2, [data_reg, #1]
-			cache_addd( ORR_REG_LSL_IMM(dest_reg, dest_reg, temp2, 8) );      // orr dest_reg, dest_reg, temp2, lsl #8
-		} else {
-			cache_addd( LDRH_IMM(dest_reg, data_reg, 0) );      // ldrh dest_reg, [data_reg]
-		}
-	}
-}
-
-// move a 32bit (dword==true) or 16bit (dword==false) value from memory into dest_reg
-// 16bit moves may destroy the upper 16bit of the destination register
-static void gen_mov_word_to_reg(HostReg dest_reg,void* data,bool dword) {
-	gen_mov_dword_to_reg_imm(temp1, (Bit32u)data);
-	gen_mov_word_to_reg_helper(dest_reg, data, dword, temp1);
-}
-
-// move a 16bit constant value into dest_reg
-// the upper 16bit of the destination register may be destroyed
-static void INLINE gen_mov_word_to_reg_imm(HostReg dest_reg,Bit16u imm) {
-	gen_mov_dword_to_reg_imm(dest_reg, (Bit32u)imm);
-}
-
-// helper function for gen_mov_word_from_reg
-static void gen_mov_word_from_reg_helper(HostReg src_reg,void* dest,bool dword, HostReg data_reg) {
-	// alignment....
-	if (dword) {
-		if ((Bit32u)dest & 3) {
-			if ( ((Bit32u)dest & 3) == 2 ) {
-				cache_addd( STRH_IMM(src_reg, data_reg, 0) );      // strh src_reg, [data_reg]
-				cache_addd( MOV_REG_LSR_IMM(temp2, src_reg, 16) );      // mov temp2, src_reg, lsr #16
-				cache_addd( STRH_IMM(temp2, data_reg, 2) );      // strh temp2, [data_reg, #2]
-			} else {
-				cache_addd( STRB_IMM(src_reg, data_reg, 0) );      // strb src_reg, [data_reg]
-				cache_addd( MOV_REG_LSR_IMM(temp2, src_reg, 8) );      // mov temp2, src_reg, lsr #8
-				cache_addd( STRH_IMM(temp2, data_reg, 1) );      // strh temp2, [data_reg, #1]
-				cache_addd( MOV_REG_LSR_IMM(temp2, temp2, 16) );      // mov temp2, temp2, lsr #16
-				cache_addd( STRB_IMM(temp2, data_reg, 3) );      // strb temp2, [data_reg, #3]
-			}
-		} else {
-			cache_addd( STR_IMM(src_reg, data_reg, 0) );      // str src_reg, [data_reg]
-		}
-	} else {
-		if ((Bit32u)dest & 1) {
-			cache_addd( STRB_IMM(src_reg, data_reg, 0) );      // strb src_reg, [data_reg]
-			cache_addd( MOV_REG_LSR_IMM(temp2, src_reg, 8) );      // mov temp2, src_reg, lsr #8
-			cache_addd( STRB_IMM(temp2, data_reg, 1) );      // strb temp2, [data_reg, #1]
-		} else {
-			cache_addd( STRH_IMM(src_reg, data_reg, 0) );      // strh src_reg, [data_reg]
-		}
-	}
-}
-
-// move 32bit (dword==true) or 16bit (dword==false) of a register into memory
-static void gen_mov_word_from_reg(HostReg src_reg,void* dest,bool dword) {
-	gen_mov_dword_to_reg_imm(temp1, (Bit32u)dest);
-	gen_mov_word_from_reg_helper(src_reg, dest, dword, temp1);
-}
-
-// move an 8bit value from memory into dest_reg
-// the upper 24bit of the destination register can be destroyed
-// this function does not use FC_OP1/FC_OP2 as dest_reg as these
-// registers might not be directly byte-accessible on some architectures
-static void gen_mov_byte_to_reg_low(HostReg dest_reg,void* data) {
-	gen_mov_dword_to_reg_imm(temp1, (Bit32u)data);
-	cache_addd( LDRB_IMM(dest_reg, temp1, 0) );      // ldrb dest_reg, [temp1]
-}
-
-// move an 8bit value from memory into dest_reg
-// the upper 24bit of the destination register can be destroyed
-// this function can use FC_OP1/FC_OP2 as dest_reg which are
-// not directly byte-accessible on some architectures
-static void INLINE gen_mov_byte_to_reg_low_canuseword(HostReg dest_reg,void* data) {
-	gen_mov_byte_to_reg_low(dest_reg, data);
-}
-
-// move an 8bit constant value into dest_reg
-// the upper 24bit of the destination register can be destroyed
-// this function does not use FC_OP1/FC_OP2 as dest_reg as these
-// registers might not be directly byte-accessible on some architectures
-static void gen_mov_byte_to_reg_low_imm(HostReg dest_reg,Bit8u imm) {
-	cache_addd( MOV_IMM(dest_reg, imm, 0) );      // mov dest_reg, #(imm)
-}
-
-// move an 8bit constant value into dest_reg
-// the upper 24bit of the destination register can be destroyed
-// this function can use FC_OP1/FC_OP2 as dest_reg which are
-// not directly byte-accessible on some architectures
-static void INLINE gen_mov_byte_to_reg_low_imm_canuseword(HostReg dest_reg,Bit8u imm) {
-	gen_mov_byte_to_reg_low_imm(dest_reg, imm);
-}
-
-// move the lowest 8bit of a register into memory
-static void gen_mov_byte_from_reg_low(HostReg src_reg,void* dest) {
-	gen_mov_dword_to_reg_imm(temp1, (Bit32u)dest);
-	cache_addd( STRB_IMM(src_reg, temp1, 0) );      // strb src_reg, [temp1]
-}
-
-
-
-// convert an 8bit word to a 32bit dword
-// the register is zero-extended (sign==false) or sign-extended (sign==true)
-static void gen_extend_byte(bool sign,HostReg reg) {
-	if (sign) {
-		cache_addd( MOV_REG_LSL_IMM(reg, reg, 24) );      // mov reg, reg, lsl #24
-		cache_addd( MOV_REG_ASR_IMM(reg, reg, 24) );      // mov reg, reg, asr #24
-	} else {
-		cache_addd( AND_IMM(reg, reg, 0xff, 0) );      // and reg, reg, #0xff
-	}
-}
-
-// convert a 16bit word to a 32bit dword
-// the register is zero-extended (sign==false) or sign-extended (sign==true)
-static void gen_extend_word(bool sign,HostReg reg) {
-	if (sign) {
-		cache_addd( MOV_REG_LSL_IMM(reg, reg, 16) );      // mov reg, reg, lsl #16
-		cache_addd( MOV_REG_ASR_IMM(reg, reg, 16) );      // mov reg, reg, asr #16
-	} else {
-		cache_addd( MOV_REG_LSL_IMM(reg, reg, 16) );      // mov reg, reg, lsl #16
-		cache_addd( MOV_REG_LSR_IMM(reg, reg, 16) );      // mov reg, reg, lsr #16
-	}
-}
-
-// add a 32bit value from memory to a full register
-static void gen_add(HostReg reg,void* op) {
-	gen_mov_word_to_reg(temp3, op, 1);
-	cache_addd( ADD_REG_LSL_IMM(reg, reg, temp3, 0) );      // add reg, reg, temp3
-}
-
-// add a 32bit constant value to a full register
-static void gen_add_imm(HostReg reg,Bit32u imm) {
-	Bits scale;
-	if(!imm) return;
-	if (imm == 0xffffffff) {
-		cache_addd( SUB_IMM(reg, reg, 1, 0) );      // sub reg, reg, #1
-	} else {
-		scale = 0;
-		while (imm) {
-			while ((imm & 3) == 0) {
-				imm>>=2;
-				scale+=2;
-			}
-			cache_addd( ADD_IMM(reg, reg, imm & 0xff, ROTATE_SCALE(scale)) );      // add reg, reg, #((imm & 0xff) << scale)
-			imm>>=8;
-			scale+=8;
-		}
-	}
-}
-
-// and a 32bit constant value with a full register
-static void gen_and_imm(HostReg reg,Bit32u imm) {
-	Bits scale;
-	Bit32u imm2;
-	imm2 = ~imm;
-	if(!imm2) return;
-	if (!imm) {
-		cache_addd( MOV_IMM(reg, 0, 0) );      // mov reg, #0
-	} else {
-		scale = 0;
-		while (imm2) {
-			while ((imm2 & 3) == 0) {
-				imm2>>=2;
-				scale+=2;
-			}
-			cache_addd( BIC_IMM(reg, reg, imm2 & 0xff, ROTATE_SCALE(scale)) );      // bic reg, reg, #((imm2 & 0xff) << scale)
-			imm2>>=8;
-			scale+=8;
-		}
-	}
-}
-
-
-// move a 32bit constant value into memory
-static void gen_mov_direct_dword(void* dest,Bit32u imm) {
-	gen_mov_dword_to_reg_imm(temp3, imm);
-	gen_mov_word_from_reg(temp3, dest, 1);
-}
-
-// move an address into memory
-static void INLINE gen_mov_direct_ptr(void* dest,DRC_PTR_SIZE_IM imm) {
-	gen_mov_direct_dword(dest,(Bit32u)imm);
-}
-
-// add an 8bit constant value to a dword memory value
-static void gen_add_direct_byte(void* dest,Bit8s imm) {
-	if(!imm) return;
-	gen_mov_dword_to_reg_imm(temp1, (Bit32u)dest);
-	gen_mov_word_to_reg_helper(temp3, dest, 1, temp1);
-	if (imm >= 0) {
-		cache_addd( ADD_IMM(temp3, temp3, (Bit32s)imm, 0) );      // add temp3, temp3, #(imm)
-	} else {
-		cache_addd( SUB_IMM(temp3, temp3, -((Bit32s)imm), 0) );      // sub temp3, temp3, #(-imm)
-	}
-	gen_mov_word_from_reg_helper(temp3, dest, 1, temp1);
-}
-
-// add a 32bit (dword==true) or 16bit (dword==false) constant value to a memory value
-static void gen_add_direct_word(void* dest,Bit32u imm,bool dword) {
-	if(!imm) return;
-	if (dword && ( (imm<128) || (imm>=0xffffff80) ) ) {
-		gen_add_direct_byte(dest,(Bit8s)imm);
-		return;
-	}
-	gen_mov_dword_to_reg_imm(temp1, (Bit32u)dest);
-	gen_mov_word_to_reg_helper(temp3, dest, dword, temp1);
-	// maybe use function gen_add_imm
-	if (dword) {
-		gen_mov_dword_to_reg_imm(temp2, imm);
-	} else {
-		gen_mov_word_to_reg_imm(temp2, (Bit16u)imm);
-	}
-	cache_addd( ADD_REG_LSL_IMM(temp3, temp3, temp2, 0) );      // add temp3, temp3, temp2
-	gen_mov_word_from_reg_helper(temp3, dest, dword, temp1);
-}
-
-// subtract an 8bit constant value from a dword memory value
-static void gen_sub_direct_byte(void* dest,Bit8s imm) {
-	if(!imm) return;
-	gen_mov_dword_to_reg_imm(temp1, (Bit32u)dest);
-	gen_mov_word_to_reg_helper(temp3, dest, 1, temp1);
-	if (imm >= 0) {
-		cache_addd( SUB_IMM(temp3, temp3, (Bit32s)imm, 0) );      // sub temp3, temp3, #(imm)
-	} else {
-		cache_addd( ADD_IMM(temp3, temp3, -((Bit32s)imm), 0) );      // add temp3, temp3, #(-imm)
-	}
-	gen_mov_word_from_reg_helper(temp3, dest, 1, temp1);
-}
-
-// subtract a 32bit (dword==true) or 16bit (dword==false) constant value from a memory value
-static void gen_sub_direct_word(void* dest,Bit32u imm,bool dword) {
-	if(!imm) return;
-	if (dword && ( (imm<128) || (imm>=0xffffff80) ) ) {
-		gen_sub_direct_byte(dest,(Bit8s)imm);
-		return;
-	}
-	gen_mov_dword_to_reg_imm(temp1, (Bit32u)dest);
-	gen_mov_word_to_reg_helper(temp3, dest, dword, temp1);
-	// maybe use function gen_add_imm/gen_sub_imm
-	if (dword) {
-		gen_mov_dword_to_reg_imm(temp2, imm);
-	} else {
-		gen_mov_word_to_reg_imm(temp2, (Bit16u)imm);
-	}
-	cache_addd( SUB_REG_LSL_IMM(temp3, temp3, temp2, 0) );      // sub temp3, temp3, temp2
-	gen_mov_word_from_reg_helper(temp3, dest, dword, temp1);
-}
-
-// effective address calculation, destination is dest_reg
-// scale_reg is scaled by scale (scale_reg*(2^scale)) and
-// added to dest_reg, then the immediate value is added
-static INLINE void gen_lea(HostReg dest_reg,HostReg scale_reg,Bitu scale,Bits imm) {
-	cache_addd( ADD_REG_LSL_IMM(dest_reg, dest_reg, scale_reg, scale) );      // add dest_reg, dest_reg, scale_reg, lsl #(scale)
-	gen_add_imm(dest_reg, imm);
-}
-
-// effective address calculation, destination is dest_reg
-// dest_reg is scaled by scale (dest_reg*(2^scale)),
-// then the immediate value is added
-static INLINE void gen_lea(HostReg dest_reg,Bitu scale,Bits imm) {
-	if (scale) {
-		cache_addd( MOV_REG_LSL_IMM(dest_reg, dest_reg, scale) );      // mov dest_reg, dest_reg, lsl #(scale)
-	}
-	gen_add_imm(dest_reg, imm);
-}
-
-// generate a call to a parameterless function
-static void INLINE gen_call_function_raw(void * func) {
-	cache_addd( LDR_IMM(temp1, HOST_pc, 4) );      // ldr temp1, [pc, #4]
-	cache_addd( ADD_IMM(HOST_lr, HOST_pc, 4, 0) );      // add lr, pc, #4
-	cache_addd( BX(temp1) );      // bx temp1
-	cache_addd((Bit32u)func);      // .int func
-}
-
-// generate a call to a function with paramcount parameters
-// note: the parameters are loaded in the architecture specific way
-// using the gen_load_param_ functions below
-static Bit32u INLINE gen_call_function_setup(void * func,Bitu paramcount,bool fastcall=false) {
-	Bit32u proc_addr = (Bit32u)cache.pos;
-	gen_call_function_raw(func);
-	return proc_addr;
-}
-
-#if (1)
-// max of 4 parameters in a1-a4
-
-// load an immediate value as param'th function parameter
-static void INLINE gen_load_param_imm(Bitu imm,Bitu param) {
-	gen_mov_dword_to_reg_imm(param, imm);
-}
-
-// load an address as param'th function parameter
-static void INLINE gen_load_param_addr(Bitu addr,Bitu param) {
-	gen_mov_dword_to_reg_imm(param, addr);
-}
-
-// load a host-register as param'th function parameter
-static void INLINE gen_load_param_reg(Bitu reg,Bitu param) {
-	gen_mov_regs(param, reg);
-}
-
-// load a value from memory as param'th function parameter
-static void INLINE gen_load_param_mem(Bitu mem,Bitu param) {
-	gen_mov_word_to_reg(param, (void *)mem, 1);
-}
-#else
-	other arm abis
-#endif
-
-// jump to an address pointed at by ptr, offset is in imm
-static void gen_jmp_ptr(void * ptr,Bits imm=0) {
-	Bits scale;
-	Bitu imm2;
-	gen_mov_word_to_reg(temp3, ptr, 1);
-
-	if (imm) {
-		scale = 0;
-		imm2 = (Bitu)imm;
-		while (imm2) {
-			while ((imm2 & 3) == 0) {
-				imm2>>=2;
-				scale+=2;
-			}
-			cache_addd( ADD_IMM(temp3, temp3, imm2 & 0xff, ROTATE_SCALE(scale)) );      // add temp3, temp3, #((imm2 & 0xff) << scale)
-			imm2>>=8;
-			scale+=8;
-		}
-	}
-
-#if (1)
-// (*ptr) should be word aligned 
-	if ((imm & 0x03) == 0) {
-		cache_addd( LDR_IMM(temp1, temp3, 0) );      // ldr temp1, [temp3]
-	} else
-#endif
-	{
-		cache_addd( LDRB_IMM(temp1, temp3, 0) );      // ldrb temp1, [temp3]
-		cache_addd( LDRB_IMM(temp2, temp3, 1) );      // ldrb temp2, [temp3, #1]
-		cache_addd( ORR_REG_LSL_IMM(temp1, temp1, temp2, 8) );      // orr temp1, temp1, temp2, lsl #8
-		cache_addd( LDRB_IMM(temp2, temp3, 2) );      // ldrb temp2, [temp3, #2]
-		cache_addd( ORR_REG_LSL_IMM(temp1, temp1, temp2, 16) );      // orr temp1, temp1, temp2, lsl #16
-		cache_addd( LDRB_IMM(temp2, temp3, 3) );      // ldrb temp2, [temp3, #3]
-		cache_addd( ORR_REG_LSL_IMM(temp1, temp1, temp2, 24) );      // orr temp1, temp1, temp2, lsl #24
-	}
-
-	cache_addd( BX(temp1) );      // bx temp1
-}
-
-// short conditional jump (+-127 bytes) if register is zero
-// the destination is set by gen_fill_branch() later
-static Bit32u gen_create_branch_on_zero(HostReg reg,bool dword) {
-	if (dword) {
-		cache_addd( CMP_IMM(reg, 0, 0) );      // cmp reg, #0
-	} else {
-		cache_addd( MOVS_REG_LSL_IMM(temp1, reg, 16) );      // movs temp1, reg, lsl #16
-	}
-	cache_addd( BEQ_FWD(0) );      // beq j
-	return ((Bit32u)cache.pos-4);
-}
-
-// short conditional jump (+-127 bytes) if register is nonzero
-// the destination is set by gen_fill_branch() later
-static Bit32u gen_create_branch_on_nonzero(HostReg reg,bool dword) {
-	if (dword) {
-		cache_addd( CMP_IMM(reg, 0, 0) );      // cmp reg, #0
-	} else {
-		cache_addd( MOVS_REG_LSL_IMM(temp1, reg, 16) );      // movs temp1, reg, lsl #16
-	}
-	cache_addd( BNE_FWD(0) );      // bne j
-	return ((Bit32u)cache.pos-4);
-}
-
-// calculate relative offset and fill it into the location pointed to by data
-static void INLINE gen_fill_branch(DRC_PTR_SIZE_IM data) {
-#if C_DEBUG
-	Bits len=(Bit32u)cache.pos-(data+8);
-	if (len<0) len=-len;
-	if (len>0x02000000) LOG_MSG("Big jump %d",len);
-#endif
-	*(Bit32u*)data=( (*(Bit32u*)data) & 0xff000000 ) | ( ( ((Bit32u)cache.pos - (data+8)) >> 2 ) & 0x00ffffff );
-}
-
-// conditional jump if register is nonzero
-// for isdword==true the 32bit of the register are tested
-// for isdword==false the lowest 8bit of the register are tested
-static Bit32u gen_create_branch_long_nonzero(HostReg reg,bool isdword) {
-	if (isdword) {
-		cache_addd( CMP_IMM(reg, 0, 0) );      // cmp reg, #0
-	} else {
-		cache_addd( TST_IMM(reg, 0xff, 0) );      // tst reg, #0xff
-	}
-	cache_addd( BEQ_FWD(8) );      // beq nobranch (pc +8)
-	cache_addd( LDR_IMM(temp1, HOST_pc, 0) );      // ldr temp1, [pc, #0]
-	cache_addd( BX(temp1) );      // bx temp1
-	cache_addd(0);      // fill j
-	// nobranch:
-	return ((Bit32u)cache.pos-4);
-}
-
-// compare 32bit-register against zero and jump if value less/equal than zero
-static Bit32u gen_create_branch_long_leqzero(HostReg reg) {
-	cache_addd( CMP_IMM(reg, 0, 0) );      // cmp reg, #0
-	cache_addd( BGT_FWD(8) );      // bgt nobranch (pc+8)
-	cache_addd( LDR_IMM(temp1, HOST_pc, 0) );      // ldr temp1, [pc, #0]
-	cache_addd( BX(temp1) );      // bx temp1
-	cache_addd(0);      // fill j
-	// nobranch:
-	return ((Bit32u)cache.pos-4);
-}
-
-// calculate long relative offset and fill it into the location pointed to by data
-static void INLINE gen_fill_branch_long(Bit32u data) {
-	// this is an absolute branch
-	*(Bit32u*)data=(Bit32u)cache.pos;
-}
-
-static void gen_run_code(void) {
-	cache_addd(0xe92d4000);			// stmfd sp!, {lr}
-	cache_addd(0xe92d0cf0);			// stmfd sp!, {v1-v4,v7,v8}
-
-	// adr: 8
-	cache_addd( LDR_IMM(FC_SEGS_ADDR, HOST_pc, 64 - (8 + 8)) );      // ldr FC_SEGS_ADDR, [pc, #(&Segs)]
-	// adr: 12
-	cache_addd( LDR_IMM(FC_REGS_ADDR, HOST_pc, 68 - (12 + 8)) );      // ldr FC_REGS_ADDR, [pc, #(&cpu_regs)]
-
-	cache_addd( ADD_IMM(HOST_lr, HOST_pc, 4, 0) );			// add lr, pc, #4
-	cache_addd(0xe92d4000);			// stmfd sp!, {lr}
-	cache_addd( BX(HOST_r0) );			// bx r0	
-
-	cache_addd(0xe8bd0cf0);			// ldmfd sp!, {v1-v4,v7,v8}
-
-	cache_addd(0xe8bd4000);			// ldmfd sp!, {lr}
-	cache_addd( BX(HOST_lr) );			// bx lr
-
-	// fill up to 64 bytes
-	cache_addd( NOP );			// nop
-	cache_addd( NOP );			// nop
-	cache_addd( NOP );			// nop
-	cache_addd( NOP );			// nop
-	cache_addd( NOP );			// nop
-	cache_addd( NOP );			// nop
-
-	// adr: 64
-	cache_addd((Bit32u)&Segs);      // address of "Segs"
-	// adr: 68
-	cache_addd((Bit32u)&cpu_regs);  // address of "cpu_regs"
-}
-
-// return from a function
-static void gen_return_function(void) {
-	cache_addd(0xe8bd4000);			// ldmfd sp!, {lr}
-	cache_addd( BX(HOST_lr) );			// bx lr
-}
-
-#ifdef DRC_FLAGS_INVALIDATION
-
-// called when a call to a function can be replaced by a
-// call to a simpler function
-static void gen_fill_function_ptr(Bit8u * pos,void* fct_ptr,Bitu flags_type) {
-#ifdef DRC_FLAGS_INVALIDATION_DCODE
-	// try to avoid function calls but rather directly fill in code
-	switch (flags_type) {
-		case t_ADDb:
-		case t_ADDw:
-		case t_ADDd:
-			*(Bit32u*)pos=ADD_REG_LSL_IMM(FC_RETOP, HOST_a1, HOST_a2, 0);	// add FC_RETOP, a1, a2
-			*(Bit32u*)(pos+4)=NOP;				// nop
-			*(Bit32u*)(pos+8)=NOP;				// nop
-			*(Bit32u*)(pos+12)=NOP;				// nop
-			break;
-		case t_ORb:
-		case t_ORw:
-		case t_ORd:
-			*(Bit32u*)pos=ORR_REG_LSL_IMM(FC_RETOP, HOST_a1, HOST_a2, 0);	// orr FC_RETOP, a1, a2
-			*(Bit32u*)(pos+4)=NOP;				// nop
-			*(Bit32u*)(pos+8)=NOP;				// nop
-			*(Bit32u*)(pos+12)=NOP;				// nop
-			break;
-		case t_ANDb:
-		case t_ANDw:
-		case t_ANDd:
-			*(Bit32u*)pos=AND_REG_LSL_IMM(FC_RETOP, HOST_a1, HOST_a2, 0);	// and FC_RETOP, a1, a2
-			*(Bit32u*)(pos+4)=NOP;				// nop
-			*(Bit32u*)(pos+8)=NOP;				// nop
-			*(Bit32u*)(pos+12)=NOP;				// nop
-			break;
-		case t_SUBb:
-		case t_SUBw:
-		case t_SUBd:
-			*(Bit32u*)pos=SUB_REG_LSL_IMM(FC_RETOP, HOST_a1, HOST_a2, 0);	// sub FC_RETOP, a1, a2
-			*(Bit32u*)(pos+4)=NOP;				// nop
-			*(Bit32u*)(pos+8)=NOP;				// nop
-			*(Bit32u*)(pos+12)=NOP;				// nop
-			break;
-		case t_XORb:
-		case t_XORw:
-		case t_XORd:
-			*(Bit32u*)pos=EOR_REG_LSL_IMM(FC_RETOP, HOST_a1, HOST_a2, 0);	// eor FC_RETOP, a1, a2
-			*(Bit32u*)(pos+4)=NOP;				// nop
-			*(Bit32u*)(pos+8)=NOP;				// nop
-			*(Bit32u*)(pos+12)=NOP;				// nop
-			break;
-		case t_CMPb:
-		case t_CMPw:
-		case t_CMPd:
-		case t_TESTb:
-		case t_TESTw:
-		case t_TESTd:
-			*(Bit32u*)pos=B_FWD(8);				// b (pc+2*4)
-			break;
-		case t_INCb:
-		case t_INCw:
-		case t_INCd:
-			*(Bit32u*)pos=ADD_IMM(FC_RETOP, HOST_a1, 1, 0);	// add FC_RETOP, a1, #1
-			*(Bit32u*)(pos+4)=NOP;				// nop
-			*(Bit32u*)(pos+8)=NOP;				// nop
-			*(Bit32u*)(pos+12)=NOP;				// nop
-			break;
-		case t_DECb:
-		case t_DECw:
-		case t_DECd:
-			*(Bit32u*)pos=SUB_IMM(FC_RETOP, HOST_a1, 1, 0);	// sub FC_RETOP, a1, #1
-			*(Bit32u*)(pos+4)=NOP;				// nop
-			*(Bit32u*)(pos+8)=NOP;				// nop
-			*(Bit32u*)(pos+12)=NOP;				// nop
-			break;
-		case t_SHLb:
-		case t_SHLw:
-		case t_SHLd:
-			*(Bit32u*)pos=MOV_REG_LSL_REG(FC_RETOP, HOST_a1, HOST_a2);	// mov FC_RETOP, a1, lsl a2
-			*(Bit32u*)(pos+4)=NOP;				// nop
-			*(Bit32u*)(pos+8)=NOP;				// nop
-			*(Bit32u*)(pos+12)=NOP;				// nop
-			break;
-		case t_SHRb:
-			*(Bit32u*)pos=AND_IMM(FC_RETOP, HOST_a1, 0xff, 0);				// and FC_RETOP, a1, #0xff
-			*(Bit32u*)(pos+4)=MOV_REG_LSR_REG(FC_RETOP, FC_RETOP, HOST_a2);	// mov FC_RETOP, FC_RETOP, lsr a2
-			*(Bit32u*)(pos+8)=NOP;				// nop
-			*(Bit32u*)(pos+12)=NOP;				// nop
-			break;
-		case t_SHRw:
-			*(Bit32u*)pos=MOV_REG_LSL_IMM(FC_RETOP, HOST_a1, 16);			// mov FC_RETOP, a1, lsl #16
-			*(Bit32u*)(pos+4)=MOV_REG_LSR_IMM(FC_RETOP, FC_RETOP, 16);		// mov FC_RETOP, FC_RETOP, lsr #16
-			*(Bit32u*)(pos+8)=MOV_REG_LSR_REG(FC_RETOP, FC_RETOP, HOST_a2);	// mov FC_RETOP, FC_RETOP, lsr a2
-			*(Bit32u*)(pos+12)=NOP;				// nop
-			break;
-		case t_SHRd:
-			*(Bit32u*)pos=MOV_REG_LSR_REG(FC_RETOP, HOST_a1, HOST_a2);	// mov FC_RETOP, a1, lsr a2
-			*(Bit32u*)(pos+4)=NOP;				// nop
-			*(Bit32u*)(pos+8)=NOP;				// nop
-			*(Bit32u*)(pos+12)=NOP;				// nop
-			break;
-		case t_SARb:
-			*(Bit32u*)pos=MOV_REG_LSL_IMM(FC_RETOP, HOST_a1, 24);			// mov FC_RETOP, a1, lsl #24
-			*(Bit32u*)(pos+4)=MOV_REG_ASR_IMM(FC_RETOP, FC_RETOP, 24);		// mov FC_RETOP, FC_RETOP, asr #24
-			*(Bit32u*)(pos+8)=MOV_REG_ASR_REG(FC_RETOP, FC_RETOP, HOST_a2);	// mov FC_RETOP, FC_RETOP, asr a2
-			*(Bit32u*)(pos+12)=NOP;				// nop
-			break;
-		case t_SARw:
-			*(Bit32u*)pos=MOV_REG_LSL_IMM(FC_RETOP, HOST_a1, 16);			// mov FC_RETOP, a1, lsl #16
-			*(Bit32u*)(pos+4)=MOV_REG_ASR_IMM(FC_RETOP, FC_RETOP, 16);		// mov FC_RETOP, FC_RETOP, asr #16
-			*(Bit32u*)(pos+8)=MOV_REG_ASR_REG(FC_RETOP, FC_RETOP, HOST_a2);	// mov FC_RETOP, FC_RETOP, asr a2
-			*(Bit32u*)(pos+12)=NOP;				// nop
-			break;
-		case t_SARd:
-			*(Bit32u*)pos=MOV_REG_ASR_REG(FC_RETOP, HOST_a1, HOST_a2);	// mov FC_RETOP, a1, asr a2
-			*(Bit32u*)(pos+4)=NOP;				// nop
-			*(Bit32u*)(pos+8)=NOP;				// nop
-			*(Bit32u*)(pos+12)=NOP;				// nop
-			break;
-		case t_RORb:
-			*(Bit32u*)pos=MOV_REG_LSL_IMM(FC_RETOP, HOST_a1, 24);					// mov FC_RETOP, a1, lsl #24
-			*(Bit32u*)(pos+4)=ORR_REG_LSR_IMM(FC_RETOP, FC_RETOP, FC_RETOP, 8);		// orr FC_RETOP, FC_RETOP, FC_RETOP, lsr #8
-			*(Bit32u*)(pos+8)=ORR_REG_LSR_IMM(FC_RETOP, FC_RETOP, FC_RETOP, 16);	// orr FC_RETOP, FC_RETOP, FC_RETOP, lsr #16
-			*(Bit32u*)(pos+12)=MOV_REG_ROR_REG(FC_RETOP, FC_RETOP, HOST_a2);		// mov FC_RETOP, FC_RETOP, ror a2
-			break;
-		case t_RORw:
-			*(Bit32u*)pos=MOV_REG_LSL_IMM(FC_RETOP, HOST_a1, 16);					// mov FC_RETOP, a1, lsl #16
-			*(Bit32u*)(pos+4)=ORR_REG_LSR_IMM(FC_RETOP, FC_RETOP, FC_RETOP, 16);	// orr FC_RETOP, FC_RETOP, FC_RETOP, lsr #16
-			*(Bit32u*)(pos+8)=MOV_REG_ROR_REG(FC_RETOP, FC_RETOP, HOST_a2);			// mov FC_RETOP, FC_RETOP, ror a2
-			*(Bit32u*)(pos+12)=NOP;				// nop
-			break;
-		case t_RORd:
-			*(Bit32u*)pos=MOV_REG_ROR_REG(FC_RETOP, HOST_a1, HOST_a2);	// mov FC_RETOP, a1, ror a2
-			*(Bit32u*)(pos+4)=NOP;				// nop
-			*(Bit32u*)(pos+8)=NOP;				// nop
-			*(Bit32u*)(pos+12)=NOP;				// nop
-			break;
-		case t_ROLw:
-			*(Bit32u*)pos=MOV_REG_LSL_IMM(FC_RETOP, HOST_a1, 16);					// mov FC_RETOP, a1, lsl #16
-			*(Bit32u*)(pos+4)=RSB_IMM(HOST_a2, HOST_a2, 32, 0);						// rsb a2, a2, #32
-			*(Bit32u*)(pos+8)=ORR_REG_LSR_IMM(FC_RETOP, FC_RETOP, FC_RETOP, 16);	// orr FC_RETOP, FC_RETOP, FC_RETOP, lsr #16
-			*(Bit32u*)(pos+12)=MOV_REG_ROR_REG(FC_RETOP, FC_RETOP, HOST_a2);		// mov FC_RETOP, FC_RETOP, ror a2
-			break;
-		case t_ROLd:
-			*(Bit32u*)pos=RSB_IMM(HOST_a2, HOST_a2, 32, 0);					// rsb a2, a2, #32
-			*(Bit32u*)(pos+4)=MOV_REG_ROR_REG(FC_RETOP, HOST_a1, HOST_a2);	// mov FC_RETOP, a1, ror a2
-			*(Bit32u*)(pos+8)=NOP;				// nop
-			*(Bit32u*)(pos+12)=NOP;				// nop
-			break;
-		case t_NEGb:
-		case t_NEGw:
-		case t_NEGd:
-			*(Bit32u*)pos=RSB_IMM(FC_RETOP, HOST_a1, 0, 0);	// rsb FC_RETOP, a1, #0
-			*(Bit32u*)(pos+4)=NOP;				// nop
-			*(Bit32u*)(pos+8)=NOP;				// nop
-			*(Bit32u*)(pos+12)=NOP;				// nop
-			break;
-		default:
-			*(Bit32u*)(pos+12)=(Bit32u)fct_ptr;		// simple_func
-			break;
-
-	}
-#else
-	*(Bit32u*)(pos+12)=(Bit32u)fct_ptr;		// simple_func
-#endif
-}
-#endif
-
-static void cache_block_before_close(void) { }
-
-#ifdef DRC_USE_SEGS_ADDR
-
-// mov 16bit value from Segs[index] into dest_reg using FC_SEGS_ADDR (index modulo 2 must be zero)
-// 16bit moves may destroy the upper 16bit of the destination register
-static void gen_mov_seg16_to_reg(HostReg dest_reg,Bitu index) {
-	cache_addd( LDRH_IMM(dest_reg, FC_SEGS_ADDR, index) );      // ldrh dest_reg, [FC_SEGS_ADDR, #index]
-}
-
-// mov 32bit value from Segs[index] into dest_reg using FC_SEGS_ADDR (index modulo 4 must be zero)
-static void gen_mov_seg32_to_reg(HostReg dest_reg,Bitu index) {
-	cache_addd( LDR_IMM(dest_reg, FC_SEGS_ADDR, index) );      // ldr dest_reg, [FC_SEGS_ADDR, #index]
-}
-
-// add a 32bit value from Segs[index] to a full register using FC_SEGS_ADDR (index modulo 4 must be zero)
-static void gen_add_seg32_to_reg(HostReg reg,Bitu index) {
-	cache_addd( LDR_IMM(temp1, FC_SEGS_ADDR, index) );      // ldr temp1, [FC_SEGS_ADDR, #index]
-	cache_addd( ADD_REG_LSL_IMM(reg, reg, temp1, 0) );      // add reg, reg, temp1
-}
-
-#endif
-
-#ifdef DRC_USE_REGS_ADDR
-
-// mov 16bit value from cpu_regs[index] into dest_reg using FC_REGS_ADDR (index modulo 2 must be zero)
-// 16bit moves may destroy the upper 16bit of the destination register
-static void gen_mov_regval16_to_reg(HostReg dest_reg,Bitu index) {
-	cache_addd( LDRH_IMM(dest_reg, FC_REGS_ADDR, index) );      // ldrh dest_reg, [FC_REGS_ADDR, #index]
-}
-
-// mov 32bit value from cpu_regs[index] into dest_reg using FC_REGS_ADDR (index modulo 4 must be zero)
-static void gen_mov_regval32_to_reg(HostReg dest_reg,Bitu index) {
-	cache_addd( LDR_IMM(dest_reg, FC_REGS_ADDR, index) );      // ldr dest_reg, [FC_REGS_ADDR, #index]
-}
-
-// move a 32bit (dword==true) or 16bit (dword==false) value from cpu_regs[index] into dest_reg using FC_REGS_ADDR (if dword==true index modulo 4 must be zero) (if dword==false index modulo 2 must be zero)
-// 16bit moves may destroy the upper 16bit of the destination register
-static void gen_mov_regword_to_reg(HostReg dest_reg,Bitu index,bool dword) {
-	if (dword) {
-		cache_addd( LDR_IMM(dest_reg, FC_REGS_ADDR, index) );      // ldr dest_reg, [FC_REGS_ADDR, #index]
-	} else {
-		cache_addd( LDRH_IMM(dest_reg, FC_REGS_ADDR, index) );      // ldrh dest_reg, [FC_REGS_ADDR, #index]
-	}
-}
-
-// move an 8bit value from cpu_regs[index]  into dest_reg using FC_REGS_ADDR
-// the upper 24bit of the destination register can be destroyed
-// this function does not use FC_OP1/FC_OP2 as dest_reg as these
-// registers might not be directly byte-accessible on some architectures
-static void gen_mov_regbyte_to_reg_low(HostReg dest_reg,Bitu index) {
-	cache_addd( LDRB_IMM(dest_reg, FC_REGS_ADDR, index) );      // ldrb dest_reg, [FC_REGS_ADDR, #index]
-}
-
-// move an 8bit value from cpu_regs[index]  into dest_reg using FC_REGS_ADDR
-// the upper 24bit of the destination register can be destroyed
-// this function can use FC_OP1/FC_OP2 as dest_reg which are
-// not directly byte-accessible on some architectures
-static void INLINE gen_mov_regbyte_to_reg_low_canuseword(HostReg dest_reg,Bitu index) {
-	cache_addd( LDRB_IMM(dest_reg, FC_REGS_ADDR, index) );      // ldrb dest_reg, [FC_REGS_ADDR, #index]
-}
-
-
-// add a 32bit value from cpu_regs[index] to a full register using FC_REGS_ADDR (index modulo 4 must be zero)
-static void gen_add_regval32_to_reg(HostReg reg,Bitu index) {
-	cache_addd( LDR_IMM(temp2, FC_REGS_ADDR, index) );      // ldr temp2, [FC_REGS_ADDR, #index]
-	cache_addd( ADD_REG_LSL_IMM(reg, reg, temp2, 0) );      // add reg, reg, temp2
-}
-
-
-// move 16bit of register into cpu_regs[index] using FC_REGS_ADDR (index modulo 2 must be zero)
-static void gen_mov_regval16_from_reg(HostReg src_reg,Bitu index) {
-	cache_addd( STRH_IMM(src_reg, FC_REGS_ADDR, index) );      // strh src_reg, [FC_REGS_ADDR, #index]
-}
-
-// move 32bit of register into cpu_regs[index] using FC_REGS_ADDR (index modulo 4 must be zero)
-static void gen_mov_regval32_from_reg(HostReg src_reg,Bitu index) {
-	cache_addd( STR_IMM(src_reg, FC_REGS_ADDR, index) );      // str src_reg, [FC_REGS_ADDR, #index]
-}
-
-// move 32bit (dword==true) or 16bit (dword==false) of a register into cpu_regs[index] using FC_REGS_ADDR (if dword==true index modulo 4 must be zero) (if dword==false index modulo 2 must be zero)
-static void gen_mov_regword_from_reg(HostReg src_reg,Bitu index,bool dword) {
-	if (dword) {
-		cache_addd( STR_IMM(src_reg, FC_REGS_ADDR, index) );      // str src_reg, [FC_REGS_ADDR, #index]
-	} else {
-		cache_addd( STRH_IMM(src_reg, FC_REGS_ADDR, index) );      // strh src_reg, [FC_REGS_ADDR, #index]
-	}
-}
-
-// move the lowest 8bit of a register into cpu_regs[index] using FC_REGS_ADDR
-static void gen_mov_regbyte_from_reg_low(HostReg src_reg,Bitu index) {
-	cache_addd( STRB_IMM(src_reg, FC_REGS_ADDR, index) );      // strb src_reg, [FC_REGS_ADDR, #index]
-}
-
-#endif
diff -Nur dosbox-0.74/src/cpu/core_dynrec/risc_armv4le-thumb.h dosbox-0.74.patch/src/cpu/core_dynrec/risc_armv4le-thumb.h
--- dosbox-0.74/src/cpu/core_dynrec/risc_armv4le-thumb.h	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/cpu/core_dynrec/risc_armv4le-thumb.h	2016-12-11 18:35:15.506284007 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: risc_armv4le-thumb.h,v 1.6 2009-06-27 12:51:10 c2woody Exp $ */
 
 
 /* ARMv4 (little endian) backend by M-HT (thumb version) */
@@ -51,15 +50,14 @@
 // temporary register for LEA
 #define TEMP_REG_DRC HOST_a4
 
-#ifdef DRC_USE_REGS_ADDR
 // used to hold the address of "cpu_regs" - preferably filled in function gen_run_code
 #define FC_REGS_ADDR HOST_v7
-#endif
 
-#ifdef DRC_USE_SEGS_ADDR
 // used to hold the address of "Segs" - preferably filled in function gen_run_code
 #define FC_SEGS_ADDR HOST_v8
-#endif
+
+// used to hold the address of "core_dynrec.readdata" - filled in function gen_run_code
+#define readdata_addr HOST_v5
 
 
 // instruction encodings
@@ -99,10 +97,14 @@
 // logical
 // and dst, src
 #define AND(dst, src) (0x4000 + (dst) + ((src) << 3) )
+// bic dst, src
+#define BIC(dst, src) (0x4380 + (dst) + ((src) << 3) )
 // eor dst, src
 #define EOR(dst, src) (0x4040 + (dst) + ((src) << 3) )
 // orr dst, src
 #define ORR(dst, src) (0x4300 + (dst) + ((src) << 3) )
+// mvn dst, src
+#define MVN(dst, src) (0x43c0 + (dst) + ((src) << 3) )
 
 // shift/rotate
 // lsl dst, src, #imm
@@ -129,6 +131,8 @@
 #define LDRB_IMM(reg, addr, imm) (0x7800 + (reg) + ((addr) << 3) + ((imm) << 6) )
 // ldr reg, [pc, #imm]		@	0 <= imm < 1024	&	imm mod 4 = 0
 #define LDR_PC_IMM(reg, imm) (0x4800 + ((reg) << 8) + ((imm) >> 2) )
+// ldr reg, [addr1, addr2]
+#define LDR_REG(reg, addr1, addr2) (0x5800 + (reg) + ((addr1) << 3) + ((addr2) << 6) )
 
 // store
 // str reg, [addr, #imm]		@	0 <= imm < 128	&	imm mod 4 = 0
@@ -151,30 +155,69 @@
 #define BX(reg) (0x4700 + ((reg) << 3) )
 
 
+// arm instructions
+
+// arithmetic
+// add dst, src, #(imm ror rimm)		@	0 <= imm <= 255	&	rimm mod 2 = 0
+#define ARM_ADD_IMM(dst, src, imm, rimm) (0xe2800000 + ((dst) << 12) + ((src) << 16) + (imm) + ((rimm) << 7) )
+
+// load
+// ldr reg, [addr, #imm]		@	0 <= imm < 4096
+#define ARM_LDR_IMM(reg, addr, imm) (0xe5900000 + ((reg) << 12) + ((addr) << 16) + (imm) )
+
+// store
+// str reg, [addr, #-(imm)]!		@	0 <= imm < 4096
+#define ARM_STR_IMM_M_W(reg, addr, imm) (0xe5200000 + ((reg) << 12) + ((addr) << 16) + (imm) )
+
+// branch
+// bx reg
+#define ARM_BX(reg) (0xe12fff10 + (reg) )
+
+
 // move a full register from reg_src to reg_dst
 static void gen_mov_regs(HostReg reg_dst,HostReg reg_src) {
 	if(reg_src == reg_dst) return;
 	cache_addw( MOV_REG(reg_dst, reg_src) );      // mov reg_dst, reg_src
 }
 
+// helper function
+static bool val_single_shift(Bit32u value, Bit32u *val_shift) {
+	Bit32u shift;
+
+	if (GCC_UNLIKELY(value == 0)) {
+		*val_shift = 0;
+		return true;
+	}
+
+	shift = 0;
+	while ((value & 1) == 0) {
+		value>>=1;
+		shift+=1;
+	}
+
+	if ((value >> 8) != 0) return false;
+
+	*val_shift = shift;
+	return true;
+}
+
 // move a 32bit constant value into dest_reg
 static void gen_mov_dword_to_reg_imm(HostReg dest_reg,Bit32u imm) {
-	if ((imm & 0xffffff00) == 0) {
-		cache_addw( MOV_IMM(dest_reg, imm) );      // mov dest_reg, #(imm)
-	} else if ((imm & 0xffff00ff) == 0) {
-		cache_addw( MOV_IMM(dest_reg, imm >> 8) );      // mov dest_reg, #(imm >> 8)
-		cache_addw( LSL_IMM(dest_reg, dest_reg, 8) );      // lsl dest_reg, dest_reg, #8
-	} else if ((imm & 0xff00ffff) == 0) {
-		cache_addw( MOV_IMM(dest_reg, imm >> 16) );      // mov dest_reg, #(imm >> 16)
-		cache_addw( LSL_IMM(dest_reg, dest_reg, 16) );      // lsl dest_reg, dest_reg, #16
-	} else if ((imm & 0x00ffffff) == 0) {
-		cache_addw( MOV_IMM(dest_reg, imm >> 24) );      // mov dest_reg, #(imm >> 24)
-		cache_addw( LSL_IMM(dest_reg, dest_reg, 24) );      // lsl dest_reg, dest_reg, #24
+	Bit32u scale;
+
+	if (imm < 256) {
+		cache_addw( MOV_IMM(dest_reg, imm) );      // mov dest_reg, #imm
+	} else if ((~imm) < 256) {
+		cache_addw( MOV_IMM(dest_reg, ~imm) );      // mov dest_reg, #(~imm)
+		cache_addw( MVN(dest_reg, dest_reg) );      // mvn dest_reg, dest_reg
+	} else if (val_single_shift(imm, &scale)) {
+		cache_addw( MOV_IMM(dest_reg, imm >> scale) );      // mov dest_reg, #(imm >> scale)
+		cache_addw( LSL_IMM(dest_reg, dest_reg, scale) );      // lsl dest_reg, dest_reg, #scale
 	} else {
 		Bit32u diff;
-		
+
 		diff = imm - ((Bit32u)cache.pos+4);
-		
+
 		if ((diff < 1024) && ((imm & 0x03) == 0)) {
 			if (((Bit32u)cache.pos & 0x03) == 0) {
 				cache_addw( ADD_LO_PC_IMM(dest_reg, diff) );      // add dest_reg, pc, #(diff >> 2)
@@ -199,10 +242,58 @@
 	}
 }
 
+// helper function
+static bool gen_mov_memval_to_reg_helper(HostReg dest_reg, Bit32u data, Bitu size, HostReg addr_reg, Bit32u addr_data) {
+	switch (size) {
+		case 4:
+#if !defined(C_UNALIGNED_MEMORY)
+			if ((data & 3) == 0)
+#endif
+			{
+				if ((data >= addr_data) && (data < addr_data + 128) && (((data - addr_data) & 3) == 0)) {
+					cache_addw( MOV_LO_HI(templo2, addr_reg) );      // mov templo2, addr_reg
+					cache_addw( LDR_IMM(dest_reg, templo2, data - addr_data) );      // ldr dest_reg, [templo2, #(data - addr_data)]
+					return true;
+				}
+			}
+			break;
+		case 2:
+#if !defined(C_UNALIGNED_MEMORY)
+			if ((data & 1) == 0)
+#endif
+			{
+				if ((data >= addr_data) && (data < addr_data + 64) && (((data - addr_data) & 1) == 0)) {
+					cache_addw( MOV_LO_HI(templo2, addr_reg) );      // mov templo2, addr_reg
+					cache_addw( LDRH_IMM(dest_reg, templo2, data - addr_data) );      // ldrh dest_reg, [templo2, #(data - addr_data)]
+					return true;
+				}
+			}
+			break;
+		case 1:
+			if ((data >= addr_data) && (data < addr_data + 32)) {
+				cache_addw( MOV_LO_HI(templo2, addr_reg) );      // mov templo2, addr_reg
+				cache_addw( LDRB_IMM(dest_reg, templo2, data - addr_data) );      // ldrb dest_reg, [templo2, #(data - addr_data)]
+				return true;
+			}
+		default:
+			break;
+	}
+	return false;
+}
+
+// helper function
+static bool gen_mov_memval_to_reg(HostReg dest_reg, void *data, Bitu size) {
+	if (gen_mov_memval_to_reg_helper(dest_reg, (Bit32u)data, size, FC_REGS_ADDR, (Bit32u)&cpu_regs)) return true;
+	if (gen_mov_memval_to_reg_helper(dest_reg, (Bit32u)data, size, readdata_addr, (Bit32u)&core_dynrec.readdata)) return true;
+	if (gen_mov_memval_to_reg_helper(dest_reg, (Bit32u)data, size, FC_SEGS_ADDR, (Bit32u)&Segs)) return true;
+	return false;
+}
+
 // helper function for gen_mov_word_to_reg
 static void gen_mov_word_to_reg_helper(HostReg dest_reg,void* data,bool dword,HostReg data_reg) {
 	// alignment....
 	if (dword) {
+#if !defined(C_UNALIGNED_MEMORY)
 		if ((Bit32u)data & 3) {
 			if ( ((Bit32u)data & 3) == 2 ) {
 				cache_addw( LDRH_IMM(dest_reg, data_reg, 0) );      // ldrh dest_reg, [data_reg]
@@ -219,16 +310,21 @@
 				cache_addw( LSL_IMM(templo1, templo1, 24) );      // lsl templo1, templo1, #24
 				cache_addw( ORR(dest_reg, templo1) );      // orr dest_reg, templo1
 			}
-		} else {
+		} else
+#endif
+		{
 			cache_addw( LDR_IMM(dest_reg, data_reg, 0) );      // ldr dest_reg, [data_reg]
 		}
 	} else {
+#if !defined(C_UNALIGNED_MEMORY)
 		if ((Bit32u)data & 1) {
 			cache_addw( LDRB_IMM(dest_reg, data_reg, 0) );      // ldrb dest_reg, [data_reg]
 			cache_addw( LDRB_IMM(templo1, data_reg, 1) );      // ldrb templo1, [data_reg, #1]
 			cache_addw( LSL_IMM(templo1, templo1, 8) );      // lsl templo1, templo1, #8
 			cache_addw( ORR(dest_reg, templo1) );      // orr dest_reg, templo1
-		} else {
+		} else
+#endif
+		{
 			cache_addw( LDRH_IMM(dest_reg, data_reg, 0) );      // ldrh dest_reg, [data_reg]
 		}
 	}
@@ -237,8 +333,10 @@
 // move a 32bit (dword==true) or 16bit (dword==false) value from memory into dest_reg
 // 16bit moves may destroy the upper 16bit of the destination register
 static void gen_mov_word_to_reg(HostReg dest_reg,void* data,bool dword) {
-	gen_mov_dword_to_reg_imm(templo2, (Bit32u)data);
-	gen_mov_word_to_reg_helper(dest_reg, data, dword, templo2);
+	if (!gen_mov_memval_to_reg(dest_reg, data, (dword)?4:2)) {
+		gen_mov_dword_to_reg_imm(templo2, (Bit32u)data);
+		gen_mov_word_to_reg_helper(dest_reg, data, dword, templo2);
+	}
 }
 
 // move a 16bit constant value into dest_reg
@@ -247,10 +345,58 @@
 	gen_mov_dword_to_reg_imm(dest_reg, (Bit32u)imm);
 }
 
+// helper function
+static bool gen_mov_memval_from_reg_helper(HostReg src_reg, Bit32u data, Bitu size, HostReg addr_reg, Bit32u addr_data) {
+	switch (size) {
+		case 4:
+#if !defined(C_UNALIGNED_MEMORY)
+			if ((data & 3) == 0)
+#endif
+			{
+				if ((data >= addr_data) && (data < addr_data + 128) && (((data - addr_data) & 3) == 0)) {
+					cache_addw( MOV_LO_HI(templo2, addr_reg) );      // mov templo2, addr_reg
+					cache_addw( STR_IMM(src_reg, templo2, data - addr_data) );      // str src_reg, [templo2, #(data - addr_data)]
+					return true;
+				}
+			}
+			break;
+		case 2:
+#if !defined(C_UNALIGNED_MEMORY)
+			if ((data & 1) == 0)
+#endif
+			{
+				if ((data >= addr_data) && (data < addr_data + 64) && (((data - addr_data) & 1) == 0)) {
+					cache_addw( MOV_LO_HI(templo2, addr_reg) );      // mov templo2, addr_reg
+					cache_addw( STRH_IMM(src_reg, templo2, data - addr_data) );      // strh src_reg, [templo2, #(data - addr_data)]
+					return true;
+				}
+			}
+			break;
+		case 1:
+			if ((data >= addr_data) && (data < addr_data + 32)) {
+				cache_addw( MOV_LO_HI(templo2, addr_reg) );      // mov templo2, addr_reg
+				cache_addw( STRB_IMM(src_reg, templo2, data - addr_data) );      // strb src_reg, [templo2, #(data - addr_data)]
+				return true;
+			}
+		default:
+			break;
+	}
+	return false;
+}
+
+// helper function
+static bool gen_mov_memval_from_reg(HostReg src_reg, void *dest, Bitu size) {
+	if (gen_mov_memval_from_reg_helper(src_reg, (Bit32u)dest, size, FC_REGS_ADDR, (Bit32u)&cpu_regs)) return true;
+	if (gen_mov_memval_from_reg_helper(src_reg, (Bit32u)dest, size, readdata_addr, (Bit32u)&core_dynrec.readdata)) return true;
+	if (gen_mov_memval_from_reg_helper(src_reg, (Bit32u)dest, size, FC_SEGS_ADDR, (Bit32u)&Segs)) return true;
+	return false;
+}
+
 // helper function for gen_mov_word_from_reg
 static void gen_mov_word_from_reg_helper(HostReg src_reg,void* dest,bool dword, HostReg data_reg) {
 	// alignment....
 	if (dword) {
+#if !defined(C_UNALIGNED_MEMORY)
 		if ((Bit32u)dest & 3) {
 			if ( ((Bit32u)dest & 3) == 2 ) {
 				cache_addw( STRH_IMM(src_reg, data_reg, 0) );      // strh src_reg, [data_reg]
@@ -269,16 +415,21 @@
 				cache_addw( LSR_IMM(templo1, templo1, 24) );      // lsr templo1, templo1, #24
 				cache_addw( STRB_IMM(templo1, data_reg, 3) );      // strb templo1, [data_reg, #3]
 			}
-		} else {
+		} else
+#endif
+		{
 			cache_addw( STR_IMM(src_reg, data_reg, 0) );      // str src_reg, [data_reg]
 		}
 	} else {
+#if !defined(C_UNALIGNED_MEMORY)
 		if ((Bit32u)dest & 1) {
 			cache_addw( STRB_IMM(src_reg, data_reg, 0) );      // strb src_reg, [data_reg]
 			cache_addw( MOV_REG(templo1, src_reg) );      // mov templo1, src_reg
 			cache_addw( LSR_IMM(templo1, templo1, 8) );      // lsr templo1, templo1, #8
 			cache_addw( STRB_IMM(templo1, data_reg, 1) );      // strb templo1, [data_reg, #1]
-		} else {
+		} else
+#endif
+		{
 			cache_addw( STRH_IMM(src_reg, data_reg, 0) );      // strh src_reg, [data_reg]
 		}
 	}
@@ -286,8 +437,10 @@
 
 // move 32bit (dword==true) or 16bit (dword==false) of a register into memory
 static void gen_mov_word_from_reg(HostReg src_reg,void* dest,bool dword) {
-	gen_mov_dword_to_reg_imm(templo2, (Bit32u)dest);
-	gen_mov_word_from_reg_helper(src_reg, dest, dword, templo2);
+	if (!gen_mov_memval_from_reg(src_reg, dest, (dword)?4:2)) {
+		gen_mov_dword_to_reg_imm(templo2, (Bit32u)dest);
+		gen_mov_word_from_reg_helper(src_reg, dest, dword, templo2);
+	}
 }
 
 // move an 8bit value from memory into dest_reg
@@ -295,8 +448,10 @@
 // this function does not use FC_OP1/FC_OP2 as dest_reg as these
 // registers might not be directly byte-accessible on some architectures
 static void gen_mov_byte_to_reg_low(HostReg dest_reg,void* data) {
-	gen_mov_dword_to_reg_imm(templo1, (Bit32u)data);
-	cache_addw( LDRB_IMM(dest_reg, templo1, 0) );      // ldrb dest_reg, [templo1]
+	if (!gen_mov_memval_to_reg(dest_reg, data, 1)) {
+		gen_mov_dword_to_reg_imm(templo1, (Bit32u)data);
+		cache_addw( LDRB_IMM(dest_reg, templo1, 0) );      // ldrb dest_reg, [templo1]
+	}
 }
 
 // move an 8bit value from memory into dest_reg
@@ -325,8 +480,10 @@
 
 // move the lowest 8bit of a register into memory
 static void gen_mov_byte_from_reg_low(HostReg src_reg,void* dest) {
-	gen_mov_dword_to_reg_imm(templo1, (Bit32u)dest);
-	cache_addw( STRB_IMM(src_reg, templo1, 0) );      // strb src_reg, [templo1]
+	if (!gen_mov_memval_from_reg(src_reg, dest, 1)) {
+		gen_mov_dword_to_reg_imm(templo1, (Bit32u)dest);
+		cache_addw( STRB_IMM(src_reg, templo1, 0) );      // strb src_reg, [templo1]
+	}
 }
 
 
@@ -363,16 +520,51 @@
 
 // add a 32bit constant value to a full register
 static void gen_add_imm(HostReg reg,Bit32u imm) {
+	Bit32u imm2, scale;
+
 	if(!imm) return;
-	gen_mov_dword_to_reg_imm(templo1, imm);
-	cache_addw( ADD_REG(reg, reg, templo1) );      // add reg, reg, templo1
+
+	imm2 = (Bit32u) (-((Bit32s)imm));
+
+	if (imm <= 255) {
+		cache_addw( ADD_IMM8(reg, imm) );      // add reg, #imm
+	} else if (imm2 <= 255) {
+		cache_addw( SUB_IMM8(reg, imm2) );      // sub reg, #(-imm)
+	} else {
+		if (val_single_shift(imm2, &scale)) {
+			cache_addw( MOV_IMM(templo1, imm2 >> scale) );      // mov templo1, #(~imm >> scale)
+			if (scale) {
+				cache_addw( LSL_IMM(templo1, templo1, scale) );      // lsl templo1, templo1, #scale
+			}
+			cache_addw( SUB_REG(reg, reg, templo1) );      // sub reg, reg, templo1
+		} else {
+			gen_mov_dword_to_reg_imm(templo1, imm);
+			cache_addw( ADD_REG(reg, reg, templo1) );      // add reg, reg, templo1
+		}
+	}
 }
 
 // and a 32bit constant value with a full register
 static void gen_and_imm(HostReg reg,Bit32u imm) {
-	if(imm == 0xffffffff) return;
-	gen_mov_dword_to_reg_imm(templo1, imm);
-	cache_addw( AND(reg, templo1) );      // and reg, templo1
+	Bit32u imm2, scale;
+
+	imm2 = ~imm;
+	if(!imm2) return;
+
+	if (!imm) {
+		cache_addw( MOV_IMM(reg, 0) );      // mov reg, #0
+	} else {
+		if (val_single_shift(imm2, &scale)) {
+			cache_addw( MOV_IMM(templo1, imm2 >> scale) );      // mov templo1, #(~imm >> scale)
+			if (scale) {
+				cache_addw( LSL_IMM(templo1, templo1, scale) );      // lsl templo1, templo1, #scale
+			}
+			cache_addw( BIC(reg, templo1) );      // bic reg, templo1
+		} else {
+			gen_mov_dword_to_reg_imm(templo1, imm);
+			cache_addw( AND(reg, templo1) );      // and reg, templo1
+		}
+	}
 }
 
 
@@ -387,66 +579,65 @@
 	gen_mov_direct_dword(dest,(Bit32u)imm);
 }
 
-// add an 8bit constant value to a dword memory value
-static void gen_add_direct_byte(void* dest,Bit8s imm) {
-	if(!imm) return;
-	gen_mov_dword_to_reg_imm(templo2, (Bit32u)dest);
-	gen_mov_word_to_reg_helper(templo3, dest, 1, templo2);
-	if (imm >= 0) {
-		cache_addw( ADD_IMM8(templo3, (Bit32s)imm) );      // add templo3, #(imm)
-	} else {
-		cache_addw( SUB_IMM8(templo3, -((Bit32s)imm)) );      // sub templo3, #(-imm)
-	}
-	gen_mov_word_from_reg_helper(templo3, dest, 1, templo2);
-}
-
 // add a 32bit (dword==true) or 16bit (dword==false) constant value to a memory value
 static void gen_add_direct_word(void* dest,Bit32u imm,bool dword) {
+	if (!dword) imm &= 0xffff;
 	if(!imm) return;
-	if (dword && ( (imm<128) || (imm>=0xffffff80) ) ) {
-		gen_add_direct_byte(dest,(Bit8s)imm);
-		return;
-	}
-	gen_mov_dword_to_reg_imm(templo2, (Bit32u)dest);
-	gen_mov_word_to_reg_helper(templo3, dest, dword, templo2);
-	if (dword) {
-		gen_mov_dword_to_reg_imm(templo1, imm);
-	} else {
-		gen_mov_word_to_reg_imm(templo1, (Bit16u)imm);
+
+	if (!gen_mov_memval_to_reg(templo3, dest, (dword)?4:2)) {
+		gen_mov_dword_to_reg_imm(templo2, (Bit32u)dest);
+		gen_mov_word_to_reg_helper(templo3, dest, dword, templo2);
+	}
+	gen_add_imm(templo3, imm);
+	if (!gen_mov_memval_from_reg(templo3, dest, (dword)?4:2)) {
+		gen_mov_word_from_reg_helper(templo3, dest, dword, templo2);
 	}
-	cache_addw( ADD_REG(templo3, templo3, templo1) );      // add templo3, templo3, templo1
-	gen_mov_word_from_reg_helper(templo3, dest, dword, templo2);
 }
 
-// subtract an 8bit constant value from a dword memory value
-static void gen_sub_direct_byte(void* dest,Bit8s imm) {
-	if(!imm) return;
-	gen_mov_dword_to_reg_imm(templo2, (Bit32u)dest);
-	gen_mov_word_to_reg_helper(templo3, dest, 1, templo2);
-	if (imm >= 0) {
-		cache_addw( SUB_IMM8(templo3, (Bit32s)imm) );      // sub templo3, #(imm)
-	} else {
-		cache_addw( ADD_IMM8(templo3, -((Bit32s)imm)) );      // add templo3, #(-imm)
-	}
-	gen_mov_word_from_reg_helper(templo3, dest, 1, templo2);
+// add an 8bit constant value to a dword memory value
+static void gen_add_direct_byte(void* dest,Bit8s imm) {
+	gen_add_direct_word(dest, (Bit32s)imm, 1);
 }
 
 // subtract a 32bit (dword==true) or 16bit (dword==false) constant value from a memory value
 static void gen_sub_direct_word(void* dest,Bit32u imm,bool dword) {
+	Bit32u imm2, scale;
+
+	if (!dword) imm &= 0xffff;
 	if(!imm) return;
-	if (dword && ( (imm<128) || (imm>=0xffffff80) ) ) {
-		gen_sub_direct_byte(dest,(Bit8s)imm);
-		return;
+
+	if (!gen_mov_memval_to_reg(templo3, dest, (dword)?4:2)) {
+		gen_mov_dword_to_reg_imm(templo2, (Bit32u)dest);
+		gen_mov_word_to_reg_helper(templo3, dest, dword, templo2);
 	}
-	gen_mov_dword_to_reg_imm(templo2, (Bit32u)dest);
-	gen_mov_word_to_reg_helper(templo3, dest, dword, templo2);
-	if (dword) {
-		gen_mov_dword_to_reg_imm(templo1, imm);
+
+	imm2 = (Bit32u) (-((Bit32s)imm));
+
+	if (imm <= 255) {
+		cache_addw( SUB_IMM8(templo3, imm) );      // sub templo3, #imm
+	} else if (imm2 <= 255) {
+		cache_addw( ADD_IMM8(templo3, imm2) );      // add templo3, #(-imm)
 	} else {
-		gen_mov_word_to_reg_imm(templo1, (Bit16u)imm);
+		if (val_single_shift(imm2, &scale)) {
+			cache_addw( MOV_IMM(templo1, imm2 >> scale) );      // mov templo1, #(~imm >> scale)
+			if (scale) {
+				cache_addw( LSL_IMM(templo1, templo1, scale) );      // lsl templo1, templo1, #scale
+			}
+			cache_addw( ADD_REG(templo3, templo3, templo1) );      // add templo3, templo3, templo1
+		} else {
+			gen_mov_dword_to_reg_imm(templo1, imm);
+			cache_addw( SUB_REG(templo3, templo3, templo1) );      // sub templo3, templo3, templo1
+		}
+	}
+
+	if (!gen_mov_memval_from_reg(templo3, dest, (dword)?4:2)) {
+		gen_mov_word_from_reg_helper(templo3, dest, dword, templo2);
 	}
-	cache_addw( SUB_REG(templo3, templo3, templo1) );      // sub templo3, templo3, templo1
-	gen_mov_word_from_reg_helper(templo3, dest, dword, templo2);
+}
+
+// subtract an 8bit constant value from a dword memory value
+static void gen_sub_direct_byte(void* dest,Bit8s imm) {
+	gen_sub_direct_word(dest, (Bit32s)imm, 1);
 }
 
 // effective address calculation, destination is dest_reg
@@ -492,7 +683,7 @@
 	// switch from arm to thumb state
 	cache_addd(0xe2800000 + (templo1 << 12) + (HOST_pc << 16) + (1));      // add templo1, pc, #1
 	cache_addd(0xe12fff10 + (templo1));      // bx templo1
-	
+
 	// thumb state from now on
 }
 
@@ -538,18 +729,20 @@
 static void gen_jmp_ptr(void * ptr,Bits imm=0) {
 	gen_mov_word_to_reg(templo3, ptr, 1);
 
-	if (imm) {
-		gen_mov_dword_to_reg_imm(templo2, imm);
-		cache_addw( ADD_REG(templo3, templo3, templo2) );      // add templo3, templo3, templo2
-	}
-
-#if (1)
-// (*ptr) should be word aligned 
+#if !defined(C_UNALIGNED_MEMORY)
+// (*ptr) should be word aligned
 	if ((imm & 0x03) == 0) {
-		cache_addw( LDR_IMM(templo2, templo3, 0) );      // ldr templo2, [templo3]
-	} else
 #endif
-	{
+		if ((imm >= 0) && (imm < 128) && ((imm & 3) == 0)) {
+			cache_addw( LDR_IMM(templo2, templo3, imm) );      // ldr templo2, [templo3, #imm]
+		} else {
+			gen_mov_dword_to_reg_imm(templo2, imm);
+			cache_addw( LDR_REG(templo2, templo3, templo2) );      // ldr templo2, [templo3, templo2]
+		}
+#if !defined(C_UNALIGNED_MEMORY)
+	} else {
+		gen_add_imm(templo3, imm);
+
 		cache_addw( LDRB_IMM(templo2, templo3, 0) );      // ldrb templo2, [templo3]
 		cache_addw( LDRB_IMM(templo1, templo3, 1) );      // ldrb templo1, [templo3, #1]
 		cache_addw( LSL_IMM(templo1, templo1, 8) );      // lsl templo1, templo1, #8
@@ -561,6 +754,7 @@
 		cache_addw( LSL_IMM(templo1, templo1, 24) );      // lsl templo1, templo1, #24
 		cache_addw( ORR(templo2, templo1) );      // orr templo2, templo1
 	}
+#endif
 
 	// increase jmp address to keep thumb state
 	cache_addw( ADD_IMM3(templo2, templo2, 1) );      // add templo2, templo2, #1
@@ -651,50 +845,53 @@
 }
 
 static void gen_run_code(void) {
-	// switch from arm to thumb state
-	cache_addd(0xe2800000 + (HOST_r3 << 12) + (HOST_pc << 16) + (1));      // add r3, pc, #1
-	cache_addd(0xe12fff10 + (HOST_r3));      // bx r3
+	Bit8u *pos1, *pos2, *pos3;
 
-	// thumb state from now on
-	cache_addw(0xb500);      // push {lr}
-	cache_addw( MOV_LO_HI(HOST_r3, FC_SEGS_ADDR) );      // mov r3, FC_SEGS_ADDR
-	cache_addw( MOV_LO_HI(HOST_r2, FC_REGS_ADDR) );      // mov r2, FC_REGS_ADDR
-	cache_addw(0xb4fc);      // push {r2,r3,v1-v4}
-
-	// adr: 16
-	cache_addw( LDR_PC_IMM(HOST_r3, 64 - (16 + 4)) );        // ldr r3, [pc, #(&Segs)]
-	// adr: 18
-	cache_addw( LDR_PC_IMM(HOST_r2, 68 - (18 + 2)) );        // ldr r2, [pc, #(&cpu_regs)]
-	cache_addw( MOV_HI_LO(FC_SEGS_ADDR, HOST_r3) );      // mov FC_SEGS_ADDR, r3
-	cache_addw( MOV_HI_LO(FC_REGS_ADDR, HOST_r2) );      // mov FC_REGS_ADDR, r2
-
-	// align 4
-	cache_addw( ADD_LO_PC_IMM(HOST_r3, 8) );      // add r3, pc, #8
-	cache_addw( ADD_IMM8(HOST_r0, 1) );      // add r0, #1
-	cache_addw( ADD_IMM8(HOST_r3, 1) );      // add r3, #1
-	cache_addw(0xb408);      // push {r3}
-	cache_addw( BX(HOST_r0) );      // bx r0
-	cache_addw( NOP );      // nop
-
-	// align 4
-	cache_addw(0xbcfc);      // pop {r2,r3,v1-v4}
-	cache_addw( MOV_HI_LO(FC_SEGS_ADDR, HOST_r3) );      // mov FC_SEGS_ADDR, r3
-	cache_addw( MOV_HI_LO(FC_REGS_ADDR, HOST_r2) );      // mov FC_REGS_ADDR, r2
+#if (__ARM_EABI__)
+	// 8-byte stack alignment
+	cache_addd(0xe92d4ff0);			// stmfd sp!, {v1-v8,lr}
+#else
+	cache_addd(0xe92d4df0);			// stmfd sp!, {v1-v5,v7,v8,lr}
+#endif
 
-	cache_addw(0xbc08);      // pop {r3}
-	cache_addw( BX(HOST_r3) );      // bx r3
+	cache_addd( ARM_ADD_IMM(HOST_r0, HOST_r0, 1, 0) );      // add r0, r0, #1
+
+	pos1 = cache.pos;
+	cache_addd( 0 );
+	pos2 = cache.pos;
+	cache_addd( 0 );
+	pos3 = cache.pos;
+	cache_addd( 0 );
+
+	cache_addd( ARM_ADD_IMM(HOST_lr, HOST_pc, 4, 0) );			// add lr, pc, #4
+	cache_addd( ARM_STR_IMM_M_W(HOST_lr, HOST_sp, 4) );      // str lr, [sp, #-4]!
+	cache_addd( ARM_BX(HOST_r0) );			// bx r0
+
+#if (__ARM_EABI__)
+	cache_addd(0xe8bd4ff0);			// ldmfd sp!, {v1-v8,lr}
+#else
+	cache_addd(0xe8bd4df0);			// ldmfd sp!, {v1-v5,v7,v8,lr}
+#endif
+	cache_addd( ARM_BX(HOST_lr) );			// bx lr
 
-	// fill up to 64 bytes
-	cache_addw( NOP );      // nop
-	cache_addd( NOP | (NOP << 16) );  // nop, nop
-	cache_addd( NOP | (NOP << 16) );  // nop, nop
-	cache_addd( NOP | (NOP << 16) );  // nop, nop
-	cache_addd( NOP | (NOP << 16) );  // nop, nop
+	// align cache.pos to 32 bytes
+	if ((((Bitu)cache.pos) & 0x1f) != 0) {
+		cache.pos = cache.pos + (32 - (((Bitu)cache.pos) & 0x1f));
+	}
 
-	// adr: 64
+	*(Bit32u*)pos1 = ARM_LDR_IMM(FC_SEGS_ADDR, HOST_pc, cache.pos - (pos1 + 8));      // ldr FC_SEGS_ADDR, [pc, #(&Segs)]
 	cache_addd((Bit32u)&Segs);      // address of "Segs"
-	// adr: 68
+
+	*(Bit32u*)pos2 = ARM_LDR_IMM(FC_REGS_ADDR, HOST_pc, cache.pos - (pos2 + 8));      // ldr FC_REGS_ADDR, [pc, #(&cpu_regs)]
 	cache_addd((Bit32u)&cpu_regs);  // address of "cpu_regs"
+
+	*(Bit32u*)pos3 = ARM_LDR_IMM(readdata_addr, HOST_pc, cache.pos - (pos3 + 8));      // ldr readdata_addr, [pc, #(&core_dynrec.readdata)]
+	cache_addd((Bit32u)&core_dynrec.readdata);  // address of "core_dynrec.readdata"
+
+	// align cache.pos to 32 bytes
+	if ((((Bitu)cache.pos) & 0x1f) != 0) {
+		cache.pos = cache.pos + (32 - (((Bitu)cache.pos) & 0x1f));
+	}
 }
 
 // return from a function
@@ -1024,7 +1221,11 @@
 }
 #endif
 
-static void cache_block_before_close(void) { }
+static void cache_block_before_close(void) {
+	if ((((Bit32u)cache.pos) & 3) != 0) {
+		cache_addw( NOP );      // nop
+	}
+}
 
 #ifdef DRC_USE_SEGS_ADDR
 
diff -Nur dosbox-0.74/src/cpu/core_dynrec/risc_armv4le-thumb-iw.h dosbox-0.74.patch/src/cpu/core_dynrec/risc_armv4le-thumb-iw.h
--- dosbox-0.74/src/cpu/core_dynrec/risc_armv4le-thumb-iw.h	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/cpu/core_dynrec/risc_armv4le-thumb-iw.h	2016-12-11 18:35:15.506284007 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: risc_armv4le-thumb-iw.h,v 1.5 2009-06-27 12:51:10 c2woody Exp $ */
 
 
 /* ARMv4 (little endian) backend by M-HT (thumb version with data pool, requires -mthumb-interwork switch when compiling dosbox) */
@@ -51,15 +50,14 @@
 // temporary register for LEA
 #define TEMP_REG_DRC HOST_a4
 
-#ifdef DRC_USE_REGS_ADDR
 // used to hold the address of "cpu_regs" - preferably filled in function gen_run_code
 #define FC_REGS_ADDR HOST_v7
-#endif
 
-#ifdef DRC_USE_SEGS_ADDR
 // used to hold the address of "Segs" - preferably filled in function gen_run_code
 #define FC_SEGS_ADDR HOST_v8
-#endif
+
+// used to hold the address of "core_dynrec.readdata" - filled in function gen_run_code
+#define readdata_addr HOST_v5
 
 
 // instruction encodings
@@ -99,10 +97,14 @@
 // logical
 // and dst, src
 #define AND(dst, src) (0x4000 + (dst) + ((src) << 3) )
+// bic dst, src
+#define BIC(dst, src) (0x4380 + (dst) + ((src) << 3) )
 // eor dst, src
 #define EOR(dst, src) (0x4040 + (dst) + ((src) << 3) )
 // orr dst, src
 #define ORR(dst, src) (0x4300 + (dst) + ((src) << 3) )
+// mvn dst, src
+#define MVN(dst, src) (0x43c0 + (dst) + ((src) << 3) )
 
 // shift/rotate
 // lsl dst, src, #imm
@@ -129,6 +131,8 @@
 #define LDRB_IMM(reg, addr, imm) (0x7800 + (reg) + ((addr) << 3) + ((imm) << 6) )
 // ldr reg, [pc, #imm]		@	0 <= imm < 1024	&	imm mod 4 = 0
 #define LDR_PC_IMM(reg, imm) (0x4800 + ((reg) << 8) + ((imm) >> 2) )
+// ldr reg, [addr1, addr2]
+#define LDR_REG(reg, addr1, addr2) (0x5800 + (reg) + ((addr1) << 3) + ((addr2) << 6) )
 
 // store
 // str reg, [addr, #imm]		@	0 <= imm < 128	&	imm mod 4 = 0
@@ -151,6 +155,25 @@
 #define BX(reg) (0x4700 + ((reg) << 3) )
 
 
+// arm instructions
+
+// arithmetic
+// add dst, src, #(imm ror rimm)		@	0 <= imm <= 255	&	rimm mod 2 = 0
+#define ARM_ADD_IMM(dst, src, imm, rimm) (0xe2800000 + ((dst) << 12) + ((src) << 16) + (imm) + ((rimm) << 7) )
+
+// load
+// ldr reg, [addr, #imm]		@	0 <= imm < 4096
+#define ARM_LDR_IMM(reg, addr, imm) (0xe5900000 + ((reg) << 12) + ((addr) << 16) + (imm) )
+
+// store
+// str reg, [addr, #-(imm)]!		@	0 <= imm < 4096
+#define ARM_STR_IMM_M_W(reg, addr, imm) (0xe5200000 + ((reg) << 12) + ((addr) << 16) + (imm) )
+
+// branch
+// bx reg
+#define ARM_BX(reg) (0xe12fff10 + (reg) )
+
+
 // data pool defines
 #define CACHE_DATA_JUMP	 (2)
 #define CACHE_DATA_ALIGN (32)
@@ -194,7 +217,7 @@
 		cache_datapos = (Bit8u *) (((Bitu)cache.block.active->cache.start + cache.block.active->cache.size - CACHE_DATA_ALIGN) & ~(CACHE_DATA_ALIGN - 1));
 	} else {
 		register Bit32u cachemodsize;
-	
+
 		cachemodsize = (cache.pos - cache.block.active->cache.start) & (CACHE_MAXSIZE - 1);
 
 		if (cachemodsize + CACHE_DATA_MAX + CACHE_DATA_ALIGN <= CACHE_MAXSIZE ||
@@ -276,30 +299,49 @@
 	cache_addw( MOV_REG(reg_dst, reg_src) );      // mov reg_dst, reg_src
 }
 
+// helper function
+static bool val_single_shift(Bit32u value, Bit32u *val_shift) {
+	Bit32u shift;
+
+	if (GCC_UNLIKELY(value == 0)) {
+		*val_shift = 0;
+		return true;
+	}
+
+	shift = 0;
+	while ((value & 1) == 0) {
+		value>>=1;
+		shift+=1;
+	}
+
+	if ((value >> 8) != 0) return false;
+
+	*val_shift = shift;
+	return true;
+}
+
 // move a 32bit constant value into dest_reg
 static void gen_mov_dword_to_reg_imm(HostReg dest_reg,Bit32u imm) {
-	if ((imm & 0xffffff00) == 0) {
+	Bit32u scale;
+
+	if (imm < 256) {
 		cache_checkinstr(2);
 		cache_addw( MOV_IMM(dest_reg, imm) );      // mov dest_reg, #(imm)
-	} else if ((imm & 0xffff00ff) == 0) {
+	} else if ((~imm) < 256) {
 		cache_checkinstr(4);
-		cache_addw( MOV_IMM(dest_reg, imm >> 8) );      // mov dest_reg, #(imm >> 8)
-		cache_addw( LSL_IMM(dest_reg, dest_reg, 8) );      // lsl dest_reg, dest_reg, #8
-	} else if ((imm & 0xff00ffff) == 0) {
+		cache_addw( MOV_IMM(dest_reg, ~imm) );      // mov dest_reg, #(~imm)
+		cache_addw( MVN(dest_reg, dest_reg) );      // mvn dest_reg, dest_reg
+	} else if (val_single_shift(imm, &scale)) {
 		cache_checkinstr(4);
-		cache_addw( MOV_IMM(dest_reg, imm >> 16) );      // mov dest_reg, #(imm >> 16)
-		cache_addw( LSL_IMM(dest_reg, dest_reg, 16) );      // lsl dest_reg, dest_reg, #16
-	} else if ((imm & 0x00ffffff) == 0) {
-		cache_checkinstr(4);
-		cache_addw( MOV_IMM(dest_reg, imm >> 24) );      // mov dest_reg, #(imm >> 24)
-		cache_addw( LSL_IMM(dest_reg, dest_reg, 24) );      // lsl dest_reg, dest_reg, #24
+		cache_addw( MOV_IMM(dest_reg, imm >> scale) );      // mov dest_reg, #(imm >> scale)
+		cache_addw( LSL_IMM(dest_reg, dest_reg, scale) );      // lsl dest_reg, dest_reg, #scale
 	} else {
 		Bit32u diff;
 
 		cache_checkinstr(4);
 
 		diff = imm - ((Bit32u)cache.pos+4);
-		
+
 		if ((diff < 1024) && ((imm & 0x03) == 0)) {
 			if (((Bit32u)cache.pos & 0x03) == 0) {
 				cache_addw( ADD_LO_PC_IMM(dest_reg, diff >> 2) );      // add dest_reg, pc, #(diff >> 2)
@@ -322,10 +364,61 @@
 	}
 }
 
+// helper function
+static bool gen_mov_memval_to_reg_helper(HostReg dest_reg, Bit32u data, Bitu size, HostReg addr_reg, Bit32u addr_data) {
+	switch (size) {
+		case 4:
+#if !defined(C_UNALIGNED_MEMORY)
+			if ((data & 3) == 0)
+#endif
+			{
+				if ((data >= addr_data) && (data < addr_data + 128) && (((data - addr_data) & 3) == 0)) {
+					cache_checkinstr(4);
+					cache_addw( MOV_LO_HI(templo2, addr_reg) );      // mov templo2, addr_reg
+					cache_addw( LDR_IMM(dest_reg, templo2, data - addr_data) );      // ldr dest_reg, [templo2, #(data - addr_data)]
+					return true;
+				}
+			}
+			break;
+		case 2:
+#if !defined(C_UNALIGNED_MEMORY)
+			if ((data & 1) == 0)
+#endif
+			{
+				if ((data >= addr_data) && (data < addr_data + 64) && (((data - addr_data) & 1) == 0)) {
+					cache_checkinstr(4);
+					cache_addw( MOV_LO_HI(templo2, addr_reg) );      // mov templo2, addr_reg
+					cache_addw( LDRH_IMM(dest_reg, templo2, data - addr_data) );      // ldrh dest_reg, [templo2, #(data - addr_data)]
+					return true;
+				}
+			}
+			break;
+		case 1:
+			if ((data >= addr_data) && (data < addr_data + 32)) {
+				cache_checkinstr(4);
+				cache_addw( MOV_LO_HI(templo2, addr_reg) );      // mov templo2, addr_reg
+				cache_addw( LDRB_IMM(dest_reg, templo2, data - addr_data) );      // ldrb dest_reg, [templo2, #(data - addr_data)]
+				return true;
+			}
+		default:
+			break;
+	}
+	return false;
+}
+
+// helper function
+static bool gen_mov_memval_to_reg(HostReg dest_reg, void *data, Bitu size) {
+	if (gen_mov_memval_to_reg_helper(dest_reg, (Bit32u)data, size, FC_REGS_ADDR, (Bit32u)&cpu_regs)) return true;
+	if (gen_mov_memval_to_reg_helper(dest_reg, (Bit32u)data, size, readdata_addr, (Bit32u)&core_dynrec.readdata)) return true;
+	if (gen_mov_memval_to_reg_helper(dest_reg, (Bit32u)data, size, FC_SEGS_ADDR, (Bit32u)&Segs)) return true;
+	return false;
+}
+
 // helper function for gen_mov_word_to_reg
 static void gen_mov_word_to_reg_helper(HostReg dest_reg,void* data,bool dword,HostReg data_reg) {
 	// alignment....
 	if (dword) {
+#if !defined(C_UNALIGNED_MEMORY)
 		if ((Bit32u)data & 3) {
 			if ( ((Bit32u)data & 3) == 2 ) {
 				cache_checkinstr(8);
@@ -344,18 +437,23 @@
 				cache_addw( LSL_IMM(templo1, templo1, 24) );      // lsl templo1, templo1, #24
 				cache_addw( ORR(dest_reg, templo1) );      // orr dest_reg, templo1
 			}
-		} else {
+		} else
+#endif
+		{
 			cache_checkinstr(2);
 			cache_addw( LDR_IMM(dest_reg, data_reg, 0) );      // ldr dest_reg, [data_reg]
 		}
 	} else {
+#if !defined(C_UNALIGNED_MEMORY)
 		if ((Bit32u)data & 1) {
 			cache_checkinstr(8);
 			cache_addw( LDRB_IMM(dest_reg, data_reg, 0) );      // ldrb dest_reg, [data_reg]
 			cache_addw( LDRB_IMM(templo1, data_reg, 1) );      // ldrb templo1, [data_reg, #1]
 			cache_addw( LSL_IMM(templo1, templo1, 8) );      // lsl templo1, templo1, #8
 			cache_addw( ORR(dest_reg, templo1) );      // orr dest_reg, templo1
-		} else {
+		} else
+#endif
+		{
 			cache_checkinstr(2);
 			cache_addw( LDRH_IMM(dest_reg, data_reg, 0) );      // ldrh dest_reg, [data_reg]
 		}
@@ -365,8 +463,10 @@
 // move a 32bit (dword==true) or 16bit (dword==false) value from memory into dest_reg
 // 16bit moves may destroy the upper 16bit of the destination register
 static void gen_mov_word_to_reg(HostReg dest_reg,void* data,bool dword) {
-	gen_mov_dword_to_reg_imm(templo2, (Bit32u)data);
-	gen_mov_word_to_reg_helper(dest_reg, data, dword, templo2);
+	if (!gen_mov_memval_to_reg(dest_reg, data, (dword)?4:2)) {
+		gen_mov_dword_to_reg_imm(templo2, (Bit32u)data);
+		gen_mov_word_to_reg_helper(dest_reg, data, dword, templo2);
+	}
 }
 
 // move a 16bit constant value into dest_reg
@@ -375,10 +475,61 @@
 	gen_mov_dword_to_reg_imm(dest_reg, (Bit32u)imm);
 }
 
+// helper function
+static bool gen_mov_memval_from_reg_helper(HostReg src_reg, Bit32u data, Bitu size, HostReg addr_reg, Bit32u addr_data) {
+	switch (size) {
+		case 4:
+#if !defined(C_UNALIGNED_MEMORY)
+			if ((data & 3) == 0)
+#endif
+			{
+				if ((data >= addr_data) && (data < addr_data + 128) && (((data - addr_data) & 3) == 0)) {
+					cache_checkinstr(4);
+					cache_addw( MOV_LO_HI(templo2, addr_reg) );      // mov templo2, addr_reg
+					cache_addw( STR_IMM(src_reg, templo2, data - addr_data) );      // str src_reg, [templo2, #(data - addr_data)]
+					return true;
+				}
+			}
+			break;
+		case 2:
+#if !defined(C_UNALIGNED_MEMORY)
+			if ((data & 1) == 0)
+#endif
+			{
+				if ((data >= addr_data) && (data < addr_data + 64) && (((data - addr_data) & 1) == 0)) {
+					cache_checkinstr(4);
+					cache_addw( MOV_LO_HI(templo2, addr_reg) );      // mov templo2, addr_reg
+					cache_addw( STRH_IMM(src_reg, templo2, data - addr_data) );      // strh src_reg, [templo2, #(data - addr_data)]
+					return true;
+				}
+			}
+			break;
+		case 1:
+			if ((data >= addr_data) && (data < addr_data + 32)) {
+				cache_checkinstr(4);
+				cache_addw( MOV_LO_HI(templo2, addr_reg) );      // mov templo2, addr_reg
+				cache_addw( STRB_IMM(src_reg, templo2, data - addr_data) );      // strb src_reg, [templo2, #(data - addr_data)]
+				return true;
+			}
+		default:
+			break;
+	}
+	return false;
+}
+
+// helper function
+static bool gen_mov_memval_from_reg(HostReg src_reg, void *dest, Bitu size) {
+	if (gen_mov_memval_from_reg_helper(src_reg, (Bit32u)dest, size, FC_REGS_ADDR, (Bit32u)&cpu_regs)) return true;
+	if (gen_mov_memval_from_reg_helper(src_reg, (Bit32u)dest, size, readdata_addr, (Bit32u)&core_dynrec.readdata)) return true;
+	if (gen_mov_memval_from_reg_helper(src_reg, (Bit32u)dest, size, FC_SEGS_ADDR, (Bit32u)&Segs)) return true;
+	return false;
+}
+
 // helper function for gen_mov_word_from_reg
 static void gen_mov_word_from_reg_helper(HostReg src_reg,void* dest,bool dword, HostReg data_reg) {
 	// alignment....
 	if (dword) {
+#if !defined(C_UNALIGNED_MEMORY)
 		if ((Bit32u)dest & 3) {
 			if ( ((Bit32u)dest & 3) == 2 ) {
 				cache_checkinstr(8);
@@ -399,18 +550,23 @@
 				cache_addw( LSR_IMM(templo1, templo1, 24) );      // lsr templo1, templo1, #24
 				cache_addw( STRB_IMM(templo1, data_reg, 3) );      // strb templo1, [data_reg, #3]
 			}
-		} else {
+		} else
+#endif
+		{
 			cache_checkinstr(2);
 			cache_addw( STR_IMM(src_reg, data_reg, 0) );      // str src_reg, [data_reg]
 		}
 	} else {
+#if !defined(C_UNALIGNED_MEMORY)
 		if ((Bit32u)dest & 1) {
 			cache_checkinstr(8);
 			cache_addw( STRB_IMM(src_reg, data_reg, 0) );      // strb src_reg, [data_reg]
 			cache_addw( MOV_REG(templo1, src_reg) );      // mov templo1, src_reg
 			cache_addw( LSR_IMM(templo1, templo1, 8) );      // lsr templo1, templo1, #8
 			cache_addw( STRB_IMM(templo1, data_reg, 1) );      // strb templo1, [data_reg, #1]
-		} else {
+		} else
+#endif
+		{
 			cache_checkinstr(2);
 			cache_addw( STRH_IMM(src_reg, data_reg, 0) );      // strh src_reg, [data_reg]
 		}
@@ -419,8 +575,10 @@
 
 // move 32bit (dword==true) or 16bit (dword==false) of a register into memory
 static void gen_mov_word_from_reg(HostReg src_reg,void* dest,bool dword) {
-	gen_mov_dword_to_reg_imm(templo2, (Bit32u)dest);
-	gen_mov_word_from_reg_helper(src_reg, dest, dword, templo2);
+	if (!gen_mov_memval_from_reg(src_reg, dest, (dword)?4:2)) {
+		gen_mov_dword_to_reg_imm(templo2, (Bit32u)dest);
+		gen_mov_word_from_reg_helper(src_reg, dest, dword, templo2);
+	}
 }
 
 // move an 8bit value from memory into dest_reg
@@ -428,9 +586,11 @@
 // this function does not use FC_OP1/FC_OP2 as dest_reg as these
 // registers might not be directly byte-accessible on some architectures
 static void gen_mov_byte_to_reg_low(HostReg dest_reg,void* data) {
-	gen_mov_dword_to_reg_imm(templo1, (Bit32u)data);
-	cache_checkinstr(2);
-	cache_addw( LDRB_IMM(dest_reg, templo1, 0) );      // ldrb dest_reg, [templo1]
+	if (!gen_mov_memval_to_reg(dest_reg, data, 1)) {
+		gen_mov_dword_to_reg_imm(templo1, (Bit32u)data);
+		cache_checkinstr(2);
+		cache_addw( LDRB_IMM(dest_reg, templo1, 0) );      // ldrb dest_reg, [templo1]
+	}
 }
 
 // move an 8bit value from memory into dest_reg
@@ -460,9 +620,11 @@
 
 // move the lowest 8bit of a register into memory
 static void gen_mov_byte_from_reg_low(HostReg src_reg,void* dest) {
-	gen_mov_dword_to_reg_imm(templo1, (Bit32u)dest);
-	cache_checkinstr(2);
-	cache_addw( STRB_IMM(src_reg, templo1, 0) );      // strb src_reg, [templo1]
+	if (!gen_mov_memval_from_reg(src_reg, dest, 1)) {
+		gen_mov_dword_to_reg_imm(templo1, (Bit32u)dest);
+		cache_checkinstr(2);
+		cache_addw( STRB_IMM(src_reg, templo1, 0) );      // strb src_reg, [templo1]
+	}
 }
 
 
@@ -502,18 +664,58 @@
 
 // add a 32bit constant value to a full register
 static void gen_add_imm(HostReg reg,Bit32u imm) {
+	Bit32u imm2, scale;
+
 	if(!imm) return;
-	gen_mov_dword_to_reg_imm(templo1, imm);
-	cache_checkinstr(2);
-	cache_addw( ADD_REG(reg, reg, templo1) );      // add reg, reg, templo1
+
+	imm2 = (Bit32u) (-((Bit32s)imm));
+
+	if (imm <= 255) {
+		cache_checkinstr(2);
+		cache_addw( ADD_IMM8(reg, imm) );      // add reg, #imm
+	} else if (imm2 <= 255) {
+		cache_checkinstr(2);
+		cache_addw( SUB_IMM8(reg, imm2) );      // sub reg, #(-imm)
+	} else {
+		if (val_single_shift(imm2, &scale)) {
+			cache_checkinstr((scale)?6:4);
+			cache_addw( MOV_IMM(templo1, imm2 >> scale) );      // mov templo1, #(~imm >> scale)
+			if (scale) {
+				cache_addw( LSL_IMM(templo1, templo1, scale) );      // lsl templo1, templo1, #scale
+			}
+			cache_addw( SUB_REG(reg, reg, templo1) );      // sub reg, reg, templo1
+		} else {
+			gen_mov_dword_to_reg_imm(templo1, imm);
+			cache_checkinstr(2);
+			cache_addw( ADD_REG(reg, reg, templo1) );      // add reg, reg, templo1
+		}
+	}
 }
 
 // and a 32bit constant value with a full register
 static void gen_and_imm(HostReg reg,Bit32u imm) {
-	if(imm == 0xffffffff) return;
-	gen_mov_dword_to_reg_imm(templo1, imm);
-	cache_checkinstr(2);
-	cache_addw( AND(reg, templo1) );      // and reg, templo1
+	Bit32u imm2, scale;
+
+	imm2 = ~imm;
+	if(!imm2) return;
+
+	if (!imm) {
+		cache_checkinstr(2);
+		cache_addw( MOV_IMM(reg, 0) );      // mov reg, #0
+	} else {
+		if (val_single_shift(imm2, &scale)) {
+			cache_checkinstr((scale)?6:4);
+			cache_addw( MOV_IMM(templo1, imm2 >> scale) );      // mov templo1, #(~imm >> scale)
+			if (scale) {
+				cache_addw( LSL_IMM(templo1, templo1, scale) );      // lsl templo1, templo1, #scale
+			}
+			cache_addw( BIC(reg, templo1) );      // bic reg, templo1
+		} else {
+			gen_mov_dword_to_reg_imm(templo1, imm);
+			cache_checkinstr(2);
+			cache_addw( AND(reg, templo1) );      // and reg, templo1
+		}
+	}
 }
 
 
@@ -528,70 +730,69 @@
 	gen_mov_direct_dword(dest,(Bit32u)imm);
 }
 
-// add an 8bit constant value to a dword memory value
-static void gen_add_direct_byte(void* dest,Bit8s imm) {
-	if(!imm) return;
-	gen_mov_dword_to_reg_imm(templo2, (Bit32u)dest);
-	gen_mov_word_to_reg_helper(templo3, dest, 1, templo2);
-	cache_checkinstr(2);
-	if (imm >= 0) {
-		cache_addw( ADD_IMM8(templo3, (Bit32s)imm) );      // add templo3, #(imm)
-	} else {
-		cache_addw( SUB_IMM8(templo3, -((Bit32s)imm)) );      // sub templo3, #(-imm)
-	}
-	gen_mov_word_from_reg_helper(templo3, dest, 1, templo2);
-}
-
 // add a 32bit (dword==true) or 16bit (dword==false) constant value to a memory value
 static void gen_add_direct_word(void* dest,Bit32u imm,bool dword) {
+	if (!dword) imm &= 0xffff;
 	if(!imm) return;
-	if (dword && ( (imm<128) || (imm>=0xffffff80) ) ) {
-		gen_add_direct_byte(dest,(Bit8s)imm);
-		return;
-	}
-	gen_mov_dword_to_reg_imm(templo2, (Bit32u)dest);
-	gen_mov_word_to_reg_helper(templo3, dest, dword, templo2);
-	if (dword) {
-		gen_mov_dword_to_reg_imm(templo1, imm);
-	} else {
-		gen_mov_word_to_reg_imm(templo1, (Bit16u)imm);
+
+	if (!gen_mov_memval_to_reg(templo3, dest, (dword)?4:2)) {
+		gen_mov_dword_to_reg_imm(templo2, (Bit32u)dest);
+		gen_mov_word_to_reg_helper(templo3, dest, dword, templo2);
+	}
+	gen_add_imm(templo3, imm);
+	if (!gen_mov_memval_from_reg(templo3, dest, (dword)?4:2)) {
+		gen_mov_word_from_reg_helper(templo3, dest, dword, templo2);
 	}
-	cache_checkinstr(2);
-	cache_addw( ADD_REG(templo3, templo3, templo1) );      // add templo3, templo3, templo1
-	gen_mov_word_from_reg_helper(templo3, dest, dword, templo2);
 }
 
-// subtract an 8bit constant value from a dword memory value
-static void gen_sub_direct_byte(void* dest,Bit8s imm) {
-	if(!imm) return;
-	gen_mov_dword_to_reg_imm(templo2, (Bit32u)dest);
-	gen_mov_word_to_reg_helper(templo3, dest, 1, templo2);
-	cache_checkinstr(2);
-	if (imm >= 0) {
-		cache_addw( SUB_IMM8(templo3, (Bit32s)imm) );      // sub templo3, #(imm)
-	} else {
-		cache_addw( ADD_IMM8(templo3, -((Bit32s)imm)) );      // add templo3, #(-imm)
-	}
-	gen_mov_word_from_reg_helper(templo3, dest, 1, templo2);
+// add an 8bit constant value to a dword memory value
+static void gen_add_direct_byte(void* dest,Bit8s imm) {
+	gen_add_direct_word(dest, (Bit32s)imm, 1);
 }
 
 // subtract a 32bit (dword==true) or 16bit (dword==false) constant value from a memory value
 static void gen_sub_direct_word(void* dest,Bit32u imm,bool dword) {
+	Bit32u imm2, scale;
+
+	if (!dword) imm &= 0xffff;
 	if(!imm) return;
-	if (dword && ( (imm<128) || (imm>=0xffffff80) ) ) {
-		gen_sub_direct_byte(dest,(Bit8s)imm);
-		return;
+
+	if (!gen_mov_memval_to_reg(templo3, dest, (dword)?4:2)) {
+		gen_mov_dword_to_reg_imm(templo2, (Bit32u)dest);
+		gen_mov_word_to_reg_helper(templo3, dest, dword, templo2);
 	}
-	gen_mov_dword_to_reg_imm(templo2, (Bit32u)dest);
-	gen_mov_word_to_reg_helper(templo3, dest, dword, templo2);
-	if (dword) {
-		gen_mov_dword_to_reg_imm(templo1, imm);
+
+	imm2 = (Bit32u) (-((Bit32s)imm));
+
+	if (imm <= 255) {
+		cache_checkinstr(2);
+		cache_addw( SUB_IMM8(templo3, imm) );      // sub templo3, #imm
+	} else if (imm2 <= 255) {
+		cache_checkinstr(2);
+		cache_addw( ADD_IMM8(templo3, imm2) );      // add templo3, #(-imm)
 	} else {
-		gen_mov_word_to_reg_imm(templo1, (Bit16u)imm);
+		if (val_single_shift(imm2, &scale)) {
+			cache_checkinstr((scale)?6:4);
+			cache_addw( MOV_IMM(templo1, imm2 >> scale) );      // mov templo1, #(~imm >> scale)
+			if (scale) {
+				cache_addw( LSL_IMM(templo1, templo1, scale) );      // lsl templo1, templo1, #scale
+			}
+			cache_addw( ADD_REG(templo3, templo3, templo1) );      // add templo3, templo3, templo1
+		} else {
+			gen_mov_dword_to_reg_imm(templo1, imm);
+			cache_checkinstr(2);
+			cache_addw( SUB_REG(templo3, templo3, templo1) );      // sub templo3, templo3, templo1
+		}
 	}
-	cache_checkinstr(2);
-	cache_addw( SUB_REG(templo3, templo3, templo1) );      // sub templo3, templo3, templo1
-	gen_mov_word_from_reg_helper(templo3, dest, dword, templo2);
+
+	if (!gen_mov_memval_from_reg(templo3, dest, (dword)?4:2)) {
+		gen_mov_word_from_reg_helper(templo3, dest, dword, templo2);
+	}
+}
+
+// subtract an 8bit constant value from a dword memory value
+static void gen_sub_direct_byte(void* dest,Bit8s imm) {
+	gen_sub_direct_word(dest, (Bit32s)imm, 1);
 }
 
 // effective address calculation, destination is dest_reg
@@ -695,20 +896,22 @@
 static void gen_jmp_ptr(void * ptr,Bits imm=0) {
 	gen_mov_word_to_reg(templo3, ptr, 1);
 
-	if (imm) {
-		gen_mov_dword_to_reg_imm(templo2, imm);
-		cache_checkinstr(2);
-		cache_addw( ADD_REG(templo3, templo3, templo2) );      // add templo3, templo3, templo2
-	}
-
-#if (1)
-// (*ptr) should be word aligned 
+#if !defined(C_UNALIGNED_MEMORY)
+// (*ptr) should be word aligned
 	if ((imm & 0x03) == 0) {
-		cache_checkinstr(6);
-		cache_addw( LDR_IMM(templo2, templo3, 0) );      // ldr templo2, [templo3]
-	} else
 #endif
-	{
+		if ((imm >= 0) && (imm < 128) && ((imm & 3) == 0)) {
+			cache_checkinstr(6);
+			cache_addw( LDR_IMM(templo2, templo3, imm) );      // ldr templo2, [templo3, #imm]
+		} else {
+			gen_mov_dword_to_reg_imm(templo2, imm);
+			cache_checkinstr(6);
+			cache_addw( LDR_REG(templo2, templo3, templo2) );      // ldr templo2, [templo3, templo2]
+		}
+#if !defined(C_UNALIGNED_MEMORY)
+	} else {
+		gen_add_imm(templo3, imm);
+
 		cache_checkinstr(24);
 		cache_addw( LDRB_IMM(templo2, templo3, 0) );      // ldrb templo2, [templo3]
 		cache_addw( LDRB_IMM(templo1, templo3, 1) );      // ldrb templo1, [templo3, #1]
@@ -721,6 +924,7 @@
 		cache_addw( LSL_IMM(templo1, templo1, 24) );      // lsl templo1, templo1, #24
 		cache_addw( ORR(templo2, templo1) );      // orr templo2, templo1
 	}
+#endif
 
 	// increase jmp address to keep thumb state
 	cache_addw( ADD_IMM3(templo2, templo2, 1) );      // add templo2, templo2, #1
@@ -816,50 +1020,53 @@
 }
 
 static void gen_run_code(void) {
-	// switch from arm to thumb state
-	cache_addd(0xe2800000 + (HOST_r3 << 12) + (HOST_pc << 16) + (1));      // add r3, pc, #1
-	cache_addd(0xe12fff10 + (HOST_r3));      // bx r3
+	Bit8u *pos1, *pos2, *pos3;
 
-	// thumb state from now on
-	cache_addw(0xb500);      // push {lr}
-	cache_addw( MOV_LO_HI(HOST_r3, FC_SEGS_ADDR) );      // mov r3, FC_SEGS_ADDR
-	cache_addw( MOV_LO_HI(HOST_r2, FC_REGS_ADDR) );      // mov r2, FC_REGS_ADDR
-	cache_addw(0xb4fc);      // push {r2,r3,v1-v4}
-
-	// adr: 16
-	cache_addw( LDR_PC_IMM(HOST_r3, 64 - (16 + 4)) );        // ldr r3, [pc, #(&Segs)]
-	// adr: 18
-	cache_addw( LDR_PC_IMM(HOST_r2, 68 - (18 + 2)) );        // ldr r2, [pc, #(&cpu_regs)]
-	cache_addw( MOV_HI_LO(FC_SEGS_ADDR, HOST_r3) );      // mov FC_SEGS_ADDR, r3
-	cache_addw( MOV_HI_LO(FC_REGS_ADDR, HOST_r2) );      // mov FC_REGS_ADDR, r2
-
-	// align 4
-	cache_addw( ADD_LO_PC_IMM(HOST_r3, 8) );      // add r3, pc, #8
-	cache_addw( ADD_IMM8(HOST_r0, 1) );      // add r0, #1
-	cache_addw( ADD_IMM8(HOST_r3, 1) );      // add r3, #1
-	cache_addw(0xb408);      // push {r3}
-	cache_addw( BX(HOST_r0) );      // bx r0
-	cache_addw( NOP );      // nop
-
-	// align 4
-	cache_addw(0xbcfc);      // pop {r2,r3,v1-v4}
-	cache_addw( MOV_HI_LO(FC_SEGS_ADDR, HOST_r3) );      // mov FC_SEGS_ADDR, r3
-	cache_addw( MOV_HI_LO(FC_REGS_ADDR, HOST_r2) );      // mov FC_REGS_ADDR, r2
-
-	cache_addw(0xbc08);      // pop {r3}
-	cache_addw( BX(HOST_r3) );      // bx r3
-
-	// fill up to 64 bytes
-	cache_addw( NOP );      // nop
-	cache_addd( NOP | (NOP << 16) );  // nop, nop
-	cache_addd( NOP | (NOP << 16) );  // nop, nop
-	cache_addd( NOP | (NOP << 16) );  // nop, nop
-	cache_addd( NOP | (NOP << 16) );  // nop, nop
+#if (__ARM_EABI__)
+	// 8-byte stack alignment
+	cache_addd(0xe92d4ff0);			// stmfd sp!, {v1-v8,lr}
+#else
+	cache_addd(0xe92d4df0);			// stmfd sp!, {v1-v5,v7,v8,lr}
+#endif
+
+	cache_addd( ARM_ADD_IMM(HOST_r0, HOST_r0, 1, 0) );      // add r0, r0, #1
 
-	// adr: 64
+	pos1 = cache.pos;
+	cache_addd( 0 );
+	pos2 = cache.pos;
+	cache_addd( 0 );
+	pos3 = cache.pos;
+	cache_addd( 0 );
+
+	cache_addd( ARM_ADD_IMM(HOST_lr, HOST_pc, 4, 0) );			// add lr, pc, #4
+	cache_addd( ARM_STR_IMM_M_W(HOST_lr, HOST_sp, 4) );      // str lr, [sp, #-4]!
+	cache_addd( ARM_BX(HOST_r0) );			// bx r0
+
+#if (__ARM_EABI__)
+	cache_addd(0xe8bd4ff0);			// ldmfd sp!, {v1-v8,lr}
+#else
+	cache_addd(0xe8bd4df0);			// ldmfd sp!, {v1-v5,v7,v8,lr}
+#endif
+	cache_addd( ARM_BX(HOST_lr) );			// bx lr
+
+	// align cache.pos to 32 bytes
+	if ((((Bitu)cache.pos) & 0x1f) != 0) {
+		cache.pos = cache.pos + (32 - (((Bitu)cache.pos) & 0x1f));
+	}
+
+	*(Bit32u*)pos1 = ARM_LDR_IMM(FC_SEGS_ADDR, HOST_pc, cache.pos - (pos1 + 8));      // ldr FC_SEGS_ADDR, [pc, #(&Segs)]
 	cache_addd((Bit32u)&Segs);      // address of "Segs"
-	// adr: 68
+
+	*(Bit32u*)pos2 = ARM_LDR_IMM(FC_REGS_ADDR, HOST_pc, cache.pos - (pos2 + 8));      // ldr FC_REGS_ADDR, [pc, #(&cpu_regs)]
 	cache_addd((Bit32u)&cpu_regs);  // address of "cpu_regs"
+
+	*(Bit32u*)pos3 = ARM_LDR_IMM(readdata_addr, HOST_pc, cache.pos - (pos3 + 8));      // ldr readdata_addr, [pc, #(&core_dynrec.readdata)]
+	cache_addd((Bit32u)&core_dynrec.readdata);  // address of "core_dynrec.readdata"
+
+	// align cache.pos to 32 bytes
+	if ((((Bitu)cache.pos) & 0x1f) != 0) {
+		cache.pos = cache.pos + (32 - (((Bitu)cache.pos) & 0x1f));
+	}
 }
 
 // return from a function
diff -Nur dosbox-0.74/src/cpu/core_dynrec/risc_armv4le-thumb-niw.h dosbox-0.74.patch/src/cpu/core_dynrec/risc_armv4le-thumb-niw.h
--- dosbox-0.74/src/cpu/core_dynrec/risc_armv4le-thumb-niw.h	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/cpu/core_dynrec/risc_armv4le-thumb-niw.h	2016-12-11 18:35:15.510284006 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: risc_armv4le-thumb-niw.h,v 1.5 2009-06-27 12:51:10 c2woody Exp $ */
 
 
 /* ARMv4 (little endian) backend by M-HT (thumb version with data pool) */
@@ -51,15 +50,14 @@
 // temporary register for LEA
 #define TEMP_REG_DRC HOST_a4
 
-#ifdef DRC_USE_REGS_ADDR
 // used to hold the address of "cpu_regs" - preferably filled in function gen_run_code
 #define FC_REGS_ADDR HOST_v7
-#endif
 
-#ifdef DRC_USE_SEGS_ADDR
 // used to hold the address of "Segs" - preferably filled in function gen_run_code
 #define FC_SEGS_ADDR HOST_v8
-#endif
+
+// used to hold the address of "core_dynrec.readdata" - filled in function gen_run_code
+#define readdata_addr HOST_v5
 
 
 // instruction encodings
@@ -99,10 +97,14 @@
 // logical
 // and dst, src
 #define AND(dst, src) (0x4000 + (dst) + ((src) << 3) )
+// bic dst, src
+#define BIC(dst, src) (0x4380 + (dst) + ((src) << 3) )
 // eor dst, src
 #define EOR(dst, src) (0x4040 + (dst) + ((src) << 3) )
 // orr dst, src
 #define ORR(dst, src) (0x4300 + (dst) + ((src) << 3) )
+// mvn dst, src
+#define MVN(dst, src) (0x43c0 + (dst) + ((src) << 3) )
 
 // shift/rotate
 // lsl dst, src, #imm
@@ -129,6 +131,8 @@
 #define LDRB_IMM(reg, addr, imm) (0x7800 + (reg) + ((addr) << 3) + ((imm) << 6) )
 // ldr reg, [pc, #imm]		@	0 <= imm < 1024	&	imm mod 4 = 0
 #define LDR_PC_IMM(reg, imm) (0x4800 + ((reg) << 8) + ((imm) >> 2) )
+// ldr reg, [addr1, addr2]
+#define LDR_REG(reg, addr1, addr2) (0x5800 + (reg) + ((addr1) << 3) + ((addr2) << 6) )
 
 // store
 // str reg, [addr, #imm]		@	0 <= imm < 128	&	imm mod 4 = 0
@@ -151,6 +155,25 @@
 #define BX(reg) (0x4700 + ((reg) << 3) )
 
 
+// arm instructions
+
+// arithmetic
+// add dst, src, #(imm ror rimm)		@	0 <= imm <= 255	&	rimm mod 2 = 0
+#define ARM_ADD_IMM(dst, src, imm, rimm) (0xe2800000 + ((dst) << 12) + ((src) << 16) + (imm) + ((rimm) << 7) )
+
+// load
+// ldr reg, [addr, #imm]		@	0 <= imm < 4096
+#define ARM_LDR_IMM(reg, addr, imm) (0xe5900000 + ((reg) << 12) + ((addr) << 16) + (imm) )
+
+// store
+// str reg, [addr, #-(imm)]!		@	0 <= imm < 4096
+#define ARM_STR_IMM_M_W(reg, addr, imm) (0xe5200000 + ((reg) << 12) + ((addr) << 16) + (imm) )
+
+// branch
+// bx reg
+#define ARM_BX(reg) (0xe12fff10 + (reg) )
+
+
 // data pool defines
 #define CACHE_DATA_JUMP	 (2)
 #define CACHE_DATA_ALIGN (32)
@@ -194,7 +217,7 @@
 		cache_datapos = (Bit8u *) (((Bitu)cache.block.active->cache.start + cache.block.active->cache.size - CACHE_DATA_ALIGN) & ~(CACHE_DATA_ALIGN - 1));
 	} else {
 		register Bit32u cachemodsize;
-	
+
 		cachemodsize = (cache.pos - cache.block.active->cache.start) & (CACHE_MAXSIZE - 1);
 
 		if (cachemodsize + CACHE_DATA_MAX + CACHE_DATA_ALIGN <= CACHE_MAXSIZE ||
@@ -276,30 +299,49 @@
 	cache_addw( MOV_REG(reg_dst, reg_src) );      // mov reg_dst, reg_src
 }
 
+// helper function
+static bool val_single_shift(Bit32u value, Bit32u *val_shift) {
+	Bit32u shift;
+
+	if (GCC_UNLIKELY(value == 0)) {
+		*val_shift = 0;
+		return true;
+	}
+
+	shift = 0;
+	while ((value & 1) == 0) {
+		value>>=1;
+		shift+=1;
+	}
+
+	if ((value >> 8) != 0) return false;
+
+	*val_shift = shift;
+	return true;
+}
+
 // move a 32bit constant value into dest_reg
 static void gen_mov_dword_to_reg_imm(HostReg dest_reg,Bit32u imm) {
-	if ((imm & 0xffffff00) == 0) {
+	Bit32u scale;
+
+	if (imm < 256) {
 		cache_checkinstr(2);
 		cache_addw( MOV_IMM(dest_reg, imm) );      // mov dest_reg, #(imm)
-	} else if ((imm & 0xffff00ff) == 0) {
+	} else if ((~imm) < 256) {
 		cache_checkinstr(4);
-		cache_addw( MOV_IMM(dest_reg, imm >> 8) );      // mov dest_reg, #(imm >> 8)
-		cache_addw( LSL_IMM(dest_reg, dest_reg, 8) );      // lsl dest_reg, dest_reg, #8
-	} else if ((imm & 0xff00ffff) == 0) {
+		cache_addw( MOV_IMM(dest_reg, ~imm) );      // mov dest_reg, #(~imm)
+		cache_addw( MVN(dest_reg, dest_reg) );      // mvn dest_reg, dest_reg
+	} else if (val_single_shift(imm, &scale)) {
 		cache_checkinstr(4);
-		cache_addw( MOV_IMM(dest_reg, imm >> 16) );      // mov dest_reg, #(imm >> 16)
-		cache_addw( LSL_IMM(dest_reg, dest_reg, 16) );      // lsl dest_reg, dest_reg, #16
-	} else if ((imm & 0x00ffffff) == 0) {
-		cache_checkinstr(4);
-		cache_addw( MOV_IMM(dest_reg, imm >> 24) );      // mov dest_reg, #(imm >> 24)
-		cache_addw( LSL_IMM(dest_reg, dest_reg, 24) );      // lsl dest_reg, dest_reg, #24
+		cache_addw( MOV_IMM(dest_reg, imm >> scale) );      // mov dest_reg, #(imm >> scale)
+		cache_addw( LSL_IMM(dest_reg, dest_reg, scale) );      // lsl dest_reg, dest_reg, #scale
 	} else {
 		Bit32u diff;
 
 		cache_checkinstr(4);
 
 		diff = imm - ((Bit32u)cache.pos+4);
-		
+
 		if ((diff < 1024) && ((imm & 0x03) == 0)) {
 			if (((Bit32u)cache.pos & 0x03) == 0) {
 				cache_addw( ADD_LO_PC_IMM(dest_reg, diff >> 2) );      // add dest_reg, pc, #(diff >> 2)
@@ -322,10 +364,61 @@
 	}
 }
 
+// helper function
+static bool gen_mov_memval_to_reg_helper(HostReg dest_reg, Bit32u data, Bitu size, HostReg addr_reg, Bit32u addr_data) {
+	switch (size) {
+		case 4:
+#if !defined(C_UNALIGNED_MEMORY)
+			if ((data & 3) == 0)
+#endif
+			{
+				if ((data >= addr_data) && (data < addr_data + 128) && (((data - addr_data) & 3) == 0)) {
+					cache_checkinstr(4);
+					cache_addw( MOV_LO_HI(templo2, addr_reg) );      // mov templo2, addr_reg
+					cache_addw( LDR_IMM(dest_reg, templo2, data - addr_data) );      // ldr dest_reg, [templo2, #(data - addr_data)]
+					return true;
+				}
+			}
+			break;
+		case 2:
+#if !defined(C_UNALIGNED_MEMORY)
+			if ((data & 1) == 0)
+#endif
+			{
+				if ((data >= addr_data) && (data < addr_data + 64) && (((data - addr_data) & 1) == 0)) {
+					cache_checkinstr(4);
+					cache_addw( MOV_LO_HI(templo2, addr_reg) );      // mov templo2, addr_reg
+					cache_addw( LDRH_IMM(dest_reg, templo2, data - addr_data) );      // ldrh dest_reg, [templo2, #(data - addr_data)]
+					return true;
+				}
+			}
+			break;
+		case 1:
+			if ((data >= addr_data) && (data < addr_data + 32)) {
+				cache_checkinstr(4);
+				cache_addw( MOV_LO_HI(templo2, addr_reg) );      // mov templo2, addr_reg
+				cache_addw( LDRB_IMM(dest_reg, templo2, data - addr_data) );      // ldrb dest_reg, [templo2, #(data - addr_data)]
+				return true;
+			}
+		default:
+			break;
+	}
+	return false;
+}
+
+// helper function
+static bool gen_mov_memval_to_reg(HostReg dest_reg, void *data, Bitu size) {
+	if (gen_mov_memval_to_reg_helper(dest_reg, (Bit32u)data, size, FC_REGS_ADDR, (Bit32u)&cpu_regs)) return true;
+	if (gen_mov_memval_to_reg_helper(dest_reg, (Bit32u)data, size, readdata_addr, (Bit32u)&core_dynrec.readdata)) return true;
+	if (gen_mov_memval_to_reg_helper(dest_reg, (Bit32u)data, size, FC_SEGS_ADDR, (Bit32u)&Segs)) return true;
+	return false;
+}
+
 // helper function for gen_mov_word_to_reg
 static void gen_mov_word_to_reg_helper(HostReg dest_reg,void* data,bool dword,HostReg data_reg) {
 	// alignment....
 	if (dword) {
+#if !defined(C_UNALIGNED_MEMORY)
 		if ((Bit32u)data & 3) {
 			if ( ((Bit32u)data & 3) == 2 ) {
 				cache_checkinstr(8);
@@ -344,18 +437,23 @@
 				cache_addw( LSL_IMM(templo1, templo1, 24) );      // lsl templo1, templo1, #24
 				cache_addw( ORR(dest_reg, templo1) );      // orr dest_reg, templo1
 			}
-		} else {
+		} else
+#endif
+		{
 			cache_checkinstr(2);
 			cache_addw( LDR_IMM(dest_reg, data_reg, 0) );      // ldr dest_reg, [data_reg]
 		}
 	} else {
+#if !defined(C_UNALIGNED_MEMORY)
 		if ((Bit32u)data & 1) {
 			cache_checkinstr(8);
 			cache_addw( LDRB_IMM(dest_reg, data_reg, 0) );      // ldrb dest_reg, [data_reg]
 			cache_addw( LDRB_IMM(templo1, data_reg, 1) );      // ldrb templo1, [data_reg, #1]
 			cache_addw( LSL_IMM(templo1, templo1, 8) );      // lsl templo1, templo1, #8
 			cache_addw( ORR(dest_reg, templo1) );      // orr dest_reg, templo1
-		} else {
+		} else
+#endif
+		{
 			cache_checkinstr(2);
 			cache_addw( LDRH_IMM(dest_reg, data_reg, 0) );      // ldrh dest_reg, [data_reg]
 		}
@@ -365,8 +463,10 @@
 // move a 32bit (dword==true) or 16bit (dword==false) value from memory into dest_reg
 // 16bit moves may destroy the upper 16bit of the destination register
 static void gen_mov_word_to_reg(HostReg dest_reg,void* data,bool dword) {
-	gen_mov_dword_to_reg_imm(templo2, (Bit32u)data);
-	gen_mov_word_to_reg_helper(dest_reg, data, dword, templo2);
+	if (!gen_mov_memval_to_reg(dest_reg, data, (dword)?4:2)) {
+		gen_mov_dword_to_reg_imm(templo2, (Bit32u)data);
+		gen_mov_word_to_reg_helper(dest_reg, data, dword, templo2);
+	}
 }
 
 // move a 16bit constant value into dest_reg
@@ -375,10 +475,61 @@
 	gen_mov_dword_to_reg_imm(dest_reg, (Bit32u)imm);
 }
 
+// helper function
+static bool gen_mov_memval_from_reg_helper(HostReg src_reg, Bit32u data, Bitu size, HostReg addr_reg, Bit32u addr_data) {
+	switch (size) {
+		case 4:
+#if !defined(C_UNALIGNED_MEMORY)
+			if ((data & 3) == 0)
+#endif
+			{
+				if ((data >= addr_data) && (data < addr_data + 128) && (((data - addr_data) & 3) == 0)) {
+					cache_checkinstr(4);
+					cache_addw( MOV_LO_HI(templo2, addr_reg) );      // mov templo2, addr_reg
+					cache_addw( STR_IMM(src_reg, templo2, data - addr_data) );      // str src_reg, [templo2, #(data - addr_data)]
+					return true;
+				}
+			}
+			break;
+		case 2:
+#if !defined(C_UNALIGNED_MEMORY)
+			if ((data & 1) == 0)
+#endif
+			{
+				if ((data >= addr_data) && (data < addr_data + 64) && (((data - addr_data) & 1) == 0)) {
+					cache_checkinstr(4);
+					cache_addw( MOV_LO_HI(templo2, addr_reg) );      // mov templo2, addr_reg
+					cache_addw( STRH_IMM(src_reg, templo2, data - addr_data) );      // strh src_reg, [templo2, #(data - addr_data)]
+					return true;
+				}
+			}
+			break;
+		case 1:
+			if ((data >= addr_data) && (data < addr_data + 32)) {
+				cache_checkinstr(4);
+				cache_addw( MOV_LO_HI(templo2, addr_reg) );      // mov templo2, addr_reg
+				cache_addw( STRB_IMM(src_reg, templo2, data - addr_data) );      // strb src_reg, [templo2, #(data - addr_data)]
+				return true;
+			}
+		default:
+			break;
+	}
+	return false;
+}
+
+// helper function
+static bool gen_mov_memval_from_reg(HostReg src_reg, void *dest, Bitu size) {
+	if (gen_mov_memval_from_reg_helper(src_reg, (Bit32u)dest, size, FC_REGS_ADDR, (Bit32u)&cpu_regs)) return true;
+	if (gen_mov_memval_from_reg_helper(src_reg, (Bit32u)dest, size, readdata_addr, (Bit32u)&core_dynrec.readdata)) return true;
+	if (gen_mov_memval_from_reg_helper(src_reg, (Bit32u)dest, size, FC_SEGS_ADDR, (Bit32u)&Segs)) return true;
+	return false;
+}
+
 // helper function for gen_mov_word_from_reg
 static void gen_mov_word_from_reg_helper(HostReg src_reg,void* dest,bool dword, HostReg data_reg) {
 	// alignment....
 	if (dword) {
+#if !defined(C_UNALIGNED_MEMORY)
 		if ((Bit32u)dest & 3) {
 			if ( ((Bit32u)dest & 3) == 2 ) {
 				cache_checkinstr(8);
@@ -399,18 +550,23 @@
 				cache_addw( LSR_IMM(templo1, templo1, 24) );      // lsr templo1, templo1, #24
 				cache_addw( STRB_IMM(templo1, data_reg, 3) );      // strb templo1, [data_reg, #3]
 			}
-		} else {
+		} else
+#endif
+		{
 			cache_checkinstr(2);
 			cache_addw( STR_IMM(src_reg, data_reg, 0) );      // str src_reg, [data_reg]
 		}
 	} else {
+#if !defined(C_UNALIGNED_MEMORY)
 		if ((Bit32u)dest & 1) {
 			cache_checkinstr(8);
 			cache_addw( STRB_IMM(src_reg, data_reg, 0) );      // strb src_reg, [data_reg]
 			cache_addw( MOV_REG(templo1, src_reg) );      // mov templo1, src_reg
 			cache_addw( LSR_IMM(templo1, templo1, 8) );      // lsr templo1, templo1, #8
 			cache_addw( STRB_IMM(templo1, data_reg, 1) );      // strb templo1, [data_reg, #1]
-		} else {
+		} else
+#endif
+		{
 			cache_checkinstr(2);
 			cache_addw( STRH_IMM(src_reg, data_reg, 0) );      // strh src_reg, [data_reg]
 		}
@@ -419,8 +575,10 @@
 
 // move 32bit (dword==true) or 16bit (dword==false) of a register into memory
 static void gen_mov_word_from_reg(HostReg src_reg,void* dest,bool dword) {
-	gen_mov_dword_to_reg_imm(templo2, (Bit32u)dest);
-	gen_mov_word_from_reg_helper(src_reg, dest, dword, templo2);
+	if (!gen_mov_memval_from_reg(src_reg, dest, (dword)?4:2)) {
+		gen_mov_dword_to_reg_imm(templo2, (Bit32u)dest);
+		gen_mov_word_from_reg_helper(src_reg, dest, dword, templo2);
+	}
 }
 
 // move an 8bit value from memory into dest_reg
@@ -428,9 +586,11 @@
 // this function does not use FC_OP1/FC_OP2 as dest_reg as these
 // registers might not be directly byte-accessible on some architectures
 static void gen_mov_byte_to_reg_low(HostReg dest_reg,void* data) {
-	gen_mov_dword_to_reg_imm(templo1, (Bit32u)data);
-	cache_checkinstr(2);
-	cache_addw( LDRB_IMM(dest_reg, templo1, 0) );      // ldrb dest_reg, [templo1]
+	if (!gen_mov_memval_to_reg(dest_reg, data, 1)) {
+		gen_mov_dword_to_reg_imm(templo1, (Bit32u)data);
+		cache_checkinstr(2);
+		cache_addw( LDRB_IMM(dest_reg, templo1, 0) );      // ldrb dest_reg, [templo1]
+	}
 }
 
 // move an 8bit value from memory into dest_reg
@@ -460,9 +620,11 @@
 
 // move the lowest 8bit of a register into memory
 static void gen_mov_byte_from_reg_low(HostReg src_reg,void* dest) {
-	gen_mov_dword_to_reg_imm(templo1, (Bit32u)dest);
-	cache_checkinstr(2);
-	cache_addw( STRB_IMM(src_reg, templo1, 0) );      // strb src_reg, [templo1]
+	if (!gen_mov_memval_from_reg(src_reg, dest, 1)) {
+		gen_mov_dword_to_reg_imm(templo1, (Bit32u)dest);
+		cache_checkinstr(2);
+		cache_addw( STRB_IMM(src_reg, templo1, 0) );      // strb src_reg, [templo1]
+	}
 }
 
 
@@ -502,18 +664,58 @@
 
 // add a 32bit constant value to a full register
 static void gen_add_imm(HostReg reg,Bit32u imm) {
+	Bit32u imm2, scale;
+
 	if(!imm) return;
-	gen_mov_dword_to_reg_imm(templo1, imm);
-	cache_checkinstr(2);
-	cache_addw( ADD_REG(reg, reg, templo1) );      // add reg, reg, templo1
+
+	imm2 = (Bit32u) (-((Bit32s)imm));
+
+	if (imm <= 255) {
+		cache_checkinstr(2);
+		cache_addw( ADD_IMM8(reg, imm) );      // add reg, #imm
+	} else if (imm2 <= 255) {
+		cache_checkinstr(2);
+		cache_addw( SUB_IMM8(reg, imm2) );      // sub reg, #(-imm)
+	} else {
+		if (val_single_shift(imm2, &scale)) {
+			cache_checkinstr((scale)?6:4);
+			cache_addw( MOV_IMM(templo1, imm2 >> scale) );      // mov templo1, #(~imm >> scale)
+			if (scale) {
+				cache_addw( LSL_IMM(templo1, templo1, scale) );      // lsl templo1, templo1, #scale
+			}
+			cache_addw( SUB_REG(reg, reg, templo1) );      // sub reg, reg, templo1
+		} else {
+			gen_mov_dword_to_reg_imm(templo1, imm);
+			cache_checkinstr(2);
+			cache_addw( ADD_REG(reg, reg, templo1) );      // add reg, reg, templo1
+		}
+	}
 }
 
 // and a 32bit constant value with a full register
 static void gen_and_imm(HostReg reg,Bit32u imm) {
-	if(imm == 0xffffffff) return;
-	gen_mov_dword_to_reg_imm(templo1, imm);
-	cache_checkinstr(2);
-	cache_addw( AND(reg, templo1) );      // and reg, templo1
+	Bit32u imm2, scale;
+
+	imm2 = ~imm;
+	if(!imm2) return;
+
+	if (!imm) {
+		cache_checkinstr(2);
+		cache_addw( MOV_IMM(reg, 0) );      // mov reg, #0
+	} else {
+		if (val_single_shift(imm2, &scale)) {
+			cache_checkinstr((scale)?6:4);
+			cache_addw( MOV_IMM(templo1, imm2 >> scale) );      // mov templo1, #(~imm >> scale)
+			if (scale) {
+				cache_addw( LSL_IMM(templo1, templo1, scale) );      // lsl templo1, templo1, #scale
+			}
+			cache_addw( BIC(reg, templo1) );      // bic reg, templo1
+		} else {
+			gen_mov_dword_to_reg_imm(templo1, imm);
+			cache_checkinstr(2);
+			cache_addw( AND(reg, templo1) );      // and reg, templo1
+		}
+	}
 }
 
 
@@ -528,70 +730,69 @@
 	gen_mov_direct_dword(dest,(Bit32u)imm);
 }
 
-// add an 8bit constant value to a dword memory value
-static void gen_add_direct_byte(void* dest,Bit8s imm) {
-	if(!imm) return;
-	gen_mov_dword_to_reg_imm(templo2, (Bit32u)dest);
-	gen_mov_word_to_reg_helper(templo3, dest, 1, templo2);
-	cache_checkinstr(2);
-	if (imm >= 0) {
-		cache_addw( ADD_IMM8(templo3, (Bit32s)imm) );      // add templo3, #(imm)
-	} else {
-		cache_addw( SUB_IMM8(templo3, -((Bit32s)imm)) );      // sub templo3, #(-imm)
-	}
-	gen_mov_word_from_reg_helper(templo3, dest, 1, templo2);
-}
-
 // add a 32bit (dword==true) or 16bit (dword==false) constant value to a memory value
 static void gen_add_direct_word(void* dest,Bit32u imm,bool dword) {
+	if (!dword) imm &= 0xffff;
 	if(!imm) return;
-	if (dword && ( (imm<128) || (imm>=0xffffff80) ) ) {
-		gen_add_direct_byte(dest,(Bit8s)imm);
-		return;
-	}
-	gen_mov_dword_to_reg_imm(templo2, (Bit32u)dest);
-	gen_mov_word_to_reg_helper(templo3, dest, dword, templo2);
-	if (dword) {
-		gen_mov_dword_to_reg_imm(templo1, imm);
-	} else {
-		gen_mov_word_to_reg_imm(templo1, (Bit16u)imm);
+
+	if (!gen_mov_memval_to_reg(templo3, dest, (dword)?4:2)) {
+		gen_mov_dword_to_reg_imm(templo2, (Bit32u)dest);
+		gen_mov_word_to_reg_helper(templo3, dest, dword, templo2);
+	}
+	gen_add_imm(templo3, imm);
+	if (!gen_mov_memval_from_reg(templo3, dest, (dword)?4:2)) {
+		gen_mov_word_from_reg_helper(templo3, dest, dword, templo2);
 	}
-	cache_checkinstr(2);
-	cache_addw( ADD_REG(templo3, templo3, templo1) );      // add templo3, templo3, templo1
-	gen_mov_word_from_reg_helper(templo3, dest, dword, templo2);
 }
 
-// subtract an 8bit constant value from a dword memory value
-static void gen_sub_direct_byte(void* dest,Bit8s imm) {
-	if(!imm) return;
-	gen_mov_dword_to_reg_imm(templo2, (Bit32u)dest);
-	gen_mov_word_to_reg_helper(templo3, dest, 1, templo2);
-	cache_checkinstr(2);
-	if (imm >= 0) {
-		cache_addw( SUB_IMM8(templo3, (Bit32s)imm) );      // sub templo3, #(imm)
-	} else {
-		cache_addw( ADD_IMM8(templo3, -((Bit32s)imm)) );      // add templo3, #(-imm)
-	}
-	gen_mov_word_from_reg_helper(templo3, dest, 1, templo2);
+// add an 8bit constant value to a dword memory value
+static void gen_add_direct_byte(void* dest,Bit8s imm) {
+	gen_add_direct_word(dest, (Bit32s)imm, 1);
 }
 
 // subtract a 32bit (dword==true) or 16bit (dword==false) constant value from a memory value
 static void gen_sub_direct_word(void* dest,Bit32u imm,bool dword) {
+	Bit32u imm2, scale;
+
+	if (!dword) imm &= 0xffff;
 	if(!imm) return;
-	if (dword && ( (imm<128) || (imm>=0xffffff80) ) ) {
-		gen_sub_direct_byte(dest,(Bit8s)imm);
-		return;
+
+	if (!gen_mov_memval_to_reg(templo3, dest, (dword)?4:2)) {
+		gen_mov_dword_to_reg_imm(templo2, (Bit32u)dest);
+		gen_mov_word_to_reg_helper(templo3, dest, dword, templo2);
 	}
-	gen_mov_dword_to_reg_imm(templo2, (Bit32u)dest);
-	gen_mov_word_to_reg_helper(templo3, dest, dword, templo2);
-	if (dword) {
-		gen_mov_dword_to_reg_imm(templo1, imm);
+
+	imm2 = (Bit32u) (-((Bit32s)imm));
+
+	if (imm <= 255) {
+		cache_checkinstr(2);
+		cache_addw( SUB_IMM8(templo3, imm) );      // sub templo3, #imm
+	} else if (imm2 <= 255) {
+		cache_checkinstr(2);
+		cache_addw( ADD_IMM8(templo3, imm2) );      // add templo3, #(-imm)
 	} else {
-		gen_mov_word_to_reg_imm(templo1, (Bit16u)imm);
+		if (val_single_shift(imm2, &scale)) {
+			cache_checkinstr((scale)?6:4);
+			cache_addw( MOV_IMM(templo1, imm2 >> scale) );      // mov templo1, #(~imm >> scale)
+			if (scale) {
+				cache_addw( LSL_IMM(templo1, templo1, scale) );      // lsl templo1, templo1, #scale
+			}
+			cache_addw( ADD_REG(templo3, templo3, templo1) );      // add templo3, templo3, templo1
+		} else {
+			gen_mov_dword_to_reg_imm(templo1, imm);
+			cache_checkinstr(2);
+			cache_addw( SUB_REG(templo3, templo3, templo1) );      // sub templo3, templo3, templo1
+		}
 	}
-	cache_checkinstr(2);
-	cache_addw( SUB_REG(templo3, templo3, templo1) );      // sub templo3, templo3, templo1
-	gen_mov_word_from_reg_helper(templo3, dest, dword, templo2);
+
+	if (!gen_mov_memval_from_reg(templo3, dest, (dword)?4:2)) {
+		gen_mov_word_from_reg_helper(templo3, dest, dword, templo2);
+	}
+}
+
+// subtract an 8bit constant value from a dword memory value
+static void gen_sub_direct_byte(void* dest,Bit8s imm) {
+	gen_sub_direct_word(dest, (Bit32s)imm, 1);
 }
 
 // effective address calculation, destination is dest_reg
@@ -697,20 +898,22 @@
 static void gen_jmp_ptr(void * ptr,Bits imm=0) {
 	gen_mov_word_to_reg(templo3, ptr, 1);
 
-	if (imm) {
-		gen_mov_dword_to_reg_imm(templo2, imm);
-		cache_checkinstr(2);
-		cache_addw( ADD_REG(templo3, templo3, templo2) );      // add templo3, templo3, templo2
-	}
-
-#if (1)
-// (*ptr) should be word aligned 
+#if !defined(C_UNALIGNED_MEMORY)
+// (*ptr) should be word aligned
 	if ((imm & 0x03) == 0) {
-		cache_checkinstr(6);
-		cache_addw( LDR_IMM(templo2, templo3, 0) );      // ldr templo2, [templo3]
-	} else
 #endif
-	{
+		if ((imm >= 0) && (imm < 128) && ((imm & 3) == 0)) {
+			cache_checkinstr(6);
+			cache_addw( LDR_IMM(templo2, templo3, imm) );      // ldr templo2, [templo3, #imm]
+		} else {
+			gen_mov_dword_to_reg_imm(templo2, imm);
+			cache_checkinstr(6);
+			cache_addw( LDR_REG(templo2, templo3, templo2) );      // ldr templo2, [templo3, templo2]
+		}
+#if !defined(C_UNALIGNED_MEMORY)
+	} else {
+		gen_add_imm(templo3, imm);
+
 		cache_checkinstr(24);
 		cache_addw( LDRB_IMM(templo2, templo3, 0) );      // ldrb templo2, [templo3]
 		cache_addw( LDRB_IMM(templo1, templo3, 1) );      // ldrb templo1, [templo3, #1]
@@ -723,6 +926,7 @@
 		cache_addw( LSL_IMM(templo1, templo1, 24) );      // lsl templo1, templo1, #24
 		cache_addw( ORR(templo2, templo1) );      // orr templo2, templo1
 	}
+#endif
 
 	// increase jmp address to keep thumb state
 	cache_addw( ADD_IMM3(templo2, templo2, 1) );      // add templo2, templo2, #1
@@ -818,50 +1022,53 @@
 }
 
 static void gen_run_code(void) {
-	// switch from arm to thumb state
-	cache_addd(0xe2800000 + (HOST_r3 << 12) + (HOST_pc << 16) + (1));      // add r3, pc, #1
-	cache_addd(0xe12fff10 + (HOST_r3));      // bx r3
+	Bit8u *pos1, *pos2, *pos3;
 
-	// thumb state from now on
-	cache_addw(0xb500);      // push {lr}
-	cache_addw( MOV_LO_HI(HOST_r3, FC_SEGS_ADDR) );      // mov r3, FC_SEGS_ADDR
-	cache_addw( MOV_LO_HI(HOST_r2, FC_REGS_ADDR) );      // mov r2, FC_REGS_ADDR
-	cache_addw(0xb4fc);      // push {r2,r3,v1-v4}
-
-	// adr: 16
-	cache_addw( LDR_PC_IMM(HOST_r3, 64 - (16 + 4)) );        // ldr r3, [pc, #(&Segs)]
-	// adr: 18
-	cache_addw( LDR_PC_IMM(HOST_r2, 68 - (18 + 2)) );        // ldr r2, [pc, #(&cpu_regs)]
-	cache_addw( MOV_HI_LO(FC_SEGS_ADDR, HOST_r3) );      // mov FC_SEGS_ADDR, r3
-	cache_addw( MOV_HI_LO(FC_REGS_ADDR, HOST_r2) );      // mov FC_REGS_ADDR, r2
-
-	// align 4
-	cache_addw( ADD_LO_PC_IMM(HOST_r3, 8) );      // add r3, pc, #8
-	cache_addw( ADD_IMM8(HOST_r0, 1) );      // add r0, #1
-	cache_addw( ADD_IMM8(HOST_r3, 1) );      // add r3, #1
-	cache_addw(0xb408);      // push {r3}
-	cache_addw( BX(HOST_r0) );      // bx r0
-	cache_addw( NOP );      // nop
-
-	// align 4
-	cache_addw(0xbcfc);      // pop {r2,r3,v1-v4}
-	cache_addw( MOV_HI_LO(FC_SEGS_ADDR, HOST_r3) );      // mov FC_SEGS_ADDR, r3
-	cache_addw( MOV_HI_LO(FC_REGS_ADDR, HOST_r2) );      // mov FC_REGS_ADDR, r2
-
-	cache_addw(0xbc08);      // pop {r3}
-	cache_addw( BX(HOST_r3) );      // bx r3
-
-	// fill up to 64 bytes
-	cache_addw( NOP );      // nop
-	cache_addd( NOP | (NOP << 16) );  // nop, nop
-	cache_addd( NOP | (NOP << 16) );  // nop, nop
-	cache_addd( NOP | (NOP << 16) );  // nop, nop
-	cache_addd( NOP | (NOP << 16) );  // nop, nop
+#if (__ARM_EABI__)
+	// 8-byte stack alignment
+	cache_addd(0xe92d4ff0);			// stmfd sp!, {v1-v8,lr}
+#else
+	cache_addd(0xe92d4df0);			// stmfd sp!, {v1-v5,v7,v8,lr}
+#endif
+
+	cache_addd( ARM_ADD_IMM(HOST_r0, HOST_r0, 1, 0) );      // add r0, r0, #1
 
-	// adr: 64
+	pos1 = cache.pos;
+	cache_addd( 0 );
+	pos2 = cache.pos;
+	cache_addd( 0 );
+	pos3 = cache.pos;
+	cache_addd( 0 );
+
+	cache_addd( ARM_ADD_IMM(HOST_lr, HOST_pc, 4, 0) );			// add lr, pc, #4
+	cache_addd( ARM_STR_IMM_M_W(HOST_lr, HOST_sp, 4) );      // str lr, [sp, #-4]!
+	cache_addd( ARM_BX(HOST_r0) );			// bx r0
+
+#if (__ARM_EABI__)
+	cache_addd(0xe8bd4ff0);			// ldmfd sp!, {v1-v8,lr}
+#else
+	cache_addd(0xe8bd4df0);			// ldmfd sp!, {v1-v5,v7,v8,lr}
+#endif
+	cache_addd( ARM_BX(HOST_lr) );			// bx lr
+
+	// align cache.pos to 32 bytes
+	if ((((Bitu)cache.pos) & 0x1f) != 0) {
+		cache.pos = cache.pos + (32 - (((Bitu)cache.pos) & 0x1f));
+	}
+
+	*(Bit32u*)pos1 = ARM_LDR_IMM(FC_SEGS_ADDR, HOST_pc, cache.pos - (pos1 + 8));      // ldr FC_SEGS_ADDR, [pc, #(&Segs)]
 	cache_addd((Bit32u)&Segs);      // address of "Segs"
-	// adr: 68
+
+	*(Bit32u*)pos2 = ARM_LDR_IMM(FC_REGS_ADDR, HOST_pc, cache.pos - (pos2 + 8));      // ldr FC_REGS_ADDR, [pc, #(&cpu_regs)]
 	cache_addd((Bit32u)&cpu_regs);  // address of "cpu_regs"
+
+	*(Bit32u*)pos3 = ARM_LDR_IMM(readdata_addr, HOST_pc, cache.pos - (pos3 + 8));      // ldr readdata_addr, [pc, #(&core_dynrec.readdata)]
+	cache_addd((Bit32u)&core_dynrec.readdata);  // address of "core_dynrec.readdata"
+
+	// align cache.pos to 32 bytes
+	if ((((Bitu)cache.pos) & 0x1f) != 0) {
+		cache.pos = cache.pos + (32 - (((Bitu)cache.pos) & 0x1f));
+	}
 }
 
 // return from a function
diff -Nur dosbox-0.74/src/cpu/core_dynrec/risc_mipsel32.h dosbox-0.74.patch/src/cpu/core_dynrec/risc_mipsel32.h
--- dosbox-0.74/src/cpu/core_dynrec/risc_mipsel32.h	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/cpu/core_dynrec/risc_mipsel32.h	2016-12-11 18:35:15.510284006 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: risc_mipsel32.h,v 1.6 2009-06-25 19:31:43 c2woody Exp $ */
 
 
 /* MIPS32 (little endian) backend by crazyc */
diff -Nur dosbox-0.74/src/cpu/core_dynrec/risc_x64.h dosbox-0.74.patch/src/cpu/core_dynrec/risc_x64.h
--- dosbox-0.74/src/cpu/core_dynrec/risc_x64.h	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/cpu/core_dynrec/risc_x64.h	2016-12-11 18:35:15.510284006 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: risc_x64.h,v 1.13 2009-06-25 19:31:43 c2woody Exp $ */
 
 
 // some configuring defines that specify the capabilities of this architecture
@@ -84,7 +83,7 @@
 }
 
 
-static INLINE void gen_memaddr(HostReg reg,void* data) {
+static INLINE void gen_reg_memaddr(HostReg reg,void* data) {
 	Bit64s diff = (Bit64s)data-((Bit64s)cache.pos+5);
 	if ((diff<0x80000000LL) && (diff>-0x80000000LL)) {
 		cache_addb(0x05+(reg<<3));
@@ -98,13 +97,28 @@
 	}
 }
 
+static INLINE void gen_memaddr(Bitu op,void* data,Bitu off) {
+	Bit64s diff;
+	diff = (Bit64s)data-((Bit64s)cache.pos+off+5);
+	if ((diff<0x80000000LL) && (diff>-0x80000000LL)) {
+		// RIP-relative addressing is offset after the instruction 
+		cache_addb(op+1);
+		cache_addd((Bit32u)(((Bit64u)diff)&0xffffffffLL)); 
+	} else if ((Bit64u)data<0x100000000LL) {
+		cache_addb(op);
+		cache_addb(0x25);
+		cache_addd((Bit32u)(((Bit64u)data)&0xffffffffLL));
+	} else {
+		E_Exit("DRC64:Unhandled memory reference");
+	}
+}
 
 // move a 32bit (dword==true) or 16bit (dword==false) value from memory into dest_reg
 // 16bit moves may destroy the upper 16bit of the destination register
 static void gen_mov_word_to_reg(HostReg dest_reg,void* data,bool dword) {
 	if (!dword) cache_addb(0x66);
 	cache_addb(0x8b); // mov reg,[data]
-	gen_memaddr(dest_reg,data);
+	gen_reg_memaddr(dest_reg,data);
 } 
 
 // move a 16bit constant value into dest_reg
@@ -125,7 +139,7 @@
 static void gen_mov_word_from_reg(HostReg src_reg,void* dest,bool dword) {
 	if (!dword) cache_addb(0x66);
 	cache_addb(0x89);	// mov [data],reg
-	gen_memaddr(src_reg,dest);
+	gen_reg_memaddr(src_reg,dest);
 }
 
 // move an 8bit value from memory into dest_reg
@@ -134,7 +148,7 @@
 // registers might not be directly byte-accessible on some architectures
 static void gen_mov_byte_to_reg_low(HostReg dest_reg,void* data) {
 	cache_addb(0x8a);	// mov reg,[data]
-	gen_memaddr(dest_reg,data);
+	gen_reg_memaddr(dest_reg,data);
 }
 
 // move an 8bit value from memory into dest_reg
@@ -144,7 +158,7 @@
 static void gen_mov_byte_to_reg_low_canuseword(HostReg dest_reg,void* data) {
 	cache_addb(0x66);
 	cache_addb(0x8b);	// mov reg,[data]
-	gen_memaddr(dest_reg,data);
+	gen_reg_memaddr(dest_reg,data);
 }
 
 // move an 8bit constant value into dest_reg
@@ -169,7 +183,7 @@
 // move the lowest 8bit of a register into memory
 static void gen_mov_byte_from_reg_low(HostReg src_reg,void* dest) {
 	cache_addb(0x88);	// mov [data],reg
-	gen_memaddr(src_reg,dest);
+	gen_reg_memaddr(src_reg,dest);
 }
 
 
@@ -193,7 +207,7 @@
 // add a 32bit value from memory to a full register
 static void gen_add(HostReg reg,void* op) {
 	cache_addb(0x03);					// add reg,[data]
-	gen_memaddr(reg,op);
+	gen_reg_memaddr(reg,op);
 }
 
 // add a 32bit constant value to a full register
@@ -212,9 +226,8 @@
 
 // move a 32bit constant value into memory
 static void gen_mov_direct_dword(void* dest,Bit32u imm) {
-	cache_addw(0x04c7);					// mov [data],imm
-	cache_addb(0x25);
-	cache_addd((Bit32u)(((Bit64u)dest)&0xffffffffLL));
+	cache_addb(0xc7);					// mov [data],imm
+	gen_memaddr(0x04,dest,4);
 	cache_addd(imm);
 }
 
@@ -235,9 +248,8 @@
 
 // add an 8bit constant value to a memory value
 static void gen_add_direct_byte(void* dest,Bit8s imm) {
-	cache_addw(0x0483);					// add [data],imm
-	cache_addb(0x25);
-	cache_addd((Bit32u)(((Bit64u)dest)&0xffffffffLL));
+	cache_addb(0x83);					// add [data],imm
+	gen_memaddr(0x4,dest,1);
 	cache_addb(imm);
 }
 
@@ -248,18 +260,20 @@
 		return;
 	}
 	if (!dword) cache_addb(0x66);
-	cache_addw(0x0481);					// add [data],imm
-	cache_addb(0x25);
-	cache_addd((Bit32u)(((Bit64u)dest)&0xffffffffLL));
-	if (dword) cache_addd((Bit32u)imm);
-	else cache_addw((Bit16u)imm);
+	cache_addb(0x81);					// add [data],imm
+	if (dword) {
+		gen_memaddr(0x4,dest,4);		// size of following immediate value
+		cache_addd((Bit32u)imm);
+	} else {
+		gen_memaddr(0x4,dest,2);		// size of following immediate value
+		cache_addw((Bit16u)imm);
+	}
 }
 
 // subtract an 8bit constant value from a memory value
 static void gen_sub_direct_byte(void* dest,Bit8s imm) {
-	cache_addw(0x2c83);					// sub [data],imm
-	cache_addb(0x25);
-	cache_addd((Bit32u)(((Bit64u)dest)&0xffffffffLL));
+	cache_addb(0x83);					// sub [data],imm
+	gen_memaddr(0x2c,dest,1);
 	cache_addb(imm);
 }
 
@@ -270,11 +284,14 @@
 		return;
 	}
 	if (!dword) cache_addb(0x66);
-	cache_addw(0x2c81);					// sub [data],imm
-	cache_addb(0x25);
-	cache_addd((Bit32u)(((Bit64u)dest)&0xffffffffLL));
-	if (dword) cache_addd((Bit32u)imm);
-	else cache_addw((Bit16u)imm);
+	cache_addw(0x81);					// sub [data],imm
+	if (dword) {
+		gen_memaddr(0x2c,dest,4);		// size of following immediate value
+		cache_addd((Bit32u)imm);
+	} else {
+		gen_memaddr(0x2c,dest,2);		// size of following immediate value
+		cache_addw((Bit16u)imm);
+	}
 }
 
 
@@ -324,10 +341,18 @@
 
 // generate a call to a parameterless function
 static void INLINE gen_call_function_raw(void * func) {
+	cache_addb(0x48); 
+	cache_addw(0xec83); 
+	cache_addb(0x08);	// sub rsp,0x08 (align stack to 16 byte boundary)
+
 	cache_addb(0x48);
 	cache_addb(0xb8);	// mov reg,imm64
 	cache_addq((Bit64u)func);
 	cache_addw(0xd0ff);
+
+	cache_addb(0x48); 
+	cache_addw(0xc483); 
+	cache_addb(0x08);	// add rsp,0x08 (reset alignment)
 }
 
 // generate a call to a function with paramcount parameters
@@ -350,9 +375,13 @@
 	cache_addw(0xc483);		// add rsp,0x08
 	cache_addb(0x08);
 
+	// stack is 16 byte aligned now
+
+
 	cache_addb(0x50);		// push rax (==old rsp)
 
-	Bit64u proc_addr=(Bit64u)cache.pos;
+	// returned address relates to where the address is stored in gen_call_function_raw
+	Bit64u proc_addr=(Bit64u)cache.pos-4;
 
 	// Do the actual call to the procedure
 	cache_addb(0x48);
@@ -596,6 +625,8 @@
 #ifdef DRC_FLAGS_INVALIDATION
 // called when a call to a function can be replaced by a
 // call to a simpler function
+// check gen_call_function_raw and gen_call_function_setup
+// for the targeted code
 static void gen_fill_function_ptr(Bit8u * pos,void* fct_ptr,Bitu flags_type) {
 #ifdef DRC_FLAGS_INVALIDATION_DCODE
 	// try to avoid function calls but rather directly fill in code
@@ -604,36 +635,46 @@
 		case t_ADDw:
 		case t_ADDd:
 			*(Bit32u*)(pos+0)=0xf001f889;	// mov eax,edi; add eax,esi
-			*(Bit32u*)(pos+4)=0x909006eb;	// skip
+			*(Bit32u*)(pos+4)=0x90900eeb;	// skip
 			*(Bit32u*)(pos+8)=0x90909090;
+			*(Bit32u*)(pos+12)=0x90909090;
+			*(Bit32u*)(pos+16)=0x90909090;
 			break;
 		case t_ORb:
 		case t_ORw:
 		case t_ORd:
 			*(Bit32u*)(pos+0)=0xf009f889;	// mov eax,edi; or eax,esi
-			*(Bit32u*)(pos+4)=0x909006eb;	// skip
+			*(Bit32u*)(pos+4)=0x90900eeb;	// skip
 			*(Bit32u*)(pos+8)=0x90909090;
+			*(Bit32u*)(pos+12)=0x90909090;
+			*(Bit32u*)(pos+16)=0x90909090;
 			break;
 		case t_ANDb:
 		case t_ANDw:
 		case t_ANDd:
 			*(Bit32u*)(pos+0)=0xf021f889;	// mov eax,edi; and eax,esi
-			*(Bit32u*)(pos+4)=0x909006eb;	// skip
+			*(Bit32u*)(pos+4)=0x90900eeb;	// skip
 			*(Bit32u*)(pos+8)=0x90909090;
+			*(Bit32u*)(pos+12)=0x90909090;
+			*(Bit32u*)(pos+16)=0x90909090;
 			break;
 		case t_SUBb:
 		case t_SUBw:
 		case t_SUBd:
 			*(Bit32u*)(pos+0)=0xf029f889;	// mov eax,edi; sub eax,esi
-			*(Bit32u*)(pos+4)=0x909006eb;	// skip
+			*(Bit32u*)(pos+4)=0x90900eeb;	// skip
 			*(Bit32u*)(pos+8)=0x90909090;
+			*(Bit32u*)(pos+12)=0x90909090;
+			*(Bit32u*)(pos+16)=0x90909090;
 			break;
 		case t_XORb:
 		case t_XORw:
 		case t_XORd:
 			*(Bit32u*)(pos+0)=0xf031f889;	// mov eax,edi; xor eax,esi
-			*(Bit32u*)(pos+4)=0x909006eb;	// skip
+			*(Bit32u*)(pos+4)=0x90900eeb;	// skip
 			*(Bit32u*)(pos+8)=0x90909090;
+			*(Bit32u*)(pos+12)=0x90909090;
+			*(Bit32u*)(pos+16)=0x90909090;
 			break;
 		case t_CMPb:
 		case t_CMPw:
@@ -641,37 +682,45 @@
 		case t_TESTb:
 		case t_TESTw:
 		case t_TESTd:
-			*(Bit32u*)(pos+0)=0x90900aeb;	// skip
+			*(Bit32u*)(pos+0)=0x909012eb;	// skip
 			*(Bit32u*)(pos+4)=0x90909090;
 			*(Bit32u*)(pos+8)=0x90909090;
+			*(Bit32u*)(pos+12)=0x90909090;
+			*(Bit32u*)(pos+16)=0x90909090;
 			break;
 		case t_INCb:
 		case t_INCw:
 		case t_INCd:
 			*(Bit32u*)(pos+0)=0xc0fff889;	// mov eax,edi; inc eax
-			*(Bit32u*)(pos+4)=0x909006eb;	// skip
+			*(Bit32u*)(pos+4)=0x90900eeb;	// skip
 			*(Bit32u*)(pos+8)=0x90909090;
+			*(Bit32u*)(pos+12)=0x90909090;
+			*(Bit32u*)(pos+16)=0x90909090;
 			break;
 		case t_DECb:
 		case t_DECw:
 		case t_DECd:
 			*(Bit32u*)(pos+0)=0xc8fff889;	// mov eax,edi; dec eax
-			*(Bit32u*)(pos+4)=0x909006eb;	// skip
+			*(Bit32u*)(pos+4)=0x90900eeb;	// skip
 			*(Bit32u*)(pos+8)=0x90909090;
+			*(Bit32u*)(pos+12)=0x90909090;
+			*(Bit32u*)(pos+16)=0x90909090;
 			break;
 		case t_NEGb:
 		case t_NEGw:
 		case t_NEGd:
 			*(Bit32u*)(pos+0)=0xd8f7f889;	// mov eax,edi; neg eax
-			*(Bit32u*)(pos+4)=0x909006eb;	// skip
+			*(Bit32u*)(pos+4)=0x90900eeb;	// skip
 			*(Bit32u*)(pos+8)=0x90909090;
+			*(Bit32u*)(pos+12)=0x90909090;
+			*(Bit32u*)(pos+16)=0x90909090;
 			break;
 		default:
-			*(Bit64u*)(pos+2)=(Bit64u)fct_ptr;		// fill function pointer
+			*(Bit64u*)(pos+6)=(Bit64u)fct_ptr;		// fill function pointer
 			break;
 	}
 #else
-	*(Bit64u*)(pos+2)=(Bit64u)fct_ptr;
+	*(Bit64u*)(pos+6)=(Bit64u)fct_ptr;		// fill function pointer
 #endif
 }
 #endif
diff -Nur dosbox-0.74/src/cpu/core_dynrec/risc_x86.h dosbox-0.74.patch/src/cpu/core_dynrec/risc_x86.h
--- dosbox-0.74/src/cpu/core_dynrec/risc_x86.h	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/cpu/core_dynrec/risc_x86.h	2016-12-11 18:35:15.510284006 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: risc_x86.h,v 1.10 2009-06-25 19:31:43 c2woody Exp $ */
 
 
 // some configuring defines that specify the capabilities of this architecture
diff -Nur dosbox-0.74/src/cpu/core_dynrec.cpp dosbox-0.74.patch/src/cpu/core_dynrec.cpp
--- dosbox-0.74/src/cpu/core_dynrec.cpp	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/cpu/core_dynrec.cpp	2016-12-11 18:35:15.510284006 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: core_dynrec.cpp,v 1.15 2009-08-02 16:52:33 c2woody Exp $ */
 
 #include "dosbox.h"
 
@@ -62,11 +61,9 @@
 #define DYN_PAGE_HASH	(4096>>DYN_HASH_SHIFT)
 #define DYN_LINKS		(16)
 
-#if 0
-#define DYN_LOG	LOG_MSG
-#else 
-#define DYN_LOG
-#endif
+
+//#define DYN_LOG 1 //Turn Logging on.
+
 
 #if C_FPU
 #define CPU_FPU 1                                               //Enable FPU escape instructions
@@ -140,6 +137,7 @@
 #define X86_64		0x02
 #define MIPSEL		0x03
 #define ARMV4LE		0x04
+#define ARMV7LE		0x05
 #define POWERPC		0x04
 
 #if C_TARGETCPU == X86_64
@@ -148,7 +146,7 @@
 #include "core_dynrec/risc_x86.h"
 #elif C_TARGETCPU == MIPSEL
 #include "core_dynrec/risc_mipsel32.h"
-#elif C_TARGETCPU == ARMV4LE
+#elif (C_TARGETCPU == ARMV4LE) || (C_TARGETCPU == ARMV7LE)
 #include "core_dynrec/risc_armv4le.h"
 #elif C_TARGETCPU == POWERPC
 #include "core_dynrec/risc_ppc.h"
@@ -166,7 +164,7 @@
 		block=temp_handler->FindCacheBlock(temp_ip & 4095);
 		if (!block) return NULL;
 
-		// found it, link the current block to 
+		// found it, link the current block to
 		cache.block.running->LinkTo(ret==BR_Link2,block);
 		return block;
 	}
@@ -222,7 +220,7 @@
 					continue;
 				}
 				CPU_CycleLeft+=old_cycles;
-				return nc_retcode; 
+				return nc_retcode;
 			}
 		}
 
@@ -249,7 +247,7 @@
 			// the block was exited due to a non-predictable control flow
 			// modifying instruction (like ret) or some nontrivial cpu state
 			// changing instruction (for example switch to/from pmode),
-			// or the maximal number of instructions to translate was reached
+			// or the maximum number of instructions to translate was reached
 #if C_HEAVY_DEBUG
 			if (DEBUG_HeavyIsBreakpoint()) return debugCallback;
 #endif
@@ -258,7 +256,7 @@
 		case BR_Cycles:
 			// cycles went negative, return from the core to handle
 			// external events, schedule the pic...
-#if C_HEAVY_DEBUG			
+#if C_HEAVY_DEBUG
 			if (DEBUG_HeavyIsBreakpoint()) return debugCallback;
 #endif
 			return CBRET_NONE;
diff -Nur dosbox-0.74/src/cpu/core_dyn_x86/cache.h dosbox-0.74.patch/src/cpu/core_dyn_x86/cache.h
--- dosbox-0.74/src/cpu/core_dyn_x86/cache.h	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/cpu/core_dyn_x86/cache.h	2016-12-11 18:35:15.510284006 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: cache.h,v 1.20 2009-07-12 20:13:05 c2woody Exp $ */
 
 class CacheBlock {
 public:
@@ -570,3 +569,75 @@
 	cache_code_link_blocks = NULL;
 	cache_initialized = false; */
 }
+
+static void cache_reset(void) {
+	if (cache_initialized) {
+		for (;;) {
+			if (cache.used_pages) {
+				CodePageHandler * cpage=cache.used_pages;
+				CodePageHandler * npage=cache.used_pages->next;
+				cpage->ClearRelease();
+				delete cpage;
+				cache.used_pages=npage;
+			} else break;
+		}
+
+		if (cache_blocks == NULL) {
+			cache_blocks=(CacheBlock*)malloc(CACHE_BLOCKS*sizeof(CacheBlock));
+			if(!cache_blocks) E_Exit("Allocating cache_blocks has failed");
+		}
+		memset(cache_blocks,0,sizeof(CacheBlock)*CACHE_BLOCKS);
+		cache.block.free=&cache_blocks[0];
+		for (Bits i=0;i<CACHE_BLOCKS-1;i++) {
+			cache_blocks[i].link[0].to=(CacheBlock *)1;
+			cache_blocks[i].link[1].to=(CacheBlock *)1;
+			cache_blocks[i].cache.next=&cache_blocks[i+1];
+		}
+
+		if (cache_code_start_ptr==NULL) {
+#if defined (WIN32)
+			cache_code_start_ptr=(Bit8u*)VirtualAlloc(0,CACHE_TOTAL+CACHE_MAXSIZE+PAGESIZE_TEMP-1+PAGESIZE_TEMP,
+				MEM_COMMIT,PAGE_EXECUTE_READWRITE);
+			if (!cache_code_start_ptr)
+				cache_code_start_ptr=(Bit8u*)malloc(CACHE_TOTAL+CACHE_MAXSIZE+PAGESIZE_TEMP-1+PAGESIZE_TEMP);
+#else
+			cache_code_start_ptr=(Bit8u*)malloc(CACHE_TOTAL+CACHE_MAXSIZE+PAGESIZE_TEMP-1+PAGESIZE_TEMP);
+#endif
+			if (!cache_code_start_ptr) E_Exit("Allocating dynamic core cache memory failed");
+
+			cache_code=(Bit8u*)(((int)cache_code_start_ptr + PAGESIZE_TEMP-1) & ~(PAGESIZE_TEMP-1)); //MEM LEAK. store old pointer if you want to free it.
+
+			cache_code_link_blocks=cache_code;
+			cache_code+=PAGESIZE_TEMP;
+
+#if (C_HAVE_MPROTECT)
+			if(mprotect(cache_code_link_blocks,CACHE_TOTAL+CACHE_MAXSIZE+PAGESIZE_TEMP,PROT_WRITE|PROT_READ|PROT_EXEC))
+				LOG_MSG("Setting excute permission on the code cache has failed!");
+#endif
+		}
+
+		CacheBlock * block=cache_getblock();
+		cache.block.first=block;
+		cache.block.active=block;
+		block->cache.start=&cache_code[0];
+		block->cache.size=CACHE_TOTAL;
+		block->cache.next=0;								//Last block in the list
+
+		/* Setup the default blocks for block linkage returns */
+		cache.pos=&cache_code_link_blocks[0];
+		link_blocks[0].cache.start=cache.pos;
+		gen_return(BR_Link1);
+		cache.pos=&cache_code_link_blocks[32];
+		link_blocks[1].cache.start=cache.pos;
+		gen_return(BR_Link2);
+		cache.free_pages=0;
+		cache.last_page=0;
+		cache.used_pages=0;
+		/* Setup the code pages */
+		for (Bitu i=0;i<CACHE_PAGES;i++) {
+			CodePageHandler * newpage=new CodePageHandler();
+			newpage->next=cache.free_pages;
+			cache.free_pages=newpage;
+		}
+	}
+}
diff -Nur dosbox-0.74/src/cpu/core_dyn_x86/decoder.h dosbox-0.74.patch/src/cpu/core_dyn_x86/decoder.h
--- dosbox-0.74/src/cpu/core_dyn_x86/decoder.h	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/cpu/core_dyn_x86/decoder.h	2016-12-11 18:35:15.510284006 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: decoder.h,v 1.59 2009-10-18 17:52:09 c2woody Exp $ */
 
 #define X86_DYNFPU_DH_ENABLED
 #define X86_INLINED_MEMACCESS
@@ -2104,7 +2103,9 @@
 			case 0xbf:dyn_mov_ev_gw(true);break;
 
 			default:
-				DYN_LOG("Unhandled dual opcode 0F%02X",dual_code);
+#if DYN_LOG
+				LOG_MSG("Unhandled dual opcode 0F%02X",dual_code);
+#endif
 				goto illegalopcode;
 			}
 		}break;
@@ -2670,11 +2671,13 @@
 			}}
 			break;
 		default:
-//			DYN_LOG("Dynamic unhandled opcode %X",opcode);
+#if DYN_LOG
+//			LOG_MSG("Dynamic unhandled opcode %X",opcode);
+#endif
 			goto illegalopcode;
 		}
 	}
-	// link to next block because the maximal number of opcodes has been reached
+	// link to next block because the maximum number of opcodes has been reached
 	dyn_set_eip_end();
 	dyn_reduce_cycles();
 	dyn_save_critical_regs();
diff -Nur dosbox-0.74/src/cpu/core_dyn_x86/dyn_fpu_dh.h dosbox-0.74.patch/src/cpu/core_dyn_x86/dyn_fpu_dh.h
--- dosbox-0.74/src/cpu/core_dyn_x86/dyn_fpu_dh.h	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/cpu/core_dyn_x86/dyn_fpu_dh.h	2016-12-11 18:35:15.510284006 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: dyn_fpu_dh.h,v 1.7 2009-09-23 20:55:19 c2woody Exp $ */
 
 #include "dosbox.h"
 #if C_FPU
diff -Nur dosbox-0.74/src/cpu/core_dyn_x86/dyn_fpu.h dosbox-0.74.patch/src/cpu/core_dyn_x86/dyn_fpu.h
--- dosbox-0.74/src/cpu/core_dyn_x86/dyn_fpu.h	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/cpu/core_dyn_x86/dyn_fpu.h	2016-12-11 18:35:15.510284006 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: dyn_fpu.h,v 1.5 2009-09-23 20:55:19 c2woody Exp $ */
 
 #include "dosbox.h"
 #if C_FPU
diff -Nur dosbox-0.74/src/cpu/core_dyn_x86/helpers.h dosbox-0.74.patch/src/cpu/core_dyn_x86/helpers.h
--- dosbox-0.74/src/cpu/core_dyn_x86/helpers.h	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/cpu/core_dyn_x86/helpers.h	2016-12-11 18:35:15.510284006 +0100
@@ -1,3 +1,21 @@
+/*
+ *  Copyright (C) 2002-2013  The DOSBox Team
+ *
+ *  This program is free software; you can redistribute it and/or modify
+ *  it under the terms of the GNU General Public License as published by
+ *  the Free Software Foundation; either version 2 of the License, or
+ *  (at your option) any later version.
+ *
+ *  This program is distributed in the hope that it will be useful,
+ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *  GNU General Public License for more details.
+ *
+ *  You should have received a copy of the GNU General Public License
+ *  along with this program; if not, write to the Free Software
+ *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+ */
+
 static bool dyn_helper_divb(Bit8u val) {
 	if (!val) return CPU_PrepareException(0,0);
 	Bitu quo=reg_ax / val;
diff -Nur dosbox-0.74/src/cpu/core_dyn_x86/Makefile.in dosbox-0.74.patch/src/cpu/core_dyn_x86/Makefile.in
--- dosbox-0.74/src/cpu/core_dyn_x86/Makefile.in	2010-05-12 11:57:43.000000000 +0200
+++ dosbox-0.74.patch/src/cpu/core_dyn_x86/Makefile.in	1970-01-01 01:00:00.000000000 +0100
@@ -1,390 +0,0 @@
-# Makefile.in generated by automake 1.11.1 from Makefile.am.
-# @configure_input@
-
-# Copyright (C) 1994, 1995, 1996, 1997, 1998, 1999, 2000, 2001, 2002,
-# 2003, 2004, 2005, 2006, 2007, 2008, 2009  Free Software Foundation,
-# Inc.
-# This Makefile.in is free software; the Free Software Foundation
-# gives unlimited permission to copy and/or distribute it,
-# with or without modifications, as long as this notice is preserved.
-
-# This program is distributed in the hope that it will be useful,
-# but WITHOUT ANY WARRANTY, to the extent permitted by law; without
-# even the implied warranty of MERCHANTABILITY or FITNESS FOR A
-# PARTICULAR PURPOSE.
-
-@SET_MAKE@
-
-VPATH = @srcdir@
-pkgdatadir = $(datadir)/@PACKAGE@
-pkgincludedir = $(includedir)/@PACKAGE@
-pkglibdir = $(libdir)/@PACKAGE@
-pkglibexecdir = $(libexecdir)/@PACKAGE@
-am__cd = CDPATH="$${ZSH_VERSION+.}$(PATH_SEPARATOR)" && cd
-install_sh_DATA = $(install_sh) -c -m 644
-install_sh_PROGRAM = $(install_sh) -c
-install_sh_SCRIPT = $(install_sh) -c
-INSTALL_HEADER = $(INSTALL_DATA)
-transform = $(program_transform_name)
-NORMAL_INSTALL = :
-PRE_INSTALL = :
-POST_INSTALL = :
-NORMAL_UNINSTALL = :
-PRE_UNINSTALL = :
-POST_UNINSTALL = :
-build_triplet = @build@
-host_triplet = @host@
-subdir = src/cpu/core_dyn_x86
-DIST_COMMON = $(noinst_HEADERS) $(srcdir)/Makefile.am \
-	$(srcdir)/Makefile.in
-ACLOCAL_M4 = $(top_srcdir)/aclocal.m4
-am__aclocal_m4_deps = $(top_srcdir)/acinclude.m4 \
-	$(top_srcdir)/configure.in
-am__configure_deps = $(am__aclocal_m4_deps) $(CONFIGURE_DEPENDENCIES) \
-	$(ACLOCAL_M4)
-mkinstalldirs = $(install_sh) -d
-CONFIG_HEADER = $(top_builddir)/config.h
-CONFIG_CLEAN_FILES =
-CONFIG_CLEAN_VPATH_FILES =
-SOURCES =
-DIST_SOURCES =
-HEADERS = $(noinst_HEADERS)
-ETAGS = etags
-CTAGS = ctags
-DISTFILES = $(DIST_COMMON) $(DIST_SOURCES) $(TEXINFOS) $(EXTRA_DIST)
-ACLOCAL = @ACLOCAL@
-ALSA_CFLAGS = @ALSA_CFLAGS@
-ALSA_LIBS = @ALSA_LIBS@
-AMTAR = @AMTAR@
-AUTOCONF = @AUTOCONF@
-AUTOHEADER = @AUTOHEADER@
-AUTOMAKE = @AUTOMAKE@
-AWK = @AWK@
-CC = @CC@
-CCDEPMODE = @CCDEPMODE@
-CFLAGS = @CFLAGS@
-CPP = @CPP@
-CPPFLAGS = @CPPFLAGS@
-CXX = @CXX@
-CXXDEPMODE = @CXXDEPMODE@
-CXXFLAGS = @CXXFLAGS@
-CYGPATH_W = @CYGPATH_W@
-DEFS = @DEFS@
-DEPDIR = @DEPDIR@
-ECHO_C = @ECHO_C@
-ECHO_N = @ECHO_N@
-ECHO_T = @ECHO_T@
-EGREP = @EGREP@
-EXEEXT = @EXEEXT@
-GREP = @GREP@
-INSTALL = @INSTALL@
-INSTALL_DATA = @INSTALL_DATA@
-INSTALL_PROGRAM = @INSTALL_PROGRAM@
-INSTALL_SCRIPT = @INSTALL_SCRIPT@
-INSTALL_STRIP_PROGRAM = @INSTALL_STRIP_PROGRAM@
-LDFLAGS = @LDFLAGS@
-LIBOBJS = @LIBOBJS@
-LIBS = @LIBS@
-LTLIBOBJS = @LTLIBOBJS@
-MAKEINFO = @MAKEINFO@
-MKDIR_P = @MKDIR_P@
-OBJEXT = @OBJEXT@
-PACKAGE = @PACKAGE@
-PACKAGE_BUGREPORT = @PACKAGE_BUGREPORT@
-PACKAGE_NAME = @PACKAGE_NAME@
-PACKAGE_STRING = @PACKAGE_STRING@
-PACKAGE_TARNAME = @PACKAGE_TARNAME@
-PACKAGE_URL = @PACKAGE_URL@
-PACKAGE_VERSION = @PACKAGE_VERSION@
-PATH_SEPARATOR = @PATH_SEPARATOR@
-RANLIB = @RANLIB@
-SDL_CFLAGS = @SDL_CFLAGS@
-SDL_CONFIG = @SDL_CONFIG@
-SDL_LIBS = @SDL_LIBS@
-SET_MAKE = @SET_MAKE@
-SHELL = @SHELL@
-STRIP = @STRIP@
-VERSION = @VERSION@
-WINDRES = @WINDRES@
-abs_builddir = @abs_builddir@
-abs_srcdir = @abs_srcdir@
-abs_top_builddir = @abs_top_builddir@
-abs_top_srcdir = @abs_top_srcdir@
-ac_ct_CC = @ac_ct_CC@
-ac_ct_CXX = @ac_ct_CXX@
-am__include = @am__include@
-am__leading_dot = @am__leading_dot@
-am__quote = @am__quote@
-am__tar = @am__tar@
-am__untar = @am__untar@
-bindir = @bindir@
-build = @build@
-build_alias = @build_alias@
-build_cpu = @build_cpu@
-build_os = @build_os@
-build_vendor = @build_vendor@
-builddir = @builddir@
-datadir = @datadir@
-datarootdir = @datarootdir@
-docdir = @docdir@
-dvidir = @dvidir@
-exec_prefix = @exec_prefix@
-host = @host@
-host_alias = @host_alias@
-host_cpu = @host_cpu@
-host_os = @host_os@
-host_vendor = @host_vendor@
-htmldir = @htmldir@
-includedir = @includedir@
-infodir = @infodir@
-install_sh = @install_sh@
-libdir = @libdir@
-libexecdir = @libexecdir@
-localedir = @localedir@
-localstatedir = @localstatedir@
-mandir = @mandir@
-mkdir_p = @mkdir_p@
-oldincludedir = @oldincludedir@
-pdfdir = @pdfdir@
-prefix = @prefix@
-program_transform_name = @program_transform_name@
-psdir = @psdir@
-sbindir = @sbindir@
-sharedstatedir = @sharedstatedir@
-srcdir = @srcdir@
-sysconfdir = @sysconfdir@
-target_alias = @target_alias@
-top_build_prefix = @top_build_prefix@
-top_builddir = @top_builddir@
-top_srcdir = @top_srcdir@
-noinst_HEADERS = cache.h helpers.h decoder.h risc_x86.h string.h \
-                 dyn_fpu.h dyn_fpu_dh.h
-
-all: all-am
-
-.SUFFIXES:
-$(srcdir)/Makefile.in:  $(srcdir)/Makefile.am  $(am__configure_deps)
-	@for dep in $?; do \
-	  case '$(am__configure_deps)' in \
-	    *$$dep*) \
-	      ( cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh ) \
-	        && { if test -f $@; then exit 0; else break; fi; }; \
-	      exit 1;; \
-	  esac; \
-	done; \
-	echo ' cd $(top_srcdir) && $(AUTOMAKE) --gnu src/cpu/core_dyn_x86/Makefile'; \
-	$(am__cd) $(top_srcdir) && \
-	  $(AUTOMAKE) --gnu src/cpu/core_dyn_x86/Makefile
-.PRECIOUS: Makefile
-Makefile: $(srcdir)/Makefile.in $(top_builddir)/config.status
-	@case '$?' in \
-	  *config.status*) \
-	    cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh;; \
-	  *) \
-	    echo ' cd $(top_builddir) && $(SHELL) ./config.status $(subdir)/$@ $(am__depfiles_maybe)'; \
-	    cd $(top_builddir) && $(SHELL) ./config.status $(subdir)/$@ $(am__depfiles_maybe);; \
-	esac;
-
-$(top_builddir)/config.status: $(top_srcdir)/configure $(CONFIG_STATUS_DEPENDENCIES)
-	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
-
-$(top_srcdir)/configure:  $(am__configure_deps)
-	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
-$(ACLOCAL_M4):  $(am__aclocal_m4_deps)
-	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
-$(am__aclocal_m4_deps):
-
-ID: $(HEADERS) $(SOURCES) $(LISP) $(TAGS_FILES)
-	list='$(SOURCES) $(HEADERS) $(LISP) $(TAGS_FILES)'; \
-	unique=`for i in $$list; do \
-	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
-	  done | \
-	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
-	      END { if (nonempty) { for (i in files) print i; }; }'`; \
-	mkid -fID $$unique
-tags: TAGS
-
-TAGS:  $(HEADERS) $(SOURCES)  $(TAGS_DEPENDENCIES) \
-		$(TAGS_FILES) $(LISP)
-	set x; \
-	here=`pwd`; \
-	list='$(SOURCES) $(HEADERS)  $(LISP) $(TAGS_FILES)'; \
-	unique=`for i in $$list; do \
-	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
-	  done | \
-	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
-	      END { if (nonempty) { for (i in files) print i; }; }'`; \
-	shift; \
-	if test -z "$(ETAGS_ARGS)$$*$$unique"; then :; else \
-	  test -n "$$unique" || unique=$$empty_fix; \
-	  if test $$# -gt 0; then \
-	    $(ETAGS) $(ETAGSFLAGS) $(AM_ETAGSFLAGS) $(ETAGS_ARGS) \
-	      "$$@" $$unique; \
-	  else \
-	    $(ETAGS) $(ETAGSFLAGS) $(AM_ETAGSFLAGS) $(ETAGS_ARGS) \
-	      $$unique; \
-	  fi; \
-	fi
-ctags: CTAGS
-CTAGS:  $(HEADERS) $(SOURCES)  $(TAGS_DEPENDENCIES) \
-		$(TAGS_FILES) $(LISP)
-	list='$(SOURCES) $(HEADERS)  $(LISP) $(TAGS_FILES)'; \
-	unique=`for i in $$list; do \
-	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
-	  done | \
-	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
-	      END { if (nonempty) { for (i in files) print i; }; }'`; \
-	test -z "$(CTAGS_ARGS)$$unique" \
-	  || $(CTAGS) $(CTAGSFLAGS) $(AM_CTAGSFLAGS) $(CTAGS_ARGS) \
-	     $$unique
-
-GTAGS:
-	here=`$(am__cd) $(top_builddir) && pwd` \
-	  && $(am__cd) $(top_srcdir) \
-	  && gtags -i $(GTAGS_ARGS) "$$here"
-
-distclean-tags:
-	-rm -f TAGS ID GTAGS GRTAGS GSYMS GPATH tags
-
-distdir: $(DISTFILES)
-	@srcdirstrip=`echo "$(srcdir)" | sed 's/[].[^$$\\*]/\\\\&/g'`; \
-	topsrcdirstrip=`echo "$(top_srcdir)" | sed 's/[].[^$$\\*]/\\\\&/g'`; \
-	list='$(DISTFILES)'; \
-	  dist_files=`for file in $$list; do echo $$file; done | \
-	  sed -e "s|^$$srcdirstrip/||;t" \
-	      -e "s|^$$topsrcdirstrip/|$(top_builddir)/|;t"`; \
-	case $$dist_files in \
-	  */*) $(MKDIR_P) `echo "$$dist_files" | \
-			   sed '/\//!d;s|^|$(distdir)/|;s,/[^/]*$$,,' | \
-			   sort -u` ;; \
-	esac; \
-	for file in $$dist_files; do \
-	  if test -f $$file || test -d $$file; then d=.; else d=$(srcdir); fi; \
-	  if test -d $$d/$$file; then \
-	    dir=`echo "/$$file" | sed -e 's,/[^/]*$$,,'`; \
-	    if test -d "$(distdir)/$$file"; then \
-	      find "$(distdir)/$$file" -type d ! -perm -700 -exec chmod u+rwx {} \;; \
-	    fi; \
-	    if test -d $(srcdir)/$$file && test $$d != $(srcdir); then \
-	      cp -fpR $(srcdir)/$$file "$(distdir)$$dir" || exit 1; \
-	      find "$(distdir)/$$file" -type d ! -perm -700 -exec chmod u+rwx {} \;; \
-	    fi; \
-	    cp -fpR $$d/$$file "$(distdir)$$dir" || exit 1; \
-	  else \
-	    test -f "$(distdir)/$$file" \
-	    || cp -p $$d/$$file "$(distdir)/$$file" \
-	    || exit 1; \
-	  fi; \
-	done
-check-am: all-am
-check: check-am
-all-am: Makefile $(HEADERS)
-installdirs:
-install: install-am
-install-exec: install-exec-am
-install-data: install-data-am
-uninstall: uninstall-am
-
-install-am: all-am
-	@$(MAKE) $(AM_MAKEFLAGS) install-exec-am install-data-am
-
-installcheck: installcheck-am
-install-strip:
-	$(MAKE) $(AM_MAKEFLAGS) INSTALL_PROGRAM="$(INSTALL_STRIP_PROGRAM)" \
-	  install_sh_PROGRAM="$(INSTALL_STRIP_PROGRAM)" INSTALL_STRIP_FLAG=-s \
-	  `test -z '$(STRIP)' || \
-	    echo "INSTALL_PROGRAM_ENV=STRIPPROG='$(STRIP)'"` install
-mostlyclean-generic:
-
-clean-generic:
-
-distclean-generic:
-	-test -z "$(CONFIG_CLEAN_FILES)" || rm -f $(CONFIG_CLEAN_FILES)
-	-test . = "$(srcdir)" || test -z "$(CONFIG_CLEAN_VPATH_FILES)" || rm -f $(CONFIG_CLEAN_VPATH_FILES)
-
-maintainer-clean-generic:
-	@echo "This command is intended for maintainers to use"
-	@echo "it deletes files that may require special tools to rebuild."
-clean: clean-am
-
-clean-am: clean-generic mostlyclean-am
-
-distclean: distclean-am
-	-rm -f Makefile
-distclean-am: clean-am distclean-generic distclean-tags
-
-dvi: dvi-am
-
-dvi-am:
-
-html: html-am
-
-html-am:
-
-info: info-am
-
-info-am:
-
-install-data-am:
-
-install-dvi: install-dvi-am
-
-install-dvi-am:
-
-install-exec-am:
-
-install-html: install-html-am
-
-install-html-am:
-
-install-info: install-info-am
-
-install-info-am:
-
-install-man:
-
-install-pdf: install-pdf-am
-
-install-pdf-am:
-
-install-ps: install-ps-am
-
-install-ps-am:
-
-installcheck-am:
-
-maintainer-clean: maintainer-clean-am
-	-rm -f Makefile
-maintainer-clean-am: distclean-am maintainer-clean-generic
-
-mostlyclean: mostlyclean-am
-
-mostlyclean-am: mostlyclean-generic
-
-pdf: pdf-am
-
-pdf-am:
-
-ps: ps-am
-
-ps-am:
-
-uninstall-am:
-
-.MAKE: install-am install-strip
-
-.PHONY: CTAGS GTAGS all all-am check check-am clean clean-generic \
-	ctags distclean distclean-generic distclean-tags distdir dvi \
-	dvi-am html html-am info info-am install install-am \
-	install-data install-data-am install-dvi install-dvi-am \
-	install-exec install-exec-am install-html install-html-am \
-	install-info install-info-am install-man install-pdf \
-	install-pdf-am install-ps install-ps-am install-strip \
-	installcheck installcheck-am installdirs maintainer-clean \
-	maintainer-clean-generic mostlyclean mostlyclean-generic pdf \
-	pdf-am ps ps-am tags uninstall uninstall-am
-
-
-# Tell versions [3.59,3.63) of GNU make to not export all variables.
-# Otherwise a system limit (for SysV at least) may be exceeded.
-.NOEXPORT:
diff -Nur dosbox-0.74/src/cpu/core_dyn_x86/risc_x86.h dosbox-0.74.patch/src/cpu/core_dyn_x86/risc_x86.h
--- dosbox-0.74/src/cpu/core_dyn_x86/risc_x86.h	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/cpu/core_dyn_x86/risc_x86.h	2016-12-11 18:35:15.510284006 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: risc_x86.h,v 1.32 2009-05-27 09:15:41 qbix79 Exp $ */
 
 static void gen_init(void);
 
diff -Nur dosbox-0.74/src/cpu/core_dyn_x86/string.h dosbox-0.74.patch/src/cpu/core_dyn_x86/string.h
--- dosbox-0.74/src/cpu/core_dyn_x86/string.h	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/cpu/core_dyn_x86/string.h	2016-12-11 18:35:15.510284006 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
diff -Nur dosbox-0.74/src/cpu/core_dyn_x86.cpp dosbox-0.74.patch/src/cpu/core_dyn_x86.cpp
--- dosbox-0.74/src/cpu/core_dyn_x86.cpp	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/cpu/core_dyn_x86.cpp	2016-12-11 18:35:15.510284006 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: core_dyn_x86.cpp,v 1.36 2009-07-20 17:55:52 c2woody Exp $ */
 
 #include "dosbox.h"
 
@@ -61,11 +60,8 @@
 #define DYN_PAGE_HASH	(4096>>DYN_HASH_SHIFT)
 #define DYN_LINKS		(16)
 
-#if 0
-#define DYN_LOG	LOG_MSG
-#else 
-#define DYN_LOG
-#endif
+//#define DYN_LOG 1 //Turn logging on
+
 
 #if C_FPU
 #define CPU_FPU 1                                               //Enable FPU escape instructions
@@ -251,8 +247,8 @@
 {										\
 	__asm__ volatile (					\
 		"fnsave		%0			\n"		\
+		:	"=m" (dyn_dh_fpu.state[0])	\
 		:								\
-		:	"m" (dyn_dh_fpu.state[0])	\
 		:	"memory"					\
 	);									\
 	dyn_dh_fpu.state_used=false;		\
@@ -307,7 +303,10 @@
 		}
 #endif
 		if (!GETFLAG(TF)) {
-			if (GETFLAG(IF) && PIC_IRQCheck) return CBRET_NONE;
+			if (GETFLAG(IF) && PIC_IRQCheck) {
+				if (dyn_dh_fpu.state_used) DH_FPU_SAVE_REINIT
+				return CBRET_NONE;
+			}
 			goto restart_core;
 		}
 		cpudecoder=CPU_Core_Dyn_X86_Trap_Run;
@@ -454,8 +453,8 @@
 		"finit					\n"
 		"fsave		%0			\n"
 		"fstcw		%1			\n"
+		:	"=m" (dyn_dh_fpu.state[0]), "=m" (dyn_dh_fpu.host_cw)
 		:
-		:	"m" (dyn_dh_fpu.state[0]), "m" (dyn_dh_fpu.host_cw)
 		:	"memory"
 	);
 #endif
@@ -472,8 +471,62 @@
 	cache_close();
 }
 
+void CPU_Core_Dyn_X86_Cache_Reset(void) {
+	cache_reset();
+}
+
 void CPU_Core_Dyn_X86_SetFPUMode(bool dh_fpu) {
 	dyn_dh_fpu.dh_fpu_enabled=dh_fpu;
 }
 
+Bit32u fpu_state[32];
+
+void CPU_Core_Dyn_X86_SaveDHFPUState(void) {
+	if (dyn_dh_fpu.dh_fpu_enabled) {
+		if (dyn_dh_fpu.state_used!=0) {
+#if defined (_MSC_VER)
+			__asm {
+			__asm	fsave	fpu_state[0]
+			__asm	finit
+			}
+#else
+			__asm__ volatile (
+				"fsave		%0			\n"
+				"finit					\n"
+				:	"=m" (fpu_state[0])
+				:
+				:	"memory"
+			);
+#endif
+		}
+	}
+}
+
+void CPU_Core_Dyn_X86_RestoreDHFPUState(void) {
+	if (dyn_dh_fpu.dh_fpu_enabled) {
+		if (dyn_dh_fpu.state_used!=0) {
+#if defined (_MSC_VER)
+			__asm {
+			__asm	frstor	fpu_state[0]
+			}
+#else
+			__asm__ volatile (
+				"frstor		%0			\n"
+				:
+				:	"m" (fpu_state[0])
+				:
+			);
+#endif
+		}
+	}
+}
+
+#else
+
+void CPU_Core_Dyn_X86_SaveDHFPUState(void) {
+}
+
+void CPU_Core_Dyn_X86_RestoreDHFPUState(void) {
+}
+
 #endif
diff -Nur dosbox-0.74/src/cpu/core_full/ea_lookup.h dosbox-0.74.patch/src/cpu/core_full/ea_lookup.h
--- dosbox-0.74/src/cpu/core_full/ea_lookup.h	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/cpu/core_full/ea_lookup.h	2016-12-11 18:35:15.510284006 +0100
@@ -1,3 +1,21 @@
+/*
+ *  Copyright (C) 2002-2013  The DOSBox Team
+ *
+ *  This program is free software; you can redistribute it and/or modify
+ *  it under the terms of the GNU General Public License as published by
+ *  the Free Software Foundation; either version 2 of the License, or
+ *  (at your option) any later version.
+ *
+ *  This program is distributed in the hope that it will be useful,
+ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *  GNU General Public License for more details.
+ *
+ *  You should have received a copy of the GNU General Public License
+ *  along with this program; if not, write to the Free Software
+ *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+ */
+
 {
 	EAPoint seg_base;
 	Bit16u off;
diff -Nur dosbox-0.74/src/cpu/core_full/load.h dosbox-0.74.patch/src/cpu/core_full/load.h
--- dosbox-0.74/src/cpu/core_full/load.h	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/cpu/core_full/load.h	2016-12-11 18:35:15.510284006 +0100
@@ -1,3 +1,21 @@
+/*
+ *  Copyright (C) 2002-2013  The DOSBox Team
+ *
+ *  This program is free software; you can redistribute it and/or modify
+ *  it under the terms of the GNU General Public License as published by
+ *  the Free Software Foundation; either version 2 of the License, or
+ *  (at your option) any later version.
+ *
+ *  This program is distributed in the hope that it will be useful,
+ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *  GNU General Public License for more details.
+ *
+ *  You should have received a copy of the GNU General Public License
+ *  along with this program; if not, write to the Free Software
+ *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+ */
+
 switch (inst.code.load) {
 /* General loading */
 	case L_POPwRM:
@@ -482,6 +500,13 @@
 	case D_ICEBP:
 		CPU_SW_Interrupt_NoIOPLCheck(1,GetIP());
 		continue;
+	case D_RDTSC: {
+		if (CPU_ArchitectureType<CPU_ARCHTYPE_PENTIUMSLOW) goto illegalopcode;
+		Bit64s tsc=(Bit64s)(PIC_FullIndex()*(double)(CPU_CycleAutoAdjust?70000:CPU_CycleMax));
+		reg_edx=(Bit32u)(tsc>>32);
+		reg_eax=(Bit32u)(tsc&0xffffffff);
+		break;
+		}
 	default:
 		LOG(LOG_CPU,LOG_ERROR)("LOAD:Unhandled code %d opcode %X",inst.code.load,inst.entry);
 		goto illegalopcode;
diff -Nur dosbox-0.74/src/cpu/core_full/loadwrite.h dosbox-0.74.patch/src/cpu/core_full/loadwrite.h
--- dosbox-0.74/src/cpu/core_full/loadwrite.h	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/cpu/core_full/loadwrite.h	2016-12-11 18:35:15.510284006 +0100
@@ -1,3 +1,21 @@
+/*
+ *  Copyright (C) 2002-2013  The DOSBox Team
+ *
+ *  This program is free software; you can redistribute it and/or modify
+ *  it under the terms of the GNU General Public License as published by
+ *  the Free Software Foundation; either version 2 of the License, or
+ *  (at your option) any later version.
+ *
+ *  This program is distributed in the hope that it will be useful,
+ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *  GNU General Public License for more details.
+ *
+ *  You should have received a copy of the GNU General Public License
+ *  along with this program; if not, write to the Free Software
+ *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+ */
+
 #define SaveIP() reg_eip=(Bit32u)(inst.cseip-SegBase(cs));
 #define LoadIP() inst.cseip=SegBase(cs)+reg_eip;
 #define GetIP()	(inst.cseip-SegBase(cs))
diff -Nur dosbox-0.74/src/cpu/core_full/Makefile.in dosbox-0.74.patch/src/cpu/core_full/Makefile.in
--- dosbox-0.74/src/cpu/core_full/Makefile.in	2010-05-12 11:57:43.000000000 +0200
+++ dosbox-0.74.patch/src/cpu/core_full/Makefile.in	1970-01-01 01:00:00.000000000 +0100
@@ -1,390 +0,0 @@
-# Makefile.in generated by automake 1.11.1 from Makefile.am.
-# @configure_input@
-
-# Copyright (C) 1994, 1995, 1996, 1997, 1998, 1999, 2000, 2001, 2002,
-# 2003, 2004, 2005, 2006, 2007, 2008, 2009  Free Software Foundation,
-# Inc.
-# This Makefile.in is free software; the Free Software Foundation
-# gives unlimited permission to copy and/or distribute it,
-# with or without modifications, as long as this notice is preserved.
-
-# This program is distributed in the hope that it will be useful,
-# but WITHOUT ANY WARRANTY, to the extent permitted by law; without
-# even the implied warranty of MERCHANTABILITY or FITNESS FOR A
-# PARTICULAR PURPOSE.
-
-@SET_MAKE@
-
-VPATH = @srcdir@
-pkgdatadir = $(datadir)/@PACKAGE@
-pkgincludedir = $(includedir)/@PACKAGE@
-pkglibdir = $(libdir)/@PACKAGE@
-pkglibexecdir = $(libexecdir)/@PACKAGE@
-am__cd = CDPATH="$${ZSH_VERSION+.}$(PATH_SEPARATOR)" && cd
-install_sh_DATA = $(install_sh) -c -m 644
-install_sh_PROGRAM = $(install_sh) -c
-install_sh_SCRIPT = $(install_sh) -c
-INSTALL_HEADER = $(INSTALL_DATA)
-transform = $(program_transform_name)
-NORMAL_INSTALL = :
-PRE_INSTALL = :
-POST_INSTALL = :
-NORMAL_UNINSTALL = :
-PRE_UNINSTALL = :
-POST_UNINSTALL = :
-build_triplet = @build@
-host_triplet = @host@
-subdir = src/cpu/core_full
-DIST_COMMON = $(noinst_HEADERS) $(srcdir)/Makefile.am \
-	$(srcdir)/Makefile.in
-ACLOCAL_M4 = $(top_srcdir)/aclocal.m4
-am__aclocal_m4_deps = $(top_srcdir)/acinclude.m4 \
-	$(top_srcdir)/configure.in
-am__configure_deps = $(am__aclocal_m4_deps) $(CONFIGURE_DEPENDENCIES) \
-	$(ACLOCAL_M4)
-mkinstalldirs = $(install_sh) -d
-CONFIG_HEADER = $(top_builddir)/config.h
-CONFIG_CLEAN_FILES =
-CONFIG_CLEAN_VPATH_FILES =
-SOURCES =
-DIST_SOURCES =
-HEADERS = $(noinst_HEADERS)
-ETAGS = etags
-CTAGS = ctags
-DISTFILES = $(DIST_COMMON) $(DIST_SOURCES) $(TEXINFOS) $(EXTRA_DIST)
-ACLOCAL = @ACLOCAL@
-ALSA_CFLAGS = @ALSA_CFLAGS@
-ALSA_LIBS = @ALSA_LIBS@
-AMTAR = @AMTAR@
-AUTOCONF = @AUTOCONF@
-AUTOHEADER = @AUTOHEADER@
-AUTOMAKE = @AUTOMAKE@
-AWK = @AWK@
-CC = @CC@
-CCDEPMODE = @CCDEPMODE@
-CFLAGS = @CFLAGS@
-CPP = @CPP@
-CPPFLAGS = @CPPFLAGS@
-CXX = @CXX@
-CXXDEPMODE = @CXXDEPMODE@
-CXXFLAGS = @CXXFLAGS@
-CYGPATH_W = @CYGPATH_W@
-DEFS = @DEFS@
-DEPDIR = @DEPDIR@
-ECHO_C = @ECHO_C@
-ECHO_N = @ECHO_N@
-ECHO_T = @ECHO_T@
-EGREP = @EGREP@
-EXEEXT = @EXEEXT@
-GREP = @GREP@
-INSTALL = @INSTALL@
-INSTALL_DATA = @INSTALL_DATA@
-INSTALL_PROGRAM = @INSTALL_PROGRAM@
-INSTALL_SCRIPT = @INSTALL_SCRIPT@
-INSTALL_STRIP_PROGRAM = @INSTALL_STRIP_PROGRAM@
-LDFLAGS = @LDFLAGS@
-LIBOBJS = @LIBOBJS@
-LIBS = @LIBS@
-LTLIBOBJS = @LTLIBOBJS@
-MAKEINFO = @MAKEINFO@
-MKDIR_P = @MKDIR_P@
-OBJEXT = @OBJEXT@
-PACKAGE = @PACKAGE@
-PACKAGE_BUGREPORT = @PACKAGE_BUGREPORT@
-PACKAGE_NAME = @PACKAGE_NAME@
-PACKAGE_STRING = @PACKAGE_STRING@
-PACKAGE_TARNAME = @PACKAGE_TARNAME@
-PACKAGE_URL = @PACKAGE_URL@
-PACKAGE_VERSION = @PACKAGE_VERSION@
-PATH_SEPARATOR = @PATH_SEPARATOR@
-RANLIB = @RANLIB@
-SDL_CFLAGS = @SDL_CFLAGS@
-SDL_CONFIG = @SDL_CONFIG@
-SDL_LIBS = @SDL_LIBS@
-SET_MAKE = @SET_MAKE@
-SHELL = @SHELL@
-STRIP = @STRIP@
-VERSION = @VERSION@
-WINDRES = @WINDRES@
-abs_builddir = @abs_builddir@
-abs_srcdir = @abs_srcdir@
-abs_top_builddir = @abs_top_builddir@
-abs_top_srcdir = @abs_top_srcdir@
-ac_ct_CC = @ac_ct_CC@
-ac_ct_CXX = @ac_ct_CXX@
-am__include = @am__include@
-am__leading_dot = @am__leading_dot@
-am__quote = @am__quote@
-am__tar = @am__tar@
-am__untar = @am__untar@
-bindir = @bindir@
-build = @build@
-build_alias = @build_alias@
-build_cpu = @build_cpu@
-build_os = @build_os@
-build_vendor = @build_vendor@
-builddir = @builddir@
-datadir = @datadir@
-datarootdir = @datarootdir@
-docdir = @docdir@
-dvidir = @dvidir@
-exec_prefix = @exec_prefix@
-host = @host@
-host_alias = @host_alias@
-host_cpu = @host_cpu@
-host_os = @host_os@
-host_vendor = @host_vendor@
-htmldir = @htmldir@
-includedir = @includedir@
-infodir = @infodir@
-install_sh = @install_sh@
-libdir = @libdir@
-libexecdir = @libexecdir@
-localedir = @localedir@
-localstatedir = @localstatedir@
-mandir = @mandir@
-mkdir_p = @mkdir_p@
-oldincludedir = @oldincludedir@
-pdfdir = @pdfdir@
-prefix = @prefix@
-program_transform_name = @program_transform_name@
-psdir = @psdir@
-sbindir = @sbindir@
-sharedstatedir = @sharedstatedir@
-srcdir = @srcdir@
-sysconfdir = @sysconfdir@
-target_alias = @target_alias@
-top_build_prefix = @top_build_prefix@
-top_builddir = @top_builddir@
-top_srcdir = @top_srcdir@
-noinst_HEADERS = ea_lookup.h load.h loadwrite.h op.h optable.h save.h \
-		 string.h support.h
-
-all: all-am
-
-.SUFFIXES:
-$(srcdir)/Makefile.in:  $(srcdir)/Makefile.am  $(am__configure_deps)
-	@for dep in $?; do \
-	  case '$(am__configure_deps)' in \
-	    *$$dep*) \
-	      ( cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh ) \
-	        && { if test -f $@; then exit 0; else break; fi; }; \
-	      exit 1;; \
-	  esac; \
-	done; \
-	echo ' cd $(top_srcdir) && $(AUTOMAKE) --gnu src/cpu/core_full/Makefile'; \
-	$(am__cd) $(top_srcdir) && \
-	  $(AUTOMAKE) --gnu src/cpu/core_full/Makefile
-.PRECIOUS: Makefile
-Makefile: $(srcdir)/Makefile.in $(top_builddir)/config.status
-	@case '$?' in \
-	  *config.status*) \
-	    cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh;; \
-	  *) \
-	    echo ' cd $(top_builddir) && $(SHELL) ./config.status $(subdir)/$@ $(am__depfiles_maybe)'; \
-	    cd $(top_builddir) && $(SHELL) ./config.status $(subdir)/$@ $(am__depfiles_maybe);; \
-	esac;
-
-$(top_builddir)/config.status: $(top_srcdir)/configure $(CONFIG_STATUS_DEPENDENCIES)
-	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
-
-$(top_srcdir)/configure:  $(am__configure_deps)
-	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
-$(ACLOCAL_M4):  $(am__aclocal_m4_deps)
-	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
-$(am__aclocal_m4_deps):
-
-ID: $(HEADERS) $(SOURCES) $(LISP) $(TAGS_FILES)
-	list='$(SOURCES) $(HEADERS) $(LISP) $(TAGS_FILES)'; \
-	unique=`for i in $$list; do \
-	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
-	  done | \
-	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
-	      END { if (nonempty) { for (i in files) print i; }; }'`; \
-	mkid -fID $$unique
-tags: TAGS
-
-TAGS:  $(HEADERS) $(SOURCES)  $(TAGS_DEPENDENCIES) \
-		$(TAGS_FILES) $(LISP)
-	set x; \
-	here=`pwd`; \
-	list='$(SOURCES) $(HEADERS)  $(LISP) $(TAGS_FILES)'; \
-	unique=`for i in $$list; do \
-	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
-	  done | \
-	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
-	      END { if (nonempty) { for (i in files) print i; }; }'`; \
-	shift; \
-	if test -z "$(ETAGS_ARGS)$$*$$unique"; then :; else \
-	  test -n "$$unique" || unique=$$empty_fix; \
-	  if test $$# -gt 0; then \
-	    $(ETAGS) $(ETAGSFLAGS) $(AM_ETAGSFLAGS) $(ETAGS_ARGS) \
-	      "$$@" $$unique; \
-	  else \
-	    $(ETAGS) $(ETAGSFLAGS) $(AM_ETAGSFLAGS) $(ETAGS_ARGS) \
-	      $$unique; \
-	  fi; \
-	fi
-ctags: CTAGS
-CTAGS:  $(HEADERS) $(SOURCES)  $(TAGS_DEPENDENCIES) \
-		$(TAGS_FILES) $(LISP)
-	list='$(SOURCES) $(HEADERS)  $(LISP) $(TAGS_FILES)'; \
-	unique=`for i in $$list; do \
-	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
-	  done | \
-	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
-	      END { if (nonempty) { for (i in files) print i; }; }'`; \
-	test -z "$(CTAGS_ARGS)$$unique" \
-	  || $(CTAGS) $(CTAGSFLAGS) $(AM_CTAGSFLAGS) $(CTAGS_ARGS) \
-	     $$unique
-
-GTAGS:
-	here=`$(am__cd) $(top_builddir) && pwd` \
-	  && $(am__cd) $(top_srcdir) \
-	  && gtags -i $(GTAGS_ARGS) "$$here"
-
-distclean-tags:
-	-rm -f TAGS ID GTAGS GRTAGS GSYMS GPATH tags
-
-distdir: $(DISTFILES)
-	@srcdirstrip=`echo "$(srcdir)" | sed 's/[].[^$$\\*]/\\\\&/g'`; \
-	topsrcdirstrip=`echo "$(top_srcdir)" | sed 's/[].[^$$\\*]/\\\\&/g'`; \
-	list='$(DISTFILES)'; \
-	  dist_files=`for file in $$list; do echo $$file; done | \
-	  sed -e "s|^$$srcdirstrip/||;t" \
-	      -e "s|^$$topsrcdirstrip/|$(top_builddir)/|;t"`; \
-	case $$dist_files in \
-	  */*) $(MKDIR_P) `echo "$$dist_files" | \
-			   sed '/\//!d;s|^|$(distdir)/|;s,/[^/]*$$,,' | \
-			   sort -u` ;; \
-	esac; \
-	for file in $$dist_files; do \
-	  if test -f $$file || test -d $$file; then d=.; else d=$(srcdir); fi; \
-	  if test -d $$d/$$file; then \
-	    dir=`echo "/$$file" | sed -e 's,/[^/]*$$,,'`; \
-	    if test -d "$(distdir)/$$file"; then \
-	      find "$(distdir)/$$file" -type d ! -perm -700 -exec chmod u+rwx {} \;; \
-	    fi; \
-	    if test -d $(srcdir)/$$file && test $$d != $(srcdir); then \
-	      cp -fpR $(srcdir)/$$file "$(distdir)$$dir" || exit 1; \
-	      find "$(distdir)/$$file" -type d ! -perm -700 -exec chmod u+rwx {} \;; \
-	    fi; \
-	    cp -fpR $$d/$$file "$(distdir)$$dir" || exit 1; \
-	  else \
-	    test -f "$(distdir)/$$file" \
-	    || cp -p $$d/$$file "$(distdir)/$$file" \
-	    || exit 1; \
-	  fi; \
-	done
-check-am: all-am
-check: check-am
-all-am: Makefile $(HEADERS)
-installdirs:
-install: install-am
-install-exec: install-exec-am
-install-data: install-data-am
-uninstall: uninstall-am
-
-install-am: all-am
-	@$(MAKE) $(AM_MAKEFLAGS) install-exec-am install-data-am
-
-installcheck: installcheck-am
-install-strip:
-	$(MAKE) $(AM_MAKEFLAGS) INSTALL_PROGRAM="$(INSTALL_STRIP_PROGRAM)" \
-	  install_sh_PROGRAM="$(INSTALL_STRIP_PROGRAM)" INSTALL_STRIP_FLAG=-s \
-	  `test -z '$(STRIP)' || \
-	    echo "INSTALL_PROGRAM_ENV=STRIPPROG='$(STRIP)'"` install
-mostlyclean-generic:
-
-clean-generic:
-
-distclean-generic:
-	-test -z "$(CONFIG_CLEAN_FILES)" || rm -f $(CONFIG_CLEAN_FILES)
-	-test . = "$(srcdir)" || test -z "$(CONFIG_CLEAN_VPATH_FILES)" || rm -f $(CONFIG_CLEAN_VPATH_FILES)
-
-maintainer-clean-generic:
-	@echo "This command is intended for maintainers to use"
-	@echo "it deletes files that may require special tools to rebuild."
-clean: clean-am
-
-clean-am: clean-generic mostlyclean-am
-
-distclean: distclean-am
-	-rm -f Makefile
-distclean-am: clean-am distclean-generic distclean-tags
-
-dvi: dvi-am
-
-dvi-am:
-
-html: html-am
-
-html-am:
-
-info: info-am
-
-info-am:
-
-install-data-am:
-
-install-dvi: install-dvi-am
-
-install-dvi-am:
-
-install-exec-am:
-
-install-html: install-html-am
-
-install-html-am:
-
-install-info: install-info-am
-
-install-info-am:
-
-install-man:
-
-install-pdf: install-pdf-am
-
-install-pdf-am:
-
-install-ps: install-ps-am
-
-install-ps-am:
-
-installcheck-am:
-
-maintainer-clean: maintainer-clean-am
-	-rm -f Makefile
-maintainer-clean-am: distclean-am maintainer-clean-generic
-
-mostlyclean: mostlyclean-am
-
-mostlyclean-am: mostlyclean-generic
-
-pdf: pdf-am
-
-pdf-am:
-
-ps: ps-am
-
-ps-am:
-
-uninstall-am:
-
-.MAKE: install-am install-strip
-
-.PHONY: CTAGS GTAGS all all-am check check-am clean clean-generic \
-	ctags distclean distclean-generic distclean-tags distdir dvi \
-	dvi-am html html-am info info-am install install-am \
-	install-data install-data-am install-dvi install-dvi-am \
-	install-exec install-exec-am install-html install-html-am \
-	install-info install-info-am install-man install-pdf \
-	install-pdf-am install-ps install-ps-am install-strip \
-	installcheck installcheck-am installdirs maintainer-clean \
-	maintainer-clean-generic mostlyclean mostlyclean-generic pdf \
-	pdf-am ps ps-am tags uninstall uninstall-am
-
-
-# Tell versions [3.59,3.63) of GNU make to not export all variables.
-# Otherwise a system limit (for SysV at least) may be exceeded.
-.NOEXPORT:
diff -Nur dosbox-0.74/src/cpu/core_full/op.h dosbox-0.74.patch/src/cpu/core_full/op.h
--- dosbox-0.74/src/cpu/core_full/op.h	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/cpu/core_full/op.h	2016-12-11 18:35:15.514284006 +0100
@@ -1,3 +1,21 @@
+/*
+ *  Copyright (C) 2002-2013  The DOSBox Team
+ *
+ *  This program is free software; you can redistribute it and/or modify
+ *  it under the terms of the GNU General Public License as published by
+ *  the Free Software Foundation; either version 2 of the License, or
+ *  (at your option) any later version.
+ *
+ *  This program is distributed in the hope that it will be useful,
+ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *  GNU General Public License for more details.
+ *
+ *  You should have received a copy of the GNU General Public License
+ *  along with this program; if not, write to the Free Software
+ *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+ */
+
 /* Do the actual opcode */
 switch (inst.code.op) {
 	case t_ADDb:	case t_ADDw:	case t_ADDd:
diff -Nur dosbox-0.74/src/cpu/core_full/optable.h dosbox-0.74.patch/src/cpu/core_full/optable.h
--- dosbox-0.74/src/cpu/core_full/optable.h	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/cpu/core_full/optable.h	2016-12-11 18:35:15.514284006 +0100
@@ -1,3 +1,21 @@
+/*
+ *  Copyright (C) 2002-2013  The DOSBox Team
+ *
+ *  This program is free software; you can redistribute it and/or modify
+ *  it under the terms of the GNU General Public License as published by
+ *  the Free Software Foundation; either version 2 of the License, or
+ *  (at your option) any later version.
+ *
+ *  This program is distributed in the hope that it will be useful,
+ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *  GNU General Public License for more details.
+ *
+ *  You should have received a copy of the GNU General Public License
+ *  along with this program; if not, write to the Free Software
+ *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+ */
+
 /* Big ass opcode table normal,double, 66 normal, 66 double */
 static OpCode OpCodeTable[1024]={
 /* 0x00 - 0x07 */
@@ -216,7 +234,7 @@
 {0			,0			,0		,0		},{0		,0			,0		,0		},
 
 /* 0x130 - 0x137 */
-{0			,0			,0		,0		},{0		,0			,0		,0		},
+{0			,0			,0		,0		},{D_RDTSC	,0			,0		,0		},
 {0			,0			,0		,0		},{0		,0			,0		,0		},
 {0			,0			,0		,0		},{0		,0			,0		,0		},
 {0			,0			,0		,0		},{0		,0			,0		,0		},
@@ -572,7 +590,7 @@
 {0			,0			,0		,0		},{0		,0			,0		,0		},
 
 /* 0x330 - 0x337 */
-{0			,0			,0		,0		},{0		,0			,0		,0		},
+{0			,0			,0		,0		},{D_RDTSC	,0			,0		,0		},
 {0			,0			,0		,0		},{0		,0			,0		,0		},
 {0			,0			,0		,0		},{0		,0			,0		,0		},
 {0			,0			,0		,0		},{0		,0			,0		,0		},
diff -Nur dosbox-0.74/src/cpu/core_full/save.h dosbox-0.74.patch/src/cpu/core_full/save.h
--- dosbox-0.74/src/cpu/core_full/save.h	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/cpu/core_full/save.h	2016-12-11 18:35:15.514284006 +0100
@@ -1,3 +1,21 @@
+/*
+ *  Copyright (C) 2002-2013  The DOSBox Team
+ *
+ *  This program is free software; you can redistribute it and/or modify
+ *  it under the terms of the GNU General Public License as published by
+ *  the Free Software Foundation; either version 2 of the License, or
+ *  (at your option) any later version.
+ *
+ *  This program is distributed in the hope that it will be useful,
+ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *  GNU General Public License for more details.
+ *
+ *  You should have received a copy of the GNU General Public License
+ *  along with this program; if not, write to the Free Software
+ *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+ */
+
 /* Write the data from the opcode */
 switch (inst.code.save) {
 /* Byte */
diff -Nur dosbox-0.74/src/cpu/core_full/string.h dosbox-0.74.patch/src/cpu/core_full/string.h
--- dosbox-0.74/src/cpu/core_full/string.h	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/cpu/core_full/string.h	2016-12-11 18:35:15.514284006 +0100
@@ -1,3 +1,21 @@
+/*
+ *  Copyright (C) 2002-2013  The DOSBox Team
+ *
+ *  This program is free software; you can redistribute it and/or modify
+ *  it under the terms of the GNU General Public License as published by
+ *  the Free Software Foundation; either version 2 of the License, or
+ *  (at your option) any later version.
+ *
+ *  This program is distributed in the hope that it will be useful,
+ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *  GNU General Public License for more details.
+ *
+ *  You should have received a copy of the GNU General Public License
+ *  along with this program; if not, write to the Free Software
+ *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+ */
+
 {
 	EAPoint si_base,di_base;
 	Bitu	si_index,di_index;
@@ -70,6 +88,13 @@
 			di_index=(di_index+add_index) & add_mask;
 		}
 		break;
+	case R_INSD:
+		add_index<<=2;
+		for (;count>0;count--) {
+			SaveMd(di_base+di_index,IO_ReadD(reg_dx));
+			di_index=(di_index+add_index) & add_mask;
+		}
+		break;
 	case R_STOSB:
 		for (;count>0;count--) {
 			SaveMb(di_base+di_index,reg_al);
diff -Nur dosbox-0.74/src/cpu/core_full/support.h dosbox-0.74.patch/src/cpu/core_full/support.h
--- dosbox-0.74/src/cpu/core_full/support.h	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/cpu/core_full/support.h	2016-12-11 18:35:15.514284006 +0100
@@ -1,3 +1,21 @@
+/*
+ *  Copyright (C) 2002-2013  The DOSBox Team
+ *
+ *  This program is free software; you can redistribute it and/or modify
+ *  it under the terms of the GNU General Public License as published by
+ *  the Free Software Foundation; either version 2 of the License, or
+ *  (at your option) any later version.
+ *
+ *  This program is distributed in the hope that it will be useful,
+ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *  GNU General Public License for more details.
+ *
+ *  You should have received a copy of the GNU General Public License
+ *  along with this program; if not, write to the Free Software
+ *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+ */
+
 enum {
 	L_N=0,
 	L_SKIP,
@@ -46,6 +64,7 @@
 	D_CPUID,
 	D_HLT,D_CLTS,
 	D_LOCK,D_ICEBP,
+	D_RDTSC,
 	L_ERROR
 };
 
diff -Nur dosbox-0.74/src/cpu/core_full.cpp dosbox-0.74.patch/src/cpu/core_full.cpp
--- dosbox-0.74/src/cpu/core_full.cpp	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/cpu/core_full.cpp	2016-12-11 18:35:15.514284006 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
diff -Nur dosbox-0.74/src/cpu/core_normal/helpers.h dosbox-0.74.patch/src/cpu/core_normal/helpers.h
--- dosbox-0.74/src/cpu/core_normal/helpers.h	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/cpu/core_normal/helpers.h	2016-12-11 18:35:15.514284006 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
diff -Nur dosbox-0.74/src/cpu/core_normal/Makefile.in dosbox-0.74.patch/src/cpu/core_normal/Makefile.in
--- dosbox-0.74/src/cpu/core_normal/Makefile.in	2010-05-12 11:57:43.000000000 +0200
+++ dosbox-0.74.patch/src/cpu/core_normal/Makefile.in	1970-01-01 01:00:00.000000000 +0100
@@ -1,390 +0,0 @@
-# Makefile.in generated by automake 1.11.1 from Makefile.am.
-# @configure_input@
-
-# Copyright (C) 1994, 1995, 1996, 1997, 1998, 1999, 2000, 2001, 2002,
-# 2003, 2004, 2005, 2006, 2007, 2008, 2009  Free Software Foundation,
-# Inc.
-# This Makefile.in is free software; the Free Software Foundation
-# gives unlimited permission to copy and/or distribute it,
-# with or without modifications, as long as this notice is preserved.
-
-# This program is distributed in the hope that it will be useful,
-# but WITHOUT ANY WARRANTY, to the extent permitted by law; without
-# even the implied warranty of MERCHANTABILITY or FITNESS FOR A
-# PARTICULAR PURPOSE.
-
-@SET_MAKE@
-
-VPATH = @srcdir@
-pkgdatadir = $(datadir)/@PACKAGE@
-pkgincludedir = $(includedir)/@PACKAGE@
-pkglibdir = $(libdir)/@PACKAGE@
-pkglibexecdir = $(libexecdir)/@PACKAGE@
-am__cd = CDPATH="$${ZSH_VERSION+.}$(PATH_SEPARATOR)" && cd
-install_sh_DATA = $(install_sh) -c -m 644
-install_sh_PROGRAM = $(install_sh) -c
-install_sh_SCRIPT = $(install_sh) -c
-INSTALL_HEADER = $(INSTALL_DATA)
-transform = $(program_transform_name)
-NORMAL_INSTALL = :
-PRE_INSTALL = :
-POST_INSTALL = :
-NORMAL_UNINSTALL = :
-PRE_UNINSTALL = :
-POST_UNINSTALL = :
-build_triplet = @build@
-host_triplet = @host@
-subdir = src/cpu/core_normal
-DIST_COMMON = $(noinst_HEADERS) $(srcdir)/Makefile.am \
-	$(srcdir)/Makefile.in
-ACLOCAL_M4 = $(top_srcdir)/aclocal.m4
-am__aclocal_m4_deps = $(top_srcdir)/acinclude.m4 \
-	$(top_srcdir)/configure.in
-am__configure_deps = $(am__aclocal_m4_deps) $(CONFIGURE_DEPENDENCIES) \
-	$(ACLOCAL_M4)
-mkinstalldirs = $(install_sh) -d
-CONFIG_HEADER = $(top_builddir)/config.h
-CONFIG_CLEAN_FILES =
-CONFIG_CLEAN_VPATH_FILES =
-SOURCES =
-DIST_SOURCES =
-HEADERS = $(noinst_HEADERS)
-ETAGS = etags
-CTAGS = ctags
-DISTFILES = $(DIST_COMMON) $(DIST_SOURCES) $(TEXINFOS) $(EXTRA_DIST)
-ACLOCAL = @ACLOCAL@
-ALSA_CFLAGS = @ALSA_CFLAGS@
-ALSA_LIBS = @ALSA_LIBS@
-AMTAR = @AMTAR@
-AUTOCONF = @AUTOCONF@
-AUTOHEADER = @AUTOHEADER@
-AUTOMAKE = @AUTOMAKE@
-AWK = @AWK@
-CC = @CC@
-CCDEPMODE = @CCDEPMODE@
-CFLAGS = @CFLAGS@
-CPP = @CPP@
-CPPFLAGS = @CPPFLAGS@
-CXX = @CXX@
-CXXDEPMODE = @CXXDEPMODE@
-CXXFLAGS = @CXXFLAGS@
-CYGPATH_W = @CYGPATH_W@
-DEFS = @DEFS@
-DEPDIR = @DEPDIR@
-ECHO_C = @ECHO_C@
-ECHO_N = @ECHO_N@
-ECHO_T = @ECHO_T@
-EGREP = @EGREP@
-EXEEXT = @EXEEXT@
-GREP = @GREP@
-INSTALL = @INSTALL@
-INSTALL_DATA = @INSTALL_DATA@
-INSTALL_PROGRAM = @INSTALL_PROGRAM@
-INSTALL_SCRIPT = @INSTALL_SCRIPT@
-INSTALL_STRIP_PROGRAM = @INSTALL_STRIP_PROGRAM@
-LDFLAGS = @LDFLAGS@
-LIBOBJS = @LIBOBJS@
-LIBS = @LIBS@
-LTLIBOBJS = @LTLIBOBJS@
-MAKEINFO = @MAKEINFO@
-MKDIR_P = @MKDIR_P@
-OBJEXT = @OBJEXT@
-PACKAGE = @PACKAGE@
-PACKAGE_BUGREPORT = @PACKAGE_BUGREPORT@
-PACKAGE_NAME = @PACKAGE_NAME@
-PACKAGE_STRING = @PACKAGE_STRING@
-PACKAGE_TARNAME = @PACKAGE_TARNAME@
-PACKAGE_URL = @PACKAGE_URL@
-PACKAGE_VERSION = @PACKAGE_VERSION@
-PATH_SEPARATOR = @PATH_SEPARATOR@
-RANLIB = @RANLIB@
-SDL_CFLAGS = @SDL_CFLAGS@
-SDL_CONFIG = @SDL_CONFIG@
-SDL_LIBS = @SDL_LIBS@
-SET_MAKE = @SET_MAKE@
-SHELL = @SHELL@
-STRIP = @STRIP@
-VERSION = @VERSION@
-WINDRES = @WINDRES@
-abs_builddir = @abs_builddir@
-abs_srcdir = @abs_srcdir@
-abs_top_builddir = @abs_top_builddir@
-abs_top_srcdir = @abs_top_srcdir@
-ac_ct_CC = @ac_ct_CC@
-ac_ct_CXX = @ac_ct_CXX@
-am__include = @am__include@
-am__leading_dot = @am__leading_dot@
-am__quote = @am__quote@
-am__tar = @am__tar@
-am__untar = @am__untar@
-bindir = @bindir@
-build = @build@
-build_alias = @build_alias@
-build_cpu = @build_cpu@
-build_os = @build_os@
-build_vendor = @build_vendor@
-builddir = @builddir@
-datadir = @datadir@
-datarootdir = @datarootdir@
-docdir = @docdir@
-dvidir = @dvidir@
-exec_prefix = @exec_prefix@
-host = @host@
-host_alias = @host_alias@
-host_cpu = @host_cpu@
-host_os = @host_os@
-host_vendor = @host_vendor@
-htmldir = @htmldir@
-includedir = @includedir@
-infodir = @infodir@
-install_sh = @install_sh@
-libdir = @libdir@
-libexecdir = @libexecdir@
-localedir = @localedir@
-localstatedir = @localstatedir@
-mandir = @mandir@
-mkdir_p = @mkdir_p@
-oldincludedir = @oldincludedir@
-pdfdir = @pdfdir@
-prefix = @prefix@
-program_transform_name = @program_transform_name@
-psdir = @psdir@
-sbindir = @sbindir@
-sharedstatedir = @sharedstatedir@
-srcdir = @srcdir@
-sysconfdir = @sysconfdir@
-target_alias = @target_alias@
-top_build_prefix = @top_build_prefix@
-top_builddir = @top_builddir@
-top_srcdir = @top_srcdir@
-noinst_HEADERS = helpers.h prefix_none.h prefix_66.h prefix_0f.h support.h table_ea.h \
-		prefix_66_0f.h string.h
-
-all: all-am
-
-.SUFFIXES:
-$(srcdir)/Makefile.in:  $(srcdir)/Makefile.am  $(am__configure_deps)
-	@for dep in $?; do \
-	  case '$(am__configure_deps)' in \
-	    *$$dep*) \
-	      ( cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh ) \
-	        && { if test -f $@; then exit 0; else break; fi; }; \
-	      exit 1;; \
-	  esac; \
-	done; \
-	echo ' cd $(top_srcdir) && $(AUTOMAKE) --gnu src/cpu/core_normal/Makefile'; \
-	$(am__cd) $(top_srcdir) && \
-	  $(AUTOMAKE) --gnu src/cpu/core_normal/Makefile
-.PRECIOUS: Makefile
-Makefile: $(srcdir)/Makefile.in $(top_builddir)/config.status
-	@case '$?' in \
-	  *config.status*) \
-	    cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh;; \
-	  *) \
-	    echo ' cd $(top_builddir) && $(SHELL) ./config.status $(subdir)/$@ $(am__depfiles_maybe)'; \
-	    cd $(top_builddir) && $(SHELL) ./config.status $(subdir)/$@ $(am__depfiles_maybe);; \
-	esac;
-
-$(top_builddir)/config.status: $(top_srcdir)/configure $(CONFIG_STATUS_DEPENDENCIES)
-	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
-
-$(top_srcdir)/configure:  $(am__configure_deps)
-	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
-$(ACLOCAL_M4):  $(am__aclocal_m4_deps)
-	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
-$(am__aclocal_m4_deps):
-
-ID: $(HEADERS) $(SOURCES) $(LISP) $(TAGS_FILES)
-	list='$(SOURCES) $(HEADERS) $(LISP) $(TAGS_FILES)'; \
-	unique=`for i in $$list; do \
-	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
-	  done | \
-	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
-	      END { if (nonempty) { for (i in files) print i; }; }'`; \
-	mkid -fID $$unique
-tags: TAGS
-
-TAGS:  $(HEADERS) $(SOURCES)  $(TAGS_DEPENDENCIES) \
-		$(TAGS_FILES) $(LISP)
-	set x; \
-	here=`pwd`; \
-	list='$(SOURCES) $(HEADERS)  $(LISP) $(TAGS_FILES)'; \
-	unique=`for i in $$list; do \
-	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
-	  done | \
-	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
-	      END { if (nonempty) { for (i in files) print i; }; }'`; \
-	shift; \
-	if test -z "$(ETAGS_ARGS)$$*$$unique"; then :; else \
-	  test -n "$$unique" || unique=$$empty_fix; \
-	  if test $$# -gt 0; then \
-	    $(ETAGS) $(ETAGSFLAGS) $(AM_ETAGSFLAGS) $(ETAGS_ARGS) \
-	      "$$@" $$unique; \
-	  else \
-	    $(ETAGS) $(ETAGSFLAGS) $(AM_ETAGSFLAGS) $(ETAGS_ARGS) \
-	      $$unique; \
-	  fi; \
-	fi
-ctags: CTAGS
-CTAGS:  $(HEADERS) $(SOURCES)  $(TAGS_DEPENDENCIES) \
-		$(TAGS_FILES) $(LISP)
-	list='$(SOURCES) $(HEADERS)  $(LISP) $(TAGS_FILES)'; \
-	unique=`for i in $$list; do \
-	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
-	  done | \
-	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
-	      END { if (nonempty) { for (i in files) print i; }; }'`; \
-	test -z "$(CTAGS_ARGS)$$unique" \
-	  || $(CTAGS) $(CTAGSFLAGS) $(AM_CTAGSFLAGS) $(CTAGS_ARGS) \
-	     $$unique
-
-GTAGS:
-	here=`$(am__cd) $(top_builddir) && pwd` \
-	  && $(am__cd) $(top_srcdir) \
-	  && gtags -i $(GTAGS_ARGS) "$$here"
-
-distclean-tags:
-	-rm -f TAGS ID GTAGS GRTAGS GSYMS GPATH tags
-
-distdir: $(DISTFILES)
-	@srcdirstrip=`echo "$(srcdir)" | sed 's/[].[^$$\\*]/\\\\&/g'`; \
-	topsrcdirstrip=`echo "$(top_srcdir)" | sed 's/[].[^$$\\*]/\\\\&/g'`; \
-	list='$(DISTFILES)'; \
-	  dist_files=`for file in $$list; do echo $$file; done | \
-	  sed -e "s|^$$srcdirstrip/||;t" \
-	      -e "s|^$$topsrcdirstrip/|$(top_builddir)/|;t"`; \
-	case $$dist_files in \
-	  */*) $(MKDIR_P) `echo "$$dist_files" | \
-			   sed '/\//!d;s|^|$(distdir)/|;s,/[^/]*$$,,' | \
-			   sort -u` ;; \
-	esac; \
-	for file in $$dist_files; do \
-	  if test -f $$file || test -d $$file; then d=.; else d=$(srcdir); fi; \
-	  if test -d $$d/$$file; then \
-	    dir=`echo "/$$file" | sed -e 's,/[^/]*$$,,'`; \
-	    if test -d "$(distdir)/$$file"; then \
-	      find "$(distdir)/$$file" -type d ! -perm -700 -exec chmod u+rwx {} \;; \
-	    fi; \
-	    if test -d $(srcdir)/$$file && test $$d != $(srcdir); then \
-	      cp -fpR $(srcdir)/$$file "$(distdir)$$dir" || exit 1; \
-	      find "$(distdir)/$$file" -type d ! -perm -700 -exec chmod u+rwx {} \;; \
-	    fi; \
-	    cp -fpR $$d/$$file "$(distdir)$$dir" || exit 1; \
-	  else \
-	    test -f "$(distdir)/$$file" \
-	    || cp -p $$d/$$file "$(distdir)/$$file" \
-	    || exit 1; \
-	  fi; \
-	done
-check-am: all-am
-check: check-am
-all-am: Makefile $(HEADERS)
-installdirs:
-install: install-am
-install-exec: install-exec-am
-install-data: install-data-am
-uninstall: uninstall-am
-
-install-am: all-am
-	@$(MAKE) $(AM_MAKEFLAGS) install-exec-am install-data-am
-
-installcheck: installcheck-am
-install-strip:
-	$(MAKE) $(AM_MAKEFLAGS) INSTALL_PROGRAM="$(INSTALL_STRIP_PROGRAM)" \
-	  install_sh_PROGRAM="$(INSTALL_STRIP_PROGRAM)" INSTALL_STRIP_FLAG=-s \
-	  `test -z '$(STRIP)' || \
-	    echo "INSTALL_PROGRAM_ENV=STRIPPROG='$(STRIP)'"` install
-mostlyclean-generic:
-
-clean-generic:
-
-distclean-generic:
-	-test -z "$(CONFIG_CLEAN_FILES)" || rm -f $(CONFIG_CLEAN_FILES)
-	-test . = "$(srcdir)" || test -z "$(CONFIG_CLEAN_VPATH_FILES)" || rm -f $(CONFIG_CLEAN_VPATH_FILES)
-
-maintainer-clean-generic:
-	@echo "This command is intended for maintainers to use"
-	@echo "it deletes files that may require special tools to rebuild."
-clean: clean-am
-
-clean-am: clean-generic mostlyclean-am
-
-distclean: distclean-am
-	-rm -f Makefile
-distclean-am: clean-am distclean-generic distclean-tags
-
-dvi: dvi-am
-
-dvi-am:
-
-html: html-am
-
-html-am:
-
-info: info-am
-
-info-am:
-
-install-data-am:
-
-install-dvi: install-dvi-am
-
-install-dvi-am:
-
-install-exec-am:
-
-install-html: install-html-am
-
-install-html-am:
-
-install-info: install-info-am
-
-install-info-am:
-
-install-man:
-
-install-pdf: install-pdf-am
-
-install-pdf-am:
-
-install-ps: install-ps-am
-
-install-ps-am:
-
-installcheck-am:
-
-maintainer-clean: maintainer-clean-am
-	-rm -f Makefile
-maintainer-clean-am: distclean-am maintainer-clean-generic
-
-mostlyclean: mostlyclean-am
-
-mostlyclean-am: mostlyclean-generic
-
-pdf: pdf-am
-
-pdf-am:
-
-ps: ps-am
-
-ps-am:
-
-uninstall-am:
-
-.MAKE: install-am install-strip
-
-.PHONY: CTAGS GTAGS all all-am check check-am clean clean-generic \
-	ctags distclean distclean-generic distclean-tags distdir dvi \
-	dvi-am html html-am info info-am install install-am \
-	install-data install-data-am install-dvi install-dvi-am \
-	install-exec install-exec-am install-html install-html-am \
-	install-info install-info-am install-man install-pdf \
-	install-pdf-am install-ps install-ps-am install-strip \
-	installcheck installcheck-am installdirs maintainer-clean \
-	maintainer-clean-generic mostlyclean mostlyclean-generic pdf \
-	pdf-am ps ps-am tags uninstall uninstall-am
-
-
-# Tell versions [3.59,3.63) of GNU make to not export all variables.
-# Otherwise a system limit (for SysV at least) may be exceeded.
-.NOEXPORT:
diff -Nur dosbox-0.74/src/cpu/core_normal/prefix_0f.h dosbox-0.74.patch/src/cpu/core_normal/prefix_0f.h
--- dosbox-0.74/src/cpu/core_normal/prefix_0f.h	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/cpu/core_normal/prefix_0f.h	2016-12-11 18:35:15.514284006 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -228,7 +228,8 @@
 	CASE_0F_B(0x31)												/* RDTSC */
 		{
 			if (CPU_ArchitectureType<CPU_ARCHTYPE_PENTIUMSLOW) goto illegal_opcode;
-			Bit64s tsc=(Bit64s)(PIC_FullIndex()*(double)CPU_CycleMax);
+			/* Use a fixed number when in auto cycles mode as else the reported value changes constantly */
+			Bit64s tsc=(Bit64s)(PIC_FullIndex()*(double) (CPU_CycleAutoAdjust?70000:CPU_CycleMax));
 			reg_edx=(Bit32u)(tsc>>32);
 			reg_eax=(Bit32u)(tsc&0xffffffff);
 		}
diff -Nur dosbox-0.74/src/cpu/core_normal/prefix_66_0f.h dosbox-0.74.patch/src/cpu/core_normal/prefix_66_0f.h
--- dosbox-0.74/src/cpu/core_normal/prefix_66_0f.h	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/cpu/core_normal/prefix_66_0f.h	2016-12-11 18:35:15.514284006 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
diff -Nur dosbox-0.74/src/cpu/core_normal/prefix_66.h dosbox-0.74.patch/src/cpu/core_normal/prefix_66.h
--- dosbox-0.74/src/cpu/core_normal/prefix_66.h	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/cpu/core_normal/prefix_66.h	2016-12-11 18:35:15.514284006 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
diff -Nur dosbox-0.74/src/cpu/core_normal/prefix_none.h dosbox-0.74.patch/src/cpu/core_normal/prefix_none.h
--- dosbox-0.74/src/cpu/core_normal/prefix_none.h	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/cpu/core_normal/prefix_none.h	2016-12-11 18:35:15.514284006 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -879,7 +879,7 @@
 		{	
 			Bitu port=Fetchb();
 			if (CPU_IO_Exception(port,2)) RUNEXCEPTION();
-			reg_al=IO_ReadW(port);
+			reg_ax=IO_ReadW(port);
 			break;
 		}
 	CASE_B(0xe6)												/* OUT Ib,AL */
diff -Nur dosbox-0.74/src/cpu/core_normal/string.h dosbox-0.74.patch/src/cpu/core_normal/string.h
--- dosbox-0.74/src/cpu/core_normal/string.h	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/cpu/core_normal/string.h	2016-12-11 18:35:15.514284006 +0100
@@ -1,3 +1,21 @@
+/*
+ *  Copyright (C) 2002-2013  The DOSBox Team
+ *
+ *  This program is free software; you can redistribute it and/or modify
+ *  it under the terms of the GNU General Public License as published by
+ *  the Free Software Foundation; either version 2 of the License, or
+ *  (at your option) any later version.
+ *
+ *  This program is distributed in the hope that it will be useful,
+ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *  GNU General Public License for more details.
+ *
+ *  You should have received a copy of the GNU General Public License
+ *  along with this program; if not, write to the Free Software
+ *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+ */
+
 enum STRING_OP {
 	R_OUTSB,R_OUTSW,R_OUTSD,
 	R_INSB,R_INSW,R_INSD,
@@ -75,6 +93,13 @@
 			di_index=(di_index+add_index) & add_mask;
 		}
 		break;
+	case R_INSD:
+		add_index<<=2;
+		for (;count>0;count--) {
+			SaveMd(di_base+di_index,IO_ReadD(reg_dx));
+			di_index=(di_index+add_index) & add_mask;
+		}
+		break;
 	case R_STOSB:
 		for (;count>0;count--) {
 			SaveMb(di_base+di_index,reg_al);
diff -Nur dosbox-0.74/src/cpu/core_normal/support.h dosbox-0.74.patch/src/cpu/core_normal/support.h
--- dosbox-0.74/src/cpu/core_normal/support.h	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/cpu/core_normal/support.h	2016-12-11 18:35:15.514284006 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
diff -Nur dosbox-0.74/src/cpu/core_normal/table_ea.h dosbox-0.74.patch/src/cpu/core_normal/table_ea.h
--- dosbox-0.74/src/cpu/core_normal/table_ea.h	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/cpu/core_normal/table_ea.h	2016-12-11 18:35:15.514284006 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
diff -Nur dosbox-0.74/src/cpu/core_normal.cpp dosbox-0.74.patch/src/cpu/core_normal.cpp
--- dosbox-0.74/src/cpu/core_normal.cpp	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/cpu/core_normal.cpp	2016-12-11 18:35:15.514284006 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
diff -Nur dosbox-0.74/src/cpu/core_prefetch.cpp dosbox-0.74.patch/src/cpu/core_prefetch.cpp
--- dosbox-0.74/src/cpu/core_prefetch.cpp	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/cpu/core_prefetch.cpp	2016-12-11 18:35:15.514284006 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: core_prefetch.cpp,v 1.3 2009-06-26 16:43:30 c2woody Exp $ */
 
 #include <stdio.h>
 
diff -Nur dosbox-0.74/src/cpu/core_simple.cpp dosbox-0.74.patch/src/cpu/core_simple.cpp
--- dosbox-0.74/src/cpu/core_simple.cpp	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/cpu/core_simple.cpp	2016-12-11 18:35:15.514284006 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
diff -Nur dosbox-0.74/src/cpu/cpu.cpp dosbox-0.74.patch/src/cpu/cpu.cpp
--- dosbox-0.74/src/cpu/cpu.cpp	2010-05-12 11:57:31.000000000 +0200
+++ dosbox-0.74.patch/src/cpu/cpu.cpp	2016-12-11 18:35:15.514284006 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,10 +16,10 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: cpu.cpp,v 1.116 2009-03-16 18:10:08 c2woody Exp $ */
 
 #include <assert.h>
 #include <sstream>
+#include <stddef.h>
 #include "dosbox.h"
 #include "cpu.h"
 #include "memory.h"
@@ -64,7 +64,7 @@
 
 Bitu CPU_ArchitectureType = CPU_ARCHTYPE_MIXED;
 
-Bitu CPU_flag_id_toggle=0;
+Bitu CPU_extflags_toggle=0;	// ID and AC flags may be toggled depending on emulated CPU architecture
 
 Bitu CPU_PrefetchQueueSize=0;
 
@@ -170,7 +170,7 @@
 
 
 void CPU_SetFlags(Bitu word,Bitu mask) {
-	mask|=CPU_flag_id_toggle;	// ID-flag can be toggled on cpuid-supporting CPUs
+	mask|=CPU_extflags_toggle;	// ID-flag and AC-flag can be toggled on CPUID-supporting CPUs
 	reg_flags=(reg_flags & ~mask)|(word & mask)|2;
 	cpu.direction=1-((reg_flags & FLAG_DF) >> 9);
 }
@@ -1547,6 +1547,7 @@
 	switch (cr) {
 	case 0:
 		{
+			value|=CR0_FPUPRESENT;
 			Bitu changed=cpu.cr0 ^ value;
 			if (!changed) return;
 			cpu.cr0=value;
@@ -2048,6 +2049,7 @@
 	if (reg_eip!=cpu.hlt.eip || SegValue(cs) != cpu.hlt.cs) {
 		cpudecoder=cpu.hlt.old_decoder;
 	} else {
+		CPU_IODelayRemoved += CPU_Cycles;
 		CPU_Cycles=0;
 	}
 	return 0;
@@ -2055,6 +2057,7 @@
 
 void CPU_HLT(Bitu oldeip) {
 	reg_eip=oldeip;
+	CPU_IODelayRemoved += CPU_Cycles;
 	CPU_Cycles=0;
 	cpu.hlt.cs=SegValue(cs);
 	cpu.hlt.eip=reg_eip;
@@ -2387,8 +2390,9 @@
 			CPU_ArchitectureType = CPU_ARCHTYPE_PENTIUMSLOW;
 		}
 
-		if (CPU_ArchitectureType>=CPU_ARCHTYPE_486NEWSLOW) CPU_flag_id_toggle=FLAG_ID;
-		else CPU_flag_id_toggle=0;
+		if (CPU_ArchitectureType>=CPU_ARCHTYPE_486NEWSLOW) CPU_extflags_toggle=(FLAG_ID|FLAG_AC);
+		else if (CPU_ArchitectureType>=CPU_ARCHTYPE_486OLDSLOW) CPU_extflags_toggle=(FLAG_AC);
+		else CPU_extflags_toggle=0;
 
 
 		if(CPU_CycleMax <= 0) CPU_CycleMax = 3000;
diff -Nur dosbox-0.74/src/cpu/flags.cpp dosbox-0.74.patch/src/cpu/flags.cpp
--- dosbox-0.74/src/cpu/flags.cpp	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/cpu/flags.cpp	2016-12-11 18:35:15.518284006 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
diff -Nur dosbox-0.74/src/cpu/instructions.h dosbox-0.74.patch/src/cpu/instructions.h
--- dosbox-0.74/src/cpu/instructions.h	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/cpu/instructions.h	2016-12-11 18:35:15.518284006 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -798,7 +798,7 @@
 	Bits res=((Bit16s)op2) * ((Bit16s)op3);					\
 	save(op1,res & 0xffff);									\
 	FillFlagsNoCFOF();										\
-	if ((res> -32768)  && (res<32767)) {					\
+	if ((res>= -32768)  && (res<=32767)) {					\
 		SETFLAGBIT(CF,false);SETFLAGBIT(OF,false);			\
 	} else {												\
 		SETFLAGBIT(CF,true);SETFLAGBIT(OF,true);			\
@@ -810,8 +810,8 @@
 	Bit64s res=((Bit64s)((Bit32s)op2))*((Bit64s)((Bit32s)op3));	\
 	save(op1,(Bit32s)res);									\
 	FillFlagsNoCFOF();										\
-	if ((res>-((Bit64s)(2147483647)+1)) &&					\
-		(res<(Bit64s)2147483647)) {							\
+	if ((res>=-((Bit64s)(2147483647)+1)) &&					\
+		(res<=(Bit64s)2147483647)) {						\
 		SETFLAGBIT(CF,false);SETFLAGBIT(OF,false);			\
 	} else {												\
 		SETFLAGBIT(CF,true);SETFLAGBIT(OF,true);			\
diff -Nur dosbox-0.74/src/cpu/lazyflags.h dosbox-0.74.patch/src/cpu/lazyflags.h
--- dosbox-0.74/src/cpu/lazyflags.h	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/cpu/lazyflags.h	2016-12-11 18:35:15.518284006 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
diff -Nur dosbox-0.74/src/cpu/Makefile.in dosbox-0.74.patch/src/cpu/Makefile.in
--- dosbox-0.74/src/cpu/Makefile.in	2010-05-12 11:57:43.000000000 +0200
+++ dosbox-0.74.patch/src/cpu/Makefile.in	1970-01-01 01:00:00.000000000 +0100
@@ -1,613 +0,0 @@
-# Makefile.in generated by automake 1.11.1 from Makefile.am.
-# @configure_input@
-
-# Copyright (C) 1994, 1995, 1996, 1997, 1998, 1999, 2000, 2001, 2002,
-# 2003, 2004, 2005, 2006, 2007, 2008, 2009  Free Software Foundation,
-# Inc.
-# This Makefile.in is free software; the Free Software Foundation
-# gives unlimited permission to copy and/or distribute it,
-# with or without modifications, as long as this notice is preserved.
-
-# This program is distributed in the hope that it will be useful,
-# but WITHOUT ANY WARRANTY, to the extent permitted by law; without
-# even the implied warranty of MERCHANTABILITY or FITNESS FOR A
-# PARTICULAR PURPOSE.
-
-@SET_MAKE@
-
-VPATH = @srcdir@
-pkgdatadir = $(datadir)/@PACKAGE@
-pkgincludedir = $(includedir)/@PACKAGE@
-pkglibdir = $(libdir)/@PACKAGE@
-pkglibexecdir = $(libexecdir)/@PACKAGE@
-am__cd = CDPATH="$${ZSH_VERSION+.}$(PATH_SEPARATOR)" && cd
-install_sh_DATA = $(install_sh) -c -m 644
-install_sh_PROGRAM = $(install_sh) -c
-install_sh_SCRIPT = $(install_sh) -c
-INSTALL_HEADER = $(INSTALL_DATA)
-transform = $(program_transform_name)
-NORMAL_INSTALL = :
-PRE_INSTALL = :
-POST_INSTALL = :
-NORMAL_UNINSTALL = :
-PRE_UNINSTALL = :
-POST_UNINSTALL = :
-build_triplet = @build@
-host_triplet = @host@
-subdir = src/cpu
-DIST_COMMON = $(srcdir)/Makefile.am $(srcdir)/Makefile.in
-ACLOCAL_M4 = $(top_srcdir)/aclocal.m4
-am__aclocal_m4_deps = $(top_srcdir)/acinclude.m4 \
-	$(top_srcdir)/configure.in
-am__configure_deps = $(am__aclocal_m4_deps) $(CONFIGURE_DEPENDENCIES) \
-	$(ACLOCAL_M4)
-mkinstalldirs = $(install_sh) -d
-CONFIG_HEADER = $(top_builddir)/config.h
-CONFIG_CLEAN_FILES =
-CONFIG_CLEAN_VPATH_FILES =
-LIBRARIES = $(noinst_LIBRARIES)
-AR = ar
-ARFLAGS = cru
-libcpu_a_AR = $(AR) $(ARFLAGS)
-libcpu_a_LIBADD =
-am_libcpu_a_OBJECTS = callback.$(OBJEXT) cpu.$(OBJEXT) flags.$(OBJEXT) \
-	modrm.$(OBJEXT) core_full.$(OBJEXT) paging.$(OBJEXT) \
-	core_normal.$(OBJEXT) core_simple.$(OBJEXT) \
-	core_prefetch.$(OBJEXT) core_dyn_x86.$(OBJEXT) \
-	core_dynrec.$(OBJEXT)
-libcpu_a_OBJECTS = $(am_libcpu_a_OBJECTS)
-DEFAULT_INCLUDES = -I.@am__isrc@ -I$(top_builddir)
-depcomp = $(SHELL) $(top_srcdir)/depcomp
-am__depfiles_maybe = depfiles
-am__mv = mv -f
-CXXCOMPILE = $(CXX) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) \
-	$(AM_CPPFLAGS) $(CPPFLAGS) $(AM_CXXFLAGS) $(CXXFLAGS)
-CXXLD = $(CXX)
-CXXLINK = $(CXXLD) $(AM_CXXFLAGS) $(CXXFLAGS) $(AM_LDFLAGS) $(LDFLAGS) \
-	-o $@
-COMPILE = $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) \
-	$(CPPFLAGS) $(AM_CFLAGS) $(CFLAGS)
-CCLD = $(CC)
-LINK = $(CCLD) $(AM_CFLAGS) $(CFLAGS) $(AM_LDFLAGS) $(LDFLAGS) -o $@
-SOURCES = $(libcpu_a_SOURCES)
-DIST_SOURCES = $(libcpu_a_SOURCES)
-RECURSIVE_TARGETS = all-recursive check-recursive dvi-recursive \
-	html-recursive info-recursive install-data-recursive \
-	install-dvi-recursive install-exec-recursive \
-	install-html-recursive install-info-recursive \
-	install-pdf-recursive install-ps-recursive install-recursive \
-	installcheck-recursive installdirs-recursive pdf-recursive \
-	ps-recursive uninstall-recursive
-RECURSIVE_CLEAN_TARGETS = mostlyclean-recursive clean-recursive	\
-  distclean-recursive maintainer-clean-recursive
-AM_RECURSIVE_TARGETS = $(RECURSIVE_TARGETS:-recursive=) \
-	$(RECURSIVE_CLEAN_TARGETS:-recursive=) tags TAGS ctags CTAGS \
-	distdir
-ETAGS = etags
-CTAGS = ctags
-DIST_SUBDIRS = $(SUBDIRS)
-DISTFILES = $(DIST_COMMON) $(DIST_SOURCES) $(TEXINFOS) $(EXTRA_DIST)
-am__relativize = \
-  dir0=`pwd`; \
-  sed_first='s,^\([^/]*\)/.*$$,\1,'; \
-  sed_rest='s,^[^/]*/*,,'; \
-  sed_last='s,^.*/\([^/]*\)$$,\1,'; \
-  sed_butlast='s,/*[^/]*$$,,'; \
-  while test -n "$$dir1"; do \
-    first=`echo "$$dir1" | sed -e "$$sed_first"`; \
-    if test "$$first" != "."; then \
-      if test "$$first" = ".."; then \
-        dir2=`echo "$$dir0" | sed -e "$$sed_last"`/"$$dir2"; \
-        dir0=`echo "$$dir0" | sed -e "$$sed_butlast"`; \
-      else \
-        first2=`echo "$$dir2" | sed -e "$$sed_first"`; \
-        if test "$$first2" = "$$first"; then \
-          dir2=`echo "$$dir2" | sed -e "$$sed_rest"`; \
-        else \
-          dir2="../$$dir2"; \
-        fi; \
-        dir0="$$dir0"/"$$first"; \
-      fi; \
-    fi; \
-    dir1=`echo "$$dir1" | sed -e "$$sed_rest"`; \
-  done; \
-  reldir="$$dir2"
-ACLOCAL = @ACLOCAL@
-ALSA_CFLAGS = @ALSA_CFLAGS@
-ALSA_LIBS = @ALSA_LIBS@
-AMTAR = @AMTAR@
-AUTOCONF = @AUTOCONF@
-AUTOHEADER = @AUTOHEADER@
-AUTOMAKE = @AUTOMAKE@
-AWK = @AWK@
-CC = @CC@
-CCDEPMODE = @CCDEPMODE@
-CFLAGS = @CFLAGS@
-CPP = @CPP@
-CPPFLAGS = @CPPFLAGS@
-CXX = @CXX@
-CXXDEPMODE = @CXXDEPMODE@
-CXXFLAGS = @CXXFLAGS@
-CYGPATH_W = @CYGPATH_W@
-DEFS = @DEFS@
-DEPDIR = @DEPDIR@
-ECHO_C = @ECHO_C@
-ECHO_N = @ECHO_N@
-ECHO_T = @ECHO_T@
-EGREP = @EGREP@
-EXEEXT = @EXEEXT@
-GREP = @GREP@
-INSTALL = @INSTALL@
-INSTALL_DATA = @INSTALL_DATA@
-INSTALL_PROGRAM = @INSTALL_PROGRAM@
-INSTALL_SCRIPT = @INSTALL_SCRIPT@
-INSTALL_STRIP_PROGRAM = @INSTALL_STRIP_PROGRAM@
-LDFLAGS = @LDFLAGS@
-LIBOBJS = @LIBOBJS@
-LIBS = @LIBS@
-LTLIBOBJS = @LTLIBOBJS@
-MAKEINFO = @MAKEINFO@
-MKDIR_P = @MKDIR_P@
-OBJEXT = @OBJEXT@
-PACKAGE = @PACKAGE@
-PACKAGE_BUGREPORT = @PACKAGE_BUGREPORT@
-PACKAGE_NAME = @PACKAGE_NAME@
-PACKAGE_STRING = @PACKAGE_STRING@
-PACKAGE_TARNAME = @PACKAGE_TARNAME@
-PACKAGE_URL = @PACKAGE_URL@
-PACKAGE_VERSION = @PACKAGE_VERSION@
-PATH_SEPARATOR = @PATH_SEPARATOR@
-RANLIB = @RANLIB@
-SDL_CFLAGS = @SDL_CFLAGS@
-SDL_CONFIG = @SDL_CONFIG@
-SDL_LIBS = @SDL_LIBS@
-SET_MAKE = @SET_MAKE@
-SHELL = @SHELL@
-STRIP = @STRIP@
-VERSION = @VERSION@
-WINDRES = @WINDRES@
-abs_builddir = @abs_builddir@
-abs_srcdir = @abs_srcdir@
-abs_top_builddir = @abs_top_builddir@
-abs_top_srcdir = @abs_top_srcdir@
-ac_ct_CC = @ac_ct_CC@
-ac_ct_CXX = @ac_ct_CXX@
-am__include = @am__include@
-am__leading_dot = @am__leading_dot@
-am__quote = @am__quote@
-am__tar = @am__tar@
-am__untar = @am__untar@
-bindir = @bindir@
-build = @build@
-build_alias = @build_alias@
-build_cpu = @build_cpu@
-build_os = @build_os@
-build_vendor = @build_vendor@
-builddir = @builddir@
-datadir = @datadir@
-datarootdir = @datarootdir@
-docdir = @docdir@
-dvidir = @dvidir@
-exec_prefix = @exec_prefix@
-host = @host@
-host_alias = @host_alias@
-host_cpu = @host_cpu@
-host_os = @host_os@
-host_vendor = @host_vendor@
-htmldir = @htmldir@
-includedir = @includedir@
-infodir = @infodir@
-install_sh = @install_sh@
-libdir = @libdir@
-libexecdir = @libexecdir@
-localedir = @localedir@
-localstatedir = @localstatedir@
-mandir = @mandir@
-mkdir_p = @mkdir_p@
-oldincludedir = @oldincludedir@
-pdfdir = @pdfdir@
-prefix = @prefix@
-program_transform_name = @program_transform_name@
-psdir = @psdir@
-sbindir = @sbindir@
-sharedstatedir = @sharedstatedir@
-srcdir = @srcdir@
-sysconfdir = @sysconfdir@
-target_alias = @target_alias@
-top_build_prefix = @top_build_prefix@
-top_builddir = @top_builddir@
-top_srcdir = @top_srcdir@
-SUBDIRS = core_full core_normal core_dyn_x86 core_dynrec
-AM_CPPFLAGS = -I$(top_srcdir)/include
-noinst_LIBRARIES = libcpu.a
-libcpu_a_SOURCES = callback.cpp cpu.cpp flags.cpp modrm.cpp modrm.h core_full.cpp instructions.h	\
-		   paging.cpp lazyflags.h core_normal.cpp core_simple.cpp core_prefetch.cpp \
-		   core_dyn_x86.cpp core_dynrec.cpp
-
-all: all-recursive
-
-.SUFFIXES:
-.SUFFIXES: .cpp .o .obj
-$(srcdir)/Makefile.in:  $(srcdir)/Makefile.am  $(am__configure_deps)
-	@for dep in $?; do \
-	  case '$(am__configure_deps)' in \
-	    *$$dep*) \
-	      ( cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh ) \
-	        && { if test -f $@; then exit 0; else break; fi; }; \
-	      exit 1;; \
-	  esac; \
-	done; \
-	echo ' cd $(top_srcdir) && $(AUTOMAKE) --gnu src/cpu/Makefile'; \
-	$(am__cd) $(top_srcdir) && \
-	  $(AUTOMAKE) --gnu src/cpu/Makefile
-.PRECIOUS: Makefile
-Makefile: $(srcdir)/Makefile.in $(top_builddir)/config.status
-	@case '$?' in \
-	  *config.status*) \
-	    cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh;; \
-	  *) \
-	    echo ' cd $(top_builddir) && $(SHELL) ./config.status $(subdir)/$@ $(am__depfiles_maybe)'; \
-	    cd $(top_builddir) && $(SHELL) ./config.status $(subdir)/$@ $(am__depfiles_maybe);; \
-	esac;
-
-$(top_builddir)/config.status: $(top_srcdir)/configure $(CONFIG_STATUS_DEPENDENCIES)
-	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
-
-$(top_srcdir)/configure:  $(am__configure_deps)
-	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
-$(ACLOCAL_M4):  $(am__aclocal_m4_deps)
-	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
-$(am__aclocal_m4_deps):
-
-clean-noinstLIBRARIES:
-	-test -z "$(noinst_LIBRARIES)" || rm -f $(noinst_LIBRARIES)
-libcpu.a: $(libcpu_a_OBJECTS) $(libcpu_a_DEPENDENCIES) 
-	-rm -f libcpu.a
-	$(libcpu_a_AR) libcpu.a $(libcpu_a_OBJECTS) $(libcpu_a_LIBADD)
-	$(RANLIB) libcpu.a
-
-mostlyclean-compile:
-	-rm -f *.$(OBJEXT)
-
-distclean-compile:
-	-rm -f *.tab.c
-
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/callback.Po@am__quote@
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/core_dyn_x86.Po@am__quote@
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/core_dynrec.Po@am__quote@
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/core_full.Po@am__quote@
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/core_normal.Po@am__quote@
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/core_prefetch.Po@am__quote@
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/core_simple.Po@am__quote@
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/cpu.Po@am__quote@
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/flags.Po@am__quote@
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/modrm.Po@am__quote@
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/paging.Po@am__quote@
-
-.cpp.o:
-@am__fastdepCXX_TRUE@	$(CXXCOMPILE) -MT $@ -MD -MP -MF $(DEPDIR)/$*.Tpo -c -o $@ $<
-@am__fastdepCXX_TRUE@	$(am__mv) $(DEPDIR)/$*.Tpo $(DEPDIR)/$*.Po
-@AMDEP_TRUE@@am__fastdepCXX_FALSE@	source='$<' object='$@' libtool=no @AMDEPBACKSLASH@
-@AMDEP_TRUE@@am__fastdepCXX_FALSE@	DEPDIR=$(DEPDIR) $(CXXDEPMODE) $(depcomp) @AMDEPBACKSLASH@
-@am__fastdepCXX_FALSE@	$(CXXCOMPILE) -c -o $@ $<
-
-.cpp.obj:
-@am__fastdepCXX_TRUE@	$(CXXCOMPILE) -MT $@ -MD -MP -MF $(DEPDIR)/$*.Tpo -c -o $@ `$(CYGPATH_W) '$<'`
-@am__fastdepCXX_TRUE@	$(am__mv) $(DEPDIR)/$*.Tpo $(DEPDIR)/$*.Po
-@AMDEP_TRUE@@am__fastdepCXX_FALSE@	source='$<' object='$@' libtool=no @AMDEPBACKSLASH@
-@AMDEP_TRUE@@am__fastdepCXX_FALSE@	DEPDIR=$(DEPDIR) $(CXXDEPMODE) $(depcomp) @AMDEPBACKSLASH@
-@am__fastdepCXX_FALSE@	$(CXXCOMPILE) -c -o $@ `$(CYGPATH_W) '$<'`
-
-# This directory's subdirectories are mostly independent; you can cd
-# into them and run `make' without going through this Makefile.
-# To change the values of `make' variables: instead of editing Makefiles,
-# (1) if the variable is set in `config.status', edit `config.status'
-#     (which will cause the Makefiles to be regenerated when you run `make');
-# (2) otherwise, pass the desired values on the `make' command line.
-$(RECURSIVE_TARGETS):
-	@fail= failcom='exit 1'; \
-	for f in x $$MAKEFLAGS; do \
-	  case $$f in \
-	    *=* | --[!k]*);; \
-	    *k*) failcom='fail=yes';; \
-	  esac; \
-	done; \
-	dot_seen=no; \
-	target=`echo $@ | sed s/-recursive//`; \
-	list='$(SUBDIRS)'; for subdir in $$list; do \
-	  echo "Making $$target in $$subdir"; \
-	  if test "$$subdir" = "."; then \
-	    dot_seen=yes; \
-	    local_target="$$target-am"; \
-	  else \
-	    local_target="$$target"; \
-	  fi; \
-	  ($(am__cd) $$subdir && $(MAKE) $(AM_MAKEFLAGS) $$local_target) \
-	  || eval $$failcom; \
-	done; \
-	if test "$$dot_seen" = "no"; then \
-	  $(MAKE) $(AM_MAKEFLAGS) "$$target-am" || exit 1; \
-	fi; test -z "$$fail"
-
-$(RECURSIVE_CLEAN_TARGETS):
-	@fail= failcom='exit 1'; \
-	for f in x $$MAKEFLAGS; do \
-	  case $$f in \
-	    *=* | --[!k]*);; \
-	    *k*) failcom='fail=yes';; \
-	  esac; \
-	done; \
-	dot_seen=no; \
-	case "$@" in \
-	  distclean-* | maintainer-clean-*) list='$(DIST_SUBDIRS)' ;; \
-	  *) list='$(SUBDIRS)' ;; \
-	esac; \
-	rev=''; for subdir in $$list; do \
-	  if test "$$subdir" = "."; then :; else \
-	    rev="$$subdir $$rev"; \
-	  fi; \
-	done; \
-	rev="$$rev ."; \
-	target=`echo $@ | sed s/-recursive//`; \
-	for subdir in $$rev; do \
-	  echo "Making $$target in $$subdir"; \
-	  if test "$$subdir" = "."; then \
-	    local_target="$$target-am"; \
-	  else \
-	    local_target="$$target"; \
-	  fi; \
-	  ($(am__cd) $$subdir && $(MAKE) $(AM_MAKEFLAGS) $$local_target) \
-	  || eval $$failcom; \
-	done && test -z "$$fail"
-tags-recursive:
-	list='$(SUBDIRS)'; for subdir in $$list; do \
-	  test "$$subdir" = . || ($(am__cd) $$subdir && $(MAKE) $(AM_MAKEFLAGS) tags); \
-	done
-ctags-recursive:
-	list='$(SUBDIRS)'; for subdir in $$list; do \
-	  test "$$subdir" = . || ($(am__cd) $$subdir && $(MAKE) $(AM_MAKEFLAGS) ctags); \
-	done
-
-ID: $(HEADERS) $(SOURCES) $(LISP) $(TAGS_FILES)
-	list='$(SOURCES) $(HEADERS) $(LISP) $(TAGS_FILES)'; \
-	unique=`for i in $$list; do \
-	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
-	  done | \
-	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
-	      END { if (nonempty) { for (i in files) print i; }; }'`; \
-	mkid -fID $$unique
-tags: TAGS
-
-TAGS: tags-recursive $(HEADERS) $(SOURCES)  $(TAGS_DEPENDENCIES) \
-		$(TAGS_FILES) $(LISP)
-	set x; \
-	here=`pwd`; \
-	if ($(ETAGS) --etags-include --version) >/dev/null 2>&1; then \
-	  include_option=--etags-include; \
-	  empty_fix=.; \
-	else \
-	  include_option=--include; \
-	  empty_fix=; \
-	fi; \
-	list='$(SUBDIRS)'; for subdir in $$list; do \
-	  if test "$$subdir" = .; then :; else \
-	    test ! -f $$subdir/TAGS || \
-	      set "$$@" "$$include_option=$$here/$$subdir/TAGS"; \
-	  fi; \
-	done; \
-	list='$(SOURCES) $(HEADERS)  $(LISP) $(TAGS_FILES)'; \
-	unique=`for i in $$list; do \
-	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
-	  done | \
-	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
-	      END { if (nonempty) { for (i in files) print i; }; }'`; \
-	shift; \
-	if test -z "$(ETAGS_ARGS)$$*$$unique"; then :; else \
-	  test -n "$$unique" || unique=$$empty_fix; \
-	  if test $$# -gt 0; then \
-	    $(ETAGS) $(ETAGSFLAGS) $(AM_ETAGSFLAGS) $(ETAGS_ARGS) \
-	      "$$@" $$unique; \
-	  else \
-	    $(ETAGS) $(ETAGSFLAGS) $(AM_ETAGSFLAGS) $(ETAGS_ARGS) \
-	      $$unique; \
-	  fi; \
-	fi
-ctags: CTAGS
-CTAGS: ctags-recursive $(HEADERS) $(SOURCES)  $(TAGS_DEPENDENCIES) \
-		$(TAGS_FILES) $(LISP)
-	list='$(SOURCES) $(HEADERS)  $(LISP) $(TAGS_FILES)'; \
-	unique=`for i in $$list; do \
-	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
-	  done | \
-	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
-	      END { if (nonempty) { for (i in files) print i; }; }'`; \
-	test -z "$(CTAGS_ARGS)$$unique" \
-	  || $(CTAGS) $(CTAGSFLAGS) $(AM_CTAGSFLAGS) $(CTAGS_ARGS) \
-	     $$unique
-
-GTAGS:
-	here=`$(am__cd) $(top_builddir) && pwd` \
-	  && $(am__cd) $(top_srcdir) \
-	  && gtags -i $(GTAGS_ARGS) "$$here"
-
-distclean-tags:
-	-rm -f TAGS ID GTAGS GRTAGS GSYMS GPATH tags
-
-distdir: $(DISTFILES)
-	@srcdirstrip=`echo "$(srcdir)" | sed 's/[].[^$$\\*]/\\\\&/g'`; \
-	topsrcdirstrip=`echo "$(top_srcdir)" | sed 's/[].[^$$\\*]/\\\\&/g'`; \
-	list='$(DISTFILES)'; \
-	  dist_files=`for file in $$list; do echo $$file; done | \
-	  sed -e "s|^$$srcdirstrip/||;t" \
-	      -e "s|^$$topsrcdirstrip/|$(top_builddir)/|;t"`; \
-	case $$dist_files in \
-	  */*) $(MKDIR_P) `echo "$$dist_files" | \
-			   sed '/\//!d;s|^|$(distdir)/|;s,/[^/]*$$,,' | \
-			   sort -u` ;; \
-	esac; \
-	for file in $$dist_files; do \
-	  if test -f $$file || test -d $$file; then d=.; else d=$(srcdir); fi; \
-	  if test -d $$d/$$file; then \
-	    dir=`echo "/$$file" | sed -e 's,/[^/]*$$,,'`; \
-	    if test -d "$(distdir)/$$file"; then \
-	      find "$(distdir)/$$file" -type d ! -perm -700 -exec chmod u+rwx {} \;; \
-	    fi; \
-	    if test -d $(srcdir)/$$file && test $$d != $(srcdir); then \
-	      cp -fpR $(srcdir)/$$file "$(distdir)$$dir" || exit 1; \
-	      find "$(distdir)/$$file" -type d ! -perm -700 -exec chmod u+rwx {} \;; \
-	    fi; \
-	    cp -fpR $$d/$$file "$(distdir)$$dir" || exit 1; \
-	  else \
-	    test -f "$(distdir)/$$file" \
-	    || cp -p $$d/$$file "$(distdir)/$$file" \
-	    || exit 1; \
-	  fi; \
-	done
-	@list='$(DIST_SUBDIRS)'; for subdir in $$list; do \
-	  if test "$$subdir" = .; then :; else \
-	    test -d "$(distdir)/$$subdir" \
-	    || $(MKDIR_P) "$(distdir)/$$subdir" \
-	    || exit 1; \
-	  fi; \
-	done
-	@list='$(DIST_SUBDIRS)'; for subdir in $$list; do \
-	  if test "$$subdir" = .; then :; else \
-	    dir1=$$subdir; dir2="$(distdir)/$$subdir"; \
-	    $(am__relativize); \
-	    new_distdir=$$reldir; \
-	    dir1=$$subdir; dir2="$(top_distdir)"; \
-	    $(am__relativize); \
-	    new_top_distdir=$$reldir; \
-	    echo " (cd $$subdir && $(MAKE) $(AM_MAKEFLAGS) top_distdir="$$new_top_distdir" distdir="$$new_distdir" \\"; \
-	    echo "     am__remove_distdir=: am__skip_length_check=: am__skip_mode_fix=: distdir)"; \
-	    ($(am__cd) $$subdir && \
-	      $(MAKE) $(AM_MAKEFLAGS) \
-	        top_distdir="$$new_top_distdir" \
-	        distdir="$$new_distdir" \
-		am__remove_distdir=: \
-		am__skip_length_check=: \
-		am__skip_mode_fix=: \
-	        distdir) \
-	      || exit 1; \
-	  fi; \
-	done
-check-am: all-am
-check: check-recursive
-all-am: Makefile $(LIBRARIES)
-installdirs: installdirs-recursive
-installdirs-am:
-install: install-recursive
-install-exec: install-exec-recursive
-install-data: install-data-recursive
-uninstall: uninstall-recursive
-
-install-am: all-am
-	@$(MAKE) $(AM_MAKEFLAGS) install-exec-am install-data-am
-
-installcheck: installcheck-recursive
-install-strip:
-	$(MAKE) $(AM_MAKEFLAGS) INSTALL_PROGRAM="$(INSTALL_STRIP_PROGRAM)" \
-	  install_sh_PROGRAM="$(INSTALL_STRIP_PROGRAM)" INSTALL_STRIP_FLAG=-s \
-	  `test -z '$(STRIP)' || \
-	    echo "INSTALL_PROGRAM_ENV=STRIPPROG='$(STRIP)'"` install
-mostlyclean-generic:
-
-clean-generic:
-
-distclean-generic:
-	-test -z "$(CONFIG_CLEAN_FILES)" || rm -f $(CONFIG_CLEAN_FILES)
-	-test . = "$(srcdir)" || test -z "$(CONFIG_CLEAN_VPATH_FILES)" || rm -f $(CONFIG_CLEAN_VPATH_FILES)
-
-maintainer-clean-generic:
-	@echo "This command is intended for maintainers to use"
-	@echo "it deletes files that may require special tools to rebuild."
-clean: clean-recursive
-
-clean-am: clean-generic clean-noinstLIBRARIES mostlyclean-am
-
-distclean: distclean-recursive
-	-rm -rf ./$(DEPDIR)
-	-rm -f Makefile
-distclean-am: clean-am distclean-compile distclean-generic \
-	distclean-tags
-
-dvi: dvi-recursive
-
-dvi-am:
-
-html: html-recursive
-
-html-am:
-
-info: info-recursive
-
-info-am:
-
-install-data-am:
-
-install-dvi: install-dvi-recursive
-
-install-dvi-am:
-
-install-exec-am:
-
-install-html: install-html-recursive
-
-install-html-am:
-
-install-info: install-info-recursive
-
-install-info-am:
-
-install-man:
-
-install-pdf: install-pdf-recursive
-
-install-pdf-am:
-
-install-ps: install-ps-recursive
-
-install-ps-am:
-
-installcheck-am:
-
-maintainer-clean: maintainer-clean-recursive
-	-rm -rf ./$(DEPDIR)
-	-rm -f Makefile
-maintainer-clean-am: distclean-am maintainer-clean-generic
-
-mostlyclean: mostlyclean-recursive
-
-mostlyclean-am: mostlyclean-compile mostlyclean-generic
-
-pdf: pdf-recursive
-
-pdf-am:
-
-ps: ps-recursive
-
-ps-am:
-
-uninstall-am:
-
-.MAKE: $(RECURSIVE_CLEAN_TARGETS) $(RECURSIVE_TARGETS) ctags-recursive \
-	install-am install-strip tags-recursive
-
-.PHONY: $(RECURSIVE_CLEAN_TARGETS) $(RECURSIVE_TARGETS) CTAGS GTAGS \
-	all all-am check check-am clean clean-generic \
-	clean-noinstLIBRARIES ctags ctags-recursive distclean \
-	distclean-compile distclean-generic distclean-tags distdir dvi \
-	dvi-am html html-am info info-am install install-am \
-	install-data install-data-am install-dvi install-dvi-am \
-	install-exec install-exec-am install-html install-html-am \
-	install-info install-info-am install-man install-pdf \
-	install-pdf-am install-ps install-ps-am install-strip \
-	installcheck installcheck-am installdirs installdirs-am \
-	maintainer-clean maintainer-clean-generic mostlyclean \
-	mostlyclean-compile mostlyclean-generic pdf pdf-am ps ps-am \
-	tags tags-recursive uninstall uninstall-am
-
-
-# Tell versions [3.59,3.63) of GNU make to not export all variables.
-# Otherwise a system limit (for SysV at least) may be exceeded.
-.NOEXPORT:
diff -Nur dosbox-0.74/src/cpu/modrm.cpp dosbox-0.74.patch/src/cpu/modrm.cpp
--- dosbox-0.74/src/cpu/modrm.cpp	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/cpu/modrm.cpp	2016-12-11 18:35:15.518284006 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
diff -Nur dosbox-0.74/src/cpu/modrm.h dosbox-0.74.patch/src/cpu/modrm.h
--- dosbox-0.74/src/cpu/modrm.h	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/cpu/modrm.h	2016-12-11 18:35:15.518284006 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
diff -Nur dosbox-0.74/src/cpu/paging.cpp dosbox-0.74.patch/src/cpu/paging.cpp
--- dosbox-0.74/src/cpu/paging.cpp	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/cpu/paging.cpp	2016-12-11 18:35:15.518284006 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: paging.cpp,v 1.36 2009-05-27 09:15:41 qbix79 Exp $ */
 
 #include <stdlib.h>
 #include <assert.h>
@@ -44,16 +43,16 @@
 	return 0;
 }
 Bitu PageHandler::readw(PhysPt addr) {
-	return 
-		(readb(addr+0) << 0) |
-		(readb(addr+1) << 8);
+	Bitu ret = (readb(addr+0) << 0);
+	ret     |= (readb(addr+1) << 8);
+	return ret;
 }
 Bitu PageHandler::readd(PhysPt addr) {
-	return 
-		(readb(addr+0) << 0)  |
-		(readb(addr+1) << 8)  |
-		(readb(addr+2) << 16) |
-		(readb(addr+3) << 24);
+	Bitu ret = (readb(addr+0) << 0);
+	ret     |= (readb(addr+1) << 8);
+	ret     |= (readb(addr+2) << 16);
+	ret     |= (readb(addr+3) << 24);
+	return ret;
 }
 
 void PageHandler::writeb(PhysPt addr,Bitu /*val*/) {
@@ -850,7 +849,7 @@
 }
 
 void PAGING_Enable(bool enabled) {
-	/* If paging is disable we work from a default paging table */
+	/* If paging is disabled, we work from a default paging table */
 	if (paging.enabled==enabled) return;
 	paging.enabled=enabled;
 	if (enabled) {
diff -Nur dosbox-0.74/src/debug/debug.cpp dosbox-0.74.patch/src/debug/debug.cpp
--- dosbox-0.74/src/debug/debug.cpp	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/debug/debug.cpp	2016-12-11 18:35:15.518284006 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: debug.cpp,v 1.97 2009-04-11 19:49:52 c2woody Exp $ */
 
 #include "dosbox.h"
 #if C_DEBUG
@@ -62,8 +61,8 @@
 // Forwards
 static void DrawCode(void);
 static void DEBUG_RaiseTimerIrq(void);
-static void SaveMemory(Bitu seg, Bitu ofs1, Bit32u num);
-static void SaveMemoryBin(Bitu seg, Bitu ofs1, Bit32u num);
+static void SaveMemory(Bit16u seg, Bit32u ofs1, Bit32u num);
+static void SaveMemoryBin(Bit16u seg, Bit32u ofs1, Bit32u num);
 static void LogMCBS(void);
 static void LogGDT(void);
 static void LogLDT(void);
@@ -76,6 +75,7 @@
 char* AnalyzeInstruction(char* inst, bool saveSelector);
 Bit32u GetHexValue(char* str, char*& hex);
 
+#if 0
 class DebugPageHandler : public PageHandler {
 public:
 	Bitu readb(PhysPt /*addr*/) {
@@ -90,10 +90,8 @@
 	}
 	void writed(PhysPt /*addr*/,Bitu /*val*/) {
 	}
-
-
-
 };
+#endif
 
 
 class DEBUG;
@@ -123,7 +121,6 @@
 static Segment oldsegs[6];
 static Bitu oldflags,oldcpucpl;
 DBGBlock dbg;
-static Bitu input_count;
 Bitu cycle_count;
 static bool debugging;
 
@@ -136,23 +133,34 @@
 	}
 }
 
+#define MAXCMDLEN 254 
 struct SCodeViewData {	
-	int		cursorPos;
+	int     cursorPos;
 	Bit16u  firstInstSize;
-	Bit16u	useCS;
-	Bit32u	useEIPlast, useEIPmid;
-	Bit32u	useEIP;
+	Bit16u  useCS;
+	Bit32u  useEIPlast, useEIPmid;
+	Bit32u  useEIP;
 	Bit16u  cursorSeg;
-	Bit32u	cursorOfs;
-	bool	inputMode;
-	char	inputStr[255];
-	char	prevInputStr[255];
-
+	Bit32u  cursorOfs;
+	bool    ovrMode;
+	char    inputStr[MAXCMDLEN+1];
+	char    suspInputStr[MAXCMDLEN+1];
+	int     inputPos;
 } codeViewData;
 
-static Bit16u	dataSeg;
-static Bit32u	dataOfs;
-static bool		showExtend = true;
+static Bit16u  dataSeg;
+static Bit32u  dataOfs;
+static bool    showExtend = true;
+
+static void ClearInputLine(void) {
+	codeViewData.inputStr[0] = 0;
+	codeViewData.inputPos = 0;
+}
+
+// History stuff
+#define MAX_HIST_BUFFER 50
+static list<string> histBuff;
+static list<string>::iterator histBuffPos = histBuff.end();
 
 /***********/
 /* Helpers */
@@ -273,32 +281,34 @@
 public:
 
 	CBreakpoint(void);
-	void					SetAddress		(Bit16u seg, Bit32u off)	{ location = GetAddress(seg,off);	type = BKPNT_PHYSICAL; segment = seg; offset = off; };
-	void					SetAddress		(PhysPt adr)				{ location = adr;				type = BKPNT_PHYSICAL; };
-	void					SetInt			(Bit8u _intNr, Bit16u ah)	{ intNr = _intNr, ahValue = ah; type = BKPNT_INTERRUPT; };
+	void					SetAddress		(Bit16u seg, Bit32u off)	{ location = GetAddress(seg,off); type = BKPNT_PHYSICAL; segment = seg; offset = off; };
+	void					SetAddress		(PhysPt adr)				{ location = adr; type = BKPNT_PHYSICAL; };
+	void					SetInt			(Bit8u _intNr, Bit16u ah, Bit16u al)	{ intNr = _intNr, ahValue = ah; alValue = al; type = BKPNT_INTERRUPT; };
 	void					SetOnce			(bool _once)				{ once = _once; };
 	void					SetType			(EBreakpoint _type)			{ type = _type; };
 	void					SetValue		(Bit8u value)				{ ahValue = value; };
+	void					SetOther		(Bit8u other)				{ alValue = other; };
 
 	bool					IsActive		(void)						{ return active; };
 	void					Activate		(bool _active);
 
 	EBreakpoint				GetType			(void)						{ return type; };
 	bool					GetOnce			(void)						{ return once; };
-	PhysPt					GetLocation		(void)						{ if (GetType()!=BKPNT_INTERRUPT)	return location;	else return 0; };
+	PhysPt					GetLocation		(void)						{ return location; };
 	Bit16u					GetSegment		(void)						{ return segment; };
 	Bit32u					GetOffset		(void)						{ return offset; };
-	Bit8u					GetIntNr		(void)						{ if (GetType()==BKPNT_INTERRUPT)	return intNr;		else return 0; };
-	Bit16u					GetValue		(void)						{ if (GetType()!=BKPNT_PHYSICAL)	return ahValue;		else return 0; };
+	Bit8u					GetIntNr		(void)						{ return intNr; };
+	Bit16u					GetValue		(void)						{ return ahValue; };
+	Bit16u					GetOther		(void)						{ return alValue; };
 
 	// statics
 	static CBreakpoint*		AddBreakpoint		(Bit16u seg, Bit32u off, bool once);
-	static CBreakpoint*		AddIntBreakpoint	(Bit8u intNum, Bit16u ah, bool once);
+	static CBreakpoint*		AddIntBreakpoint	(Bit8u intNum, Bit16u ah, Bit16u al, bool once);
 	static CBreakpoint*		AddMemBreakpoint	(Bit16u seg, Bit32u off);
 	static void				ActivateBreakpoints	(PhysPt adr, bool activate);
 	static bool				CheckBreakpoint		(PhysPt adr);
 	static bool				CheckBreakpoint		(Bitu seg, Bitu off);
-	static bool				CheckIntBreakpoint	(PhysPt adr, Bit8u intNr, Bit16u ahValue);
+	static bool				CheckIntBreakpoint	(PhysPt adr, Bit8u intNr, Bit16u ahValue, Bit16u alValue);
 	static bool				IsBreakpoint		(PhysPt where);
 	static bool				IsBreakpointDrawn	(PhysPt where);
 	static bool				DeleteBreakpoint	(PhysPt where);
@@ -317,6 +327,7 @@
 	// Int
 	Bit8u		intNr;
 	Bit16u		ahValue;
+	Bit16u		alValue;
 	// Shared
 	bool		active;
 	bool		once;
@@ -329,7 +340,7 @@
 CBreakpoint::CBreakpoint(void):
 location(0),
 active(false),once(false),
-segment(0),offset(0),intNr(0),ahValue(0),
+segment(0),offset(0),intNr(0),ahValue(0),alValue(0),
 type(BKPNT_UNKNOWN) { };
 
 void CBreakpoint::Activate(bool _active)
@@ -357,7 +368,7 @@
 // Statics
 std::list<CBreakpoint*> CBreakpoint::BPoints;
 CBreakpoint*			CBreakpoint::ignoreOnce = 0;
-Bitu					ignoreAddressOnce = 0;
+PhysPt					ignoreAddressOnce = 0;
 
 CBreakpoint* CBreakpoint::AddBreakpoint(Bit16u seg, Bit32u off, bool once)
 {
@@ -368,10 +379,10 @@
 	return bp;
 };
 
-CBreakpoint* CBreakpoint::AddIntBreakpoint(Bit8u intNum, Bit16u ah, bool once)
+CBreakpoint* CBreakpoint::AddIntBreakpoint(Bit8u intNum, Bit16u ah, Bit16u al, bool once)
 {
 	CBreakpoint* bp = new CBreakpoint();
-	bp->SetInt			(intNum,ah);
+	bp->SetInt			(intNum,ah,al);
 	bp->SetOnce			(once);
 	BPoints.push_front	(bp);
 	return bp;
@@ -394,7 +405,7 @@
 	CBreakpoint* bp;
 	for(i=BPoints.begin(); i != BPoints.end(); i++) {
 		bp = (*i);
-		// Do not activate, when bp is an actual adress
+		// Do not activate, when bp is an actual address
 		if (activate && (bp->GetType()==BKPNT_PHYSICAL) && (bp->GetLocation()==adr)) {
 			// Do not activate :)
 			continue;
@@ -404,7 +415,7 @@
 };
 
 bool CBreakpoint::CheckBreakpoint(Bitu seg, Bitu off)
-// Checks if breakpoint is valid an should stop execution
+// Checks if breakpoint is valid and should stop execution
 {
 	if ((ignoreAddressOnce!=0) && (GetAddress(seg,off)==ignoreAddressOnce)) {
 		ignoreAddressOnce = 0;
@@ -467,8 +478,8 @@
 	return false;
 };
 
-bool CBreakpoint::CheckIntBreakpoint(PhysPt adr, Bit8u intNr, Bit16u ahValue)
-// Checks if interrupt breakpoint is valid an should stop execution
+bool CBreakpoint::CheckIntBreakpoint(PhysPt adr, Bit8u intNr, Bit16u ahValue, Bit16u alValue)
+// Checks if interrupt breakpoint is valid and should stop execution
 {
 	if ((ignoreAddressOnce!=0) && (adr==ignoreAddressOnce)) {
 		ignoreAddressOnce = 0;
@@ -482,8 +493,8 @@
 	for(i=BPoints.begin(); i != BPoints.end(); i++) {
 		bp = (*i);
 		if ((bp->GetType()==BKPNT_INTERRUPT) && bp->IsActive() && (bp->GetIntNr()==intNr)) {
-			if ((bp->GetValue()==BPINT_ALL) || (bp->GetValue()==ahValue)) {
-				// Ignoie it once ?
+			if (((bp->GetValue()==BPINT_ALL) || (bp->GetValue()==ahValue)) && ((bp->GetOther()==BPINT_ALL) || (bp->GetOther()==alValue))) {
+				// Ignore it once ?
 				if (ignoreOnce==bp) {
 					ignoreOnce=0;
 					bp->Activate(true);
@@ -598,8 +609,9 @@
 		if (bp->GetType()==BKPNT_PHYSICAL) {
 			DEBUG_ShowMsg("%02X. BP %04X:%04X\n",nr,bp->GetSegment(),bp->GetOffset());
 		} else if (bp->GetType()==BKPNT_INTERRUPT) {
-			if (bp->GetValue()==BPINT_ALL)	DEBUG_ShowMsg("%02X. BPINT %02X\n",nr,bp->GetIntNr());					
-			else							DEBUG_ShowMsg("%02X. BPINT %02X AH=%02X\n",nr,bp->GetIntNr(),bp->GetValue());
+			if (bp->GetValue()==BPINT_ALL) DEBUG_ShowMsg("%02X. BPINT %02X\n",nr,bp->GetIntNr());
+			else if (bp->GetOther()==BPINT_ALL) DEBUG_ShowMsg("%02X. BPINT %02X AH=%02X\n",nr,bp->GetIntNr(),bp->GetValue());
+			else DEBUG_ShowMsg("%02X. BPINT %02X AH=%02X AL=%02X\n",nr,bp->GetIntNr(),bp->GetValue(),bp->GetOther());
 		} else if (bp->GetType()==BKPNT_MEMORY) {
 			DEBUG_ShowMsg("%02X. BPMEM %04X:%04X (%02X)\n",nr,bp->GetSegment(),bp->GetOffset(),bp->GetValue());
 		} else if (bp->GetType()==BKPNT_MEMORY_PROT) {
@@ -613,7 +625,7 @@
 
 bool DEBUG_Breakpoint(void)
 {
-	/* First get the phyiscal address and check for a set Breakpoint */
+	/* First get the physical address and check for a set Breakpoint */
 	if (!CBreakpoint::CheckBreakpoint(SegValue(cs),reg_eip)) return false;
 	// Found. Breakpoint is valid
 	PhysPt where=GetAddress(SegValue(cs),reg_eip);
@@ -623,9 +635,9 @@
 
 bool DEBUG_IntBreakpoint(Bit8u intNum)
 {
-	/* First get the phyiscal address and check for a set Breakpoint */
+	/* First get the physical address and check for a set Breakpoint */
 	PhysPt where=GetAddress(SegValue(cs),reg_eip);
-	if (!CBreakpoint::CheckIntBreakpoint(where,intNum,reg_ah)) return false;
+	if (!CBreakpoint::CheckIntBreakpoint(where,intNum,reg_ah,reg_al)) return false;
 	// Found. Breakpoint is valid
 	CBreakpoint::ActivateBreakpoints(where,false);	// Deactivate all breakpoints
 	return true;
@@ -673,7 +685,7 @@
 	Bit32u address;
 	/* Data win */	
 	for (int y=0; y<8; y++) {
-		// Adress
+		// Address
 		if (add<0x10000) mvwprintw (dbg.win_data,1+y,0,"%04X:%04X     ",dataSeg,add);
 		else mvwprintw (dbg.win_data,1+y,0,"%04X:%08X ",dataSeg,add);
 		for (int x=0; x<16; x++) {
@@ -775,6 +787,8 @@
 				wattrset(dbg.win_code,COLOR_PAIR(PAIR_GREEN_BLACK));			
 				if (codeViewData.cursorPos==-1) {
 					codeViewData.cursorPos = i; // Set Cursor 
+				}
+				if (i == codeViewData.cursorPos) {
 					codeViewData.cursorSeg = SegValue(cs);
 					codeViewData.cursorOfs = disEIP;
 				}
@@ -837,12 +851,18 @@
 	
 	wattrset(dbg.win_code,0);			
 	if (!debugging) {
-		mvwprintw(dbg.win_code,10,0,"(Running)",codeViewData.inputStr);
-	} else { 
-		if(!*codeViewData.inputStr) { //Clear old commands
-			mvwprintw(dbg.win_code,10,0,"                                                                            ");
-		}
-		mvwprintw(dbg.win_code,10,0,"-> %s_  ",codeViewData.inputStr);
+		mvwprintw(dbg.win_code,10,0,"%s","(Running)");
+		wclrtoeol(dbg.win_code);
+	} else {
+		//TODO long lines
+		char* dispPtr = codeViewData.inputStr; 
+		char* curPtr = &codeViewData.inputStr[codeViewData.inputPos];
+		mvwprintw(dbg.win_code,10,0,"%c-> %s%c",
+			(codeViewData.ovrMode?'O':'I'),dispPtr,(*curPtr?' ':'_'));
+		wclrtoeol(dbg.win_code); // not correct in pdcurses if full line
+		if (*curPtr) {
+			mvwchgat(dbg.win_code,10,(curPtr-dispPtr+4),1,0,(PAIR_BLACK_GREY),NULL);
+ 		} 
 	}
 
 	wrefresh(dbg.win_code);
@@ -973,7 +993,7 @@
 		return true;
 	};
 
-	if (command == "MEMDUMPBIN") { // Dump memory to file bineary
+	if (command == "MEMDUMPBIN") { // Dump memory to file binary
 		Bit16u seg = (Bit16u)GetHexValue(found,found); found++;
 		Bit32u ofs = GetHexValue(found,found); found++;
 		Bit32u num = GetHexValue(found,found); found++;
@@ -1021,6 +1041,11 @@
 		return true;
 	};
 
+	if (command == "ADDLOG") {
+		if(found && *found)	DEBUG_ShowMsg("NOTICE: %s\n",found);
+		return true;
+	};
+
 	if (command == "SR") { // Set register value
 		DEBUG_ShowMsg("DEBUG: Set Register %s.\n",(ChangeRegister(found)?"success":"failure"));
 		return true;
@@ -1084,14 +1109,21 @@
 
 	if (command == "BPINT") { // Add Interrupt Breakpoint
 		Bit8u intNr	= (Bit8u)GetHexValue(found,found);
-		bool all = !(*found);found++;
-		Bit8u valAH	= (Bit8u)GetHexValue(found,found);
+		bool all = !(*found);
+		Bit8u valAH = (Bit8u)GetHexValue(found,found);
 		if ((valAH==0x00) && (*found=='*' || all)) {
-			CBreakpoint::AddIntBreakpoint(intNr,BPINT_ALL,false);
+			CBreakpoint::AddIntBreakpoint(intNr,BPINT_ALL,BPINT_ALL,false);
 			DEBUG_ShowMsg("DEBUG: Set interrupt breakpoint at INT %02X\n",intNr);
 		} else {
-			CBreakpoint::AddIntBreakpoint(intNr,valAH,false);
-			DEBUG_ShowMsg("DEBUG: Set interrupt breakpoint at INT %02X AH=%02X\n",intNr,valAH);
+			all = !(*found);
+			Bit8u valAL = (Bit8u)GetHexValue(found,found);
+			if ((valAL==0x00) && (*found=='*' || all)) {
+				CBreakpoint::AddIntBreakpoint(intNr,valAH,BPINT_ALL,false);
+				DEBUG_ShowMsg("DEBUG: Set interrupt breakpoint at INT %02X AH=%02X\n",intNr,valAH);
+			} else {
+				CBreakpoint::AddIntBreakpoint(intNr,valAH,valAL,false);
+				DEBUG_ShowMsg("DEBUG: Set interrupt breakpoint at INT %02X AH=%02X AL=%02X\n",intNr,valAH,valAL);
+			}
 		}
 		return true;
 	};
@@ -1121,6 +1153,7 @@
 		DEBUG_ShowMsg("DEBUG: Set code overview to %04X:%04X\n",codeSeg,codeOfs);
 		codeViewData.useCS	= codeSeg;
 		codeViewData.useEIP = codeOfs;
+		codeViewData.cursorPos = 0;
 		return true;
 	};
 
@@ -1226,6 +1259,7 @@
 			DEBUG_ShowMsg("DEBUG: Set code overview to interrupt handler %X\n",intNr);
 			codeViewData.useCS	= mem_readw(intNr*4+2);
 			codeViewData.useEIP = mem_readw(intNr*4);
+			codeViewData.cursorPos = 0;
 			return true;
 		}
 	};
@@ -1259,7 +1293,8 @@
 	if (command == "HELP" || command == "?") {
 		DEBUG_ShowMsg("Debugger commands (enter all values in hex or as register):\n");
 		DEBUG_ShowMsg("--------------------------------------------------------------------------\n");
-		DEBUG_ShowMsg("F3/F6                     - Re-enter previous command.\n");
+		DEBUG_ShowMsg("F3/F6                     - Previous command in history.\n");
+		DEBUG_ShowMsg("F4/F7                     - Next command in history.\n");
 		DEBUG_ShowMsg("F5                        - Run.\n");
 		DEBUG_ShowMsg("F9                        - Set/Remove breakpoint.\n");
 		DEBUG_ShowMsg("F10/F11                   - Step over / trace into instruction.\n");
@@ -1270,7 +1305,8 @@
 		DEBUG_ShowMsg("Home/End                  - Scroll log messages.\n");
 		DEBUG_ShowMsg("BP     [segment]:[offset] - Set breakpoint.\n");
 		DEBUG_ShowMsg("BPINT  [intNr] *          - Set interrupt breakpoint.\n");
-		DEBUG_ShowMsg("BPINT  [intNr] [ah]       - Set interrupt breakpoint with ah.\n");
+		DEBUG_ShowMsg("BPINT  [intNr] [ah] *     - Set interrupt breakpoint with ah.\n");
+		DEBUG_ShowMsg("BPINT  [intNr] [ah] [al]  - Set interrupt breakpoint with ah and al.\n");
 #if C_HEAVY_DEBUG
 		DEBUG_ShowMsg("BPM    [segment]:[offset] - Set memory breakpoint (memory change).\n");
 		DEBUG_ShowMsg("BPPM   [selector]:[offset]- Set pmode-memory breakpoint (memory change).\n");
@@ -1285,7 +1321,7 @@
 		DEBUG_ShowMsg("LOG [num]                 - Write cpu log file.\n");
 		DEBUG_ShowMsg("LOGS/LOGL [num]           - Write short/long cpu log file.\n");
 		DEBUG_ShowMsg("HEAVYLOG                  - Enable/Disable automatic cpu log when dosbox exits.\n");
-		DEBUG_ShowMsg("ZEROPROTECT               - Enable/Disable zero code execution detecion.\n");
+		DEBUG_ShowMsg("ZEROPROTECT               - Enable/Disable zero code execution detection.\n");
 #endif
 		DEBUG_ShowMsg("SR [reg] [value]          - Set register value.\n");
 		DEBUG_ShowMsg("SM [seg]:[off] [val] [.]..- Set memory with following values.\n");	
@@ -1294,6 +1330,8 @@
 		DEBUG_ShowMsg("SV [filename]             - Save var list in file.\n");
 		DEBUG_ShowMsg("LV [filename]             - Load var list from file.\n");
 
+		DEBUG_ShowMsg("ADDLOG [message]          - Add message to the log file.\n");
+
 		DEBUG_ShowMsg("MEMDUMP [seg]:[off] [len] - Write memory to file memdump.txt.\n");
 		DEBUG_ShowMsg("MEMDUMPBIN [s]:[o] [len]  - Write memory to file memdump.bin.\n");
 		DEBUG_ShowMsg("SELINFO [segName]         - Show selector info.\n");
@@ -1383,7 +1421,7 @@
 		// Variable found ?
 		CDebugVar* var = CDebugVar::FindVar(address);
 		if (var) {
-			// Replace occurance
+			// Replace occurrence
 			char* pos1 = strchr(inst,'[');
 			char* pos2 = strchr(inst,']');
 			if (pos1 && pos2) {
@@ -1476,12 +1514,12 @@
 		if (jmp) {
 			pos = strchr(instu,'$');
 			if (pos) {
-			pos = strchr(instu,'+');
-			if (pos) {
-				strcpy(result,"(down)");
-			} else {
-				strcpy(result,"(up)");
-			}
+				pos = strchr(instu,'+');
+				if (pos) {
+					strcpy(result,"(down)");
+				} else {
+					strcpy(result,"(up)");
+				}
 			}
 		} else {
 			sprintf(result,"(no jmp)");
@@ -1497,6 +1535,11 @@
 	if (key>0) {
 #if defined(WIN32) && defined(__PDCURSES__)
 		switch (key) {
+		case PADENTER:	key=0x0A;	break;
+		case PADSLASH:	key='/';	break;
+		case PADSTAR:	key='*';	break;
+		case PADMINUS:	key='-';	break;
+		case PADPLUS:	key='+';	break;
 		case ALT_D:
 			if (ungetch('D') != ERR) key=27;
 			break;
@@ -1518,7 +1561,7 @@
 		case 27:	// escape (a bit slow): Clears line. and processes alt commands.
 			key=getch();
 			if(key < 0) { //Purely escape Clear line
-				codeViewData.inputStr[0] = 0; 
+				ClearInputLine();
 				break;
 			}
 
@@ -1584,23 +1627,54 @@
 		case KEY_END:	// End: scroll log page down
 				DEBUG_RefreshPage(1);
 				break;
-		case KEY_F(6):  // Re-enter previous command (f1-f4 generate rubbish at my place)
-		case KEY_F(3):  // Re-enter previous command
-				// copy prevInputStr back into inputStr
-				safe_strncpy(codeViewData.inputStr, codeViewData.prevInputStr, sizeof(codeViewData.inputStr));
+		case KEY_IC:	// Insert: toggle insert/overwrite
+				codeViewData.ovrMode = !codeViewData.ovrMode;
+				break;
+		case KEY_LEFT:	// move to the left in command line
+				if (codeViewData.inputPos > 0) codeViewData.inputPos--;
+ 				break;
+		case KEY_RIGHT:	// move to the right in command line
+				if (codeViewData.inputStr[codeViewData.inputPos]) codeViewData.inputPos++;
+				break;
+		case KEY_F(6):	// previous command (f1-f4 generate rubbish at my place)
+		case KEY_F(3):	// previous command 
+				if (histBuffPos == histBuff.begin()) break;
+				if (histBuffPos == histBuff.end()) {
+					// copy inputStr to suspInputStr so we can restore it
+					safe_strncpy(codeViewData.suspInputStr, codeViewData.inputStr, sizeof(codeViewData.suspInputStr));
+				}
+				safe_strncpy(codeViewData.inputStr,(*--histBuffPos).c_str(),sizeof(codeViewData.inputStr));
+				codeViewData.inputPos = strlen(codeViewData.inputStr);
 				break;
+		case KEY_F(7):	// next command (f1-f4 generate rubbish at my place)
+		case KEY_F(4):	// next command
+				if (histBuffPos == histBuff.end()) break;
+				if (++histBuffPos != histBuff.end()) {
+					safe_strncpy(codeViewData.inputStr,(*histBuffPos).c_str(),sizeof(codeViewData.inputStr));
+				} else {
+					// copy suspInputStr back into inputStr
+					safe_strncpy(codeViewData.inputStr, codeViewData.suspInputStr, sizeof(codeViewData.inputStr));
+				}
+				codeViewData.inputPos = strlen(codeViewData.inputStr);
+				break; 
 		case KEY_F(5):	// Run Program
 				debugging=false;
 				CBreakpoint::ActivateBreakpoints(SegPhys(cs)+reg_eip,true);						
 				ignoreAddressOnce = SegPhys(cs)+reg_eip;
 				DOSBOX_SetNormalLoop();	
 				break;
-		case KEY_F(9):	// Set/Remove TBreakpoint
+		case KEY_F(9):	// Set/Remove Breakpoint
 				{	PhysPt ptr = GetAddress(codeViewData.cursorSeg,codeViewData.cursorOfs);
-					if (CBreakpoint::IsBreakpoint(ptr)) CBreakpoint::DeleteBreakpoint(ptr);
-					else								CBreakpoint::AddBreakpoint(codeViewData.cursorSeg, codeViewData.cursorOfs, false);
+					if (CBreakpoint::IsBreakpoint(ptr)) {
+						CBreakpoint::DeleteBreakpoint(ptr);
+						DEBUG_ShowMsg("DEBUG: Breakpoint deletion success.\n");
+					}
+					else {
+						CBreakpoint::AddBreakpoint(codeViewData.cursorSeg, codeViewData.cursorOfs, false);
+						DEBUG_ShowMsg("DEBUG: Set breakpoint at %04X:%04X\n",codeViewData.cursorSeg,codeViewData.cursorOfs);
+					}
 				}
-						break;
+				break;
 		case KEY_F(10):	// Step over inst
 				if (StepOver()) return 0;
 				else {
@@ -1621,30 +1695,59 @@
 				CBreakpoint::ignoreOnce = 0;
 				break;
 		case 0x0A: //Parse typed Command
-				codeViewData.inputMode = true;
+				codeViewData.inputStr[MAXCMDLEN] = '\0';
 				if(ParseCommand(codeViewData.inputStr)) {
-					// copy inputStr to prevInputStr so we can restore it if the user hits F3
-					safe_strncpy(codeViewData.prevInputStr, codeViewData.inputStr, sizeof(codeViewData.prevInputStr));
-					// clear input line ready for next command
-					codeViewData.inputStr[0] = 0;
-				}
+					char* cmd = ltrim(codeViewData.inputStr);
+					if (histBuff.empty() || *--histBuff.end()!=cmd)
+						histBuff.push_back(cmd);
+					if (histBuff.size() > MAX_HIST_BUFFER) histBuff.pop_front();
+					histBuffPos = histBuff.end();
+					ClearInputLine();
+				} else { 
+					codeViewData.inputPos = strlen(codeViewData.inputStr);
+				} 
 				break;
-		case 0x107:     //backspace (linux)
-		case 0x7f:	//backspace in some terminal emulators (linux)
-		case 0x08:	// delete
-				if (strlen(codeViewData.inputStr)>0) codeViewData.inputStr[strlen(codeViewData.inputStr)-1] = 0;
-				break;
-		default	:	if ((key>=32) && (key<=128) && (strlen(codeViewData.inputStr)<253)) {
-					Bit32u len = strlen(codeViewData.inputStr);
-					codeViewData.inputStr[len]	= char(key);
-					codeViewData.inputStr[len+1] = 0;
+		case KEY_BACKSPACE: //backspace (linux)
+		case 0x7f:	// backspace in some terminal emulators (linux)
+		case 0x08:	// delete 
+				if (codeViewData.inputPos == 0) break;
+				codeViewData.inputPos--;
+				// fallthrough
+		case KEY_DC: // delete character 
+				if ((codeViewData.inputPos<0) || (codeViewData.inputPos>=MAXCMDLEN)) break;
+				if (codeViewData.inputStr[codeViewData.inputPos] != 0) {
+						codeViewData.inputStr[MAXCMDLEN] = '\0';
+						for(char* p=&codeViewData.inputStr[codeViewData.inputPos];(*p=*(p+1));p++) {}
+				}
+ 				break;
+		default:
+				if ((key>=32) && (key<127)) {
+					if ((codeViewData.inputPos<0) || (codeViewData.inputPos>=MAXCMDLEN)) break;
+					codeViewData.inputStr[MAXCMDLEN] = '\0';
+					if (codeViewData.inputStr[codeViewData.inputPos] == 0) {
+							codeViewData.inputStr[codeViewData.inputPos++] = char(key);
+							codeViewData.inputStr[codeViewData.inputPos] = '\0';
+					} else if (!codeViewData.ovrMode) {
+						int len = (int) strlen(codeViewData.inputStr);
+						if (len < MAXCMDLEN) { 
+							for(len++;len>codeViewData.inputPos;len--)
+								codeViewData.inputStr[len]=codeViewData.inputStr[len-1];
+							codeViewData.inputStr[codeViewData.inputPos++] = char(key);
+						}
+					} else {
+						codeViewData.inputStr[codeViewData.inputPos++] = char(key);
+					}
+				} else if (key==killchar()) {
+					ClearInputLine();
 				}
 				break;
-
 		}
-                if (ret<0) return ret;
+		if (ret<0) return ret;
 		if (ret>0) {
-			ret=(*CallBack_Handlers[ret])();
+			if (GCC_UNLIKELY(ret >= CB_MAX)) 
+				ret = 0;
+			else
+				ret = (*CallBack_Handlers[ret])();
 			if (ret) {
 				exitLoop=true;
 				CPU_Cycles=CPU_CycleLeft=0;
@@ -1706,7 +1809,8 @@
 	DOS_MCB mcb(mcb_segment);
 	char filename[9]; // 8 characters plus a terminating NUL
 	const char *psp_seg_note;
-	PhysPt dataAddr = PhysMake(dataSeg,dataOfs);// location being viewed in the "Data Overview"
+	Bit16u DOS_dataOfs = static_cast<Bit16u>(dataOfs); //Realmode addressing only
+	PhysPt dataAddr = PhysMake(dataSeg,DOS_dataOfs);// location being viewed in the "Data Overview"
 
 	// loop forever, breaking out of the loop once we've processed the last MCB
 	while (true) {
@@ -1736,7 +1840,7 @@
 		PhysPt mcbStartAddr = PhysMake(mcb_segment+1,0);
 		PhysPt mcbEndAddr = PhysMake(mcb_segment+1+mcb.GetSize(),0);
 		if (dataAddr >= mcbStartAddr && dataAddr < mcbEndAddr) {
-			LOG(LOG_MISC,LOG_ERROR)("   (data addr %04hX:%04X is %u bytes past this MCB)",dataSeg,dataOfs,dataAddr - mcbStartAddr);
+			LOG(LOG_MISC,LOG_ERROR)("   (data addr %04hX:%04X is %u bytes past this MCB)",dataSeg,DOS_dataOfs,dataAddr - mcbStartAddr);
 		}
 
 		// if we've just processed the last MCB in the chain, break out of the loop
@@ -1772,9 +1876,9 @@
 	while (address<max) {
 		desc.Load(address);
 		sprintf(out1,"%04X: b:%08X type: %02X parbg",(i<<3),desc.GetBase(),desc.saved.seg.type);
-		LOG(LOG_MISC,LOG_ERROR)(out1);
+		LOG(LOG_MISC,LOG_ERROR)("%s",out1);
 		sprintf(out1,"      l:%08X dpl : %01X  %1X%1X%1X%1X%1X",desc.GetLimit(),desc.saved.seg.dpl,desc.saved.seg.p,desc.saved.seg.avl,desc.saved.seg.r,desc.saved.seg.big,desc.saved.seg.g);
-		LOG(LOG_MISC,LOG_ERROR)(out1);
+		LOG(LOG_MISC,LOG_ERROR)("%s",out1);
 		address+=8; i++;
 	};
 };
@@ -1792,9 +1896,9 @@
 	while (address<max) {
 		desc.Load(address);
 		sprintf(out1,"%04X: b:%08X type: %02X parbg",(i<<3)|4,desc.GetBase(),desc.saved.seg.type);
-		LOG(LOG_MISC,LOG_ERROR)(out1);
+		LOG(LOG_MISC,LOG_ERROR)("%s",out1);
 		sprintf(out1,"      l:%08X dpl : %01X  %1X%1X%1X%1X%1X",desc.GetLimit(),desc.saved.seg.dpl,desc.saved.seg.p,desc.saved.seg.avl,desc.saved.seg.r,desc.saved.seg.big,desc.saved.seg.g);
-		LOG(LOG_MISC,LOG_ERROR)(out1);
+		LOG(LOG_MISC,LOG_ERROR)("%s",out1);
 		address+=8; i++;
 	};
 };
@@ -1806,7 +1910,7 @@
 	while (address<256*8) {
 		if (cpu.idt.GetDescriptor(address,desc)) {
 			sprintf(out1,"%04X: sel:%04X off:%02X",address/8,desc.GetSelector(),desc.GetOffset());
-			LOG(LOG_MISC,LOG_ERROR)(out1);
+			LOG(LOG_MISC,LOG_ERROR)("%s",out1);
 		}
 		address+=8;
 	};
@@ -1829,7 +1933,7 @@
 						sprintf(out1,"page %05Xxxx -> %04Xxxx  flags [uw] %x:%x::%x:%x [d=%x|a=%x]",
 							i,entry.block.base,entry.block.us,table.block.us,
 							entry.block.wr,table.block.wr,entry.block.d,entry.block.a);
-						LOG(LOG_MISC,LOG_ERROR)(out1);
+						LOG(LOG_MISC,LOG_ERROR)("%s",out1);
 					}
 				}
 			}
@@ -1842,10 +1946,10 @@
 				Bitu entry_addr=(table.block.base<<12)+(sel & 0x3ff)*4;
 				entry.load=phys_readd(entry_addr);
 				sprintf(out1,"page %05Xxxx -> %04Xxxx  flags [puw] %x:%x::%x:%x::%x:%x",sel,entry.block.base,entry.block.p,table.block.p,entry.block.us,table.block.us,entry.block.wr,table.block.wr);
-				LOG(LOG_MISC,LOG_ERROR)(out1);
+				LOG(LOG_MISC,LOG_ERROR)("%s",out1);
 			} else {
 				sprintf(out1,"pagetable %03X not present, flags [puw] %x::%x::%x",(sel >> 10),table.block.p,table.block.us,table.block.wr);
-				LOG(LOG_MISC,LOG_ERROR)(out1);
+				LOG(LOG_MISC,LOG_ERROR)("%s",out1);
 			}
 		}
 	}
@@ -1854,24 +1958,24 @@
 static void LogCPUInfo(void) {
 	char out1[512];
 	sprintf(out1,"cr0:%08X cr2:%08X cr3:%08X  cpl=%x",cpu.cr0,paging.cr2,paging.cr3,cpu.cpl);
-	LOG(LOG_MISC,LOG_ERROR)(out1);
+	LOG(LOG_MISC,LOG_ERROR)("%s",out1);
 	sprintf(out1,"eflags:%08X [vm=%x iopl=%x nt=%x]",reg_flags,GETFLAG(VM)>>17,GETFLAG(IOPL)>>12,GETFLAG(NT)>>14);
-	LOG(LOG_MISC,LOG_ERROR)(out1);
+	LOG(LOG_MISC,LOG_ERROR)("%s",out1);
 	sprintf(out1,"GDT base=%08X limit=%08X",cpu.gdt.GetBase(),cpu.gdt.GetLimit());
-	LOG(LOG_MISC,LOG_ERROR)(out1);
+	LOG(LOG_MISC,LOG_ERROR)("%s",out1);
 	sprintf(out1,"IDT base=%08X limit=%08X",cpu.idt.GetBase(),cpu.idt.GetLimit());
-	LOG(LOG_MISC,LOG_ERROR)(out1);
+	LOG(LOG_MISC,LOG_ERROR)("%s",out1);
 
 	Bitu sel=CPU_STR();
 	Descriptor desc;
 	if (cpu.gdt.GetDescriptor(sel,desc)) {
 		sprintf(out1,"TR selector=%04X, base=%08X limit=%08X*%X",sel,desc.GetBase(),desc.GetLimit(),desc.saved.seg.g?0x4000:1);
-		LOG(LOG_MISC,LOG_ERROR)(out1);
+		LOG(LOG_MISC,LOG_ERROR)("%s",out1);
 	}
 	sel=CPU_SLDT();
 	if (cpu.gdt.GetDescriptor(sel,desc)) {
 		sprintf(out1,"LDT selector=%04X, base=%08X limit=%08X*%X",sel,desc.GetBase(),desc.GetLimit(),desc.saved.seg.g?0x4000:1);
-		LOG(LOG_MISC,LOG_ERROR)(out1);
+		LOG(LOG_MISC,LOG_ERROR)("%s",out1);
 	}
 };
 
@@ -1902,7 +2006,7 @@
 		char ibytes[200]="";	char tmpc[200];
 		for (Bitu i=0; i<size; i++) {
 			Bit8u value;
-			if (mem_readb_checked(start+i,&value)) sprintf(tmpc,"?? ",value);
+			if (mem_readb_checked(start+i,&value)) sprintf(tmpc,"%s","?? ");
 			else sprintf(tmpc,"%02X ",value);
 			strcat(ibytes,tmpc);
 		}
@@ -1952,13 +2056,12 @@
 		}
 	   
 		char filename[128];
-		char args[256];
+		char args[256+1];
 	
 		cmd->FindCommand(1,temp_line);
 		safe_strncpy(filename,temp_line.c_str(),128);
 		// Read commandline
 		Bit16u i	=2;
-		bool ok		= false; 
 		args[0]		= 0;
 		for (;cmd->FindCommand(i++,temp_line)==true;) {
 			strncat(args,temp_line.c_str(),256);
@@ -2022,26 +2125,27 @@
 	WIN32_Console();
 	#else
 	tcgetattr(0,&consolesettings);
-	printf("\e[8;50;80t"); //resize terminal
-	fflush(NULL);
+	//curses must be inited first in order to catch the resize (is an event)
+//	printf("\e[8;50;80t"); //resize terminal
+//	fflush(NULL);
 	#endif	
 	memset((void *)&dbg,0,sizeof(dbg));
 	debugging=false;
-	dbg.active_win=3;
-	input_count=0;
+//	dbg.active_win=3;
 	/* Start the Debug Gui */
 	DBGUI_StartUp();
 }
 
-static void DEBUG_ShutDown(Section * /*sec*/) {
+void DEBUG_ShutDown(Section * /*sec*/) {
 	CBreakpoint::DeleteAll();
 	CDebugVar::DeleteAll();
 	curs_set(old_cursor_state);
+	endwin();
 	#ifndef WIN32
 	tcsetattr(0, TCSANOW,&consolesettings);
 //	printf("\e[0m\e[2J"); //Seems to destroy scrolling
-	printf("\ec");
-	fflush(NULL);
+//	printf("\ec"); //Doesn't seem to be needed anymore
+//	fflush(NULL);
 	#endif
 }
 
@@ -2049,11 +2153,11 @@
 
 void DEBUG_Init(Section* sec) {
 
-	MSG_Add("DEBUG_CONFIGFILE_HELP","Debugger related options.\n");
+//	MSG_Add("DEBUG_CONFIGFILE_HELP","Debugger related options.\n");
 	DEBUG_DrawScreen();
 	/* Add some keyhandlers */
 	MAPPER_AddHandler(DEBUG_Enable,MK_pause,MMOD2,"debugger","Debugger");
-	/* Clear the TBreakpoint list */
+	/* Reset code overview and input line */
 	memset((void*)&codeViewData,0,sizeof(codeViewData));
 	/* setup debug.com */
 	PROGRAMS_MakeFile("DEBUG.COM",DEBUG_ProgramStart);
@@ -2093,11 +2197,11 @@
 	return 0;
 };
 
-bool CDebugVar::SaveVars(char* name)
-{
+bool CDebugVar::SaveVars(char* name) {
+	if (varList.size()>65535) return false;
+
 	FILE* f = fopen(name,"wb+");
 	if (!f) return false;
-	if (varList.size()>65535) return false;
 
 	// write number of vars
 	Bit16u num = (Bit16u)varList.size();
@@ -2124,15 +2228,15 @@
 
 	// read number of vars
 	Bit16u num;
-	fread(&num,1,sizeof(num),f);
+	if (fread(&num,sizeof(num),1,f) != 1) return false;
 
 	for (Bit16u i=0; i<num; i++) {
 		char name[16];
 		// name
-		fread(name,1,16,f);
+		if (fread(name,16,1,f) != 1) break;
 		// adr
 		PhysPt adr;
-		fread(&adr,1,sizeof(adr),f);
+		if (fread(&adr,sizeof(adr),1,f) != 1) break;
 		// insert
 		InsertVariable(name,adr);
 	};
@@ -2140,7 +2244,7 @@
 	return true;
 };
 
-static void SaveMemory(Bitu seg, Bitu ofs1, Bit32u num) {
+static void SaveMemory(Bit16u seg, Bit32u ofs1, Bit32u num) {
 	FILE* f = fopen("MEMDUMP.TXT","wt");
 	if (!f) {
 		DEBUG_ShowMsg("DEBUG: Memory dump failed.\n");
@@ -2154,7 +2258,7 @@
 		sprintf(buffer,"%04X:%04X   ",seg,ofs1);
 		for (Bit16u x=0; x<16; x++) {
 			Bit8u value;
-			if (mem_readb_checked(GetAddress(seg,ofs1+x),&value)) sprintf(temp,"?? ",value);
+			if (mem_readb_checked(GetAddress(seg,ofs1+x),&value)) sprintf(temp,"%s","?? ");
 			else sprintf(temp,"%02X ",value);
 			strcat(buffer,temp);
 		}
@@ -2167,7 +2271,7 @@
 		sprintf(buffer,"%04X:%04X   ",seg,ofs1);
 		for (Bit16u x=0; x<num; x++) {
 			Bit8u value;
-			if (mem_readb_checked(GetAddress(seg,ofs1+x),&value)) sprintf(temp,"?? ",value);
+			if (mem_readb_checked(GetAddress(seg,ofs1+x),&value)) sprintf(temp,"%s","?? ");
 			else sprintf(temp,"%02X ",value);
 			strcat(buffer,temp);
 		}
@@ -2177,7 +2281,7 @@
 	DEBUG_ShowMsg("DEBUG: Memory dump success.\n");
 }
 
-static void SaveMemoryBin(Bitu seg, Bitu ofs1, Bit32u num) {
+static void SaveMemoryBin(Bit16u seg, Bit32u ofs1, Bit32u num) {
 	FILE* f = fopen("MEMDUMP.BIN","wb");
 	if (!f) {
 		DEBUG_ShowMsg("DEBUG: Memory binary dump failed.\n");
@@ -2229,7 +2333,7 @@
 
 		Bit16u value;
 		if (mem_readw_checked(dv->GetAdr(),&value))
-			snprintf(buffer,DEBUG_VAR_BUF_LEN, "??????", value);
+			snprintf(buffer,DEBUG_VAR_BUF_LEN, "%s", "??????");
 		else
 			snprintf(buffer,DEBUG_VAR_BUF_LEN, "0x%04x", value);
 
@@ -2248,8 +2352,6 @@
 
 const Bit32u LOGCPUMAX = 20000;
 
-static Bit16u logCpuCS [LOGCPUMAX];
-static Bit32u logCpuEIP[LOGCPUMAX];
 static Bit32u logCount = 0;
 
 struct TLogInst {
@@ -2287,7 +2389,7 @@
 
 	PhysPt start = GetAddress(SegValue(cs),reg_eip);
 	char dline[200];
-	Bitu size = DasmI386(dline, start, reg_eip, cpu.code.big);
+	DasmI386(dline, start, reg_eip, cpu.code.big);
 	char* res = empty;
 	if (showExtend) {
 		res = AnalyzeInstruction(dline,false);
@@ -2343,7 +2445,7 @@
 	out << hex << noshowbase << setfill('0') << uppercase;
 	Bit32u startLog = logCount;
 	do {
-		// Write Intructions
+		// Write Instructions
 		TLogInst & inst = logInst[startLog];
 		out << setw(4) << inst.s_cs << ":" << setw(8) << inst.eip << "  " 
 		    << inst.dline << "  " << inst.res << " EAX:" << setw(8)<< inst.eax
diff -Nur dosbox-0.74/src/debug/debug_disasm.cpp dosbox-0.74.patch/src/debug/debug_disasm.cpp
--- dosbox-0.74/src/debug/debug_disasm.cpp	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/debug/debug_disasm.cpp	2016-12-11 18:35:15.518284006 +0100
@@ -283,8 +283,10 @@
   0,                  0,                 0,                0,
   0,                  0,                 0,                0,
 /* 3 */
-  0, 0, 0, 0, 0, 0, 0, 0,
-  0, 0, 0, 0, 0, 0, 0, 0,
+  0,                  "rdtsc",           0,                0,
+  0,                  0,                 0,                0,
+  0,                  0,                 0,                0,
+  0,                  0,                 0,                0,
 /* 4 */
   0, 0, 0, 0, 0, 0, 0, 0,
   0, 0, 0, 0, 0, 0, 0, 0,
@@ -947,7 +949,9 @@
        break;
 
   case '2':                            /* old [pop cs]! now indexes */
-       ua_str(second[getbyte()]);      /* instructions in 386/486   */
+       c = getbyte();
+       wordop = c & 1;
+       ua_str(second[c]);              /* instructions in 386/486   */
        break;
 
   case 'g':                            /* modrm group `subtype' (0--7) */
diff -Nur dosbox-0.74/src/debug/debug_gui.cpp dosbox-0.74.patch/src/debug/debug_gui.cpp
--- dosbox-0.74/src/debug/debug_gui.cpp	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/debug/debug_gui.cpp	2016-12-11 18:35:15.518284006 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: debug_gui.cpp,v 1.38 2009-05-27 09:15:41 qbix79 Exp $ */
 
 #include "dosbox.h"
 
@@ -87,6 +86,7 @@
 	list<string>::iterator i = logBuffPos;
 	int maxy, maxx; getmaxyx(dbg.win_out,maxy,maxx);
 	int rem_lines = maxy;
+	if(rem_lines == -1) return;
 
 	wclear(dbg.win_out);
 
@@ -110,7 +110,7 @@
 
 	if (d_type>=LOG_MAX) return;
 	if ((d_severity!=LOG_ERROR) && (!loggrp[d_type].enabled)) return;
-	DEBUG_ShowMsg("%10u: %s:%s\n",cycle_count,loggrp[d_type].front,buf);
+	DEBUG_ShowMsg("%10u: %s:%s\n",static_cast<Bit32u>(cycle_count),loggrp[d_type].front,buf);
 }
 
 
@@ -146,40 +146,42 @@
 		attrset(COLOR_PAIR(PAIR_BLACK_BLUE));
 	}
 	/* Show the Register bar */
-	mvaddstr(dbg.win_reg->_begy-1,0, "---(Register Overview                   )---");
+	mvaddstr(1-1,0, "---(Register Overview                   )---");
 	/* Show the Data Overview bar perhaps with more special stuff in the end */
-	mvaddstr(dbg.win_data->_begy-1,0,"---(Data Overview   Scroll: page up/down)---");
+	mvaddstr(6-1,0,"---(Data Overview   Scroll: page up/down)---");
 	/* Show the Code Overview perhaps with special stuff in bar too */
-	mvaddstr(dbg.win_code->_begy-1,0,"---(Code Overview   Scroll: up/down     )---");
+	mvaddstr(17-1,0,"---(Code Overview   Scroll: up/down     )---");
 	/* Show the Variable Overview bar */
-	mvaddstr(dbg.win_var->_begy-1,0, "---(Variable Overview                   )---");
+	mvaddstr(29-1,0, "---(Variable Overview                   )---");
 	/* Show the Output OverView */
-	mvaddstr(dbg.win_out->_begy-1,0, "---(OutPut/Input    Scroll: home/end    )---");
+	mvaddstr(34-1,0, "---(Output          Scroll: home/end    )---");
 	attrset(0);
+	//Match values with below. So we don't need to touch the internal window structures
 }
 
 
 
 static void MakeSubWindows(void) {
-	/* The Std output win should go in bottem */
+	/* The Std output win should go at the bottom */
 	/* Make all the subwindows */
 	int win_main_maxy, win_main_maxx; getmaxyx(dbg.win_main,win_main_maxy,win_main_maxx);
-	int outy=1;
+	int outy=1; //Match values with above
 	/* The Register window  */
 	dbg.win_reg=subwin(dbg.win_main,4,win_main_maxx,outy,0);
-	outy+=5;
+	outy+=5; // 6
 	/* The Data Window */
 	dbg.win_data=subwin(dbg.win_main,10,win_main_maxx,outy,0);
-	outy+=11;
+	outy+=11; // 17
 	/* The Code Window */
 	dbg.win_code=subwin(dbg.win_main,11,win_main_maxx,outy,0);
-	outy+=12;
+	outy+=12; // 29
 	/* The Variable Window */
 	dbg.win_var=subwin(dbg.win_main,4,win_main_maxx,outy,0);
-	outy+=5;
+	outy+=5; // 34
 	/* The Output Window */	
-	dbg.win_out=subwin(dbg.win_main,win_main_maxy-outy-1,win_main_maxx,outy,0);
-	dbg.input_y=win_main_maxy-1;
+	dbg.win_out=subwin(dbg.win_main,win_main_maxy-outy,win_main_maxx,outy,0);
+	if(!dbg.win_reg ||!dbg.win_data || !dbg.win_code || !dbg.win_var || !dbg.win_out) E_Exit("Setting up windows failed");
+//	dbg.input_y=win_main_maxy-1;
 	scrollok(dbg.win_out,TRUE);
 	DrawBars();
 	Draw_RegisterLayout();
@@ -245,6 +247,7 @@
 	loggrp[LOG_MISC].front="MISC";
 
 	loggrp[LOG_IO].front="IO";
+	loggrp[LOG_PCI].front="PCI";
 	
 	/* Register the log section */
 	Section_prop * sect=control->AddSection_prop("log",LOG_Init);
@@ -257,7 +260,7 @@
 		Prop_bool* Pbool = sect->Add_bool(buf,Property::Changeable::Always,true);
 		Pbool->Set_help("Enable/Disable logging of this type.");
 	}
-	MSG_Add("LOG_CONFIGFILE_HELP","Logging related options for the debugger.\n");
+//	MSG_Add("LOG_CONFIGFILE_HELP","Logging related options for the debugger.\n");
 }
 
 
@@ -271,6 +274,8 @@
 	nodelay(dbg.win_main,true);
 	keypad(dbg.win_main,true);
 	#ifndef WIN32
+	printf("\e[8;50;80t");
+	fflush(NULL);
 	resizeterm(50,80);
 	touchwin(dbg.win_main);
 	#endif
diff -Nur dosbox-0.74/src/debug/debug_inc.h dosbox-0.74.patch/src/debug/debug_inc.h
--- dosbox-0.74/src/debug/debug_inc.h	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/debug/debug_inc.h	2016-12-11 18:35:15.518284006 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -18,7 +18,6 @@
 
 /* Local Debug Function */
 
-/* $Id: debug_inc.h,v 1.12 2009-05-27 09:15:41 qbix79 Exp $ */
 
 #include <curses.h>
 #include "mem.h"
diff -Nur dosbox-0.74/src/debug/debug_win32.cpp dosbox-0.74.patch/src/debug/debug_win32.cpp
--- dosbox-0.74/src/debug/debug_win32.cpp	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/debug/debug_win32.cpp	2016-12-11 18:35:15.518284006 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
diff -Nur dosbox-0.74/src/debug/disasm_tables.h dosbox-0.74.patch/src/debug/disasm_tables.h
--- dosbox-0.74/src/debug/disasm_tables.h	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/debug/disasm_tables.h	2016-12-11 18:35:15.518284006 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
diff -Nur dosbox-0.74/src/debug/Makefile.in dosbox-0.74.patch/src/debug/Makefile.in
--- dosbox-0.74/src/debug/Makefile.in	2010-05-12 11:57:44.000000000 +0200
+++ dosbox-0.74.patch/src/debug/Makefile.in	1970-01-01 01:00:00.000000000 +0100
@@ -1,447 +0,0 @@
-# Makefile.in generated by automake 1.11.1 from Makefile.am.
-# @configure_input@
-
-# Copyright (C) 1994, 1995, 1996, 1997, 1998, 1999, 2000, 2001, 2002,
-# 2003, 2004, 2005, 2006, 2007, 2008, 2009  Free Software Foundation,
-# Inc.
-# This Makefile.in is free software; the Free Software Foundation
-# gives unlimited permission to copy and/or distribute it,
-# with or without modifications, as long as this notice is preserved.
-
-# This program is distributed in the hope that it will be useful,
-# but WITHOUT ANY WARRANTY, to the extent permitted by law; without
-# even the implied warranty of MERCHANTABILITY or FITNESS FOR A
-# PARTICULAR PURPOSE.
-
-@SET_MAKE@
-
-VPATH = @srcdir@
-pkgdatadir = $(datadir)/@PACKAGE@
-pkgincludedir = $(includedir)/@PACKAGE@
-pkglibdir = $(libdir)/@PACKAGE@
-pkglibexecdir = $(libexecdir)/@PACKAGE@
-am__cd = CDPATH="$${ZSH_VERSION+.}$(PATH_SEPARATOR)" && cd
-install_sh_DATA = $(install_sh) -c -m 644
-install_sh_PROGRAM = $(install_sh) -c
-install_sh_SCRIPT = $(install_sh) -c
-INSTALL_HEADER = $(INSTALL_DATA)
-transform = $(program_transform_name)
-NORMAL_INSTALL = :
-PRE_INSTALL = :
-POST_INSTALL = :
-NORMAL_UNINSTALL = :
-PRE_UNINSTALL = :
-POST_UNINSTALL = :
-build_triplet = @build@
-host_triplet = @host@
-subdir = src/debug
-DIST_COMMON = $(srcdir)/Makefile.am $(srcdir)/Makefile.in
-ACLOCAL_M4 = $(top_srcdir)/aclocal.m4
-am__aclocal_m4_deps = $(top_srcdir)/acinclude.m4 \
-	$(top_srcdir)/configure.in
-am__configure_deps = $(am__aclocal_m4_deps) $(CONFIGURE_DEPENDENCIES) \
-	$(ACLOCAL_M4)
-mkinstalldirs = $(install_sh) -d
-CONFIG_HEADER = $(top_builddir)/config.h
-CONFIG_CLEAN_FILES =
-CONFIG_CLEAN_VPATH_FILES =
-LIBRARIES = $(noinst_LIBRARIES)
-AR = ar
-ARFLAGS = cru
-libdebug_a_AR = $(AR) $(ARFLAGS)
-libdebug_a_LIBADD =
-am_libdebug_a_OBJECTS = debug.$(OBJEXT) debug_gui.$(OBJEXT) \
-	debug_disasm.$(OBJEXT) debug_win32.$(OBJEXT)
-libdebug_a_OBJECTS = $(am_libdebug_a_OBJECTS)
-DEFAULT_INCLUDES = -I.@am__isrc@ -I$(top_builddir)
-depcomp = $(SHELL) $(top_srcdir)/depcomp
-am__depfiles_maybe = depfiles
-am__mv = mv -f
-CXXCOMPILE = $(CXX) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) \
-	$(AM_CPPFLAGS) $(CPPFLAGS) $(AM_CXXFLAGS) $(CXXFLAGS)
-CXXLD = $(CXX)
-CXXLINK = $(CXXLD) $(AM_CXXFLAGS) $(CXXFLAGS) $(AM_LDFLAGS) $(LDFLAGS) \
-	-o $@
-COMPILE = $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) \
-	$(CPPFLAGS) $(AM_CFLAGS) $(CFLAGS)
-CCLD = $(CC)
-LINK = $(CCLD) $(AM_CFLAGS) $(CFLAGS) $(AM_LDFLAGS) $(LDFLAGS) -o $@
-SOURCES = $(libdebug_a_SOURCES)
-DIST_SOURCES = $(libdebug_a_SOURCES)
-ETAGS = etags
-CTAGS = ctags
-DISTFILES = $(DIST_COMMON) $(DIST_SOURCES) $(TEXINFOS) $(EXTRA_DIST)
-ACLOCAL = @ACLOCAL@
-ALSA_CFLAGS = @ALSA_CFLAGS@
-ALSA_LIBS = @ALSA_LIBS@
-AMTAR = @AMTAR@
-AUTOCONF = @AUTOCONF@
-AUTOHEADER = @AUTOHEADER@
-AUTOMAKE = @AUTOMAKE@
-AWK = @AWK@
-CC = @CC@
-CCDEPMODE = @CCDEPMODE@
-CFLAGS = @CFLAGS@
-CPP = @CPP@
-CPPFLAGS = @CPPFLAGS@
-CXX = @CXX@
-CXXDEPMODE = @CXXDEPMODE@
-CXXFLAGS = @CXXFLAGS@
-CYGPATH_W = @CYGPATH_W@
-DEFS = @DEFS@
-DEPDIR = @DEPDIR@
-ECHO_C = @ECHO_C@
-ECHO_N = @ECHO_N@
-ECHO_T = @ECHO_T@
-EGREP = @EGREP@
-EXEEXT = @EXEEXT@
-GREP = @GREP@
-INSTALL = @INSTALL@
-INSTALL_DATA = @INSTALL_DATA@
-INSTALL_PROGRAM = @INSTALL_PROGRAM@
-INSTALL_SCRIPT = @INSTALL_SCRIPT@
-INSTALL_STRIP_PROGRAM = @INSTALL_STRIP_PROGRAM@
-LDFLAGS = @LDFLAGS@
-LIBOBJS = @LIBOBJS@
-LIBS = @LIBS@
-LTLIBOBJS = @LTLIBOBJS@
-MAKEINFO = @MAKEINFO@
-MKDIR_P = @MKDIR_P@
-OBJEXT = @OBJEXT@
-PACKAGE = @PACKAGE@
-PACKAGE_BUGREPORT = @PACKAGE_BUGREPORT@
-PACKAGE_NAME = @PACKAGE_NAME@
-PACKAGE_STRING = @PACKAGE_STRING@
-PACKAGE_TARNAME = @PACKAGE_TARNAME@
-PACKAGE_URL = @PACKAGE_URL@
-PACKAGE_VERSION = @PACKAGE_VERSION@
-PATH_SEPARATOR = @PATH_SEPARATOR@
-RANLIB = @RANLIB@
-SDL_CFLAGS = @SDL_CFLAGS@
-SDL_CONFIG = @SDL_CONFIG@
-SDL_LIBS = @SDL_LIBS@
-SET_MAKE = @SET_MAKE@
-SHELL = @SHELL@
-STRIP = @STRIP@
-VERSION = @VERSION@
-WINDRES = @WINDRES@
-abs_builddir = @abs_builddir@
-abs_srcdir = @abs_srcdir@
-abs_top_builddir = @abs_top_builddir@
-abs_top_srcdir = @abs_top_srcdir@
-ac_ct_CC = @ac_ct_CC@
-ac_ct_CXX = @ac_ct_CXX@
-am__include = @am__include@
-am__leading_dot = @am__leading_dot@
-am__quote = @am__quote@
-am__tar = @am__tar@
-am__untar = @am__untar@
-bindir = @bindir@
-build = @build@
-build_alias = @build_alias@
-build_cpu = @build_cpu@
-build_os = @build_os@
-build_vendor = @build_vendor@
-builddir = @builddir@
-datadir = @datadir@
-datarootdir = @datarootdir@
-docdir = @docdir@
-dvidir = @dvidir@
-exec_prefix = @exec_prefix@
-host = @host@
-host_alias = @host_alias@
-host_cpu = @host_cpu@
-host_os = @host_os@
-host_vendor = @host_vendor@
-htmldir = @htmldir@
-includedir = @includedir@
-infodir = @infodir@
-install_sh = @install_sh@
-libdir = @libdir@
-libexecdir = @libexecdir@
-localedir = @localedir@
-localstatedir = @localstatedir@
-mandir = @mandir@
-mkdir_p = @mkdir_p@
-oldincludedir = @oldincludedir@
-pdfdir = @pdfdir@
-prefix = @prefix@
-program_transform_name = @program_transform_name@
-psdir = @psdir@
-sbindir = @sbindir@
-sharedstatedir = @sharedstatedir@
-srcdir = @srcdir@
-sysconfdir = @sysconfdir@
-target_alias = @target_alias@
-top_build_prefix = @top_build_prefix@
-top_builddir = @top_builddir@
-top_srcdir = @top_srcdir@
-AM_CPPFLAGS = -I$(top_srcdir)/include
-noinst_LIBRARIES = libdebug.a
-libdebug_a_SOURCES = debug.cpp debug_gui.cpp debug_disasm.cpp debug_inc.h disasm_tables.h debug_win32.cpp
-all: all-am
-
-.SUFFIXES:
-.SUFFIXES: .cpp .o .obj
-$(srcdir)/Makefile.in:  $(srcdir)/Makefile.am  $(am__configure_deps)
-	@for dep in $?; do \
-	  case '$(am__configure_deps)' in \
-	    *$$dep*) \
-	      ( cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh ) \
-	        && { if test -f $@; then exit 0; else break; fi; }; \
-	      exit 1;; \
-	  esac; \
-	done; \
-	echo ' cd $(top_srcdir) && $(AUTOMAKE) --gnu src/debug/Makefile'; \
-	$(am__cd) $(top_srcdir) && \
-	  $(AUTOMAKE) --gnu src/debug/Makefile
-.PRECIOUS: Makefile
-Makefile: $(srcdir)/Makefile.in $(top_builddir)/config.status
-	@case '$?' in \
-	  *config.status*) \
-	    cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh;; \
-	  *) \
-	    echo ' cd $(top_builddir) && $(SHELL) ./config.status $(subdir)/$@ $(am__depfiles_maybe)'; \
-	    cd $(top_builddir) && $(SHELL) ./config.status $(subdir)/$@ $(am__depfiles_maybe);; \
-	esac;
-
-$(top_builddir)/config.status: $(top_srcdir)/configure $(CONFIG_STATUS_DEPENDENCIES)
-	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
-
-$(top_srcdir)/configure:  $(am__configure_deps)
-	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
-$(ACLOCAL_M4):  $(am__aclocal_m4_deps)
-	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
-$(am__aclocal_m4_deps):
-
-clean-noinstLIBRARIES:
-	-test -z "$(noinst_LIBRARIES)" || rm -f $(noinst_LIBRARIES)
-libdebug.a: $(libdebug_a_OBJECTS) $(libdebug_a_DEPENDENCIES) 
-	-rm -f libdebug.a
-	$(libdebug_a_AR) libdebug.a $(libdebug_a_OBJECTS) $(libdebug_a_LIBADD)
-	$(RANLIB) libdebug.a
-
-mostlyclean-compile:
-	-rm -f *.$(OBJEXT)
-
-distclean-compile:
-	-rm -f *.tab.c
-
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/debug.Po@am__quote@
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/debug_disasm.Po@am__quote@
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/debug_gui.Po@am__quote@
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/debug_win32.Po@am__quote@
-
-.cpp.o:
-@am__fastdepCXX_TRUE@	$(CXXCOMPILE) -MT $@ -MD -MP -MF $(DEPDIR)/$*.Tpo -c -o $@ $<
-@am__fastdepCXX_TRUE@	$(am__mv) $(DEPDIR)/$*.Tpo $(DEPDIR)/$*.Po
-@AMDEP_TRUE@@am__fastdepCXX_FALSE@	source='$<' object='$@' libtool=no @AMDEPBACKSLASH@
-@AMDEP_TRUE@@am__fastdepCXX_FALSE@	DEPDIR=$(DEPDIR) $(CXXDEPMODE) $(depcomp) @AMDEPBACKSLASH@
-@am__fastdepCXX_FALSE@	$(CXXCOMPILE) -c -o $@ $<
-
-.cpp.obj:
-@am__fastdepCXX_TRUE@	$(CXXCOMPILE) -MT $@ -MD -MP -MF $(DEPDIR)/$*.Tpo -c -o $@ `$(CYGPATH_W) '$<'`
-@am__fastdepCXX_TRUE@	$(am__mv) $(DEPDIR)/$*.Tpo $(DEPDIR)/$*.Po
-@AMDEP_TRUE@@am__fastdepCXX_FALSE@	source='$<' object='$@' libtool=no @AMDEPBACKSLASH@
-@AMDEP_TRUE@@am__fastdepCXX_FALSE@	DEPDIR=$(DEPDIR) $(CXXDEPMODE) $(depcomp) @AMDEPBACKSLASH@
-@am__fastdepCXX_FALSE@	$(CXXCOMPILE) -c -o $@ `$(CYGPATH_W) '$<'`
-
-ID: $(HEADERS) $(SOURCES) $(LISP) $(TAGS_FILES)
-	list='$(SOURCES) $(HEADERS) $(LISP) $(TAGS_FILES)'; \
-	unique=`for i in $$list; do \
-	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
-	  done | \
-	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
-	      END { if (nonempty) { for (i in files) print i; }; }'`; \
-	mkid -fID $$unique
-tags: TAGS
-
-TAGS:  $(HEADERS) $(SOURCES)  $(TAGS_DEPENDENCIES) \
-		$(TAGS_FILES) $(LISP)
-	set x; \
-	here=`pwd`; \
-	list='$(SOURCES) $(HEADERS)  $(LISP) $(TAGS_FILES)'; \
-	unique=`for i in $$list; do \
-	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
-	  done | \
-	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
-	      END { if (nonempty) { for (i in files) print i; }; }'`; \
-	shift; \
-	if test -z "$(ETAGS_ARGS)$$*$$unique"; then :; else \
-	  test -n "$$unique" || unique=$$empty_fix; \
-	  if test $$# -gt 0; then \
-	    $(ETAGS) $(ETAGSFLAGS) $(AM_ETAGSFLAGS) $(ETAGS_ARGS) \
-	      "$$@" $$unique; \
-	  else \
-	    $(ETAGS) $(ETAGSFLAGS) $(AM_ETAGSFLAGS) $(ETAGS_ARGS) \
-	      $$unique; \
-	  fi; \
-	fi
-ctags: CTAGS
-CTAGS:  $(HEADERS) $(SOURCES)  $(TAGS_DEPENDENCIES) \
-		$(TAGS_FILES) $(LISP)
-	list='$(SOURCES) $(HEADERS)  $(LISP) $(TAGS_FILES)'; \
-	unique=`for i in $$list; do \
-	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
-	  done | \
-	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
-	      END { if (nonempty) { for (i in files) print i; }; }'`; \
-	test -z "$(CTAGS_ARGS)$$unique" \
-	  || $(CTAGS) $(CTAGSFLAGS) $(AM_CTAGSFLAGS) $(CTAGS_ARGS) \
-	     $$unique
-
-GTAGS:
-	here=`$(am__cd) $(top_builddir) && pwd` \
-	  && $(am__cd) $(top_srcdir) \
-	  && gtags -i $(GTAGS_ARGS) "$$here"
-
-distclean-tags:
-	-rm -f TAGS ID GTAGS GRTAGS GSYMS GPATH tags
-
-distdir: $(DISTFILES)
-	@srcdirstrip=`echo "$(srcdir)" | sed 's/[].[^$$\\*]/\\\\&/g'`; \
-	topsrcdirstrip=`echo "$(top_srcdir)" | sed 's/[].[^$$\\*]/\\\\&/g'`; \
-	list='$(DISTFILES)'; \
-	  dist_files=`for file in $$list; do echo $$file; done | \
-	  sed -e "s|^$$srcdirstrip/||;t" \
-	      -e "s|^$$topsrcdirstrip/|$(top_builddir)/|;t"`; \
-	case $$dist_files in \
-	  */*) $(MKDIR_P) `echo "$$dist_files" | \
-			   sed '/\//!d;s|^|$(distdir)/|;s,/[^/]*$$,,' | \
-			   sort -u` ;; \
-	esac; \
-	for file in $$dist_files; do \
-	  if test -f $$file || test -d $$file; then d=.; else d=$(srcdir); fi; \
-	  if test -d $$d/$$file; then \
-	    dir=`echo "/$$file" | sed -e 's,/[^/]*$$,,'`; \
-	    if test -d "$(distdir)/$$file"; then \
-	      find "$(distdir)/$$file" -type d ! -perm -700 -exec chmod u+rwx {} \;; \
-	    fi; \
-	    if test -d $(srcdir)/$$file && test $$d != $(srcdir); then \
-	      cp -fpR $(srcdir)/$$file "$(distdir)$$dir" || exit 1; \
-	      find "$(distdir)/$$file" -type d ! -perm -700 -exec chmod u+rwx {} \;; \
-	    fi; \
-	    cp -fpR $$d/$$file "$(distdir)$$dir" || exit 1; \
-	  else \
-	    test -f "$(distdir)/$$file" \
-	    || cp -p $$d/$$file "$(distdir)/$$file" \
-	    || exit 1; \
-	  fi; \
-	done
-check-am: all-am
-check: check-am
-all-am: Makefile $(LIBRARIES)
-installdirs:
-install: install-am
-install-exec: install-exec-am
-install-data: install-data-am
-uninstall: uninstall-am
-
-install-am: all-am
-	@$(MAKE) $(AM_MAKEFLAGS) install-exec-am install-data-am
-
-installcheck: installcheck-am
-install-strip:
-	$(MAKE) $(AM_MAKEFLAGS) INSTALL_PROGRAM="$(INSTALL_STRIP_PROGRAM)" \
-	  install_sh_PROGRAM="$(INSTALL_STRIP_PROGRAM)" INSTALL_STRIP_FLAG=-s \
-	  `test -z '$(STRIP)' || \
-	    echo "INSTALL_PROGRAM_ENV=STRIPPROG='$(STRIP)'"` install
-mostlyclean-generic:
-
-clean-generic:
-
-distclean-generic:
-	-test -z "$(CONFIG_CLEAN_FILES)" || rm -f $(CONFIG_CLEAN_FILES)
-	-test . = "$(srcdir)" || test -z "$(CONFIG_CLEAN_VPATH_FILES)" || rm -f $(CONFIG_CLEAN_VPATH_FILES)
-
-maintainer-clean-generic:
-	@echo "This command is intended for maintainers to use"
-	@echo "it deletes files that may require special tools to rebuild."
-clean: clean-am
-
-clean-am: clean-generic clean-noinstLIBRARIES mostlyclean-am
-
-distclean: distclean-am
-	-rm -rf ./$(DEPDIR)
-	-rm -f Makefile
-distclean-am: clean-am distclean-compile distclean-generic \
-	distclean-tags
-
-dvi: dvi-am
-
-dvi-am:
-
-html: html-am
-
-html-am:
-
-info: info-am
-
-info-am:
-
-install-data-am:
-
-install-dvi: install-dvi-am
-
-install-dvi-am:
-
-install-exec-am:
-
-install-html: install-html-am
-
-install-html-am:
-
-install-info: install-info-am
-
-install-info-am:
-
-install-man:
-
-install-pdf: install-pdf-am
-
-install-pdf-am:
-
-install-ps: install-ps-am
-
-install-ps-am:
-
-installcheck-am:
-
-maintainer-clean: maintainer-clean-am
-	-rm -rf ./$(DEPDIR)
-	-rm -f Makefile
-maintainer-clean-am: distclean-am maintainer-clean-generic
-
-mostlyclean: mostlyclean-am
-
-mostlyclean-am: mostlyclean-compile mostlyclean-generic
-
-pdf: pdf-am
-
-pdf-am:
-
-ps: ps-am
-
-ps-am:
-
-uninstall-am:
-
-.MAKE: install-am install-strip
-
-.PHONY: CTAGS GTAGS all all-am check check-am clean clean-generic \
-	clean-noinstLIBRARIES ctags distclean distclean-compile \
-	distclean-generic distclean-tags distdir dvi dvi-am html \
-	html-am info info-am install install-am install-data \
-	install-data-am install-dvi install-dvi-am install-exec \
-	install-exec-am install-html install-html-am install-info \
-	install-info-am install-man install-pdf install-pdf-am \
-	install-ps install-ps-am install-strip installcheck \
-	installcheck-am installdirs maintainer-clean \
-	maintainer-clean-generic mostlyclean mostlyclean-compile \
-	mostlyclean-generic pdf pdf-am ps ps-am tags uninstall \
-	uninstall-am
-
-
-# Tell versions [3.59,3.63) of GNU make to not export all variables.
-# Otherwise a system limit (for SysV at least) may be exceeded.
-.NOEXPORT:
diff -Nur dosbox-0.74/src/dos/cdrom_aspi_win32.cpp dosbox-0.74.patch/src/dos/cdrom_aspi_win32.cpp
--- dosbox-0.74/src/dos/cdrom_aspi_win32.cpp	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/dos/cdrom_aspi_win32.cpp	2016-12-11 18:35:15.518284006 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: cdrom_aspi_win32.cpp,v 1.21 2009-05-27 09:15:41 qbix79 Exp $ */
 
 #if defined (WIN32)
 
diff -Nur dosbox-0.74/src/dos/cdrom.cpp dosbox-0.74.patch/src/dos/cdrom.cpp
--- dosbox-0.74/src/dos/cdrom.cpp	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/dos/cdrom.cpp	2016-12-11 18:35:15.518284006 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: cdrom.cpp,v 1.27 2009-04-26 18:24:36 qbix79 Exp $ */
 
 // ******************************************************
 // SDL CDROM 
diff -Nur dosbox-0.74/src/dos/cdrom.h dosbox-0.74.patch/src/dos/cdrom.h
--- dosbox-0.74/src/dos/cdrom.h	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/dos/cdrom.h	2016-12-11 18:35:15.522284006 +0100
@@ -1,3 +1,21 @@
+/*
+ *  Copyright (C) 2002-2013  The DOSBox Team
+ *
+ *  This program is free software; you can redistribute it and/or modify
+ *  it under the terms of the GNU General Public License as published by
+ *  the Free Software Foundation; either version 2 of the License, or
+ *  (at your option) any later version.
+ *
+ *  This program is distributed in the hope that it will be useful,
+ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *  GNU General Public License for more details.
+ *
+ *  You should have received a copy of the GNU General Public License
+ *  along with this program; if not, write to the Free Software
+ *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+ */
+
 
 #ifndef __CDROM_INTERFACE__
 #define __CDROM_INTERFACE__
@@ -31,6 +49,11 @@
 	unsigned char fr;
 } TMSF;
 
+typedef struct SCtrl {
+	Bit8u	out[4];			// output channel
+	Bit8u	vol[4];			// channel volume
+} TCtrl;
+
 extern int CDROM_GetMountType(char* path, int force);
 
 class CDROM_Interface
@@ -52,6 +75,7 @@
 	virtual bool	PlayAudioSector		(unsigned long start,unsigned long len) = 0;
 	virtual bool	PauseAudio			(bool resume) = 0;
 	virtual bool	StopAudio			(void) = 0;
+	virtual void	ChannelControl		(TCtrl ctrl) = 0;
 	
 	virtual bool	ReadSectors			(PhysPt buffer, bool raw, unsigned long sector, unsigned long num) = 0;
 
@@ -76,6 +100,7 @@
 	virtual bool	PlayAudioSector		(unsigned long start,unsigned long len);
 	virtual bool	PauseAudio			(bool resume);
 	virtual bool	StopAudio			(void);
+	virtual void	ChannelControl		(TCtrl ctrl) { return; };
 	virtual bool	ReadSectors			(PhysPt /*buffer*/, bool /*raw*/, unsigned long /*sector*/, unsigned long /*num*/) { return false; };
 	virtual bool	LoadUnloadMedia		(bool unload);
 
@@ -101,6 +126,7 @@
 	bool	PlayAudioSector		(unsigned long /*start*/,unsigned long /*len*/) { return true; };
 	bool	PauseAudio			(bool /*resume*/) { return true; };
 	bool	StopAudio			(void) { return true; };
+	void	ChannelControl		(TCtrl ctrl) { return; };
 	bool	ReadSectors			(PhysPt /*buffer*/, bool /*raw*/, unsigned long /*sector*/, unsigned long /*num*/) { return true; };
 	bool	LoadUnloadMedia		(bool /*unload*/) { return true; };
 };	
@@ -166,6 +192,7 @@
 	bool	PlayAudioSector		(unsigned long start,unsigned long len);
 	bool	PauseAudio		(bool resume);
 	bool	StopAudio		(void);
+	void	ChannelControl		(TCtrl ctrl);
 	bool	ReadSectors		(PhysPt buffer, bool raw, unsigned long sector, unsigned long num);
 	bool	LoadUnloadMedia		(bool unload);
 	bool	ReadSector		(Bit8u *buffer, bool raw, unsigned long sector);
@@ -188,6 +215,8 @@
 		int     targetFrame;
 		bool    isPlaying;
 		bool    isPaused;
+		bool    ctrlUsed;
+		TCtrl   ctrlData;
 	} player;
 	
 	void 	ClearTracks();
@@ -234,6 +263,7 @@
 	bool	PlayAudioSector		(unsigned long start,unsigned long len);
 	bool	PauseAudio			(bool resume);
 	bool	StopAudio			(void);
+	void	ChannelControl		(TCtrl ctrl) { return; };
 	
 	bool	ReadSectors			(PhysPt buffer, bool raw, unsigned long sector, unsigned long num);
 
@@ -284,6 +314,7 @@
 	bool	PlayAudioSector		(unsigned long start,unsigned long len);
 	bool	PauseAudio			(bool resume);
 	bool	StopAudio			(void);
+	void	ChannelControl		(TCtrl ctrl);
 	
 	bool	ReadSector			(Bit8u *buffer, bool raw, unsigned long sector);
 	bool	ReadSectors			(PhysPt buffer, bool raw, unsigned long sector, unsigned long num);
@@ -338,6 +369,8 @@
 		int     targetFrame;
 		bool    isPlaying;
 		bool    isPaused;
+		bool    ctrlUsed;
+		TCtrl   ctrlData;
 	} player;
 
 };
diff -Nur dosbox-0.74/src/dos/cdrom_image.cpp dosbox-0.74.patch/src/dos/cdrom_image.cpp
--- dosbox-0.74/src/dos/cdrom_image.cpp	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/dos/cdrom_image.cpp	2016-12-11 18:35:15.522284006 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: cdrom_image.cpp,v 1.24 2009-03-19 20:45:42 c2woody Exp $ */
 
 #include <cctype>
 #include <cmath>
@@ -131,7 +130,7 @@
 int CDROM_Interface_Image::refCount = 0;
 CDROM_Interface_Image* CDROM_Interface_Image::images[26];
 CDROM_Interface_Image::imagePlayer CDROM_Interface_Image::player = {
-	NULL, NULL, NULL, {0}, 0, 0, 0, false, false };
+	NULL, NULL, NULL, {0}, 0, 0, 0, false, false, false, {0} };
 
 	
 CDROM_Interface_Image::CDROM_Interface_Image(Bit8u subUnit)
@@ -247,7 +246,6 @@
 
 bool CDROM_Interface_Image::PauseAudio(bool resume)
 {
-	if (!player.isPlaying) return false;
 	player.isPaused = !resume;
 	return true;
 }
@@ -259,6 +257,12 @@
 	return true;
 }
 
+void CDROM_Interface_Image::ChannelControl(TCtrl ctrl)
+{
+	player.ctrlUsed = (ctrl.out[0]!=0 || ctrl.out[1]!=1 || ctrl.vol[0]<0xfe || ctrl.vol[1]<0xfe);
+	player.ctrlData = ctrl;
+}
+
 bool CDROM_Interface_Image::ReadSectors(PhysPt buffer, bool raw, unsigned long sector, unsigned long num)
 {
 	int sectorSize = raw ? RAW_SECTOR_SIZE : COOKED_SECTOR_SIZE;
@@ -336,9 +340,25 @@
 		}
 	}
 	SDL_mutexV(player.mutex);
+	if (player.ctrlUsed) {
+		Bit16s sample0,sample1;
+		Bit16s * samples=(Bit16s *)&player.buffer;
+		for (Bitu pos=0;pos<len/4;pos++) {
 #if defined(WORDS_BIGENDIAN)
-	player.channel->AddSamples_s16_nonnative(len/4,(Bit16s *)player.buffer);
+			sample0=(Bit16s)host_readw((HostPt)&samples[pos*2+player.ctrlData.out[0]]);
+			sample1=(Bit16s)host_readw((HostPt)&samples[pos*2+player.ctrlData.out[1]]);
 #else
+			sample0=samples[pos*2+player.ctrlData.out[0]];
+			sample1=samples[pos*2+player.ctrlData.out[1]];
+#endif
+			samples[pos*2+0]=(Bit16s)(sample0*player.ctrlData.vol[0]/255.0);
+			samples[pos*2+1]=(Bit16s)(sample1*player.ctrlData.vol[1]/255.0);
+		}
+#if defined(WORDS_BIGENDIAN)
+		player.channel->AddSamples_s16(len/4,(Bit16s *)player.buffer);
+	} else	player.channel->AddSamples_s16_nonnative(len/4,(Bit16s *)player.buffer);
+#else
+	}
 	player.channel->AddSamples_s16(len/4,(Bit16s *)player.buffer);
 #endif
 	memmove(player.buffer, &player.buffer[len], player.bufLen - len);
@@ -638,7 +658,30 @@
 			return true;
 		}
 	}
-	
+#if defined (WIN32) || defined(OS2)
+	//Nothing
+#else
+	//Consider the possibility that the filename has a windows directory seperator (inside the CUE file) 
+	//which is common for some commercial rereleases of DOS games using DOSBox
+
+	string copy = filename;
+	size_t l = copy.size();
+	for (size_t i = 0; i < l;i++) {
+		if(copy[i] == '\\') copy[i] = '/';
+	}
+
+	if (stat(copy.c_str(), &test) == 0) {
+		filename = copy;
+		return true;
+	}
+
+	tmpstr = pathname + "/" + copy;
+	if (stat(tmpstr.c_str(), &test) == 0) {
+		filename = tmpstr;
+		return true;
+	}
+
+#endif
 	return false;
 }
 
diff -Nur dosbox-0.74/src/dos/cdrom_ioctl_linux.cpp dosbox-0.74.patch/src/dos/cdrom_ioctl_linux.cpp
--- dosbox-0.74/src/dos/cdrom_ioctl_linux.cpp	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/dos/cdrom_ioctl_linux.cpp	2016-12-11 18:35:15.522284006 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -37,7 +37,7 @@
 bool CDROM_Interface_Ioctl::GetUPC(unsigned char& attr, char* upc)
 {
 	int cdrom_fd = open(device_name, O_RDONLY | O_NONBLOCK);
-	if (cdrom_fd <= 0) return false;
+	if (cdrom_fd == -1) return false;
 	
 	struct cdrom_mcn cdrom_mcn;
 	int ret = ioctl(cdrom_fd, CDROM_GET_MCN, &cdrom_mcn);
@@ -55,7 +55,7 @@
 bool CDROM_Interface_Ioctl::ReadSectors(PhysPt buffer, bool raw, unsigned long sector, unsigned long num)
 {
 	int cdrom_fd = open(device_name, O_RDONLY | O_NONBLOCK);
-	if (cdrom_fd <= 0) return false;
+	if (cdrom_fd == -1) return false;
 	
 	Bits buflen = raw ? num * CD_FRAMESIZE_RAW : num * CD_FRAMESIZE;
 	Bit8u* buf = new Bit8u[buflen];	
diff -Nur dosbox-0.74/src/dos/cdrom_ioctl_os2.cpp dosbox-0.74.patch/src/dos/cdrom_ioctl_os2.cpp
--- dosbox-0.74/src/dos/cdrom_ioctl_os2.cpp	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/dos/cdrom_ioctl_os2.cpp	2016-12-11 18:35:15.522284006 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: cdrom_ioctl_os2.cpp,v 1.4 2009-05-27 09:15:41 qbix79 Exp $ */
 
 #include <string.h>
 #include "dosbox.h"
diff -Nur dosbox-0.74/src/dos/cdrom_ioctl_win32.cpp dosbox-0.74.patch/src/dos/cdrom_ioctl_win32.cpp
--- dosbox-0.74/src/dos/cdrom_ioctl_win32.cpp	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/dos/cdrom_ioctl_win32.cpp	2016-12-11 18:35:15.522284006 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: cdrom_ioctl_win32.cpp,v 1.16 2009-01-07 22:39:18 c2woody Exp $ */
 
 #if defined (WIN32)
 
@@ -175,7 +174,7 @@
 
 
 CDROM_Interface_Ioctl::dxPlayer CDROM_Interface_Ioctl::player = {
-	NULL, NULL, NULL, 0, 0,	0, 0, 0, false,	false };
+	NULL, NULL, NULL, {0}, 0, 0, 0, false, false, false, {0} };
 
 CDROM_Interface_Ioctl::CDROM_Interface_Ioctl(cdioctl_cdatype ioctl_cda) {
 	pathname[0] = 0;
@@ -430,7 +429,6 @@
 		return false;
 	}
 	if (use_dxplay) {
-		if (!player.isPlaying) return false;
 		player.isPaused = !resume;
 		return true;
 	}
@@ -462,6 +460,12 @@
 	return bStat>0;
 }
 
+void CDROM_Interface_Ioctl::ChannelControl(TCtrl ctrl)
+{
+	player.ctrlUsed = (ctrl.out[0]!=0 || ctrl.out[1]!=1 || ctrl.vol[0]<0xfe || ctrl.vol[1]<0xfe);
+	player.ctrlData = ctrl;
+}
+
 bool CDROM_Interface_Ioctl::LoadUnloadMedia(bool unload) {
 	BOOL bStat; 
 	DWORD byteCount;
@@ -553,6 +557,16 @@
 		}
 	}
 	SDL_mutexV(player.mutex);
+	if (player.ctrlUsed) {
+		Bit16s sample0,sample1;
+		Bit16s * samples=(Bit16s *)&player.buffer;
+		for (Bitu pos=0;pos<len/4;pos++) {
+			sample0=samples[pos*2+player.ctrlData.out[0]];
+			sample1=samples[pos*2+player.ctrlData.out[1]];
+			samples[pos*2+0]=(Bit16s)(sample0*player.ctrlData.vol[0]/255.0);
+			samples[pos*2+1]=(Bit16s)(sample1*player.ctrlData.vol[1]/255.0);
+		}
+	}
 	player.channel->AddSamples_s16(len/4,(Bit16s *)player.buffer);
 	memmove(player.buffer, &player.buffer[len], player.bufLen - len);
 	player.bufLen -= len;
diff -Nur dosbox-0.74/src/dos/dev_con.h dosbox-0.74.patch/src/dos/dev_con.h
--- dosbox-0.74/src/dos/dev_con.h	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/dos/dev_con.h	2016-12-11 18:35:15.522284006 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: dev_con.h,v 1.35 2009-05-27 09:15:41 qbix79 Exp $ */
 
 #include "dos_inc.h"
 #include "../ints/int10.h"
@@ -38,7 +37,7 @@
 private:
 	Bit8u readcache;
 	Bit8u lastwrite;
-	struct ansi { /* should create a constructor which fills them with the appriorate values */
+	struct ansi { /* should create a constructor, which would fill them with the appropriate values */
 		bool esc;
 		bool sci;
 		bool enabled;
@@ -129,7 +128,7 @@
 				count++;
 				continue;
 			} else { 
-				/* Some sort of "hack" now that \n doesn't set col to 0 (int10_char.cpp old chessgame) */
+				/* Some sort of "hack" now that '\n' doesn't set col to 0 (int10_char.cpp old chessgame) */
 				if((data[count] == '\n') && (lastwrite != '\r')) INT10_TeletypeOutputAttr('\r',ansi.attr,ansi.enabled);
 				/* pass attribute only if ansi is enabled */
 				INT10_TeletypeOutputAttr(data[count],ansi.attr,ansi.enabled);
diff -Nur dosbox-0.74/src/dos/dos_classes.cpp dosbox-0.74.patch/src/dos/dos_classes.cpp
--- dosbox-0.74/src/dos/dos_classes.cpp	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/dos/dos_classes.cpp	2016-12-11 18:35:15.522284006 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: dos_classes.cpp,v 1.58 2009-07-09 20:06:57 c2woody Exp $ */
 
 #include <string.h>
 #include <stdlib.h>
@@ -301,6 +300,9 @@
 }
 
 bool DOS_PSP::SetNumFiles(Bit16u fileNum) {
+	//20 minimum. clipper program.
+	if (fileNum < 20) fileNum = 20;
+	 
 	if (fileNum>20) {
 		// Allocate needed paragraphs
 		fileNum+=2;	// Add a few more files for safety
@@ -492,6 +494,10 @@
 	if(extended) mem_writeb(pt - 1,attr);
 }
 
+void DOS_FCB::SetResultAttr(Bit8u attr) {
+	mem_writeb(pt + 12,attr);
+}
+
 void DOS_SDA::Init() {
 	/* Clear */
 	for(Bitu i=0;i<sizeof(sSDA);i++) mem_writeb(pt+i,0x00);
diff -Nur dosbox-0.74/src/dos/dos.cpp dosbox-0.74.patch/src/dos/dos.cpp
--- dosbox-0.74/src/dos/dos.cpp	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/dos/dos.cpp	2016-12-11 18:35:15.522284006 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,12 +16,10 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: dos.cpp,v 1.121 2009-10-28 21:45:12 qbix79 Exp $ */
 
 #include <stdlib.h>
 #include <string.h>
 #include <ctype.h>
-#include <time.h>
 #include "dosbox.h"
 #include "bios.h"
 #include "mem.h"
@@ -42,6 +40,34 @@
 	dos.errorcode=code;
 }
 
+const Bit8u DOS_DATE_months[] = {
+	0, 31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31
+};
+
+static void DOS_AddDays(Bitu days) {
+	dos.date.day += days;
+	Bit8u monthlimit = DOS_DATE_months[dos.date.month];
+
+	if(dos.date.day > monthlimit) {
+		if((dos.date.year %4 == 0) && (dos.date.month==2)) {
+			// leap year
+			if(dos.date.day > 29) {
+				dos.date.month++;
+				dos.date.day -= 29;
+			}
+		} else {
+			//not leap year
+			dos.date.month++;
+			dos.date.day -= monthlimit;
+		}
+		if(dos.date.month > 12) {
+			// year over
+			dos.date.month = 1;
+			dos.date.year++;
+		}
+	}
+}
+
 #define DATA_TRANSFERS_TAKE_CYCLES 1
 #ifdef DATA_TRANSFERS_TAKE_CYCLES
 
@@ -86,6 +112,8 @@
 
 	char name1[DOSNAMEBUF+2+DOS_NAMELENGTH_ASCII];
 	char name2[DOSNAMEBUF+2+DOS_NAMELENGTH_ASCII];
+	
+	static Bitu time_start = 0; //For emulating temporary time changes.
 
 	switch (reg_ah) {
 	case 0x00:		/* Terminate Program */
@@ -192,6 +220,7 @@
 			Bit8u free=mem_readb(data);
 			Bit8u read=0;Bit8u c;Bit16u n=1;
 			if (!free) break;
+			free--;
 			for(;;) {
 				DOS_ReadFile(STDIN,&c,&n);
 				if (c == 8) {			// Backspace
@@ -204,7 +233,7 @@
 					}
 					continue;
 				}
-				if (read >= free) {		// Keyboard buffer full
+				if (read == free && c != 13) {		// Keyboard buffer full
 					Bit8u bell = 7;
 					DOS_WriteFile(STDOUT, &bell, &n);
 					continue;
@@ -227,10 +256,13 @@
 		break;
 	case 0x0c:		/* Flush Buffer and read STDIN call */
 		{
-			/* flush STDIN-buffer */
-			Bit8u c;Bit16u n;
-			while (DOS_GetSTDINStatus()) {
-				n=1;	DOS_ReadFile(STDIN,&c,&n);
+			/* flush buffer if STDIN is CON */
+			Bit8u handle=RealHandle(STDIN);
+			if (handle!=0xFF && Files[handle] && Files[handle]->IsName("CON")) {
+				Bit8u c;Bit16u n;
+				while (DOS_GetSTDINStatus()) {
+					n=1;	DOS_ReadFile(STDIN,&c,&n);
+				}
 			}
 			switch (reg_al) {
 			case 0x1:
@@ -316,11 +348,17 @@
 		if (!DOS_GetAllocationInfo(reg_dl,&reg_cx,&reg_al,&reg_dx)) reg_al=0xff;
 		break;
 	case 0x21:		/* Read random record from FCB */
-		reg_al = DOS_FCBRandomRead(SegValue(ds),reg_dx,1,true);
+		{
+			Bit16u toread=1;
+			reg_al = DOS_FCBRandomRead(SegValue(ds),reg_dx,&toread,true);
+		}
 		LOG(LOG_FCB,LOG_NORMAL)("DOS:0x21 FCB-Random read used, result:al=%d",reg_al);
 		break;
 	case 0x22:		/* Write random record to FCB */
-		reg_al=DOS_FCBRandomWrite(SegValue(ds),reg_dx,1,true);
+		{
+			Bit16u towrite=1;
+			reg_al=DOS_FCBRandomWrite(SegValue(ds),reg_dx,&towrite,true);
+		}
 		LOG(LOG_FCB,LOG_NORMAL)("DOS:0x22 FCB-Random write used, result:al=%d",reg_al);
 		break;
 	case 0x23:		/* Get file size for FCB */
@@ -331,11 +369,11 @@
 		DOS_FCBSetRandomRecord(SegValue(ds),reg_dx);
 		break;
 	case 0x27:		/* Random block read from FCB */
-		reg_al = DOS_FCBRandomRead(SegValue(ds),reg_dx,reg_cx,false);
+		reg_al = DOS_FCBRandomRead(SegValue(ds),reg_dx,&reg_cx,false);
 		LOG(LOG_FCB,LOG_NORMAL)("DOS:0x27 FCB-Random(block) read used, result:al=%d",reg_al);
 		break;
 	case 0x28:		/* Random Block write to FCB */
-		reg_al=DOS_FCBRandomWrite(SegValue(ds),reg_dx,reg_cx,false);
+		reg_al=DOS_FCBRandomWrite(SegValue(ds),reg_dx,&reg_cx,false);
 		LOG(LOG_FCB,LOG_NORMAL)("DOS:0x28 FCB-Random(block) write used, result:al=%d",reg_al);
 		break;
 	case 0x29:		/* Parse filename into FCB */
@@ -359,9 +397,13 @@
 		break;
 	case 0x26:		/* Create new PSP */
 		DOS_NewPSP(reg_dx,DOS_PSP(dos.psp()).GetSize());
+		reg_al=0xf0;	/* al destroyed */		
 		break;
 	case 0x2a:		/* Get System Date */
 		{
+			reg_ax=0; // get time
+			CALLBACK_RunRealInt(0x1a);
+			if(reg_al) DOS_AddDays(reg_al);
 			int a = (14 - dos.date.month)/12;
 			int y = dos.date.year - a;
 			int m = dos.date.month + 12*a - 2;
@@ -374,34 +416,49 @@
 	case 0x2b:		/* Set System Date */
 		if (reg_cx<1980) { reg_al=0xff;break;}
 		if ((reg_dh>12) || (reg_dh==0))	{ reg_al=0xff;break;}
-		if ((reg_dl>31) || (reg_dl==0))	{ reg_al=0xff;break;}
+		if (reg_dl==0) { reg_al=0xff;break;}
+ 		if (reg_dl>DOS_DATE_months[reg_dh]) {
+			if(!((reg_dh==2)&&(reg_cx%4 == 0)&&(reg_dl==29))) // february pass
+			{ reg_al=0xff;break; }
+		}
 		dos.date.year=reg_cx;
 		dos.date.month=reg_dh;
 		dos.date.day=reg_dl;
 		reg_al=0;
 		break;
-	case 0x2c:		/* Get System Time */
-//TODO Get time through bios calls date is fixed
-		{
-/*	Calculate how many miliseconds have passed */
-			Bitu ticks=5*mem_readd(BIOS_TIMER);
-			ticks = ((ticks / 59659u) << 16) + ((ticks % 59659u) << 16) / 59659u;
-			Bitu seconds=(ticks/100);
-			reg_ch=(Bit8u)(seconds/3600);
-			reg_cl=(Bit8u)((seconds % 3600)/60);
-			reg_dh=(Bit8u)(seconds % 60);
-			reg_dl=(Bit8u)(ticks % 100);
-		}
+	case 0x2c: {	/* Get System Time */
+		reg_ax=0; // get time
+		CALLBACK_RunRealInt(0x1a);
+		if(reg_al) DOS_AddDays(reg_al);
+		reg_ah=0x2c;
+
+		Bitu ticks=((Bitu)reg_cx<<16)|reg_dx;
+		if(time_start<=ticks) ticks-=time_start;
+		Bitu time=(Bitu)((100.0/((double)PIT_TICK_RATE/65536.0)) * (double)ticks);
+
+		reg_dl=(Bit8u)((Bitu)time % 100); // 1/100 seconds
+		time/=100;
+		reg_dh=(Bit8u)((Bitu)time % 60); // seconds
+		time/=60;
+		reg_cl=(Bit8u)((Bitu)time % 60); // minutes
+		time/=60;
+		reg_ch=(Bit8u)((Bitu)time % 24); // hours
+
 		//Simulate DOS overhead for timing-sensitive games
-        	//Robomaze 2
+        //Robomaze 2
 		overhead();
 		break;
+	}
 	case 0x2d:		/* Set System Time */
 		LOG(LOG_DOSMISC,LOG_ERROR)("DOS:Set System Time not supported");
 		//Check input parameters nonetheless
 		if( reg_ch > 23 || reg_cl > 59 || reg_dh > 59 || reg_dl > 99 )
 			reg_al = 0xff; 
-		else reg_al = 0;
+		else { //Allow time to be set to zero. Restore the orginal time for all other parameters. (QuickBasic)
+			if (reg_cx == 0 && reg_dx == 0) {time_start = mem_readd(BIOS_TIMER);LOG_MSG("Warning: game messes with DOS time!");}
+			else time_start = 0;
+			reg_al = 0;
+		}
 		break;
 	case 0x2e:		/* Set Verify flag */
 		dos.verify=(reg_al==1);
@@ -458,7 +515,9 @@
 				reg_dh=0x10;								/* Dos in HMA */
 				break;
 			default:
-				E_Exit("DOS:Illegal 0x33 Call %2X",reg_al);					
+				LOG(LOG_DOSMISC,LOG_ERROR)("Weird 0x33 call %2X",reg_al);
+				reg_al =0xff;
+				break;
 		}
 		break;
 	case 0x34:		/* Get INDos Flag */
@@ -520,6 +579,7 @@
 	case 0x39:		/* MKDIR Create directory */
 		MEM_StrCopy(SegPhys(ds)+reg_dx,name1,DOSNAMEBUF);
 		if (DOS_MakeDir(name1)) {
+			reg_ax=0x05;	/* ax destroyed */
 			CALLBACK_SCF(false);
 		} else {
 			reg_ax=dos.errorcode;
@@ -529,6 +589,7 @@
 	case 0x3a:		/* RMDIR Remove directory */
 		MEM_StrCopy(SegPhys(ds)+reg_dx,name1,DOSNAMEBUF);
 		if  (DOS_RemoveDir(name1)) {
+			reg_ax=0x05;	/* ax destroyed */
 			CALLBACK_SCF(false);
 		} else {
 			reg_ax=dos.errorcode;
@@ -539,6 +600,7 @@
 	case 0x3b:		/* CHDIR Set current directory */
 		MEM_StrCopy(SegPhys(ds)+reg_dx,name1,DOSNAMEBUF);
 		if  (DOS_ChangeDir(name1)) {
+			reg_ax=0x00;	/* ax destroyed */
 			CALLBACK_SCF(false);
 		} else {
 			reg_ax=dos.errorcode;
@@ -565,6 +627,7 @@
 		break;
 	case 0x3e:		/* CLOSE Close file */
 		if (DOS_CloseFile(reg_bx)) {
+//			reg_al=0x01;	/* al destroyed. Refcount */
 			CALLBACK_SCF(false);
 		} else {
 			reg_ax=dos.errorcode;
@@ -786,6 +849,7 @@
 	case 0x55:					/* Create Child PSP*/
 		DOS_ChildPSP(reg_dx,reg_si);
 		dos.psp(reg_dx);
+		reg_al=0xf0;	/* al destroyed */
 		break;
 	case 0x56:					/* RENAME Rename file */
 		MEM_StrCopy(SegPhys(ds)+reg_dx,name1,DOSNAMEBUF);
@@ -1056,7 +1120,7 @@
 
 	case 0x71:					/* Unknown probably 4dos detection */
 		reg_ax=0x7100;
-		CALLBACK_SCF(true);
+		CALLBACK_SCF(true); //Check this! What needs this ? See default case
 		LOG(LOG_DOSMISC,LOG_NORMAL)("DOS:Windows long file name support call %2X",reg_al);
 		break;
 
@@ -1070,7 +1134,7 @@
 	case 0xEF:                  /* Used in Ancient Art Of War CGA */
 	case 0x5e:					/* More Network Functions */
 	default:
-		LOG(LOG_DOSMISC,LOG_ERROR)("DOS:Unhandled call %02X al=%02X. Set al to default of 0",reg_ah,reg_al);
+		if (reg_ah < 0x6d) LOG(LOG_DOSMISC,LOG_ERROR)("DOS:Unhandled call %02X al=%02X. Set al to default of 0",reg_ah,reg_al); //Less errors. above 0x6c the functions are simply always skipped, only al is zeroed, all other registers untouched
 		reg_al=0x00; /* default value */
 		break;
 	};
@@ -1093,27 +1157,29 @@
 }
 
 static Bitu DOS_25Handler(void) {
-	if(Drives[reg_al]==0){
-		reg_ax=0x8002;
+	if (Drives[reg_al] == 0){
+		reg_ax = 0x8002;
 		SETFLAGBIT(CF,true);
-	}else{
+	} else {
 		SETFLAGBIT(CF,false);
-		if((reg_cx != 1) ||(reg_dx != 1))
+		if ((reg_cx != 1) ||(reg_dx != 1))
 			LOG(LOG_DOSMISC,LOG_NORMAL)("int 25 called but not as diskdetection drive %X",reg_al);
 
-	   reg_ax=0;
+	   reg_ax = 0;
 	}
+	SETFLAGBIT(IF,true);
     return CBRET_NONE;
 }
 static Bitu DOS_26Handler(void) {
 	LOG(LOG_DOSMISC,LOG_NORMAL)("int 26 called: hope for the best!");
-	if(Drives[reg_al]==0){
-		reg_ax=0x8002;
+	if (Drives[reg_al] == 0){
+		reg_ax = 0x8002;
 		SETFLAGBIT(CF,true);
-	}else{
+	} else {
 		SETFLAGBIT(CF,false);
-		reg_ax=0;
+		reg_ax = 0;
 	}
+	SETFLAGBIT(IF,true);
     return CBRET_NONE;
 }
 
@@ -1166,16 +1232,6 @@
 	
 		dos.version.major=5;
 		dos.version.minor=0;
-	
-		/* Setup time and date */
-		time_t curtime;struct tm *loctime;
-		curtime = time (NULL);loctime = localtime (&curtime);
-	
-		dos.date.day=(Bit8u)loctime->tm_mday;
-		dos.date.month=(Bit8u)loctime->tm_mon+1;
-		dos.date.year=(Bit16u)loctime->tm_year+1900;
-		Bit32u ticks=(Bit32u)((loctime->tm_hour*3600+loctime->tm_min*60+loctime->tm_sec)*(float)PIT_TICK_RATE/65536.0);
-		mem_writed(BIOS_TIMER,ticks);
 	}
 	~DOS(){
 		for (Bit16u i=0;i<DOS_DRIVES;i++) delete Drives[i];
diff -Nur dosbox-0.74/src/dos/dos_devices.cpp dosbox-0.74.patch/src/dos/dos_devices.cpp
--- dosbox-0.74/src/dos/dos_devices.cpp	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/dos/dos_devices.cpp	2016-12-11 18:35:15.522284006 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: dos_devices.cpp,v 1.22 2009-05-27 09:15:41 qbix79 Exp $ */ 
 
 #include <string.h>
 #include "dosbox.h"
@@ -61,6 +60,10 @@
 public:
    	device_LPT1() { SetName("LPT1");}
 	Bit16u GetInformation(void) { return 0x80A0; }
+	bool Read(Bit8u* data,Bit16u * size){
+		DOS_SetError(DOSERR_ACCESS_DENIED);
+		return false;
+	}	
 };
 
 bool DOS_Device::Read(Bit8u * data,Bit16u * size) {
@@ -98,6 +101,7 @@
 	attr=orig.attr;
 	refCtr=orig.refCtr;
 	open=orig.open;
+	hdrive=orig.hdrive;
 	name=0;
 	if(orig.name) {
 		name=new char [strlen(orig.name) + 1];strcpy(name,orig.name);
@@ -111,6 +115,7 @@
 	attr=orig.attr;
 	refCtr=orig.refCtr;
 	open=orig.open;
+	hdrive=orig.hdrive;
 	if(name) {
 		delete [] name; name=0;
 	}
diff -Nur dosbox-0.74/src/dos/dos_execute.cpp dosbox-0.74.patch/src/dos/dos_execute.cpp
--- dosbox-0.74/src/dos/dos_execute.cpp	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/dos/dos_execute.cpp	2016-12-11 18:35:15.522284006 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: dos_execute.cpp,v 1.68 2009-10-04 14:28:07 c2woody Exp $ */
 
 #include <string.h>
 #include <ctype.h>
@@ -94,8 +93,13 @@
 	DOS_MCB mcb(dos.psp()-1);
 	static char name[9];
 	mcb.GetFileName(name);
+	name[8] = 0;
 	if (!strlen(name)) strcpy(name,"DOSBOX");
-	RunningProgram=name;
+	for(Bitu i = 0;i < 8;i++) { //Don't put garbage in the title bar. Mac OS X doesn't like it
+		if (name[i] == 0) break;
+		if ( !isprint(*reinterpret_cast<unsigned char*>(&name[i])) ) name[i] = '?';
+	}
+	RunningProgram = name;
 	GFX_SetTitle(-1,-1,false);
 }
 
diff -Nur dosbox-0.74/src/dos/dos_files.cpp dosbox-0.74.patch/src/dos/dos_files.cpp
--- dosbox-0.74/src/dos/dos_files.cpp	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/dos/dos_files.cpp	2016-12-11 18:35:15.522284006 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: dos_files.cpp,v 1.113 2009-08-31 18:03:08 qbix79 Exp $ */
 
 #include <string.h>
 #include <stdlib.h>
@@ -93,7 +92,7 @@
 		case '!':	case '%':	case '{':	case '}':	case '`':	case '~':
 		case '_':	case '-':	case '.':	case '*':	case '?':	case '&':
 		case '\'':	case '+':	case '^':	case 246:	case 255:	case 0xa0:
-		case 0xe5:	case 0xbd:
+		case 0xe5:	case 0xbd:	case 0x9d:
 			upname[w++]=c;
 			break;
 		default:
@@ -203,7 +202,18 @@
 
 bool DOS_ChangeDir(char const * const dir) {
 	Bit8u drive;char fulldir[DOS_PATHLENGTH];
+	const char * testdir=dir;
+	if (strlen(testdir) && testdir[1]==':') testdir+=2;
+	size_t len=strlen(testdir);
+	if (!len) {
+		DOS_SetError(DOSERR_PATH_NOT_FOUND);
+		return false;
+	}
 	if (!DOS_MakeName(dir,fulldir,&drive)) return false;
+	if (strlen(fulldir) && testdir[len-1]=='\\') {
+		DOS_SetError(DOSERR_PATH_NOT_FOUND);
+		return false;
+	}
 	
 	if (Drives[drive]->TestDir(fulldir)) {
 		strcpy(Drives[drive]->curdir,fulldir);
@@ -289,7 +299,7 @@
 	}
 
 	if (Drives[drivenew]->Rename(fullold,fullnew)) return true;
-	/* If it still fails. which error should we give ? PATH NOT FOUND or EACCESS */
+	/* If it still fails, which error should we give ? PATH NOT FOUND or EACCESS */
 	LOG(LOG_FILES,LOG_NORMAL)("Rename fails for %s to %s, no proper errorcode returned.",oldname,newname);
 	DOS_SetError(DOSERR_FILE_NOT_FOUND);
 	return false;
@@ -880,7 +890,7 @@
 
 static void DTAExtendName(char * const name,char * const filename,char * const ext) {
 	char * find=strchr(name,'.');
-	if (find) {
+	if (find && find!=name) {
 		strcpy(ext,find+1);
 		*find=0;
 	} else ext[0]=0;
@@ -898,12 +908,15 @@
 	char file_name[9];char ext[4];
 	find_dta.GetResult(name,size,date,time,attr);
 	drive=find_fcb.GetDrive()+1;
+	Bit8u find_attr = DOS_ATTR_ARCHIVE;
+	find_fcb.GetAttr(find_attr); /* Gets search attributes if extended */
 	/* Create a correct file and extention */
 	DTAExtendName(name,file_name,ext);	
 	DOS_FCB fcb(RealSeg(dos.dta()),RealOff(dos.dta()));//TODO
 	fcb.Create(find_fcb.Extended());
 	fcb.SetName(drive,file_name,ext);
-	fcb.SetAttr(attr);      /* Only adds attribute if fcb is extended */
+	fcb.SetAttr(find_attr);      /* Only adds attribute if fcb is extended */
+	fcb.SetResultAttr(attr);
 	fcb.SetSizeDateTime(size,date,time);
 }
 
@@ -911,7 +924,10 @@
 	DOS_FCB fcb(seg,offset);
 	char shortname[DOS_FCBNAME];Bit16u handle;
 	fcb.GetName(shortname);
-	if (!DOS_CreateFile(shortname,DOS_ATTR_ARCHIVE,&handle)) return false;
+	Bit8u attr = DOS_ATTR_ARCHIVE;
+	fcb.GetAttr(attr);
+	if (!attr) attr = DOS_ATTR_ARCHIVE; //Better safe than sorry 
+	if (!DOS_CreateFile(shortname,attr,&handle)) return false;
 	fcb.FileOpen((Bit8u)handle);
 	return true;
 }
@@ -980,6 +996,11 @@
 	DOS_FCB fcb(seg,offset);
 	Bit8u fhandle,cur_rec;Bit16u cur_block,rec_size;
 	fcb.GetSeqData(fhandle,rec_size);
+	if (fhandle==0xff && rec_size!=0) {
+		if (!DOS_FCBOpen(seg,offset)) return FCB_READ_NODATA;
+		LOG(LOG_FCB,LOG_WARN)("Reopened closed FCB");
+		fcb.GetSeqData(fhandle,rec_size);
+	}
 	fcb.GetRecord(cur_block,cur_rec);
 	Bit32u pos=((cur_block*128)+cur_rec)*rec_size;
 	if (!DOS_SeekFile(fhandle,&pos,DOS_SEEK_SET)) return FCB_READ_NODATA; 
@@ -1002,6 +1023,11 @@
 	DOS_FCB fcb(seg,offset);
 	Bit8u fhandle,cur_rec;Bit16u cur_block,rec_size;
 	fcb.GetSeqData(fhandle,rec_size);
+	if (fhandle==0xff && rec_size!=0) {
+		if (!DOS_FCBOpen(seg,offset)) return FCB_READ_NODATA;
+		LOG(LOG_FCB,LOG_WARN)("Reopened closed FCB");
+		fcb.GetSeqData(fhandle,rec_size);
+	}
 	fcb.GetRecord(cur_block,cur_rec);
 	Bit32u pos=((cur_block*128)+cur_rec)*rec_size;
 	if (!DOS_SeekFile(fhandle,&pos,DOS_SEEK_SET)) return FCB_ERR_WRITE; 
@@ -1056,32 +1082,30 @@
 	return FCB_SUCCESS;
 }
 
-Bit8u DOS_FCBRandomRead(Bit16u seg,Bit16u offset,Bit16u numRec,bool restore) {
+Bit8u DOS_FCBRandomRead(Bit16u seg,Bit16u offset,Bit16u * numRec,bool restore) {
 /* if restore is true :random read else random blok read. 
  * random read updates old block and old record to reflect the random data
  * before the read!!!!!!!!! and the random data is not updated! (user must do this)
  * Random block read updates these fields to reflect the state after the read!
  */
-
-/* BUG: numRec should return the amount of records read! 
- * Not implemented yet as I'm unsure how to count on error states (partial/failed) 
- */
-
 	DOS_FCB fcb(seg,offset);
 	Bit32u random;
 	Bit16u old_block=0;
 	Bit8u old_rec=0;
 	Bit8u error=0;
+	Bit16u count;
 
 	/* Set the correct record from the random data */
 	fcb.GetRandom(random);
 	fcb.SetRecord((Bit16u)(random / 128),(Bit8u)(random & 127));
 	if (restore) fcb.GetRecord(old_block,old_rec);//store this for after the read.
 	// Read records
-	for (int i=0; i<numRec; i++) {
-		error = DOS_FCBRead(seg,offset,(Bit16u)i);
-		if (error!=0x00) break;
+	for (count=0; count<*numRec; count++) {
+		error = DOS_FCBRead(seg,offset,count);
+		if (error!=FCB_SUCCESS) break;
 	}
+	if (error==FCB_READ_PARTIAL) count++;	//partial read counts
+	*numRec=count;
 	Bit16u new_block;Bit8u new_rec;
 	fcb.GetRecord(new_block,new_rec);
 	if (restore) fcb.SetRecord(old_block,old_rec);
@@ -1090,24 +1114,26 @@
 	return error;
 }
 
-Bit8u DOS_FCBRandomWrite(Bit16u seg,Bit16u offset,Bit16u numRec,bool restore) {
+Bit8u DOS_FCBRandomWrite(Bit16u seg,Bit16u offset,Bit16u * numRec,bool restore) {
 /* see FCB_RandomRead */
 	DOS_FCB fcb(seg,offset);
 	Bit32u random;
 	Bit16u old_block=0;
 	Bit8u old_rec=0;
 	Bit8u error=0;
+	Bit16u count;
 
 	/* Set the correct record from the random data */
 	fcb.GetRandom(random);
 	fcb.SetRecord((Bit16u)(random / 128),(Bit8u)(random & 127));
 	if (restore) fcb.GetRecord(old_block,old_rec);
-	if (numRec>0) {
+	if (*numRec > 0) {
 		/* Write records */
-		for (int i=0; i<numRec; i++) {
-			error = DOS_FCBWrite(seg,offset,(Bit16u)i);// dos_fcbwrite return 0 false when true...
-			if (error!=0x00) break;
+		for (count=0; count<*numRec; count++) {
+			error = DOS_FCBWrite(seg,offset,count);// dos_fcbwrite return 0 false when true...
+			if (error!=FCB_SUCCESS) break;
 		}
+		*numRec=count;
 	} else {
 		DOS_FCBIncreaseSize(seg,offset);
 	}
@@ -1115,7 +1141,7 @@
 	fcb.GetRecord(new_block,new_rec);
 	if (restore) fcb.SetRecord(old_block,old_rec);
 	/* Update the random record pointer with new position only when restore is false */
-	if(!restore) fcb.SetRandom(new_block*128+new_rec); 
+	if (!restore) fcb.SetRandom(new_block*128+new_rec); 
 	return error;
 }
 
@@ -1141,10 +1167,11 @@
  * stored. This can not be the tempdta as that one is used by fcbfindfirst
  */
 	RealPt old_dta=dos.dta();dos.dta(dos.tables.tempdta_fcbdelete);
-	DOS_FCB fcb(RealSeg(dos.dta()),RealOff(dos.dta()));
+	RealPt new_dta=dos.dta();
 	bool nextfile = false;
 	bool return_value = false;
 	nextfile = DOS_FCBFindFirst(seg,offset);
+	DOS_FCB fcb(RealSeg(new_dta),RealOff(new_dta));
 	while(nextfile) {
 		char shortname[DOS_FCBNAME] = { 0 };
 		fcb.GetName(shortname);
@@ -1159,9 +1186,29 @@
 bool DOS_FCBRenameFile(Bit16u seg, Bit16u offset){
 	DOS_FCB fcbold(seg,offset);
 	DOS_FCB fcbnew(seg,offset+16);
+	if(!fcbold.Valid()) return false;
 	char oldname[DOS_FCBNAME];
 	char newname[DOS_FCBNAME];
 	fcbold.GetName(oldname);fcbnew.GetName(newname);
+
+	/* Check, if sourcefile is still open. This was possible in DOS, but modern oses don't like this */
+	Bit8u drive; char fullname[DOS_PATHLENGTH];
+	if (!DOS_MakeName(oldname,fullname,&drive)) return false;
+	
+	DOS_PSP psp(dos.psp());
+	for (Bit8u i=0;i<DOS_FILES;i++) {
+		if (Files[i] && Files[i]->IsOpen() && Files[i]->IsName(fullname)) {
+			Bit16u handle = psp.FindEntryByHandle(i);
+			if (handle == 0xFF) {
+				// This shouldnt happen
+				LOG(LOG_FILES,LOG_ERROR)("DOS: File %s is opened but has no psp entry.",oldname);
+				return false;
+			}
+			DOS_CloseFile(handle);
+		}
+	}
+
+	/* Rename the file */
 	return DOS_Rename(oldname,newname);
 }
 
@@ -1182,7 +1229,10 @@
 bool DOS_GetAllocationInfo(Bit8u drive,Bit16u * _bytes_sector,Bit8u * _sectors_cluster,Bit16u * _total_clusters) {
 	if (!drive) drive =  DOS_GetDefaultDrive();
 	else drive--;
-	if (drive >= DOS_DRIVES || !Drives[drive]) return false;
+	if (drive >= DOS_DRIVES || !Drives[drive]) {
+		DOS_SetError(DOSERR_INVALID_DRIVE);
+		return false;
+	}
 	Bit16u _free_clusters;
 	Drives[drive]->AllocationInfo(_bytes_sector,_sectors_cluster,_total_clusters,&_free_clusters);
 	SegSet16(ds,RealSeg(dos.tables.mediaid));
diff -Nur dosbox-0.74/src/dos/dos_ioctl.cpp dosbox-0.74.patch/src/dos/dos_ioctl.cpp
--- dosbox-0.74/src/dos/dos_ioctl.cpp	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/dos/dos_ioctl.cpp	2016-12-11 18:35:15.522284006 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: dos_ioctl.cpp,v 1.35 2009-04-16 12:16:52 qbix79 Exp $ */
 
 #include <string.h>
 #include "dosbox.h"
@@ -41,7 +40,7 @@
 	} else if (reg_al<0x12) { 				/* those use a diskdrive except 0x0b */
 		if (reg_al!=0x0b) {
 			drive=reg_bl;if (!drive) drive = DOS_GetDefaultDrive();else drive--;
-			if( !(( drive < DOS_DRIVES ) && Drives[drive]) ) {
+			if( (drive >= 2) && !(( drive < DOS_DRIVES ) && Drives[drive]) ) {
 				DOS_SetError(DOSERR_INVALID_DRIVE);
 				return false;
 			}
@@ -134,7 +133,7 @@
 		}
 		return true;
 	case 0x09:		/* Check if block device remote */
-		if (Drives[drive]->isRemote()) {
+		if ((drive >= 2) && Drives[drive]->isRemote()) {
 			reg_dx=0x1000;	// device is remote
 			// undocumented bits always clear
 		} else {
@@ -152,7 +151,7 @@
 		return true;
 	case 0x0D:		/* Generic block device request */
 		{
-			if (Drives[drive]->isRemovable()) {
+			if ((drive < 2) || Drives[drive]->isRemovable()) {
 				DOS_SetError(DOSERR_FUNCTION_NUMBER_INVALID);
 				return false;
 			}
@@ -203,11 +202,14 @@
 			return true;
 		}
 	case 0x0E:			/* Get Logical Drive Map */
-		if (Drives[drive]->isRemovable()) {
+		if (drive < 2) {
+			if (Drives[drive]) reg_al=drive+1;
+			else reg_al=1;
+		} else if (Drives[drive]->isRemovable()) {
 			DOS_SetError(DOSERR_FUNCTION_NUMBER_INVALID);
 			return false;
-		}
-		reg_al = 0;		/* Only 1 logical drive assigned */
+		} else reg_al=0;	/* Only 1 logical drive assigned */
+		reg_ah=0x07;
 		return true;
 	default:
 		LOG(LOG_DOSMISC,LOG_ERROR)("DOS:IOCTL Call %2X unhandled",reg_al);
diff -Nur dosbox-0.74/src/dos/dos_keyboard_layout.cpp dosbox-0.74.patch/src/dos/dos_keyboard_layout.cpp
--- dosbox-0.74/src/dos/dos_keyboard_layout.cpp	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/dos/dos_keyboard_layout.cpp	2016-12-11 18:35:15.522284006 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: dos_keyboard_layout.cpp,v 1.22 2009-09-06 19:25:33 c2woody Exp $ */
 
 #include "dosbox.h"
 #include "bios.h"
@@ -443,7 +442,14 @@
 					}
 				}
 
-				current_layout[scan*layout_pages+layout_pages-1]=read_buf[read_buf_pos-2];	// flags
+				// calculate max length of entries, taking into account old number of entries
+				Bit8u new_flags=current_layout[scan*layout_pages+layout_pages-1]&0x7;
+				if ((read_buf[read_buf_pos-2]&0x7) > new_flags) new_flags = read_buf[read_buf_pos-2]&0x7;
+
+				// merge flag bits in as well
+				new_flags |= (read_buf[read_buf_pos-2] | current_layout[scan*layout_pages+layout_pages-1]) & 0xf0;
+
+				current_layout[scan*layout_pages+layout_pages-1]=new_flags;
 				if (read_buf[read_buf_pos-2]&0x80) scan_length*=2;		// granularity flag (S)
 			}
 			i+=scan_length;		// advance pointer
diff -Nur dosbox-0.74/src/dos/dos_memory.cpp dosbox-0.74.patch/src/dos/dos_memory.cpp
--- dosbox-0.74/src/dos/dos_memory.cpp	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/dos/dos_memory.cpp	2016-12-11 18:35:15.522284006 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: dos_memory.cpp,v 1.45 2009-07-15 17:05:07 c2woody Exp $ */
 
 #include "dosbox.h"
 #include "mem.h"
@@ -436,7 +435,7 @@
 	if (machine==MCH_TANDY) {
 		/* memory up to 608k available, the rest (to 640k) is used by
 			the tandy graphics system's variable mapping of 0xb800 */
-		mcb.SetSize(0x97FF - DOS_MEM_START - mcb_sizes);
+		mcb.SetSize(0x9BFF - DOS_MEM_START - mcb_sizes);
 	} else if (machine==MCH_PCJR) {
 		/* memory from 128k to 640k is available */
 		mcb_devicedummy.SetPt((Bit16u)0x2000);
diff -Nur dosbox-0.74/src/dos/dos_misc.cpp dosbox-0.74.patch/src/dos/dos_misc.cpp
--- dosbox-0.74/src/dos/dos_misc.cpp	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/dos/dos_misc.cpp	2016-12-11 18:35:15.522284006 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: dos_misc.cpp,v 1.24 2009-09-25 20:51:21 qbix79 Exp $ */
 
 #include "dosbox.h"
 #include "callback.h"
diff -Nur dosbox-0.74/src/dos/dos_mscdex.cpp dosbox-0.74.patch/src/dos/dos_mscdex.cpp
--- dosbox-0.74/src/dos/dos_mscdex.cpp	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/dos/dos_mscdex.cpp	2016-12-11 18:35:15.522284006 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: dos_mscdex.cpp,v 1.59 2009-04-16 12:28:30 qbix79 Exp $ */
 
 #include <string.h>
 #include <ctype.h>
@@ -152,6 +151,7 @@
 		bool	locked;			// drive locked ?
 		bool	lastResult;		// last operation success ?
 		Bit32u	volumeSize;		// for media change
+		TCtrl	audioCtrl;		// audio channel control
 	} TDriveInfo;
 
 	Bit16u				defaultBufSeg;
@@ -160,6 +160,9 @@
 	
 public:
 	Bit16u		rootDriverHeaderSeg;
+
+	bool		ChannelControl		(Bit8u subUnit, TCtrl ctrl);
+	bool		GetChannelControl	(Bit8u subUnit, TCtrl& ctrl);
 };
 
 CMscdex::CMscdex(void) {
@@ -368,25 +371,34 @@
 		devHeader.SetInterrupt(off+5);
 	}
 
-	subUnit = (Bit8u)numDrives;
 	// Set drive
 	DOS_DeviceHeader devHeader(PhysMake(rootDriverHeaderSeg,0));
 	devHeader.SetNumSubUnits(devHeader.GetNumSubUnits()+1);
 
 	if (dinfo[0].drive-1==_drive) {
 		CDROM_Interface *_cdrom = cdrom[numDrives];
+		CDROM_Interface_Image *_cdimg = CDROM_Interface_Image::images[numDrives];
 		for (Bit16u i=GetNumDrives(); i>0; i--) {
 			dinfo[i] = dinfo[i-1];
 			cdrom[i] = cdrom[i-1];
+			CDROM_Interface_Image::images[i] = CDROM_Interface_Image::images[i-1];
 		}
 		cdrom[0] = _cdrom;
+		CDROM_Interface_Image::images[0] = _cdimg;
 		dinfo[0].drive		= (Bit8u)_drive;
 		dinfo[0].physDrive	= (Bit8u)toupper(physicalPath[0]);
+		subUnit = 0;
 	} else {
 		dinfo[numDrives].drive		= (Bit8u)_drive;
 		dinfo[numDrives].physDrive	= (Bit8u)toupper(physicalPath[0]);
+		subUnit = (Bit8u)numDrives;
 	}
 	numDrives++;
+	// init channel control
+	for (Bit8u chan=0;chan<4;chan++) {
+		dinfo[subUnit].audioCtrl.out[chan]=chan;
+		dinfo[subUnit].audioCtrl.vol[chan]=0xff;
+	}
 	// stop audio
 	StopAudio(subUnit);
 	return result;
@@ -426,8 +438,7 @@
 	};
 }
 
-bool CMscdex::GetCDInfo(Bit8u subUnit, Bit8u& tr1, Bit8u& tr2, TMSF& leadOut)
-{
+bool CMscdex::GetCDInfo(Bit8u subUnit, Bit8u& tr1, Bit8u& tr2, TMSF& leadOut) {
 	if (subUnit>=numDrives) return false;
 	int tr1i,tr2i;
 	// Assume Media change
@@ -443,23 +454,21 @@
 	return dinfo[subUnit].lastResult;
 }
 
-bool CMscdex::GetTrackInfo(Bit8u subUnit, Bit8u track, Bit8u& attr, TMSF& start)
-{
+bool CMscdex::GetTrackInfo(Bit8u subUnit, Bit8u track, Bit8u& attr, TMSF& start) {
 	if (subUnit>=numDrives) return false;
 	dinfo[subUnit].lastResult = cdrom[subUnit]->GetAudioTrackInfo(track,start,attr);	
 	if (!dinfo[subUnit].lastResult) {
 		attr = 0;
 		memset(&start,0,sizeof(start));
-	};
+	}
 	return dinfo[subUnit].lastResult;
 }
 
-bool CMscdex::PlayAudioSector(Bit8u subUnit, Bit32u sector, Bit32u length)
-{
+bool CMscdex::PlayAudioSector(Bit8u subUnit, Bit32u sector, Bit32u length) {
 	if (subUnit>=numDrives) return false;
 	// If value from last stop is used, this is meant as a resume
 	// better start using resume command
-	if (dinfo[subUnit].audioPaused && (sector==dinfo[subUnit].audioStart)) {
+	if (dinfo[subUnit].audioPaused && (sector==dinfo[subUnit].audioStart) && (dinfo[subUnit].audioEnd!=0)) {
 		dinfo[subUnit].lastResult = cdrom[subUnit]->PauseAudio(true);
 	} else 
 		dinfo[subUnit].lastResult = cdrom[subUnit]->PlayAudioSector(sector,length);
@@ -469,12 +478,11 @@
 		dinfo[subUnit].audioPaused	= false;
 		dinfo[subUnit].audioStart	= sector;
 		dinfo[subUnit].audioEnd		= length;
-	};
+	}
 	return dinfo[subUnit].lastResult;
 }
 
-bool CMscdex::PlayAudioMSF(Bit8u subUnit, Bit32u start, Bit32u length)
-{
+bool CMscdex::PlayAudioMSF(Bit8u subUnit, Bit32u start, Bit32u length) {
 	if (subUnit>=numDrives) return false;
 	Bit8u min		= (Bit8u)(start>>16) & 0xFF;
 	Bit8u sec		= (Bit8u)(start>> 8) & 0xFF;
@@ -483,48 +491,61 @@
 	return dinfo[subUnit].lastResult = PlayAudioSector(subUnit,sector,length);
 }
 
-bool CMscdex::GetSubChannelData(Bit8u subUnit, Bit8u& attr, Bit8u& track, Bit8u &index, TMSF& rel, TMSF& abs)
-{
+bool CMscdex::GetSubChannelData(Bit8u subUnit, Bit8u& attr, Bit8u& track, Bit8u &index, TMSF& rel, TMSF& abs) {
 	if (subUnit>=numDrives) return false;
 	dinfo[subUnit].lastResult = cdrom[subUnit]->GetAudioSub(attr,track,index,rel,abs);
 	if (!dinfo[subUnit].lastResult) {
 		attr = track = index = 0;
 		memset(&rel,0,sizeof(rel));
 		memset(&abs,0,sizeof(abs));
-	};
+	}
 	return dinfo[subUnit].lastResult;
 }
 
-bool CMscdex::GetAudioStatus(Bit8u subUnit, bool& playing, bool& pause, TMSF& start, TMSF& end)
-{
+bool CMscdex::GetAudioStatus(Bit8u subUnit, bool& playing, bool& pause, TMSF& start, TMSF& end) {
 	if (subUnit>=numDrives) return false;
 	dinfo[subUnit].lastResult = cdrom[subUnit]->GetAudioStatus(playing,pause);
 	if (dinfo[subUnit].lastResult) {
-		// Start
-		Bit32u addr	= dinfo[subUnit].audioStart + 150;
-		start.fr	= (Bit8u)(addr%75);	addr/=75;
-		start.sec	= (Bit8u)(addr%60); 
-		start.min	= (Bit8u)(addr/60);
-		// End
-		addr		= dinfo[subUnit].audioEnd + 150;
-		end.fr		= (Bit8u)(addr%75);	addr/=75;
-		end.sec		= (Bit8u)(addr%60); 
-		end.min		= (Bit8u)(addr/60);
+		if (playing) {
+			// Start
+			Bit32u addr	= dinfo[subUnit].audioStart + 150;
+			start.fr	= (Bit8u)(addr%75);	addr/=75;
+			start.sec	= (Bit8u)(addr%60); 
+			start.min	= (Bit8u)(addr/60);
+			// End
+			addr		= dinfo[subUnit].audioEnd + 150;
+			end.fr		= (Bit8u)(addr%75);	addr/=75;
+			end.sec		= (Bit8u)(addr%60); 
+			end.min		= (Bit8u)(addr/60);
+		} else {
+			memset(&start,0,sizeof(start));
+			memset(&end,0,sizeof(end));
+		}
 	} else {
 		playing		= false;
 		pause		= false;
 		memset(&start,0,sizeof(start));
 		memset(&end,0,sizeof(end));
-	};
+	}
 	
 	return dinfo[subUnit].lastResult;
 }
 
-bool CMscdex::StopAudio(Bit8u subUnit)
-{
+bool CMscdex::StopAudio(Bit8u subUnit) {
 	if (subUnit>=numDrives) return false;
-	if (dinfo[subUnit].audioPlay)	dinfo[subUnit].lastResult = cdrom[subUnit]->PauseAudio(false);
-	else							dinfo[subUnit].lastResult = cdrom[subUnit]->StopAudio();
+	if (dinfo[subUnit].audioPlay) {
+		// Check if audio is still playing....
+		TMSF start,end;
+		bool playing,pause;
+		if (GetAudioStatus(subUnit,playing,pause,start,end))
+			dinfo[subUnit].audioPlay = playing;
+		else
+			dinfo[subUnit].audioPlay = false;
+	}
+	if (dinfo[subUnit].audioPlay)
+		dinfo[subUnit].lastResult = cdrom[subUnit]->PauseAudio(false);
+	else
+		dinfo[subUnit].lastResult = cdrom[subUnit]->StopAudio();
 	
 	if (dinfo[subUnit].lastResult) {
 		if (dinfo[subUnit].audioPlay) {
@@ -536,9 +557,9 @@
 			dinfo[subUnit].audioPaused  = false;
 			dinfo[subUnit].audioStart	= 0;
 			dinfo[subUnit].audioEnd		= 0;
-		};
+		}
 		dinfo[subUnit].audioPlay = false;
-	};
+	}
 	return dinfo[subUnit].lastResult;
 }
 
@@ -600,8 +621,13 @@
 	PhysPt ptoc = GetTempBuffer();
 	success = ReadVTOC(drive,0x00,ptoc,error);
 	if (success) {
-		MEM_BlockCopy(data,ptoc+702,37);
-		mem_writeb(data+37,0);
+		Bitu len;
+		for (len=0;len<37;len++) {
+			Bit8u c=mem_readb(ptoc+702+len);
+			if (c==0 || c==0x20) break;
+		}
+		MEM_BlockCopy(data,ptoc+702,len);
+		mem_writeb(data+len,0);
 	};
 	return success; 
 }
@@ -612,8 +638,13 @@
 	PhysPt ptoc = GetTempBuffer();
 	success = ReadVTOC(drive,0x00,ptoc,error);
 	if (success) {
-		MEM_BlockCopy(data,ptoc+739,37);
-		mem_writeb(data+37,0);
+		Bitu len;
+		for (len=0;len<37;len++) {
+			Bit8u c=mem_readb(ptoc+739+len);
+			if (c==0 || c==0x20) break;
+		}
+		MEM_BlockCopy(data,ptoc+739,len);
+		mem_writeb(data+len,0);
 	};
 	return success; 
 }
@@ -624,8 +655,13 @@
 	PhysPt ptoc = GetTempBuffer();
 	success = ReadVTOC(drive,0x00,ptoc,error);
 	if (success) {
-		MEM_BlockCopy(data,ptoc+776,37);
-		mem_writeb(data+37,0);
+		Bitu len;
+		for (len=0;len<37;len++) {
+			Bit8u c=mem_readb(ptoc+776+len);
+			if (c==0 || c==0x20) break;
+		}
+		MEM_BlockCopy(data,ptoc+776,len);
+		mem_writeb(data+len,0);
 	};
 	return success; 
 }
@@ -658,13 +694,13 @@
 	return ReadSectors(GetSubUnit(drive),false,sector,num,data);
 }
 
-bool CMscdex::GetDirectoryEntry(Bit16u drive, bool copyFlag, PhysPt pathname, PhysPt buffer, Bit16u& error)
-{
+bool CMscdex::GetDirectoryEntry(Bit16u drive, bool copyFlag, PhysPt pathname, PhysPt buffer, Bit16u& error) {
 	char	volumeID[6] = {0};
 	char	searchName[256];
 	char	entryName[256];
 	bool	foundComplete = false;
 	bool	foundName;
+	bool	nextPart = true;
 	char*	useName = 0;
 	Bitu	entryLength,nameLength;
 	// clear error
@@ -695,14 +731,15 @@
 		if (!ReadSectors(GetSubUnit(drive),false,dirEntrySector,1,defBuffer)) return false;
 		// Get string part
 		foundName	= false;
-		if (searchPos) { 
-			useName = searchPos; 
-			searchPos = strchr(searchPos,'\\'); 
+		if (nextPart) {
+			if (searchPos) { 
+				useName = searchPos; 
+				searchPos = strchr(searchPos,'\\'); 
+			}
+			if (searchPos) { *searchPos = 0; searchPos++; }
+			else foundComplete = true;
 		}
 
-	   	if (searchPos) { *searchPos = 0; searchPos++; }
-		else foundComplete = true;
-
 		do {
 			entryLength = mem_readb(defBuffer+index);
 			if (entryLength==0) break;
@@ -759,18 +796,19 @@
 			// change directory
 			dirEntrySector = mem_readd(defBuffer+index+2);
 			dirSize	= mem_readd(defBuffer+index+10);
+			nextPart = true;
 		} else {
 			// continue search in next sector
 			dirSize -= 2048;
 			dirEntrySector++;
+			nextPart = false;
 		}
-	};
+	}
 	error = 2; // file not found
 	return false; // not found
 }
 
-bool CMscdex::GetCurrentPos(Bit8u subUnit, TMSF& pos)
-{
+bool CMscdex::GetCurrentPos(Bit8u subUnit, TMSF& pos) {
 	if (subUnit>=numDrives) return false;
 	TMSF rel;
 	Bit8u attr,track,index;
@@ -779,30 +817,39 @@
 	return dinfo[subUnit].lastResult;
 }
 
-bool CMscdex::GetMediaStatus(Bit8u subUnit, bool& media, bool& changed, bool& trayOpen)
-{
+bool CMscdex::GetMediaStatus(Bit8u subUnit, bool& media, bool& changed, bool& trayOpen) {
 	if (subUnit>=numDrives) return false;
 	dinfo[subUnit].lastResult = cdrom[subUnit]->GetMediaTrayStatus(media,changed,trayOpen);
 	return dinfo[subUnit].lastResult;
 }
 
-Bit32u CMscdex::GetDeviceStatus(Bit8u subUnit)
-{
+Bit32u CMscdex::GetDeviceStatus(Bit8u subUnit) {
 	if (subUnit>=numDrives) return false;
 	bool media,changed,trayOpen;
 
 	dinfo[subUnit].lastResult = GetMediaStatus(subUnit,media,changed,trayOpen);
-	Bit32u status = (trayOpen << 0)					|	// Drive is open ?
-					(dinfo[subUnit].locked	<< 1)	|	// Drive is locked ?
-					(1<<2)							|	// raw + cooked sectors
-					(1<<4)							|	// Can read sudio
-					(1<<9)							|	// Red book & HSG
-					((!media) << 11);					// Drive is empty ?
+	if (dinfo[subUnit].audioPlay) {
+		// Check if audio is still playing....
+		TMSF start,end;
+		bool playing,pause;
+		if (GetAudioStatus(subUnit,playing,pause,start,end))
+			dinfo[subUnit].audioPlay = playing;
+		else
+			dinfo[subUnit].audioPlay = false;
+	}
+
+	Bit32u status = ((trayOpen?1:0) << 0)					|	// Drive is open ?
+					((dinfo[subUnit].locked?1:0) << 1)		|	// Drive is locked ?
+					(1<<2)									|	// raw + cooked sectors
+					(1<<4)									|	// Can read sudio
+					(1<<8)									|	// Can control audio
+					(1<<9)									|	// Red book & HSG
+					((dinfo[subUnit].audioPlay?1:0) << 10)	|	// Audio is playing ?
+					((media?0:1) << 11);						// Drive is empty ?
 	return status;
 }
 
-bool CMscdex::GetMediaStatus(Bit8u subUnit, Bit8u& status)
-{
+bool CMscdex::GetMediaStatus(Bit8u subUnit, Bit8u& status) {
 	if (subUnit>=numDrives) return false;
 /*	bool media,changed,open,result;
 	result = GetMediaStatus(subUnit,media,changed,open);
@@ -812,15 +859,13 @@
 	return true;
 }
 
-bool CMscdex::LoadUnloadMedia(Bit8u subUnit, bool unload)
-{
+bool CMscdex::LoadUnloadMedia(Bit8u subUnit, bool unload) {
 	if (subUnit>=numDrives) return false;
 	dinfo[subUnit].lastResult = cdrom[subUnit]->LoadUnloadMedia(unload);
 	return dinfo[subUnit].lastResult;
 }
 
-bool CMscdex::SendDriverRequest(Bit16u drive, PhysPt data)
-{
+bool CMscdex::SendDriverRequest(Bit16u drive, PhysPt data) {
 	Bit8u subUnit = GetSubUnit(drive);
 	if (subUnit>=numDrives) return false;
 	// Get SubUnit
@@ -831,8 +876,7 @@
 	return true;
 }
 
-Bit16u CMscdex::GetStatusWord(Bit8u subUnit,Bit16u status)
-{
+Bit16u CMscdex::GetStatusWord(Bit8u subUnit,Bit16u status) {
 	if (subUnit>=numDrives) return REQUEST_STATUS_ERROR | 0x02; // error : Drive not ready
 
 	if (dinfo[subUnit].lastResult)	status |= REQUEST_STATUS_DONE;				// ok
@@ -860,6 +904,22 @@
 	}
 }
 
+bool CMscdex::ChannelControl(Bit8u subUnit, TCtrl ctrl) {
+	if (subUnit>=numDrives) return false;
+	// adjust strange channel mapping
+	if (ctrl.out[0]>1) ctrl.out[0]=0;
+	if (ctrl.out[1]>1) ctrl.out[1]=1;
+	dinfo[subUnit].audioCtrl=ctrl;
+	cdrom[subUnit]->ChannelControl(ctrl);
+	return true;
+}
+
+bool CMscdex::GetChannelControl(Bit8u subUnit, TCtrl& ctrl) {
+	if (subUnit>=numDrives) return false;
+	ctrl=dinfo[subUnit].audioCtrl;
+	return true;
+}
+
 static CMscdex* mscdex = 0;
 static PhysPt curReqheaderPtr = 0;
 
@@ -889,6 +949,14 @@
 						return 0x03;		// invalid function
 					}
 				   }break;
+		case 0x04 : /* Audio Channel control */
+					TCtrl ctrl;
+					if (!mscdex->GetChannelControl(drive_unit,ctrl)) return 0x01;
+					for (Bit8u chan=0;chan<4;chan++) {
+						mem_writeb(buffer+chan*2+1,ctrl.out[chan]);
+						mem_writeb(buffer+chan*2+2,ctrl.vol[chan]);
+					}
+					break;
 		case 0x06 : /* Get Device status */
 					mem_writed(buffer+1,mscdex->GetDeviceStatus(drive_unit)); 
 					break;
@@ -980,7 +1048,13 @@
 					if (!mscdex->LoadUnloadMedia(drive_unit,true)) return 0x02;
 					break;
 		case 0x03: //Audio Channel control
-					MSCDEX_LOG("MSCDEX: Audio Channel Control used. Not handled. Faking succes!");
+					TCtrl ctrl;
+					for (Bit8u chan=0;chan<4;chan++) {
+						ctrl.out[chan]=mem_readb(buffer+chan*2+1);
+						ctrl.vol[chan]=mem_readb(buffer+chan*2+2);
+					}
+					if (!mscdex->ChannelControl(drive_unit,ctrl)) return 0x01;
+					break;
 		case 0x01 : // (un)Lock door 
 					// do nothing -> report as success
 					break;
@@ -990,6 +1064,7 @@
 					break;
 		case 0x05 :	// load media
 					if (!mscdex->LoadUnloadMedia(drive_unit,false)) return 0x02;
+					break;
 		default	:	LOG(LOG_MISC,LOG_ERROR)("MSCDEX: Unsupported IOCTL OUTPUT Subfunction %02X",ioctl_fct);
 					return 0x03;	// invalid function
 	}
diff -Nur dosbox-0.74/src/dos/dos_programs.cpp dosbox-0.74.patch/src/dos/dos_programs.cpp
--- dosbox-0.74/src/dos/dos_programs.cpp	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/dos/dos_programs.cpp	2016-12-11 18:35:15.526284006 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: dos_programs.cpp,v 1.94 2009-06-12 20:10:09 c2woody Exp $ */
 
 #include "dosbox.h"
 #include <stdlib.h>
@@ -34,6 +33,7 @@
 #include "dos_system.h"
 #include "dos_inc.h"
 #include "bios.h"
+#include "bios_disk.h" 
 #include "setup.h"
 #include "control.h"
 
@@ -49,27 +49,55 @@
 #endif
 
 void MSCDEX_SetCDInterface(int intNr, int forceCD);
-
+static Bitu ZDRIVE_NUM = 25;
 
 class MOUNT : public Program {
 public:
-	void Run(void)
-	{
+	void ListMounts(void) {
+		char name[DOS_NAMELENGTH_ASCII];Bit32u size;Bit16u date;Bit16u time;Bit8u attr;
+		/* Command uses dta so set it to our internal dta */
+		RealPt save_dta = dos.dta();
+		dos.dta(dos.tables.tempdta);
+		DOS_DTA dta(dos.dta());
+
+		WriteOut(MSG_Get("PROGRAM_MOUNT_STATUS_1"));
+		WriteOut(MSG_Get("PROGRAM_MOUNT_STATUS_FORMAT"),"Drive","Type","Label");
+		for(int p = 0;p < 8;p++) WriteOut("----------");
+
+		for (int d = 0;d < DOS_DRIVES;d++) {
+			if (!Drives[d]) continue;
+
+			char root[4] = {'A'+d,':','\\',0};
+			bool ret = DOS_FindFirst(root,DOS_ATTR_VOLUME);
+			if (ret) {
+				dta.GetResult(name,size,date,time,attr);
+				DOS_FindNext(); //Mark entry as invalid
+			} else name[0] = 0;
+
+			/* Change 8.3 to 11.0 */
+			char* dot = strchr(name,'.');
+			if(dot && (dot - name == 8) ) { 
+				name[8] = name[9];name[9] = name[10];name[10] = name[11];name[11] = 0;
+			}
+
+			root[1] = 0; //This way, the format string can be reused.
+			WriteOut(MSG_Get("PROGRAM_MOUNT_STATUS_FORMAT"),root, Drives[d]->GetInfo(),name);		
+		}
+		dos.dta(save_dta);
+	}
+
+	void Run(void) {
 		DOS_Drive * newdrive;char drive;
 		std::string label;
 		std::string umount;
+		std::string newz;
 
 		//Hack To allow long commandlines
 		ChangeToLongCmd();
 		/* Parse the command line */
 		/* if the command line is empty show current mounts */
 		if (!cmd->GetCount()) {
-			WriteOut(MSG_Get("PROGRAM_MOUNT_STATUS_1"));
-			for (int d=0;d<DOS_DRIVES;d++) {
-				if (Drives[d]) {
-					WriteOut(MSG_Get("PROGRAM_MOUNT_STATUS_2"),d+'A',Drives[d]->GetInfo());
-				}
-			}
+			ListMounts();
 			return;
 		}
 
@@ -84,12 +112,12 @@
 		if (cmd->FindString("-u",umount,false)) {
 			umount[0] = toupper(umount[0]);
 			int i_drive = umount[0]-'A';
-				if(i_drive < DOS_DRIVES && i_drive >= 0 && Drives[i_drive]) {
+				if (i_drive < DOS_DRIVES && i_drive >= 0 && Drives[i_drive]) {
 					switch (DriveManager::UnmountDrive(i_drive)) {
 					case 0:
 						Drives[i_drive] = 0;
 						if(i_drive == DOS_GetDefaultDrive()) 
-							DOS_SetDrive(toupper('Z') - 'A');
+							DOS_SetDrive(ZDRIVE_NUM);
 						WriteOut(MSG_Get("PROGRAM_MOUNT_UMOUNT_SUCCESS"),umount[0]);
 						break;
 					case 1:
@@ -104,8 +132,46 @@
 				}
 			return;
 		}
-	   
-		// Show list of cdroms
+		
+		/* Check for moving Z: */
+		/* Only allowing moving it once. It is merely a convenience added for the wine team */
+		if (ZDRIVE_NUM == 25 && cmd->FindString("-z", newz,false)) {
+			newz[0] = toupper(newz[0]);
+			int i_newz = newz[0] - 'A';
+			if (i_newz >= 0 && i_newz < DOS_DRIVES-1 && !Drives[i_newz]) {
+				ZDRIVE_NUM = i_newz;
+				/* remap drives */
+				Drives[i_newz] = Drives[25];
+				Drives[25] = 0;
+				DOS_Shell *fs = static_cast<DOS_Shell *>(first_shell); //dynamic ?				
+				/* Update environment */
+				std::string line = "";
+				char ppp[2] = {newz[0],0};
+				std::string tempenv = ppp; tempenv += ":\\";
+				if (fs->GetEnvStr("PATH",line)){
+					std::string::size_type idx = line.find('=');
+					std::string value = line.substr(idx +1 , std::string::npos);
+					while ( (idx = value.find("Z:\\")) != std::string::npos ||
+					        (idx = value.find("z:\\")) != std::string::npos  )
+						value.replace(idx,3,tempenv);
+					line = value;
+				}
+				if (!line.size()) line = tempenv;
+				fs->SetEnv("PATH",line.c_str());
+				tempenv += "COMMAND.COM";
+				fs->SetEnv("COMSPEC",tempenv.c_str());
+
+				/* Update batch file if running from Z: (very likely: autoexec) */
+				if(fs->bf) {
+					std::string &name = fs->bf->filename;
+					if(name.length() >2 &&  name[0] == 'Z' && name[1] == ':') name[0] = newz[0];
+				}
+				/* Change the active drive */
+				if (DOS_GetDefaultDrive() == 25) DOS_SetDrive(i_newz);
+			}
+			return;
+		}
+		/* Show list of cdroms */
 		if (cmd->FindExist("-cd",false)) {
 			int num = SDL_CDNumDrives();
    			WriteOut(MSG_Get("PROGRAM_MOUNT_CDROMS_FOUND"),num);
@@ -126,9 +192,9 @@
 				str_size="512,1,2880,2880";/* All space free */
 				mediaid=0xF0;		/* Floppy 1.44 media */
 			} else if (type=="dir") {
-				// 512*127*16383==~1GB total size
-				// 512*127*4031==~250MB total free size
-				str_size="512,127,16383,4031";
+				// 512*32*32765==~500MB total size
+				// 512*32*16000==~250MB total free size
+				str_size="512,32,32765,16000";
 				mediaid=0xF8;		/* Hard Disk */
 			} else if (type=="cdrom") {
 				str_size="2048,1,65535,0";
@@ -141,11 +207,17 @@
 			std::string mb_size;
 			if(cmd->FindString("-freesize",mb_size,true)) {
 				char teststr[1024];
-				Bit16u sizemb = static_cast<Bit16u>(atoi(mb_size.c_str()));
+				Bit16u freesize = static_cast<Bit16u>(atoi(mb_size.c_str()));
 				if (type=="floppy") {
-					sprintf(teststr,"512,1,2880,%d",sizemb*1024/(512*1));
+					// freesize in kb
+					sprintf(teststr,"512,1,2880,%d",freesize*1024/(512*1));
 				} else {
-					sprintf(teststr,"512,127,16513,%d",sizemb*1024*1024/(512*127));
+					Bit32u total_size_cyl=32765;
+					Bit32u free_size_cyl=(Bit32u)freesize*1024*1024/(512*32);
+					if (free_size_cyl>65534) free_size_cyl=65534;
+					if (total_size_cyl<free_size_cyl) total_size_cyl=free_size_cyl+10;
+					if (total_size_cyl>65534) total_size_cyl=65534;
+					sprintf(teststr,"512,32,%d,%d",total_size_cyl,free_size_cyl);
 				}
 				str_size=teststr;
 			}
@@ -319,6 +391,7 @@
 			label = drive; label += "_FLOPPY";
 			newdrive->dirCache.SetLabel(label.c_str(),iscdrom,true);
 		}
+		if(type == "floppy") incrementFDD();
 		return;
 showusage:
 #if defined (WIN32) || defined(OS2)
@@ -908,11 +981,29 @@
 
 void RESCAN::Run(void) 
 {
-	// Get current drive
+	bool all = false;
+	
 	Bit8u drive = DOS_GetDefaultDrive();
-	if (Drives[drive]) {
-		Drives[drive]->EmptyCache();
+	
+	if(cmd->FindCommand(1,temp_line)) {
+		//-A -All /A /All 
+		if(temp_line.size() >= 2 && (temp_line[0] == '-' ||temp_line[0] =='/')&& (temp_line[1] == 'a' || temp_line[1] =='A') ) all = true;
+		else if(temp_line.size() == 2 && temp_line[1] == ':') {
+			lowcase(temp_line);
+			drive  = temp_line[0] - 'a';
+		}
+	}
+	// Get current drive
+	if (all) {
+		for(Bitu i =0; i<DOS_DRIVES;i++) {
+			if (Drives[i]) Drives[i]->EmptyCache();
+		}
 		WriteOut(MSG_Get("PROGRAM_RESCAN_SUCCESS"));
+	} else {
+		if (drive < DOS_DRIVES && Drives[drive]) {
+			Drives[drive]->EmptyCache();
+			WriteOut(MSG_Get("PROGRAM_RESCAN_SUCCESS"));
+		}
 	}
 }
 
@@ -1026,7 +1117,7 @@
 			if (type=="floppy") {
 				mediaid=0xF0;		
 			} else if (type=="iso") {
-				str_size="650,127,16513,1700";
+				str_size=="2048,1,60000,0";	// ignored, see drive_iso.cpp (AllocationInfo)
 				mediaid=0xF8;		
 				fstype = "iso";
 			} 
@@ -1123,10 +1214,6 @@
 			}
 			if (paths.size() == 1)
 				temp_line = paths[0];
-			if (paths.size() > 1 && fstype != "iso") {
-				WriteOut(MSG_Get("PROGRAM_IMGMOUNT_MULTIPLE_NON_CUEISO_FILES"));
-				return;
-			}
 
 			if(fstype=="fat") {
 				if (imgsizedetect) {
@@ -1158,12 +1245,122 @@
 					LOG_MSG("autosized image file: %d:%d:%d:%d",sizes[0],sizes[1],sizes[2],sizes[3]);
 				}
 
-				newdrive=new fatDrive(temp_line.c_str(),sizes[0],sizes[1],sizes[2],sizes[3],0);
-				if(!(dynamic_cast<fatDrive*>(newdrive))->created_successfully) {
-					delete newdrive;
-					newdrive = 0;
+				if (Drives[drive-'A']) {
+					WriteOut(MSG_Get("PROGRAM_IMGMOUNT_ALREADY_MOUNTED"));
+					return;
+				}
+
+				std::vector<DOS_Drive*> imgDisks;
+				std::vector<std::string>::size_type i;
+				std::vector<DOS_Drive*>::size_type ct;
+				
+				for (i = 0; i < paths.size(); i++) {
+					DOS_Drive* newDrive = new fatDrive(paths[i].c_str(),sizes[0],sizes[1],sizes[2],sizes[3],0);
+					imgDisks.push_back(newDrive);
+					if(!(dynamic_cast<fatDrive*>(newDrive))->created_successfully) {
+						WriteOut(MSG_Get("PROGRAM_IMGMOUNT_CANT_CREATE"));
+						for(ct = 0; ct < imgDisks.size(); ct++) {
+							delete imgDisks[ct];
+						}
+						return;
+					}
+				}
+
+				// Update DriveManager
+				for(ct = 0; ct < imgDisks.size(); ct++) {
+					DriveManager::AppendDisk(drive - 'A', imgDisks[ct]);
+				}
+				DriveManager::InitializeDrive(drive - 'A');
+
+				// Set the correct media byte in the table 
+				mem_writeb(Real2Phys(dos.tables.mediaid) + (drive - 'A') * 2, mediaid);
+				
+				/* Command uses dta so set it to our internal dta */
+				RealPt save_dta = dos.dta();
+				dos.dta(dos.tables.tempdta);
+
+				for(ct = 0; ct < imgDisks.size(); ct++) {
+					DriveManager::CycleAllDisks();
+
+					char root[4] = {drive, ':', '\\', 0};
+					DOS_FindFirst(root, DOS_ATTR_VOLUME); // force obtaining the label and saving it in dirCache
+				}
+				dos.dta(save_dta);
+
+				std::string tmp(paths[0]);
+				for (i = 1; i < paths.size(); i++) {
+					tmp += "; " + paths[i];
+				}
+				WriteOut(MSG_Get("PROGRAM_MOUNT_STATUS_2"), drive, tmp.c_str());
+
+				if (paths.size() == 1) {
+					newdrive = imgDisks[0];
+					if(((fatDrive *)newdrive)->loadedDisk->hardDrive) {
+						if(imageDiskList[2] == NULL) {
+							imageDiskList[2] = ((fatDrive *)newdrive)->loadedDisk;
+							updateDPT();
+							return;
+						}
+						if(imageDiskList[3] == NULL) {
+							imageDiskList[3] = ((fatDrive *)newdrive)->loadedDisk;
+							updateDPT();
+							return;
+						}
+					}
+					if(!((fatDrive *)newdrive)->loadedDisk->hardDrive) {
+						imageDiskList[0] = ((fatDrive *)newdrive)->loadedDisk;
+					}
 				}
 			} else if (fstype=="iso") {
+
+				if (Drives[drive-'A']) {
+					WriteOut(MSG_Get("PROGRAM_IMGMOUNT_ALREADY_MOUNTED"));
+					return;
+				}
+				MSCDEX_SetCDInterface(CDROM_USE_SDL, -1);
+				// create new drives for all images
+				std::vector<DOS_Drive*> isoDisks;
+				std::vector<std::string>::size_type i;
+				std::vector<DOS_Drive*>::size_type ct;
+				for (i = 0; i < paths.size(); i++) {
+					int error = -1;
+					DOS_Drive* newDrive = new isoDrive(drive, paths[i].c_str(), mediaid, error);
+					isoDisks.push_back(newDrive);
+					switch (error) {
+						case 0  :	break;
+						case 1  :	WriteOut(MSG_Get("MSCDEX_ERROR_MULTIPLE_CDROMS"));	break;
+						case 2  :	WriteOut(MSG_Get("MSCDEX_ERROR_NOT_SUPPORTED"));	break;
+						case 3  :	WriteOut(MSG_Get("MSCDEX_ERROR_OPEN"));				break;
+						case 4  :	WriteOut(MSG_Get("MSCDEX_TOO_MANY_DRIVES"));		break;
+						case 5  :	WriteOut(MSG_Get("MSCDEX_LIMITED_SUPPORT"));		break;
+						case 6  :	WriteOut(MSG_Get("MSCDEX_INVALID_FILEFORMAT"));		break;
+						default :	WriteOut(MSG_Get("MSCDEX_UNKNOWN_ERROR"));			break;
+					}
+					// error: clean up and leave
+					if (error) {
+						for(ct = 0; ct < isoDisks.size(); ct++) {
+							delete isoDisks[ct];
+						}
+						return;
+					}
+				}
+				// Update DriveManager
+				for(ct = 0; ct < isoDisks.size(); ct++) {
+					DriveManager::AppendDisk(drive - 'A', isoDisks[ct]);
+				}
+				DriveManager::InitializeDrive(drive - 'A');
+				
+				// Set the correct media byte in the table 
+				mem_writeb(Real2Phys(dos.tables.mediaid) + (drive - 'A') * 2, mediaid);
+				
+				// Print status message (success)
+				WriteOut(MSG_Get("MSCDEX_SUCCESS"));
+				std::string tmp(paths[0]);
+				for (i = 1; i < paths.size(); i++) {
+					tmp += "; " + paths[i];
+				}
+				WriteOut(MSG_Get("PROGRAM_MOUNT_STATUS_2"), drive, tmp.c_str());
+
 			} else {
 				FILE *newDisk = fopen(temp_line.c_str(), "rb+");
 				fseek(newDisk,0L, SEEK_END);
@@ -1177,82 +1374,7 @@
 			return;
 		}
 
-		if(fstype=="fat") {
-			if (Drives[drive-'A']) {
-				WriteOut(MSG_Get("PROGRAM_IMGMOUNT_ALREADY_MOUNTED"));
-				if (newdrive) delete newdrive;
-				return;
-			}
-			if (!newdrive) {WriteOut(MSG_Get("PROGRAM_IMGMOUNT_CANT_CREATE"));return;}
-			Drives[drive-'A']=newdrive;
-			// Set the correct media byte in the table 
-			mem_writeb(Real2Phys(dos.tables.mediaid)+(drive-'A')*2,mediaid);
-			WriteOut(MSG_Get("PROGRAM_MOUNT_STATUS_2"),drive,temp_line.c_str());
-			if(((fatDrive *)newdrive)->loadedDisk->hardDrive) {
-				if(imageDiskList[2] == NULL) {
-					imageDiskList[2] = ((fatDrive *)newdrive)->loadedDisk;
-					updateDPT();
-					return;
-				}
-				if(imageDiskList[3] == NULL) {
-					imageDiskList[3] = ((fatDrive *)newdrive)->loadedDisk;
-					updateDPT();
-					return;
-				}
-			}
-			if(!((fatDrive *)newdrive)->loadedDisk->hardDrive) {
-				imageDiskList[0] = ((fatDrive *)newdrive)->loadedDisk;
-			}
-		} else if (fstype=="iso") {
-			if (Drives[drive-'A']) {
-				WriteOut(MSG_Get("PROGRAM_IMGMOUNT_ALREADY_MOUNTED"));
-				return;
-			}
-			MSCDEX_SetCDInterface(CDROM_USE_SDL, -1);
-			// create new drives for all images
-			std::vector<DOS_Drive*> isoDisks;
-			std::vector<std::string>::size_type i;
-			std::vector<DOS_Drive*>::size_type ct;
-			for (i = 0; i < paths.size(); i++) {
-				int error = -1;
-				DOS_Drive* newDrive = new isoDrive(drive, paths[i].c_str(), mediaid, error);
-				isoDisks.push_back(newDrive);
-				switch (error) {
-					case 0  :	break;
-					case 1  :	WriteOut(MSG_Get("MSCDEX_ERROR_MULTIPLE_CDROMS"));	break;
-					case 2  :	WriteOut(MSG_Get("MSCDEX_ERROR_NOT_SUPPORTED"));	break;
-					case 3  :	WriteOut(MSG_Get("MSCDEX_ERROR_OPEN"));				break;
-					case 4  :	WriteOut(MSG_Get("MSCDEX_TOO_MANY_DRIVES"));		break;
-					case 5  :	WriteOut(MSG_Get("MSCDEX_LIMITED_SUPPORT"));		break;
-					case 6  :	WriteOut(MSG_Get("MSCDEX_INVALID_FILEFORMAT"));		break;
-					default :	WriteOut(MSG_Get("MSCDEX_UNKNOWN_ERROR"));			break;
-				}
-				// error: clean up and leave
-				if (error) {
-					for(ct = 0; ct < isoDisks.size(); ct++) {
-						delete isoDisks[ct];
-					}
-					return;
-				}
-			}
-			// Update DriveManager
-			for(ct = 0; ct < isoDisks.size(); ct++) {
-				DriveManager::AppendDisk(drive - 'A', isoDisks[ct]);
-			}
-			DriveManager::InitializeDrive(drive - 'A');
-			
-			// Set the correct media byte in the table 
-			mem_writeb(Real2Phys(dos.tables.mediaid) + (drive - 'A') * 2, mediaid);
-			
-			// Print status message (success)
-			WriteOut(MSG_Get("MSCDEX_SUCCESS"));
-			std::string tmp(paths[0]);
-			for (i = 1; i < paths.size(); i++) {
-				tmp += "; " + paths[i];
-			}
-			WriteOut(MSG_Get("PROGRAM_MOUNT_STATUS_2"), drive, tmp.c_str());
-			
-		} else if (fstype=="none") {
+		if (fstype=="none") {
 			if(imageDiskList[drive-'0'] != NULL) delete imageDiskList[drive-'0'];
 			imageDiskList[drive-'0'] = newImage;
 			updateDPT();
@@ -1347,8 +1469,9 @@
 	/*Add Messages */
 
 	MSG_Add("PROGRAM_MOUNT_CDROMS_FOUND","CDROMs found: %d\n");
+	MSG_Add("PROGRAM_MOUNT_STATUS_FORMAT","%-5s  %-58s %-12s\n");
 	MSG_Add("PROGRAM_MOUNT_STATUS_2","Drive %c is mounted as %s\n");
-	MSG_Add("PROGRAM_MOUNT_STATUS_1","Current mounted drives are:\n");
+	MSG_Add("PROGRAM_MOUNT_STATUS_1","The currently mounted drives are:\n");
 	MSG_Add("PROGRAM_MOUNT_ERROR_1","Directory %s doesn't exist.\n");
 	MSG_Add("PROGRAM_MOUNT_ERROR_2","%s isn't a directory\n");
 	MSG_Add("PROGRAM_MOUNT_ILL_TYPE","Illegal type %s\n");
diff -Nur dosbox-0.74/src/dos/dos_tables.cpp dosbox-0.74.patch/src/dos/dos_tables.cpp
--- dosbox-0.74/src/dos/dos_tables.cpp	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/dos/dos_tables.cpp	2016-12-11 18:35:15.526284006 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: dos_tables.cpp,v 1.32 2009-10-28 21:45:12 qbix79 Exp $ */
 
 #include "dosbox.h"
 #include "mem.h"
diff -Nur dosbox-0.74/src/dos/drive_cache.cpp dosbox-0.74.patch/src/dos/drive_cache.cpp
--- dosbox-0.74/src/dos/drive_cache.cpp	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/dos/drive_cache.cpp	2016-12-11 18:35:15.526284006 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: drive_cache.cpp,v 1.59 2009-04-16 12:28:30 qbix79 Exp $ */
 
 #include "drives.h"
 #include "dos_inc.h"
@@ -67,7 +66,7 @@
 	srchNr			= 0;
 	label[0]		= 0;
 	nextFreeFindFirst	= 0;
-	for (Bit32u i=0; i<MAX_OPENDIRS; i++) { dirSearch[i] = 0; free[i] = true; dirFindFirst[i] = 0; };
+	for (Bit32u i=0; i<MAX_OPENDIRS; i++) { dirSearch[i] = 0; dirFindFirst[i] = 0; };
 	SetDirSort(DIRALPHABETICAL);
 	updatelabel = true;
 }
@@ -78,7 +77,7 @@
 	srchNr			= 0;
 	label[0]		= 0;
 	nextFreeFindFirst	= 0;
-	for (Bit32u i=0; i<MAX_OPENDIRS; i++) { dirSearch[i] = 0; free[i] = true; dirFindFirst[i] = 0; };
+	for (Bit32u i=0; i<MAX_OPENDIRS; i++) { dirSearch[i] = 0; dirFindFirst[i] = 0; };
 	SetDirSort(DIRALPHABETICAL);
 	SetBaseDir(path);
 	updatelabel = true;
@@ -86,11 +85,11 @@
 
 DOS_Drive_Cache::~DOS_Drive_Cache(void) {
 	Clear();
-	for (Bit32u i=0; i<MAX_OPENDIRS; i++) { delete dirFindFirst[i]; dirFindFirst[i]=0; };
+	for (Bit32u i=0; i<MAX_OPENDIRS; i++) { DeleteFileInfo(dirFindFirst[i]); dirFindFirst[i]=0; };
 }
 
 void DOS_Drive_Cache::Clear(void) {
-	delete dirBase; dirBase = 0;
+	DeleteFileInfo(dirBase); dirBase = 0;
 	nextFreeFindFirst	= 0;
 	for (Bit32u i=0; i<MAX_OPENDIRS; i++) dirSearch[i] = 0;
 }
@@ -101,7 +100,6 @@
 	dirBase		= new CFileInfo;
 	save_dir	= 0;
 	srchNr		= 0;
-	for (Bit32u i=0; i<MAX_OPENDIRS; i++) free[i] = true; 
 	SetBaseDir(basePath);
 }
 
@@ -117,8 +115,16 @@
 }
 
 Bit16u DOS_Drive_Cache::GetFreeID(CFileInfo* dir) {
-	for (Bit16u i=0; i<MAX_OPENDIRS; i++) if (free[i] || (dir==dirSearch[i])) return i;
+	if (dir->id != MAX_OPENDIRS)
+		return dir->id;
+	for (Bit16u i=0; i<MAX_OPENDIRS; i++) {
+		if (!dirSearch[i]) {
+			dir->id = i;
+			return i;
+		}
+	}
 	LOG(LOG_FILES,LOG_NORMAL)("DIRCACHE: Too many open directories!");
+	dir->id=0;
 	return 0;
 }
 
@@ -262,7 +268,7 @@
 	// delete file objects...
 	for(Bit32u i=0; i<dir->fileList.size(); i++) {
 		if (dirSearch[srchNr]==dir->fileList[i]) dirSearch[srchNr] = 0;
-		delete dir->fileList[i]; dir->fileList[i] = 0;
+		DeleteFileInfo(dir->fileList[i]); dir->fileList[i] = 0;
 	}
 	// clear lists
 	dir->fileList.clear();
@@ -370,6 +376,60 @@
 	return false;
 }
 
+#define WINE_DRIVE_SUPPORT 1
+#if WINE_DRIVE_SUPPORT
+//Changes to interact with WINE by supporting their namemangling.
+//The code is rather slow, because orglist is unordered, so it needs to be avoided if possible.
+//Hence the tests in GetLongFileName
+
+
+// From the Wine project
+static Bits wine_hash_short_file_name( char* name, char* buffer )
+{
+	static const char hash_chars[] = "ABCDEFGHIJKLMNOPQRSTUVWXYZ012345";
+	static const char invalid_chars[] = { '*','?','<','>','|','"','+','=',',',';','[',']',' ','\345','~','.',0 };
+	char* p;
+	char* ext;
+	char* end = name + strlen(name);
+	char* dst;
+	unsigned short hash;
+	int i;
+
+	// Compute the hash code of the file name
+	for (p = name, hash = 0xbeef; p < end - 1; p++)
+		hash = (hash<<3) ^ (hash>>5) ^ tolower(*p) ^ (tolower(p[1]) << 8);
+	hash = (hash<<3) ^ (hash>>5) ^ tolower(*p); // Last character
+
+
+	// Find last dot for start of the extension
+	for (p = name + 1, ext = NULL; p < end - 1; p++) if (*p == '.') ext = p;
+
+	// Copy first 4 chars, replacing invalid chars with '_'
+	for (i = 4, p = name, dst = buffer; i > 0; i--, p++)
+	{
+		if (p == end || p == ext) break;
+		*dst++ = (*p < 0 || strchr( invalid_chars, *p ) != NULL) ? '_' : toupper(*p);
+	}
+	// Pad to 5 chars with '~'
+	while (i-- >= 0) *dst++ = '~';
+
+	// Insert hash code converted to 3 ASCII chars
+	*dst++ = hash_chars[(hash >> 10) & 0x1f];
+	*dst++ = hash_chars[(hash >> 5) & 0x1f];
+	*dst++ = hash_chars[hash & 0x1f];
+
+	// Copy the first 3 chars of the extension (if any)
+	if (ext)
+	{
+		*dst++ = '.';
+		for (i = 3, ext++; (i > 0) && ext < end; i--, ext++)
+			*dst++ = (*ext < 0 || strchr( invalid_chars, *ext ) != NULL) ? '_' : toupper(*ext);
+	}
+
+	return dst - buffer;
+}
+#endif
+
 Bits DOS_Drive_Cache::GetLongName(CFileInfo* curDir, char* shortName) {
 	std::vector<CFileInfo*>::size_type filelist_size = curDir->fileList.size();
 	if (GCC_UNLIKELY(filelist_size<=0)) return -1;
@@ -390,6 +450,21 @@
 			return mid;
 		};
 	}
+#ifdef WINE_DRIVE_SUPPORT
+	if (strlen(shortName) < 8 || shortName[4] != '~' || shortName[5] == '.' || shortName[6] == '.' || shortName[7] == '.') return -1; // not available
+	// else it's most likely a Wine style short name ABCD~###, # = not dot  (length at least 8) 
+	// The above test is rather strict as the following loop can be really slow if filelist_size is large.
+	char buff[CROSS_LEN];
+	for (Bitu i = 0; i < filelist_size; i++) {
+		res = wine_hash_short_file_name(curDir->fileList[i]->orgname,buff);
+		buff[res] = 0;
+		if (!strcmp(shortName,buff)) {	
+			// Found
+			strcpy(shortName,curDir->fileList[i]->orgname);
+			return (Bits)i;
+		}
+	}
+#endif
 	// not available
 	return -1;
 }
@@ -524,7 +599,10 @@
 			strcpy(buffer,dirPath);
 			ReadDir(id,result);
 			strcpy(dirPath,buffer);
-			free[id] = true;
+			if (dirSearch[id]) {
+				dirSearch[id]->id = MAX_OPENDIRS;
+				dirSearch[id] = 0;
+			}
 		};
 	};
 
@@ -554,7 +632,10 @@
 					strcpy(buffer,dirPath);
 					ReadDir(id,result);
 					strcpy(dirPath,buffer);
-					free[id] = true;
+					if (dirSearch[id]) {
+						dirSearch[id]->id = MAX_OPENDIRS;
+						dirSearch[id] = 0;
+					}
 				};
 			}
 		};
@@ -598,9 +679,12 @@
 			// Reset it..
 			close_directory(dirp);
 			strcpy(dirPath,expandcopy);
-			free[id] = false;
 			return true;
 		}
+		if (dirSearch[id]) {
+			dirSearch[id]->id = MAX_OPENDIRS;
+			dirSearch[id] = 0;
+		}
 	};
 	return false;
 }
@@ -659,7 +743,10 @@
 		// Try to open directory
 		dir_information* dirp = open_directory(dirPath);
 		if (!dirp) {
-			free[id] = true;
+			if (dirSearch[id]) {
+				dirSearch[id]->id = MAX_OPENDIRS;
+				dirSearch[id] = 0;
+			}
 			return false;
 		}
 		// Read complete directory
@@ -686,7 +773,10 @@
 		};*/
 	};
 	if (SetResult(dirSearch[id], result, dirSearch[id]->nextEntry)) return true;
-	free[id] = true;
+	if (dirSearch[id]) {
+		dirSearch[id]->id = MAX_OPENDIRS;
+		dirSearch[id] = 0;
+	}
 	return false;
 }
 
@@ -730,7 +820,7 @@
 		this->nextFreeFindFirst = 1; //the next free one after this search
 		for(Bitu n=0; n<MAX_OPENDIRS;n++) {	
 	     	// Clear and reuse slot
-			delete dirFindFirst[n];
+			DeleteFileInfo(dirFindFirst[n]);
 			dirFindFirst[n]=0;
 		}
 	   
@@ -765,8 +855,25 @@
 	}
 	if (!SetResult(dirFindFirst[id], result, dirFindFirst[id]->nextEntry)) {
 		// free slot
-		delete dirFindFirst[id]; dirFindFirst[id] = 0;
+		DeleteFileInfo(dirFindFirst[id]); dirFindFirst[id] = 0;
 		return false;
 	}
 	return true;
 }
+
+void DOS_Drive_Cache::ClearFileInfo(CFileInfo *dir) {
+	for(Bit32u i=0; i<dir->fileList.size(); i++) {
+		if (CFileInfo *info = dir->fileList[i])
+			ClearFileInfo(info);
+	}
+	if (dir->id != MAX_OPENDIRS) {
+		dirSearch[dir->id] = 0;
+		dir->id = MAX_OPENDIRS;
+	}
+}
+
+void DOS_Drive_Cache::DeleteFileInfo(CFileInfo *dir) {
+	if (dir)
+		ClearFileInfo(dir);
+	delete dir;
+}
diff -Nur dosbox-0.74/src/dos/drive_fat.cpp dosbox-0.74.patch/src/dos/drive_fat.cpp
--- dosbox-0.74/src/dos/drive_fat.cpp	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/dos/drive_fat.cpp	2016-12-11 18:35:15.526284006 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: drive_fat.cpp,v 1.28 2009-06-19 18:28:10 c2woody Exp $ */
 
 #include <stdio.h>
 #include <stdlib.h>
@@ -28,6 +27,7 @@
 #include "support.h"
 #include "cross.h"
 #include "bios.h"
+#include "bios_disk.h"
 
 #define IMGTYPE_FLOPPY 0
 #define IMGTYPE_ISO    1
@@ -37,9 +37,6 @@
 #define FAT16		   1
 #define FAT32		   2
 
-Bit8u fatSectBuffer[1024];
-Bit32u curFatSect;
-
 class fatFile : public DOS_File {
 public:
 	fatFile(const char* name, Bit32u startCluster, Bit32u fileLen, fatDrive *useDrive);
@@ -529,6 +526,10 @@
 		}
 		if((isEOF) && (skipClust>=1)) {
 			//LOG_MSG("End of cluster chain reached before end of logical sector seek!");
+			if (skipClust == 1 && fattype == FAT12) {
+				//break;
+				LOG(LOG_DOSMISC,LOG_ERROR)("End of cluster chain reached, but maybe good afterall ?");
+			}
 			return 0;
 		}
 		currentClust = testvalue;
@@ -725,6 +726,9 @@
 
 	memset(fatSectBuffer,0,1024);
 	curFatSect = 0xffffffff;
+
+	strcpy(info, "fatDrive ");
+	strcat(info, sysFilename);
 }
 
 bool fatDrive::AllocationInfo(Bit16u *_bytes_sector, Bit8u *_sectors_cluster, Bit16u *_total_clusters, Bit16u *_free_clusters) {
@@ -856,6 +860,7 @@
 
 bool fatDrive::FindFirst(char *_dir, DOS_DTA &dta,bool /*fcb_findfirst*/) {
 	direntry dummyClust;
+#if 0
 	Bit8u attr;char pattern[DOS_NAMELENGTH_ASCII];
 	dta.GetSearchParams(attr,pattern);
 	if(attr==DOS_ATTR_VOLUME) {
@@ -868,6 +873,7 @@
 	}
 	if(attr & DOS_ATTR_VOLUME) //check for root dir or fcb_findfirst
 		LOG(LOG_DOSMISC,LOG_WARN)("findfirst for volumelabel used on fatDrive. Unhandled!!!!!");
+#endif
 	if(!getDirClustNum(_dir, &cwdDirCluster, false)) {
 		DOS_SetError(DOSERR_PATH_NOT_FOUND);
 		return false;
@@ -935,26 +941,37 @@
 		DOS_SetError(DOSERR_NO_MORE_FILES);
 		return false;
 	}
-
 	memset(find_name,0,DOS_NAMELENGTH_ASCII);
 	memset(extension,0,4);
 	memcpy(find_name,&sectbuf[entryoffset].entryname[0],8);
 	memcpy(extension,&sectbuf[entryoffset].entryname[8],3);
 	trimString(&find_name[0]);
 	trimString(&extension[0]);
-	if(!(sectbuf[entryoffset].attrib & DOS_ATTR_DIRECTORY) || extension[0]!=0) { 
+	
+	//if(!(sectbuf[entryoffset].attrib & DOS_ATTR_DIRECTORY))
+	if (extension[0]!=0) {
 		strcat(find_name, ".");
 		strcat(find_name, extension);
 	}
 
-	/* Ignore files with volume label. FindFirst should search for those. (return the first one found) */
-	if(sectbuf[entryoffset].attrib & 0x8) goto nextfile;
-   
-	/* Always find ARCHIVES even if bit is not set  Perhaps test is not the best test */
-	if(~attrs & sectbuf[entryoffset].attrib & (DOS_ATTR_DIRECTORY | DOS_ATTR_HIDDEN | DOS_ATTR_SYSTEM) )  goto nextfile;
+	/* Compare attributes to search attributes */
+
+	//TODO What about attrs = DOS_ATTR_VOLUME|DOS_ATTR_DIRECTORY ?
+	if (attrs == DOS_ATTR_VOLUME) {
+		if (!(sectbuf[entryoffset].attrib & DOS_ATTR_VOLUME)) goto nextfile;
+		dirCache.SetLabel(find_name, false, true);
+	} else {
+		if (~attrs & sectbuf[entryoffset].attrib & (DOS_ATTR_DIRECTORY | DOS_ATTR_VOLUME | DOS_ATTR_SYSTEM | DOS_ATTR_HIDDEN) ) goto nextfile;
+	}
+
+
+	/* Compare name to search pattern */
 	if(!WildFileCmp(find_name,srch_pattern)) goto nextfile;
 
-	dta.SetResult(find_name, sectbuf[entryoffset].entrysize, sectbuf[entryoffset].crtDate, sectbuf[entryoffset].crtTime, sectbuf[entryoffset].attrib);
+	//dta.SetResult(find_name, sectbuf[entryoffset].entrysize, sectbuf[entryoffset].crtDate, sectbuf[entryoffset].crtTime, sectbuf[entryoffset].attrib);
+
+	dta.SetResult(find_name, sectbuf[entryoffset].entrysize, sectbuf[entryoffset].modDate, sectbuf[entryoffset].modTime, sectbuf[entryoffset].attrib);
+
 	memcpy(foundEntry, &sectbuf[entryoffset], sizeof(direntry));
 
 	return true;
@@ -983,11 +1000,13 @@
 		/* Find directory entry in parent directory */
 		Bit32s fileidx = 2;
 		if (dirClust==0) fileidx = 0;	// root directory
-		while(directoryBrowse(dirClust, &fileEntry, fileidx)) {
+		Bit32s last_idx=0;
+		while(directoryBrowse(dirClust, &fileEntry, fileidx, last_idx)) {
 			if(memcmp(&fileEntry.entryname, &pathName[0], 11) == 0) {
 				*attr=fileEntry.attrib;
 				return true;
 			}
+			last_idx=fileidx;
 			fileidx++;
 		}
 		return false;
@@ -995,12 +1014,15 @@
 	return true;
 }
 
-bool fatDrive::directoryBrowse(Bit32u dirClustNumber, direntry *useEntry, Bit32s entNum) {
+bool fatDrive::directoryBrowse(Bit32u dirClustNumber, direntry *useEntry, Bit32s entNum, Bit32s start/*=0*/) {
 	direntry sectbuf[16];	/* 16 directory entries per sector */
 	Bit32u logentsector;	/* Logical entry sector */
 	Bit32u entryoffset = 0;	/* Index offset within sector */
 	Bit32u tmpsector;
-	Bit16u dirPos = 0;
+	if ((start<0) || (start>65535)) return false;
+	Bit16u dirPos = (Bit16u)start;
+	if (entNum<start) return false;
+	entNum-=start;
 
 	while(entNum>=0) {
 
diff -Nur dosbox-0.74/src/dos/drive_iso.cpp dosbox-0.74.patch/src/dos/drive_iso.cpp
--- dosbox-0.74/src/dos/drive_iso.cpp	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/dos/drive_iso.cpp	2016-12-11 18:35:15.526284006 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: drive_iso.cpp,v 1.27 2009-09-22 21:48:08 c2woody Exp $ */
 
 #include <cctype>
 #include <cstring>
@@ -256,13 +255,8 @@
 	dta.GetSearchParams(attr, pattern);
    
 	if (attr == DOS_ATTR_VOLUME) {
-		if (strlen(discLabel) != 0) {
-			dta.SetResult(discLabel, 0, 0, 0, DOS_ATTR_VOLUME);
-			return true;
-		} else {
-			DOS_SetError(DOSERR_NO_MORE_FILES);		
-			return false;
-		}
+		dta.SetResult(discLabel, 0, 0, 0, DOS_ATTR_VOLUME);
+		return true;
 	} else if ((attr & DOS_ATTR_VOLUME) && isRoot && !fcb_findfirst) {
 		if (WildFileCmp(discLabel,pattern)) {
 			// Get Volume Label (DOS_ATTR_VOLUME) and only in basedir and if it matches the searchstring
@@ -289,7 +283,7 @@
 		else findAttr |= DOS_ATTR_ARCHIVE;
 		if (IS_HIDDEN(de.fileFlags)) findAttr |= DOS_ATTR_HIDDEN;
 
-		if (!(isRoot && de.ident[0]=='.') && WildFileCmp((char*)de.ident, pattern)
+		if (!IS_ASSOC(de.fileFlags) && !(isRoot && de.ident[0]=='.') && WildFileCmp((char*)de.ident, pattern)
 			&& !(~attr & findAttr & (DOS_ATTR_DIRECTORY | DOS_ATTR_HIDDEN | DOS_ATTR_SYSTEM))) {
 			
 			/* file is okay, setup everything to be copied in DTA Block */
@@ -333,7 +327,7 @@
 bool isoDrive::AllocationInfo(Bit16u *bytes_sector, Bit8u *sectors_cluster, Bit16u *total_clusters, Bit16u *free_clusters) {
 	*bytes_sector = 2048;
 	*sectors_cluster = 1; // cluster size for cdroms ?
-	*total_clusters = 60000;
+	*total_clusters = 65535;
 	*free_clusters = 0;
 	return true;
 }
@@ -494,13 +488,13 @@
 			if (de->ident[tmp - 1] == '.') de->ident[tmp - 1] = 0;
 		}
 	}
-	const char* dotpos = strchr((char*)de->ident, '.');
+	char* dotpos = strchr((char*)de->ident, '.');
 	if (dotpos!=NULL) {
+		if (strlen(dotpos)>4) dotpos[4]=0;
 		if (dotpos-(char*)de->ident>8) {
 			strcpy((char*)(&de->ident[8]),dotpos);
 		}
-	}
-	if (strlen((char*)de->ident)>12) de->ident[12]=0;
+	} else if (strlen((char*)de->ident)>8) de->ident[8]=0;
 	return de->length;
 }
 
@@ -541,7 +535,7 @@
 			// look for the current path element
 			int dirIterator = GetDirIterator(de);
 			while (!found && GetNextDirEntry(dirIterator, de)) {
-				if (0 == strncasecmp((char*) de->ident, name, ISO_MAX_FILENAME_LENGTH)) {
+				if (!IS_ASSOC(de->fileFlags) && (0 == strncasecmp((char*) de->ident, name, ISO_MAX_FILENAME_LENGTH))) {
 					found = true;
 				}
 			}
diff -Nur dosbox-0.74/src/dos/drive_local.cpp dosbox-0.74.patch/src/dos/drive_local.cpp
--- dosbox-0.74/src/dos/drive_local.cpp	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/dos/drive_local.cpp	2016-12-11 18:35:15.526284006 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: drive_local.cpp,v 1.82 2009-07-18 18:42:55 c2woody Exp $ */
 
 #include <stdio.h>
 #include <stdlib.h>
@@ -41,6 +40,7 @@
 	Bit16u GetInformation(void);
 	bool UpdateDateTimeFromHost(void);   
 	void FlagReadOnlyMedium(void);
+	void Flush(void);
 private:
 	FILE * fhandle;
 	bool read_only_medium;
@@ -82,9 +82,10 @@
 bool localDrive::FileOpen(DOS_File * * file,char * name,Bit32u flags) {
 	const char* type;
 	switch (flags&0xf) {
-	case OPEN_READ:type="rb"; break;
-	case OPEN_WRITE:type="rb+"; break;
-	case OPEN_READWRITE:type="rb+"; break;
+	case OPEN_READ:        type = "rb" ; break;
+	case OPEN_WRITE:       type = "rb+"; break;
+	case OPEN_READWRITE:   type = "rb+"; break;
+	case OPEN_READ_NO_MOD: type = "rb" ; break; //No modification of dates. LORD4.07 uses this
 	default:
 		DOS_SetError(DOSERR_ACCESS_CODE_INVALID);
 		return false;
@@ -95,6 +96,22 @@
 	CROSS_FILENAME(newname);
 	dirCache.ExpandName(newname);
 
+	//Flush the buffer of handles for the same file. (Betrayal in Antara)
+	Bit8u i,drive=DOS_DRIVES;
+	localFile *lfp;
+	for (i=0;i<DOS_DRIVES;i++) {
+		if (Drives[i]==this) {
+			drive=i;
+			break;
+		}
+	}
+	for (i=0;i<DOS_FILES;i++) {
+		if (Files[i] && Files[i]->IsOpen() && Files[i]->GetDrive()==drive && Files[i]->IsName(name)) {
+			lfp=dynamic_cast<localFile*>(Files[i]);
+			if (lfp) lfp->Flush();
+		}
+	}
+
 	FILE * hand=fopen(newname,type);
 //	Bit32u err=errno;
 	if (!hand) { 
@@ -362,8 +379,6 @@
 }
 
 bool localDrive::AllocationInfo(Bit16u * _bytes_sector,Bit8u * _sectors_cluster,Bit16u * _total_clusters,Bit16u * _free_clusters) {
-	/* Always report 100 mb free should be enough */
-	/* Total size is always 1 gb */
 	*_bytes_sector=allocation.bytes_sector;
 	*_sectors_cluster=allocation.sectors_cluster;
 	*_total_clusters=allocation.total_clusters;
@@ -377,9 +392,9 @@
 	strcat(newname,name);
 	CROSS_FILENAME(newname);
 	dirCache.ExpandName(newname);
-	FILE* Temp=fopen(newname,"rb");
-	if(Temp==NULL) return false;
-	fclose(Temp);
+	struct stat temp_stat;
+	if(stat(newname,&temp_stat)!=0) return false;
+	if(temp_stat.st_mode & S_IFDIR) return false;
 	return true;
 }
 
@@ -541,6 +556,13 @@
 	return true;
 }
 
+void localFile::Flush(void) {
+	if (last_action==WRITE) {
+		fseek(fhandle,ftell(fhandle),SEEK_SET);
+		last_action=NONE;
+	}
+}
+
 
 // ********************************************
 // CDROM DRIVE
diff -Nur dosbox-0.74/src/dos/drives.cpp dosbox-0.74.patch/src/dos/drives.cpp
--- dosbox-0.74/src/dos/drives.cpp	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/dos/drives.cpp	2016-12-11 18:35:15.526284006 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: drives.cpp,v 1.15 2009-05-27 09:15:41 qbix79 Exp $ */
 
 #include "dosbox.h"
 #include "dos_system.h"
diff -Nur dosbox-0.74/src/dos/drives.h dosbox-0.74.patch/src/dos/drives.h
--- dosbox-0.74/src/dos/drives.h	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/dos/drives.h	2016-12-11 18:35:15.526284006 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: drives.h,v 1.41 2009-05-27 09:15:41 qbix79 Exp $ */
 
 #ifndef _DRIVES_H__
 #define _DRIVES_H__
@@ -25,7 +24,6 @@
 #include <sys/types.h>
 #include "dos_system.h"
 #include "shell.h" /* for DOS_Shell */
-#include "bios_disk.h"  /* for fatDrive */
 
 bool WildFileCmp(const char * file, const char * wild);
 void Set_Label(char const * const input, char * const output, bool cdrom);
@@ -143,7 +141,8 @@
 #ifdef _MSC_VER
 #pragma pack ()
 #endif
-
+//Forward
+class imageDisk;
 class fatDrive : public DOS_Drive {
 public:
 	fatDrive(const char * sysFilename, Bit32u bytesector, Bit32u cylsector, Bit32u headscyl, Bit32u cylinders, Bit32u startSector);
@@ -172,7 +171,7 @@
 	Bit32u appendCluster(Bit32u startCluster);
 	void deleteClustChain(Bit32u startCluster);
 	Bit32u getFirstFreeClust(void);
-	bool directoryBrowse(Bit32u dirClustNumber, direntry *useEntry, Bit32s entNum);
+	bool directoryBrowse(Bit32u dirClustNumber, direntry *useEntry, Bit32s entNum, Bit32s start=0);
 	bool directoryChange(Bit32u dirClustNumber, direntry *useEntry, Bit32s entNum);
 	imageDisk *loadedDisk;
 	bool created_successfully;
@@ -208,6 +207,9 @@
 
 	Bit32u cwdDirCluster;
 	Bit32u dirPosition; /* Position in directory search */
+
+	Bit8u fatSectBuffer[1024];
+	Bit32u curFatSect;
 };
 
 
@@ -298,11 +300,13 @@
 #endif
 
 #define ISO_FRAMESIZE		2048
+#define ISO_ASSOCIATED		4
 #define ISO_DIRECTORY		2
 #define ISO_HIDDEN		1
 #define ISO_MAX_FILENAME_LENGTH 37
 #define ISO_MAXPATHNAME		256
 #define ISO_FIRST_VD		16
+#define IS_ASSOC(fileFlags)	(fileFlags & ISO_ASSOCIATED)
 #define IS_DIR(fileFlags)	(fileFlags & ISO_DIRECTORY)
 #define IS_HIDDEN(fileFlags)	(fileFlags & ISO_HIDDEN)
 #define ISO_MAX_HASH_TABLE_SIZE 	100
diff -Nur dosbox-0.74/src/dos/drive_virtual.cpp dosbox-0.74.patch/src/dos/drive_virtual.cpp
--- dosbox-0.74/src/dos/drive_virtual.cpp	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/dos/drive_virtual.cpp	2016-12-11 18:35:15.526284006 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -101,7 +101,7 @@
 }
 
 bool Virtual_File::Write(Bit8u * data,Bit16u * size){
-/* Not really writeable */
+	/* Not really writable */
 	return false;
 }
 
@@ -248,12 +248,10 @@
 }
 
 bool Virtual_Drive::AllocationInfo(Bit16u * _bytes_sector,Bit8u * _sectors_cluster,Bit16u * _total_clusters,Bit16u * _free_clusters) {
-	/* Always report 100 mb free should be enough */
-	/* Total size is always 1 gb */
 	*_bytes_sector=512;
-	*_sectors_cluster=127;
-	*_total_clusters=16513;
-	*_free_clusters=00;
+	*_sectors_cluster=32;
+	*_total_clusters=32765;	// total size is always 500 mb
+	*_free_clusters=0;		// nothing free here
 	return true;
 }
 
diff -Nur dosbox-0.74/src/dos/Makefile.in dosbox-0.74.patch/src/dos/Makefile.in
--- dosbox-0.74/src/dos/Makefile.in	2010-05-12 11:57:44.000000000 +0200
+++ dosbox-0.74.patch/src/dos/Makefile.in	1970-01-01 01:00:00.000000000 +0100
@@ -1,482 +0,0 @@
-# Makefile.in generated by automake 1.11.1 from Makefile.am.
-# @configure_input@
-
-# Copyright (C) 1994, 1995, 1996, 1997, 1998, 1999, 2000, 2001, 2002,
-# 2003, 2004, 2005, 2006, 2007, 2008, 2009  Free Software Foundation,
-# Inc.
-# This Makefile.in is free software; the Free Software Foundation
-# gives unlimited permission to copy and/or distribute it,
-# with or without modifications, as long as this notice is preserved.
-
-# This program is distributed in the hope that it will be useful,
-# but WITHOUT ANY WARRANTY, to the extent permitted by law; without
-# even the implied warranty of MERCHANTABILITY or FITNESS FOR A
-# PARTICULAR PURPOSE.
-
-@SET_MAKE@
-
-VPATH = @srcdir@
-pkgdatadir = $(datadir)/@PACKAGE@
-pkgincludedir = $(includedir)/@PACKAGE@
-pkglibdir = $(libdir)/@PACKAGE@
-pkglibexecdir = $(libexecdir)/@PACKAGE@
-am__cd = CDPATH="$${ZSH_VERSION+.}$(PATH_SEPARATOR)" && cd
-install_sh_DATA = $(install_sh) -c -m 644
-install_sh_PROGRAM = $(install_sh) -c
-install_sh_SCRIPT = $(install_sh) -c
-INSTALL_HEADER = $(INSTALL_DATA)
-transform = $(program_transform_name)
-NORMAL_INSTALL = :
-PRE_INSTALL = :
-POST_INSTALL = :
-NORMAL_UNINSTALL = :
-PRE_UNINSTALL = :
-POST_UNINSTALL = :
-build_triplet = @build@
-host_triplet = @host@
-subdir = src/dos
-DIST_COMMON = $(srcdir)/Makefile.am $(srcdir)/Makefile.in
-ACLOCAL_M4 = $(top_srcdir)/aclocal.m4
-am__aclocal_m4_deps = $(top_srcdir)/acinclude.m4 \
-	$(top_srcdir)/configure.in
-am__configure_deps = $(am__aclocal_m4_deps) $(CONFIGURE_DEPENDENCIES) \
-	$(ACLOCAL_M4)
-mkinstalldirs = $(install_sh) -d
-CONFIG_HEADER = $(top_builddir)/config.h
-CONFIG_CLEAN_FILES =
-CONFIG_CLEAN_VPATH_FILES =
-LIBRARIES = $(noinst_LIBRARIES)
-AR = ar
-ARFLAGS = cru
-libdos_a_AR = $(AR) $(ARFLAGS)
-libdos_a_LIBADD =
-am_libdos_a_OBJECTS = dos.$(OBJEXT) dos_devices.$(OBJEXT) \
-	dos_execute.$(OBJEXT) dos_files.$(OBJEXT) dos_ioctl.$(OBJEXT) \
-	dos_memory.$(OBJEXT) dos_misc.$(OBJEXT) dos_classes.$(OBJEXT) \
-	dos_programs.$(OBJEXT) dos_tables.$(OBJEXT) drives.$(OBJEXT) \
-	drive_virtual.$(OBJEXT) drive_local.$(OBJEXT) \
-	drive_cache.$(OBJEXT) drive_fat.$(OBJEXT) drive_iso.$(OBJEXT) \
-	dos_mscdex.$(OBJEXT) dos_keyboard_layout.$(OBJEXT) \
-	cdrom.$(OBJEXT) cdrom_ioctl_win32.$(OBJEXT) \
-	cdrom_aspi_win32.$(OBJEXT) cdrom_ioctl_linux.$(OBJEXT) \
-	cdrom_image.$(OBJEXT) cdrom_ioctl_os2.$(OBJEXT)
-libdos_a_OBJECTS = $(am_libdos_a_OBJECTS)
-DEFAULT_INCLUDES = -I.@am__isrc@ -I$(top_builddir)
-depcomp = $(SHELL) $(top_srcdir)/depcomp
-am__depfiles_maybe = depfiles
-am__mv = mv -f
-CXXCOMPILE = $(CXX) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) \
-	$(AM_CPPFLAGS) $(CPPFLAGS) $(AM_CXXFLAGS) $(CXXFLAGS)
-CXXLD = $(CXX)
-CXXLINK = $(CXXLD) $(AM_CXXFLAGS) $(CXXFLAGS) $(AM_LDFLAGS) $(LDFLAGS) \
-	-o $@
-COMPILE = $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) \
-	$(CPPFLAGS) $(AM_CFLAGS) $(CFLAGS)
-CCLD = $(CC)
-LINK = $(CCLD) $(AM_CFLAGS) $(CFLAGS) $(AM_LDFLAGS) $(LDFLAGS) -o $@
-SOURCES = $(libdos_a_SOURCES)
-DIST_SOURCES = $(libdos_a_SOURCES)
-ETAGS = etags
-CTAGS = ctags
-DISTFILES = $(DIST_COMMON) $(DIST_SOURCES) $(TEXINFOS) $(EXTRA_DIST)
-ACLOCAL = @ACLOCAL@
-ALSA_CFLAGS = @ALSA_CFLAGS@
-ALSA_LIBS = @ALSA_LIBS@
-AMTAR = @AMTAR@
-AUTOCONF = @AUTOCONF@
-AUTOHEADER = @AUTOHEADER@
-AUTOMAKE = @AUTOMAKE@
-AWK = @AWK@
-CC = @CC@
-CCDEPMODE = @CCDEPMODE@
-CFLAGS = @CFLAGS@
-CPP = @CPP@
-CPPFLAGS = @CPPFLAGS@
-CXX = @CXX@
-CXXDEPMODE = @CXXDEPMODE@
-CXXFLAGS = @CXXFLAGS@
-CYGPATH_W = @CYGPATH_W@
-DEFS = @DEFS@
-DEPDIR = @DEPDIR@
-ECHO_C = @ECHO_C@
-ECHO_N = @ECHO_N@
-ECHO_T = @ECHO_T@
-EGREP = @EGREP@
-EXEEXT = @EXEEXT@
-GREP = @GREP@
-INSTALL = @INSTALL@
-INSTALL_DATA = @INSTALL_DATA@
-INSTALL_PROGRAM = @INSTALL_PROGRAM@
-INSTALL_SCRIPT = @INSTALL_SCRIPT@
-INSTALL_STRIP_PROGRAM = @INSTALL_STRIP_PROGRAM@
-LDFLAGS = @LDFLAGS@
-LIBOBJS = @LIBOBJS@
-LIBS = @LIBS@
-LTLIBOBJS = @LTLIBOBJS@
-MAKEINFO = @MAKEINFO@
-MKDIR_P = @MKDIR_P@
-OBJEXT = @OBJEXT@
-PACKAGE = @PACKAGE@
-PACKAGE_BUGREPORT = @PACKAGE_BUGREPORT@
-PACKAGE_NAME = @PACKAGE_NAME@
-PACKAGE_STRING = @PACKAGE_STRING@
-PACKAGE_TARNAME = @PACKAGE_TARNAME@
-PACKAGE_URL = @PACKAGE_URL@
-PACKAGE_VERSION = @PACKAGE_VERSION@
-PATH_SEPARATOR = @PATH_SEPARATOR@
-RANLIB = @RANLIB@
-SDL_CFLAGS = @SDL_CFLAGS@
-SDL_CONFIG = @SDL_CONFIG@
-SDL_LIBS = @SDL_LIBS@
-SET_MAKE = @SET_MAKE@
-SHELL = @SHELL@
-STRIP = @STRIP@
-VERSION = @VERSION@
-WINDRES = @WINDRES@
-abs_builddir = @abs_builddir@
-abs_srcdir = @abs_srcdir@
-abs_top_builddir = @abs_top_builddir@
-abs_top_srcdir = @abs_top_srcdir@
-ac_ct_CC = @ac_ct_CC@
-ac_ct_CXX = @ac_ct_CXX@
-am__include = @am__include@
-am__leading_dot = @am__leading_dot@
-am__quote = @am__quote@
-am__tar = @am__tar@
-am__untar = @am__untar@
-bindir = @bindir@
-build = @build@
-build_alias = @build_alias@
-build_cpu = @build_cpu@
-build_os = @build_os@
-build_vendor = @build_vendor@
-builddir = @builddir@
-datadir = @datadir@
-datarootdir = @datarootdir@
-docdir = @docdir@
-dvidir = @dvidir@
-exec_prefix = @exec_prefix@
-host = @host@
-host_alias = @host_alias@
-host_cpu = @host_cpu@
-host_os = @host_os@
-host_vendor = @host_vendor@
-htmldir = @htmldir@
-includedir = @includedir@
-infodir = @infodir@
-install_sh = @install_sh@
-libdir = @libdir@
-libexecdir = @libexecdir@
-localedir = @localedir@
-localstatedir = @localstatedir@
-mandir = @mandir@
-mkdir_p = @mkdir_p@
-oldincludedir = @oldincludedir@
-pdfdir = @pdfdir@
-prefix = @prefix@
-program_transform_name = @program_transform_name@
-psdir = @psdir@
-sbindir = @sbindir@
-sharedstatedir = @sharedstatedir@
-srcdir = @srcdir@
-sysconfdir = @sysconfdir@
-target_alias = @target_alias@
-top_build_prefix = @top_build_prefix@
-top_builddir = @top_builddir@
-top_srcdir = @top_srcdir@
-AM_CPPFLAGS = -I$(top_srcdir)/include
-noinst_LIBRARIES = libdos.a
-EXTRA_DIST = scsidefs.h wnaspi32.h dos_codepages.h dos_keyboard_layout_data.h
-libdos_a_SOURCES = dos.cpp dos_devices.cpp dos_execute.cpp dos_files.cpp dos_ioctl.cpp dos_memory.cpp \
-                   dos_misc.cpp dos_classes.cpp dos_programs.cpp dos_tables.cpp \
-		   drives.cpp drives.h drive_virtual.cpp drive_local.cpp drive_cache.cpp drive_fat.cpp \
-		   drive_iso.cpp dev_con.h dos_mscdex.cpp dos_keyboard_layout.cpp \
-		   cdrom.h cdrom.cpp cdrom_ioctl_win32.cpp cdrom_aspi_win32.cpp cdrom_ioctl_linux.cpp cdrom_image.cpp \
-		   cdrom_ioctl_os2.cpp
-
-all: all-am
-
-.SUFFIXES:
-.SUFFIXES: .cpp .o .obj
-$(srcdir)/Makefile.in:  $(srcdir)/Makefile.am  $(am__configure_deps)
-	@for dep in $?; do \
-	  case '$(am__configure_deps)' in \
-	    *$$dep*) \
-	      ( cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh ) \
-	        && { if test -f $@; then exit 0; else break; fi; }; \
-	      exit 1;; \
-	  esac; \
-	done; \
-	echo ' cd $(top_srcdir) && $(AUTOMAKE) --gnu src/dos/Makefile'; \
-	$(am__cd) $(top_srcdir) && \
-	  $(AUTOMAKE) --gnu src/dos/Makefile
-.PRECIOUS: Makefile
-Makefile: $(srcdir)/Makefile.in $(top_builddir)/config.status
-	@case '$?' in \
-	  *config.status*) \
-	    cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh;; \
-	  *) \
-	    echo ' cd $(top_builddir) && $(SHELL) ./config.status $(subdir)/$@ $(am__depfiles_maybe)'; \
-	    cd $(top_builddir) && $(SHELL) ./config.status $(subdir)/$@ $(am__depfiles_maybe);; \
-	esac;
-
-$(top_builddir)/config.status: $(top_srcdir)/configure $(CONFIG_STATUS_DEPENDENCIES)
-	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
-
-$(top_srcdir)/configure:  $(am__configure_deps)
-	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
-$(ACLOCAL_M4):  $(am__aclocal_m4_deps)
-	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
-$(am__aclocal_m4_deps):
-
-clean-noinstLIBRARIES:
-	-test -z "$(noinst_LIBRARIES)" || rm -f $(noinst_LIBRARIES)
-libdos.a: $(libdos_a_OBJECTS) $(libdos_a_DEPENDENCIES) 
-	-rm -f libdos.a
-	$(libdos_a_AR) libdos.a $(libdos_a_OBJECTS) $(libdos_a_LIBADD)
-	$(RANLIB) libdos.a
-
-mostlyclean-compile:
-	-rm -f *.$(OBJEXT)
-
-distclean-compile:
-	-rm -f *.tab.c
-
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/cdrom.Po@am__quote@
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/cdrom_aspi_win32.Po@am__quote@
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/cdrom_image.Po@am__quote@
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/cdrom_ioctl_linux.Po@am__quote@
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/cdrom_ioctl_os2.Po@am__quote@
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/cdrom_ioctl_win32.Po@am__quote@
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/dos.Po@am__quote@
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/dos_classes.Po@am__quote@
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/dos_devices.Po@am__quote@
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/dos_execute.Po@am__quote@
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/dos_files.Po@am__quote@
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/dos_ioctl.Po@am__quote@
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/dos_keyboard_layout.Po@am__quote@
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/dos_memory.Po@am__quote@
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/dos_misc.Po@am__quote@
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/dos_mscdex.Po@am__quote@
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/dos_programs.Po@am__quote@
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/dos_tables.Po@am__quote@
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/drive_cache.Po@am__quote@
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/drive_fat.Po@am__quote@
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/drive_iso.Po@am__quote@
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/drive_local.Po@am__quote@
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/drive_virtual.Po@am__quote@
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/drives.Po@am__quote@
-
-.cpp.o:
-@am__fastdepCXX_TRUE@	$(CXXCOMPILE) -MT $@ -MD -MP -MF $(DEPDIR)/$*.Tpo -c -o $@ $<
-@am__fastdepCXX_TRUE@	$(am__mv) $(DEPDIR)/$*.Tpo $(DEPDIR)/$*.Po
-@AMDEP_TRUE@@am__fastdepCXX_FALSE@	source='$<' object='$@' libtool=no @AMDEPBACKSLASH@
-@AMDEP_TRUE@@am__fastdepCXX_FALSE@	DEPDIR=$(DEPDIR) $(CXXDEPMODE) $(depcomp) @AMDEPBACKSLASH@
-@am__fastdepCXX_FALSE@	$(CXXCOMPILE) -c -o $@ $<
-
-.cpp.obj:
-@am__fastdepCXX_TRUE@	$(CXXCOMPILE) -MT $@ -MD -MP -MF $(DEPDIR)/$*.Tpo -c -o $@ `$(CYGPATH_W) '$<'`
-@am__fastdepCXX_TRUE@	$(am__mv) $(DEPDIR)/$*.Tpo $(DEPDIR)/$*.Po
-@AMDEP_TRUE@@am__fastdepCXX_FALSE@	source='$<' object='$@' libtool=no @AMDEPBACKSLASH@
-@AMDEP_TRUE@@am__fastdepCXX_FALSE@	DEPDIR=$(DEPDIR) $(CXXDEPMODE) $(depcomp) @AMDEPBACKSLASH@
-@am__fastdepCXX_FALSE@	$(CXXCOMPILE) -c -o $@ `$(CYGPATH_W) '$<'`
-
-ID: $(HEADERS) $(SOURCES) $(LISP) $(TAGS_FILES)
-	list='$(SOURCES) $(HEADERS) $(LISP) $(TAGS_FILES)'; \
-	unique=`for i in $$list; do \
-	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
-	  done | \
-	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
-	      END { if (nonempty) { for (i in files) print i; }; }'`; \
-	mkid -fID $$unique
-tags: TAGS
-
-TAGS:  $(HEADERS) $(SOURCES)  $(TAGS_DEPENDENCIES) \
-		$(TAGS_FILES) $(LISP)
-	set x; \
-	here=`pwd`; \
-	list='$(SOURCES) $(HEADERS)  $(LISP) $(TAGS_FILES)'; \
-	unique=`for i in $$list; do \
-	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
-	  done | \
-	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
-	      END { if (nonempty) { for (i in files) print i; }; }'`; \
-	shift; \
-	if test -z "$(ETAGS_ARGS)$$*$$unique"; then :; else \
-	  test -n "$$unique" || unique=$$empty_fix; \
-	  if test $$# -gt 0; then \
-	    $(ETAGS) $(ETAGSFLAGS) $(AM_ETAGSFLAGS) $(ETAGS_ARGS) \
-	      "$$@" $$unique; \
-	  else \
-	    $(ETAGS) $(ETAGSFLAGS) $(AM_ETAGSFLAGS) $(ETAGS_ARGS) \
-	      $$unique; \
-	  fi; \
-	fi
-ctags: CTAGS
-CTAGS:  $(HEADERS) $(SOURCES)  $(TAGS_DEPENDENCIES) \
-		$(TAGS_FILES) $(LISP)
-	list='$(SOURCES) $(HEADERS)  $(LISP) $(TAGS_FILES)'; \
-	unique=`for i in $$list; do \
-	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
-	  done | \
-	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
-	      END { if (nonempty) { for (i in files) print i; }; }'`; \
-	test -z "$(CTAGS_ARGS)$$unique" \
-	  || $(CTAGS) $(CTAGSFLAGS) $(AM_CTAGSFLAGS) $(CTAGS_ARGS) \
-	     $$unique
-
-GTAGS:
-	here=`$(am__cd) $(top_builddir) && pwd` \
-	  && $(am__cd) $(top_srcdir) \
-	  && gtags -i $(GTAGS_ARGS) "$$here"
-
-distclean-tags:
-	-rm -f TAGS ID GTAGS GRTAGS GSYMS GPATH tags
-
-distdir: $(DISTFILES)
-	@srcdirstrip=`echo "$(srcdir)" | sed 's/[].[^$$\\*]/\\\\&/g'`; \
-	topsrcdirstrip=`echo "$(top_srcdir)" | sed 's/[].[^$$\\*]/\\\\&/g'`; \
-	list='$(DISTFILES)'; \
-	  dist_files=`for file in $$list; do echo $$file; done | \
-	  sed -e "s|^$$srcdirstrip/||;t" \
-	      -e "s|^$$topsrcdirstrip/|$(top_builddir)/|;t"`; \
-	case $$dist_files in \
-	  */*) $(MKDIR_P) `echo "$$dist_files" | \
-			   sed '/\//!d;s|^|$(distdir)/|;s,/[^/]*$$,,' | \
-			   sort -u` ;; \
-	esac; \
-	for file in $$dist_files; do \
-	  if test -f $$file || test -d $$file; then d=.; else d=$(srcdir); fi; \
-	  if test -d $$d/$$file; then \
-	    dir=`echo "/$$file" | sed -e 's,/[^/]*$$,,'`; \
-	    if test -d "$(distdir)/$$file"; then \
-	      find "$(distdir)/$$file" -type d ! -perm -700 -exec chmod u+rwx {} \;; \
-	    fi; \
-	    if test -d $(srcdir)/$$file && test $$d != $(srcdir); then \
-	      cp -fpR $(srcdir)/$$file "$(distdir)$$dir" || exit 1; \
-	      find "$(distdir)/$$file" -type d ! -perm -700 -exec chmod u+rwx {} \;; \
-	    fi; \
-	    cp -fpR $$d/$$file "$(distdir)$$dir" || exit 1; \
-	  else \
-	    test -f "$(distdir)/$$file" \
-	    || cp -p $$d/$$file "$(distdir)/$$file" \
-	    || exit 1; \
-	  fi; \
-	done
-check-am: all-am
-check: check-am
-all-am: Makefile $(LIBRARIES)
-installdirs:
-install: install-am
-install-exec: install-exec-am
-install-data: install-data-am
-uninstall: uninstall-am
-
-install-am: all-am
-	@$(MAKE) $(AM_MAKEFLAGS) install-exec-am install-data-am
-
-installcheck: installcheck-am
-install-strip:
-	$(MAKE) $(AM_MAKEFLAGS) INSTALL_PROGRAM="$(INSTALL_STRIP_PROGRAM)" \
-	  install_sh_PROGRAM="$(INSTALL_STRIP_PROGRAM)" INSTALL_STRIP_FLAG=-s \
-	  `test -z '$(STRIP)' || \
-	    echo "INSTALL_PROGRAM_ENV=STRIPPROG='$(STRIP)'"` install
-mostlyclean-generic:
-
-clean-generic:
-
-distclean-generic:
-	-test -z "$(CONFIG_CLEAN_FILES)" || rm -f $(CONFIG_CLEAN_FILES)
-	-test . = "$(srcdir)" || test -z "$(CONFIG_CLEAN_VPATH_FILES)" || rm -f $(CONFIG_CLEAN_VPATH_FILES)
-
-maintainer-clean-generic:
-	@echo "This command is intended for maintainers to use"
-	@echo "it deletes files that may require special tools to rebuild."
-clean: clean-am
-
-clean-am: clean-generic clean-noinstLIBRARIES mostlyclean-am
-
-distclean: distclean-am
-	-rm -rf ./$(DEPDIR)
-	-rm -f Makefile
-distclean-am: clean-am distclean-compile distclean-generic \
-	distclean-tags
-
-dvi: dvi-am
-
-dvi-am:
-
-html: html-am
-
-html-am:
-
-info: info-am
-
-info-am:
-
-install-data-am:
-
-install-dvi: install-dvi-am
-
-install-dvi-am:
-
-install-exec-am:
-
-install-html: install-html-am
-
-install-html-am:
-
-install-info: install-info-am
-
-install-info-am:
-
-install-man:
-
-install-pdf: install-pdf-am
-
-install-pdf-am:
-
-install-ps: install-ps-am
-
-install-ps-am:
-
-installcheck-am:
-
-maintainer-clean: maintainer-clean-am
-	-rm -rf ./$(DEPDIR)
-	-rm -f Makefile
-maintainer-clean-am: distclean-am maintainer-clean-generic
-
-mostlyclean: mostlyclean-am
-
-mostlyclean-am: mostlyclean-compile mostlyclean-generic
-
-pdf: pdf-am
-
-pdf-am:
-
-ps: ps-am
-
-ps-am:
-
-uninstall-am:
-
-.MAKE: install-am install-strip
-
-.PHONY: CTAGS GTAGS all all-am check check-am clean clean-generic \
-	clean-noinstLIBRARIES ctags distclean distclean-compile \
-	distclean-generic distclean-tags distdir dvi dvi-am html \
-	html-am info info-am install install-am install-data \
-	install-data-am install-dvi install-dvi-am install-exec \
-	install-exec-am install-html install-html-am install-info \
-	install-info-am install-man install-pdf install-pdf-am \
-	install-ps install-ps-am install-strip installcheck \
-	installcheck-am installdirs maintainer-clean \
-	maintainer-clean-generic mostlyclean mostlyclean-compile \
-	mostlyclean-generic pdf pdf-am ps ps-am tags uninstall \
-	uninstall-am
-
-
-# Tell versions [3.59,3.63) of GNU make to not export all variables.
-# Otherwise a system limit (for SysV at least) may be exceeded.
-.NOEXPORT:
diff -Nur dosbox-0.74/src/dos/scsidefs.h dosbox-0.74.patch/src/dos/scsidefs.h
--- dosbox-0.74/src/dos/scsidefs.h	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/dos/scsidefs.h	2016-12-11 18:35:15.526284006 +0100
@@ -1,12 +1,7 @@
 /* Got it from Bochs */
 
-/////////////////////////////////////////////////////////////////////////
-// $Id: scsidefs.h,v 1.3 2005-07-21 12:49:52 qbix79 Exp $
-/////////////////////////////////////////////////////////////////////////
-//
 //
 // iodev/scsidefs.h
-// $Id: scsidefs.h,v 1.3 2005-07-21 12:49:52 qbix79 Exp $
 //
 // This file was copied from ... ?
 //
diff -Nur dosbox-0.74/src/dosbox.cpp dosbox-0.74.patch/src/dosbox.cpp
--- dosbox-0.74/src/dosbox.cpp	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/dosbox.cpp	2016-12-11 18:35:15.526284006 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: dosbox.cpp,v 1.150 2009-11-03 20:17:42 qbix79 Exp $ */
 
 #include <stdlib.h>
 #include <stdarg.h>
@@ -42,6 +41,7 @@
 #include "mapper.h"
 #include "ints/int10.h"
 #include "render.h"
+#include "pci_bus.h"
 
 Config * control;
 MachineType machine;
@@ -74,6 +74,10 @@
 void MIDI_Init(Section*);
 void HARDWARE_Init(Section*);
 
+#if defined(PCI_FUNCTIONALITY_ENABLED)
+void PCI_Init(Section*);
+#endif
+
 
 void KEYBOARD_Init(Section*);	//TODO This should setup INT 16 too but ok ;)
 void JOYSTICK_Init(Section*);
@@ -129,10 +133,11 @@
 	Bits ret;
 	while (1) {
 		if (PIC_RunQueue()) {
-			ret=(*cpudecoder)();
+			ret = (*cpudecoder)();
 			if (GCC_UNLIKELY(ret<0)) return 1;
 			if (ret>0) {
-				Bitu blah=(*CallBack_Handlers[ret])();
+				if (GCC_UNLIKELY(ret >= CB_MAX)) return 0;
+				Bitu blah = (*CallBack_Handlers[ret])();
 				if (GCC_UNLIKELY(blah)) return blah;
 			}
 #if C_DEBUG
@@ -174,7 +179,7 @@
 					Bit32s new_cmax = CPU_CycleMax;
 					Bit64s cproc = (Bit64s)CPU_CycleMax * (Bit64s)ticksScheduled;
 					if (cproc > 0) {
-						/* ignore the cycles added due to the io delay code in order
+						/* ignore the cycles added due to the IO delay code in order
 						   to have smoother auto cycle adjustments */
 						double ratioremoved = (double) CPU_IODelayRemoved / (double) cproc;
 						if (ratioremoved < 1.0) {
@@ -184,10 +189,13 @@
 							if (ticksScheduled >= 250 && ticksDone < 10 && ratio > 20480) 
 								ratio = 20480;
 							Bit64s cmax_scaled = (Bit64s)CPU_CycleMax * (Bit64s)ratio;
+							/* The auto cycle code seems reliable enough to disable the fast cut back code.
+							 * This should improve the fluency of complex games.
 							if (ratio <= 1024) 
 								new_cmax = (Bit32s)(cmax_scaled / (Bit64s)1024);
 							else 
-								new_cmax = (Bit32s)(1 + (CPU_CycleMax >> 1) + cmax_scaled / (Bit64s)2048);
+							 */
+							new_cmax = (Bit32s)(1 + (CPU_CycleMax >> 1) + cmax_scaled / (Bit64s)2048);
 						}
 					}
 
@@ -333,14 +341,14 @@
 	const char* machines[] = {
 		"hercules", "cga", "tandy", "pcjr", "ega",
 		"vgaonly", "svga_s3", "svga_et3000", "svga_et4000",
-		 "svga_paradise", "vesa_nolfb", "vesa_oldvbe", 0 };
+		"svga_paradise", "vesa_nolfb", "vesa_oldvbe", 0 };
 	secprop=control->AddSection_prop("dosbox",&DOSBOX_RealInit);
 	Pstring = secprop->Add_path("language",Property::Changeable::Always,"");
 	Pstring->Set_help("Select another language file.");
 
 	Pstring = secprop->Add_string("machine",Property::Changeable::OnlyAtStart,"svga_s3");
 	Pstring->Set_values(machines);
-	Pstring->Set_help("The type of machine tries to emulate.");
+	Pstring->Set_help("The type of machine DOSBox tries to emulate.");
 
 	Pstring = secprop->Add_path("captures",Property::Changeable::Always,"capture");
 	Pstring->Set_help("Directory where things like wave, midi, screenshot get captured.");
@@ -376,8 +384,8 @@
 
 	Pmulti = secprop->Add_multi("scaler",Property::Changeable::Always," ");
 	Pmulti->SetValue("normal2x");
-	Pmulti->Set_help("Scaler used to enlarge/enhance low resolution modes.\n"
-	                 "  If 'forced' is appended, then the scaler will be used even if the result might not be desired.");
+	Pmulti->Set_help("Scaler used to enlarge/enhance low resolution modes. If 'forced' is appended,\n"
+	                 "then the scaler will be used even if the result might not be desired.");
 	Pstring = Pmulti->GetSection()->Add_string("type",Property::Changeable::Always,"normal2x");
 
 	const char *scalers[] = { 
@@ -403,7 +411,8 @@
 		"normal", "simple",0 };
 	Pstring = secprop->Add_string("core",Property::Changeable::WhenIdle,"auto");
 	Pstring->Set_values(cores);
-	Pstring->Set_help("CPU Core used in emulation. auto will switch to dynamic if available and appropriate.");
+	Pstring->Set_help("CPU Core used in emulation. auto will switch to dynamic if available and\n"
+		"appropriate.");
 
 	const char* cputype_values[] = { "auto", "386", "386_slow", "486_slow", "pentium_slow", "386_prefetch", 0};
 	Pstring = secprop->Add_string("cputype",Property::Changeable::Always,"auto");
@@ -418,9 +427,10 @@
 		"Cycles can be set in 3 ways:\n"
 		"  'auto'          tries to guess what a game needs.\n"
 		"                  It usually works, but can fail for certain games.\n"
-		"  'fixed #number' will set a fixed amount of cycles. This is what you usually need if 'auto' fails.\n"
-		"                  (Example: fixed 4000).\n"
-		"  'max'           will allocate as much cycles as your computer is able to handle.\n");
+		"  'fixed #number' will set a fixed amount of cycles. This is what you usually\n"
+		"                  need if 'auto' fails (Example: fixed 4000).\n"
+		"  'max'           will allocate as much cycles as your computer is able to\n"
+		"                  handle.");
 
 	const char* cyclest[] = { "auto","fixed","max","%u",0 };
 	Pstring = Pmulti_remain->GetSection()->Add_string("type",Property::Changeable::Always,"auto");
@@ -431,7 +441,7 @@
 	
 	Pint = secprop->Add_int("cycleup",Property::Changeable::Always,10);
 	Pint->SetMinMax(1,1000000);
-	Pint->Set_help("Amount of cycles to decrease/increase with keycombo.(CTRL-F11/CTRL-F12)");
+	Pint->Set_help("Amount of cycles to decrease/increase with keycombos.(CTRL-F11/CTRL-F12)");
 
 	Pint = secprop->Add_int("cycledown",Property::Changeable::Always,20);
 	Pint->SetMinMax(1,1000000);
@@ -444,6 +454,12 @@
 	secprop->AddInitFunction(&VGA_Init);
 	secprop->AddInitFunction(&KEYBOARD_Init);
 
+
+#if defined(PCI_FUNCTIONALITY_ENABLED)
+	secprop=control->AddSection_prop("pci",&PCI_Init,false); //PCI bus
+#endif
+
+
 	secprop=control->AddSection_prop("mixer",&MIXER_Init);
 	Pbool = secprop->Add_bool("nosound",Property::Changeable::OnlyAtStart,false);
 	Pbool->Set_help("Enable silent mode, sound is still emulated though.");
@@ -478,6 +494,9 @@
 
 	Pstring = secprop->Add_string("midiconfig",Property::Changeable::WhenIdle,"");
 	Pstring->Set_help("Special configuration options for the device driver. This is usually the id of the device you want to use.\n"
+	                  "  or in the case of coreaudio, you can specify a soundfont here.\n"
+	                  "  When using a Roland MT-32 rev. 0 as midi output device, some games may require a delay in order to prevent 'buffer overflow' issues.\n"
+	                  "  In that case, add 'delaysysex', for example: midiconfig=2 delaysysex\n"
 	                  "  See the README/Manual for more details.");
 
 #if C_DEBUG
@@ -654,8 +673,13 @@
 	Pbool->Set_help("Enable XMS support.");
 
 	secprop->AddInitFunction(&EMS_Init,true);//done
-	Pbool = secprop->Add_bool("ems",Property::Changeable::WhenIdle,true);
-	Pbool->Set_help("Enable EMS support.");
+	const char* ems_settings[] = { "true", "emsboard", "emm386", "false", 0};
+	Pstring = secprop->Add_string("ems",Property::Changeable::WhenIdle,"true");
+	Pstring->Set_values(ems_settings);
+	Pstring->Set_help("Enable EMS support. The default (=true) provides the best\n"
+		"compatibility but certain applications may run better with\n"
+		"other choices, or require EMS support to be disabled (=false)\n"
+		"to work at all.");
 
 	Pbool = secprop->Add_bool("umb",Property::Changeable::WhenIdle,true);
 	Pbool->Set_help("Enable UMB support.");
@@ -682,8 +706,8 @@
 		"You can put your MOUNT lines here.\n"
 	);
 	MSG_Add("CONFIGFILE_INTRO",
-	        "# This is the configurationfile for DOSBox %s. (Please use the latest version of DOSBox)\n"
-	        "# Lines starting with a # are commentlines and are ignored by DOSBox.\n"
+	        "# This is the configuration file for DOSBox %s. (Please use the latest version of DOSBox)\n"
+	        "# Lines starting with a # are comment lines and are ignored by DOSBox.\n"
 	        "# They are used to (briefly) document the effect of each option.\n");
 	MSG_Add("CONFIG_SUGGESTED_VALUES", "Possible values");
 
diff -Nur dosbox-0.74/src/fpu/fpu.cpp dosbox-0.74.patch/src/fpu/fpu.cpp
--- dosbox-0.74/src/fpu/fpu.cpp	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/fpu/fpu.cpp	2016-12-11 18:35:15.526284006 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: fpu.cpp,v 1.31 2009-09-16 18:01:53 qbix79 Exp $ */
 
 #include "dosbox.h"
 #if C_FPU
diff -Nur dosbox-0.74/src/fpu/fpu_instructions.h dosbox-0.74.patch/src/fpu/fpu_instructions.h
--- dosbox-0.74/src/fpu/fpu_instructions.h	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/fpu/fpu_instructions.h	2016-12-11 18:35:15.526284006 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: fpu_instructions.h,v 1.33 2009-05-27 09:15:41 qbix79 Exp $ */
 
 
 static void FPU_FINIT(void) {
@@ -97,7 +96,7 @@
 	test.eind.l.lower = mem_readd(addr);
 	test.eind.l.upper = mem_readd(addr+4);
 	test.begin = mem_readw(addr+8);
-
+   
 	Bit64s exp64 = (((test.begin&0x7fff) - BIAS80));
 	Bit64s blah = ((exp64 >0)?exp64:-exp64)&0x3ff;
 	Bit64s exp64final = ((exp64 >0)?blah:-blah) +BIAS64;
@@ -106,6 +105,11 @@
 	Bit64s sign = (test.begin&0x8000)?1:0;
 	FPU_Reg result;
 	result.ll = (sign <<63)|(exp64final << 52)| mant64;
+
+	if(test.eind.l.lower == 0 && test.eind.l.upper == 0x80000000 && (test.begin&0x7fff) == 0x7fff) {
+		//Detect INF and -INF (score 3.11 when drawing a slur.)
+		result.d = sign?-HUGE_VAL:HUGE_VAL;
+	}
 	return result.d;
 
 	//mant64= test.mant80/2***64    * 2 **53 
diff -Nur dosbox-0.74/src/fpu/fpu_instructions_x86.h dosbox-0.74.patch/src/fpu/fpu_instructions_x86.h
--- dosbox-0.74/src/fpu/fpu_instructions_x86.h	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/fpu/fpu_instructions_x86.h	2016-12-11 18:35:15.526284006 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: fpu_instructions_x86.h,v 1.7 2009-05-27 09:15:41 qbix79 Exp $ */
 
 
 // #define WEAK_EXCEPTIONS
@@ -313,23 +312,7 @@
 #endif
 
 // handles fdiv,fdivr
-#ifdef WEAK_EXCEPTIONS
-#define FPUD_ARITH3(op)						\
-		Bit16u save_cw;						\
-		__asm {								\
-		__asm	fnstcw	save_cw				\
-		__asm	mov		eax, op1			\
-		__asm	shl		eax, 4				\
-		__asm	fldcw	fpu.cw_mask_all		\
-		__asm	mov		ebx, op2			\
-		__asm	shl		ebx, 4				\
-		__asm	fld		TBYTE PTR fpu.p_regs[eax].m1	\
-		__asm	fld		TBYTE PTR fpu.p_regs[ebx].m1	\
-		__asm	op		st(1), st(0)		\
-		__asm	fstp	TBYTE PTR fpu.p_regs[eax].m1	 \
-		__asm	fldcw	save_cw				\
-		}
-#else
+// (This is identical to FPUD_ARITH1 but without a WEAK_EXCEPTIONS variant)
 #define FPUD_ARITH3(op)						\
 		Bit16u new_sw,save_cw;				\
 		__asm {								\
@@ -348,24 +331,9 @@
 		__asm	fldcw	save_cw				\
 		}									\
 		fpu.sw=(new_sw&0xffbf)|(fpu.sw&0x80ff);
-#endif
 
 // handles fdiv,fdivr
-#ifdef WEAK_EXCEPTIONS
-#define FPUD_ARITH3_EA(op)					\
-		Bit16u save_cw;						\
-		__asm {								\
-		__asm	fnstcw	save_cw				\
-		__asm	mov		eax, op1			\
-		__asm	fldcw	fpu.cw_mask_all		\
-		__asm	shl		eax, 4				\
-		__asm	fld		TBYTE PTR fpu.p_regs[eax].m1	\
-		__asm	fxch	\
-		__asm	op		st(1), st(0)		\
-		__asm	fstp	TBYTE PTR fpu.p_regs[eax].m1	 \
-		__asm	fldcw	save_cw				\
-		}
-#else
+// (This is identical to FPUD_ARITH1_EA but without a WEAK_EXCEPTIONS variant)
 #define FPUD_ARITH3_EA(op)					\
 		Bit16u new_sw,save_cw;				\
 		__asm {								\
@@ -382,10 +350,9 @@
 		__asm	fldcw	save_cw				\
 		}									\
 		fpu.sw=(new_sw&0xffbf)|(fpu.sw&0x80ff);
-#endif
 
 // handles fprem,fprem1,fscale
-#define FPUD_REMINDER(op)			\
+#define FPUD_REMAINDER(op)			\
 		Bit16u new_sw;				\
 		__asm {						\
 		__asm	mov		eax, TOP	\
@@ -533,6 +500,8 @@
 
 #else
 
+// !defined _MSC_VER
+
 #ifdef WEAK_EXCEPTIONS
 #define clx
 #else
@@ -542,55 +511,44 @@
 #ifdef WEAK_EXCEPTIONS
 #define FPUD_LOAD(op,szI,szA)				\
 		__asm__ volatile (					\
-			"movl		$128, %%eax		\n"	\
-			"shl		$4, %0			\n"	\
-			#op #szA "	(%1, %%eax)		\n"	\
-			"fstpt		(%1, %0)		"	\
-			:								\
-			:	"r" (store_to), "r" (fpu.p_regs)	\
-			:	"eax", "memory"						\
+			#op #szA "	%1				\n"	\
+			"fstpt		%0				"	\
+			:	"=m" (fpu.p_regs[store_to])	\
+			:	"m" (fpu.p_regs[8])			\
 		);
 #else
 #define FPUD_LOAD(op,szI,szA)				\
 		Bit16u new_sw;						\
 		__asm__ volatile (					\
-			"movl		$8, %%eax		\n"	\
-			"shl		$4, %%eax		\n"	\
-			"shl		$4, %1			\n"	\
 			"fclex						\n"	\
-			#op #szA "	(%2, %%eax)		\n"	\
+			#op #szA "	%2				\n"	\
 			"fnstsw		%0				\n"	\
-			"fstpt		(%2, %1)		"	\
-			:	"=m" (new_sw)				\
-			:	"r" (store_to), "r" (fpu.p_regs)	\
-			:	"eax", "memory"						\
+			"fstpt		%1				"	\
+			:	"=&am" (new_sw), "=m" (fpu.p_regs[store_to])		\
+			:	"m" (fpu.p_regs[8])			\
 		);									\
-		fpu.sw=(new_sw&0xffbf)|(fpu.sw&0x80ff);
+		fpu.sw=(new_sw&exc_mask)|(fpu.sw&0x80ff);
 #endif
 
 #ifdef WEAK_EXCEPTIONS
 #define FPUD_LOAD_EA(op,szI,szA)			\
 		__asm__ volatile (					\
-			"movl		$128, %%eax		\n"	\
-			#op #szA "	(%0, %%eax)		\n"	\
+			#op #szA "	%0				\n"	\
 			:								\
-			:	"r" (fpu.p_regs)			\
-			:	"eax", "memory"				\
+			:	"m" (fpu.p_regs[8])			\
 		);
 #else
 #define FPUD_LOAD_EA(op,szI,szA)			\
 		Bit16u new_sw;						\
 		__asm__ volatile (					\
-			"movl		$8, %%eax		\n"	\
-			"shl		$4, %%eax		\n"	\
 			"fclex						\n"	\
-			#op #szA "	(%1, %%eax)		\n"	\
+			#op #szA "	%1				\n"	\
 			"fnstsw		%0				\n"	\
-			:	"=m" (new_sw)				\
-			:	"r" (fpu.p_regs)			\
-			:	"eax", "memory"				\
+			:	"=&am" (new_sw)				\
+			:	"m" (fpu.p_regs[8])			\
+			:								\
 		);									\
-		fpu.sw=(new_sw&0xffbf)|(fpu.sw&0x80ff);
+		fpu.sw=(new_sw&exc_mask)|(fpu.sw&0x80ff);
 #endif
 
 #ifdef WEAK_EXCEPTIONS
@@ -598,15 +556,12 @@
 		Bit16u save_cw;						\
 		__asm__ volatile (					\
 			"fnstcw		%0				\n"	\
-			"shll		$4, %1			\n"	\
 			"fldcw		%3				\n"	\
-			"movl		$128, %%eax		\n"	\
-			"fldt		(%2, %1)		\n"	\
-			#op #szA "	(%2, %%eax)		\n"	\
+			"fldt		%2				\n"	\
+			#op #szA "	%1				\n"	\
 			"fldcw		%0				"	\
-			:	"=m" (save_cw)				\
-			:	"r" (TOP), "r" (fpu.p_regs), "m" (fpu.cw_mask_all)		\
-			:	"eax", "memory"						\
+			:	"=m" (save_cw), "=m" (fpu.p_regs[8])	\
+			:	"m" (fpu.p_regs[TOP]), "m" (fpu.cw_mask_all)		\
 		);
 #else
 #define FPUD_STORE(op,szI,szA)				\
@@ -614,18 +569,14 @@
 		__asm__ volatile (					\
 			"fnstcw		%1				\n"	\
 			"fldcw		%4				\n"	\
-			"shll		$4, %2			\n"	\
-			"movl		$8, %%eax		\n"	\
-			"shl		$4, %%eax		\n"	\
-			"fldt		(%3, %2)		\n"	\
-			clx" 						\n"	\
-			#op #szA "	(%3, %%eax)		\n"	\
+			"fldt		%3				\n"	\
+			"fclex 						\n"	\
+			#op #szA "	%2				\n"	\
 			"fnstsw		%0				\n"	\
 			"fldcw		%1				"	\
-			:	"=m" (new_sw), "=m" (save_cw)	\
-			:	"r" (TOP), "r" (fpu.p_regs), "m" (fpu.cw_mask_all)		\
-			:	"eax", "memory"						\
-		);										\
+			:	"=&am" (new_sw), "=m" (save_cw), "=m" (fpu.p_regs[8])	\
+			:	"m" (fpu.p_regs[TOP]), "m" (fpu.cw_mask_all)			\
+		);									\
 		fpu.sw=(new_sw&exc_mask)|(fpu.sw&0x80ff);
 #endif
 
@@ -633,15 +584,12 @@
 #define FPUD_TRIG(op)						\
 		Bit16u new_sw;						\
 		__asm__ volatile (					\
-			"shll		$4, %1			\n"	\
-			"fldt		(%2, %1)		\n"	\
+			"fldt		%1				\n"	\
 			clx" 						\n"	\
 			#op" 						\n"	\
 			"fnstsw		%0				\n"	\
-			"fstpt		(%2, %1)		"	\
-			:	"=m" (new_sw)				\
-			:	"r" (TOP), "r" (fpu.p_regs)	\
-			:	"memory"					\
+			"fstpt		%1				"	\
+			:	"=&am" (new_sw), "+m" (fpu.p_regs[TOP])		\
 		);									\
 		fpu.sw=(new_sw&exc_mask)|(fpu.sw&0x80ff);
 
@@ -649,24 +597,20 @@
 #define FPUD_SINCOS()					\
 		Bit16u new_sw;						\
 		__asm__ volatile (					\
-			"movl		%1, %%eax		\n"	\
-			"shll		$4, %1			\n"	\
-			"decl		%%eax			\n"	\
-			"andl		$7, %%eax		\n"	\
-			"shll		$4, %%eax		\n"	\
-			"fldt		(%2, %1)		\n"	\
+			"fldt		%1				\n"	\
 			clx" 						\n"	\
 			"fsincos					\n"	\
 			"fnstsw		%0				\n"	\
-			"fstpt		(%2, %%eax)		\n"	\
+			"fstpt		%2				\n"	\
 			"movw		%0, %%ax		\n"	\
 			"sahf						\n"	\
-			"jp			argument_too_large1		\n"	\
-			"fstpt		(%2, %1)		\n"	\
-			"argument_too_large1:		"	\
-			:	"=m" (new_sw)				\
-			:	"r" (TOP), "r" (fpu.p_regs)	\
-			:	"eax", "cc", "memory"		\
+			"jp			1f				\n"	\
+			"fstpt		%1				\n"	\
+			"1:							"	\
+			:	"=m" (new_sw), "+m" (fpu.p_regs[TOP]),	\
+				"=m" (fpu.p_regs[(TOP-1)&7])			\
+			:								\
+			:	"ax", "cc"					\
 		);									\
 		fpu.sw=(new_sw&exc_mask)|(fpu.sw&0x80ff);		\
 		if ((new_sw&0x0400)==0) FPU_PREP_PUSH();
@@ -675,24 +619,20 @@
 #define FPUD_PTAN()						\
 		Bit16u new_sw;						\
 		__asm__ volatile (					\
-			"movl		%1, %%eax		\n"	\
-			"shll		$4, %1			\n"	\
-			"decl		%%eax			\n"	\
-			"andl		$7, %%eax		\n"	\
-			"shll		$4, %%eax		\n"	\
-			"fldt		(%2, %1)		\n"	\
+			"fldt		%1				\n"	\
 			clx" 						\n"	\
 			"fptan 						\n"	\
 			"fnstsw		%0				\n"	\
-			"fstpt		(%2, %%eax)		\n"	\
+			"fstpt		%2				\n"	\
 			"movw		%0, %%ax		\n"	\
 			"sahf						\n"	\
-			"jp			argument_too_large2		\n"	\
-			"fstpt		(%2, %1)		\n"	\
-			"argument_too_large2:		"	\
-			:	"=m" (new_sw)				\
-			:	"r" (TOP), "r" (fpu.p_regs)	\
-			:	"eax", "cc", "memory"		\
+			"jp			1f				\n"	\
+			"fstpt		%1				\n"	\
+			"1:							"	\
+			:	"=m" (new_sw), "+m" (fpu.p_regs[TOP]),	\
+				"=m" (fpu.p_regs[(TOP-1)&7])			\
+			:								\
+			:	"ax", "cc"					\
 		);									\
 		fpu.sw=(new_sw&exc_mask)|(fpu.sw&0x80ff);		\
 		if ((new_sw&0x0400)==0) FPU_PREP_PUSH();
@@ -701,40 +641,27 @@
 #ifdef WEAK_EXCEPTIONS
 #define FPUD_XTRACT						\
 		__asm__ volatile (					\
-			"movl		%0, %%eax		\n"	\
-			"shll		$4, %0			\n"	\
-			"decl		%%eax			\n"	\
-			"andl		$7, %%eax		\n"	\
-			"shll		$4, %%eax		\n"	\
-			"fldt		(%1, %0)		\n"	\
+			"fldt		%0				\n"	\
 			"fxtract					\n"	\
-			"fstpt		(%1, %%eax)		\n"	\
-			"fstpt		(%1, %0)		"	\
-			:								\
-			:	"r" (TOP), "r" (fpu.p_regs)	\
-			:	"eax", "memory"				\
+			"fstpt		%1				\n"	\
+			"fstpt		%0				"	\
+			:	"+m" (fpu.p_regs[TOP]), "=m" (fpu.p_regs[(TOP-1)&7])	\
 		);									\
 		FPU_PREP_PUSH();
 #else
 #define FPUD_XTRACT						\
 		Bit16u new_sw;						\
 		__asm__ volatile (					\
-			"movl		%1, %%eax		\n"	\
-			"shll		$4, %1			\n"	\
-			"decl		%%eax			\n"	\
-			"andl		$7, %%eax		\n"	\
-			"shll		$4, %%eax		\n"	\
-			"fldt		(%2, %1)		\n"	\
+			"fldt		%1				\n"	\
 			"fclex						\n"	\
 			"fxtract					\n"	\
 			"fnstsw		%0				\n"	\
-			"fstpt		(%2, %%eax)		\n"	\
-			"fstpt		(%2, %1)		"	\
-			:	"=m" (new_sw)				\
-			:	"r" (TOP), "r" (fpu.p_regs)	\
-			:	"eax", "memory"						\
+			"fstpt		%2				\n"	\
+			"fstpt		%1				"	\
+			:	"=&am" (new_sw), "+m" (fpu.p_regs[TOP]),	\
+				"=m" (fpu.p_regs[(TOP-1)&7])			\
 		);									\
-		fpu.sw=(new_sw&0xffbf)|(fpu.sw&0x80ff);		\
+		fpu.sw=(new_sw&exc_mask)|(fpu.sw&0x80ff);		\
 		FPU_PREP_PUSH();
 #endif
 
@@ -744,36 +671,30 @@
 		Bit16u save_cw;						\
 		__asm__ volatile (					\
 			"fnstcw		%0				\n"	\
-			"fldcw		%4				\n"	\
-			"shll		$4, %2			\n"	\
-			"shll		$4, %1			\n"	\
-			"fldt		(%3, %2)		\n"	\
-			"fldt		(%3, %1)		\n"	\
+			"fldcw		%3				\n"	\
+			"fldt		%2				\n"	\
+			"fldt		%1				\n"	\
 			#op"						\n"	\
-			"fstpt		(%3, %1)		\n"	\
+			"fstpt		%1				\n"	\
 			"fldcw		%0				"	\
-			:	"=m" (save_cw)		\
-			:	"r" (op1), "r" (op2), "r" (fpu.p_regs), "m" (fpu.cw_mask_all)		\
-			:	"memory"				\
+			:	"=m" (save_cw), "+m" (fpu.p_regs[op1])				\
+			:	"m" (fpu.p_regs[op2]), "m" (fpu.cw_mask_all)		\
 		);
 #else
 #define FPUD_ARITH1(op)						\
 		Bit16u new_sw,save_cw;				\
 		__asm__ volatile (					\
 			"fnstcw		%1				\n"	\
-			"fldcw		%5				\n"	\
-			"shll		$4, %3			\n"	\
-			"shll		$4, %2			\n"	\
-			"fldt		(%4, %3)		\n"	\
-			"fldt		(%4, %2)		\n"	\
-			clx" 						\n"	\
+			"fldcw		%4				\n"	\
+			"fldt		%3				\n"	\
+			"fldt		%2				\n"	\
+			"fclex 						\n"	\
 			#op"						\n"	\
 			"fnstsw		%0				\n"	\
-			"fstpt		(%4, %2)		\n"	\
+			"fstpt		%2				\n"	\
 			"fldcw		%1				"	\
-			:	"=m" (new_sw), "=m" (save_cw)		\
-			:	"r" (op1), "r" (op2), "r" (fpu.p_regs), "m" (fpu.cw_mask_all)		\
-			:	"memory"				\
+			:	"=&am" (new_sw), "=m" (save_cw), "+m" (fpu.p_regs[op1])	\
+			:	"m" (fpu.p_regs[op2]), "m" (fpu.cw_mask_all)		\
 		);									\
 		fpu.sw=(new_sw&exc_mask)|(fpu.sw&0x80ff);
 #endif
@@ -784,32 +705,28 @@
 		Bit16u save_cw;						\
 		__asm__ volatile (					\
 			"fnstcw		%0				\n"	\
-			"fldcw		%3				\n"	\
-			"shll		$4, %1			\n"	\
-			"fldt		(%2, %1)		\n"	\
+			"fldcw		%2				\n"	\
+			"fldt		%1				\n"	\
 			#op"						\n"	\
-			"fstpt		(%2, %1)		\n"	\
+			"fstpt		%1				\n"	\
 			"fldcw		%0				"	\
-			:	"=m" (save_cw)		\
-			:	"r" (op1), "r" (fpu.p_regs), "m" (fpu.cw_mask_all)		\
-			:	"memory"				\
+			:	"=m" (save_cw), "+m" (fpu.p_regs[op1])		\
+			:	"m" (fpu.cw_mask_all)		\
 		);
 #else
 #define FPUD_ARITH1_EA(op)					\
 		Bit16u new_sw,save_cw;				\
 		__asm__ volatile (					\
 			"fnstcw		%1				\n"	\
-			"fldcw		%4				\n"	\
-			"shll		$4, %2			\n"	\
-			"fldt		(%3, %2)		\n"	\
-			clx" 						\n"	\
+			"fldcw		%3				\n"	\
+			"fldt		%2				\n"	\
+			"fclex 						\n"	\
 			#op"						\n"	\
 			"fnstsw		%0				\n"	\
-			"fstpt		(%3, %2)		\n"	\
+			"fstpt		%2				\n"	\
 			"fldcw		%1				"	\
-			:	"=m" (new_sw), "=m" (save_cw)		\
-			:	"r" (op1), "r" (fpu.p_regs), "m" (fpu.cw_mask_all)		\
-			:	"memory"				\
+			:	"=&am" (new_sw), "=m" (save_cw), "+m" (fpu.p_regs[op1])	\
+			:	"m" (fpu.cw_mask_all)		\
 		);									\
 		fpu.sw=(new_sw&exc_mask)|(fpu.sw&0x80ff);
 #endif
@@ -820,131 +737,82 @@
 		Bit16u save_cw;						\
 		__asm__ volatile (					\
 			"fnstcw		%0				\n"	\
-			"fldcw		%3				\n"	\
-			"shll		$4, %1			\n"	\
-			"fldt		(%2, %1)		\n"	\
+			"fldcw		%2				\n"	\
+			"fldt		%1				\n"	\
 			#op" 						\n"	\
-			"fstpt		(%2, %1)		\n"	\
+			"fstpt		%1				\n"	\
 			"fldcw		%0				"	\
-			:	"=m" (save_cw)				\
-			:	"r" (TOP), "r" (fpu.p_regs), "m" (fpu.cw_mask_all)		\
-			:	"memory"				\
+			:	"=m" (save_cw), "+m" (fpu.p_regs[TOP])		\
+			:	"m" (fpu.cw_mask_all)		\
 		);
 #else
 #define FPUD_ARITH2(op)						\
 		Bit16u new_sw,save_cw;				\
 		__asm__ volatile (					\
 			"fnstcw		%1				\n"	\
-			"fldcw		%4				\n"	\
-			"shll		$4, %2			\n"	\
-			"fldt		(%3, %2)		\n"	\
-			clx" 						\n"	\
+			"fldcw		%3				\n"	\
+			"fldt		%2				\n"	\
+			"fclex 						\n"	\
 			#op" 						\n"	\
 			"fnstsw		%0				\n"	\
-			"fstpt		(%3, %2)		\n"	\
+			"fstpt		%2				\n"	\
 			"fldcw		%1				"	\
-			:	"=m" (new_sw), "=m" (save_cw)	\
-			:	"r" (TOP), "r" (fpu.p_regs), "m" (fpu.cw_mask_all)		\
-			:	"memory"				\
+			:	"=&am" (new_sw), "=m" (save_cw), "+m" (fpu.p_regs[TOP])	\
+			:	"m" (fpu.cw_mask_all)		\
 		);										\
 		fpu.sw=(new_sw&exc_mask)|(fpu.sw&0x80ff);
 #endif
 
 // handles fdiv,fdivr
-#ifdef WEAK_EXCEPTIONS
-#define FPUD_ARITH3(op)						\
-		Bit16u save_cw;						\
-		__asm__ volatile (					\
-			"fnstcw		%0				\n"	\
-			"fldcw		%4				\n"	\
-			"shll		$4, %2			\n"	\
-			"shll		$4, %1			\n"	\
-			"fldt		(%3, %2)		\n"	\
-			"fldt		(%3, %1)		\n"	\
-			#op"						\n"	\
-			"fstpt		(%3, %1)		\n"	\
-			"fldcw		%0				"	\
-			:	"=m" (save_cw)				\
-			:	"r" (op1), "r" (op2), "r" (fpu.p_regs), "m" (fpu.cw_mask_all)		\
-			:	"memory"					\
-		);
-#else
+// (This is identical to FPUD_ARITH1 but without a WEAK_EXCEPTIONS variant)
 #define FPUD_ARITH3(op)						\
 		Bit16u new_sw,save_cw;				\
 		__asm__ volatile (					\
 			"fnstcw		%1				\n"	\
-			"fldcw		%5				\n"	\
-			"shll		$4, %3			\n"	\
-			"shll		$4, %2			\n"	\
-			"fldt		(%4, %3)		\n"	\
-			"fldt		(%4, %2)		\n"	\
-			"fclex						\n"	\
+			"fldcw		%4				\n"	\
+			"fldt		%3				\n"	\
+			"fldt		%2				\n"	\
+			"fclex 						\n"	\
 			#op"						\n"	\
 			"fnstsw		%0				\n"	\
-			"fstpt		(%4, %2)		\n"	\
+			"fstpt		%2				\n"	\
 			"fldcw		%1				"	\
-			:	"=m" (new_sw), "=m" (save_cw)		\
-			:	"r" (op1), "r" (op2), "r" (fpu.p_regs), "m" (fpu.cw_mask_all)		\
-			:	"memory"					\
+			:	"=&am" (new_sw), "=m" (save_cw), "+m" (fpu.p_regs[op1])	\
+			:	"m" (fpu.p_regs[op2]), "m" (fpu.cw_mask_all)		\
 		);									\
 		fpu.sw=(new_sw&0xffbf)|(fpu.sw&0x80ff);
-#endif
 
 // handles fdiv,fdivr
-#ifdef WEAK_EXCEPTIONS
-#define FPUD_ARITH3_EA(op)					\
-		Bit16u save_cw;						\
-		__asm__ volatile (					\
-			"fnstcw		%0				\n"	\
-			"fldcw		%3				\n"	\
-			"shll		$4, %1			\n"	\
-			"fldt		(%2, %1)		\n"	\
-			#op"						\n"	\
-			"fstpt		(%2, %1)		\n"	\
-			"fldcw		%0				"	\
-			:	"=m" (save_cw)				\
-			:	"r" (op1), "r" (fpu.p_regs), "m" (fpu.cw_mask_all)		\
-			:	"memory"					\
-		);
-#else
+// (This is identical to FPUD_ARITH1_EA but without a WEAK_EXCEPTIONS variant)
 #define FPUD_ARITH3_EA(op)					\
 		Bit16u new_sw,save_cw;				\
 		__asm__ volatile (					\
 			"fnstcw		%1				\n"	\
-			"fldcw		%4				\n"	\
-			"shll		$4, %2			\n"	\
-			"fldt		(%3, %2)		\n"	\
-			"fclex						\n"	\
+			"fldcw		%3				\n"	\
+			"fldt		%2				\n"	\
+			"fclex 						\n"	\
 			#op"						\n"	\
 			"fnstsw		%0				\n"	\
-			"fstpt		(%3, %2)		\n"	\
+			"fstpt		%2				\n"	\
 			"fldcw		%1				"	\
-			:	"=m" (new_sw), "=m" (save_cw)		\
-			:	"r" (op1), "r" (fpu.p_regs), "m" (fpu.cw_mask_all)		\
-			:	"memory"					\
+			:	"=&am" (new_sw), "=m" (save_cw), "+m" (fpu.p_regs[op1])	\
+			:	"m" (fpu.cw_mask_all)		\
 		);									\
 		fpu.sw=(new_sw&0xffbf)|(fpu.sw&0x80ff);
-#endif
 
 // handles fprem,fprem1,fscale
-#define FPUD_REMINDER(op)					\
+#define FPUD_REMAINDER(op)					\
 		Bit16u new_sw;						\
 		__asm__ volatile (					\
-			"movl		%1, %%eax		\n"	\
-			"incl		%%eax			\n"	\
-			"andl		$7, %%eax		\n"	\
-			"shll		$4, %%eax		\n"	\
-			"shll		$4, %1			\n"	\
-			"fldt		(%2, %%eax)		\n"	\
-			"fldt		(%2, %1)		\n"	\
+			"fldt		%2				\n"	\
+			"fldt		%1				\n"	\
 			"fclex						\n"	\
 			#op" 						\n"	\
 			"fnstsw		%0				\n"	\
-			"fstpt		(%2, %1)		\n"	\
+			"fstpt		%1				\n"	\
 			"fstp		%%st(0)			"	\
-			:	"=m" (new_sw)				\
-			:	"r" (TOP), "r" (fpu.p_regs)	\
-			:	"eax", "memory"						\
+			:	"=&am" (new_sw), "+m" (fpu.p_regs[TOP])	\
+			:	"m" (fpu.p_regs[(TOP+1)&7])				\
 		);									\
 		fpu.sw=(new_sw&0xffbf)|(fpu.sw&0x80ff);
 
@@ -952,16 +820,13 @@
 #define FPUD_COMPARE(op)					\
 		Bit16u new_sw;						\
 		__asm__ volatile (					\
-			"shll		$4, %2			\n"	\
-			"shll		$4, %1			\n"	\
-			"fldt		(%3, %2)		\n"	\
-			"fldt		(%3, %1)		\n"	\
+			"fldt		%2				\n"	\
+			"fldt		%1				\n"	\
 			clx" 						\n"	\
 			#op" 						\n"	\
 			"fnstsw		%0				"	\
-			:	"=m" (new_sw)				\
-			:	"r" (op1), "r" (op2), "r" (fpu.p_regs) 		\
-			:	"memory"					\
+			:	"=&am" (new_sw)				\
+			:	"m" (fpu.p_regs[op1]), "m" (fpu.p_regs[op2])	\
 		);									\
 		fpu.sw=(new_sw&exc_mask)|(fpu.sw&0x80ff);
 
@@ -969,14 +834,12 @@
 #define FPUD_COMPARE_EA(op)					\
 		Bit16u new_sw;						\
 		__asm__ volatile (					\
-			"shll		$4, %1			\n"	\
-			"fldt		(%2, %1)		\n"	\
+			"fldt		%1				\n"	\
 			clx" 						\n"	\
 			#op" 						\n"	\
 			"fnstsw		%0				"	\
-			:	"=m" (new_sw)				\
-			:	"r" (op1), "r" (fpu.p_regs) 		\
-			:	"memory"					\
+			:	"=&am" (new_sw)				\
+			:	"m" (fpu.p_regs[op1])		\
 		);									\
 		fpu.sw=(new_sw&exc_mask)|(fpu.sw&0x80ff);
 
@@ -984,15 +847,13 @@
 #define FPUD_EXAMINE(op)					\
 		Bit16u new_sw;						\
 		__asm__ volatile (					\
-			"shll		$4, %1			\n"	\
-			"fldt		(%2, %1)		\n"	\
+			"fldt		%1				\n"	\
 			clx" 						\n"	\
 			#op" 						\n"	\
 			"fnstsw		%0				\n"	\
 			"fstp		%%st(0)			"	\
-			:	"=m" (new_sw)				\
-			:	"r" (TOP), "r" (fpu.p_regs)	\
-			:	"memory"				\
+			:	"=&am" (new_sw)				\
+			:	"m" (fpu.p_regs[TOP])		\
 		);									\
 		fpu.sw=(new_sw&exc_mask)|(fpu.sw&0x80ff);
 
@@ -1000,40 +861,28 @@
 #ifdef WEAK_EXCEPTIONS
 #define FPUD_WITH_POP(op)					\
 		__asm__ volatile (					\
-			"movl		%0, %%eax		\n"	\
-			"incl		%%eax			\n"	\
-			"andl		$7, %%eax		\n"	\
-			"shll		$4, %%eax		\n"	\
-			"shll		$4, %0			\n"	\
-			"fldt		(%1, %%eax)		\n"	\
-			"fldt		(%1, %0)		\n"	\
+			"fldt		%0				\n"	\
+			"fldt		%1				\n"	\
 			#op" 						\n"	\
-			"fstpt		(%1, %%eax)		\n"	\
-			:								\
-			:	"r" (TOP), "r" (fpu.p_regs)	\
-			:	"eax", "memory"				\
+			"fstpt		%0				\n"	\
+			:	"+m" (fpu.p_regs[(TOP+1)&7])	\
+			:	"m" (fpu.p_regs[TOP])		\
 		);									\
 		FPU_FPOP();
 #else
 #define FPUD_WITH_POP(op)					\
 		Bit16u new_sw;						\
 		__asm__ volatile (					\
-			"movl		%1, %%eax		\n"	\
-			"incl		%%eax			\n"	\
-			"andl		$7, %%eax		\n"	\
-			"shll		$4, %%eax		\n"	\
-			"shll		$4, %1			\n"	\
-			"fldt		(%2, %%eax)		\n"	\
-			"fldt		(%2, %1)		\n"	\
+			"fldt		%1				\n"	\
+			"fldt		%2				\n"	\
 			"fclex						\n"	\
 			#op" 						\n"	\
 			"fnstsw		%0				\n"	\
-			"fstpt		(%2, %%eax)		\n"	\
-			:	"=m" (new_sw)				\
-			:	"r" (TOP), "r" (fpu.p_regs)	\
-			:	"eax", "memory"						\
+			"fstpt		%1				\n"	\
+			:	"=&am" (new_sw), "+m" (fpu.p_regs[(TOP+1)&7])		\
+			:	"m" (fpu.p_regs[TOP])		\
 		);									\
-		fpu.sw=(new_sw&0xffbf)|(fpu.sw&0x80ff);		\
+		fpu.sw=(new_sw&exc_mask)|(fpu.sw&0x80ff);		\
 		FPU_FPOP();
 #endif
 
@@ -1041,40 +890,28 @@
 #ifdef WEAK_EXCEPTIONS
 #define FPUD_FYL2X(op)						\
 		__asm__ volatile (					\
-			"movl		%0, %%eax		\n"	\
-			"incl		%%eax			\n"	\
-			"andl		$7, %%eax		\n"	\
-			"shll		$4, %%eax		\n"	\
-			"shll		$4, %0			\n"	\
-			"fldt		(%1, %%eax)		\n"	\
-			"fldt		(%1, %0)		\n"	\
+			"fldt		%0				\n"	\
+			"fldt		%1				\n"	\
 			#op" 						\n"	\
-			"fstpt		(%1, %%eax)		\n"	\
-			:								\
-			:	"r" (TOP), "r" (fpu.p_regs)	\
-			:	"eax", "memory"				\
+			"fstpt		%0				\n"	\
+			:	"+m" (fpu.p_regs[(TOP+1)&7])	\
+			:	"m" (fpu.p_regs[TOP]) 		\
 		);									\
 		FPU_FPOP();
 #else
 #define FPUD_FYL2X(op)						\
 		Bit16u new_sw;						\
 		__asm__ volatile (					\
-			"movl		%1, %%eax		\n"	\
-			"incl		%%eax			\n"	\
-			"andl		$7, %%eax		\n"	\
-			"shll		$4, %%eax		\n"	\
-			"shll		$4, %1			\n"	\
-			"fldt		(%2, %%eax)		\n"	\
-			"fldt		(%2, %1)		\n"	\
+			"fldt		%1				\n"	\
+			"fldt		%2				\n"	\
 			"fclex						\n"	\
 			#op" 						\n"	\
 			"fnstsw		%0				\n"	\
-			"fstpt		(%2, %%eax)		\n"	\
-			:	"=m" (new_sw)				\
-			:	"r" (TOP), "r" (fpu.p_regs)	\
-			:	"eax", "memory"				\
+			"fstpt		%1				\n"	\
+			:	"=&am" (new_sw), "+m" (fpu.p_regs[(TOP+1)&7])		\
+			:	"m" (fpu.p_regs[TOP]) 		\
 		);									\
-		fpu.sw=(new_sw&0xffbf)|(fpu.sw&0x80ff);		\
+		fpu.sw=(new_sw&exc_mask)|(fpu.sw&0x80ff);		\
 		FPU_FPOP();
 #endif
 
@@ -1082,13 +919,10 @@
 #define FPUD_LOAD_CONST(op)				\
 		FPU_PREP_PUSH();					\
 		__asm__ volatile (					\
-			"shll		$4, %0			\n"	\
 			clx" 						\n"	\
 			#op" 						\n"	\
-			"fstpt		(%1, %0)		\n"	\
-			:								\
-			:	"r" (TOP), "r" (fpu.p_regs)	\
-			:	"memory"					\
+			"fstpt		%0				\n"	\
+			:	"=m" (fpu.p_regs[TOP])		\
 		);
 
 #endif
@@ -1162,12 +996,12 @@
 
 static void FPU_FLD_I16(PhysPt addr,Bitu store_to) {
 	fpu.p_regs[8].m1 = (Bit32u)mem_readw(addr);
-	FPUD_LOAD(fild,WORD,)
+	FPUD_LOAD(fild,WORD,s)
 }
 
 static void FPU_FLD_I16_EA(PhysPt addr) {
 	fpu.p_regs[8].m1 = (Bit32u)mem_readw(addr);
-	FPUD_LOAD_EA(fild,WORD,)
+	FPUD_LOAD_EA(fild,WORD,s)
 }
 
 static void FPU_FLD_I32(PhysPt addr,Bitu store_to) {
@@ -1212,7 +1046,7 @@
 }
 
 static void FPU_FST_I16(PhysPt addr) {
-	FPUD_STORE(fistp,WORD,)
+	FPUD_STORE(fistp,WORD,s)
 	mem_writew(addr,(Bit16u)fpu.p_regs[8].m1);
 }
 
@@ -1354,11 +1188,11 @@
 }
 
 static void FPU_FPREM(void){
-	FPUD_REMINDER(fprem)
+	FPUD_REMAINDER(fprem)
 }
 
 static void FPU_FPREM1(void){
-	FPUD_REMINDER(fprem1)
+	FPUD_REMAINDER(fprem1)
 }
 
 static void FPU_FXAM(void){
@@ -1383,7 +1217,7 @@
 }
 
 static void FPU_FSCALE(void){
-	FPUD_REMINDER(fscale)
+	FPUD_REMAINDER(fscale)
 }
 
 
diff -Nur dosbox-0.74/src/fpu/Makefile.in dosbox-0.74.patch/src/fpu/Makefile.in
--- dosbox-0.74/src/fpu/Makefile.in	2010-05-12 11:57:44.000000000 +0200
+++ dosbox-0.74.patch/src/fpu/Makefile.in	1970-01-01 01:00:00.000000000 +0100
@@ -1,445 +0,0 @@
-# Makefile.in generated by automake 1.11.1 from Makefile.am.
-# @configure_input@
-
-# Copyright (C) 1994, 1995, 1996, 1997, 1998, 1999, 2000, 2001, 2002,
-# 2003, 2004, 2005, 2006, 2007, 2008, 2009  Free Software Foundation,
-# Inc.
-# This Makefile.in is free software; the Free Software Foundation
-# gives unlimited permission to copy and/or distribute it,
-# with or without modifications, as long as this notice is preserved.
-
-# This program is distributed in the hope that it will be useful,
-# but WITHOUT ANY WARRANTY, to the extent permitted by law; without
-# even the implied warranty of MERCHANTABILITY or FITNESS FOR A
-# PARTICULAR PURPOSE.
-
-@SET_MAKE@
-
-VPATH = @srcdir@
-pkgdatadir = $(datadir)/@PACKAGE@
-pkgincludedir = $(includedir)/@PACKAGE@
-pkglibdir = $(libdir)/@PACKAGE@
-pkglibexecdir = $(libexecdir)/@PACKAGE@
-am__cd = CDPATH="$${ZSH_VERSION+.}$(PATH_SEPARATOR)" && cd
-install_sh_DATA = $(install_sh) -c -m 644
-install_sh_PROGRAM = $(install_sh) -c
-install_sh_SCRIPT = $(install_sh) -c
-INSTALL_HEADER = $(INSTALL_DATA)
-transform = $(program_transform_name)
-NORMAL_INSTALL = :
-PRE_INSTALL = :
-POST_INSTALL = :
-NORMAL_UNINSTALL = :
-PRE_UNINSTALL = :
-POST_UNINSTALL = :
-build_triplet = @build@
-host_triplet = @host@
-subdir = src/fpu
-DIST_COMMON = $(srcdir)/Makefile.am $(srcdir)/Makefile.in
-ACLOCAL_M4 = $(top_srcdir)/aclocal.m4
-am__aclocal_m4_deps = $(top_srcdir)/acinclude.m4 \
-	$(top_srcdir)/configure.in
-am__configure_deps = $(am__aclocal_m4_deps) $(CONFIGURE_DEPENDENCIES) \
-	$(ACLOCAL_M4)
-mkinstalldirs = $(install_sh) -d
-CONFIG_HEADER = $(top_builddir)/config.h
-CONFIG_CLEAN_FILES =
-CONFIG_CLEAN_VPATH_FILES =
-LIBRARIES = $(noinst_LIBRARIES)
-AR = ar
-ARFLAGS = cru
-libfpu_a_AR = $(AR) $(ARFLAGS)
-libfpu_a_LIBADD =
-am_libfpu_a_OBJECTS = fpu.$(OBJEXT)
-libfpu_a_OBJECTS = $(am_libfpu_a_OBJECTS)
-DEFAULT_INCLUDES = -I.@am__isrc@ -I$(top_builddir)
-depcomp = $(SHELL) $(top_srcdir)/depcomp
-am__depfiles_maybe = depfiles
-am__mv = mv -f
-CXXCOMPILE = $(CXX) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) \
-	$(AM_CPPFLAGS) $(CPPFLAGS) $(AM_CXXFLAGS) $(CXXFLAGS)
-CXXLD = $(CXX)
-CXXLINK = $(CXXLD) $(AM_CXXFLAGS) $(CXXFLAGS) $(AM_LDFLAGS) $(LDFLAGS) \
-	-o $@
-COMPILE = $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) \
-	$(CPPFLAGS) $(AM_CFLAGS) $(CFLAGS)
-CCLD = $(CC)
-LINK = $(CCLD) $(AM_CFLAGS) $(CFLAGS) $(AM_LDFLAGS) $(LDFLAGS) -o $@
-SOURCES = $(libfpu_a_SOURCES)
-DIST_SOURCES = $(libfpu_a_SOURCES)
-ETAGS = etags
-CTAGS = ctags
-DISTFILES = $(DIST_COMMON) $(DIST_SOURCES) $(TEXINFOS) $(EXTRA_DIST)
-ACLOCAL = @ACLOCAL@
-ALSA_CFLAGS = @ALSA_CFLAGS@
-ALSA_LIBS = @ALSA_LIBS@
-AMTAR = @AMTAR@
-AUTOCONF = @AUTOCONF@
-AUTOHEADER = @AUTOHEADER@
-AUTOMAKE = @AUTOMAKE@
-AWK = @AWK@
-CC = @CC@
-CCDEPMODE = @CCDEPMODE@
-CFLAGS = @CFLAGS@
-CPP = @CPP@
-CPPFLAGS = @CPPFLAGS@
-CXX = @CXX@
-CXXDEPMODE = @CXXDEPMODE@
-CXXFLAGS = @CXXFLAGS@
-CYGPATH_W = @CYGPATH_W@
-DEFS = @DEFS@
-DEPDIR = @DEPDIR@
-ECHO_C = @ECHO_C@
-ECHO_N = @ECHO_N@
-ECHO_T = @ECHO_T@
-EGREP = @EGREP@
-EXEEXT = @EXEEXT@
-GREP = @GREP@
-INSTALL = @INSTALL@
-INSTALL_DATA = @INSTALL_DATA@
-INSTALL_PROGRAM = @INSTALL_PROGRAM@
-INSTALL_SCRIPT = @INSTALL_SCRIPT@
-INSTALL_STRIP_PROGRAM = @INSTALL_STRIP_PROGRAM@
-LDFLAGS = @LDFLAGS@
-LIBOBJS = @LIBOBJS@
-LIBS = @LIBS@
-LTLIBOBJS = @LTLIBOBJS@
-MAKEINFO = @MAKEINFO@
-MKDIR_P = @MKDIR_P@
-OBJEXT = @OBJEXT@
-PACKAGE = @PACKAGE@
-PACKAGE_BUGREPORT = @PACKAGE_BUGREPORT@
-PACKAGE_NAME = @PACKAGE_NAME@
-PACKAGE_STRING = @PACKAGE_STRING@
-PACKAGE_TARNAME = @PACKAGE_TARNAME@
-PACKAGE_URL = @PACKAGE_URL@
-PACKAGE_VERSION = @PACKAGE_VERSION@
-PATH_SEPARATOR = @PATH_SEPARATOR@
-RANLIB = @RANLIB@
-SDL_CFLAGS = @SDL_CFLAGS@
-SDL_CONFIG = @SDL_CONFIG@
-SDL_LIBS = @SDL_LIBS@
-SET_MAKE = @SET_MAKE@
-SHELL = @SHELL@
-STRIP = @STRIP@
-VERSION = @VERSION@
-WINDRES = @WINDRES@
-abs_builddir = @abs_builddir@
-abs_srcdir = @abs_srcdir@
-abs_top_builddir = @abs_top_builddir@
-abs_top_srcdir = @abs_top_srcdir@
-ac_ct_CC = @ac_ct_CC@
-ac_ct_CXX = @ac_ct_CXX@
-am__include = @am__include@
-am__leading_dot = @am__leading_dot@
-am__quote = @am__quote@
-am__tar = @am__tar@
-am__untar = @am__untar@
-bindir = @bindir@
-build = @build@
-build_alias = @build_alias@
-build_cpu = @build_cpu@
-build_os = @build_os@
-build_vendor = @build_vendor@
-builddir = @builddir@
-datadir = @datadir@
-datarootdir = @datarootdir@
-docdir = @docdir@
-dvidir = @dvidir@
-exec_prefix = @exec_prefix@
-host = @host@
-host_alias = @host_alias@
-host_cpu = @host_cpu@
-host_os = @host_os@
-host_vendor = @host_vendor@
-htmldir = @htmldir@
-includedir = @includedir@
-infodir = @infodir@
-install_sh = @install_sh@
-libdir = @libdir@
-libexecdir = @libexecdir@
-localedir = @localedir@
-localstatedir = @localstatedir@
-mandir = @mandir@
-mkdir_p = @mkdir_p@
-oldincludedir = @oldincludedir@
-pdfdir = @pdfdir@
-prefix = @prefix@
-program_transform_name = @program_transform_name@
-psdir = @psdir@
-sbindir = @sbindir@
-sharedstatedir = @sharedstatedir@
-srcdir = @srcdir@
-sysconfdir = @sysconfdir@
-target_alias = @target_alias@
-top_build_prefix = @top_build_prefix@
-top_builddir = @top_builddir@
-top_srcdir = @top_srcdir@
-AM_CPPFLAGS = -I$(top_srcdir)/include
-noinst_LIBRARIES = libfpu.a
-libfpu_a_SOURCES = fpu.cpp fpu_instructions.h \
-                   fpu_instructions_x86.h
-
-all: all-am
-
-.SUFFIXES:
-.SUFFIXES: .cpp .o .obj
-$(srcdir)/Makefile.in:  $(srcdir)/Makefile.am  $(am__configure_deps)
-	@for dep in $?; do \
-	  case '$(am__configure_deps)' in \
-	    *$$dep*) \
-	      ( cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh ) \
-	        && { if test -f $@; then exit 0; else break; fi; }; \
-	      exit 1;; \
-	  esac; \
-	done; \
-	echo ' cd $(top_srcdir) && $(AUTOMAKE) --gnu src/fpu/Makefile'; \
-	$(am__cd) $(top_srcdir) && \
-	  $(AUTOMAKE) --gnu src/fpu/Makefile
-.PRECIOUS: Makefile
-Makefile: $(srcdir)/Makefile.in $(top_builddir)/config.status
-	@case '$?' in \
-	  *config.status*) \
-	    cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh;; \
-	  *) \
-	    echo ' cd $(top_builddir) && $(SHELL) ./config.status $(subdir)/$@ $(am__depfiles_maybe)'; \
-	    cd $(top_builddir) && $(SHELL) ./config.status $(subdir)/$@ $(am__depfiles_maybe);; \
-	esac;
-
-$(top_builddir)/config.status: $(top_srcdir)/configure $(CONFIG_STATUS_DEPENDENCIES)
-	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
-
-$(top_srcdir)/configure:  $(am__configure_deps)
-	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
-$(ACLOCAL_M4):  $(am__aclocal_m4_deps)
-	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
-$(am__aclocal_m4_deps):
-
-clean-noinstLIBRARIES:
-	-test -z "$(noinst_LIBRARIES)" || rm -f $(noinst_LIBRARIES)
-libfpu.a: $(libfpu_a_OBJECTS) $(libfpu_a_DEPENDENCIES) 
-	-rm -f libfpu.a
-	$(libfpu_a_AR) libfpu.a $(libfpu_a_OBJECTS) $(libfpu_a_LIBADD)
-	$(RANLIB) libfpu.a
-
-mostlyclean-compile:
-	-rm -f *.$(OBJEXT)
-
-distclean-compile:
-	-rm -f *.tab.c
-
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/fpu.Po@am__quote@
-
-.cpp.o:
-@am__fastdepCXX_TRUE@	$(CXXCOMPILE) -MT $@ -MD -MP -MF $(DEPDIR)/$*.Tpo -c -o $@ $<
-@am__fastdepCXX_TRUE@	$(am__mv) $(DEPDIR)/$*.Tpo $(DEPDIR)/$*.Po
-@AMDEP_TRUE@@am__fastdepCXX_FALSE@	source='$<' object='$@' libtool=no @AMDEPBACKSLASH@
-@AMDEP_TRUE@@am__fastdepCXX_FALSE@	DEPDIR=$(DEPDIR) $(CXXDEPMODE) $(depcomp) @AMDEPBACKSLASH@
-@am__fastdepCXX_FALSE@	$(CXXCOMPILE) -c -o $@ $<
-
-.cpp.obj:
-@am__fastdepCXX_TRUE@	$(CXXCOMPILE) -MT $@ -MD -MP -MF $(DEPDIR)/$*.Tpo -c -o $@ `$(CYGPATH_W) '$<'`
-@am__fastdepCXX_TRUE@	$(am__mv) $(DEPDIR)/$*.Tpo $(DEPDIR)/$*.Po
-@AMDEP_TRUE@@am__fastdepCXX_FALSE@	source='$<' object='$@' libtool=no @AMDEPBACKSLASH@
-@AMDEP_TRUE@@am__fastdepCXX_FALSE@	DEPDIR=$(DEPDIR) $(CXXDEPMODE) $(depcomp) @AMDEPBACKSLASH@
-@am__fastdepCXX_FALSE@	$(CXXCOMPILE) -c -o $@ `$(CYGPATH_W) '$<'`
-
-ID: $(HEADERS) $(SOURCES) $(LISP) $(TAGS_FILES)
-	list='$(SOURCES) $(HEADERS) $(LISP) $(TAGS_FILES)'; \
-	unique=`for i in $$list; do \
-	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
-	  done | \
-	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
-	      END { if (nonempty) { for (i in files) print i; }; }'`; \
-	mkid -fID $$unique
-tags: TAGS
-
-TAGS:  $(HEADERS) $(SOURCES)  $(TAGS_DEPENDENCIES) \
-		$(TAGS_FILES) $(LISP)
-	set x; \
-	here=`pwd`; \
-	list='$(SOURCES) $(HEADERS)  $(LISP) $(TAGS_FILES)'; \
-	unique=`for i in $$list; do \
-	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
-	  done | \
-	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
-	      END { if (nonempty) { for (i in files) print i; }; }'`; \
-	shift; \
-	if test -z "$(ETAGS_ARGS)$$*$$unique"; then :; else \
-	  test -n "$$unique" || unique=$$empty_fix; \
-	  if test $$# -gt 0; then \
-	    $(ETAGS) $(ETAGSFLAGS) $(AM_ETAGSFLAGS) $(ETAGS_ARGS) \
-	      "$$@" $$unique; \
-	  else \
-	    $(ETAGS) $(ETAGSFLAGS) $(AM_ETAGSFLAGS) $(ETAGS_ARGS) \
-	      $$unique; \
-	  fi; \
-	fi
-ctags: CTAGS
-CTAGS:  $(HEADERS) $(SOURCES)  $(TAGS_DEPENDENCIES) \
-		$(TAGS_FILES) $(LISP)
-	list='$(SOURCES) $(HEADERS)  $(LISP) $(TAGS_FILES)'; \
-	unique=`for i in $$list; do \
-	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
-	  done | \
-	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
-	      END { if (nonempty) { for (i in files) print i; }; }'`; \
-	test -z "$(CTAGS_ARGS)$$unique" \
-	  || $(CTAGS) $(CTAGSFLAGS) $(AM_CTAGSFLAGS) $(CTAGS_ARGS) \
-	     $$unique
-
-GTAGS:
-	here=`$(am__cd) $(top_builddir) && pwd` \
-	  && $(am__cd) $(top_srcdir) \
-	  && gtags -i $(GTAGS_ARGS) "$$here"
-
-distclean-tags:
-	-rm -f TAGS ID GTAGS GRTAGS GSYMS GPATH tags
-
-distdir: $(DISTFILES)
-	@srcdirstrip=`echo "$(srcdir)" | sed 's/[].[^$$\\*]/\\\\&/g'`; \
-	topsrcdirstrip=`echo "$(top_srcdir)" | sed 's/[].[^$$\\*]/\\\\&/g'`; \
-	list='$(DISTFILES)'; \
-	  dist_files=`for file in $$list; do echo $$file; done | \
-	  sed -e "s|^$$srcdirstrip/||;t" \
-	      -e "s|^$$topsrcdirstrip/|$(top_builddir)/|;t"`; \
-	case $$dist_files in \
-	  */*) $(MKDIR_P) `echo "$$dist_files" | \
-			   sed '/\//!d;s|^|$(distdir)/|;s,/[^/]*$$,,' | \
-			   sort -u` ;; \
-	esac; \
-	for file in $$dist_files; do \
-	  if test -f $$file || test -d $$file; then d=.; else d=$(srcdir); fi; \
-	  if test -d $$d/$$file; then \
-	    dir=`echo "/$$file" | sed -e 's,/[^/]*$$,,'`; \
-	    if test -d "$(distdir)/$$file"; then \
-	      find "$(distdir)/$$file" -type d ! -perm -700 -exec chmod u+rwx {} \;; \
-	    fi; \
-	    if test -d $(srcdir)/$$file && test $$d != $(srcdir); then \
-	      cp -fpR $(srcdir)/$$file "$(distdir)$$dir" || exit 1; \
-	      find "$(distdir)/$$file" -type d ! -perm -700 -exec chmod u+rwx {} \;; \
-	    fi; \
-	    cp -fpR $$d/$$file "$(distdir)$$dir" || exit 1; \
-	  else \
-	    test -f "$(distdir)/$$file" \
-	    || cp -p $$d/$$file "$(distdir)/$$file" \
-	    || exit 1; \
-	  fi; \
-	done
-check-am: all-am
-check: check-am
-all-am: Makefile $(LIBRARIES)
-installdirs:
-install: install-am
-install-exec: install-exec-am
-install-data: install-data-am
-uninstall: uninstall-am
-
-install-am: all-am
-	@$(MAKE) $(AM_MAKEFLAGS) install-exec-am install-data-am
-
-installcheck: installcheck-am
-install-strip:
-	$(MAKE) $(AM_MAKEFLAGS) INSTALL_PROGRAM="$(INSTALL_STRIP_PROGRAM)" \
-	  install_sh_PROGRAM="$(INSTALL_STRIP_PROGRAM)" INSTALL_STRIP_FLAG=-s \
-	  `test -z '$(STRIP)' || \
-	    echo "INSTALL_PROGRAM_ENV=STRIPPROG='$(STRIP)'"` install
-mostlyclean-generic:
-
-clean-generic:
-
-distclean-generic:
-	-test -z "$(CONFIG_CLEAN_FILES)" || rm -f $(CONFIG_CLEAN_FILES)
-	-test . = "$(srcdir)" || test -z "$(CONFIG_CLEAN_VPATH_FILES)" || rm -f $(CONFIG_CLEAN_VPATH_FILES)
-
-maintainer-clean-generic:
-	@echo "This command is intended for maintainers to use"
-	@echo "it deletes files that may require special tools to rebuild."
-clean: clean-am
-
-clean-am: clean-generic clean-noinstLIBRARIES mostlyclean-am
-
-distclean: distclean-am
-	-rm -rf ./$(DEPDIR)
-	-rm -f Makefile
-distclean-am: clean-am distclean-compile distclean-generic \
-	distclean-tags
-
-dvi: dvi-am
-
-dvi-am:
-
-html: html-am
-
-html-am:
-
-info: info-am
-
-info-am:
-
-install-data-am:
-
-install-dvi: install-dvi-am
-
-install-dvi-am:
-
-install-exec-am:
-
-install-html: install-html-am
-
-install-html-am:
-
-install-info: install-info-am
-
-install-info-am:
-
-install-man:
-
-install-pdf: install-pdf-am
-
-install-pdf-am:
-
-install-ps: install-ps-am
-
-install-ps-am:
-
-installcheck-am:
-
-maintainer-clean: maintainer-clean-am
-	-rm -rf ./$(DEPDIR)
-	-rm -f Makefile
-maintainer-clean-am: distclean-am maintainer-clean-generic
-
-mostlyclean: mostlyclean-am
-
-mostlyclean-am: mostlyclean-compile mostlyclean-generic
-
-pdf: pdf-am
-
-pdf-am:
-
-ps: ps-am
-
-ps-am:
-
-uninstall-am:
-
-.MAKE: install-am install-strip
-
-.PHONY: CTAGS GTAGS all all-am check check-am clean clean-generic \
-	clean-noinstLIBRARIES ctags distclean distclean-compile \
-	distclean-generic distclean-tags distdir dvi dvi-am html \
-	html-am info info-am install install-am install-data \
-	install-data-am install-dvi install-dvi-am install-exec \
-	install-exec-am install-html install-html-am install-info \
-	install-info-am install-man install-pdf install-pdf-am \
-	install-ps install-ps-am install-strip installcheck \
-	installcheck-am installdirs maintainer-clean \
-	maintainer-clean-generic mostlyclean mostlyclean-compile \
-	mostlyclean-generic pdf pdf-am ps ps-am tags uninstall \
-	uninstall-am
-
-
-# Tell versions [3.59,3.63) of GNU make to not export all variables.
-# Otherwise a system limit (for SysV at least) may be exceeded.
-.NOEXPORT:
diff -Nur dosbox-0.74/src/gui/dosbox_logo.h dosbox-0.74.patch/src/gui/dosbox_logo.h
--- dosbox-0.74/src/gui/dosbox_logo.h	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/gui/dosbox_logo.h	2016-12-11 18:35:15.530284006 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: dosbox_logo.h,v 1.5 2009-05-27 09:15:41 qbix79 Exp $ */
 
 /* DOSBox icon designed by Ido Beeri */
 
diff -Nur dosbox-0.74/src/gui/Makefile.in dosbox-0.74.patch/src/gui/Makefile.in
--- dosbox-0.74/src/gui/Makefile.in	2010-05-12 11:57:44.000000000 +0200
+++ dosbox-0.74.patch/src/gui/Makefile.in	1970-01-01 01:00:00.000000000 +0100
@@ -1,457 +0,0 @@
-# Makefile.in generated by automake 1.11.1 from Makefile.am.
-# @configure_input@
-
-# Copyright (C) 1994, 1995, 1996, 1997, 1998, 1999, 2000, 2001, 2002,
-# 2003, 2004, 2005, 2006, 2007, 2008, 2009  Free Software Foundation,
-# Inc.
-# This Makefile.in is free software; the Free Software Foundation
-# gives unlimited permission to copy and/or distribute it,
-# with or without modifications, as long as this notice is preserved.
-
-# This program is distributed in the hope that it will be useful,
-# but WITHOUT ANY WARRANTY, to the extent permitted by law; without
-# even the implied warranty of MERCHANTABILITY or FITNESS FOR A
-# PARTICULAR PURPOSE.
-
-@SET_MAKE@
-
-VPATH = @srcdir@
-pkgdatadir = $(datadir)/@PACKAGE@
-pkgincludedir = $(includedir)/@PACKAGE@
-pkglibdir = $(libdir)/@PACKAGE@
-pkglibexecdir = $(libexecdir)/@PACKAGE@
-am__cd = CDPATH="$${ZSH_VERSION+.}$(PATH_SEPARATOR)" && cd
-install_sh_DATA = $(install_sh) -c -m 644
-install_sh_PROGRAM = $(install_sh) -c
-install_sh_SCRIPT = $(install_sh) -c
-INSTALL_HEADER = $(INSTALL_DATA)
-transform = $(program_transform_name)
-NORMAL_INSTALL = :
-PRE_INSTALL = :
-POST_INSTALL = :
-NORMAL_UNINSTALL = :
-PRE_UNINSTALL = :
-POST_UNINSTALL = :
-build_triplet = @build@
-host_triplet = @host@
-subdir = src/gui
-DIST_COMMON = $(srcdir)/Makefile.am $(srcdir)/Makefile.in
-ACLOCAL_M4 = $(top_srcdir)/aclocal.m4
-am__aclocal_m4_deps = $(top_srcdir)/acinclude.m4 \
-	$(top_srcdir)/configure.in
-am__configure_deps = $(am__aclocal_m4_deps) $(CONFIGURE_DEPENDENCIES) \
-	$(ACLOCAL_M4)
-mkinstalldirs = $(install_sh) -d
-CONFIG_HEADER = $(top_builddir)/config.h
-CONFIG_CLEAN_FILES =
-CONFIG_CLEAN_VPATH_FILES =
-LIBRARIES = $(noinst_LIBRARIES)
-AR = ar
-ARFLAGS = cru
-libgui_a_AR = $(AR) $(ARFLAGS)
-libgui_a_LIBADD =
-am_libgui_a_OBJECTS = sdlmain.$(OBJEXT) sdl_mapper.$(OBJEXT) \
-	render.$(OBJEXT) render_scalers.$(OBJEXT) midi.$(OBJEXT) \
-	sdl_gui.$(OBJEXT)
-libgui_a_OBJECTS = $(am_libgui_a_OBJECTS)
-DEFAULT_INCLUDES = -I.@am__isrc@ -I$(top_builddir)
-depcomp = $(SHELL) $(top_srcdir)/depcomp
-am__depfiles_maybe = depfiles
-am__mv = mv -f
-CXXCOMPILE = $(CXX) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) \
-	$(AM_CPPFLAGS) $(CPPFLAGS) $(AM_CXXFLAGS) $(CXXFLAGS)
-CXXLD = $(CXX)
-CXXLINK = $(CXXLD) $(AM_CXXFLAGS) $(CXXFLAGS) $(AM_LDFLAGS) $(LDFLAGS) \
-	-o $@
-COMPILE = $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) \
-	$(CPPFLAGS) $(AM_CFLAGS) $(CFLAGS)
-CCLD = $(CC)
-LINK = $(CCLD) $(AM_CFLAGS) $(CFLAGS) $(AM_LDFLAGS) $(LDFLAGS) -o $@
-SOURCES = $(libgui_a_SOURCES)
-DIST_SOURCES = $(libgui_a_SOURCES)
-ETAGS = etags
-CTAGS = ctags
-DISTFILES = $(DIST_COMMON) $(DIST_SOURCES) $(TEXINFOS) $(EXTRA_DIST)
-ACLOCAL = @ACLOCAL@
-ALSA_CFLAGS = @ALSA_CFLAGS@
-ALSA_LIBS = @ALSA_LIBS@
-AMTAR = @AMTAR@
-AUTOCONF = @AUTOCONF@
-AUTOHEADER = @AUTOHEADER@
-AUTOMAKE = @AUTOMAKE@
-AWK = @AWK@
-CC = @CC@
-CCDEPMODE = @CCDEPMODE@
-CFLAGS = @CFLAGS@
-CPP = @CPP@
-CPPFLAGS = @CPPFLAGS@
-CXX = @CXX@
-CXXDEPMODE = @CXXDEPMODE@
-CXXFLAGS = @CXXFLAGS@
-CYGPATH_W = @CYGPATH_W@
-DEFS = @DEFS@
-DEPDIR = @DEPDIR@
-ECHO_C = @ECHO_C@
-ECHO_N = @ECHO_N@
-ECHO_T = @ECHO_T@
-EGREP = @EGREP@
-EXEEXT = @EXEEXT@
-GREP = @GREP@
-INSTALL = @INSTALL@
-INSTALL_DATA = @INSTALL_DATA@
-INSTALL_PROGRAM = @INSTALL_PROGRAM@
-INSTALL_SCRIPT = @INSTALL_SCRIPT@
-INSTALL_STRIP_PROGRAM = @INSTALL_STRIP_PROGRAM@
-LDFLAGS = @LDFLAGS@
-LIBOBJS = @LIBOBJS@
-LIBS = @LIBS@
-LTLIBOBJS = @LTLIBOBJS@
-MAKEINFO = @MAKEINFO@
-MKDIR_P = @MKDIR_P@
-OBJEXT = @OBJEXT@
-PACKAGE = @PACKAGE@
-PACKAGE_BUGREPORT = @PACKAGE_BUGREPORT@
-PACKAGE_NAME = @PACKAGE_NAME@
-PACKAGE_STRING = @PACKAGE_STRING@
-PACKAGE_TARNAME = @PACKAGE_TARNAME@
-PACKAGE_URL = @PACKAGE_URL@
-PACKAGE_VERSION = @PACKAGE_VERSION@
-PATH_SEPARATOR = @PATH_SEPARATOR@
-RANLIB = @RANLIB@
-SDL_CFLAGS = @SDL_CFLAGS@
-SDL_CONFIG = @SDL_CONFIG@
-SDL_LIBS = @SDL_LIBS@
-SET_MAKE = @SET_MAKE@
-SHELL = @SHELL@
-STRIP = @STRIP@
-VERSION = @VERSION@
-WINDRES = @WINDRES@
-abs_builddir = @abs_builddir@
-abs_srcdir = @abs_srcdir@
-abs_top_builddir = @abs_top_builddir@
-abs_top_srcdir = @abs_top_srcdir@
-ac_ct_CC = @ac_ct_CC@
-ac_ct_CXX = @ac_ct_CXX@
-am__include = @am__include@
-am__leading_dot = @am__leading_dot@
-am__quote = @am__quote@
-am__tar = @am__tar@
-am__untar = @am__untar@
-bindir = @bindir@
-build = @build@
-build_alias = @build_alias@
-build_cpu = @build_cpu@
-build_os = @build_os@
-build_vendor = @build_vendor@
-builddir = @builddir@
-datadir = @datadir@
-datarootdir = @datarootdir@
-docdir = @docdir@
-dvidir = @dvidir@
-exec_prefix = @exec_prefix@
-host = @host@
-host_alias = @host_alias@
-host_cpu = @host_cpu@
-host_os = @host_os@
-host_vendor = @host_vendor@
-htmldir = @htmldir@
-includedir = @includedir@
-infodir = @infodir@
-install_sh = @install_sh@
-libdir = @libdir@
-libexecdir = @libexecdir@
-localedir = @localedir@
-localstatedir = @localstatedir@
-mandir = @mandir@
-mkdir_p = @mkdir_p@
-oldincludedir = @oldincludedir@
-pdfdir = @pdfdir@
-prefix = @prefix@
-program_transform_name = @program_transform_name@
-psdir = @psdir@
-sbindir = @sbindir@
-sharedstatedir = @sharedstatedir@
-srcdir = @srcdir@
-sysconfdir = @sysconfdir@
-target_alias = @target_alias@
-top_build_prefix = @top_build_prefix@
-top_builddir = @top_builddir@
-top_srcdir = @top_srcdir@
-AM_CPPFLAGS = -I$(top_srcdir)/include
-noinst_LIBRARIES = libgui.a
-libgui_a_SOURCES = sdlmain.cpp sdl_mapper.cpp dosbox_logo.h \
-	render.cpp render_scalers.cpp render_scalers.h \
-	render_templates.h render_loops.h render_simple.h \
-	render_templates_sai.h render_templates_hq.h \
-	render_templates_hq2x.h render_templates_hq3x.h \
-	midi.cpp midi_win32.h midi_oss.h midi_coreaudio.h midi_alsa.h \
-	midi_coremidi.h sdl_gui.cpp dosbox_splash.h
-
-all: all-am
-
-.SUFFIXES:
-.SUFFIXES: .cpp .o .obj
-$(srcdir)/Makefile.in:  $(srcdir)/Makefile.am  $(am__configure_deps)
-	@for dep in $?; do \
-	  case '$(am__configure_deps)' in \
-	    *$$dep*) \
-	      ( cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh ) \
-	        && { if test -f $@; then exit 0; else break; fi; }; \
-	      exit 1;; \
-	  esac; \
-	done; \
-	echo ' cd $(top_srcdir) && $(AUTOMAKE) --gnu src/gui/Makefile'; \
-	$(am__cd) $(top_srcdir) && \
-	  $(AUTOMAKE) --gnu src/gui/Makefile
-.PRECIOUS: Makefile
-Makefile: $(srcdir)/Makefile.in $(top_builddir)/config.status
-	@case '$?' in \
-	  *config.status*) \
-	    cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh;; \
-	  *) \
-	    echo ' cd $(top_builddir) && $(SHELL) ./config.status $(subdir)/$@ $(am__depfiles_maybe)'; \
-	    cd $(top_builddir) && $(SHELL) ./config.status $(subdir)/$@ $(am__depfiles_maybe);; \
-	esac;
-
-$(top_builddir)/config.status: $(top_srcdir)/configure $(CONFIG_STATUS_DEPENDENCIES)
-	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
-
-$(top_srcdir)/configure:  $(am__configure_deps)
-	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
-$(ACLOCAL_M4):  $(am__aclocal_m4_deps)
-	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
-$(am__aclocal_m4_deps):
-
-clean-noinstLIBRARIES:
-	-test -z "$(noinst_LIBRARIES)" || rm -f $(noinst_LIBRARIES)
-libgui.a: $(libgui_a_OBJECTS) $(libgui_a_DEPENDENCIES) 
-	-rm -f libgui.a
-	$(libgui_a_AR) libgui.a $(libgui_a_OBJECTS) $(libgui_a_LIBADD)
-	$(RANLIB) libgui.a
-
-mostlyclean-compile:
-	-rm -f *.$(OBJEXT)
-
-distclean-compile:
-	-rm -f *.tab.c
-
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/midi.Po@am__quote@
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/render.Po@am__quote@
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/render_scalers.Po@am__quote@
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/sdl_gui.Po@am__quote@
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/sdl_mapper.Po@am__quote@
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/sdlmain.Po@am__quote@
-
-.cpp.o:
-@am__fastdepCXX_TRUE@	$(CXXCOMPILE) -MT $@ -MD -MP -MF $(DEPDIR)/$*.Tpo -c -o $@ $<
-@am__fastdepCXX_TRUE@	$(am__mv) $(DEPDIR)/$*.Tpo $(DEPDIR)/$*.Po
-@AMDEP_TRUE@@am__fastdepCXX_FALSE@	source='$<' object='$@' libtool=no @AMDEPBACKSLASH@
-@AMDEP_TRUE@@am__fastdepCXX_FALSE@	DEPDIR=$(DEPDIR) $(CXXDEPMODE) $(depcomp) @AMDEPBACKSLASH@
-@am__fastdepCXX_FALSE@	$(CXXCOMPILE) -c -o $@ $<
-
-.cpp.obj:
-@am__fastdepCXX_TRUE@	$(CXXCOMPILE) -MT $@ -MD -MP -MF $(DEPDIR)/$*.Tpo -c -o $@ `$(CYGPATH_W) '$<'`
-@am__fastdepCXX_TRUE@	$(am__mv) $(DEPDIR)/$*.Tpo $(DEPDIR)/$*.Po
-@AMDEP_TRUE@@am__fastdepCXX_FALSE@	source='$<' object='$@' libtool=no @AMDEPBACKSLASH@
-@AMDEP_TRUE@@am__fastdepCXX_FALSE@	DEPDIR=$(DEPDIR) $(CXXDEPMODE) $(depcomp) @AMDEPBACKSLASH@
-@am__fastdepCXX_FALSE@	$(CXXCOMPILE) -c -o $@ `$(CYGPATH_W) '$<'`
-
-ID: $(HEADERS) $(SOURCES) $(LISP) $(TAGS_FILES)
-	list='$(SOURCES) $(HEADERS) $(LISP) $(TAGS_FILES)'; \
-	unique=`for i in $$list; do \
-	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
-	  done | \
-	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
-	      END { if (nonempty) { for (i in files) print i; }; }'`; \
-	mkid -fID $$unique
-tags: TAGS
-
-TAGS:  $(HEADERS) $(SOURCES)  $(TAGS_DEPENDENCIES) \
-		$(TAGS_FILES) $(LISP)
-	set x; \
-	here=`pwd`; \
-	list='$(SOURCES) $(HEADERS)  $(LISP) $(TAGS_FILES)'; \
-	unique=`for i in $$list; do \
-	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
-	  done | \
-	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
-	      END { if (nonempty) { for (i in files) print i; }; }'`; \
-	shift; \
-	if test -z "$(ETAGS_ARGS)$$*$$unique"; then :; else \
-	  test -n "$$unique" || unique=$$empty_fix; \
-	  if test $$# -gt 0; then \
-	    $(ETAGS) $(ETAGSFLAGS) $(AM_ETAGSFLAGS) $(ETAGS_ARGS) \
-	      "$$@" $$unique; \
-	  else \
-	    $(ETAGS) $(ETAGSFLAGS) $(AM_ETAGSFLAGS) $(ETAGS_ARGS) \
-	      $$unique; \
-	  fi; \
-	fi
-ctags: CTAGS
-CTAGS:  $(HEADERS) $(SOURCES)  $(TAGS_DEPENDENCIES) \
-		$(TAGS_FILES) $(LISP)
-	list='$(SOURCES) $(HEADERS)  $(LISP) $(TAGS_FILES)'; \
-	unique=`for i in $$list; do \
-	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
-	  done | \
-	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
-	      END { if (nonempty) { for (i in files) print i; }; }'`; \
-	test -z "$(CTAGS_ARGS)$$unique" \
-	  || $(CTAGS) $(CTAGSFLAGS) $(AM_CTAGSFLAGS) $(CTAGS_ARGS) \
-	     $$unique
-
-GTAGS:
-	here=`$(am__cd) $(top_builddir) && pwd` \
-	  && $(am__cd) $(top_srcdir) \
-	  && gtags -i $(GTAGS_ARGS) "$$here"
-
-distclean-tags:
-	-rm -f TAGS ID GTAGS GRTAGS GSYMS GPATH tags
-
-distdir: $(DISTFILES)
-	@srcdirstrip=`echo "$(srcdir)" | sed 's/[].[^$$\\*]/\\\\&/g'`; \
-	topsrcdirstrip=`echo "$(top_srcdir)" | sed 's/[].[^$$\\*]/\\\\&/g'`; \
-	list='$(DISTFILES)'; \
-	  dist_files=`for file in $$list; do echo $$file; done | \
-	  sed -e "s|^$$srcdirstrip/||;t" \
-	      -e "s|^$$topsrcdirstrip/|$(top_builddir)/|;t"`; \
-	case $$dist_files in \
-	  */*) $(MKDIR_P) `echo "$$dist_files" | \
-			   sed '/\//!d;s|^|$(distdir)/|;s,/[^/]*$$,,' | \
-			   sort -u` ;; \
-	esac; \
-	for file in $$dist_files; do \
-	  if test -f $$file || test -d $$file; then d=.; else d=$(srcdir); fi; \
-	  if test -d $$d/$$file; then \
-	    dir=`echo "/$$file" | sed -e 's,/[^/]*$$,,'`; \
-	    if test -d "$(distdir)/$$file"; then \
-	      find "$(distdir)/$$file" -type d ! -perm -700 -exec chmod u+rwx {} \;; \
-	    fi; \
-	    if test -d $(srcdir)/$$file && test $$d != $(srcdir); then \
-	      cp -fpR $(srcdir)/$$file "$(distdir)$$dir" || exit 1; \
-	      find "$(distdir)/$$file" -type d ! -perm -700 -exec chmod u+rwx {} \;; \
-	    fi; \
-	    cp -fpR $$d/$$file "$(distdir)$$dir" || exit 1; \
-	  else \
-	    test -f "$(distdir)/$$file" \
-	    || cp -p $$d/$$file "$(distdir)/$$file" \
-	    || exit 1; \
-	  fi; \
-	done
-check-am: all-am
-check: check-am
-all-am: Makefile $(LIBRARIES)
-installdirs:
-install: install-am
-install-exec: install-exec-am
-install-data: install-data-am
-uninstall: uninstall-am
-
-install-am: all-am
-	@$(MAKE) $(AM_MAKEFLAGS) install-exec-am install-data-am
-
-installcheck: installcheck-am
-install-strip:
-	$(MAKE) $(AM_MAKEFLAGS) INSTALL_PROGRAM="$(INSTALL_STRIP_PROGRAM)" \
-	  install_sh_PROGRAM="$(INSTALL_STRIP_PROGRAM)" INSTALL_STRIP_FLAG=-s \
-	  `test -z '$(STRIP)' || \
-	    echo "INSTALL_PROGRAM_ENV=STRIPPROG='$(STRIP)'"` install
-mostlyclean-generic:
-
-clean-generic:
-
-distclean-generic:
-	-test -z "$(CONFIG_CLEAN_FILES)" || rm -f $(CONFIG_CLEAN_FILES)
-	-test . = "$(srcdir)" || test -z "$(CONFIG_CLEAN_VPATH_FILES)" || rm -f $(CONFIG_CLEAN_VPATH_FILES)
-
-maintainer-clean-generic:
-	@echo "This command is intended for maintainers to use"
-	@echo "it deletes files that may require special tools to rebuild."
-clean: clean-am
-
-clean-am: clean-generic clean-noinstLIBRARIES mostlyclean-am
-
-distclean: distclean-am
-	-rm -rf ./$(DEPDIR)
-	-rm -f Makefile
-distclean-am: clean-am distclean-compile distclean-generic \
-	distclean-tags
-
-dvi: dvi-am
-
-dvi-am:
-
-html: html-am
-
-html-am:
-
-info: info-am
-
-info-am:
-
-install-data-am:
-
-install-dvi: install-dvi-am
-
-install-dvi-am:
-
-install-exec-am:
-
-install-html: install-html-am
-
-install-html-am:
-
-install-info: install-info-am
-
-install-info-am:
-
-install-man:
-
-install-pdf: install-pdf-am
-
-install-pdf-am:
-
-install-ps: install-ps-am
-
-install-ps-am:
-
-installcheck-am:
-
-maintainer-clean: maintainer-clean-am
-	-rm -rf ./$(DEPDIR)
-	-rm -f Makefile
-maintainer-clean-am: distclean-am maintainer-clean-generic
-
-mostlyclean: mostlyclean-am
-
-mostlyclean-am: mostlyclean-compile mostlyclean-generic
-
-pdf: pdf-am
-
-pdf-am:
-
-ps: ps-am
-
-ps-am:
-
-uninstall-am:
-
-.MAKE: install-am install-strip
-
-.PHONY: CTAGS GTAGS all all-am check check-am clean clean-generic \
-	clean-noinstLIBRARIES ctags distclean distclean-compile \
-	distclean-generic distclean-tags distdir dvi dvi-am html \
-	html-am info info-am install install-am install-data \
-	install-data-am install-dvi install-dvi-am install-exec \
-	install-exec-am install-html install-html-am install-info \
-	install-info-am install-man install-pdf install-pdf-am \
-	install-ps install-ps-am install-strip installcheck \
-	installcheck-am installdirs maintainer-clean \
-	maintainer-clean-generic mostlyclean mostlyclean-compile \
-	mostlyclean-generic pdf pdf-am ps ps-am tags uninstall \
-	uninstall-am
-
-
-# Tell versions [3.59,3.63) of GNU make to not export all variables.
-# Otherwise a system limit (for SysV at least) may be exceeded.
-.NOEXPORT:
diff -Nur dosbox-0.74/src/gui/midi_alsa.h dosbox-0.74.patch/src/gui/midi_alsa.h
--- dosbox-0.74/src/gui/midi_alsa.h	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/gui/midi_alsa.h	2016-12-11 18:35:15.530284006 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: midi_alsa.h,v 1.20 2009-04-27 17:33:12 qbix79 Exp $ */
 
 #define ALSA_PCM_OLD_HW_PARAMS_API
 #define ALSA_PCM_OLD_SW_PARAMS_API
diff -Nur dosbox-0.74/src/gui/midi_coreaudio.h dosbox-0.74.patch/src/gui/midi_coreaudio.h
--- dosbox-0.74/src/gui/midi_coreaudio.h	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/gui/midi_coreaudio.h	2016-12-11 18:35:15.530284006 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: midi_coreaudio.h,v 1.12 2009-10-18 18:06:28 qbix79 Exp $ */
 
 #include <AudioToolbox/AUGraph.h>
 #include <CoreServices/CoreServices.h>
@@ -33,6 +32,7 @@
 private:
 	AUGraph m_auGraph;
 	AudioUnit m_synth;
+        const char *soundfont;
 public:
 	MidiHandler_coreaudio() : m_auGraph(0), m_synth(0) {}
 	const char * GetName(void) { return "coreaudio"; }
@@ -72,6 +72,22 @@
 		// Get the music device from the graph.
 		RequireNoErr(AUGraphGetNodeInfo(m_auGraph, synthNode, NULL, NULL, NULL, &m_synth));
 
+                // Optionally load a soundfont 
+                if (conf && conf[0]) {
+                  soundfont = conf;
+                  FSRef soundfontRef;
+                  RequireNoErr(FSPathMakeRef((const UInt8*)soundfont, &soundfontRef, NULL));
+                  RequireNoErr(AudioUnitSetProperty(
+                                                    m_synth,
+                                                    kMusicDeviceProperty_SoundBankFSRef, 
+                                                    kAudioUnitScope_Global,
+                                                    0,
+                                                    &soundfontRef,
+                                                    sizeof(soundfontRef)
+                                                    ));
+                  LOG_MSG("MIDI:coreaudio: loaded soundfont: %s",soundfont);
+                } 
+
 		// Finally: Start the graph!
 		RequireNoErr(AUGraphStart(m_auGraph));
 
diff -Nur dosbox-0.74/src/gui/midi_coremidi.h dosbox-0.74.patch/src/gui/midi_coremidi.h
--- dosbox-0.74/src/gui/midi_coremidi.h	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/gui/midi_coremidi.h	2016-12-11 18:35:15.530284006 +0100
@@ -25,14 +25,14 @@
 public:
 	MidiHandler_coremidi()  {m_pCurPacket = 0;}
 	const char * GetName(void) { return "coremidi"; }
-	bool Open(const char * conf) {
-	
+	bool Open(const char * conf) {	
 		// Get the MIDIEndPoint
 		m_endpoint = 0;
 		OSStatus result;
 		Bitu numDests = MIDIGetNumberOfDestinations();
-	        Bitu destId = 0;
-	        if(conf && conf[0]) destId = atoi(conf);
+		Bitu destId = 0;
+		if(conf && conf[0]) destId = atoi(conf);
+		
 		if (destId < numDests)
 		{
 			m_endpoint = MIDIGetDestination(destId);
@@ -67,7 +67,8 @@
 		MIDIClientDispose(m_client);
 
 		// Dispose the endpoint
-		MIDIEndpointDispose(m_endpoint);
+		// Not, as it is for Endpoints created by us
+//		MIDIEndpointDispose(m_endpoint);
 	}
 	
 	void PlayMsg(Bit8u * msg) {
@@ -99,6 +100,21 @@
 		// Send the MIDIPacketList
 		MIDISend(m_port,m_endpoint,packetList);
 	}
+	void ListAll(Program* base) {
+		Bitu numDests = MIDIGetNumberOfDestinations();
+		for(Bitu i = 0; i < numDests; i++){
+			MIDIEndpointRef dest = MIDIGetDestination(i);
+			if(!dest) continue;
+			CFStringRef midiname = 0;
+			if(MIDIObjectGetStringProperty(dest, kMIDIPropertyDisplayName, &midiname) == noErr) {
+				const char * s = CFStringGetCStringPtr(midiname, kCFStringEncodingMacRoman);
+				if(s) base->WriteOut("%02d\t%s\n",i,s);
+			}
+			//This is for EndPoints created by us.
+			//MIDIEndpointDispose(dest);
+		}
+
+	}
 };
 
 MidiHandler_coremidi Midi_coremidi;
diff -Nur dosbox-0.74/src/gui/midi.cpp dosbox-0.74.patch/src/gui/midi.cpp
--- dosbox-0.74/src/gui/midi.cpp	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/gui/midi.cpp	2016-12-11 18:35:15.530284006 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -19,16 +19,21 @@
 #include <assert.h>
 #include <string.h>
 #include <stdlib.h>
+#include <string>
+#include <algorithm>
+
+#include "SDL.h"
 
 #include "dosbox.h"
+#include "midi.h"
 #include "cross.h"
 #include "support.h"
 #include "setup.h"
 #include "mapper.h"
 #include "pic.h"
 #include "hardware.h"
+#include "timer.h"
 
-#define SYSEX_SIZE 1024
 #define RAWBUF	1024
 
 Bit8u MIDI_evt_len[256] = {
@@ -54,23 +59,11 @@
   0,2,3,2, 0,0,1,0, 1,0,1,1, 1,0,1,0   // 0xf0
 };
 
-class MidiHandler;
-
-MidiHandler * handler_list=0;
+MidiHandler * handler_list = 0;
 
-class MidiHandler {
-public:
-	MidiHandler() {
-		next=handler_list;
-		handler_list=this;
-	};
-	virtual bool Open(const char * /*conf*/) { return true; };
-	virtual void Close(void) {};
-	virtual void PlayMsg(Bit8u * /*msg*/) {};
-	virtual void PlaySysex(Bit8u * /*sysex*/,Bitu /*len*/) {};
-	virtual const char * GetName(void) { return "none"; };
-	virtual ~MidiHandler() { };
-	MidiHandler * next;
+MidiHandler::MidiHandler(){
+	next = handler_list;
+	handler_list = this;
 };
 
 MidiHandler Midi_none;
@@ -98,21 +91,14 @@
 
 #endif
 
-static struct {
-	Bitu status;
-	Bitu cmd_len;
-	Bitu cmd_pos;
-	Bit8u cmd_buf[8];
-	Bit8u rt_buf[8];
-	struct {
-		Bit8u buf[SYSEX_SIZE];
-		Bitu used;
-	} sysex;
-	bool available;
-	MidiHandler * handler;
-} midi;
+DB_Midi midi;
 
 void MIDI_RawOutByte(Bit8u data) {
+	if (midi.sysex.start) {
+		Bit32u passed_ticks = GetTicks() - midi.sysex.start;
+		if (passed_ticks < midi.sysex.delay) SDL_Delay(midi.sysex.delay - passed_ticks);
+	}
+
 	/* Test for a realtime MIDI message */
 	if (data>=0xf8) {
 		midi.rt_buf[0]=data;
@@ -122,11 +108,28 @@
 	/* Test for a active sysex tranfer */
 	if (midi.status==0xf0) {
 		if (!(data&0x80)) { 
-			if (midi.sysex.used<(SYSEX_SIZE-1)) midi.sysex.buf[midi.sysex.used++]=data;
+			if (midi.sysex.used<(SYSEX_SIZE-1)) midi.sysex.buf[midi.sysex.used++] = data;
 			return;
 		} else {
-			midi.sysex.buf[midi.sysex.used++]=0xf7;
-			midi.handler->PlaySysex(midi.sysex.buf,midi.sysex.used);
+			midi.sysex.buf[midi.sysex.used++] = 0xf7;
+
+			if ((midi.sysex.start) && (midi.sysex.used >= 4) && (midi.sysex.used <= 9) && (midi.sysex.buf[1] == 0x41) && (midi.sysex.buf[3] == 0x16)) {
+				LOG(LOG_ALL,LOG_ERROR)("MIDI:Skipping invalid MT-32 SysEx midi message (too short to contain a checksum)");
+			} else {
+//				LOG(LOG_ALL,LOG_NORMAL)("Play sysex; address:%02X %02X %02X, length:%4d, delay:%3d", midi.sysex.buf[5], midi.sysex.buf[6], midi.sysex.buf[7], midi.sysex.used, midi.sysex.delay);
+				midi.handler->PlaySysex(midi.sysex.buf, midi.sysex.used);
+				if (midi.sysex.start) {
+					if (midi.sysex.buf[5] == 0x7F) {
+						midi.sysex.delay = 290; // All Parameters reset
+					} else if (midi.sysex.buf[5] == 0x10 && midi.sysex.buf[6] == 0x00 && midi.sysex.buf[7] == 0x04) {
+						midi.sysex.delay = 145; // Viking Child
+					} else if (midi.sysex.buf[5] == 0x10 && midi.sysex.buf[6] == 0x00 && midi.sysex.buf[7] == 0x01) {
+						midi.sysex.delay = 30; // Dark Sun 1
+					} else midi.sysex.delay = (Bitu)(((float)(midi.sysex.used) * 1.25f) * 1000.0f / 3125.0f) + 2;
+					midi.sysex.start = GetTicks();
+				}
+			}
+
 			LOG(LOG_ALL,LOG_NORMAL)("Sysex message size %d",midi.sysex.used);
 			if (CaptureState & CAPTURE_MIDI) {
 				CAPTURE_AddMidi( true, midi.sysex.used-1, &midi.sysex.buf[1]);
@@ -163,10 +166,19 @@
 	MIDI(Section* configuration):Module_base(configuration){
 		Section_prop * section=static_cast<Section_prop *>(configuration);
 		const char * dev=section->Get_string("mididevice");
-		const char * conf=section->Get_string("midiconfig");
+		std::string fullconf=section->Get_string("midiconfig");
 		/* If device = "default" go for first handler that works */
 		MidiHandler * handler;
 //		MAPPER_AddHandler(MIDI_SaveRawEvent,MK_f8,MMOD1|MMOD2,"caprawmidi","Cap MIDI");
+		midi.sysex.delay = 0;
+		midi.sysex.start = 0;
+		if (fullconf.find("delaysysex") != std::string::npos) {
+			midi.sysex.start = GetTicks();
+			fullconf.erase(fullconf.find("delaysysex"));
+			LOG_MSG("MIDI:Using delayed SysEx processing");
+		}
+		std::remove(fullconf.begin(), fullconf.end(), ' ');
+		const char * conf = fullconf.c_str();
 		midi.status=0x00;
 		midi.cmd_pos=0;
 		midi.cmd_len=0;
diff -Nur dosbox-0.74/src/gui/midi_oss.h dosbox-0.74.patch/src/gui/midi_oss.h
--- dosbox-0.74/src/gui/midi_oss.h	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/gui/midi_oss.h	2016-12-11 18:35:15.530284006 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
diff -Nur dosbox-0.74/src/gui/midi_win32.h dosbox-0.74.patch/src/gui/midi_win32.h
--- dosbox-0.74/src/gui/midi_win32.h	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/gui/midi_win32.h	2016-12-11 18:35:15.530284006 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: midi_win32.h,v 1.16 2009-05-27 09:15:41 qbix79 Exp $ */
 
 #ifndef WIN32_LEAN_AND_MEAN
 #define WIN32_LEAN_AND_MEAN
@@ -48,10 +47,10 @@
 				MIDIOUTCAPS mididev;
 				midiOutGetDevCaps(nummer, &mididev, sizeof(MIDIOUTCAPS));
 				LOG_MSG("MIDI:win32 selected %s",mididev.szPname);
-				res = midiOutOpen(&m_out, nummer, (DWORD)m_event, 0, CALLBACK_EVENT);
+				res = midiOutOpen(&m_out, nummer, (DWORD_PTR)m_event, 0, CALLBACK_EVENT);
 			}
 		} else {
-			res = midiOutOpen(&m_out, MIDI_MAPPER, (DWORD)m_event, 0, CALLBACK_EVENT);
+			res = midiOutOpen(&m_out, MIDI_MAPPER, (DWORD_PTR)m_event, 0, CALLBACK_EVENT);
 		}
 		if (res != MMSYSERR_NOERROR) return false;
 		isOpen=true;
@@ -88,6 +87,14 @@
 			return;
 		}
 	}
+	void ListAll(Program* base) {
+		unsigned int total = midiOutGetNumDevs();	
+		for(unsigned int i = 0;i < total;i++) {
+			MIDIOUTCAPS mididev;
+			midiOutGetDevCaps(i, &mididev, sizeof(MIDIOUTCAPS));
+			base->WriteOut("%2d\t \"%s\"\n",i,mididev.szPname);
+		}
+	}
 };
 
 MidiHandler_win32 Midi_win32; 
diff -Nur dosbox-0.74/src/gui/render.cpp dosbox-0.74.patch/src/gui/render.cpp
--- dosbox-0.74/src/gui/render.cpp	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/gui/render.cpp	2016-12-11 18:35:15.530284006 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: render.cpp,v 1.60 2009-04-26 19:14:50 harekiet Exp $ */
 
 #include <sys/types.h>
 #include <assert.h>
diff -Nur dosbox-0.74/src/gui/render_loops.h dosbox-0.74.patch/src/gui/render_loops.h
--- dosbox-0.74/src/gui/render_loops.h	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/gui/render_loops.h	2016-12-11 18:35:15.530284006 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
diff -Nur dosbox-0.74/src/gui/render_scalers.cpp dosbox-0.74.patch/src/gui/render_scalers.cpp
--- dosbox-0.74/src/gui/render_scalers.cpp	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/gui/render_scalers.cpp	2016-12-11 18:35:15.530284006 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
diff -Nur dosbox-0.74/src/gui/render_scalers.h dosbox-0.74.patch/src/gui/render_scalers.h
--- dosbox-0.74/src/gui/render_scalers.h	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/gui/render_scalers.h	2016-12-11 18:35:15.530284006 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
diff -Nur dosbox-0.74/src/gui/render_simple.h dosbox-0.74.patch/src/gui/render_simple.h
--- dosbox-0.74/src/gui/render_simple.h	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/gui/render_simple.h	2016-12-11 18:35:15.530284006 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: render_simple.h,v 1.7 2009-05-27 09:15:41 qbix79 Exp $ */
 
 #if defined (SCALERLINEAR)
 static void conc4d(SCALERNAME,SBPP,DBPP,L)(const void *s) {
diff -Nur dosbox-0.74/src/gui/render_templates.h dosbox-0.74.patch/src/gui/render_templates.h
--- dosbox-0.74/src/gui/render_templates.h	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/gui/render_templates.h	2016-12-11 18:35:15.530284006 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
diff -Nur dosbox-0.74/src/gui/render_templates_hq2x.h dosbox-0.74.patch/src/gui/render_templates_hq2x.h
--- dosbox-0.74/src/gui/render_templates_hq2x.h	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/gui/render_templates_hq2x.h	2016-12-11 18:35:15.530284006 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
diff -Nur dosbox-0.74/src/gui/render_templates_hq3x.h dosbox-0.74.patch/src/gui/render_templates_hq3x.h
--- dosbox-0.74/src/gui/render_templates_hq3x.h	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/gui/render_templates_hq3x.h	2016-12-11 18:35:15.530284006 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
diff -Nur dosbox-0.74/src/gui/render_templates_hq.h dosbox-0.74.patch/src/gui/render_templates_hq.h
--- dosbox-0.74/src/gui/render_templates_hq.h	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/gui/render_templates_hq.h	2016-12-11 18:35:15.530284006 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
diff -Nur dosbox-0.74/src/gui/render_templates_sai.h dosbox-0.74.patch/src/gui/render_templates_sai.h
--- dosbox-0.74/src/gui/render_templates_sai.h	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/gui/render_templates_sai.h	2016-12-11 18:35:15.530284006 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
diff -Nur dosbox-0.74/src/gui/sdl_gui.cpp dosbox-0.74.patch/src/gui/sdl_gui.cpp
--- dosbox-0.74/src/gui/sdl_gui.cpp	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/gui/sdl_gui.cpp	2016-12-11 18:35:15.530284006 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: sdl_gui.cpp,v 1.11 2009-02-25 19:58:11 c2woody Exp $ */
 
 #if 0
 #include "SDL.h"
@@ -40,7 +39,7 @@
 
 extern Bit8u int10_font_14[256 * 14];
 extern Program * first_shell;
-extern void MSG_Write(const char *);
+extern bool MSG_Write(const char *);
 extern void GFX_SetTitle(Bit32s cycles, Bits frameskip, bool paused);
 
 static int cursor, saved_bpp;
@@ -570,7 +569,7 @@
 			Section_prop *section = static_cast<Section_prop *>(sec);
 			new SectionEditor(getScreen(), 50, 30, section);
 		} else if (arg == "About") {
-			new GUI::MessageBox(getScreen(), 200, 150, 280, "About DOSBox", "\nDOSBox 0.72\nAn emulator for old DOS Games\n\nCopyright 2002-2009\nThe DOSBox Team");
+			new GUI::MessageBox(getScreen(), 200, 150, 280, "About DOSBox", "\nDOSBox 0.74\nAn emulator for old DOS Games\n\nCopyright 2002-2013\nThe DOSBox Team");
 		} else if (arg == "Introduction") {
 			new GUI::MessageBox(getScreen(), 20, 50, 600, "Introduction", MSG_Get("PROGRAM_INTRO"));
 		} else if (arg == "Getting Started") {
diff -Nur dosbox-0.74/src/gui/sdlmain.cpp dosbox-0.74.patch/src/gui/sdlmain.cpp
--- dosbox-0.74/src/gui/sdlmain.cpp	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/gui/sdlmain.cpp	2016-12-11 18:35:49.078282759 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: sdlmain.cpp,v 1.154 2009-06-01 10:25:51 qbix79 Exp $ */
 
 #ifndef _GNU_SOURCE
 #define _GNU_SOURCE
@@ -64,34 +63,30 @@
 #define APIENTRYP APIENTRY *
 #endif
 
-#ifdef __WIN32__
-#define NVIDIA_PixelDataRange 1
-
-#ifndef WGL_NV_allocate_memory
-#define WGL_NV_allocate_memory 1
-typedef void * (APIENTRY * PFNWGLALLOCATEMEMORYNVPROC) (int size, float readfreq, float writefreq, float priority);
-typedef void (APIENTRY * PFNWGLFREEMEMORYNVPROC) (void *pointer);
-#endif
-
-PFNWGLALLOCATEMEMORYNVPROC db_glAllocateMemoryNV = NULL;
-PFNWGLFREEMEMORYNVPROC db_glFreeMemoryNV = NULL;
-
-#else
-
-#endif
-
-#if defined(NVIDIA_PixelDataRange)
-
-#ifndef GL_NV_pixel_data_range
-#define GL_NV_pixel_data_range 1
-#define GL_WRITE_PIXEL_DATA_RANGE_NV      0x8878
-typedef void (APIENTRYP PFNGLPIXELDATARANGENVPROC) (GLenum target, GLsizei length, GLvoid *pointer);
-typedef void (APIENTRYP PFNGLFLUSHPIXELDATARANGENVPROC) (GLenum target);
-#endif
-
-PFNGLPIXELDATARANGENVPROC glPixelDataRangeNV = NULL;
-
-#endif
+#ifndef GL_ARB_pixel_buffer_object
+#define GL_ARB_pixel_buffer_object 1
+#define GL_PIXEL_PACK_BUFFER_ARB           0x88EB
+#define GL_PIXEL_UNPACK_BUFFER_ARB         0x88EC
+#define GL_PIXEL_PACK_BUFFER_BINDING_ARB   0x88ED
+#define GL_PIXEL_UNPACK_BUFFER_BINDING_ARB 0x88EF
+#endif
+
+#ifndef GL_ARB_vertex_buffer_object
+#define GL_ARB_vertex_buffer_object 1
+typedef void (APIENTRYP PFNGLGENBUFFERSARBPROC) (GLsizei n, GLuint *buffers);
+typedef void (APIENTRYP PFNGLBINDBUFFERARBPROC) (GLenum target, GLuint buffer);
+typedef void (APIENTRYP PFNGLDELETEBUFFERSARBPROC) (GLsizei n, const GLuint *buffers);
+typedef void (APIENTRYP PFNGLBUFFERDATAARBPROC) (GLenum target, GLsizeiptr size, const GLvoid *data, GLenum usage);
+typedef GLvoid* (APIENTRYP PFNGLMAPBUFFERARBPROC) (GLenum target, GLenum access);
+typedef GLboolean (APIENTRYP PFNGLUNMAPBUFFERARBPROC) (GLenum target);
+#endif
+
+PFNGLGENBUFFERSARBPROC glGenBuffersARB = NULL;
+PFNGLBINDBUFFERARBPROC glBindBufferARB = NULL;
+PFNGLDELETEBUFFERSARBPROC glDeleteBuffersARB = NULL;
+PFNGLBUFFERDATAARBPROC glBufferDataARB = NULL;
+PFNGLMAPBUFFERARBPROC glMapBufferARB = NULL;
+PFNGLUNMAPBUFFERARBPROC glUnmapBufferARB = NULL;
 
 #endif //C_OPENGL
 
@@ -172,6 +167,8 @@
 		} window;
 		Bit8u bpp;
 		bool fullscreen;
+		bool lazy_fullscreen;
+		bool lazy_fullscreen_req;
 		bool doublebuf;
 		SCREEN_TYPES type;
 		SCREEN_TYPES want_type;
@@ -180,15 +177,14 @@
 	struct {
 		Bitu pitch;
 		void * framebuf;
+		GLuint buffer;
 		GLuint texture;
 		GLuint displaylist;
 		GLint max_texsize;
 		bool bilinear;
 		bool packed_pixel;
 		bool paletted_texture;
-#if defined(NVIDIA_PixelDataRange)
-		bool pixel_data_range;
-#endif
+		bool pixel_buffer_object;
 	} opengl;
 #endif
 	struct {
@@ -229,22 +225,47 @@
 //Globals for keyboard initialisation
 bool startup_state_numlock=false;
 bool startup_state_capslock=false;
+
 void GFX_SetTitle(Bit32s cycles,Bits frameskip,bool paused){
 	char title[200]={0};
 	static Bit32s internal_cycles=0;
-	static Bits internal_frameskip=0;
+	static Bit32s internal_frameskip=0;
 	if(cycles != -1) internal_cycles = cycles;
 	if(frameskip != -1) internal_frameskip = frameskip;
 	if(CPU_CycleAutoAdjust) {
-		sprintf(title,"DOSBox %s, Cpu speed: max %3d%% cycles, Frameskip %2d, Program: %8s",VERSION,internal_cycles,internal_frameskip,RunningProgram);
+		sprintf(title,"DOSBox %s, CPU speed: max %3d%% cycles, Frameskip %2d, Program: %8s",VERSION,internal_cycles,internal_frameskip,RunningProgram);
 	} else {
-		sprintf(title,"DOSBox %s, Cpu speed: %8d cycles, Frameskip %2d, Program: %8s",VERSION,internal_cycles,internal_frameskip,RunningProgram);
+		sprintf(title,"DOSBox %s, CPU speed: %8d cycles, Frameskip %2d, Program: %8s",VERSION,internal_cycles,internal_frameskip,RunningProgram);
 	}
 
 	if(paused) strcat(title," PAUSED");
 	SDL_WM_SetCaption(title,VERSION);
 }
 
+static unsigned char logo[32*32*4]= {
+#include "dosbox_logo.h"
+};
+static void GFX_SetIcon() {
+#if !defined(MACOSX)
+	/* Set Icon (must be done before any sdl_setvideomode call) */
+	/* But don't set it on OS X, as we use a nicer external icon there. */
+	/* Made into a separate call, so it can be called again when we restart the graphics output on win32 */
+#if WORDS_BIGENDIAN
+	SDL_Surface* logos= SDL_CreateRGBSurfaceFrom((void*)logo,32,32,32,128,0xff000000,0x00ff0000,0x0000ff00,0);
+#else
+	SDL_Surface* logos= SDL_CreateRGBSurfaceFrom((void*)logo,32,32,32,128,0x000000ff,0x0000ff00,0x00ff0000,0);
+#endif
+	SDL_WM_SetIcon(logos,NULL);
+#endif
+}
+
+
+static void KillSwitch(bool pressed) {
+	if (!pressed)
+		return;
+	throw 1;
+}
+
 static void PauseDOSBox(bool pressed) {
 	if (!pressed)
 		return;
@@ -261,15 +282,22 @@
 		SDL_WaitEvent(&event);    // since we're not polling, cpu usage drops to 0.
 		switch (event.type) {
 
-			case SDL_QUIT: throw(0); break;
+			case SDL_QUIT: KillSwitch(true); break;
 			case SDL_KEYDOWN:   // Must use Pause/Break Key to resume.
 			case SDL_KEYUP:
-			if(event.key.keysym.sym==SDLK_PAUSE) {
+			if(event.key.keysym.sym == SDLK_PAUSE) {
 
-				paused=false;
+				paused = false;
 				GFX_SetTitle(-1,-1,false);
 				break;
 			}
+#if defined (MACOSX)
+			if (event.key.keysym.sym == SDLK_q && (event.key.keysym.mod == KMOD_RMETA || event.key.keysym.mod == KMOD_LMETA) ) {
+				/* On macs, all aps exit when pressing cmd-q */
+				KillSwitch(true);
+				break;
+			} 
+#endif
 		}
 	}
 }
@@ -354,6 +382,16 @@
 	CPU_Reset_AutoAdjust();
 }
 
+void GFX_ForceFullscreenExit(void) {
+	if (sdl.desktop.lazy_fullscreen) {
+//		sdl.desktop.lazy_fullscreen_req=true;
+		LOG_MSG("GFX LF: invalid screen change");
+	} else {
+		sdl.desktop.fullscreen=false;
+		GFX_ResetScreen();
+	}
+}
+
 static int int_log2 (int val) {
     int log = 0;
     while ((val >>= 1) != 0)
@@ -406,6 +444,16 @@
 	}
 }
 
+void GFX_TearDown(void) {
+	if (sdl.updating)
+		GFX_EndUpdate( 0 );
+
+	if (sdl.blit.surface) {
+		SDL_FreeSurface(sdl.blit.surface);
+		sdl.blit.surface=0;
+	}
+}
+
 Bitu GFX_SetSize(Bitu width,Bitu height,Bitu flags,double scalex,double scaley,GFX_CallBack_t callback) {
 	if (sdl.updating)
 		GFX_EndUpdate( 0 );
@@ -416,7 +464,7 @@
 	sdl.draw.scalex=scalex;
 	sdl.draw.scaley=scaley;
 
-	Bitu bpp=0;
+	int bpp=0;
 	Bitu retFlags = 0;
 
 	if (sdl.blit.surface) {
@@ -447,7 +495,7 @@
 					SDL_FULLSCREEN | ((flags & GFX_CAN_RANDOM) ? SDL_SWSURFACE : SDL_HWSURFACE) |
 					(sdl.desktop.doublebuf ? SDL_DOUBLEBUF|SDL_ASYNCBLIT  : 0)|SDL_HWPALETTE);
 				if (sdl.surface == NULL)
-					E_Exit("Could not set fullscreen video mode %ix%i-%i: %s",width,height,bpp,SDL_GetError());
+					E_Exit("Could not set fullscreen video mode %ix%i-%i: %s",(int)width,(int)height,bpp,SDL_GetError());
 			}
 		} else {
 			sdl.clip.x=0;sdl.clip.y=0;
@@ -465,11 +513,13 @@
 					sdl.using_windib=false;
 				}
 				SDL_InitSubSystem(SDL_INIT_VIDEO);
+				GFX_SetIcon(); //Set Icon again
 				sdl.surface = SDL_SetVideoMode(width,height,bpp,SDL_HWSURFACE);
+				if(sdl.surface) GFX_SetTitle(-1,-1,false); //refresh title.
 			}
 #endif
 			if (sdl.surface == NULL)
-				E_Exit("Could not set windowed video mode %ix%i-%i: %s",width,height,bpp,SDL_GetError());
+				E_Exit("Could not set windowed video mode %ix%i-%i: %s",(int)width,(int)height,bpp,SDL_GetError());
 		}
 		if (sdl.surface) {
 			switch (sdl.surface->format->BitsPerPixel) {
@@ -556,11 +606,10 @@
 #if C_OPENGL
 	case SCREEN_OPENGL:
 	{
-		if (sdl.opengl.framebuf) {
-#if defined(NVIDIA_PixelDataRange)
-			if (sdl.opengl.pixel_data_range) db_glFreeMemoryNV(sdl.opengl.framebuf);
-			else
-#endif
+		if (sdl.opengl.pixel_buffer_object) {
+			glBindBufferARB(GL_PIXEL_UNPACK_BUFFER_EXT, 0);
+			if (sdl.opengl.buffer) glDeleteBuffersARB(1, &sdl.opengl.buffer);
+		} else if (sdl.opengl.framebuf) {
 			free(sdl.opengl.framebuf);
 		}
 		sdl.opengl.framebuf=0;
@@ -580,15 +629,12 @@
 			goto dosurface;
 		}
 		/* Create the texture and display list */
-#if defined(NVIDIA_PixelDataRange)
-		if (sdl.opengl.pixel_data_range) {
-			sdl.opengl.framebuf=db_glAllocateMemoryNV(width*height*4,0.0,1.0,1.0);
-			glPixelDataRangeNV(GL_WRITE_PIXEL_DATA_RANGE_NV,width*height*4,sdl.opengl.framebuf);
-			glEnableClientState(GL_WRITE_PIXEL_DATA_RANGE_NV);
+		if (sdl.opengl.pixel_buffer_object) {
+			glGenBuffersARB(1, &sdl.opengl.buffer);
+			glBindBufferARB(GL_PIXEL_UNPACK_BUFFER_EXT, sdl.opengl.buffer);
+			glBufferDataARB(GL_PIXEL_UNPACK_BUFFER_EXT, width*height*4, NULL, GL_STREAM_DRAW_ARB);
+			glBindBufferARB(GL_PIXEL_UNPACK_BUFFER_EXT, 0);
 		} else {
-#else
-		{
-#endif
 			sdl.opengl.framebuf=malloc(width*height*4);		//32 bit color
 		}
 		sdl.opengl.pitch=width*4;
@@ -642,10 +688,8 @@
 		glEndList();
 		sdl.desktop.type=SCREEN_OPENGL;
 		retFlags = GFX_CAN_32 | GFX_SCALING;
-#if defined(NVIDIA_PixelDataRange)
-		if (sdl.opengl.pixel_data_range)
+		if (sdl.opengl.pixel_buffer_object)
 			retFlags |= GFX_HARDWARE;
-#endif
 	break;
 		}//OPENGL
 #endif	//C_OPENGL
@@ -671,6 +715,18 @@
         mouselocked=sdl.mouse.locked;
 }
 
+void GFX_UpdateSDLCaptureState(void) {
+	if (sdl.mouse.locked) {
+		SDL_WM_GrabInput(SDL_GRAB_ON);
+		SDL_ShowCursor(SDL_DISABLE);
+	} else {
+		SDL_WM_GrabInput(SDL_GRAB_OFF);
+		if (sdl.mouse.autoenable || !sdl.mouse.autolock) SDL_ShowCursor(SDL_ENABLE);
+	}
+	CPU_Reset_AutoAdjust();
+	GFX_SetTitle(-1,-1,false);
+}
+
 bool mouselocked; //Global variable for mapper
 static void CaptureMouse(bool pressed) {
 	if (!pressed)
@@ -678,12 +734,40 @@
 	GFX_CaptureMouse();
 }
 
+#if defined (WIN32)
+STICKYKEYS stick_keys = {sizeof(STICKYKEYS), 0};
+void sticky_keys(bool restore){
+	static bool inited = false;
+	if (!inited){
+		inited = true;
+		SystemParametersInfo(SPI_GETSTICKYKEYS, sizeof(STICKYKEYS), &stick_keys, 0);
+	} 
+	if (restore) {
+		SystemParametersInfo(SPI_SETSTICKYKEYS, sizeof(STICKYKEYS), &stick_keys, 0);
+		return;
+	}
+	//Get current sticky keys layout:
+	STICKYKEYS s = {sizeof(STICKYKEYS), 0};
+	SystemParametersInfo(SPI_GETSTICKYKEYS, sizeof(STICKYKEYS), &s, 0);
+	if ( !(s.dwFlags & SKF_STICKYKEYSON)) { //Not on already
+		s.dwFlags &= ~SKF_HOTKEYACTIVE;
+		SystemParametersInfo(SPI_SETSTICKYKEYS, sizeof(STICKYKEYS), &s, 0);
+	}
+}
+#endif
+
 void GFX_SwitchFullScreen(void) {
 	sdl.desktop.fullscreen=!sdl.desktop.fullscreen;
 	if (sdl.desktop.fullscreen) {
 		if (!sdl.mouse.locked) GFX_CaptureMouse();
+#if defined (WIN32)
+		sticky_keys(false); //disable sticky keys in fullscreen mode
+#endif
 	} else {
 		if (sdl.mouse.locked) GFX_CaptureMouse();
+#if defined (WIN32)		
+		sticky_keys(true); //restore sticky keys to default state in windowed mode.
+#endif
 	}
 	GFX_ResetScreen();
 }
@@ -691,7 +775,32 @@
 static void SwitchFullScreen(bool pressed) {
 	if (!pressed)
 		return;
-	GFX_SwitchFullScreen();
+
+	if (sdl.desktop.lazy_fullscreen) {
+//		sdl.desktop.lazy_fullscreen_req=true;
+		LOG_MSG("GFX LF: fullscreen switching not supported");
+	} else {
+		GFX_SwitchFullScreen();
+	}
+}
+
+void GFX_SwitchLazyFullscreen(bool lazy) {
+	sdl.desktop.lazy_fullscreen=lazy;
+	sdl.desktop.lazy_fullscreen_req=false;
+}
+
+void GFX_SwitchFullscreenNoReset(void) {
+	sdl.desktop.fullscreen=!sdl.desktop.fullscreen;
+}
+
+bool GFX_LazyFullscreenRequested(void) {
+	if (sdl.desktop.lazy_fullscreen) return sdl.desktop.lazy_fullscreen_req;
+	return false;
+}
+
+void GFX_RestoreMode(void) {
+	GFX_SetSize(sdl.draw.width,sdl.draw.height,sdl.draw.flags,sdl.draw.scalex,sdl.draw.scaley,sdl.draw.callback);
+	GFX_UpdateSDLCaptureState();
 }
 
 
@@ -727,14 +836,18 @@
 		return true;
 #endif
 	case SCREEN_OVERLAY:
-		SDL_LockYUVOverlay(sdl.overlay);
+		if (SDL_LockYUVOverlay(sdl.overlay)) return false;
 		pixels=(Bit8u *)*(sdl.overlay->pixels);
 		pitch=*(sdl.overlay->pitches);
 		sdl.updating=true;
 		return true;
 #if C_OPENGL
 	case SCREEN_OPENGL:
-		pixels=(Bit8u *)sdl.opengl.framebuf;
+		if(sdl.opengl.pixel_buffer_object) {
+		    glBindBufferARB(GL_PIXEL_UNPACK_BUFFER_EXT, sdl.opengl.buffer);
+		    pixels=(Bit8u *)glMapBufferARB(GL_PIXEL_UNPACK_BUFFER_EXT, GL_WRITE_ONLY);
+		} else
+		    pixels=(Bit8u *)sdl.opengl.framebuf;
 		pitch=sdl.opengl.pitch;
 		sdl.updating=true;
 		return true;
@@ -814,19 +927,18 @@
 		break;
 #if C_OPENGL
 	case SCREEN_OPENGL:
-#if defined(NVIDIA_PixelDataRange)
-		if (sdl.opengl.pixel_data_range) {
-            glBindTexture(GL_TEXTURE_2D, sdl.opengl.texture);
+		if (sdl.opengl.pixel_buffer_object) {
+			glUnmapBufferARB(GL_PIXEL_UNPACK_BUFFER_EXT);
+			glBindTexture(GL_TEXTURE_2D, sdl.opengl.texture);
 			glTexSubImage2D(GL_TEXTURE_2D, 0, 0, 0,
 					sdl.draw.width, sdl.draw.height, GL_BGRA_EXT,
-					GL_UNSIGNED_INT_8_8_8_8_REV, sdl.opengl.framebuf);
+					GL_UNSIGNED_INT_8_8_8_8_REV, 0);
+			glBindBufferARB(GL_PIXEL_UNPACK_BUFFER_EXT, 0);
 			glCallList(sdl.opengl.displaylist);
 			SDL_GL_SwapBuffers();
-		} else
-#endif
-		if (changedLines) {
+		} else if (changedLines) {
 			Bitu y = 0, index = 0;
-            glBindTexture(GL_TEXTURE_2D, sdl.opengl.texture);
+			glBindTexture(GL_TEXTURE_2D, sdl.opengl.texture);
 			while (y < sdl.draw.height) {
 				if (!(index & 1)) {
 					y += changedLines[index];
@@ -905,11 +1017,6 @@
 	if (sdl.desktop.fullscreen) GFX_SwitchFullScreen();
 }
 
-static void KillSwitch(bool pressed) {
-	if (!pressed)
-		return;
-	throw 1;
-}
 
 static void SetPriority(PRIORITY_LEVELS level) {
 
@@ -983,28 +1090,21 @@
 	}
 }
 
-static unsigned char logo[32*32*4]= {
-#include "dosbox_logo.h"
-};
 #include "dosbox_splash.h"
 
 //extern void UI_Run(bool);
+void Restart(bool pressed);
+
 static void GUI_StartUp(Section * sec) {
 	sec->AddDestroyFunction(&GUI_ShutDown);
 	Section_prop * section=static_cast<Section_prop *>(sec);
 	sdl.active=false;
 	sdl.updating=false;
 
-#if !defined(MACOSX)
-	/* Set Icon (must be done before any sdl_setvideomode call) */
-	/* But don't set it on OS X, as we use a nicer external icon there. */
-#if WORDS_BIGENDIAN
-	SDL_Surface* logos= SDL_CreateRGBSurfaceFrom((void*)logo,32,32,32,128,0xff000000,0x00ff0000,0x0000ff00,0);
-#else
-	SDL_Surface* logos= SDL_CreateRGBSurfaceFrom((void*)logo,32,32,32,128,0x000000ff,0x0000ff00,0x00ff0000,0);
-#endif
-	SDL_WM_SetIcon(logos,NULL);
-#endif
+	GFX_SetIcon();
+
+	sdl.desktop.lazy_fullscreen=false;
+	sdl.desktop.lazy_fullscreen_req=false;
 
 	sdl.desktop.fullscreen=section->Get_bool("fullscreen");
 	sdl.wait_on_error=section->Get_bool("waitonerror");
@@ -1043,13 +1143,15 @@
 		char res[100];
 		strncpy( res, fullresolution, sizeof( res ));
 		fullresolution = lowcase (res);//so x and X are allowed
-		if(strcmp(fullresolution,"original")) {
+		if (strcmp(fullresolution,"original")) {
 			sdl.desktop.full.fixed = true;
-			char* height = const_cast<char*>(strchr(fullresolution,'x'));
-			if(height && * height) {
-				*height = 0;
-				sdl.desktop.full.height = (Bit16u)atoi(height+1);
-				sdl.desktop.full.width  = (Bit16u)atoi(res);
+			if (strcmp(fullresolution,"desktop")) { //desktop = 0x0
+				char* height = const_cast<char*>(strchr(fullresolution,'x'));
+				if (height && * height) {
+					*height = 0;
+					sdl.desktop.full.height = (Bit16u)atoi(height+1);
+					sdl.desktop.full.width  = (Bit16u)atoi(res);
+				}
 			}
 		}
 	}
@@ -1071,10 +1173,22 @@
 		}
 	}
 	sdl.desktop.doublebuf=section->Get_bool("fulldouble");
+#if SDL_VERSION_ATLEAST(1, 2, 10)
+	if (!sdl.desktop.full.width || !sdl.desktop.full.height){
+		//Can only be done on the very first call! Not restartable.
+		const SDL_VideoInfo* vidinfo = SDL_GetVideoInfo();
+		if (vidinfo) {
+			sdl.desktop.full.width = vidinfo->current_w;
+			sdl.desktop.full.height = vidinfo->current_h;
+		}
+	}
+#endif
+
 	if (!sdl.desktop.full.width) {
 #ifdef WIN32
 		sdl.desktop.full.width=(Bit16u)GetSystemMetrics(SM_CXSCREEN);
 #else
+		LOG_MSG("Your fullscreen resolution can NOT be determined, it's assumed to be 1024x768.\nPlease edit the configuration file if this value is wrong.");
 		sdl.desktop.full.width=1024;
 #endif
 	}
@@ -1123,24 +1237,24 @@
 		LOG_MSG("Could not initialize OpenGL, switching back to surface");
 		sdl.desktop.want_type=SCREEN_SURFACE;
 	} else {
+	sdl.opengl.buffer=0;
 	sdl.opengl.framebuf=0;
 	sdl.opengl.texture=0;
 	sdl.opengl.displaylist=0;
 	glGetIntegerv (GL_MAX_TEXTURE_SIZE, &sdl.opengl.max_texsize);
-#if defined(__WIN32__) && defined(NVIDIA_PixelDataRange)
-	glPixelDataRangeNV = (PFNGLPIXELDATARANGENVPROC) wglGetProcAddress("glPixelDataRangeNV");
-	db_glAllocateMemoryNV = (PFNWGLALLOCATEMEMORYNVPROC) wglGetProcAddress("wglAllocateMemoryNV");
-	db_glFreeMemoryNV = (PFNWGLFREEMEMORYNVPROC) wglGetProcAddress("wglFreeMemoryNV");
-#endif
+	glGenBuffersARB = (PFNGLGENBUFFERSARBPROC)SDL_GL_GetProcAddress("glGenBuffersARB");
+	glBindBufferARB = (PFNGLBINDBUFFERARBPROC)SDL_GL_GetProcAddress("glBindBufferARB");
+	glDeleteBuffersARB = (PFNGLDELETEBUFFERSARBPROC)SDL_GL_GetProcAddress("glDeleteBuffersARB");
+	glBufferDataARB = (PFNGLBUFFERDATAARBPROC)SDL_GL_GetProcAddress("glBufferDataARB");
+	glMapBufferARB = (PFNGLMAPBUFFERARBPROC)SDL_GL_GetProcAddress("glMapBufferARB");
+	glUnmapBufferARB = (PFNGLUNMAPBUFFERARBPROC)SDL_GL_GetProcAddress("glUnmapBufferARB");
 	const char * gl_ext = (const char *)glGetString (GL_EXTENSIONS);
 	if(gl_ext && *gl_ext){
 		sdl.opengl.packed_pixel=(strstr(gl_ext,"EXT_packed_pixels") > 0);
 		sdl.opengl.paletted_texture=(strstr(gl_ext,"EXT_paletted_texture") > 0);
-#if defined(NVIDIA_PixelDataRange)
-		sdl.opengl.pixel_data_range=(strstr(gl_ext,"GL_NV_pixel_data_range") >0 ) &&
-			glPixelDataRangeNV && db_glAllocateMemoryNV && db_glFreeMemoryNV;
-		sdl.opengl.pixel_data_range = 0;
-#endif
+		sdl.opengl.pixel_buffer_object=(strstr(gl_ext,"GL_ARB_pixel_buffer_object") >0 ) &&
+		    glGenBuffersARB && glBindBufferARB && glDeleteBuffersARB && glBufferDataARB &&
+		    glMapBufferARB && glUnmapBufferARB;
     	} else {
 		sdl.opengl.packed_pixel=sdl.opengl.paletted_texture=false;
 	}
@@ -1234,6 +1348,7 @@
 	MAPPER_AddHandler(KillSwitch,MK_f9,MMOD1,"shutdown","ShutDown");
 	MAPPER_AddHandler(CaptureMouse,MK_f10,MMOD1,"capmouse","Cap Mouse");
 	MAPPER_AddHandler(SwitchFullScreen,MK_return,MMOD2,"fullscr","Fullscreen");
+	MAPPER_AddHandler(Restart,MK_home,MMOD1|MMOD2,"restart","Restart");
 #if C_DEBUG
 	/* Pause binds with activate-debugger */
 #else
@@ -1309,6 +1424,10 @@
 	MAPPER_LosingFocus();
 }
 
+bool GFX_IsFullscreen(void) {
+	return sdl.desktop.fullscreen;
+}
+
 void GFX_Events() {
 	SDL_Event event;
 #if defined (REDUCE_JOYSTICK_POLLING)
@@ -1334,8 +1453,7 @@
 #ifdef WIN32
 						if (sdl.desktop.fullscreen) {
 							VGA_KillDrawing();
-							sdl.desktop.fullscreen=false;
-							GFX_ResetScreen();
+							GFX_ForceFullscreenExit();
 						}
 #endif
 						GFX_CaptureMouse();
@@ -1418,6 +1536,15 @@
 			if (((event.key.keysym.sym==SDLK_TAB)) &&
 				((sdl.laltstate==SDL_KEYDOWN) || (sdl.raltstate==SDL_KEYDOWN))) break;
 #endif
+#if defined (MACOSX)			
+		case SDL_KEYDOWN:
+		case SDL_KEYUP:
+			/* On macs CMD-Q is the default key to close an application */
+			if (event.key.keysym.sym == SDLK_q && (event.key.keysym.mod == KMOD_RMETA || event.key.keysym.mod == KMOD_LMETA) ) {
+				KillSwitch(true);
+				break;
+			} 
+#endif
 		default:
 			void MAPPER_CheckEvent(SDL_Event * event);
 			MAPPER_CheckEvent(&event);
@@ -1471,7 +1598,7 @@
 	Pbool->Set_help("Use double buffering in fullscreen. It can reduce screen flickering, but it can also result in a slow DOSBox.");
 
 	Pstring = sdl_sec->Add_string("fullresolution",Property::Changeable::Always,"original");
-	Pstring->Set_help("What resolution to use for fullscreen: original or fixed size (e.g. 1024x768).\n"
+	Pstring->Set_help("What resolution to use for fullscreen: original, desktop or a fixed size (e.g. 1024x768).\n"
 	                  "  Using your monitor's native resolution with aspect=true might give the best results.\n"
 			  "  If you end up with small window on a large screen, try an output different from surface.");
 
@@ -1516,9 +1643,9 @@
 	Pstring->Set_values(inactt);
 
 	Pstring = sdl_sec->Add_path("mapperfile",Property::Changeable::Always,MAPPERFILE);
-	Pstring->Set_help("File used to load/save the key/event mappings from. Resetmapper only works with the defaul value.");
+	Pstring->Set_help("File used to load/save the key/event mappings from. Resetmapper only works with the default value.");
 
-	Pbool = sdl_sec->Add_bool("usescancodes",Property::Changeable::Always,true);
+	Pbool = sdl_sec->Add_bool("usescancodes",Property::Changeable::Always,false);
 	Pbool->Set_help("Avoid usage of symkeys, might not work on all operating systems.");
 }
 
@@ -1529,7 +1656,7 @@
 	if ( !sdl.inited && SDL_Init(SDL_INIT_VIDEO|SDL_INIT_NOPARACHUTE) < 0 ) textonly = true;
 	sdl.inited = true;
 #endif
-	printf(message);
+	printf("%s",message);
 	if(textonly) return;
 	if(!sdl.surface) sdl.surface = SDL_SetVideoMode(640,400,0,0);
 	if(!sdl.surface) return;
@@ -1586,6 +1713,32 @@
 	printf("can't find editor(s) specified at the command line.\n");
 	exit(1);
 }
+#if C_DEBUG
+extern void DEBUG_ShutDown(Section * /*sec*/);
+#endif
+
+void restart_program(std::vector<std::string> & parameters) {
+	char** newargs = new char* [parameters.size()+1];
+	// parameter 0 is the executable path
+	// contents of the vector follow
+	// last one is NULL
+	for(Bitu i = 0; i < parameters.size(); i++) newargs[i]=(char*)parameters[i].c_str();
+	newargs[parameters.size()] = NULL;
+	SDL_CloseAudio();
+	SDL_Delay(50);
+	SDL_Quit();
+#if C_DEBUG
+	// shutdown curses
+	DEBUG_ShutDown(NULL);
+#endif
+
+	execvp(newargs[0], newargs);
+	free(newargs);
+}
+void Restart(bool pressed) { // mapper handler
+	restart_program(control->startup_params);
+}
+
 static void launchcaptures(std::string const& edit) {
 	std::string path,file;
 	Section* t = control->GetSection("dosbox");
@@ -1665,7 +1818,6 @@
 }
 
 
-
 //extern void UI_Init(void);
 int main(int argc, char* argv[]) {
 	try {
@@ -1683,7 +1835,7 @@
 		if(control->cmdline->FindExist("-resetconf")) eraseconfigfile();
 		if(control->cmdline->FindExist("-erasemapper")) erasemapperfile();
 		if(control->cmdline->FindExist("-resetmapper")) erasemapperfile();
-
+		
 		/* Can't disable the console with debugger enabled */
 #if defined(WIN32) && !(C_DEBUG)
 		if (control->cmdline->FindExist("-noconsole")) {
@@ -1708,7 +1860,7 @@
 #endif  //defined(WIN32) && !(C_DEBUG)
 		if (control->cmdline->FindExist("-version") ||
 		    control->cmdline->FindExist("--version") ) {
-			printf("\nDOSBox version %s, copyright 2002-2010 DOSBox Team.\n\n",VERSION);
+			printf("\nDOSBox version %s, copyright 2002-2013 DOSBox Team.\n\n",VERSION);
 			printf("DOSBox is written by the DOSBox Team (See AUTHORS file))\n");
 			printf("DOSBox comes with ABSOLUTELY NO WARRANTY.  This is free software,\n");
 			printf("and you are welcome to redistribute it under certain conditions;\n");
@@ -1736,11 +1888,15 @@
 
 	/* Display Welcometext in the console */
 	LOG_MSG("DOSBox version %s",VERSION);
-	LOG_MSG("Copyright 2002-2010 DOSBox Team, published under GNU GPL.");
+	LOG_MSG("Copyright 2002-2013 DOSBox Team, published under GNU GPL.");
 	LOG_MSG("---");
 
 	/* Init SDL */
 #if SDL_VERSION_ATLEAST(1, 2, 14)
+	/* Or debian/ubuntu with older libsdl version as they have done this themselves, but then differently.
+	 * with this variable they will work correctly. I've only tested the 1.2.14 behaviour against the windows version
+	 * of libsdl
+	 */
 	putenv(const_cast<char*>("SDL_DISABLE_LOCK_KEYS=1"));
 #endif
 	if ( SDL_Init( SDL_INIT_AUDIO|SDL_INIT_VIDEO|SDL_INIT_TIMER|SDL_INIT_CDROM
@@ -1790,15 +1946,16 @@
 
 	/* Parse configuration files */
 	std::string config_file,config_path;
-	bool parsed_anyconfigfile = false;
-	//First Parse -userconf
+	Cross::GetPlatformConfigDir(config_path);
+	
+	//First parse -userconf
 	if(control->cmdline->FindExist("-userconf",true)){
 		config_file.clear();
 		Cross::GetPlatformConfigDir(config_path);
 		Cross::GetPlatformConfigName(config_file);
 		config_path += config_file;
-		if(control->ParseConfigFile(config_path.c_str())) parsed_anyconfigfile = true;
-		if(!parsed_anyconfigfile) {
+		control->ParseConfigFile(config_path.c_str());
+		if(!control->configfiles.size()) {
 			//Try to create the userlevel configfile.
 			config_file.clear();
 			Cross::CreatePlatformConfigDir(config_path);
@@ -1807,29 +1964,29 @@
 			if(control->PrintConfig(config_path.c_str())) {
 				LOG_MSG("CONFIG: Generating default configuration.\nWriting it to %s",config_path.c_str());
 				//Load them as well. Makes relative paths much easier
-				if(control->ParseConfigFile(config_path.c_str())) parsed_anyconfigfile = true;
+				control->ParseConfigFile(config_path.c_str());
 			}
 		}
 	}
 
-	//Second parse -conf entries
-	while(control->cmdline->FindString("-conf",config_file,true))
-		if (control->ParseConfigFile(config_file.c_str())) parsed_anyconfigfile = true;
-
-	//if none found => parse localdir conf
-	config_file = "dosbox.conf";
-	if (!parsed_anyconfigfile && control->ParseConfigFile(config_file.c_str())) parsed_anyconfigfile = true;
+	//Second parse -conf switches
+	while(control->cmdline->FindString("-conf",config_file,true)) {
+		if(!control->ParseConfigFile(config_file.c_str())) {
+			// try to load it from the user directory
+			control->ParseConfigFile((config_path + config_file).c_str());
+		}
+	}
+	// if none found => parse localdir conf
+	if(!control->configfiles.size()) control->ParseConfigFile("dosbox.conf");
 
-	//if none found => parse userlevel conf
-	if(!parsed_anyconfigfile) {
+	// if none found => parse userlevel conf
+	if(!control->configfiles.size()) {
 		config_file.clear();
-		Cross::GetPlatformConfigDir(config_path);
 		Cross::GetPlatformConfigName(config_file);
-		config_path += config_file;
-		if(control->ParseConfigFile(config_path.c_str())) parsed_anyconfigfile = true;
+		control->ParseConfigFile((config_path + config_file).c_str());
 	}
 
-	if(!parsed_anyconfigfile) {
+	if(!control->configfiles.size()) {
 		//Try to create the userlevel configfile.
 		config_file.clear();
 		Cross::CreatePlatformConfigDir(config_path);
@@ -1856,7 +2013,7 @@
 		Section_prop * sdl_sec=static_cast<Section_prop *>(control->GetSection("sdl"));
 
 		if (control->cmdline->FindExist("-fullscreen") || sdl_sec->Get_bool("fullscreen")) {
-			if(!sdl.desktop.fullscreen) { //only switch if not allready in fullscreen
+			if(!sdl.desktop.fullscreen) { //only switch if not already in fullscreen
 				GFX_SwitchFullScreen();
 			}
 		}
@@ -1868,6 +2025,9 @@
 		control->StartUp();
 		/* Shutdown everything */
 	} catch (char * error) {
+#if defined (WIN32)
+		sticky_keys(true);
+#endif
 		GFX_ShowMsg("Exit to error: %s",error);
 		fflush(NULL);
 		if(sdl.wait_on_error) {
@@ -1883,14 +2043,14 @@
 
 	}
 	catch (int){
-		;//nothing pressed killswitch
+		; //nothing, pressed killswitch
 	}
 	catch(...){
-		//Force visible mouse to end user. Somehow this sometimes doesn't happen
-		SDL_WM_GrabInput(SDL_GRAB_OFF);
-		SDL_ShowCursor(SDL_ENABLE);
-		throw;//dunno what happened. rethrow for sdl to catch
+		; // Unknown error, let's just exit.
 	}
+#if defined (WIN32)
+	sticky_keys(true); //Might not be needed if the shutdown function switches to windowed mode, but it doesn't hurt
+#endif 
 	//Force visible mouse to end user. Somehow this sometimes doesn't happen
 	SDL_WM_GrabInput(SDL_GRAB_OFF);
 	SDL_ShowCursor(SDL_ENABLE);
diff -Nur dosbox-0.74/src/gui/sdl_mapper.cpp dosbox-0.74.patch/src/gui/sdl_mapper.cpp
--- dosbox-0.74/src/gui/sdl_mapper.cpp	2010-05-10 20:58:06.000000000 +0200
+++ dosbox-0.74.patch/src/gui/sdl_mapper.cpp	2016-12-11 18:35:15.534284006 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: sdl_mapper.cpp,v 1.60 2009-06-01 10:25:51 qbix79 Exp $ */
 
 #include <vector>
 #include <list>
@@ -521,11 +520,12 @@
 };
 
 #define MAX_VJOY_BUTTONS 8
-
+#define MAX_VJOY_HAT 16
+#define MAX_VJOY_AXIS 8
 static struct {
 	bool button_pressed[MAX_VJOY_BUTTONS];
-	Bit16s axis_pos[8];
-	bool hat_pressed[16];
+	Bit16s axis_pos[MAX_VJOY_AXIS];
+	bool hat_pressed[MAX_VJOY_HAT];
 } virtual_joysticks[2];
 
 
@@ -1584,6 +1584,9 @@
 		case MK_printscreen:
 			key=SDLK_PRINT;
 			break;
+		case MK_home: 
+			key=SDLK_HOME; 
+			break;
 		}
 		sprintf(buf,"%s \"key %d%s%s%s\"",
 			entry,
@@ -2105,7 +2108,7 @@
 }
 
 void MAPPER_AddHandler(MAPPER_Handler * handler,MapKeys key,Bitu mods,char const * const eventname,char const * const buttonname) {
-	//Check if it allready exists=> if so return.
+	//Check if it already exists=> if so return.
 	for(CHandlerEventVector_it it=handlergroup.begin();it!=handlergroup.end();it++)
 		if(strcmp((*it)->buttonname,buttonname) == 0) return;
 
@@ -2359,17 +2362,21 @@
 	if (!MAPPER_LoadBinds()) CreateDefaultBinds();
 	if (SDL_GetModState()&KMOD_CAPS) {
 		for (CBindList_it bit=caps_lock_event->bindlist.begin();bit!=caps_lock_event->bindlist.end();bit++) {
-			(*bit)->ActivateBind(32767,true,true);
 #if SDL_VERSION_ATLEAST(1, 2, 14)
+			(*bit)->ActivateBind(32767,true,false);
 			(*bit)->DeActivateBind(false);
+#else
+			(*bit)->ActivateBind(32767,true,true); //Skip the action itself as bios_keyboard.cpp handles the startup state.
 #endif
 		}
 	}
 	if (SDL_GetModState()&KMOD_NUM) {
 		for (CBindList_it bit=num_lock_event->bindlist.begin();bit!=num_lock_event->bindlist.end();bit++) {
-			(*bit)->ActivateBind(32767,true,true);
 #if SDL_VERSION_ATLEAST(1, 2, 14)
+			(*bit)->ActivateBind(32767,true,false);
 			(*bit)->DeActivateBind(false);
+#else
+			(*bit)->ActivateBind(32767,true,true);
 #endif
 		}
 	}
@@ -2384,15 +2391,17 @@
 	mapper.sticks.num=0;
 	mapper.sticks.num_groups=0;
 	Bitu i;
-	for (i=0; i<16; i++) {
+	for (i=0; i<MAX_VJOY_BUTTONS; i++) {
 		virtual_joysticks[0].button_pressed[i]=false;
 		virtual_joysticks[1].button_pressed[i]=false;
+	}
+	for (i=0; i<MAX_VJOY_HAT; i++) {
 		virtual_joysticks[0].hat_pressed[i]=false;
 		virtual_joysticks[1].hat_pressed[i]=false;
 	}
-	for (i=0; i<8; i++) {
-		virtual_joysticks[0].axis_pos[i]=0;
+	for (i=0; i<MAX_VJOY_AXIS; i++) {
 		virtual_joysticks[0].axis_pos[i]=0;
+		virtual_joysticks[1].axis_pos[i]=0;
 	}
 
 	usescancodes = false;
diff -Nur dosbox-0.74/src/hardware/adlib.cpp dosbox-0.74.patch/src/hardware/adlib.cpp
--- dosbox-0.74/src/hardware/adlib.cpp	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/hardware/adlib.cpp	2016-12-11 18:35:15.534284006 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: adlib.cpp,v 1.42 2009-11-03 20:17:42 qbix79 Exp $ */
 
 #include <stdlib.h>
 #include <string.h>
diff -Nur dosbox-0.74/src/hardware/adlib.h dosbox-0.74.patch/src/hardware/adlib.h
--- dosbox-0.74/src/hardware/adlib.h	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/hardware/adlib.h	2016-12-11 18:35:15.534284006 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: adlib.h,v 1.5 2009-04-28 21:45:43 c2woody Exp $ */
 
 #ifndef DOSBOX_ADLIB_H
 #define DOSBOX_ADLIB_H
diff -Nur dosbox-0.74/src/hardware/cmos.cpp dosbox-0.74.patch/src/hardware/cmos.cpp
--- dosbox-0.74/src/hardware/cmos.cpp	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/hardware/cmos.cpp	2016-12-11 18:35:15.534284006 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: cmos.cpp,v 1.29 2009-06-16 18:19:18 qbix79 Exp $ */
 
 #include <time.h>
 #include <math.h>
diff -Nur dosbox-0.74/src/hardware/dbopl.cpp dosbox-0.74.patch/src/hardware/dbopl.cpp
--- dosbox-0.74/src/hardware/dbopl.cpp	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/hardware/dbopl.cpp	2016-12-11 18:35:15.534284006 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -32,7 +32,6 @@
 	//DUNNO Keyon in 4op, switch to 2op without keyoff.
 */
 
-/* $Id: dbopl.cpp,v 1.10 2009-06-10 19:54:51 harekiet Exp $ */
 
 
 #include <math.h>
diff -Nur dosbox-0.74/src/hardware/dbopl.h dosbox-0.74.patch/src/hardware/dbopl.h
--- dosbox-0.74/src/hardware/dbopl.h	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/hardware/dbopl.h	2016-12-11 18:35:15.534284006 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
diff -Nur dosbox-0.74/src/hardware/disney.cpp dosbox-0.74.patch/src/hardware/disney.cpp
--- dosbox-0.74/src/hardware/disney.cpp	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/hardware/disney.cpp	2016-12-11 18:35:15.534284006 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: disney.cpp,v 1.17 2009-05-14 17:04:37 qbix79 Exp $ */
 
 #include <string.h>
 #include "dosbox.h"
@@ -70,11 +69,9 @@
 	if(disney.mo) {
 		disney.chan->AddSilence();
 		disney.chan->Enable(false);
-		delete disney.mo;
 	}
 	disney.leader = 0;
 	disney.last_used = 0;
-	disney.mo = 0;
 	disney.state = DS_IDLE;
 	disney.interface_det = 0;
 	disney.interface_det_ext = 0;
@@ -91,8 +88,7 @@
 		if(disney.stereo) LOG(LOG_MISC,LOG_NORMAL)("disney enable %d Hz, stereo",freq);
 		else LOG(LOG_MISC,LOG_NORMAL)("disney enable %d Hz, mono",freq);
 #endif
-		disney.mo = new MixerObject();
-		disney.chan=disney.mo->Install(&DISNEY_CallBack,freq,"DISNEY");
+		disney.chan->SetFreq(freq);
 		disney.chan->Enable(true);
 		disney.state = DS_RUNNING;
 	}
@@ -378,11 +374,16 @@
 		disney.control=0;
 		disney.last_used=0;
 
-		disney.mo=0;
+		disney.mo = new MixerObject();
+		disney.chan=disney.mo->Install(&DISNEY_CallBack,10000,"DISNEY");
 		DISNEY_disable(0);
+
+
 	}
 	~DISNEY(){
 		DISNEY_disable(0);
+		if (disney.mo)
+			delete disney.mo;
 	}
 };
 
diff -Nur dosbox-0.74/src/hardware/dma.cpp dosbox-0.74.patch/src/hardware/dma.cpp
--- dosbox-0.74/src/hardware/dma.cpp	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/hardware/dma.cpp	2016-12-11 18:35:15.534284006 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: dma.cpp,v 1.41 2009-07-24 09:56:14 c2woody Exp $ */
 
 #include <string.h>
 #include "dosbox.h"
@@ -32,6 +31,8 @@
 #define EMM_PAGEFRAME4K	((0xE000*16)/4096)
 Bit32u ems_board_mapping[LINK_START];
 
+static Bit32u dma_wrapping = 0xffff;
+
 static void UpdateEMSMapping(void) {
 	/* if EMS is not present, this will result in a 1:1 mapping */
 	Bitu i;
@@ -48,7 +49,9 @@
 	offset <<= dma16;
 	Bit32u dma_wrap = ((0xffff<<dma16)+dma16) | dma_wrapping;
 	for ( ; size ; size--, offset++) {
-		if (offset>(dma_wrapping<<dma16)) E_Exit("DMA segbound wrapping (read)");
+		if (offset>(dma_wrapping<<dma16)) {
+			LOG_MSG("DMA segbound wrapping (read): %x:%x size %x [%x] wrap %x",spage,offset,size,dma16,dma_wrapping);
+		}
 		offset &= dma_wrap;
 		Bitu page = highpart_addr_page+(offset >> 12);
 		/* care for EMS pageframe etc. */
@@ -67,7 +70,9 @@
 	offset <<= dma16;
 	Bit32u dma_wrap = ((0xffff<<dma16)+dma16) | dma_wrapping;
 	for ( ; size ; size--, offset++) {
-		if (offset>(dma_wrapping<<dma16)) E_Exit("DMA segbound wrapping (write)");
+		if (offset>(dma_wrapping<<dma16)) {
+			LOG_MSG("DMA segbound wrapping (write): %x:%x size %x [%x] wrap %x",spage,offset,size,dma16,dma_wrapping);
+		}
 		offset &= dma_wrap;
 		Bitu page = highpart_addr_page+(offset >> 12);
 		/* care for EMS pageframe etc. */
diff -Nur dosbox-0.74/src/hardware/gameblaster.cpp dosbox-0.74.patch/src/hardware/gameblaster.cpp
--- dosbox-0.74/src/hardware/gameblaster.cpp	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/hardware/gameblaster.cpp	2016-12-11 18:35:15.534284006 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
diff -Nur dosbox-0.74/src/hardware/gus.cpp dosbox-0.74.patch/src/hardware/gus.cpp
--- dosbox-0.74/src/hardware/gus.cpp	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/hardware/gus.cpp	2016-12-11 18:35:15.534284006 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: gus.cpp,v 1.37 2009-09-03 16:03:01 c2woody Exp $ */
 
 #include <string.h>
 #include <iomanip>
@@ -770,7 +769,7 @@
 		vol16bit[i]=(Bit16s)out;
 		out/=1.002709201;		/* 0.0235 dB Steps */
 	}
-	pantable[0]=0;
+	pantable[0] = 4095 << RAMP_FRACT;
 	for (i=1;i<16;i++) {
 		pantable[i]=(Bit32u)(-128.0*(log((double)i/15.0)/log(2.0))*(double)(1 << RAMP_FRACT));
 	}
diff -Nur dosbox-0.74/src/hardware/hardware.cpp dosbox-0.74.patch/src/hardware/hardware.cpp
--- dosbox-0.74/src/hardware/hardware.cpp	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/hardware/hardware.cpp	2016-12-11 18:35:15.534284006 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: hardware.cpp,v 1.23 2009-10-11 18:09:22 qbix79 Exp $ */
 
 #include <string.h>
 #include <stdlib.h>
@@ -161,13 +160,17 @@
 #endif
 
 #if (C_SSHOT)
+static void CAPTURE_VideoEvent(bool pressed) {
+	if (!pressed)
+		return;
+	if (CaptureState & CAPTURE_VIDEO) {
+		/* Close the video */
+		CaptureState &= ~CAPTURE_VIDEO;
+		LOG_MSG("Stopped capturing video.");	
 
-static void CAPTURE_VideoHeader() {
 		Bit8u avi_header[AVI_HEADER_SIZE];
 		Bitu main_list;
 		Bitu header_pos=0;
-		Bitu save_pos=ftell(capture.video.handle);
-
 #define AVIOUT4(_S_) memcpy(&avi_header[header_pos],_S_,4);header_pos+=4;
 #define AVIOUTw(_S_) host_writew(&avi_header[header_pos], _S_);header_pos+=2;
 #define AVIOUTd(_S_) host_writed(&avi_header[header_pos], _S_);header_pos+=4;
@@ -284,20 +287,6 @@
 		fwrite( capture.video.index, 1, capture.video.indexused, capture.video.handle);
 		fseek(capture.video.handle, 0, SEEK_SET);
 		fwrite(&avi_header, 1, AVI_HEADER_SIZE, capture.video.handle);
-		fseek(capture.video.handle, save_pos, SEEK_SET);
-}
-
-static void CAPTURE_VideoEvent(bool pressed) {
-	if (!pressed)
-		return;
-	if (CaptureState & CAPTURE_VIDEO) {
-		/* Close the video */
-		CaptureState &= ~CAPTURE_VIDEO;
-		LOG_MSG("Stopped capturing video.");	
-
-		/* Adds AVI header to the file */
-		CAPTURE_VideoHeader();
-
 		fclose( capture.video.handle );
 		free( capture.video.index );
 		free( capture.video.buf );
@@ -334,7 +323,7 @@
 		/* Open the actual file */
 		FILE * fp=OpenCaptureFile("Screenshot",".png");
 		if (!fp) goto skip_shot;
-		/* First try to alloacte the png structures */
+		/* First try to allocate the png structures */
 		png_ptr = png_create_write_struct(PNG_LIBPNG_VER_STRING, NULL,NULL, NULL);
 		if (!png_ptr) goto skip_shot;
 		info_ptr = png_create_info_struct(png_ptr);
@@ -370,7 +359,23 @@
 				8, PNG_COLOR_TYPE_RGB, PNG_INTERLACE_NONE,
 				PNG_COMPRESSION_TYPE_DEFAULT, PNG_FILTER_TYPE_DEFAULT);
 		}
+#ifdef PNG_TEXT_SUPPORTED
+		int fields = 1;
+		png_text text[1];
+		const char* text_s = "DOSBox " VERSION;
+		size_t strl = strlen(text_s);
+		char* ptext_s = new char[strl + 1];
+		strcpy(ptext_s, text_s);
+		char software[9] = { 'S','o','f','t','w','a','r','e',0};
+		text[0].compression = PNG_TEXT_COMPRESSION_NONE;
+		text[0].key  = software;
+		text[0].text = ptext_s;
+		png_set_text(png_ptr, info_ptr, text, fields);
+#endif
 		png_write_info(png_ptr, info_ptr);
+#ifdef PNG_TEXT_SUPPORTED
+		delete [] ptext_s;
+#endif
 		for (i=0;i<height;i++) {
 			void *rowPointer;
 			void *srcLine;
@@ -557,9 +562,6 @@
 			capture.video.audioused = 0;
 		}
 
-		/* Adds AVI header to the file */
-		CAPTURE_VideoHeader();
-
 		/* Everything went okay, set flag again for next frame */
 		CaptureState |= CAPTURE_VIDEO;
 	}
@@ -756,6 +758,9 @@
 #endif
 	}
 	~HARDWARE(){
+#if (C_SSHOT)
+		if (capture.video.handle) CAPTURE_VideoEvent(true);
+#endif
 		if (capture.wave.handle) CAPTURE_WaveEvent(true);
 		if (capture.midi.handle) CAPTURE_MidiEvent(true);
 	}
diff -Nur dosbox-0.74/src/hardware/iohandler.cpp dosbox-0.74.patch/src/hardware/iohandler.cpp
--- dosbox-0.74/src/hardware/iohandler.cpp	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/hardware/iohandler.cpp	2016-12-11 18:35:15.534284006 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: iohandler.cpp,v 1.30 2009-05-27 09:15:41 qbix79 Exp $ */
 
 #include <string.h>
 #include "dosbox.h"
@@ -45,7 +44,7 @@
 		io_readhandlers[0][port]=IO_ReadBlocked;
 		return 0xff;
 	case 2:
-		return 
+		return
 			(io_readhandlers[0][port+0](port+0,1) << 0) |
 			(io_readhandlers[0][port+1](port+1,1) << 8);
 	case 4:
@@ -59,7 +58,7 @@
 void IO_WriteDefault(Bitu port,Bitu val,Bitu iolen) {
 	switch (iolen) {
 	case 1:
-		LOG(LOG_IO,LOG_WARN)("Writing %02X to port %04X",val,port);		
+		LOG(LOG_IO,LOG_WARN)("Writing %02X to port %04X",val,port);
 		io_writehandlers[0][port]=IO_WriteBlocked;
 		break;
 	case 2:
@@ -116,12 +115,17 @@
 		m_mask=mask;
 		m_range=range;
 		IO_RegisterReadHandler(port,handler,mask,range);
-	} else E_Exit("IO_readHandler allready installed port %x",port);
+	} else E_Exit("IO_readHandler already installed port %x",port);
 }
 
-IO_ReadHandleObject::~IO_ReadHandleObject(){
+void IO_ReadHandleObject::Uninstall(){
 	if(!installed) return;
 	IO_FreeReadHandler(m_port,m_mask,m_range);
+	installed=false;
+}
+
+IO_ReadHandleObject::~IO_ReadHandleObject(){
+	Uninstall();
 }
 
 void IO_WriteHandleObject::Install(Bitu port,IO_WriteHandler * handler,Bitu mask,Bitu range) {
@@ -131,12 +135,17 @@
 		m_mask=mask;
 		m_range=range;
 		IO_RegisterWriteHandler(port,handler,mask,range);
-	} else E_Exit("IO_writeHandler allready installed port %x",port);
+	} else E_Exit("IO_writeHandler already installed port %x",port);
 }
 
-IO_WriteHandleObject::~IO_WriteHandleObject(){
+void IO_WriteHandleObject::Uninstall() {
 	if(!installed) return;
 	IO_FreeWriteHandler(m_port,m_mask,m_range);
+	installed=false;
+}
+
+IO_WriteHandleObject::~IO_WriteHandleObject(){
+	Uninstall();
 	//LOG_MSG("FreeWritehandler called with port %X",m_port);
 }
 
@@ -157,7 +166,7 @@
 	Bits ret=CPU_Core_Full_Run();
 	CPU_CycleLeft+=CPU_Cycles;
 	if (ret<0) E_Exit("Got a dosbox close machine in IO-fault core?");
-	if (ret) 
+	if (ret)
 		return ret;
 	if (!iof_queue.used) E_Exit("IO-faul Core without IO-faul");
 	IOF_Entry * entry=&iof_queue.entries[iof_queue.used-1];
@@ -187,7 +196,7 @@
 inline void IO_USEC_write_delay_old() {
 	if(CPU_CycleMax > static_cast<Bit32s>((IODELAY_WRITE_MICROS*1000.0))) {
 		// this could be calculated whenever CPU_CycleMax changes
-		Bits delaycyc = static_cast<Bits>((CPU_CycleMax/1000)*IODELAY_WRITE_MICROS); 
+		Bits delaycyc = static_cast<Bits>((CPU_CycleMax/1000)*IODELAY_WRITE_MICROS);
 		if(CPU_Cycles > delaycyc) CPU_Cycles -= delaycyc;
 		else CPU_Cycles = 0;
 	}
@@ -205,7 +214,7 @@
 }
 
 inline void IO_USEC_write_delay() {
-	Bits delaycyc = CPU_CycleMax/IODELAY_WRITE_MICROSk; 
+	Bits delaycyc = CPU_CycleMax/IODELAY_WRITE_MICROSk;
 	if(GCC_UNLIKELY(CPU_Cycles < 3*delaycyc)) delaycyc=0;
 	CPU_Cycles -= delaycyc;
 	CPU_IODelayRemoved += delaycyc;
@@ -328,7 +337,7 @@
 		CPU_Push16(reg_ip);
 		Bit16u old_ax = reg_ax;
 		Bit16u old_dx = reg_dx;
-		reg_al = val;
+		reg_ax = val;
 		reg_dx = port;
 		RealPt icb = CALLBACK_RealPointer(call_priv_io);
 		SegSet16(cs,RealSeg(icb));
@@ -364,7 +373,7 @@
 		CPU_Push16(reg_ip);
 		Bit32u old_eax = reg_eax;
 		Bit16u old_dx = reg_dx;
-		reg_al = val;
+		reg_eax = val;
 		reg_dx = port;
 		RealPt icb = CALLBACK_RealPointer(call_priv_io);
 		SegSet16(cs,RealSeg(icb));
@@ -406,7 +415,7 @@
 		iof_queue.used--;
 
 		retval = reg_al;
-		reg_dx = old_dx;		
+		reg_dx = old_dx;
 		memcpy(&lflags,&old_lflags,sizeof(LazyFlags));
 		cpudecoder=old_cpudecoder;
 		return retval;
@@ -443,7 +452,7 @@
 		iof_queue.used--;
 
 		retval = reg_ax;
-		reg_dx = old_dx;		
+		reg_dx = old_dx;
 		memcpy(&lflags,&old_lflags,sizeof(LazyFlags));
 		cpudecoder=old_cpudecoder;
 	}
@@ -479,7 +488,7 @@
 		iof_queue.used--;
 
 		retval = reg_eax;
-		reg_dx = old_dx;		
+		reg_dx = old_dx;
 		memcpy(&lflags,&old_lflags,sizeof(LazyFlags));
 		cpudecoder=old_cpudecoder;
 	} else {
diff -Nur dosbox-0.74/src/hardware/ipx.cpp dosbox-0.74.patch/src/hardware/ipx.cpp
--- dosbox-0.74/src/hardware/ipx.cpp	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/hardware/ipx.cpp	2016-12-11 18:35:15.534284006 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: ipx.cpp,v 1.17 2009-05-27 09:15:41 qbix79 Exp $ */
 
 #include "dosbox.h"
 
@@ -936,7 +935,7 @@
 			if(strcasecmp("startserver", temp_line.c_str()) == 0) {
 				if(!isIpxServer) {
 					if(incomingPacket.connected) {
-						WriteOut("IPX Tunneling Client alreadu connected to another server.  Disconnect first.\n");
+						WriteOut("IPX Tunneling Client already connected to another server.  Disconnect first.\n");
 						return;
 					}
 					bool startsuccess;
diff -Nur dosbox-0.74/src/hardware/ipxserver.cpp dosbox-0.74.patch/src/hardware/ipxserver.cpp
--- dosbox-0.74/src/hardware/ipxserver.cpp	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/hardware/ipxserver.cpp	2016-12-11 18:35:15.538284005 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: ipxserver.cpp,v 1.10 2009-05-27 09:15:41 qbix79 Exp $ */
 
 #include "dosbox.h"
 
diff -Nur dosbox-0.74/src/hardware/joystick.cpp dosbox-0.74.patch/src/hardware/joystick.cpp
--- dosbox-0.74/src/hardware/joystick.cpp	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/hardware/joystick.cpp	2016-12-11 18:35:15.538284005 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: joystick.cpp,v 1.21 2009-05-27 09:15:41 qbix79 Exp $ */
 
 #include <string.h>
 #include "dosbox.h"
diff -Nur dosbox-0.74/src/hardware/keyboard.cpp dosbox-0.74.patch/src/hardware/keyboard.cpp
--- dosbox-0.74/src/hardware/keyboard.cpp	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/hardware/keyboard.cpp	2016-12-11 18:35:15.538284005 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: keyboard.cpp,v 1.41 2009-05-27 09:15:41 qbix79 Exp $ */
 
 #include "dosbox.h"
 #include "keyboard.h"
@@ -348,15 +347,18 @@
 	}
 	/* Add the actual key in the keyboard queue */
 	if (pressed) {
-		if (keyb.repeat.key==keytype) keyb.repeat.wait=keyb.repeat.rate;		
-		else keyb.repeat.wait=keyb.repeat.pause;
-		keyb.repeat.key=keytype;
+		if (keyb.repeat.key == keytype) keyb.repeat.wait = keyb.repeat.rate;		
+		else keyb.repeat.wait = keyb.repeat.pause;
+		keyb.repeat.key = keytype;
 	} else {
-		keyb.repeat.key=KBD_NONE;
-		keyb.repeat.wait=0;
-		ret+=128;
+		if (keyb.repeat.key == keytype) {
+			/* repeated key being released */
+			keyb.repeat.key  = KBD_NONE;
+			keyb.repeat.wait = 0;
+		}
+		ret += 128;
 	}
-	if (extend) KEYBOARD_AddBuffer(0xe0); 
+	if (extend) KEYBOARD_AddBuffer(0xe0);
 	KEYBOARD_AddBuffer(ret);
 }
 
diff -Nur dosbox-0.74/src/hardware/Makefile.am dosbox-0.74.patch/src/hardware/Makefile.am
--- dosbox-0.74/src/hardware/Makefile.am	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/hardware/Makefile.am	2016-12-11 18:35:15.538284005 +0100
@@ -2,12 +2,12 @@
 
 SUBDIRS = serialport
 
-EXTRA_DIST = opl.cpp opl.h adlib.h dbopl.h
+EXTRA_DIST = opl.cpp opl.h adlib.h dbopl.h pci_devices.h
 
 noinst_LIBRARIES = libhardware.a
 
 libhardware_a_SOURCES = adlib.cpp dma.cpp gameblaster.cpp hardware.cpp iohandler.cpp joystick.cpp keyboard.cpp \
-                        memory.cpp mixer.cpp pcspeaker.cpp pic.cpp sblaster.cpp tandy_sound.cpp timer.cpp \
+                        memory.cpp mixer.cpp pcspeaker.cpp pci_bus.cpp pic.cpp sblaster.cpp tandy_sound.cpp timer.cpp \
 			vga.cpp vga_attr.cpp vga_crtc.cpp vga_dac.cpp vga_draw.cpp vga_gfx.cpp vga_other.cpp \
 			vga_memory.cpp vga_misc.cpp vga_seq.cpp vga_xga.cpp vga_s3.cpp vga_tseng.cpp vga_paradise.cpp \
 			cmos.cpp disney.cpp gus.cpp mpu401.cpp ipx.cpp ipxserver.cpp dbopl.cpp
diff -Nur dosbox-0.74/src/hardware/Makefile.in dosbox-0.74.patch/src/hardware/Makefile.in
--- dosbox-0.74/src/hardware/Makefile.in	2010-05-12 11:57:44.000000000 +0200
+++ dosbox-0.74.patch/src/hardware/Makefile.in	1970-01-01 01:00:00.000000000 +0100
@@ -1,643 +0,0 @@
-# Makefile.in generated by automake 1.11.1 from Makefile.am.
-# @configure_input@
-
-# Copyright (C) 1994, 1995, 1996, 1997, 1998, 1999, 2000, 2001, 2002,
-# 2003, 2004, 2005, 2006, 2007, 2008, 2009  Free Software Foundation,
-# Inc.
-# This Makefile.in is free software; the Free Software Foundation
-# gives unlimited permission to copy and/or distribute it,
-# with or without modifications, as long as this notice is preserved.
-
-# This program is distributed in the hope that it will be useful,
-# but WITHOUT ANY WARRANTY, to the extent permitted by law; without
-# even the implied warranty of MERCHANTABILITY or FITNESS FOR A
-# PARTICULAR PURPOSE.
-
-@SET_MAKE@
-
-VPATH = @srcdir@
-pkgdatadir = $(datadir)/@PACKAGE@
-pkgincludedir = $(includedir)/@PACKAGE@
-pkglibdir = $(libdir)/@PACKAGE@
-pkglibexecdir = $(libexecdir)/@PACKAGE@
-am__cd = CDPATH="$${ZSH_VERSION+.}$(PATH_SEPARATOR)" && cd
-install_sh_DATA = $(install_sh) -c -m 644
-install_sh_PROGRAM = $(install_sh) -c
-install_sh_SCRIPT = $(install_sh) -c
-INSTALL_HEADER = $(INSTALL_DATA)
-transform = $(program_transform_name)
-NORMAL_INSTALL = :
-PRE_INSTALL = :
-POST_INSTALL = :
-NORMAL_UNINSTALL = :
-PRE_UNINSTALL = :
-POST_UNINSTALL = :
-build_triplet = @build@
-host_triplet = @host@
-subdir = src/hardware
-DIST_COMMON = $(srcdir)/Makefile.am $(srcdir)/Makefile.in
-ACLOCAL_M4 = $(top_srcdir)/aclocal.m4
-am__aclocal_m4_deps = $(top_srcdir)/acinclude.m4 \
-	$(top_srcdir)/configure.in
-am__configure_deps = $(am__aclocal_m4_deps) $(CONFIGURE_DEPENDENCIES) \
-	$(ACLOCAL_M4)
-mkinstalldirs = $(install_sh) -d
-CONFIG_HEADER = $(top_builddir)/config.h
-CONFIG_CLEAN_FILES =
-CONFIG_CLEAN_VPATH_FILES =
-LIBRARIES = $(noinst_LIBRARIES)
-AR = ar
-ARFLAGS = cru
-libhardware_a_AR = $(AR) $(ARFLAGS)
-libhardware_a_LIBADD =
-am_libhardware_a_OBJECTS = adlib.$(OBJEXT) dma.$(OBJEXT) \
-	gameblaster.$(OBJEXT) hardware.$(OBJEXT) iohandler.$(OBJEXT) \
-	joystick.$(OBJEXT) keyboard.$(OBJEXT) memory.$(OBJEXT) \
-	mixer.$(OBJEXT) pcspeaker.$(OBJEXT) pic.$(OBJEXT) \
-	sblaster.$(OBJEXT) tandy_sound.$(OBJEXT) timer.$(OBJEXT) \
-	vga.$(OBJEXT) vga_attr.$(OBJEXT) vga_crtc.$(OBJEXT) \
-	vga_dac.$(OBJEXT) vga_draw.$(OBJEXT) vga_gfx.$(OBJEXT) \
-	vga_other.$(OBJEXT) vga_memory.$(OBJEXT) vga_misc.$(OBJEXT) \
-	vga_seq.$(OBJEXT) vga_xga.$(OBJEXT) vga_s3.$(OBJEXT) \
-	vga_tseng.$(OBJEXT) vga_paradise.$(OBJEXT) cmos.$(OBJEXT) \
-	disney.$(OBJEXT) gus.$(OBJEXT) mpu401.$(OBJEXT) ipx.$(OBJEXT) \
-	ipxserver.$(OBJEXT) dbopl.$(OBJEXT)
-libhardware_a_OBJECTS = $(am_libhardware_a_OBJECTS)
-DEFAULT_INCLUDES = -I.@am__isrc@ -I$(top_builddir)
-depcomp = $(SHELL) $(top_srcdir)/depcomp
-am__depfiles_maybe = depfiles
-am__mv = mv -f
-CXXCOMPILE = $(CXX) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) \
-	$(AM_CPPFLAGS) $(CPPFLAGS) $(AM_CXXFLAGS) $(CXXFLAGS)
-CXXLD = $(CXX)
-CXXLINK = $(CXXLD) $(AM_CXXFLAGS) $(CXXFLAGS) $(AM_LDFLAGS) $(LDFLAGS) \
-	-o $@
-SOURCES = $(libhardware_a_SOURCES)
-DIST_SOURCES = $(libhardware_a_SOURCES)
-RECURSIVE_TARGETS = all-recursive check-recursive dvi-recursive \
-	html-recursive info-recursive install-data-recursive \
-	install-dvi-recursive install-exec-recursive \
-	install-html-recursive install-info-recursive \
-	install-pdf-recursive install-ps-recursive install-recursive \
-	installcheck-recursive installdirs-recursive pdf-recursive \
-	ps-recursive uninstall-recursive
-RECURSIVE_CLEAN_TARGETS = mostlyclean-recursive clean-recursive	\
-  distclean-recursive maintainer-clean-recursive
-AM_RECURSIVE_TARGETS = $(RECURSIVE_TARGETS:-recursive=) \
-	$(RECURSIVE_CLEAN_TARGETS:-recursive=) tags TAGS ctags CTAGS \
-	distdir
-ETAGS = etags
-CTAGS = ctags
-DIST_SUBDIRS = $(SUBDIRS)
-DISTFILES = $(DIST_COMMON) $(DIST_SOURCES) $(TEXINFOS) $(EXTRA_DIST)
-am__relativize = \
-  dir0=`pwd`; \
-  sed_first='s,^\([^/]*\)/.*$$,\1,'; \
-  sed_rest='s,^[^/]*/*,,'; \
-  sed_last='s,^.*/\([^/]*\)$$,\1,'; \
-  sed_butlast='s,/*[^/]*$$,,'; \
-  while test -n "$$dir1"; do \
-    first=`echo "$$dir1" | sed -e "$$sed_first"`; \
-    if test "$$first" != "."; then \
-      if test "$$first" = ".."; then \
-        dir2=`echo "$$dir0" | sed -e "$$sed_last"`/"$$dir2"; \
-        dir0=`echo "$$dir0" | sed -e "$$sed_butlast"`; \
-      else \
-        first2=`echo "$$dir2" | sed -e "$$sed_first"`; \
-        if test "$$first2" = "$$first"; then \
-          dir2=`echo "$$dir2" | sed -e "$$sed_rest"`; \
-        else \
-          dir2="../$$dir2"; \
-        fi; \
-        dir0="$$dir0"/"$$first"; \
-      fi; \
-    fi; \
-    dir1=`echo "$$dir1" | sed -e "$$sed_rest"`; \
-  done; \
-  reldir="$$dir2"
-ACLOCAL = @ACLOCAL@
-ALSA_CFLAGS = @ALSA_CFLAGS@
-ALSA_LIBS = @ALSA_LIBS@
-AMTAR = @AMTAR@
-AUTOCONF = @AUTOCONF@
-AUTOHEADER = @AUTOHEADER@
-AUTOMAKE = @AUTOMAKE@
-AWK = @AWK@
-CC = @CC@
-CCDEPMODE = @CCDEPMODE@
-CFLAGS = @CFLAGS@
-CPP = @CPP@
-CPPFLAGS = @CPPFLAGS@
-CXX = @CXX@
-CXXDEPMODE = @CXXDEPMODE@
-CXXFLAGS = @CXXFLAGS@
-CYGPATH_W = @CYGPATH_W@
-DEFS = @DEFS@
-DEPDIR = @DEPDIR@
-ECHO_C = @ECHO_C@
-ECHO_N = @ECHO_N@
-ECHO_T = @ECHO_T@
-EGREP = @EGREP@
-EXEEXT = @EXEEXT@
-GREP = @GREP@
-INSTALL = @INSTALL@
-INSTALL_DATA = @INSTALL_DATA@
-INSTALL_PROGRAM = @INSTALL_PROGRAM@
-INSTALL_SCRIPT = @INSTALL_SCRIPT@
-INSTALL_STRIP_PROGRAM = @INSTALL_STRIP_PROGRAM@
-LDFLAGS = @LDFLAGS@
-LIBOBJS = @LIBOBJS@
-LIBS = @LIBS@
-LTLIBOBJS = @LTLIBOBJS@
-MAKEINFO = @MAKEINFO@
-MKDIR_P = @MKDIR_P@
-OBJEXT = @OBJEXT@
-PACKAGE = @PACKAGE@
-PACKAGE_BUGREPORT = @PACKAGE_BUGREPORT@
-PACKAGE_NAME = @PACKAGE_NAME@
-PACKAGE_STRING = @PACKAGE_STRING@
-PACKAGE_TARNAME = @PACKAGE_TARNAME@
-PACKAGE_URL = @PACKAGE_URL@
-PACKAGE_VERSION = @PACKAGE_VERSION@
-PATH_SEPARATOR = @PATH_SEPARATOR@
-RANLIB = @RANLIB@
-SDL_CFLAGS = @SDL_CFLAGS@
-SDL_CONFIG = @SDL_CONFIG@
-SDL_LIBS = @SDL_LIBS@
-SET_MAKE = @SET_MAKE@
-SHELL = @SHELL@
-STRIP = @STRIP@
-VERSION = @VERSION@
-WINDRES = @WINDRES@
-abs_builddir = @abs_builddir@
-abs_srcdir = @abs_srcdir@
-abs_top_builddir = @abs_top_builddir@
-abs_top_srcdir = @abs_top_srcdir@
-ac_ct_CC = @ac_ct_CC@
-ac_ct_CXX = @ac_ct_CXX@
-am__include = @am__include@
-am__leading_dot = @am__leading_dot@
-am__quote = @am__quote@
-am__tar = @am__tar@
-am__untar = @am__untar@
-bindir = @bindir@
-build = @build@
-build_alias = @build_alias@
-build_cpu = @build_cpu@
-build_os = @build_os@
-build_vendor = @build_vendor@
-builddir = @builddir@
-datadir = @datadir@
-datarootdir = @datarootdir@
-docdir = @docdir@
-dvidir = @dvidir@
-exec_prefix = @exec_prefix@
-host = @host@
-host_alias = @host_alias@
-host_cpu = @host_cpu@
-host_os = @host_os@
-host_vendor = @host_vendor@
-htmldir = @htmldir@
-includedir = @includedir@
-infodir = @infodir@
-install_sh = @install_sh@
-libdir = @libdir@
-libexecdir = @libexecdir@
-localedir = @localedir@
-localstatedir = @localstatedir@
-mandir = @mandir@
-mkdir_p = @mkdir_p@
-oldincludedir = @oldincludedir@
-pdfdir = @pdfdir@
-prefix = @prefix@
-program_transform_name = @program_transform_name@
-psdir = @psdir@
-sbindir = @sbindir@
-sharedstatedir = @sharedstatedir@
-srcdir = @srcdir@
-sysconfdir = @sysconfdir@
-target_alias = @target_alias@
-top_build_prefix = @top_build_prefix@
-top_builddir = @top_builddir@
-top_srcdir = @top_srcdir@
-AM_CPPFLAGS = -I$(top_srcdir)/include
-SUBDIRS = serialport
-EXTRA_DIST = opl.cpp opl.h adlib.h dbopl.h
-noinst_LIBRARIES = libhardware.a
-libhardware_a_SOURCES = adlib.cpp dma.cpp gameblaster.cpp hardware.cpp iohandler.cpp joystick.cpp keyboard.cpp \
-                        memory.cpp mixer.cpp pcspeaker.cpp pic.cpp sblaster.cpp tandy_sound.cpp timer.cpp \
-			vga.cpp vga_attr.cpp vga_crtc.cpp vga_dac.cpp vga_draw.cpp vga_gfx.cpp vga_other.cpp \
-			vga_memory.cpp vga_misc.cpp vga_seq.cpp vga_xga.cpp vga_s3.cpp vga_tseng.cpp vga_paradise.cpp \
-			cmos.cpp disney.cpp gus.cpp mpu401.cpp ipx.cpp ipxserver.cpp dbopl.cpp
-
-all: all-recursive
-
-.SUFFIXES:
-.SUFFIXES: .cpp .o .obj
-$(srcdir)/Makefile.in:  $(srcdir)/Makefile.am  $(am__configure_deps)
-	@for dep in $?; do \
-	  case '$(am__configure_deps)' in \
-	    *$$dep*) \
-	      ( cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh ) \
-	        && { if test -f $@; then exit 0; else break; fi; }; \
-	      exit 1;; \
-	  esac; \
-	done; \
-	echo ' cd $(top_srcdir) && $(AUTOMAKE) --gnu src/hardware/Makefile'; \
-	$(am__cd) $(top_srcdir) && \
-	  $(AUTOMAKE) --gnu src/hardware/Makefile
-.PRECIOUS: Makefile
-Makefile: $(srcdir)/Makefile.in $(top_builddir)/config.status
-	@case '$?' in \
-	  *config.status*) \
-	    cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh;; \
-	  *) \
-	    echo ' cd $(top_builddir) && $(SHELL) ./config.status $(subdir)/$@ $(am__depfiles_maybe)'; \
-	    cd $(top_builddir) && $(SHELL) ./config.status $(subdir)/$@ $(am__depfiles_maybe);; \
-	esac;
-
-$(top_builddir)/config.status: $(top_srcdir)/configure $(CONFIG_STATUS_DEPENDENCIES)
-	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
-
-$(top_srcdir)/configure:  $(am__configure_deps)
-	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
-$(ACLOCAL_M4):  $(am__aclocal_m4_deps)
-	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
-$(am__aclocal_m4_deps):
-
-clean-noinstLIBRARIES:
-	-test -z "$(noinst_LIBRARIES)" || rm -f $(noinst_LIBRARIES)
-libhardware.a: $(libhardware_a_OBJECTS) $(libhardware_a_DEPENDENCIES) 
-	-rm -f libhardware.a
-	$(libhardware_a_AR) libhardware.a $(libhardware_a_OBJECTS) $(libhardware_a_LIBADD)
-	$(RANLIB) libhardware.a
-
-mostlyclean-compile:
-	-rm -f *.$(OBJEXT)
-
-distclean-compile:
-	-rm -f *.tab.c
-
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/adlib.Po@am__quote@
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/cmos.Po@am__quote@
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/dbopl.Po@am__quote@
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/disney.Po@am__quote@
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/dma.Po@am__quote@
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/gameblaster.Po@am__quote@
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/gus.Po@am__quote@
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/hardware.Po@am__quote@
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/iohandler.Po@am__quote@
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/ipx.Po@am__quote@
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/ipxserver.Po@am__quote@
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/joystick.Po@am__quote@
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/keyboard.Po@am__quote@
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/memory.Po@am__quote@
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/mixer.Po@am__quote@
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/mpu401.Po@am__quote@
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/pcspeaker.Po@am__quote@
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/pic.Po@am__quote@
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/sblaster.Po@am__quote@
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/tandy_sound.Po@am__quote@
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/timer.Po@am__quote@
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/vga.Po@am__quote@
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/vga_attr.Po@am__quote@
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/vga_crtc.Po@am__quote@
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/vga_dac.Po@am__quote@
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/vga_draw.Po@am__quote@
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/vga_gfx.Po@am__quote@
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/vga_memory.Po@am__quote@
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/vga_misc.Po@am__quote@
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/vga_other.Po@am__quote@
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/vga_paradise.Po@am__quote@
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/vga_s3.Po@am__quote@
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/vga_seq.Po@am__quote@
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/vga_tseng.Po@am__quote@
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/vga_xga.Po@am__quote@
-
-.cpp.o:
-@am__fastdepCXX_TRUE@	$(CXXCOMPILE) -MT $@ -MD -MP -MF $(DEPDIR)/$*.Tpo -c -o $@ $<
-@am__fastdepCXX_TRUE@	$(am__mv) $(DEPDIR)/$*.Tpo $(DEPDIR)/$*.Po
-@AMDEP_TRUE@@am__fastdepCXX_FALSE@	source='$<' object='$@' libtool=no @AMDEPBACKSLASH@
-@AMDEP_TRUE@@am__fastdepCXX_FALSE@	DEPDIR=$(DEPDIR) $(CXXDEPMODE) $(depcomp) @AMDEPBACKSLASH@
-@am__fastdepCXX_FALSE@	$(CXXCOMPILE) -c -o $@ $<
-
-.cpp.obj:
-@am__fastdepCXX_TRUE@	$(CXXCOMPILE) -MT $@ -MD -MP -MF $(DEPDIR)/$*.Tpo -c -o $@ `$(CYGPATH_W) '$<'`
-@am__fastdepCXX_TRUE@	$(am__mv) $(DEPDIR)/$*.Tpo $(DEPDIR)/$*.Po
-@AMDEP_TRUE@@am__fastdepCXX_FALSE@	source='$<' object='$@' libtool=no @AMDEPBACKSLASH@
-@AMDEP_TRUE@@am__fastdepCXX_FALSE@	DEPDIR=$(DEPDIR) $(CXXDEPMODE) $(depcomp) @AMDEPBACKSLASH@
-@am__fastdepCXX_FALSE@	$(CXXCOMPILE) -c -o $@ `$(CYGPATH_W) '$<'`
-
-# This directory's subdirectories are mostly independent; you can cd
-# into them and run `make' without going through this Makefile.
-# To change the values of `make' variables: instead of editing Makefiles,
-# (1) if the variable is set in `config.status', edit `config.status'
-#     (which will cause the Makefiles to be regenerated when you run `make');
-# (2) otherwise, pass the desired values on the `make' command line.
-$(RECURSIVE_TARGETS):
-	@fail= failcom='exit 1'; \
-	for f in x $$MAKEFLAGS; do \
-	  case $$f in \
-	    *=* | --[!k]*);; \
-	    *k*) failcom='fail=yes';; \
-	  esac; \
-	done; \
-	dot_seen=no; \
-	target=`echo $@ | sed s/-recursive//`; \
-	list='$(SUBDIRS)'; for subdir in $$list; do \
-	  echo "Making $$target in $$subdir"; \
-	  if test "$$subdir" = "."; then \
-	    dot_seen=yes; \
-	    local_target="$$target-am"; \
-	  else \
-	    local_target="$$target"; \
-	  fi; \
-	  ($(am__cd) $$subdir && $(MAKE) $(AM_MAKEFLAGS) $$local_target) \
-	  || eval $$failcom; \
-	done; \
-	if test "$$dot_seen" = "no"; then \
-	  $(MAKE) $(AM_MAKEFLAGS) "$$target-am" || exit 1; \
-	fi; test -z "$$fail"
-
-$(RECURSIVE_CLEAN_TARGETS):
-	@fail= failcom='exit 1'; \
-	for f in x $$MAKEFLAGS; do \
-	  case $$f in \
-	    *=* | --[!k]*);; \
-	    *k*) failcom='fail=yes';; \
-	  esac; \
-	done; \
-	dot_seen=no; \
-	case "$@" in \
-	  distclean-* | maintainer-clean-*) list='$(DIST_SUBDIRS)' ;; \
-	  *) list='$(SUBDIRS)' ;; \
-	esac; \
-	rev=''; for subdir in $$list; do \
-	  if test "$$subdir" = "."; then :; else \
-	    rev="$$subdir $$rev"; \
-	  fi; \
-	done; \
-	rev="$$rev ."; \
-	target=`echo $@ | sed s/-recursive//`; \
-	for subdir in $$rev; do \
-	  echo "Making $$target in $$subdir"; \
-	  if test "$$subdir" = "."; then \
-	    local_target="$$target-am"; \
-	  else \
-	    local_target="$$target"; \
-	  fi; \
-	  ($(am__cd) $$subdir && $(MAKE) $(AM_MAKEFLAGS) $$local_target) \
-	  || eval $$failcom; \
-	done && test -z "$$fail"
-tags-recursive:
-	list='$(SUBDIRS)'; for subdir in $$list; do \
-	  test "$$subdir" = . || ($(am__cd) $$subdir && $(MAKE) $(AM_MAKEFLAGS) tags); \
-	done
-ctags-recursive:
-	list='$(SUBDIRS)'; for subdir in $$list; do \
-	  test "$$subdir" = . || ($(am__cd) $$subdir && $(MAKE) $(AM_MAKEFLAGS) ctags); \
-	done
-
-ID: $(HEADERS) $(SOURCES) $(LISP) $(TAGS_FILES)
-	list='$(SOURCES) $(HEADERS) $(LISP) $(TAGS_FILES)'; \
-	unique=`for i in $$list; do \
-	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
-	  done | \
-	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
-	      END { if (nonempty) { for (i in files) print i; }; }'`; \
-	mkid -fID $$unique
-tags: TAGS
-
-TAGS: tags-recursive $(HEADERS) $(SOURCES)  $(TAGS_DEPENDENCIES) \
-		$(TAGS_FILES) $(LISP)
-	set x; \
-	here=`pwd`; \
-	if ($(ETAGS) --etags-include --version) >/dev/null 2>&1; then \
-	  include_option=--etags-include; \
-	  empty_fix=.; \
-	else \
-	  include_option=--include; \
-	  empty_fix=; \
-	fi; \
-	list='$(SUBDIRS)'; for subdir in $$list; do \
-	  if test "$$subdir" = .; then :; else \
-	    test ! -f $$subdir/TAGS || \
-	      set "$$@" "$$include_option=$$here/$$subdir/TAGS"; \
-	  fi; \
-	done; \
-	list='$(SOURCES) $(HEADERS)  $(LISP) $(TAGS_FILES)'; \
-	unique=`for i in $$list; do \
-	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
-	  done | \
-	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
-	      END { if (nonempty) { for (i in files) print i; }; }'`; \
-	shift; \
-	if test -z "$(ETAGS_ARGS)$$*$$unique"; then :; else \
-	  test -n "$$unique" || unique=$$empty_fix; \
-	  if test $$# -gt 0; then \
-	    $(ETAGS) $(ETAGSFLAGS) $(AM_ETAGSFLAGS) $(ETAGS_ARGS) \
-	      "$$@" $$unique; \
-	  else \
-	    $(ETAGS) $(ETAGSFLAGS) $(AM_ETAGSFLAGS) $(ETAGS_ARGS) \
-	      $$unique; \
-	  fi; \
-	fi
-ctags: CTAGS
-CTAGS: ctags-recursive $(HEADERS) $(SOURCES)  $(TAGS_DEPENDENCIES) \
-		$(TAGS_FILES) $(LISP)
-	list='$(SOURCES) $(HEADERS)  $(LISP) $(TAGS_FILES)'; \
-	unique=`for i in $$list; do \
-	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
-	  done | \
-	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
-	      END { if (nonempty) { for (i in files) print i; }; }'`; \
-	test -z "$(CTAGS_ARGS)$$unique" \
-	  || $(CTAGS) $(CTAGSFLAGS) $(AM_CTAGSFLAGS) $(CTAGS_ARGS) \
-	     $$unique
-
-GTAGS:
-	here=`$(am__cd) $(top_builddir) && pwd` \
-	  && $(am__cd) $(top_srcdir) \
-	  && gtags -i $(GTAGS_ARGS) "$$here"
-
-distclean-tags:
-	-rm -f TAGS ID GTAGS GRTAGS GSYMS GPATH tags
-
-distdir: $(DISTFILES)
-	@srcdirstrip=`echo "$(srcdir)" | sed 's/[].[^$$\\*]/\\\\&/g'`; \
-	topsrcdirstrip=`echo "$(top_srcdir)" | sed 's/[].[^$$\\*]/\\\\&/g'`; \
-	list='$(DISTFILES)'; \
-	  dist_files=`for file in $$list; do echo $$file; done | \
-	  sed -e "s|^$$srcdirstrip/||;t" \
-	      -e "s|^$$topsrcdirstrip/|$(top_builddir)/|;t"`; \
-	case $$dist_files in \
-	  */*) $(MKDIR_P) `echo "$$dist_files" | \
-			   sed '/\//!d;s|^|$(distdir)/|;s,/[^/]*$$,,' | \
-			   sort -u` ;; \
-	esac; \
-	for file in $$dist_files; do \
-	  if test -f $$file || test -d $$file; then d=.; else d=$(srcdir); fi; \
-	  if test -d $$d/$$file; then \
-	    dir=`echo "/$$file" | sed -e 's,/[^/]*$$,,'`; \
-	    if test -d "$(distdir)/$$file"; then \
-	      find "$(distdir)/$$file" -type d ! -perm -700 -exec chmod u+rwx {} \;; \
-	    fi; \
-	    if test -d $(srcdir)/$$file && test $$d != $(srcdir); then \
-	      cp -fpR $(srcdir)/$$file "$(distdir)$$dir" || exit 1; \
-	      find "$(distdir)/$$file" -type d ! -perm -700 -exec chmod u+rwx {} \;; \
-	    fi; \
-	    cp -fpR $$d/$$file "$(distdir)$$dir" || exit 1; \
-	  else \
-	    test -f "$(distdir)/$$file" \
-	    || cp -p $$d/$$file "$(distdir)/$$file" \
-	    || exit 1; \
-	  fi; \
-	done
-	@list='$(DIST_SUBDIRS)'; for subdir in $$list; do \
-	  if test "$$subdir" = .; then :; else \
-	    test -d "$(distdir)/$$subdir" \
-	    || $(MKDIR_P) "$(distdir)/$$subdir" \
-	    || exit 1; \
-	  fi; \
-	done
-	@list='$(DIST_SUBDIRS)'; for subdir in $$list; do \
-	  if test "$$subdir" = .; then :; else \
-	    dir1=$$subdir; dir2="$(distdir)/$$subdir"; \
-	    $(am__relativize); \
-	    new_distdir=$$reldir; \
-	    dir1=$$subdir; dir2="$(top_distdir)"; \
-	    $(am__relativize); \
-	    new_top_distdir=$$reldir; \
-	    echo " (cd $$subdir && $(MAKE) $(AM_MAKEFLAGS) top_distdir="$$new_top_distdir" distdir="$$new_distdir" \\"; \
-	    echo "     am__remove_distdir=: am__skip_length_check=: am__skip_mode_fix=: distdir)"; \
-	    ($(am__cd) $$subdir && \
-	      $(MAKE) $(AM_MAKEFLAGS) \
-	        top_distdir="$$new_top_distdir" \
-	        distdir="$$new_distdir" \
-		am__remove_distdir=: \
-		am__skip_length_check=: \
-		am__skip_mode_fix=: \
-	        distdir) \
-	      || exit 1; \
-	  fi; \
-	done
-check-am: all-am
-check: check-recursive
-all-am: Makefile $(LIBRARIES)
-installdirs: installdirs-recursive
-installdirs-am:
-install: install-recursive
-install-exec: install-exec-recursive
-install-data: install-data-recursive
-uninstall: uninstall-recursive
-
-install-am: all-am
-	@$(MAKE) $(AM_MAKEFLAGS) install-exec-am install-data-am
-
-installcheck: installcheck-recursive
-install-strip:
-	$(MAKE) $(AM_MAKEFLAGS) INSTALL_PROGRAM="$(INSTALL_STRIP_PROGRAM)" \
-	  install_sh_PROGRAM="$(INSTALL_STRIP_PROGRAM)" INSTALL_STRIP_FLAG=-s \
-	  `test -z '$(STRIP)' || \
-	    echo "INSTALL_PROGRAM_ENV=STRIPPROG='$(STRIP)'"` install
-mostlyclean-generic:
-
-clean-generic:
-
-distclean-generic:
-	-test -z "$(CONFIG_CLEAN_FILES)" || rm -f $(CONFIG_CLEAN_FILES)
-	-test . = "$(srcdir)" || test -z "$(CONFIG_CLEAN_VPATH_FILES)" || rm -f $(CONFIG_CLEAN_VPATH_FILES)
-
-maintainer-clean-generic:
-	@echo "This command is intended for maintainers to use"
-	@echo "it deletes files that may require special tools to rebuild."
-clean: clean-recursive
-
-clean-am: clean-generic clean-noinstLIBRARIES mostlyclean-am
-
-distclean: distclean-recursive
-	-rm -rf ./$(DEPDIR)
-	-rm -f Makefile
-distclean-am: clean-am distclean-compile distclean-generic \
-	distclean-tags
-
-dvi: dvi-recursive
-
-dvi-am:
-
-html: html-recursive
-
-html-am:
-
-info: info-recursive
-
-info-am:
-
-install-data-am:
-
-install-dvi: install-dvi-recursive
-
-install-dvi-am:
-
-install-exec-am:
-
-install-html: install-html-recursive
-
-install-html-am:
-
-install-info: install-info-recursive
-
-install-info-am:
-
-install-man:
-
-install-pdf: install-pdf-recursive
-
-install-pdf-am:
-
-install-ps: install-ps-recursive
-
-install-ps-am:
-
-installcheck-am:
-
-maintainer-clean: maintainer-clean-recursive
-	-rm -rf ./$(DEPDIR)
-	-rm -f Makefile
-maintainer-clean-am: distclean-am maintainer-clean-generic
-
-mostlyclean: mostlyclean-recursive
-
-mostlyclean-am: mostlyclean-compile mostlyclean-generic
-
-pdf: pdf-recursive
-
-pdf-am:
-
-ps: ps-recursive
-
-ps-am:
-
-uninstall-am:
-
-.MAKE: $(RECURSIVE_CLEAN_TARGETS) $(RECURSIVE_TARGETS) ctags-recursive \
-	install-am install-strip tags-recursive
-
-.PHONY: $(RECURSIVE_CLEAN_TARGETS) $(RECURSIVE_TARGETS) CTAGS GTAGS \
-	all all-am check check-am clean clean-generic \
-	clean-noinstLIBRARIES ctags ctags-recursive distclean \
-	distclean-compile distclean-generic distclean-tags distdir dvi \
-	dvi-am html html-am info info-am install install-am \
-	install-data install-data-am install-dvi install-dvi-am \
-	install-exec install-exec-am install-html install-html-am \
-	install-info install-info-am install-man install-pdf \
-	install-pdf-am install-ps install-ps-am install-strip \
-	installcheck installcheck-am installdirs installdirs-am \
-	maintainer-clean maintainer-clean-generic mostlyclean \
-	mostlyclean-compile mostlyclean-generic pdf pdf-am ps ps-am \
-	tags tags-recursive uninstall uninstall-am
-
-
-# Tell versions [3.59,3.63) of GNU make to not export all variables.
-# Otherwise a system limit (for SysV at least) may be exceeded.
-.NOEXPORT:
diff -Nur dosbox-0.74/src/hardware/memory.cpp dosbox-0.74.patch/src/hardware/memory.cpp
--- dosbox-0.74/src/hardware/memory.cpp	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/hardware/memory.cpp	2016-12-11 18:35:15.538284005 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: memory.cpp,v 1.56 2009-05-27 09:15:41 qbix79 Exp $ */
 
 #include "dosbox.h"
 #include "mem.h"
@@ -428,15 +427,17 @@
 
 /* Memory access functions */
 Bit16u mem_unalignedreadw(PhysPt address) {
-	return mem_readb_inline(address) |
-		mem_readb_inline(address+1) << 8;
+	Bit16u ret = mem_readb_inline(address);
+	ret       |= mem_readb_inline(address+1) << 8;
+	return ret;
 }
 
 Bit32u mem_unalignedreadd(PhysPt address) {
-	return mem_readb_inline(address) |
-		(mem_readb_inline(address+1) << 8) |
-		(mem_readb_inline(address+2) << 16) |
-		(mem_readb_inline(address+3) << 24);
+	Bit32u ret = mem_readb_inline(address);
+	ret       |= mem_readb_inline(address+1) << 8;
+	ret       |= mem_readb_inline(address+2) << 16;
+	ret       |= mem_readb_inline(address+3) << 24;
+	return ret;
 }
 
 
diff -Nur dosbox-0.74/src/hardware/mixer.cpp dosbox-0.74.patch/src/hardware/mixer.cpp
--- dosbox-0.74/src/hardware/mixer.cpp	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/hardware/mixer.cpp	2016-12-11 18:35:15.538284005 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: mixer.cpp,v 1.54 2009-09-05 11:10:04 qbix79 Exp $ */
 
 /* 
 	Remove the sdl code from here and have it handeld in the sdlmain.
@@ -48,6 +47,7 @@
 #include "mapper.h"
 #include "hardware.h"
 #include "programs.h"
+#include "midi.h"
 
 #define MIXER_SSIZE 4
 #define MIXER_SHIFT 14
@@ -578,15 +578,7 @@
 	}
 
 	void ListMidi(){
-#if defined (WIN32)
-		unsigned int total = midiOutGetNumDevs();	
-		for(unsigned int i=0;i<total;i++) {
-			MIDIOUTCAPS mididev;
-			midiOutGetDevCaps(i, &mididev, sizeof(MIDIOUTCAPS));
-			WriteOut("%2d\t \"%s\"\n",i,mididev.szPname);
-		}
-#endif
-	return;
+		if(midi.handler) midi.handler->ListAll(this);
 	};
 
 };
@@ -602,7 +594,7 @@
 		installed = true;
 		return MIXER_AddChannel(handler,freq,name);
 	} else {
-		E_Exit("allready added mixer channel.");
+		E_Exit("already added mixer channel.");
 		return 0; //Compiler happy
 	}
 }
diff -Nur dosbox-0.74/src/hardware/mpu401.cpp dosbox-0.74.patch/src/hardware/mpu401.cpp
--- dosbox-0.74/src/hardware/mpu401.cpp	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/hardware/mpu401.cpp	2016-12-11 18:35:15.538284005 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2012  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: mpu401.cpp,v 1.29 2009-05-27 09:15:41 qbix79 Exp $ */
 
 #include <string.h>
 #include "dosbox.h"
@@ -31,12 +30,15 @@
 
 static void MPU401_Event(Bitu);
 static void MPU401_Reset(void);
-static void MPU401_EOIHandler(void);
+static void MPU401_ResetDone(Bitu);
+static void MPU401_EOIHandler(Bitu val=0);
+static void MPU401_EOIHandlerDispatch(void);
 
 #define MPU401_VERSION	0x15
 #define MPU401_REVISION	0x01
 #define MPU401_QUEUE 32
 #define MPU401_TIMECONSTANT (60000000/1000.0f)
+#define MPU401_RESETBUSY 27.0f
 
 enum MpuMode { M_UART,M_INTELLIGENT };
 enum MpuDataType {T_OVERFLOW,T_MARK,T_MIDI_SYS,T_MIDI_NORM,T_COMMAND};
@@ -73,8 +75,9 @@
 		bool wsd,wsm,wsd_start;
 		bool run_irq,irq_pending;
 		bool send_now;
+		bool eoi_scheduled;
 		Bits data_onoff;
-		Bitu command_byte;
+		Bitu command_byte,cmd_pending;
 		Bit8u tmask,cmask,amask;
 		Bit16u midi_mask;
 		Bit16u req_mask;
@@ -113,12 +116,13 @@
 
 static Bitu MPU401_ReadStatus(Bitu port,Bitu iolen) {
 	Bit8u ret=0x3f;	/* Bits 6 and 7 clear */
+	if (mpu.state.cmd_pending) ret|=0x40;
 	if (!mpu.queue_used) ret|=0x80;
 	return ret;
 }
 
 static void MPU401_WriteCommand(Bitu port,Bitu val,Bitu iolen) {
-	mpu.state.reset=0;
+	if (mpu.state.reset) {mpu.state.cmd_pending=val+1;return;}
 	if (val<=0x2f) {
 		switch (val&3) { /* MIDI stop, start, continue */
 			case 1: {MIDI_RawOutByte(0xfc);break;}
@@ -240,12 +244,10 @@
 			break;
 		case 0xff:	/* Reset MPU-401 */
 			LOG(LOG_MISC,LOG_NORMAL)("MPU-401:Reset %X",val);
-			mpu.state.reset=1;
-			if (CPU_Cycles > 5) { //It came from the desert wants a fast irq
-				CPU_CycleLeft += CPU_Cycles;
-				CPU_Cycles = 5;
-			}
+			PIC_AddEvent(MPU401_ResetDone,MPU401_RESETBUSY);
+			mpu.state.reset=true;
 			MPU401_Reset();
+			if (mpu.mode==M_UART) return;//do not send ack in UART mode
 			break;
 		case 0x3f:	/* UART mode */
 			LOG(LOG_MISC,LOG_NORMAL)("MPU-401:Set UART mode %X",val);
@@ -285,7 +287,7 @@
 	}
 	if (ret==MSG_MPU_END || ret==MSG_MPU_CLOCK || ret==MSG_MPU_ACK) {
 		mpu.state.data_onoff=-1;
-		MPU401_EOIHandler();
+		MPU401_EOIHandlerDispatch();
 	}
 	return ret;
 }
@@ -391,7 +393,7 @@
 				if (val<0xf0) mpu.state.data_onoff++;
 				else {
 					mpu.state.data_onoff=-1;
-					MPU401_EOIHandler();
+					MPU401_EOIHandlerDispatch();
 					return;
 				}
 				if (val==0) mpu.state.send_now=true;
@@ -403,13 +405,13 @@
 				if (val==0xf8 || val==0xf9) mpu.condbuf.type=T_OVERFLOW;
 				mpu.condbuf.value[mpu.condbuf.vlength]=val;
 				mpu.condbuf.vlength++;
-				if ((val&0xf0)!=0xe0) MPU401_EOIHandler();
+				if ((val&0xf0)!=0xe0) MPU401_EOIHandlerDispatch();
 				else mpu.state.data_onoff++;
 				break;
 			case  2:/* Command byte #2 */
 				mpu.condbuf.value[mpu.condbuf.vlength]=val;
 				mpu.condbuf.vlength++;
-				MPU401_EOIHandler();
+				MPU401_EOIHandlerDispatch();
 				break;
 		}
 		return;
@@ -421,7 +423,7 @@
 			if (val<0xf0) mpu.state.data_onoff=1;
 			else {
 				mpu.state.data_onoff=-1;
-				MPU401_EOIHandler();
+				MPU401_EOIHandlerDispatch();
 				return;
 			}
 			if (val==0) mpu.state.send_now=true;
@@ -462,7 +464,7 @@
 				}
 			}
 			if (!(posd==1 && val>=0xf0)) mpu.playbuf[mpu.state.channel].value[posd-1]=val;
-			if (posd==length) MPU401_EOIHandler();
+			if (posd==length) MPU401_EOIHandlerDispatch();
 	}
 }
 
@@ -541,7 +543,18 @@
 	PIC_AddEvent(MPU401_Event,MPU401_TIMECONSTANT/new_time);
 }
 
-static void MPU401_EOIHandler(void) {
+
+static void MPU401_EOIHandlerDispatch(void) {
+	if (mpu.state.send_now) {
+		mpu.state.eoi_scheduled=true;
+		PIC_AddEvent(MPU401_EOIHandler,0.06f); //Possible a bit longer
+	}
+	else if (!mpu.state.eoi_scheduled) MPU401_EOIHandler();
+}
+
+//Updates counters and requests new data on "End of Input"
+static void MPU401_EOIHandler(Bitu val) {
+	mpu.state.eoi_scheduled=false;
 	if (mpu.state.send_now) {
 		mpu.state.send_now=false;
 		if (mpu.state.cond_req) UpdateConductor();
@@ -559,9 +572,18 @@
 	} while ((i++)<16);
 }
 
+static void MPU401_ResetDone(Bitu) {
+	mpu.state.reset=false;
+	if (mpu.state.cmd_pending) {
+		MPU401_WriteCommand(0x331,mpu.state.cmd_pending-1,1);
+		mpu.state.cmd_pending=0;
+	}
+}
 static void MPU401_Reset(void) {
 	PIC_DeActivateIRQ(mpu.irq);
 	mpu.mode=(mpu.intelligent ? M_INTELLIGENT : M_UART);
+	PIC_RemoveEvents(MPU401_EOIHandler);
+	mpu.state.eoi_scheduled=false;
 	mpu.state.wsd=false;
 	mpu.state.wsm=false;
 	mpu.state.conductor=false;
diff -Nur dosbox-0.74/src/hardware/opl.cpp dosbox-0.74.patch/src/hardware/opl.cpp
--- dosbox-0.74/src/hardware/opl.cpp	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/hardware/opl.cpp	2016-12-11 18:35:15.538284005 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *  OPL2/OPL3 emulation library
  *
  *  This library is free software; you can redistribute it and/or
diff -Nur dosbox-0.74/src/hardware/opl.h dosbox-0.74.patch/src/hardware/opl.h
--- dosbox-0.74/src/hardware/opl.h	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/hardware/opl.h	2016-12-11 18:35:15.538284005 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *  OPL2/OPL3 emulation library
  *
  *  This library is free software; you can redistribute it and/or
diff -Nur dosbox-0.74/src/hardware/pci_bus.cpp dosbox-0.74.patch/src/hardware/pci_bus.cpp
--- dosbox-0.74/src/hardware/pci_bus.cpp	1970-01-01 01:00:00.000000000 +0100
+++ dosbox-0.74.patch/src/hardware/pci_bus.cpp	2016-12-11 18:35:15.538284005 +0100
@@ -0,0 +1,444 @@
+/*
+ *  Copyright (C) 2002-2013  The DOSBox Team
+ *
+ *  This program is free software; you can redistribute it and/or modify
+ *  it under the terms of the GNU General Public License as published by
+ *  the Free Software Foundation; either version 2 of the License, or
+ *  (at your option) any later version.
+ *
+ *  This program is distributed in the hope that it will be useful,
+ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *  GNU General Public License for more details.
+ *
+ *  You should have received a copy of the GNU General Public License
+ *  along with this program; if not, write to the Free Software
+ *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+ */
+
+
+#include "dosbox.h"
+#include "inout.h"
+#include "mem.h"
+#include "pci_bus.h"
+#include "setup.h"
+#include "debug.h"
+#include "callback.h"
+#include "regs.h"
+
+
+#if defined(PCI_FUNCTIONALITY_ENABLED)
+
+static Bit32u pci_caddress=0;			// current PCI addressing
+static Bitu pci_devices_installed=0;	// number of registered PCI devices
+
+static Bit8u pci_cfg_data[PCI_MAX_PCIDEVICES][PCI_MAX_PCIFUNCTIONS][256];		// PCI configuration data
+static PCI_Device* pci_devices[PCI_MAX_PCIDEVICES];		// registered PCI devices
+
+
+// PCI address
+// 31    - set for a PCI access
+// 30-24 - 0
+// 23-16 - bus number			(0x00ff0000)
+// 15-11 - device number (slot)	(0x0000f800)
+// 10- 8 - subfunction number	(0x00000700)
+//  7- 2 - config register #	(0x000000fc)
+
+static void write_pci_addr(Bitu port,Bitu val,Bitu iolen) {
+	LOG(LOG_PCI,LOG_NORMAL)("Write PCI address :=%x",val);
+	pci_caddress=val;
+}
+
+static void write_pci_register(PCI_Device* dev,Bit8u regnum,Bit8u value) {
+	// vendor/device/class IDs/header type/etc. are read-only
+	if ((regnum<0x04) || ((regnum>=0x06) && (regnum<0x0c)) || (regnum==0x0e)) return;
+	if (dev==NULL) return;
+	switch (pci_cfg_data[dev->PCIId()][dev->PCISubfunction()][0x0e]&0x7f) {	// header-type specific handling
+		case 0x00:
+			if ((regnum>=0x28) && (regnum<0x30)) return;	// subsystem information is read-only
+			break;
+		case 0x01:
+		case 0x02:
+		default:
+			break;
+	}
+
+	// call device routine for special actions and the
+	// possibility to discard/replace the value that is to be written
+	Bits parsed_register=dev->ParseWriteRegister(regnum,value);
+	if (parsed_register>=0)
+		pci_cfg_data[dev->PCIId()][dev->PCISubfunction()][regnum]=(Bit8u)(parsed_register&0xff);
+}
+
+static void write_pci(Bitu port,Bitu val,Bitu iolen) {
+	LOG(LOG_PCI,LOG_NORMAL)("Write PCI data :=%x (len %d)",port,val,iolen);
+
+	// check for enabled/bus 0
+	if ((pci_caddress & 0x80ff0000) == 0x80000000) {
+		Bit8u devnum = (Bit8u)((pci_caddress >> 11) & 0x1f);
+		Bit8u fctnum = (Bit8u)((pci_caddress >> 8) & 0x7);
+		Bit8u regnum = (Bit8u)((pci_caddress & 0xfc) + (port & 0x03));
+		LOG(LOG_PCI,LOG_NORMAL)("  Write to device %x register %x (function %x) (:=%x)",devnum,regnum,fctnum,val);
+
+		if (devnum>=pci_devices_installed) return;
+		PCI_Device* masterdev=pci_devices[devnum];
+		if (masterdev==NULL) return;
+		if (fctnum>masterdev->NumSubdevices()) return;
+
+		PCI_Device* dev=masterdev->GetSubdevice(fctnum);
+		if (dev==NULL) return;
+
+		// write data to PCI device/configuration
+		switch (iolen) {
+			case 1: write_pci_register(dev,regnum+0,(Bit8u)(val&0xff)); break;
+			case 2: write_pci_register(dev,regnum+0,(Bit8u)(val&0xff));
+					write_pci_register(dev,regnum+1,(Bit8u)((val>>8)&0xff)); break;
+			case 4: write_pci_register(dev,regnum+0,(Bit8u)(val&0xff));
+					write_pci_register(dev,regnum+1,(Bit8u)((val>>8)&0xff));
+					write_pci_register(dev,regnum+2,(Bit8u)((val>>16)&0xff));
+					write_pci_register(dev,regnum+3,(Bit8u)((val>>24)&0xff)); break;
+		}
+	}
+}
+
+
+static Bitu read_pci_addr(Bitu port,Bitu iolen) {
+	LOG(LOG_PCI,LOG_NORMAL)("Read PCI address -> %x",pci_caddress);
+	return pci_caddress;
+}
+
+// read single 8bit value from register file (special register treatment included)
+static Bit8u read_pci_register(PCI_Device* dev,Bit8u regnum) {
+	switch (regnum) {
+		case 0x00:
+			return (Bit8u)(dev->VendorID()&0xff);
+		case 0x01:
+			return (Bit8u)((dev->VendorID()>>8)&0xff);
+		case 0x02:
+			return (Bit8u)(dev->DeviceID()&0xff);
+		case 0x03:
+			return (Bit8u)((dev->DeviceID()>>8)&0xff);
+
+		case 0x0e:
+			return (pci_cfg_data[dev->PCIId()][dev->PCISubfunction()][regnum]&0x7f) |
+						((dev->NumSubdevices()>0)?0x80:0x00);
+		default:
+			break;
+	}
+
+	// call device routine for special actions and possibility to discard/remap register
+	Bits parsed_regnum=dev->ParseReadRegister(regnum);
+	if ((parsed_regnum>=0) && (parsed_regnum<256))
+		return pci_cfg_data[dev->PCIId()][dev->PCISubfunction()][parsed_regnum];
+
+	Bit8u newval, mask;
+	if (dev->OverrideReadRegister(regnum, &newval, &mask)) {
+		Bit8u oldval=pci_cfg_data[dev->PCIId()][dev->PCISubfunction()][regnum] & (~mask);
+		return oldval | (newval & mask);
+	}
+
+	return 0xff;
+}
+
+static Bitu read_pci(Bitu port,Bitu iolen) {
+	LOG(LOG_PCI,LOG_NORMAL)("Read PCI data -> %x",pci_caddress);
+
+	if ((pci_caddress & 0x80ff0000) == 0x80000000) {
+		Bit8u devnum = (Bit8u)((pci_caddress >> 11) & 0x1f);
+		Bit8u fctnum = (Bit8u)((pci_caddress >> 8) & 0x7);
+		Bit8u regnum = (Bit8u)((pci_caddress & 0xfc) + (port & 0x03));
+		if (devnum>=pci_devices_installed) return 0xffffffff;
+		LOG(LOG_PCI,LOG_NORMAL)("  Read from device %x register %x (function %x); addr %x",
+			devnum,regnum,fctnum,pci_caddress);
+
+		PCI_Device* masterdev=pci_devices[devnum];
+		if (masterdev==NULL) return 0xffffffff;
+		if (fctnum>masterdev->NumSubdevices()) return 0xffffffff;
+
+		PCI_Device* dev=masterdev->GetSubdevice(fctnum);
+
+		if (dev!=NULL) {
+			switch (iolen) {
+				case 1:
+					{
+						Bit8u val8=read_pci_register(dev,regnum);
+						return val8;
+					}
+				case 2:
+					{
+						Bit16u val16=read_pci_register(dev,regnum);
+						val16|=(read_pci_register(dev,regnum+1)<<8);
+						return val16;
+					}
+				case 4:
+					{
+						Bit32u val32=read_pci_register(dev,regnum);
+						val32|=(read_pci_register(dev,regnum+1)<<8);
+						val32|=(read_pci_register(dev,regnum+2)<<16);
+						val32|=(read_pci_register(dev,regnum+3)<<24);
+						return val32;
+					}
+				default:
+					break;
+			}
+		}
+	}
+	return 0xffffffff;
+}
+
+
+static Bitu PCI_PM_Handler() {
+	LOG_MSG("PCI PMode handler, function %x",reg_ax);
+	return CBRET_NONE;
+}
+
+
+PCI_Device::PCI_Device(Bit16u vendor, Bit16u device) {
+	pci_id=-1;
+	pci_subfunction=-1;
+	vendor_id=vendor;
+	device_id=device;
+	num_subdevices=0;
+	for (Bitu dct=0;dct<PCI_MAX_PCIFUNCTIONS-1;dct++) subdevices[dct]=0;
+}
+
+void PCI_Device::SetPCIId(Bitu number, Bits subfct) {
+	if ((number>=0) && (number<PCI_MAX_PCIDEVICES)) {
+		pci_id=number;
+		if ((subfct>=0) && (subfct<PCI_MAX_PCIFUNCTIONS-1))
+			pci_subfunction=subfct;
+		else
+			pci_subfunction=-1;
+	}
+}
+
+bool PCI_Device::AddSubdevice(PCI_Device* dev) {
+	if (num_subdevices<PCI_MAX_PCIFUNCTIONS-1) {
+		if (subdevices[num_subdevices]!=NULL) E_Exit("PCI subdevice slot already in use!");
+		subdevices[num_subdevices]=dev;
+		num_subdevices++;
+		return true;
+	}
+	return false;
+}
+
+void PCI_Device::RemoveSubdevice(Bits subfct) {
+	if ((subfct>0) && (subfct<PCI_MAX_PCIFUNCTIONS)) {
+		if (subfct<=this->NumSubdevices()) {
+			delete subdevices[subfct-1];
+			subdevices[subfct-1]=NULL;
+			// should adjust things like num_subdevices as well...
+		}
+	}
+}
+
+PCI_Device* PCI_Device::GetSubdevice(Bits subfct) {
+	if (subfct>=PCI_MAX_PCIFUNCTIONS) return NULL;
+	if (subfct>0) {
+		if (subfct<=this->NumSubdevices()) return subdevices[subfct-1];
+	} else if (subfct==0) {
+		return this;
+	}
+	return NULL;
+}
+
+
+// queued devices (PCI device registering requested before the PCI framework was initialized)
+static const Bitu max_rqueued_devices=16;
+static Bitu num_rqueued_devices=0;
+static PCI_Device* rqueued_devices[max_rqueued_devices];
+
+
+#include "pci_devices.h"
+
+class PCI:public Module_base{
+private:
+	bool initialized;
+
+protected:
+	IO_WriteHandleObject PCI_WriteHandler[5];
+	IO_ReadHandleObject PCI_ReadHandler[5];
+
+	CALLBACK_HandlerObject callback_pci;
+
+public:
+
+	PhysPt GetPModeCallbackPointer(void) {
+		return Real2Phys(callback_pci.Get_RealPointer());
+	}
+
+	bool IsInitialized(void) {
+		return initialized;
+	}
+
+	// set up port handlers and configuration data
+	void InitializePCI(void) {
+		// install PCI-addressing ports
+		PCI_WriteHandler[0].Install(0xcf8,write_pci_addr,IO_MD);
+		PCI_ReadHandler[0].Install(0xcf8,read_pci_addr,IO_MD);
+		// install PCI-register read/write handlers
+		for (Bitu ct=0;ct<4;ct++) {
+			PCI_WriteHandler[1+ct].Install(0xcfc+ct,write_pci,IO_MB);
+			PCI_ReadHandler[1+ct].Install(0xcfc+ct,read_pci,IO_MB);
+		}
+
+		for (Bitu dev=0; dev<PCI_MAX_PCIDEVICES; dev++)
+			for (Bitu fct=0; fct<PCI_MAX_PCIFUNCTIONS-1; fct++)
+				for (Bitu reg=0; reg<256; reg++)
+					pci_cfg_data[dev][fct][reg] = 0;
+
+		callback_pci.Install(&PCI_PM_Handler,CB_IRETD,"PCI PM");
+
+		initialized=true;
+	}
+
+	// register PCI device to bus and setup data
+	Bits RegisterPCIDevice(PCI_Device* device, Bits slot=-1) {
+		if (device==NULL) return -1;
+
+		if (slot>=0) {
+			// specific slot specified, basic check for validity
+			if (slot>=PCI_MAX_PCIDEVICES) return -1;
+		} else {
+			// auto-add to new slot, check if one is still free
+			if (pci_devices_installed>=PCI_MAX_PCIDEVICES) return -1;
+		}
+
+		if (!initialized) InitializePCI();
+
+		if (slot<0) slot=pci_devices_installed;	// use next slot
+		Bits subfunction=0;	// main device unless specific already-occupied slot is requested
+		if (pci_devices[slot]!=NULL) {
+			subfunction=pci_devices[slot]->GetNextSubdeviceNumber();
+			if (subfunction<0) E_Exit("Too many PCI subdevices!");
+		}
+
+		if (device->InitializeRegisters(pci_cfg_data[slot][subfunction])) {
+			device->SetPCIId(slot, subfunction);
+			if (pci_devices[slot]==NULL) {
+				pci_devices[slot]=device;
+				pci_devices_installed++;
+			} else {
+				pci_devices[slot]->AddSubdevice(device);
+			}
+
+			return slot;
+		}
+
+		return -1;
+	}
+
+	void Deinitialize(void) {
+		initialized=false;
+		pci_devices_installed=0;
+		num_rqueued_devices=0;
+		pci_caddress=0;
+
+		for (Bitu dev=0; dev<PCI_MAX_PCIDEVICES; dev++)
+			for (Bitu fct=0; fct<PCI_MAX_PCIFUNCTIONS-1; fct++)
+				for (Bitu reg=0; reg<256; reg++)
+					pci_cfg_data[dev][fct][reg] = 0;
+
+		// install PCI-addressing ports
+		PCI_WriteHandler[0].Uninstall();
+		PCI_ReadHandler[0].Uninstall();
+		// install PCI-register read/write handlers
+		for (Bitu ct=0;ct<4;ct++) {
+			PCI_WriteHandler[1+ct].Uninstall();
+			PCI_ReadHandler[1+ct].Uninstall();
+		}
+
+		callback_pci.Uninstall();
+	}
+
+	void RemoveDevice(Bit16u vendor_id, Bit16u device_id) {
+		for (Bitu dct=0;dct<pci_devices_installed;dct++) {
+			if (pci_devices[dct]!=NULL) {
+				if (pci_devices[dct]->NumSubdevices()>0) {
+					for (Bitu sct=1;sct<PCI_MAX_PCIFUNCTIONS;sct++) {
+						PCI_Device* sdev=pci_devices[dct]->GetSubdevice(sct);
+						if (sdev!=NULL) {
+							if ((sdev->VendorID()==vendor_id) && (sdev->DeviceID()==device_id)) {
+								pci_devices[dct]->RemoveSubdevice(sct);
+							}
+						}
+					}
+				}
+
+				if ((pci_devices[dct]->VendorID()==vendor_id) && (pci_devices[dct]->DeviceID()==device_id)) {
+					delete pci_devices[dct];
+					pci_devices[dct]=NULL;
+				}
+			}
+		}
+
+		// check if all devices have been removed
+		bool any_device_left=false;
+		for (Bitu dct=0;dct<PCI_MAX_PCIDEVICES;dct++) {
+			if (dct>=pci_devices_installed) break;
+			if (pci_devices[dct]!=NULL) {
+				any_device_left=true;
+				break;
+			}
+		}
+		if (!any_device_left) Deinitialize();
+
+		Bitu last_active_device=PCI_MAX_PCIDEVICES;
+		for (Bitu dct=0;dct<PCI_MAX_PCIDEVICES;dct++) {
+			if (pci_devices[dct]!=NULL) last_active_device=dct;
+		}
+		if (last_active_device<pci_devices_installed)
+			pci_devices_installed=last_active_device+1;
+	}
+
+	PCI(Section* configuration):Module_base(configuration) {
+		initialized=false;
+		pci_devices_installed=0;
+
+		for (Bitu devct=0;devct<PCI_MAX_PCIDEVICES;devct++)
+			pci_devices[devct]=NULL;
+
+		if (num_rqueued_devices>0) {
+			// register all devices that have been added before the PCI bus was instantiated
+			for (Bitu dct=0;dct<num_rqueued_devices;dct++) {
+				this->RegisterPCIDevice(rqueued_devices[dct]);
+			}
+			num_rqueued_devices=0;
+		}
+	}
+
+	~PCI(){
+		initialized=false;
+		pci_devices_installed=0;
+		num_rqueued_devices=0;
+	}
+
+};
+
+static PCI* pci_interface=NULL;
+
+
+PhysPt PCI_GetPModeInterface(void) {
+	if (pci_interface) {
+		return pci_interface->GetPModeCallbackPointer();
+	}
+	return 0;
+}
+
+bool PCI_IsInitialized() {
+	if (pci_interface) return pci_interface->IsInitialized();
+	return false;
+}
+
+
+void PCI_ShutDown(Section* sec){
+	delete pci_interface;
+	pci_interface=NULL;
+}
+
+void PCI_Init(Section* sec) {
+	pci_interface = new PCI(sec);
+	sec->AddDestroyFunction(&PCI_ShutDown,false);
+}
+
+#endif
diff -Nur dosbox-0.74/src/hardware/pci_devices.h dosbox-0.74.patch/src/hardware/pci_devices.h
--- dosbox-0.74/src/hardware/pci_devices.h	1970-01-01 01:00:00.000000000 +0100
+++ dosbox-0.74.patch/src/hardware/pci_devices.h	2016-12-11 18:35:15.538284005 +0100
@@ -0,0 +1,18 @@
+/*
+ *  Copyright (C) 2002-2013  The DOSBox Team
+ *
+ *  This program is free software; you can redistribute it and/or modify
+ *  it under the terms of the GNU General Public License as published by
+ *  the Free Software Foundation; either version 2 of the License, or
+ *  (at your option) any later version.
+ *
+ *  This program is distributed in the hope that it will be useful,
+ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *  GNU General Public License for more details.
+ *
+ *  You should have received a copy of the GNU General Public License
+ *  along with this program; if not, write to the Free Software
+ *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+ */
+
diff -Nur dosbox-0.74/src/hardware/pcspeaker.cpp dosbox-0.74.patch/src/hardware/pcspeaker.cpp
--- dosbox-0.74/src/hardware/pcspeaker.cpp	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/hardware/pcspeaker.cpp	2016-12-11 18:35:15.538284005 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
  
- /* $Id: pcspeaker.cpp,v 1.26 2009-05-27 09:15:41 qbix79 Exp $ */
 
 #include <math.h>
 #include "dosbox.h"
diff -Nur dosbox-0.74/src/hardware/pic.cpp dosbox-0.74.patch/src/hardware/pic.cpp
--- dosbox-0.74/src/hardware/pic.cpp	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/hardware/pic.cpp	2016-12-11 18:35:15.538284005 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,10 +16,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: pic.cpp,v 1.44 2009-05-27 09:15:41 qbix79 Exp $ */
-
-#include <list>
-
 #include "dosbox.h"
 #include "inout.h"
 #include "cpu.h"
@@ -30,35 +26,144 @@
 
 #define PIC_QUEUESIZE 512
 
-struct IRQ_Block {
-	bool masked;
-	bool active;
-	bool inservice;
-	Bitu vector;
-};
-
 struct PIC_Controller {
 	Bitu icw_words;
 	Bitu icw_index;
-	Bitu masked;
-
 	bool special;
 	bool auto_eoi;
 	bool rotate_on_auto_eoi;
 	bool single;
 	bool request_issr;
 	Bit8u vector_base;
-};
 
-Bitu PIC_Ticks=0;
-Bitu PIC_IRQCheck;
-Bitu PIC_IRQOnSecondPicActive;
-Bitu PIC_IRQActive;
+	Bit8u irr;        // request register
+	Bit8u imr;        // mask register
+	Bit8u imrr;       // mask register reversed (makes bit tests simpler)
+	Bit8u isr;        // in service register
+	Bit8u isrr;       // in service register reversed (makes bit tests simpler)
+	Bit8u active_irq; //currently active irq
+
+
+	void set_imr(Bit8u val);
+
+	void check_after_EOI(){
+		//Update the active_irq as an EOI is likely to change that.
+		update_active_irq();
+		if((irr&imrr)&isrr) check_for_irq();
+	}
+
+	void update_active_irq() {
+		if(isr == 0) {active_irq = 8; return;}
+		for(Bit8u i = 0, s = 1; i < 8;i++, s<<=1){
+			if( isr & s){
+				active_irq = i;
+				return;
+			}
+		}
+	}
+
+	void check_for_irq(){
+		const Bit8u possible_irq = (irr&imrr)&isrr;
+		if (possible_irq) {
+			const Bit8u a_irq = special?8:active_irq;
+			for(Bit8u i = 0, s = 1; i < a_irq;i++, s<<=1){
+				if ( possible_irq & s ) {
+					//There is an irq ready to be served => signal master and/or cpu
+					activate();
+					return;
+				}
+			}
+		}
+		deactivate(); //No irq, remove signal to master and/or cpu
+	}
+
+	//Signals master/cpu that there is an irq ready.
+	void activate();
 
+	//Removes signal to master/cpu that there is an irq ready.
+	void deactivate();
+
+	void raise_irq(Bit8u val){
+		Bit8u bit = 1 << (val);
+		if((irr & bit)==0) { //value changed (as it is currently not active)
+			irr|=bit;
+			if((bit&imrr)&isrr) { //not masked and not in service
+				if(special || val < active_irq) activate();
+			}
+		}
+	}
+
+	void lower_irq(Bit8u val){
+		Bit8u bit = 1 << ( val);
+		if(irr & bit) { //value will change (as it is currently active)
+			irr&=~bit;
+			if((bit&imrr)&isrr) { //not masked and not in service
+				//This irq might have toggled PIC_IRQCheck/caused irq 2 on master, when it was raised.
+				//If it is active, then recheck it, we can't just deactivate as there might be more IRQS raised.
+				if(special || val < active_irq) check_for_irq();
+			}
+		}
+	}
+
+	//handles all bits and logic related to starting this IRQ, it does NOT start the interrupt on the CPU.
+	void start_irq(Bit8u val);
+};
 
-static IRQ_Block irqs[16];
 static PIC_Controller pics[2];
-static bool PIC_Special_Mode = false; //Saves one compare in the pic_run_irqloop
+static PIC_Controller& master = pics[0];
+static PIC_Controller& slave  = pics[1];
+Bitu PIC_Ticks = 0;
+Bitu PIC_IRQCheck = 0; //Maybe make it a bool and/or ensure 32bit size (x86 dynamic core seems to assume 32 bit variable size)
+
+
+void PIC_Controller::set_imr(Bit8u val) {
+	if (GCC_UNLIKELY(machine==MCH_PCJR)) {
+		//irq 6 is a NMI on the PCJR
+		if (this == &master) val &= ~(1 <<(6));
+	}
+	Bit8u change = (imr) ^ (val); //Bits that have changed become 1.
+	imr  =  val;
+	imrr = ~val;
+
+	//Test if changed bits are set in irr and are not being served at the moment
+	//Those bits have impact on whether the cpu emulation should be paused or not.
+	if((irr & change)&isrr) check_for_irq();
+}
+
+void PIC_Controller::activate() { 
+	//Stops CPU if master, signals master if slave
+	if(this == &master) {
+		PIC_IRQCheck = 1;
+		//cycles 0, take care of the port IO stuff added in raise_irq base caller.
+		CPU_CycleLeft += CPU_Cycles;
+		CPU_Cycles = 0;
+		//maybe when coming from a EOI, give a tiny delay. (for the cpu to pick it up) (see PIC_Activate_IRQ)
+	} else {
+		master.raise_irq(2);
+	}
+}
+
+void PIC_Controller::deactivate() { 
+	//removes irq check value  if master, signals master if slave
+	if(this == &master) {
+		PIC_IRQCheck = 0;
+	} else {
+		master.lower_irq(2);
+	}
+}
+
+void PIC_Controller::start_irq(Bit8u val){
+	irr&=~(1<<(val));
+	if (!auto_eoi) {
+		active_irq = val;
+		isr |= 1<<(val);
+		isrr = ~isr;
+	} else if (GCC_UNLIKELY(rotate_on_auto_eoi)) {
+		E_Exit("rotate on auto EOI not handled");
+	}
+}
+
+
 struct PICEntry {
 	float index;
 	Bitu value;
@@ -74,10 +179,7 @@
 
 static void write_command(Bitu port,Bitu val,Bitu iolen) {
 	PIC_Controller * pic=&pics[port==0x20 ? 0 : 1];
-	Bitu irq_base=port==0x20 ? 0 : 8;
-	Bitu i;
-	static Bit16u IRQ_priority_table[16] = 
-		{ 0,1,2,8,9,10,11,12,13,14,15,3,4,5,6,7 };
+
 	if (GCC_UNLIKELY(val&0x10)) {		// ICW1 issued
 		if (val&0x04) E_Exit("PIC: 4 byte interval not handled");
 		if (val&0x08) E_Exit("PIC: level triggered mode not handled");
@@ -92,42 +194,26 @@
 			else pic->request_issr=false;			/* select read interrupt request register */
 		}
 		if (val&0x40) {		// special mask select
-			if (val&0x20) pic->special=true;
-			else pic->special=false;
-			if(pic[0].special || pics[1].special) 
-				PIC_Special_Mode = true; else 
-				PIC_Special_Mode = false;
-			if (PIC_IRQCheck) { //Recheck irqs
-				CPU_CycleLeft += CPU_Cycles;
-				CPU_Cycles = 0;
-			}
+			if (val&0x20) pic->special = true;
+			else pic->special = false;
+			//Check if there are irqs ready to run, as the priority system has possibly been changed.
+			pic->check_for_irq();
 			LOG(LOG_PIC,LOG_NORMAL)("port %X : special mask %s",port,(pic->special)?"ON":"OFF");
 		}
 	} else {	// OCW2 issued
 		if (val&0x20) {		// EOI commands
 			if (GCC_UNLIKELY(val&0x80)) E_Exit("rotate mode not supported");
 			if (val&0x40) {		// specific EOI
-				if (PIC_IRQActive==(irq_base+val-0x60U)) {
-					irqs[PIC_IRQActive].inservice=false;
-					PIC_IRQActive=PIC_NOIRQ;
-					for (i=0; i<=15; i++) {
-						if (irqs[IRQ_priority_table[i]].inservice) {
-							PIC_IRQActive=IRQ_priority_table[i];
-							break;
-						}
-					}
-				}
+				pic->isr &= ~(1<< ((val-0x60)));
+				pic->isrr = ~pic->isr;
+				pic->check_after_EOI();
 //				if (val&0x80);	// perform rotation
 			} else {		// nonspecific EOI
-				if (PIC_IRQActive<(irq_base+8)) {
-					irqs[PIC_IRQActive].inservice=false;
-					PIC_IRQActive=PIC_NOIRQ;
-					for (i=0; i<=15; i++){
-						if(GCC_UNLIKELY(irqs[IRQ_priority_table[i]].inservice)) {
-							PIC_IRQActive=IRQ_priority_table[i];
-							break;
-						}
-					}
+				if (pic->active_irq != 8) { 
+					//If there is no irq in service, ignore the call, some games send an eoi to both pics when a sound irq happens (regardless of the irq).
+					pic->isr &= ~(1 << (pic->active_irq));
+					pic->isrr = ~pic->isr;
+					pic->check_after_EOI();
 				}
 //				if (val&0x80);	// perform rotation
 			}
@@ -144,43 +230,13 @@
 
 static void write_data(Bitu port,Bitu val,Bitu iolen) {
 	PIC_Controller * pic=&pics[port==0x21 ? 0 : 1];
-	Bitu irq_base=(port==0x21) ? 0 : 8;
-	Bitu i;
-	bool old_irq2_mask = irqs[2].masked;
 	switch(pic->icw_index) {
 	case 0:                        /* mask register */
-		LOG(LOG_PIC,LOG_NORMAL)("%d mask %X",port==0x21 ? 0 : 1,val);
-		for (i=0;i<=7;i++) {
-			irqs[i+irq_base].masked=(val&(1<<i))>0;
-			if(port==0x21) {
-				if (irqs[i+irq_base].active && !irqs[i+irq_base].masked) PIC_IRQCheck|=(1 << (i+irq_base));
-				else PIC_IRQCheck&=~(1 << (i+irq_base));
-			} else {
-				if (irqs[i+irq_base].active && !irqs[i+irq_base].masked && !irqs[2].masked) PIC_IRQCheck|=(1 << (i+irq_base));
-				else PIC_IRQCheck&=~(1 << (i+irq_base));
-			}
-		}
-		if (machine==MCH_PCJR) {
-			/* irq6 cannot be disabled as it serves as pseudo-NMI */
-			irqs[6].masked=false;
-		}
-		if(irqs[2].masked != old_irq2_mask) {
-		/* Irq 2 mask has changed recheck second pic */
-			for(i=8;i<=15;i++) {
-				if (irqs[i].active && !irqs[i].masked && !irqs[2].masked) PIC_IRQCheck|=(1 << (i));
-				else PIC_IRQCheck&=~(1 << (i));
-			}
-		}
-		if (PIC_IRQCheck) {
-			CPU_CycleLeft+=CPU_Cycles;
-			CPU_Cycles=0;
-		}
+		pic->set_imr(val);
 		break;
 	case 1:                        /* icw2          */
 		LOG(LOG_PIC,LOG_NORMAL)("%d:Base vector %X",port==0x21 ? 0 : 1,val);
-		for (i=0;i<=7;i++) {
-			irqs[i+irq_base].vector=(val&0xf8)+i;
-		};
+		pic->vector_base = val&0xf8;
 		if(pic->icw_index++ >= pic->icw_words) pic->icw_index=0;
 		else if(pic->single) pic->icw_index=3;		/* skip ICW3 in single mode */
 		break;
@@ -215,71 +271,70 @@
 
 static Bitu read_command(Bitu port,Bitu iolen) {
 	PIC_Controller * pic=&pics[port==0x20 ? 0 : 1];
-	Bitu irq_base=(port==0x20) ? 0 : 8;
-	Bitu i;Bit8u ret=0;Bit8u b=1;
-	if (pic->request_issr) {
-		for (i=irq_base;i<irq_base+8;i++) {
-			if (irqs[i].inservice) ret|=b;
-			b <<= 1;
-		}
-	} else {
-		for (i=irq_base;i<irq_base+8;i++) {
-			if (irqs[i].active)	ret|=b;
-			b <<= 1;
-		}
-		if (irq_base==0 && (PIC_IRQCheck&0xff00)) ret |=4;
+	if (pic->request_issr){
+		return pic->isr;
+	} else { 
+		return pic->irr;
 	}
-	return ret;
 }
 
+
 static Bitu read_data(Bitu port,Bitu iolen) {
-	Bitu irq_base=(port==0x21) ? 0 : 8;
-	Bitu i;Bit8u ret=0;Bit8u b=1;
-	for (i=irq_base;i<=irq_base+7;i++) {
-		if (irqs[i].masked)	ret|=b;
-		b <<= 1;
-	}
-	return ret;
+	PIC_Controller * pic=&pics[port==0x21 ? 0 : 1];
+	return pic->imr;
 }
 
-
 void PIC_ActivateIRQ(Bitu irq) {
-	if( irq < 8 ) {
-		irqs[irq].active = true;
-		if (!irqs[irq].masked) {
-			PIC_IRQCheck|=(1 << irq);
-		}
-	} else 	if (irq < 16) {
-		irqs[irq].active = true;
-		PIC_IRQOnSecondPicActive|=(1 << irq);
-		if (!irqs[irq].masked && !irqs[2].masked) {
-			PIC_IRQCheck|=(1 << irq);
-		}
+	Bitu t = irq>7 ? (irq - 8): irq;
+	PIC_Controller * pic=&pics[irq>7 ? 1 : 0];
+
+	Bit32s OldCycles = CPU_Cycles;
+	pic->raise_irq(t); //Will set the CPU_Cycles to zero if this IRQ will be handled directly
+
+	if (GCC_UNLIKELY(OldCycles != CPU_Cycles)) {
+		// if CPU_Cycles have changed, this means that the interrupt was triggered by an I/O
+		// register write rather than an event.
+		// Real hardware executes 0 to ~13 NOPs or comparable instructions
+		// before the processor picks up the interrupt. Let's try with 2
+		// cycles here.
+		// Required by Panic demo (irq0), It came from the desert (MPU401)
+		// Does it matter if CPU_CycleLeft becomes negative?
+
+		// It might be an idea to do this always in order to simulate this
+		// So on write mask and EOI as well. (so inside the activate function)
+//		CPU_CycleLeft += (CPU_Cycles-2);
+		CPU_CycleLeft -= 2;
+		CPU_Cycles = 2;
 	}
 }
 
 void PIC_DeActivateIRQ(Bitu irq) {
-	if (irq<16) {
-		irqs[irq].active=false;
-		PIC_IRQCheck&=~(1 << irq);
-		PIC_IRQOnSecondPicActive&=~(1 << irq);
-	}
-}
-static inline bool PIC_startIRQ(Bitu i) {
-	/* irqs on second pic only if irq 2 isn't masked */
-	if( i > 7 && irqs[2].masked) return false;
-	irqs[i].active = false;
-	PIC_IRQCheck&= ~(1 << i);
-	PIC_IRQOnSecondPicActive&= ~(1 << i);
-	CPU_HW_Interrupt(irqs[i].vector);
-	Bitu pic=(i&8)>>3;
-	if (!pics[pic].auto_eoi) { //irq 0-7 => pic 0 else pic 1 
-		PIC_IRQActive = i;
-		irqs[i].inservice = true;
-	} else if (GCC_UNLIKELY(pics[pic].rotate_on_auto_eoi)) {
-		E_Exit("rotate on auto EOI not handled");
+	Bitu t = irq>7 ? (irq - 8): irq;
+	PIC_Controller * pic=&pics[irq>7 ? 1 : 0];
+	pic->lower_irq(t);
+}
+
+static void slave_startIRQ(){
+	Bit8u pic1_irq = 8;
+	const Bit8u p = (slave.irr & slave.imrr)&slave.isrr;
+	const Bit8u max = slave.special?8:slave.active_irq;
+	for(Bit8u i = 0,s = 1;i < max;i++, s<<=1){
+		if (p&s){
+			pic1_irq = i;
+			break;
+		}
 	}
-	return true;
+	// Maybe change the E_Exit to a return
+	if (GCC_UNLIKELY(pic1_irq == 8)) E_Exit("irq 2 is active, but no irq active on the slave PIC.");
+
+	slave.start_irq(pic1_irq);
+	master.start_irq(2);
+	CPU_HW_Interrupt(slave.vector_base + pic1_irq);
+}
+
+static void inline master_startIRQ(Bitu i){
+	master.start_irq(i);
+	CPU_HW_Interrupt(master.vector_base + i);
 }
 
 void PIC_runIRQs(void) {
@@ -287,70 +342,31 @@
 	if (GCC_UNLIKELY(!PIC_IRQCheck)) return;
 	if (GCC_UNLIKELY(cpudecoder==CPU_Core_Normal_Trap_Run)) return;
 
-	static Bitu IRQ_priority_order[16] = 
-		{ 0,1,2,8,9,10,11,12,13,14,15,3,4,5,6,7 };
-	static Bit16u IRQ_priority_lookup[17] =
-		{ 0,1,2,11,12,13,14,15,3,4,5,6,7,8,9,10,16 };
-	Bit16u activeIRQ = PIC_IRQActive;
-	if (activeIRQ == PIC_NOIRQ) activeIRQ = 16;
-	/* Get the priority of the active irq */
-	Bit16u Priority_Active_IRQ = IRQ_priority_lookup[activeIRQ];
-
-	Bitu i,j;
-	/* j is the priority (walker)
-	 * i is the irq at the current priority */
-
-	/* If one of the pics is in special mode use a check that cares for that. */
-	if(!PIC_Special_Mode) {
-		for (j = 0; j < Priority_Active_IRQ; j++) {
-			i = IRQ_priority_order[j];
-			if (!irqs[i].masked && irqs[i].active) {
-				if(GCC_LIKELY(PIC_startIRQ(i))) return;
-			}
-		}
-	} else {	/* Special mode variant */
-		for (j = 0; j<= 15; j++) {
-			i = IRQ_priority_order[j];
-			if ( (j < Priority_Active_IRQ) || (pics[ ((i&8)>>3) ].special) ) {
-				if (!irqs[i].masked && irqs[i].active) {
-					/* the irq line is active. it's not masked and
-					 * the irq is allowed priority wise. So let's start it */
-					/* If started successfully return, else go for the next */
-					if(PIC_startIRQ(i)) return;
-				}
+	const Bit8u p = (master.irr & master.imrr)&master.isrr;
+	const Bit8u max = master.special?8:master.active_irq;
+	for(Bit8u i = 0,s = 1;i < max;i++, s<<=1){
+		if (p&s){
+			if (i==2) { //second pic
+				slave_startIRQ();
+			} else {
+				master_startIRQ(i);
 			}
+			break;
 		}
 	}
+	//Disable check variable.
+	PIC_IRQCheck = 0;
 }
 
 void PIC_SetIRQMask(Bitu irq, bool masked) {
-	if(irqs[irq].masked == masked) return;	/* Do nothing if mask doesn't change */
-	bool old_irq2_mask = irqs[2].masked;
-	irqs[irq].masked=masked;
-	if(irq < 8) {
-		if (irqs[irq].active && !irqs[irq].masked) { 
-			PIC_IRQCheck|=(1 << (irq));
-		} else { 
-			PIC_IRQCheck&=~(1 << (irq));
-		}
-	} else {
-		if (irqs[irq].active && !irqs[irq].masked && !irqs[2].masked) {
-			PIC_IRQCheck|=(1 << (irq));
-		} else { 
-			PIC_IRQCheck&=~(1 << (irq));
-		}
-	}
-	if(irqs[2].masked != old_irq2_mask) {
-	/* Irq 2 mask has changed recheck second pic */
-		for(Bitu i=8;i<=15;i++) {
-			if (irqs[i].active && !irqs[i].masked && !irqs[2].masked) PIC_IRQCheck|=(1 << (i));
-			else PIC_IRQCheck&=~(1 << (i));
-		}
-	}
-	if (PIC_IRQCheck) {
-		CPU_CycleLeft+=CPU_Cycles;
-		CPU_Cycles=0;
-	}
+	Bitu t = irq>7 ? (irq - 8): irq;
+	PIC_Controller * pic=&pics[irq>7 ? 1 : 0];
+	//clear bit
+	Bit8u bit = 1 <<(t);
+	Bit8u newmask = pic->imr;
+	newmask &= ~bit;
+	if (masked) newmask |= bit;
+	pic->set_imr(newmask);
 }
 
 static void AddEntry(PICEntry * entry) {
@@ -453,7 +469,7 @@
 
 
 bool PIC_RunQueue(void) {
-	/* Check to see if a new milisecond needs to be started */
+	/* Check to see if a new millisecond needs to be started */
 	CPU_CycleLeft+=CPU_Cycles;
 	CPU_Cycles=0;
 	if (CPU_CycleLeft<=0) {
@@ -540,20 +556,18 @@
 	}
 }
 
-
-class PIC:public Module_base{
+/* Use full name to avoid name clash with compile option for position-independent code */
+class PIC_8259A: public Module_base {
 private:
 	IO_ReadHandleObject ReadHandler[4];
 	IO_WriteHandleObject WriteHandler[4];
 public:
-	PIC(Section* configuration):Module_base(configuration){
+	PIC_8259A(Section* configuration):Module_base(configuration){
 		/* Setup pic0 and pic1 with initial values like DOS has normally */
 		PIC_IRQCheck=0;
-		PIC_IRQActive=PIC_NOIRQ;
 		PIC_Ticks=0;
 		Bitu i;
 		for (i=0;i<2;i++) {
-			pics[i].masked=0xff;
 			pics[i].auto_eoi=false;
 			pics[i].rotate_on_auto_eoi=false;
 			pics[i].request_issr=false;
@@ -561,24 +575,21 @@
 			pics[i].single=false;
 			pics[i].icw_index=0;
 			pics[i].icw_words=0;
-		}
-		for (i=0;i<=7;i++) {
-			irqs[i].active=false;
-			irqs[i].masked=true;
-			irqs[i].inservice=false;
-			irqs[i+8].active=false;
-			irqs[i+8].masked=true;
-			irqs[i+8].inservice=false;
-			irqs[i].vector=0x8+i;
-			irqs[i+8].vector=0x70+i;	
-		}
-		irqs[0].masked=false;					/* Enable system timer */
-		irqs[1].masked=false;					/* Enable Keyboard IRQ */
-		irqs[2].masked=false;					/* Enable second pic */
-		irqs[8].masked=false;					/* Enable RTC IRQ */
+			pics[i].irr = pics[i].isr = pics[i].imrr = 0;
+			pics[i].isrr = pics[i].imr = 0xff;
+			pics[i].active_irq = 8;
+		}
+		master.vector_base = 0x08;
+		slave.vector_base = 0x70;
+
+		PIC_SetIRQMask(0,false);					/* Enable system timer */
+		PIC_SetIRQMask(1,false);					/* Enable system timer */
+		PIC_SetIRQMask(2,false);					/* Enable second pic */
+		PIC_SetIRQMask(8,false);					/* Enable RTC IRQ */
+
 		if (machine==MCH_PCJR) {
 			/* Enable IRQ6 (replacement for the NMI for PCJr) */
-			irqs[6].masked=false;
+			PIC_SetIRQMask(6,false);
 		}
 		ReadHandler[0].Install(0x20,read_command,IO_MB);
 		ReadHandler[1].Install(0x21,read_data,IO_MB);
@@ -596,17 +607,18 @@
 		pic_queue.free_entry=&pic_queue.entries[0];
 		pic_queue.next_entry=0;
 	}
-	~PIC(){
+
+	~PIC_8259A(){
 	}
 };
 
-static PIC* test;
+static PIC_8259A* test;
 
 void PIC_Destroy(Section* sec){
 	delete test;
 }
 
 void PIC_Init(Section* sec) {
-	test = new PIC(sec);
+	test = new PIC_8259A(sec);
 	sec->AddDestroyFunction(&PIC_Destroy);
 }
diff -Nur dosbox-0.74/src/hardware/sblaster.cpp dosbox-0.74.patch/src/hardware/sblaster.cpp
--- dosbox-0.74/src/hardware/sblaster.cpp	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/hardware/sblaster.cpp	2016-12-11 18:35:15.538284005 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: sblaster.cpp,v 1.78 2009-10-25 16:22:22 c2woody Exp $ */
 
 #include <iomanip>
 #include <sstream>
@@ -275,7 +274,7 @@
 }
 
 static void DSP_DMA_CallBack(DmaChannel * chan, DMAEvent event) {
-	if (event==DMA_REACHED_TC) return;
+	if (chan!=sb.dma.chan || event==DMA_REACHED_TC) return;
 	else if (event==DMA_MASKED) {
 		if (sb.mode==MODE_DMA) {
 			GenerateDMASound(sb.dma.min);
@@ -504,6 +503,8 @@
 	sb.dma.left-=read;
 	if (!sb.dma.left) {
 		PIC_RemoveEvents(END_DMA_Event);
+		if (sb.dma.mode >= DSP_DMA_16) SB_RaiseIRQ(SB_IRQ_16);
+		else SB_RaiseIRQ(SB_IRQ_8);
 		if (!sb.dma.autoinit) {
 			LOG(LOG_SB,LOG_NORMAL)("Single cycle transfer ended");
 			sb.mode=MODE_NONE;
@@ -515,8 +516,6 @@
 				sb.mode=MODE_NONE;
 			}
 		}
-		if (sb.dma.mode >= DSP_DMA_16) SB_RaiseIRQ(SB_IRQ_16);
-		else SB_RaiseIRQ(SB_IRQ_8);
 	}
 }
 
@@ -872,6 +871,11 @@
 	case 0x76:  /* 074h : Single Cycle 3-bit(2.6bit) ADPCM */
 		DSP_PrepareDMA_Old(DSP_DMA_3,false,false);
 		break;
+	case 0x7d:	/* Auto Init 4-bit ADPCM Reference */
+		DSP_SB2_ABOVE;
+		sb.adpcm.haveref=true;
+		DSP_PrepareDMA_Old(DSP_DMA_4,true,false);
+		break;
 	case 0x17:	/* 017h : Single Cycle 2-bit ADPCM Reference*/
 		sb.adpcm.haveref=true;
 	case 0x16:  /* 074h : Single Cycle 2-bit ADPCM */
@@ -900,6 +904,9 @@
 	case 0xd0:	/* Halt 8-bit DMA */
 //		DSP_ChangeMode(MODE_NONE);
 //		Games sometimes already program a new dma before stopping, gives noise
+		if (sb.mode==MODE_NONE) {
+			// possibly different code here that does not switch to MODE_DMA_PAUSE
+		}
 		sb.mode=MODE_DMA_PAUSE;
 		PIC_RemoveEvents(END_DMA_Event);
 		break;
@@ -920,7 +927,7 @@
 	case 0xd4:	/* Continue DMA 8-bit*/
 		if (sb.mode==MODE_DMA_PAUSE) {
 			sb.mode=MODE_DMA_MASKED;
-			sb.dma.chan->Register_Callback(DSP_DMA_CallBack);
+			if (sb.dma.chan!=NULL) sb.dma.chan->Register_Callback(DSP_DMA_CallBack);
 		}
 		break;
 	case 0xd9:  /* Exit Autoinitialize 16-bit */
@@ -977,7 +984,12 @@
 		DSP_AddData(sb.dsp.test_register);;
 		break;
 	case 0xf2:	/* Trigger 8bit IRQ */
-		SB_RaiseIRQ(SB_IRQ_8);
+		//Small delay in order to emulate the slowness of the DSP, fixes Llamatron 2012 and Lemmings 3D
+		PIC_AddEvent(&DSP_RaiseIRQEvent,0.01f); 
+		break;
+	case 0xf3:   /* Trigger 16bit IRQ */
+		DSP_SB16_ONLY; 
+		SB_RaiseIRQ(SB_IRQ_16);
 		break;
 	case 0xf8:  /* Undocumented, pre-SB16 only */
 		DSP_FlushData();
@@ -990,7 +1002,7 @@
 		DSP_SB2_ABOVE;
 		LOG(LOG_SB,LOG_ERROR)("DSP:Unimplemented MIDI UART command %2X",sb.dsp.cmd);
 		break;
-	case 0x7d: case 0x7f: case 0x1f:
+	case 0x7f: case 0x1f:
 		DSP_SB2_ABOVE;
 		LOG(LOG_SB,LOG_ERROR)("DSP:Unimplemented auto-init DMA ADPCM command %2X",sb.dsp.cmd);
 		break;
@@ -1090,11 +1102,16 @@
 	chan=MIXER_FindChannel("FM");
 	if (chan) chan->SetVolume(float(sb.mixer.master[0])/31.0f*CALCVOL(sb.mixer.fm[0]),
 							  float(sb.mixer.master[1])/31.0f*CALCVOL(sb.mixer.fm[1]));
+	chan=MIXER_FindChannel("CDAUDIO");
+	if (chan) chan->SetVolume(float(sb.mixer.master[0])/31.0f*CALCVOL(sb.mixer.cda[0]),
+							  float(sb.mixer.master[1])/31.0f*CALCVOL(sb.mixer.cda[1]));
 }
 
 static void CTMIXER_Reset(void) {
 	sb.mixer.fm[0]=
 	sb.mixer.fm[1]=
+	sb.mixer.cda[0]=
+	sb.mixer.cda[1]=
 	sb.mixer.dac[0]=
 	sb.mixer.dac[1]=31;
 	sb.mixer.master[0]=
@@ -1106,8 +1123,9 @@
 	_WHICH_[0]=   ((((_VAL_) & 0xf0) >> 3)|(sb.type==SBT_16 ? 1:3));	\
 	_WHICH_[1]=   ((((_VAL_) & 0x0f) << 1)|(sb.type==SBT_16 ? 1:3));	\
 
-#define MAKEPROVOL(_WHICH_)			\
-	((((_WHICH_[0] & 0x1e) << 3) | ((_WHICH_[1] & 0x1e) >> 1)) & (sb.type==SBT_16 ? 0xff:0xee))
+#define MAKEPROVOL(_WHICH_)											\
+	((((_WHICH_[0] & 0x1e) << 3) | ((_WHICH_[1] & 0x1e) >> 1)) |	\
+		((sb.type==SBT_PRO1 || sb.type==SBT_PRO2) ? 0x11:0))
 
 static void DSP_ChangeStereo(bool stereo) {
 	if (!sb.dma.stereo && stereo) {
@@ -1147,10 +1165,15 @@
 		break;
 	case 0x08:		/* CDA Volume (SB2 Only) */
 		SETPROVOL(sb.mixer.cda,(val&0xf)|(val<<4));
+		CTMIXER_UpdateVolumes();
 		break;
 	case 0x0a:		/* Mic Level (SBPRO) or DAC Volume (SB2): 2-bit, 3-bit on SB16 */
-		if (sb.type==SBT_2) sb.mixer.dac[0]=sb.mixer.dac[1]=((val & 0x6) << 2)|3;
-		else sb.mixer.mic=((val & 0x7) << 2)|(sb.type==SBT_16?1:3);
+		if (sb.type==SBT_2) {
+			sb.mixer.dac[0]=sb.mixer.dac[1]=((val & 0x6) << 2)|3;
+			CTMIXER_UpdateVolumes();
+		} else {
+			sb.mixer.mic=((val & 0x7) << 2)|(sb.type==SBT_16?1:3);
+		}
 		break;
 	case 0x0e:		/* Output/Stereo Select */
 		sb.mixer.stereo=(val & 0x2) > 0;
@@ -1168,6 +1191,7 @@
 		break;
 	case 0x28:		/* CD Audio Volume (SBPRO) */
 		SETPROVOL(sb.mixer.cda,val);
+		CTMIXER_UpdateVolumes();
 		break;
 	case 0x2e:		/* Line-in Volume (SBPRO) */
 		SETPROVOL(sb.mixer.lin,val);
@@ -1211,10 +1235,16 @@
 		}
 		break;
 	case 0x36:		/* CD Volume Left (SB16) */
-		if (sb.type==SBT_16) sb.mixer.cda[0]=val>>3;
+		if (sb.type==SBT_16) {
+			sb.mixer.cda[0]=val>>3;
+			CTMIXER_UpdateVolumes();
+		}
 		break;
 	case 0x37:		/* CD Volume Right (SB16) */
-		if (sb.type==SBT_16) sb.mixer.cda[1]=val>>3;
+		if (sb.type==SBT_16) {
+			sb.mixer.cda[1]=val>>3;
+			CTMIXER_UpdateVolumes();
+		}
 		break;
 	case 0x38:		/* Line-in Volume Left (SB16) */
 		if (sb.type==SBT_16) sb.mixer.lin[0]=val>>3;
@@ -1345,7 +1375,8 @@
 		return ret;
 	case 0x82:		/* IRQ Status */
 		return	(sb.irq.pending_8bit ? 0x1 : 0) |
-				(sb.irq.pending_16bit ? 0x2 : 0);
+				(sb.irq.pending_16bit ? 0x2 : 0) | 
+				((sb.type == SBT_16) ? 0x20 : 0);
 	default:
 		if (	((sb.type == SBT_PRO1 || sb.type == SBT_PRO2) && sb.mixer.index==0x0c) || /* Input control on SBPro */
 			(sb.type == SBT_16 && sb.mixer.index >= 0x3b && sb.mixer.index <= 0x47)) /* New SB16 registers */
diff -Nur dosbox-0.74/src/hardware/serialport/directserial.cpp dosbox-0.74.patch/src/hardware/serialport/directserial.cpp
--- dosbox-0.74/src/hardware/serialport/directserial.cpp	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/hardware/serialport/directserial.cpp	2016-12-11 18:35:15.538284005 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: directserial.cpp,v 1.2 2009-09-26 09:15:19 h-a-l-9000 Exp $ */
 
 #include "dosbox.h"
 
diff -Nur dosbox-0.74/src/hardware/serialport/directserial.h dosbox-0.74.patch/src/hardware/serialport/directserial.h
--- dosbox-0.74/src/hardware/serialport/directserial.h	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/hardware/serialport/directserial.h	2016-12-11 18:35:15.538284005 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: directserial.h,v 1.2 2009-09-26 09:15:19 h-a-l-9000 Exp $ */
 
 // include guard
 #ifndef DOSBOX_DIRECTSERIAL_WIN32_H
diff -Nur dosbox-0.74/src/hardware/serialport/libserial.cpp dosbox-0.74.patch/src/hardware/serialport/libserial.cpp
--- dosbox-0.74/src/hardware/serialport/libserial.cpp	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/hardware/serialport/libserial.cpp	2016-12-11 18:35:15.538284005 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: libserial.cpp,v 1.4 2009-11-02 09:51:02 h-a-l-9000 Exp $ */
 
 #include "libserial.h"
 
@@ -45,6 +44,7 @@
 	int len = strlen(portname);
 	if(len > 240) {
 		SetLastError(ERROR_BUFFER_OVERFLOW);
+		free(cp);
 		return false;
 	}
 	char extended_portname[256] = "\\\\.\\";
@@ -197,7 +197,7 @@
 	char chRead;
 
 	int retval = 0;
-	// receive a byte; TODO communicate faliure
+	// receive a byte; TODO communicate failure
 	if (ReadFile (port->porthandle, &chRead, 1, &dwRead, NULL)) {
 		if (dwRead) {
 			// check for errors
@@ -580,7 +580,7 @@
 	char chRead;
 
 	int retval = 0;
-	// receive a byte; TODO communicate faliure
+	// receive a byte; TODO communicate failure
 	if (DosRead(port->porthandle, &chRead, 1, &dwRead) == NO_ERROR) {
 		if (dwRead) {
 			// check for errors; will OS/2 clear the error on reading its data?
diff -Nur dosbox-0.74/src/hardware/serialport/libserial.h dosbox-0.74.patch/src/hardware/serialport/libserial.h
--- dosbox-0.74/src/hardware/serialport/libserial.h	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/hardware/serialport/libserial.h	2016-12-11 18:35:15.538284005 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: libserial.h,v 1.2 2009-09-26 09:15:19 h-a-l-9000 Exp $ */
 
 typedef struct _COMPORT *COMPORT;
 
diff -Nur dosbox-0.74/src/hardware/serialport/Makefile.in dosbox-0.74.patch/src/hardware/serialport/Makefile.in
--- dosbox-0.74/src/hardware/serialport/Makefile.in	2010-05-12 11:57:44.000000000 +0200
+++ dosbox-0.74.patch/src/hardware/serialport/Makefile.in	1970-01-01 01:00:00.000000000 +0100
@@ -1,456 +0,0 @@
-# Makefile.in generated by automake 1.11.1 from Makefile.am.
-# @configure_input@
-
-# Copyright (C) 1994, 1995, 1996, 1997, 1998, 1999, 2000, 2001, 2002,
-# 2003, 2004, 2005, 2006, 2007, 2008, 2009  Free Software Foundation,
-# Inc.
-# This Makefile.in is free software; the Free Software Foundation
-# gives unlimited permission to copy and/or distribute it,
-# with or without modifications, as long as this notice is preserved.
-
-# This program is distributed in the hope that it will be useful,
-# but WITHOUT ANY WARRANTY, to the extent permitted by law; without
-# even the implied warranty of MERCHANTABILITY or FITNESS FOR A
-# PARTICULAR PURPOSE.
-
-@SET_MAKE@
-
-VPATH = @srcdir@
-pkgdatadir = $(datadir)/@PACKAGE@
-pkgincludedir = $(includedir)/@PACKAGE@
-pkglibdir = $(libdir)/@PACKAGE@
-pkglibexecdir = $(libexecdir)/@PACKAGE@
-am__cd = CDPATH="$${ZSH_VERSION+.}$(PATH_SEPARATOR)" && cd
-install_sh_DATA = $(install_sh) -c -m 644
-install_sh_PROGRAM = $(install_sh) -c
-install_sh_SCRIPT = $(install_sh) -c
-INSTALL_HEADER = $(INSTALL_DATA)
-transform = $(program_transform_name)
-NORMAL_INSTALL = :
-PRE_INSTALL = :
-POST_INSTALL = :
-NORMAL_UNINSTALL = :
-PRE_UNINSTALL = :
-POST_UNINSTALL = :
-build_triplet = @build@
-host_triplet = @host@
-subdir = src/hardware/serialport
-DIST_COMMON = $(srcdir)/Makefile.am $(srcdir)/Makefile.in
-ACLOCAL_M4 = $(top_srcdir)/aclocal.m4
-am__aclocal_m4_deps = $(top_srcdir)/acinclude.m4 \
-	$(top_srcdir)/configure.in
-am__configure_deps = $(am__aclocal_m4_deps) $(CONFIGURE_DEPENDENCIES) \
-	$(ACLOCAL_M4)
-mkinstalldirs = $(install_sh) -d
-CONFIG_HEADER = $(top_builddir)/config.h
-CONFIG_CLEAN_FILES =
-CONFIG_CLEAN_VPATH_FILES =
-LIBRARIES = $(noinst_LIBRARIES)
-AR = ar
-ARFLAGS = cru
-libserial_a_AR = $(AR) $(ARFLAGS)
-libserial_a_LIBADD =
-am_libserial_a_OBJECTS = directserial.$(OBJEXT) libserial.$(OBJEXT) \
-	serialdummy.$(OBJEXT) serialport.$(OBJEXT) softmodem.$(OBJEXT) \
-	misc_util.$(OBJEXT) nullmodem.$(OBJEXT)
-libserial_a_OBJECTS = $(am_libserial_a_OBJECTS)
-DEFAULT_INCLUDES = -I.@am__isrc@ -I$(top_builddir)
-depcomp = $(SHELL) $(top_srcdir)/depcomp
-am__depfiles_maybe = depfiles
-am__mv = mv -f
-CXXCOMPILE = $(CXX) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) \
-	$(AM_CPPFLAGS) $(CPPFLAGS) $(AM_CXXFLAGS) $(CXXFLAGS)
-CXXLD = $(CXX)
-CXXLINK = $(CXXLD) $(AM_CXXFLAGS) $(CXXFLAGS) $(AM_LDFLAGS) $(LDFLAGS) \
-	-o $@
-COMPILE = $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) \
-	$(CPPFLAGS) $(AM_CFLAGS) $(CFLAGS)
-CCLD = $(CC)
-LINK = $(CCLD) $(AM_CFLAGS) $(CFLAGS) $(AM_LDFLAGS) $(LDFLAGS) -o $@
-SOURCES = $(libserial_a_SOURCES)
-DIST_SOURCES = $(libserial_a_SOURCES)
-ETAGS = etags
-CTAGS = ctags
-DISTFILES = $(DIST_COMMON) $(DIST_SOURCES) $(TEXINFOS) $(EXTRA_DIST)
-ACLOCAL = @ACLOCAL@
-ALSA_CFLAGS = @ALSA_CFLAGS@
-ALSA_LIBS = @ALSA_LIBS@
-AMTAR = @AMTAR@
-AUTOCONF = @AUTOCONF@
-AUTOHEADER = @AUTOHEADER@
-AUTOMAKE = @AUTOMAKE@
-AWK = @AWK@
-CC = @CC@
-CCDEPMODE = @CCDEPMODE@
-CFLAGS = @CFLAGS@
-CPP = @CPP@
-CPPFLAGS = @CPPFLAGS@
-CXX = @CXX@
-CXXDEPMODE = @CXXDEPMODE@
-CXXFLAGS = @CXXFLAGS@
-CYGPATH_W = @CYGPATH_W@
-DEFS = @DEFS@
-DEPDIR = @DEPDIR@
-ECHO_C = @ECHO_C@
-ECHO_N = @ECHO_N@
-ECHO_T = @ECHO_T@
-EGREP = @EGREP@
-EXEEXT = @EXEEXT@
-GREP = @GREP@
-INSTALL = @INSTALL@
-INSTALL_DATA = @INSTALL_DATA@
-INSTALL_PROGRAM = @INSTALL_PROGRAM@
-INSTALL_SCRIPT = @INSTALL_SCRIPT@
-INSTALL_STRIP_PROGRAM = @INSTALL_STRIP_PROGRAM@
-LDFLAGS = @LDFLAGS@
-LIBOBJS = @LIBOBJS@
-LIBS = @LIBS@
-LTLIBOBJS = @LTLIBOBJS@
-MAKEINFO = @MAKEINFO@
-MKDIR_P = @MKDIR_P@
-OBJEXT = @OBJEXT@
-PACKAGE = @PACKAGE@
-PACKAGE_BUGREPORT = @PACKAGE_BUGREPORT@
-PACKAGE_NAME = @PACKAGE_NAME@
-PACKAGE_STRING = @PACKAGE_STRING@
-PACKAGE_TARNAME = @PACKAGE_TARNAME@
-PACKAGE_URL = @PACKAGE_URL@
-PACKAGE_VERSION = @PACKAGE_VERSION@
-PATH_SEPARATOR = @PATH_SEPARATOR@
-RANLIB = @RANLIB@
-SDL_CFLAGS = @SDL_CFLAGS@
-SDL_CONFIG = @SDL_CONFIG@
-SDL_LIBS = @SDL_LIBS@
-SET_MAKE = @SET_MAKE@
-SHELL = @SHELL@
-STRIP = @STRIP@
-VERSION = @VERSION@
-WINDRES = @WINDRES@
-abs_builddir = @abs_builddir@
-abs_srcdir = @abs_srcdir@
-abs_top_builddir = @abs_top_builddir@
-abs_top_srcdir = @abs_top_srcdir@
-ac_ct_CC = @ac_ct_CC@
-ac_ct_CXX = @ac_ct_CXX@
-am__include = @am__include@
-am__leading_dot = @am__leading_dot@
-am__quote = @am__quote@
-am__tar = @am__tar@
-am__untar = @am__untar@
-bindir = @bindir@
-build = @build@
-build_alias = @build_alias@
-build_cpu = @build_cpu@
-build_os = @build_os@
-build_vendor = @build_vendor@
-builddir = @builddir@
-datadir = @datadir@
-datarootdir = @datarootdir@
-docdir = @docdir@
-dvidir = @dvidir@
-exec_prefix = @exec_prefix@
-host = @host@
-host_alias = @host_alias@
-host_cpu = @host_cpu@
-host_os = @host_os@
-host_vendor = @host_vendor@
-htmldir = @htmldir@
-includedir = @includedir@
-infodir = @infodir@
-install_sh = @install_sh@
-libdir = @libdir@
-libexecdir = @libexecdir@
-localedir = @localedir@
-localstatedir = @localstatedir@
-mandir = @mandir@
-mkdir_p = @mkdir_p@
-oldincludedir = @oldincludedir@
-pdfdir = @pdfdir@
-prefix = @prefix@
-program_transform_name = @program_transform_name@
-psdir = @psdir@
-sbindir = @sbindir@
-sharedstatedir = @sharedstatedir@
-srcdir = @srcdir@
-sysconfdir = @sysconfdir@
-target_alias = @target_alias@
-top_build_prefix = @top_build_prefix@
-top_builddir = @top_builddir@
-top_srcdir = @top_srcdir@
-AM_CPPFLAGS = -I$(top_srcdir)/include
-noinst_LIBRARIES = libserial.a
-libserial_a_SOURCES = directserial.cpp directserial.h \
-						libserial.cpp libserial.h \
-						serialdummy.cpp serialdummy.h serialport.cpp \
-						softmodem.cpp softmodem.h misc_util.cpp misc_util.h \
-						nullmodem.cpp nullmodem.h
-
-all: all-am
-
-.SUFFIXES:
-.SUFFIXES: .cpp .o .obj
-$(srcdir)/Makefile.in:  $(srcdir)/Makefile.am  $(am__configure_deps)
-	@for dep in $?; do \
-	  case '$(am__configure_deps)' in \
-	    *$$dep*) \
-	      ( cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh ) \
-	        && { if test -f $@; then exit 0; else break; fi; }; \
-	      exit 1;; \
-	  esac; \
-	done; \
-	echo ' cd $(top_srcdir) && $(AUTOMAKE) --gnu src/hardware/serialport/Makefile'; \
-	$(am__cd) $(top_srcdir) && \
-	  $(AUTOMAKE) --gnu src/hardware/serialport/Makefile
-.PRECIOUS: Makefile
-Makefile: $(srcdir)/Makefile.in $(top_builddir)/config.status
-	@case '$?' in \
-	  *config.status*) \
-	    cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh;; \
-	  *) \
-	    echo ' cd $(top_builddir) && $(SHELL) ./config.status $(subdir)/$@ $(am__depfiles_maybe)'; \
-	    cd $(top_builddir) && $(SHELL) ./config.status $(subdir)/$@ $(am__depfiles_maybe);; \
-	esac;
-
-$(top_builddir)/config.status: $(top_srcdir)/configure $(CONFIG_STATUS_DEPENDENCIES)
-	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
-
-$(top_srcdir)/configure:  $(am__configure_deps)
-	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
-$(ACLOCAL_M4):  $(am__aclocal_m4_deps)
-	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
-$(am__aclocal_m4_deps):
-
-clean-noinstLIBRARIES:
-	-test -z "$(noinst_LIBRARIES)" || rm -f $(noinst_LIBRARIES)
-libserial.a: $(libserial_a_OBJECTS) $(libserial_a_DEPENDENCIES) 
-	-rm -f libserial.a
-	$(libserial_a_AR) libserial.a $(libserial_a_OBJECTS) $(libserial_a_LIBADD)
-	$(RANLIB) libserial.a
-
-mostlyclean-compile:
-	-rm -f *.$(OBJEXT)
-
-distclean-compile:
-	-rm -f *.tab.c
-
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/directserial.Po@am__quote@
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/libserial.Po@am__quote@
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/misc_util.Po@am__quote@
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/nullmodem.Po@am__quote@
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/serialdummy.Po@am__quote@
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/serialport.Po@am__quote@
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/softmodem.Po@am__quote@
-
-.cpp.o:
-@am__fastdepCXX_TRUE@	$(CXXCOMPILE) -MT $@ -MD -MP -MF $(DEPDIR)/$*.Tpo -c -o $@ $<
-@am__fastdepCXX_TRUE@	$(am__mv) $(DEPDIR)/$*.Tpo $(DEPDIR)/$*.Po
-@AMDEP_TRUE@@am__fastdepCXX_FALSE@	source='$<' object='$@' libtool=no @AMDEPBACKSLASH@
-@AMDEP_TRUE@@am__fastdepCXX_FALSE@	DEPDIR=$(DEPDIR) $(CXXDEPMODE) $(depcomp) @AMDEPBACKSLASH@
-@am__fastdepCXX_FALSE@	$(CXXCOMPILE) -c -o $@ $<
-
-.cpp.obj:
-@am__fastdepCXX_TRUE@	$(CXXCOMPILE) -MT $@ -MD -MP -MF $(DEPDIR)/$*.Tpo -c -o $@ `$(CYGPATH_W) '$<'`
-@am__fastdepCXX_TRUE@	$(am__mv) $(DEPDIR)/$*.Tpo $(DEPDIR)/$*.Po
-@AMDEP_TRUE@@am__fastdepCXX_FALSE@	source='$<' object='$@' libtool=no @AMDEPBACKSLASH@
-@AMDEP_TRUE@@am__fastdepCXX_FALSE@	DEPDIR=$(DEPDIR) $(CXXDEPMODE) $(depcomp) @AMDEPBACKSLASH@
-@am__fastdepCXX_FALSE@	$(CXXCOMPILE) -c -o $@ `$(CYGPATH_W) '$<'`
-
-ID: $(HEADERS) $(SOURCES) $(LISP) $(TAGS_FILES)
-	list='$(SOURCES) $(HEADERS) $(LISP) $(TAGS_FILES)'; \
-	unique=`for i in $$list; do \
-	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
-	  done | \
-	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
-	      END { if (nonempty) { for (i in files) print i; }; }'`; \
-	mkid -fID $$unique
-tags: TAGS
-
-TAGS:  $(HEADERS) $(SOURCES)  $(TAGS_DEPENDENCIES) \
-		$(TAGS_FILES) $(LISP)
-	set x; \
-	here=`pwd`; \
-	list='$(SOURCES) $(HEADERS)  $(LISP) $(TAGS_FILES)'; \
-	unique=`for i in $$list; do \
-	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
-	  done | \
-	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
-	      END { if (nonempty) { for (i in files) print i; }; }'`; \
-	shift; \
-	if test -z "$(ETAGS_ARGS)$$*$$unique"; then :; else \
-	  test -n "$$unique" || unique=$$empty_fix; \
-	  if test $$# -gt 0; then \
-	    $(ETAGS) $(ETAGSFLAGS) $(AM_ETAGSFLAGS) $(ETAGS_ARGS) \
-	      "$$@" $$unique; \
-	  else \
-	    $(ETAGS) $(ETAGSFLAGS) $(AM_ETAGSFLAGS) $(ETAGS_ARGS) \
-	      $$unique; \
-	  fi; \
-	fi
-ctags: CTAGS
-CTAGS:  $(HEADERS) $(SOURCES)  $(TAGS_DEPENDENCIES) \
-		$(TAGS_FILES) $(LISP)
-	list='$(SOURCES) $(HEADERS)  $(LISP) $(TAGS_FILES)'; \
-	unique=`for i in $$list; do \
-	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
-	  done | \
-	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
-	      END { if (nonempty) { for (i in files) print i; }; }'`; \
-	test -z "$(CTAGS_ARGS)$$unique" \
-	  || $(CTAGS) $(CTAGSFLAGS) $(AM_CTAGSFLAGS) $(CTAGS_ARGS) \
-	     $$unique
-
-GTAGS:
-	here=`$(am__cd) $(top_builddir) && pwd` \
-	  && $(am__cd) $(top_srcdir) \
-	  && gtags -i $(GTAGS_ARGS) "$$here"
-
-distclean-tags:
-	-rm -f TAGS ID GTAGS GRTAGS GSYMS GPATH tags
-
-distdir: $(DISTFILES)
-	@srcdirstrip=`echo "$(srcdir)" | sed 's/[].[^$$\\*]/\\\\&/g'`; \
-	topsrcdirstrip=`echo "$(top_srcdir)" | sed 's/[].[^$$\\*]/\\\\&/g'`; \
-	list='$(DISTFILES)'; \
-	  dist_files=`for file in $$list; do echo $$file; done | \
-	  sed -e "s|^$$srcdirstrip/||;t" \
-	      -e "s|^$$topsrcdirstrip/|$(top_builddir)/|;t"`; \
-	case $$dist_files in \
-	  */*) $(MKDIR_P) `echo "$$dist_files" | \
-			   sed '/\//!d;s|^|$(distdir)/|;s,/[^/]*$$,,' | \
-			   sort -u` ;; \
-	esac; \
-	for file in $$dist_files; do \
-	  if test -f $$file || test -d $$file; then d=.; else d=$(srcdir); fi; \
-	  if test -d $$d/$$file; then \
-	    dir=`echo "/$$file" | sed -e 's,/[^/]*$$,,'`; \
-	    if test -d "$(distdir)/$$file"; then \
-	      find "$(distdir)/$$file" -type d ! -perm -700 -exec chmod u+rwx {} \;; \
-	    fi; \
-	    if test -d $(srcdir)/$$file && test $$d != $(srcdir); then \
-	      cp -fpR $(srcdir)/$$file "$(distdir)$$dir" || exit 1; \
-	      find "$(distdir)/$$file" -type d ! -perm -700 -exec chmod u+rwx {} \;; \
-	    fi; \
-	    cp -fpR $$d/$$file "$(distdir)$$dir" || exit 1; \
-	  else \
-	    test -f "$(distdir)/$$file" \
-	    || cp -p $$d/$$file "$(distdir)/$$file" \
-	    || exit 1; \
-	  fi; \
-	done
-check-am: all-am
-check: check-am
-all-am: Makefile $(LIBRARIES)
-installdirs:
-install: install-am
-install-exec: install-exec-am
-install-data: install-data-am
-uninstall: uninstall-am
-
-install-am: all-am
-	@$(MAKE) $(AM_MAKEFLAGS) install-exec-am install-data-am
-
-installcheck: installcheck-am
-install-strip:
-	$(MAKE) $(AM_MAKEFLAGS) INSTALL_PROGRAM="$(INSTALL_STRIP_PROGRAM)" \
-	  install_sh_PROGRAM="$(INSTALL_STRIP_PROGRAM)" INSTALL_STRIP_FLAG=-s \
-	  `test -z '$(STRIP)' || \
-	    echo "INSTALL_PROGRAM_ENV=STRIPPROG='$(STRIP)'"` install
-mostlyclean-generic:
-
-clean-generic:
-
-distclean-generic:
-	-test -z "$(CONFIG_CLEAN_FILES)" || rm -f $(CONFIG_CLEAN_FILES)
-	-test . = "$(srcdir)" || test -z "$(CONFIG_CLEAN_VPATH_FILES)" || rm -f $(CONFIG_CLEAN_VPATH_FILES)
-
-maintainer-clean-generic:
-	@echo "This command is intended for maintainers to use"
-	@echo "it deletes files that may require special tools to rebuild."
-clean: clean-am
-
-clean-am: clean-generic clean-noinstLIBRARIES mostlyclean-am
-
-distclean: distclean-am
-	-rm -rf ./$(DEPDIR)
-	-rm -f Makefile
-distclean-am: clean-am distclean-compile distclean-generic \
-	distclean-tags
-
-dvi: dvi-am
-
-dvi-am:
-
-html: html-am
-
-html-am:
-
-info: info-am
-
-info-am:
-
-install-data-am:
-
-install-dvi: install-dvi-am
-
-install-dvi-am:
-
-install-exec-am:
-
-install-html: install-html-am
-
-install-html-am:
-
-install-info: install-info-am
-
-install-info-am:
-
-install-man:
-
-install-pdf: install-pdf-am
-
-install-pdf-am:
-
-install-ps: install-ps-am
-
-install-ps-am:
-
-installcheck-am:
-
-maintainer-clean: maintainer-clean-am
-	-rm -rf ./$(DEPDIR)
-	-rm -f Makefile
-maintainer-clean-am: distclean-am maintainer-clean-generic
-
-mostlyclean: mostlyclean-am
-
-mostlyclean-am: mostlyclean-compile mostlyclean-generic
-
-pdf: pdf-am
-
-pdf-am:
-
-ps: ps-am
-
-ps-am:
-
-uninstall-am:
-
-.MAKE: install-am install-strip
-
-.PHONY: CTAGS GTAGS all all-am check check-am clean clean-generic \
-	clean-noinstLIBRARIES ctags distclean distclean-compile \
-	distclean-generic distclean-tags distdir dvi dvi-am html \
-	html-am info info-am install install-am install-data \
-	install-data-am install-dvi install-dvi-am install-exec \
-	install-exec-am install-html install-html-am install-info \
-	install-info-am install-man install-pdf install-pdf-am \
-	install-ps install-ps-am install-strip installcheck \
-	installcheck-am installdirs maintainer-clean \
-	maintainer-clean-generic mostlyclean mostlyclean-compile \
-	mostlyclean-generic pdf pdf-am ps ps-am tags uninstall \
-	uninstall-am
-
-
-# Tell versions [3.59,3.63) of GNU make to not export all variables.
-# Otherwise a system limit (for SysV at least) may be exceeded.
-.NOEXPORT:
diff -Nur dosbox-0.74/src/hardware/serialport/misc_util.cpp dosbox-0.74.patch/src/hardware/serialport/misc_util.cpp
--- dosbox-0.74/src/hardware/serialport/misc_util.cpp	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/hardware/serialport/misc_util.cpp	2016-12-11 18:35:15.542284005 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
diff -Nur dosbox-0.74/src/hardware/serialport/misc_util.h dosbox-0.74.patch/src/hardware/serialport/misc_util.h
--- dosbox-0.74/src/hardware/serialport/misc_util.h	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/hardware/serialport/misc_util.h	2016-12-11 18:35:15.542284005 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: misc_util.h,v 1.5 2009-09-25 23:40:47 h-a-l-9000 Exp $ */
 
 #ifndef SDLNETWRAPPER_H
 #define SDLNETWRAPPER_H
diff -Nur dosbox-0.74/src/hardware/serialport/nullmodem.cpp dosbox-0.74.patch/src/hardware/serialport/nullmodem.cpp
--- dosbox-0.74/src/hardware/serialport/nullmodem.cpp	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/hardware/serialport/nullmodem.cpp	2016-12-11 18:35:15.542284005 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: nullmodem.cpp,v 1.8 2009-09-25 23:40:47 h-a-l-9000 Exp $ */
 
 #include "dosbox.h"
 
@@ -53,137 +52,108 @@
 	// 1) when it is client connect to the server not immediately but
 	//    as soon as a modem-aware application is started (DTR is switched on).
 	// 2) only receive data when DTR is on.
-	if(getBituSubstring("usedtr:", &bool_temp, cmd)) {
-		if(bool_temp==1) {
+	if (getBituSubstring("usedtr:", &bool_temp, cmd)) {
+		if (bool_temp==1) {
 			dtrrespect=true;
 			transparent=true;
+			DTR_delta=false; // connect immediately when DTR is already 1
 		}
 	}
 	// transparent: don't add additional handshake control.
-	if(getBituSubstring("transparent:", &bool_temp, cmd)) {
-		if(bool_temp==1) transparent=true;
+	if (getBituSubstring("transparent:", &bool_temp, cmd)) {
+		if (bool_temp==1) transparent=true;
 		else transparent=false;
 	}
 	// telnet: interpret telnet commands.
-	if(getBituSubstring("telnet:", &bool_temp, cmd)) {
-		if(bool_temp==1) {
+	if (getBituSubstring("telnet:", &bool_temp, cmd)) {
+		if (bool_temp==1) {
 			transparent=true;
 			telnet=true;
 		}
 	}
 	// rxdelay: How many milliseconds to wait before causing an
 	// overflow when the application is unresponsive.
-	if(getBituSubstring("rxdelay:", &rx_retry_max, cmd)) {
-		if(!(rx_retry_max<=10000)) {
+	if (getBituSubstring("rxdelay:", &rx_retry_max, cmd)) {
+		if (!(rx_retry_max<=10000)) {
 			rx_retry_max=50;
 		}
 	}
 	// txdelay: How many milliseconds to wait before sending data.
 	// This reduces network overhead quite a lot.
-	if(getBituSubstring("txdelay:", &tx_gather, cmd)) {
-		if(!(tx_gather<=500)) {
+	if (getBituSubstring("txdelay:", &tx_gather, cmd)) {
+		if (!(tx_gather<=500)) {
 			tx_gather=12;
 		}
 	}
 	// port is for both server and client
-	if(getBituSubstring("port:", &temptcpport, cmd)) {
-		if(!(temptcpport>0&&temptcpport<65536)) {
+	if (getBituSubstring("port:", &temptcpport, cmd)) {
+		if (!(temptcpport>0&&temptcpport<65536)) {
 			temptcpport=23;
 		}
 	}
-	// socket inheritance
-	if(getBituSubstring("inhsocket:", &bool_temp, cmd)) {
+	// socket inheritance (client-alike)
+	if (getBituSubstring("inhsocket:", &bool_temp, cmd)) {
 #ifdef NATIVESOCKETS
-		if(Netwrapper_GetCapabilities()&NETWRAPPER_TCP_NATIVESOCKET) {
-			if(bool_temp==1) {
+		if (Netwrapper_GetCapabilities()&NETWRAPPER_TCP_NATIVESOCKET) {
+			if (bool_temp==1) {
 				int sock;
 				if (control->cmdline->FindInt("-socket",sock,true)) {
 					dtrrespect=false;
 					transparent=true;
-					// custom connect
-					Bit8u peernamebuf[16];
-					LOG_MSG("inheritance port: %d",sock);
-					clientsocket = new TCPClientSocket(sock);
-					if(!clientsocket->isopen) {
-						LOG_MSG("Serial%d: Connection failed.",COMNUMBER);
-#if SERIAL_DEBUG
-						log_ser(dbg_aux,"Nullmodem: Connection failed.");
-#endif
-						delete clientsocket;
-						clientsocket=0;
+					LOG_MSG("Inheritance socket handle: %d",sock);
+					if (!ClientConnect(new TCPClientSocket(sock)))
 						return;
-					}
-					clientsocket->SetSendBufferSize(256);
-					clientsocket->GetRemoteAddressString(peernamebuf);
-					// transmit the line status
-					if(!transparent) setRTSDTR(getRTS(), getDTR());
-
-					LOG_MSG("Serial%d: Connected to %s",COMNUMBER,peernamebuf);
-#if SERIAL_DEBUG
-					log_ser(dbg_aux,"Nullmodem: Connected to %s",peernamebuf);
-#endif
-					setEvent(SERIAL_POLLING_EVENT, 1);
-
-					CSerial::Init_Registers ();
-					InstallationSuccessful = true;
-
-					setCTS(true);
-					setDSR(true);
-					setRI (false);
-					setCD (true);
-					return;
 				} else {
-					LOG_MSG("Serial%d: -socket start parameter missing.",COMNUMBER);
+					LOG_MSG("Serial%d: -socket parameter missing.",COMNUMBER);
 					return;
 				}
 			}
 		} else {
-#endif
 			LOG_MSG("Serial%d: socket inheritance not supported on this platform.",
 				COMNUMBER);
 			return;
 		}
-	}
-	std::string tmpstring;
-	if(cmd->FindStringBegin("server:",tmpstring,false)) {
-		// we are a client
-		const char* hostnamechar=tmpstring.c_str();
-		size_t hostlen=strlen(hostnamechar)+1;
-		if(hostlen>sizeof(hostnamebuffer)) {
-			hostlen=sizeof(hostnamebuffer);
-			hostnamebuffer[sizeof(hostnamebuffer)-1]=0;
-		}
-		memcpy(hostnamebuffer,hostnamechar,hostlen);
-		clientport=(Bit16u)temptcpport;
-		if(dtrrespect) {
-			// we connect as soon as DTR is switched on
-			setEvent(SERIAL_NULLMODEM_DTR_EVENT, 50);
-			LOG_MSG("Serial%d: Waiting for DTR...",COMNUMBER);
-		} else ClientConnect();
+#else
+		LOG_MSG("Serial%d: socket inheritance not available.", COMNUMBER);
+#endif
 	} else {
-		// we are a server
-		serverport = (Bit16u)temptcpport;
-		serversocket = new TCPServerSocket(serverport);
-		if(!serversocket->isopen) return;
-		LOG_MSG("Serial%d: Nullmodem server waiting for connection on port %d...",
-			COMNUMBER,serverport);
-		setEvent(SERIAL_SERVER_POLLING_EVENT, 50);
+		// normal server/client
+		std::string tmpstring;
+		if (cmd->FindStringBegin("server:",tmpstring,false)) {
+			// we are a client
+			const char* hostnamechar=tmpstring.c_str();
+			size_t hostlen=strlen(hostnamechar)+1;
+			if (hostlen>sizeof(hostnamebuffer)) {
+				hostlen=sizeof(hostnamebuffer);
+				hostnamebuffer[sizeof(hostnamebuffer)-1]=0;
+			}
+			memcpy(hostnamebuffer,hostnamechar,hostlen);
+			clientport=(Bit16u)temptcpport;
+			if (dtrrespect) {
+				// we connect as soon as DTR is switched on
+				setEvent(SERIAL_NULLMODEM_DTR_EVENT, 50);
+				LOG_MSG("Serial%d: Waiting for DTR...",COMNUMBER);
+			} else if (!ClientConnect(
+				new TCPClientSocket((char*)hostnamebuffer,(Bit16u)clientport)))
+				return;
+		} else {
+			// we are a server
+			serverport = (Bit16u)temptcpport;
+			if (!ServerListen()) return;
+		}
 	}
-
-	// ....
-
-	CSerial::Init_Registers ();
+	CSerial::Init_Registers();
 	InstallationSuccessful = true;
 
 	setCTS(dtrrespect||transparent);
 	setDSR(dtrrespect||transparent);
-	setRI (false);
-	setCD (dtrrespect);
+	setRI(false);
+	setCD(clientsocket > 0); // CD on if connection established
 }
 
-CNullModem::~CNullModem () {
-	if(serversocket) delete serversocket;
-	if(clientsocket) delete clientsocket;
+CNullModem::~CNullModem() {
+	if (serversocket) delete serversocket;
+	if (clientsocket) delete clientsocket;
 	// remove events
 	for(Bit16u i = SERIAL_BASE_EVENT_COUNT+1;
 			i <= SERIAL_NULLMODEM_EVENT_COUNT; i++) {
@@ -192,9 +162,8 @@
 }
 
 void CNullModem::WriteChar(Bit8u data) {
-	
-	if(clientsocket)clientsocket->SendByteBuffered(data);
-	if(!tx_block) {
+	if (clientsocket)clientsocket->SendByteBuffered(data);
+	if (!tx_block) {
 		//LOG_MSG("setevreduct");
 		setEvent(SERIAL_TX_REDUCTION, (float)tx_gather);
 		tx_block=true;
@@ -202,37 +171,75 @@
 }
 
 Bits CNullModem::readChar() {
-	
 	Bits rxchar = clientsocket->GetcharNonBlock();
-	if(telnet && rxchar>=0) return TelnetEmulation((Bit8u)rxchar);
-	else if(rxchar==0xff && !transparent) {// escape char
+	if (telnet && rxchar>=0) return TelnetEmulation((Bit8u)rxchar);
+	else if (rxchar==0xff && !transparent) {// escape char
 		// get the next char
 		Bits rxchar = clientsocket->GetcharNonBlock();
-		if(rxchar==0xff) return rxchar; // 0xff 0xff -> 0xff was meant
+		if (rxchar==0xff) return rxchar; // 0xff 0xff -> 0xff was meant
 		rxchar&0x1? setCTS(true) : setCTS(false);
 		rxchar&0x2? setDSR(true) : setDSR(false);
-		if(rxchar&0x4) receiveByteEx(0x0,0x10);
+		if (rxchar&0x4) receiveByteEx(0x0,0x10);
 		return -1;	// no "payload" received
 	} else return rxchar;
 }
 
-void CNullModem::ClientConnect(){
+bool CNullModem::ClientConnect(TCPClientSocket* newsocket) {
 	Bit8u peernamebuf[16];
-	clientsocket = new TCPClientSocket((char*)hostnamebuffer,
-										(Bit16u)clientport); 
-	if(!clientsocket->isopen) {
-		LOG_MSG("Serial%d: Connection failed.",idnumber+1);
+	clientsocket = newsocket;
+ 
+	if (!clientsocket->isopen) {
+		LOG_MSG("Serial%d: Connection failed.",COMNUMBER);
 		delete clientsocket;
 		clientsocket=0;
-		return;
+		setCD(false);
+		return false;
 	}
 	clientsocket->SetSendBufferSize(256);
 	clientsocket->GetRemoteAddressString(peernamebuf);
 	// transmit the line status
-	if(!transparent) setRTSDTR(getRTS(), getDTR());
+	if (!transparent) setRTSDTR(getRTS(), getDTR());
+	rx_state=N_RX_IDLE;
+	LOG_MSG("Serial%d: Connected to %s",COMNUMBER,peernamebuf);
+	setEvent(SERIAL_POLLING_EVENT, 1);
+	setCD(true);
+	return true;
+}
+
+bool CNullModem::ServerListen() {
+	// Start the server listen port.
+	serversocket = new TCPServerSocket(serverport);
+	if (!serversocket->isopen) return false;
+	LOG_MSG("Serial%d: Nullmodem server waiting for connection on port %d...",
+		COMNUMBER,serverport);
+	setEvent(SERIAL_SERVER_POLLING_EVENT, 50);
+	setCD(false);
+	return true;
+}
+
+bool CNullModem::ServerConnect() {
+	// check if a connection is available.
+	clientsocket=serversocket->Accept();
+	if (!clientsocket) return false;
+	
+	Bit8u peeripbuf[16];
+	clientsocket->GetRemoteAddressString(peeripbuf);
+	LOG_MSG("Serial%d: A client (%s) has connected.",COMNUMBER,peeripbuf);
+#if SERIAL_DEBUG
+	log_ser(dbg_aux,"Nullmodem: A client (%s) has connected.", peeripbuf);
+#endif
+	clientsocket->SetSendBufferSize(256);
 	rx_state=N_RX_IDLE;
-	LOG_MSG("Serial%d: Connected to %s",idnumber+1,peernamebuf);
 	setEvent(SERIAL_POLLING_EVENT, 1);
+	
+	// we don't accept further connections
+	delete serversocket;
+	serversocket=0;
+
+	// transmit the line status
+	setRTSDTR(getRTS(), getDTR());
+	if (transparent) setCD(true);
+	return true;
 }
 
 void CNullModem::Disconnect() {
@@ -244,11 +251,16 @@
 	clientsocket=0;
 	setDSR(false);
 	setCTS(false);
-	if(serverport) {
+	setCD(false);
+	
+	if (serverport) {
 		serversocket = new TCPServerSocket(serverport);
-		if(serversocket->isopen) 
+		if (serversocket->isopen) 
 			setEvent(SERIAL_SERVER_POLLING_EVENT, 50);
 		else delete serversocket;
+	} else if (dtrrespect) {
+		setEvent(SERIAL_NULLMODEM_DTR_EVENT,50);
+		DTR_delta = getDTR(); // try to reconnect the next time DTR is set
 	}
 }
 
@@ -263,8 +275,8 @@
 			updateMSR();
 			switch(rx_state) {
 				case N_RX_IDLE:
-					if(CanReceiveByte()) {
-						if(doReceive()) {
+					if (CanReceiveByte()) {
+						if (doReceive()) {
 							// a byte was received
 							rx_state=N_RX_WAIT;
 							setEvent(SERIAL_RX_EVENT, bytetime*0.9f);
@@ -280,13 +292,13 @@
 					break;
 				case N_RX_BLOCKED:
                     // one timeout tick
-					if(!CanReceiveByte()) {
+					if (!CanReceiveByte()) {
 						rx_retry++;
-						if(rx_retry>=rx_retry_max) {
+						if (rx_retry>=rx_retry_max) {
 							// it has timed out:
 							rx_retry=0;
 							removeEvent(SERIAL_RX_EVENT);
-							if(doReceive()) {
+							if (doReceive()) {
 								// read away everything
 								while(doReceive());
 								rx_state=N_RX_WAIT;
@@ -303,7 +315,7 @@
 						// good: we can receive again
 						removeEvent(SERIAL_RX_EVENT);
 						rx_retry=0;
-						if(doReceive()) {
+						if (doReceive()) {
 							rx_state=N_RX_FASTWAIT;
 							setEvent(SERIAL_RX_EVENT, bytetime*0.65f);
 						} else {
@@ -328,11 +340,11 @@
 				case N_RX_BLOCKED: // try to receive
 				case N_RX_WAIT:
 				case N_RX_FASTWAIT:
-					if(CanReceiveByte()) {
+					if (CanReceiveByte()) {
 						// just works or unblocked
-						if(doReceive()) {
+						if (doReceive()) {
 							rx_retry=0; // not waiting anymore
-							if(rx_state==N_RX_WAIT) setEvent(SERIAL_RX_EVENT, bytetime*0.9f);
+							if (rx_state==N_RX_WAIT) setEvent(SERIAL_RX_EVENT, bytetime*0.9f);
 							else {
 								// maybe unblocked
 								rx_state=N_RX_FASTWAIT;
@@ -346,7 +358,7 @@
 					} else {
 						// blocking now or still blocked
 #if SERIAL_DEBUG
-						if(rx_state==N_RX_BLOCKED)
+						if (rx_state==N_RX_BLOCKED)
 							log_ser(dbg_aux,"Nullmodem: rx still blocked (retry=%d)",rx_retry);
 						else log_ser(dbg_aux,"Nullmodem: block on continued rx (retry=%d).",rx_retry);
 #endif
@@ -360,8 +372,8 @@
 		}
 		case SERIAL_TX_EVENT: {
 			// Maybe echo cirquit works a bit better this way
-			if(rx_state==N_RX_IDLE && CanReceiveByte() && clientsocket) {
-				if(doReceive()) {
+			if (rx_state==N_RX_IDLE && CanReceiveByte() && clientsocket) {
+				if (doReceive()) {
 					// a byte was received
 					rx_state=N_RX_WAIT;
 					setEvent(SERIAL_RX_EVENT, bytetime*0.9f);
@@ -379,25 +391,7 @@
 		case SERIAL_SERVER_POLLING_EVENT: {
 			// As long as nothing is connected to our server poll the
 			// connection.
-			clientsocket=serversocket->Accept();
-			if(clientsocket) {
-				Bit8u peeripbuf[16];
-				clientsocket->GetRemoteAddressString(peeripbuf);
-				LOG_MSG("Serial%d: A client (%s) has connected.",COMNUMBER,peeripbuf);
-#if SERIAL_DEBUG
-				log_ser(dbg_aux,"Nullmodem: A client (%s) has connected.", peeripbuf);
-#endif// new socket found...
-				clientsocket->SetSendBufferSize(256);
-				rx_state=N_RX_IDLE;
-				setEvent(SERIAL_POLLING_EVENT, 1);
-				
-				// we don't accept further connections
-				delete serversocket;
-				serversocket=0;
-
-				// transmit the line status
-				setRTSDTR(getRTS(), getDTR());
-			} else {
+			if (!ServerConnect()) {
 				// continue looking
 				setEvent(SERIAL_SERVER_POLLING_EVENT, 50);
 			}
@@ -405,13 +399,19 @@
 		}
 		case SERIAL_TX_REDUCTION: {
 			// Flush the data in the transmitting buffer.
-			if(clientsocket) clientsocket->FlushBuffer();
+			if (clientsocket) clientsocket->FlushBuffer();
 			tx_block=false;
 			break;						  
 		}
 		case SERIAL_NULLMODEM_DTR_EVENT: {
-			if(getDTR()) ClientConnect();
-			else setEvent(SERIAL_NULLMODEM_DTR_EVENT,50);
+			if ((!DTR_delta) && getDTR()) {
+				// DTR went positive. Try to connect.
+				if (ClientConnect(new TCPClientSocket((char*)hostnamebuffer,
+								(Bit16u)clientport)))
+					break; // no more DTR wait event when connected
+			}
+			DTR_delta = getDTR();
+			setEvent(SERIAL_NULLMODEM_DTR_EVENT,50);
 			break;
 		}
 	}
@@ -431,11 +431,11 @@
 
 bool CNullModem::doReceive () {
 		Bits rxchar = readChar();
-		if(rxchar>=0) {
+		if (rxchar>=0) {
 			receiveByteEx((Bit8u)rxchar,0);
 			return true;
 		}
-		else if(rxchar==-2) {
+		else if (rxchar==-2) {
 			Disconnect();
 		}
 		return false;
@@ -443,7 +443,7 @@
  
 void CNullModem::transmitByte (Bit8u val, bool first) {
  	// transmit it later in THR_Event
-	if(first) setEvent(SERIAL_THR_EVENT, bytetime/8);
+	if (first) setEvent(SERIAL_THR_EVENT, bytetime/8);
 	else setEvent(SERIAL_TX_EVENT, bytetime);
 
 	// disable 0xff escaping when transparent mode is enabled
@@ -454,73 +454,73 @@
 
 Bits CNullModem::TelnetEmulation(Bit8u data) {
 	Bit8u response[3];
-	if(telClient.inIAC) {
-		if(telClient.recCommand) {
-			if((data != 0) && (data != 1) && (data != 3)) {
+	if (telClient.inIAC) {
+		if (telClient.recCommand) {
+			if ((data != 0) && (data != 1) && (data != 3)) {
 				LOG_MSG("Serial%d: Unrecognized telnet option %d",COMNUMBER, data);
-				if(telClient.command>250) {
+				if (telClient.command>250) {
 					/* Reject anything we don't recognize */
 					response[0]=0xff;
 					response[1]=252;
 					response[2]=data; /* We won't do crap! */
-					if(clientsocket) clientsocket->SendArray(response, 3);
+					if (clientsocket) clientsocket->SendArray(response, 3);
 				}
 			}
 			switch(telClient.command) {
 				case 251: /* Will */
-					if(data == 0) telClient.binary[TEL_SERVER] = true;
-					if(data == 1) telClient.echo[TEL_SERVER] = true;
-					if(data == 3) telClient.supressGA[TEL_SERVER] = true;
+					if (data == 0) telClient.binary[TEL_SERVER] = true;
+					if (data == 1) telClient.echo[TEL_SERVER] = true;
+					if (data == 3) telClient.supressGA[TEL_SERVER] = true;
 					break;
 				case 252: /* Won't */
-					if(data == 0) telClient.binary[TEL_SERVER] = false;
-					if(data == 1) telClient.echo[TEL_SERVER] = false;
-					if(data == 3) telClient.supressGA[TEL_SERVER] = false;
+					if (data == 0) telClient.binary[TEL_SERVER] = false;
+					if (data == 1) telClient.echo[TEL_SERVER] = false;
+					if (data == 3) telClient.supressGA[TEL_SERVER] = false;
 					break;
 				case 253: /* Do */
-					if(data == 0) {
+					if (data == 0) {
 						telClient.binary[TEL_CLIENT] = true;
 							response[0]=0xff;
 							response[1]=251;
 							response[2]=0; /* Will do binary transfer */
-							if(clientsocket) clientsocket->SendArray(response, 3);
+							if (clientsocket) clientsocket->SendArray(response, 3);
 					}
-					if(data == 1) {
+					if (data == 1) {
 						telClient.echo[TEL_CLIENT] = false;
 							response[0]=0xff;
 							response[1]=252;
 							response[2]=1; /* Won't echo (too lazy) */
-							if(clientsocket) clientsocket->SendArray(response, 3);
+							if (clientsocket) clientsocket->SendArray(response, 3);
 					}
-					if(data == 3) {
+					if (data == 3) {
 						telClient.supressGA[TEL_CLIENT] = true;
 							response[0]=0xff;
 							response[1]=251;
 							response[2]=3; /* Will Suppress GA */
-							if(clientsocket) clientsocket->SendArray(response, 3);
+							if (clientsocket) clientsocket->SendArray(response, 3);
 					}
 					break;
 				case 254: /* Don't */
-					if(data == 0) {
+					if (data == 0) {
 						telClient.binary[TEL_CLIENT] = false;
 						response[0]=0xff;
 						response[1]=252;
 						response[2]=0; /* Won't do binary transfer */
-						if(clientsocket) clientsocket->SendArray(response, 3);
+						if (clientsocket) clientsocket->SendArray(response, 3);
 					}
-					if(data == 1) {
+					if (data == 1) {
 						telClient.echo[TEL_CLIENT] = false;
 						response[0]=0xff;
 						response[1]=252;
 						response[2]=1; /* Won't echo (fine by me) */
-						if(clientsocket) clientsocket->SendArray(response, 3);
+						if (clientsocket) clientsocket->SendArray(response, 3);
 					}
-					if(data == 3) {
+					if (data == 3) {
 						telClient.supressGA[TEL_CLIENT] = true;
 						response[0]=0xff;
 						response[1]=251;
 						response[2]=3; /* Will Suppress GA (too lazy) */
-						if(clientsocket) clientsocket->SendArray(response, 3);
+						if (clientsocket) clientsocket->SendArray(response, 3);
 					}
 					break;
 				default:
@@ -531,7 +531,7 @@
 			telClient.recCommand = false;
 			return -1; //continue;
 		} else {
-			if(data==249) {
+			if (data==249) {
 				/* Go Ahead received */
 				telClient.inIAC = false;
 				return -1; //continue;
@@ -539,7 +539,7 @@
 			telClient.command = data;
 			telClient.recCommand = true;
 			
-			if((telClient.binary[TEL_SERVER]) && (data == 0xff)) {
+			if ((telClient.binary[TEL_SERVER]) && (data == 0xff)) {
 				/* Binary data with value of 255 */
 				telClient.inIAC = false;
 				telClient.recCommand = false;
@@ -547,7 +547,7 @@
 			}
 		}
 	} else {
-		if(data == 0xff) {
+		if (data == 0xff) {
 			telClient.inIAC = true;
 			return -1;
 		}
@@ -569,14 +569,14 @@
 /* updateModemControlLines(mcr) sets DTR and RTS.                           **/
 /*****************************************************************************/
 void CNullModem::setRTSDTR(bool xrts, bool xdtr) {
-	if(!transparent) {
+	if (!transparent) {
 		Bit8u control[2];
 		control[0]=0xff;
 		control[1]=0x0;
-		if(xrts) control[1]|=1;
-		if(xdtr) control[1]|=2;
-		if(LCR&LCR_BREAK_MASK) control[1]|=4;
-		if(clientsocket) clientsocket->SendArray(control, 2);
+		if (xrts) control[1]|=1;
+		if (xdtr) control[1]|=2;
+		if (LCR&LCR_BREAK_MASK) control[1]|=4;
+		if (clientsocket) clientsocket->SendArray(control, 2);
 	}
 }
 void CNullModem::setRTS(bool val) {
diff -Nur dosbox-0.74/src/hardware/serialport/nullmodem.h dosbox-0.74.patch/src/hardware/serialport/nullmodem.h
--- dosbox-0.74/src/hardware/serialport/nullmodem.h	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/hardware/serialport/nullmodem.h	2016-12-11 18:35:15.542284005 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: nullmodem.h,v 1.4 2009-09-25 23:40:47 h-a-l-9000 Exp $ */
 
 // include guard
 #ifndef DOSBOX_NULLMODEM_WIN32_H
@@ -36,16 +35,8 @@
 
 class CNullModem : public CSerial {
 public:
-	TCPServerSocket* serversocket;
-	TCPClientSocket* clientsocket;
-
 	CNullModem(Bitu id, CommandLine* cmd);
 	~CNullModem();
-	bool receiveblock;		// It's not a block of data it rather blocks
-	Bit16u serverport;		// we are a server if this is nonzero
-	Bit16u clientport;
-
-	Bit8u hostnamebuffer[128]; // the name passed to us by the user
 
 	void updatePortConfig(Bit16u divider, Bit8u lcr);
 	void updateMSR();
@@ -57,6 +48,16 @@
 	void setDTR(bool val);
 	void handleUpperEvent(Bit16u type);
 
+private:
+	TCPServerSocket* serversocket;
+	TCPClientSocket* clientsocket;
+
+	bool receiveblock;		// It's not a block of data it rather blocks
+	Bit16u serverport;		// we are a server if this is nonzero
+	Bit16u clientport;
+
+	Bit8u hostnamebuffer[128]; // the name passed to us by the user
+
 	Bitu rx_state;
 #define N_RX_IDLE		0
 #define N_RX_WAIT		1
@@ -65,11 +66,17 @@
 #define N_RX_DISC		4
 
 	bool doReceive();
-	void ClientConnect();
+	bool ClientConnect(TCPClientSocket* newsocket);
+	bool ServerListen();
+	bool ServerConnect();
     void Disconnect();
 	Bits readChar();
 	void WriteChar(Bit8u data);
 
+	bool DTR_delta;		// with dtrrespect, we try to establish a connection
+						// whenever DTR switches to 1. This variable is
+						// used to remember the old state.
+
 	bool tx_block;		// true while the SERIAL_TX_REDUCTION event
 						// is pending
 
diff -Nur dosbox-0.74/src/hardware/serialport/serialdummy.cpp dosbox-0.74.patch/src/hardware/serialport/serialdummy.cpp
--- dosbox-0.74/src/hardware/serialport/serialdummy.cpp	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/hardware/serialport/serialdummy.cpp	2016-12-11 18:35:15.542284005 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: serialdummy.cpp,v 1.5 2009-05-27 09:15:41 qbix79 Exp $ */
 
 #include "dosbox.h"
 
diff -Nur dosbox-0.74/src/hardware/serialport/serialdummy.h dosbox-0.74.patch/src/hardware/serialport/serialdummy.h
--- dosbox-0.74/src/hardware/serialport/serialdummy.h	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/hardware/serialport/serialdummy.h	2016-12-11 18:35:15.542284005 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: serialdummy.h,v 1.5 2009-05-27 09:15:41 qbix79 Exp $ */
 
 #ifndef INCLUDEGUARD_SERIALDUMMY_H
 #define INCLUDEGUARD_SERIALDUMMY_H
diff -Nur dosbox-0.74/src/hardware/serialport/serialport.cpp dosbox-0.74.patch/src/hardware/serialport/serialport.cpp
--- dosbox-0.74/src/hardware/serialport/serialport.cpp	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/hardware/serialport/serialport.cpp	2016-12-11 18:35:15.542284005 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: serialport.cpp,v 1.14 2009-10-01 17:25:28 h-a-l-9000 Exp $ */
 
 #include <string.h>
 #include <ctype.h>
@@ -224,7 +223,8 @@
 	else bitlen = (1000.0f/115200.0f)*(float)baud_divider;
 	bytetime=bitlen*(float)(1+5+1);		// startbit + minimum length + stopbit
 	bytetime+= bitlen*(float)(LCR&0x3); // databits
-	if(LCR&0x4) bytetime+=bitlen;		// stopbit
+	if(LCR&0x4) bytetime+=bitlen;		// 2nd stopbit
+	if(LCR&0x8) bytetime+=bitlen;		// parity
 
 #if SERIAL_DEBUG
 	const char* const dbgtext[]={"none","odd","none","even","none","mark","none","space"};
diff -Nur dosbox-0.74/src/hardware/serialport/softmodem.cpp dosbox-0.74.patch/src/hardware/serialport/softmodem.cpp
--- dosbox-0.74/src/hardware/serialport/softmodem.cpp	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/hardware/serialport/softmodem.cpp	2016-12-11 18:35:15.542284005 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: softmodem.cpp,v 1.12 2009-10-04 20:57:40 h-a-l-9000 Exp $ */
 
 #include "dosbox.h"
 
@@ -363,18 +362,23 @@
 				helper[0]=0;
 				helper--;
 			}
+
+			//Large enough scope, so the buffers are still valid when reaching Dail.
+			char buffer[128];
+			char obuffer[128];
 			if (strlen(foundstr) >= 12) {
 				// Check if supplied parameter only consists of digits
 				bool isNum = true;
-				for (Bitu i=0; i<strlen(foundstr); i++)
+				size_t fl = strlen(foundstr);
+				for (size_t i = 0; i < fl; i++)
 					if (foundstr[i] < '0' || foundstr[i] > '9') isNum = false;
 				if (isNum) {
 					// Parameter is a number with at least 12 digits => this cannot
 					// be a valid IP/name
 					// Transform by adding dots
-					char buffer[128];
-					Bitu j = 0;
-					for (Bitu i=0; i<strlen(foundstr); i++) {
+					size_t j = 0;
+					size_t foundlen = strlen(foundstr);
+					for (size_t i = 0; i < foundlen; i++) {
 						buffer[j++] = foundstr[i];
 						// Add a dot after the third, sixth and ninth number
 						if (i == 2 || i == 5 || i == 8)
@@ -386,6 +390,19 @@
 					}
 					buffer[j] = 0;
 					foundstr = buffer;
+
+					// Remove Zeros from beginning of octets
+					size_t k = 0;
+					size_t foundlen2 = strlen(foundstr);
+					for (size_t i = 0; i < foundlen2; i++) {
+						if (i == 0 && foundstr[0] == '0') continue;
+						if (i == 1 && foundstr[0] == '0' && foundstr[1] == '0') continue;
+						if (foundstr[i] == '0' && foundstr[i-1] == '.') continue;
+						if (foundstr[i] == '0' && foundstr[i-1] == '0' && foundstr[i-2] == '.') continue;
+						obuffer[k++] = foundstr[i];
+						}
+					obuffer[k] = 0;
+					foundstr = obuffer;
 				}
 			}
 			Dial(foundstr);
@@ -393,8 +410,8 @@
 		}
 		case 'I': // Some strings about firmware
 			switch (ScanNumber(scanbuf)) {
-			case 3: SendLine("DosBox Emulated Modem Firmware V1.00"); break;
-			case 4: SendLine("Modem compiled for DosBox version " VERSION); break;
+			case 3: SendLine("DOSBox Emulated Modem Firmware V1.00"); break;
+			case 4: SendLine("Modem compiled for DOSBox version " VERSION); break;
 			}
 			break;
 		case 'E': // Echo on/off
diff -Nur dosbox-0.74/src/hardware/serialport/softmodem.h dosbox-0.74.patch/src/hardware/serialport/softmodem.h
--- dosbox-0.74/src/hardware/serialport/softmodem.h	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/hardware/serialport/softmodem.h	2016-12-11 18:35:15.542284005 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: softmodem.h,v 1.12 2009-10-04 20:57:40 h-a-l-9000 Exp $ */
 
 #ifndef DOSBOX_SERIALMODEM_H
 #define DOSBOX_SERIALMODEM_H
diff -Nur dosbox-0.74/src/hardware/tandy_sound.cpp dosbox-0.74.patch/src/hardware/tandy_sound.cpp
--- dosbox-0.74/src/hardware/tandy_sound.cpp	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/hardware/tandy_sound.cpp	2016-12-11 18:35:15.542284005 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
diff -Nur dosbox-0.74/src/hardware/timer.cpp dosbox-0.74.patch/src/hardware/timer.cpp
--- dosbox-0.74/src/hardware/timer.cpp	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/hardware/timer.cpp	2016-12-11 18:35:15.542284005 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: timer.cpp,v 1.49 2009-04-10 09:53:04 c2woody Exp $ */
 
 #include <math.h>
 #include "dosbox.h"
@@ -138,8 +137,14 @@
 	p->go_read_latch=false;
 
 	//If gate2 is disabled don't update the read_latch
-	if(counter == 2 && !gate2 && p->mode !=1) return;
-
+	if (counter == 2 && !gate2 && p->mode !=1) return;
+	if (GCC_UNLIKELY(p->new_mode)) {
+		double passed_time = PIC_FullIndex() - p->start;
+		Bitu ticks_since_then = (Bitu)(passed_time / (1000.0/PIT_TICK_RATE));
+		//if (p->mode==3) ticks_since_then /= 2; // TODO figure this out on real hardware
+		p->read_latch -= ticks_since_then;
+		return;
+	}
 	double index=PIC_FullIndex()-p->start;
 	switch (p->mode) {
 	case 4:		/* Software Triggered Strobe */
@@ -299,6 +304,10 @@
 			/* Counter latch command */
 			counter_latch(latch);
 		} else {
+			// save output status to be used with timer 0 irq
+			bool old_output = counter_output(0);
+			// save the current count value to be re-used in undocumented newmode
+			counter_latch(latch);
 			pit[latch].bcd = (val&1)>0;   
 			if (val & 1) {
 				if(pit[latch].cntr>=9999) pit[latch].cntr=9999;
@@ -309,6 +318,8 @@
 				pit[latch].counterstatus_set=false;
 				latched_timerstatus_locked=false;
 			}
+			pit[latch].start = PIC_FullIndex(); // for undocumented newmode
+			pit[latch].go_read_latch = true;
 			pit[latch].update_count = false;
 			pit[latch].counting = false;
 			pit[latch].read_state  = (val >> 4) & 0x03;
@@ -317,9 +328,7 @@
 			if (mode > 5)
 				mode -= 4; //6,7 become 2 and 3
 
-			/* Don't set it directly so counter_output uses the old mode */
-			/* That's theory. It breaks panic. So set it here again */
-			if(!pit[latch].mode) pit[latch].mode     = mode;
+			pit[latch].mode = mode;
 
 			/* If the line goes from low to up => generate irq. 
 			 *      ( BUT needs to stay up until acknowlegded by the cpu!!! therefore: )
@@ -327,20 +336,17 @@
 			 * Mode 0 starts with a low line. (so always disable irq)
 			 * Mode 2,3 start with a high line.
 			 * counter_output tells if the current counter is high or low 
-			 * So actually a mode 2 timer enables and disables irq al the time. (not handled) */
+			 * So actually a mode 3 timer enables and disables irq al the time. (not handled) */
 
 			if (latch == 0) {
 				PIC_RemoveEvents(PIT0_Event);
-				if (!counter_output(0) && mode) {
+				if((mode != 0)&& !old_output) {
 					PIC_ActivateIRQ(0);
-					//Don't raise instantaniously. (Origamo)
-					if(CPU_Cycles < 25) CPU_Cycles = 25;
-				}
-				if(!mode)
+				} else {
 					PIC_DeActivateIRQ(0);
+				}
 			}
 			pit[latch].new_mode = true;
-			pit[latch].mode     = mode; //Set the correct mode (here)
 		}
 		break;
     case 3:
diff -Nur dosbox-0.74/src/hardware/vga_attr.cpp dosbox-0.74.patch/src/hardware/vga_attr.cpp
--- dosbox-0.74/src/hardware/vga_attr.cpp	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/hardware/vga_attr.cpp	2016-12-11 18:35:15.542284005 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: vga_attr.cpp,v 1.31 2009-06-28 14:56:13 c2woody Exp $ */
 
 #include "dosbox.h"
 #include "inout.h"
@@ -24,22 +23,70 @@
 
 #define attr(blah) vga.attr.blah
 
-void VGA_ATTR_SetPalette(Bit8u index,Bit8u val) {
-	vga.attr.palette[index] = val;
-	if (vga.attr.mode_control & 0x80) val = (val&0xf) | (vga.attr.color_select << 4);
-	val &= 63;
-	val |= (vga.attr.color_select & 0xc) << 4;
-	if (GCC_UNLIKELY(machine==MCH_EGA)) {
-		if ((vga.crtc.vertical_total | ((vga.crtc.overflow & 1) << 8)) == 260) {
-			// check for intensity bit
-			if (val&0x10) val|=0x38;
-			else {
-				val&=0x7;
-				// check for special brown
-				if (val==6) val=0x14;
+void VGA_ATTR_SetEGAMonitorPalette(EGAMonitorMode m) {
+	// palette bit assignment:
+	// bit | pin | EGA        | CGA       | monochrome
+	// ----+-----+------------+-----------+------------
+	// 0   | 5   | blue       | blue      | nc
+	// 1   | 4   | green      | green*    | nc
+	// 2   | 3   | red        | red*      | nc
+	// 3   | 7   | blue sec.  | nc        | video
+	// 4   | 6   | green sec. | intensity | intensity
+	// 5   | 2   | red sec.   | nc        | nc
+    // 6-7 | not used
+	// * additive color brown instead of yellow
+	switch(m) {
+		case CGA:
+			//LOG_MSG("Monitor CGA");
+			for (Bitu i=0;i<64;i++) {
+				vga.dac.rgb[i].red=((i & 0x4)? 0x2a:0) + ((i & 0x10)? 0x15:0);
+				vga.dac.rgb[i].blue=((i & 0x1)? 0x2a:0) + ((i & 0x10)? 0x15:0);
+				
+				// replace yellow with brown
+				if ((i & 0x17) == 0x6) vga.dac.rgb[i].green = 0x15;
+				else vga.dac.rgb[i].green =
+					((i & 0x2)? 0x2a:0) + ((i & 0x10)? 0x15:0);
 			}
-		}
+			break;
+		case EGA:
+			//LOG_MSG("Monitor EGA");
+			for (Bitu i=0;i<64;i++) {
+				vga.dac.rgb[i].red=((i & 0x4)? 0x2a:0) + ((i & 0x20)? 0x15:0);
+				vga.dac.rgb[i].green=((i & 0x2)? 0x2a:0) + ((i & 0x10)? 0x15:0);
+				vga.dac.rgb[i].blue=((i & 0x1)? 0x2a:0) + ((i & 0x8)? 0x15:0);
+			}
+			break;
+		case MONO:
+			//LOG_MSG("Monitor MONO");
+			for (Bitu i=0;i<64;i++) {
+				Bit8u value = ((i & 0x8)? 0x2a:0) + ((i & 0x10)? 0x15:0);
+				vga.dac.rgb[i].red = vga.dac.rgb[i].green =
+					vga.dac.rgb[i].blue = value;
+			}
+			break;
 	}
+
+	// update the mappings
+	for (Bit8u i=0;i<0x10;i++)
+		VGA_ATTR_SetPalette(i,vga.attr.palette[i]);
+}
+
+void VGA_ATTR_SetPalette(Bit8u index, Bit8u val) {
+	// the attribute table stores only 6 bits
+	val &= 63; 
+	vga.attr.palette[index] = val;
+
+	// apply the plane mask
+	val = vga.attr.palette[index & vga.attr.color_plane_enable];
+
+	// replace bits 4-5 if configured
+	if (vga.attr.mode_control & 0x80)
+		val = (val&0xf) | (vga.attr.color_select << 4);
+
+	// set bits 6 and 7 (not relevant for EGA)
+	val |= (vga.attr.color_select & 0xc) << 4;
+
+	// apply
 	VGA_DAC_CombineColor(index,val);
 }
 
@@ -76,26 +123,33 @@
 				10h and 14h.
 			*/
 			break;
-		case 0x10: /* Mode Control Register */
+		case 0x10: { /* Mode Control Register */
 			if (!IS_VGA_ARCH) val&=0x1f;	// not really correct, but should do it
-			if ((attr(mode_control) ^ val) & 0x80) {
-				attr(mode_control)^=0x80;
-				for (Bit8u i=0;i<0x10;i++) {
+			Bitu difference = attr(mode_control)^val;
+			attr(mode_control)=(Bit8u)val;
+
+			if (difference & 0x80) {
+				for (Bit8u i=0;i<0x10;i++)
 					VGA_ATTR_SetPalette(i,vga.attr.palette[i]);
-				}
 			}
-			if ((attr(mode_control) ^ val) & 0x08) {
+			if (difference & 0x08)
 				VGA_SetBlinking(val & 0x8);
-			}
-			if ((attr(mode_control) ^ val) & 0x04) {
-				attr(mode_control)=(Bit8u)val;
-				VGA_DetermineMode();
-				if ((IS_VGA_ARCH) && (svgaCard==SVGA_None)) VGA_StartResize();
-			} else {
-				attr(mode_control)=(Bit8u)val;
+			
+			if (difference & 0x41)
 				VGA_DetermineMode();
-			}
 
+			if (difference & 0x04) {
+				// recompute the panning value
+				if(vga.mode==M_TEXT) {
+					Bit8u pan_reg = attr(horizontal_pel_panning);
+					if (pan_reg > 7)
+						vga.config.pel_panning=0;
+					else if (val&0x4) // 9-dot wide characters
+						vga.config.pel_panning=(Bit8u)(pan_reg+1);
+					else // 8-dot characters
+						vga.config.pel_panning=(Bit8u)pan_reg;
+				}
+			}
 			/*
 				0	Graphics mode if set, Alphanumeric mode else.
 				1	Monochrome mode if set, color mode else.
@@ -113,13 +167,21 @@
 					used.
 			*/
 			break;
+		}
 		case 0x11:	/* Overscan Color Register */
 			attr(overscan_color)=(Bit8u)val;
 			/* 0-5  Color of screen border. Color is defined as in the palette registers. */
 			break;
 		case 0x12:	/* Color Plane Enable Register */
 			/* Why disable colour planes? */
-			attr(color_plane_enable)=(Bit8u)val;
+			/* To support weird modes. */
+			if ((attr(color_plane_enable)^val) & 0xf) {
+				// in case the plane enable bits change...
+				attr(color_plane_enable)=(Bit8u)val;
+				for (Bit8u i=0;i<0x10;i++)
+					VGA_ATTR_SetPalette(i,vga.attr.palette[i]);
+			} else
+				attr(color_plane_enable)=(Bit8u)val;
 			/* 
 				0	Bit plane 0 is enabled if set.
 				1	Bit plane 1 is enabled if set.
@@ -134,9 +196,12 @@
 			attr(horizontal_pel_panning)=val & 0xF;
 			switch (vga.mode) {
 			case M_TEXT:
-				if ((val==0x7) && (svgaCard==SVGA_None)) vga.config.pel_panning=7;
-				if (val>0x7) vga.config.pel_panning=0;
-				else vga.config.pel_panning=(Bit8u)(val+1);
+				if (val > 7)
+					vga.config.pel_panning=0;
+				else if (vga.attr.mode_control&0x4) // 9-dot wide characters
+					vga.config.pel_panning=(Bit8u)(val+1);
+				else // 8-dot characters
+					vga.config.pel_panning=(Bit8u)val;
 				break;
 			case M_VGA:
 			case M_LIN8:
@@ -146,6 +211,9 @@
 			default:
 				vga.config.pel_panning=(val & 0x7);
 			}
+			if (machine==MCH_EGA)
+				// On the EGA panning can be programmed for every scanline:
+				vga.draw.panning = vga.config.pel_panning;
 			/*
 				0-3	Indicates number of pixels to shift the display left
 					Value  9bit textmode   256color mode   Other modes
@@ -167,9 +235,8 @@
 			}
 			if (attr(color_select) ^ val) {
 				attr(color_select)=(Bit8u)val;
-				for (Bit8u i=0;i<0x10;i++) {
+				for (Bit8u i=0;i<0x10;i++)
 					VGA_ATTR_SetPalette(i,vga.attr.palette[i]);
-				}
 			}
 			/*
 				0-1	If 3C0h index 10h bit 7 is set these 2 bits are used as bits 4-5 of
diff -Nur dosbox-0.74/src/hardware/vga.cpp dosbox-0.74.patch/src/hardware/vga.cpp
--- dosbox-0.74/src/hardware/vga.cpp	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/hardware/vga.cpp	2016-12-11 18:35:15.542284005 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: vga.cpp,v 1.36 2009-05-27 09:15:41 qbix79 Exp $ */
 
 #include "dosbox.h"
 //#include "setup.h"
diff -Nur dosbox-0.74/src/hardware/vga_crtc.cpp dosbox-0.74.patch/src/hardware/vga_crtc.cpp
--- dosbox-0.74/src/hardware/vga_crtc.cpp	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/hardware/vga_crtc.cpp	2016-12-11 18:35:15.542284005 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: vga_crtc.cpp,v 1.34 2009-03-18 18:08:16 c2woody Exp $ */
 
 #include <stdlib.h>
 #include "dosbox.h"
@@ -302,10 +301,14 @@
 		*/
 		break;
 	case 0x16:	/*  End Vertical Blank Register */
-		crtc(end_vertical_blanking)=val;
-		 /*
+		if (val!=crtc(end_vertical_blanking)) {
+			crtc(end_vertical_blanking)=val;
+			VGA_StartResize();
+		}
+		/*
 			0-6	Vertical blanking stops when the lower 7 bits of the line counter
 				equals this field. Some SVGA chips uses all 8 bits!
+				IBM actually says bits 0-7.
 		*/
 		break;
 	case 0x17:	/* Mode Control Register */
diff -Nur dosbox-0.74/src/hardware/vga_dac.cpp dosbox-0.74.patch/src/hardware/vga_dac.cpp
--- dosbox-0.74/src/hardware/vga_dac.cpp	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/hardware/vga_dac.cpp	2016-12-11 18:35:15.542284005 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -213,19 +213,5 @@
 		IO_RegisterReadHandler(0x3c8,read_p3c8,IO_MB);
 		IO_RegisterWriteHandler(0x3c9,write_p3c9,IO_MB);
 		IO_RegisterReadHandler(0x3c9,read_p3c9,IO_MB);
-	} else if (machine==MCH_EGA) {
-		for (Bitu i=0;i<64;i++) {
-			if ((i&4)>0) vga.dac.rgb[i].red=0x2a;
-			else vga.dac.rgb[i].red=0;
-			if ((i&32)>0) vga.dac.rgb[i].red+=0x15;
-
-			if ((i&2)>0) vga.dac.rgb[i].green=0x2a;
-			else vga.dac.rgb[i].green=0;
-			if ((i&16)>0) vga.dac.rgb[i].green+=0x15;
-
-			if ((i&1)>0) vga.dac.rgb[i].blue=0x2a;
-			else vga.dac.rgb[i].blue=0;
-			if ((i&8)>0) vga.dac.rgb[i].blue+=0x15;
-		}
 	}
 }
diff -Nur dosbox-0.74/src/hardware/vga_draw.cpp dosbox-0.74.patch/src/hardware/vga_draw.cpp
--- dosbox-0.74/src/hardware/vga_draw.cpp	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/hardware/vga_draw.cpp	2016-12-11 18:35:15.542284005 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: vga_draw.cpp,v 1.112 2009-11-03 21:06:59 h-a-l-9000 Exp $ */
 
 #include <string.h>
 #include <math.h>
@@ -78,70 +77,61 @@
 
 static Bit8u * VGA_Draw_CGA16_Line(Bitu vidstart, Bitu line) {
 	const Bit8u *base = vga.tandy.draw_base + ((line & vga.tandy.line_mask) << vga.tandy.line_shift);
-	const Bit8u *reader = base + vidstart;
+#define CGA16_READER(OFF) (base[(vidstart +(OFF))& (8*1024 -1)])
 	Bit32u * draw=(Bit32u *)TempLine;
-	//Generate a temporary bitline to calculate the avarage
-	//over bit-2  bit-1  bit  bit+1.
-	//Combine this number with the current colour to get 
-	//an unigue index in the pallete. Or it with bit 7 as they are stored 
-	//in the upperpart to keep them from interfering the regular cga stuff
-
-	for(Bitu x = 0; x < 640; x++)
-		temp[x+2] = (( reader[(x>>3)] >> (7-(x&7)) )&1) << 4;
-		//shift 4 as that is for the index.
-	Bitu i = 0,temp1,temp2,temp3,temp4;
+	//There are 640 hdots in each line of the screen.
+	//The color of an even hdot always depends on only 4 bits of video RAM.
+	//The color of an odd hdot depends on 4 bits of video RAM in
+	//1-hdot-per-pixel modes and 6 bits of video RAM in 2-hdot-per-pixel
+	//modes. We always assume 6 and use duplicate palette entries in
+	//1-hdot-per-pixel modes so that we can use the same routine for all
+	//composite modes.
+  temp[1] = (CGA16_READER(0) >> 6) & 3;
+	for(Bitu x = 2; x < 640; x+=2) {
+		temp[x] = (temp[x-1] & 0xf);
+		temp[x+1] = (temp[x] << 2) | ((( CGA16_READER(x>>3)) >> (6-(x&6)) )&3);
+	}
+	temp[640] = temp[639] & 0xf;
+	temp[641] = temp[640] << 2;
+	temp[642] = temp[641] & 0xf;
+
+	Bitu i = 2;
 	for (Bitu x=0;x<vga.draw.blocks;x++) {
-		Bitu val1 = *reader++;
-		Bitu val2 = val1&0xf;
-		val1 >>= 4;
-
-		temp1 = temp[i] + temp[i+1] + temp[i+2] + temp[i+3]; i++;
-		temp2 = temp[i] + temp[i+1] + temp[i+2] + temp[i+3]; i++;
-		temp3 = temp[i] + temp[i+1] + temp[i+2] + temp[i+3]; i++;
-		temp4 = temp[i] + temp[i+1] + temp[i+2] + temp[i+3]; i++;
-
-		*draw++ = 0x80808080|(temp1|val1) |
-		          ((temp2|val1) << 8) |
-		          ((temp3|val1) <<16) |
-		          ((temp4|val1) <<24);
-		temp1 = temp[i] + temp[i+1] + temp[i+2] + temp[i+3]; i++;
-		temp2 = temp[i] + temp[i+1] + temp[i+2] + temp[i+3]; i++;
-		temp3 = temp[i] + temp[i+1] + temp[i+2] + temp[i+3]; i++;
-		temp4 = temp[i] + temp[i+1] + temp[i+2] + temp[i+3]; i++;
-		*draw++ = 0x80808080|(temp1|val2) |
-		          ((temp2|val2) << 8) |
-		          ((temp3|val2) <<16) |
-		          ((temp4|val2) <<24);
+		*draw++ = 0xc0708030 | temp[i] | (temp[i+1] << 8) | (temp[i+2] << 16) | (temp[i+3] << 24);
+		i += 4;
+		*draw++ = 0xc0708030 | temp[i] | (temp[i+1] << 8) | (temp[i+2] << 16) | (temp[i+3] << 24);
+		i += 4;
 	}
 	return TempLine;
+#undef CGA16_READER
 }
 
 static Bit8u * VGA_Draw_4BPP_Line(Bitu vidstart, Bitu line) {
 	const Bit8u *base = vga.tandy.draw_base + ((line & vga.tandy.line_mask) << vga.tandy.line_shift);
-	Bit32u * draw=(Bit32u *)TempLine;
-	for (Bitu x=0;x<vga.draw.blocks;x++) {
-		Bitu val1 = base[vidstart & vga.tandy.addr_mask];
-		++vidstart;
-		Bitu val2 = base[vidstart & vga.tandy.addr_mask];
-		++vidstart;
-		*draw++=(val1 & 0x0f) << 8  |
-				(val1 & 0xf0) >> 4  |
-				(val2 & 0x0f) << 24 |
-				(val2 & 0xf0) << 12;
+	Bit8u* draw=TempLine;
+	Bitu end = vga.draw.blocks*2;
+	while(end) {
+		Bit8u byte = base[vidstart & vga.tandy.addr_mask];
+		*draw++=vga.attr.palette[byte >> 4];
+		*draw++=vga.attr.palette[byte & 0x0f];
+		vidstart++;
+		end--;
 	}
 	return TempLine;
 }
 
 static Bit8u * VGA_Draw_4BPP_Line_Double(Bitu vidstart, Bitu line) {
 	const Bit8u *base = vga.tandy.draw_base + ((line & vga.tandy.line_mask) << vga.tandy.line_shift);
-	Bit32u * draw=(Bit32u *)TempLine;
-	for (Bitu x=0;x<vga.draw.blocks;x++) {
-		Bitu val = base[vidstart & vga.tandy.addr_mask];
-		++vidstart;
-		*draw++=(val & 0xf0) >> 4  |
-				(val & 0xf0) << 4  |
-				(val & 0x0f) << 16 |
-				(val & 0x0f) << 24;
+	Bit8u* draw=TempLine;
+	Bitu end = vga.draw.blocks;
+	while(end) {
+		Bit8u byte = base[vidstart & vga.tandy.addr_mask];
+		Bit8u data = vga.attr.palette[byte >> 4];
+		*draw++ = data; *draw++ = data;
+		data = vga.attr.palette[byte & 0x0f];
+		*draw++ = data; *draw++ = data;
+		vidstart++;
+		end--;
 	}
 	return TempLine;
 }
@@ -155,7 +145,7 @@
 	for (; start <= end;start++) {
 		if ( map[start] & checkMask ) {
 			Bitu offset = vidstart & vga.draw.linear_mask;
-			if(vga.draw.linear_mask-offset < vga.draw.line_length)
+			if (vga.draw.linear_mask-offset < vga.draw.line_length)
 				memcpy(vga.draw.linear_base+vga.draw.linear_mask+1, vga.draw.linear_base, vga.draw.line_length);
 			Bit8u *ret = &vga.draw.linear_base[ offset ];
 #if !defined(C_UNALIGNED_MEMORY)
@@ -175,12 +165,28 @@
 #endif
 
 static Bit8u * VGA_Draw_Linear_Line(Bitu vidstart, Bitu /*line*/) {
-// There is guaranteed extra memory past the wrap boundary. So, instead of using temporary
-// storage just copy appropriate chunk from the beginning to the wrap boundary when needed.
 	Bitu offset = vidstart & vga.draw.linear_mask;
-	if (vga.draw.linear_mask-offset < vga.draw.line_length)
-		memcpy(vga.draw.linear_base+vga.draw.linear_mask+1, vga.draw.linear_base, vga.draw.line_length);
-	Bit8u *ret = &vga.draw.linear_base[ offset ];
+	Bit8u* ret = &vga.draw.linear_base[offset];
+	
+	// in case (vga.draw.line_length + offset) has bits set that
+	// are not set in the mask: ((x|y)!=y) equals (x&~y)
+	if (GCC_UNLIKELY((vga.draw.line_length + offset)& ~vga.draw.linear_mask)) {
+		// this happens, if at all, only once per frame (1 of 480 lines)
+		// in some obscure games
+		Bitu end = (offset + vga.draw.line_length) & vga.draw.linear_mask;
+		
+		// assuming lines not longer than 4096 pixels
+		Bitu wrapped_len = end & 0xFFF;
+		Bitu unwrapped_len = vga.draw.line_length-wrapped_len;
+		
+		// unwrapped chunk: to top of memory block
+		memcpy(TempLine, &vga.draw.linear_base[offset], unwrapped_len);
+		// wrapped chunk: from base of memory block
+		memcpy(&TempLine[unwrapped_len], vga.draw.linear_base, wrapped_len);
+
+		ret = TempLine;
+	}
+
 #if !defined(C_UNALIGNED_MEMORY)
 	if (GCC_UNLIKELY( ((Bitu)ret) & (sizeof(Bitu)-1)) ) {
 		memcpy( TempLine, ret, vga.draw.line_length );
@@ -197,14 +203,6 @@
 		temps[i]=vga.dac.xlat16[ret[i]];
 	}
 	return TempLine;
-	/*
-#if !defined(C_UNALIGNED_MEMORY)
-	if (GCC_UNLIKELY( ((Bitu)ret) & (sizeof(Bitu)-1)) ) {
-		memcpy( TempLine, ret, vga.draw.line_length );
-		return TempLine;
-	}
-#endif
-	return ret;*/
 }
 
 //Test version, might as well keep it
@@ -446,167 +444,121 @@
 skip_cursor:
 	return TempLine;
 }
-
-static Bit8u * VGA_TEXT_Xlat16_Draw_Line(Bitu vidstart, Bitu line) {
-	Bits font_addr;
-	Bit16u * draw=(Bit16u *)TempLine;
-	const Bit8u* vidmem = VGA_Text_Memwrap(vidstart);
-	for (Bitu cx=0;cx<vga.draw.blocks;cx++) {
-		Bitu chr=vidmem[cx*2];
-		Bitu col=vidmem[cx*2+1];
-		Bitu font=vga.draw.font_tables[(col >> 3)&1][chr*32+line];
-		Bit32u mask1=TXT_Font_Table[font>>4] & FontMask[col >> 7];
-		Bit32u mask2=TXT_Font_Table[font&0xf] & FontMask[col >> 7];
-		Bit32u fg=TXT_FG_Table[col&0xf];
-		Bit32u bg=TXT_BG_Table[col>>4];
-		
-		mask1=(fg&mask1) | (bg&~mask1);
-		mask2=(fg&mask2) | (bg&~mask2);
-
-		for(int i = 0; i < 4; i++) {
-			*draw++ = vga.dac.xlat16[(mask1>>8*i)&0xff];
-		}
-		for(int i = 0; i < 4; i++) {
-			*draw++ = vga.dac.xlat16[(mask2>>8*i)&0xff];
-		}
-	}
-	if (!vga.draw.cursor.enabled || !(vga.draw.cursor.count&0x8)) goto skip_cursor;
-	font_addr = (vga.draw.cursor.address-vidstart) >> 1;
-	if (font_addr>=0 && font_addr<(Bits)vga.draw.blocks) {
-		if (line<vga.draw.cursor.sline) goto skip_cursor;
-		if (line>vga.draw.cursor.eline) goto skip_cursor;
-		draw=(Bit16u *)&TempLine[font_addr*16];
-		Bit8u att=(Bit8u)(TXT_FG_Table[vga.tandy.draw_base[vga.draw.cursor.address+1]&0xf]&0xff);
-		for(int i = 0; i < 8; i++) {
-			*draw++ = vga.dac.xlat16[att];
-		}
-	}
-skip_cursor:
-	return TempLine;
-}
-
 /*
-static Bit8u * VGA_TEXT_Draw_Line_9(Bitu vidstart, Bitu line) {
-	Bits font_addr;
-	Bit8u * draw=(Bit8u *)TempLine;
-	bool underline=(Bitu)(vga.crtc.underline_location&0x1f)==line;
-	Bit8u pel_pan=(Bit8u)vga.draw.panning;
-	if ((vga.attr.mode_control&0x20) && (vga.draw.lines_done>=vga.draw.split_line)) pel_pan=0;
-	const Bit8u* vidmem = VGA_Text_Memwrap(vidstart);
-	Bit8u chr=vidmem[0];
-	Bit8u col=vidmem[1];
-	Bit8u font=(vga.draw.font_tables[(col >> 3)&1][chr*32+line])<<pel_pan;
-	if (underline && ((col&0x07) == 0x01)) font=0xff;
-	Bit8u fg=col&0xf;
-	Bit8u bg=(Bit8u)(TXT_BG_Table[col>>4]&0xff);
-	Bitu draw_blocks=vga.draw.blocks;
-	draw_blocks++;
-	for (Bitu cx=1;cx<draw_blocks;cx++) {
-		if (pel_pan) {
-			chr=vidmem[cx*2];
-			col=vidmem[cx*2+1];
-			if (underline && ((col&0x07) == 0x01)) font|=0xff>>(8-pel_pan);
-			else font|=vga.draw.font_tables[(col >> 3)&1][chr*32+line]>>(8-pel_pan);
-			fg=col&0xf;
-			bg=(Bit8u)(TXT_BG_Table[col>>4]&0xff);
+// combined 8/9-dot wide text mode 8bpp line drawing function
+static Bit8u* VGA_TEXT_Draw_Line(Bitu vidstart, Bitu line) {
+	// keep it aligned:
+	Bit8u* draw = ((Bit8u*)TempLine) + 16 - vga.draw.panning;
+	const Bit8u* vidmem = VGA_Text_Memwrap(vidstart); // pointer to chars+attribs
+	Bitu blocks = vga.draw.blocks;
+	if (vga.draw.panning) blocks++; // if the text is panned part of an 
+									// additional character becomes visible
+	while (blocks--) { // for each character in the line
+		Bitu chr = *vidmem++;
+		Bitu attr = *vidmem++;
+		// the font pattern
+		Bitu font = vga.draw.font_tables[(attr >> 3)&1][(chr<<5)+line];
+		
+		Bitu background = attr >> 4;
+		// if blinking is enabled bit7 is not mapped to attributes
+		if (vga.draw.blinking) background &= ~0x8;
+		// choose foreground color if blinking not set for this cell or blink on
+		Bitu foreground = (vga.draw.blink || (!(attr&0x80)))?
+			(attr&0xf):background;
+		// underline: all foreground [freevga: 0x77, previous 0x7]
+		if (GCC_UNLIKELY(((attr&0x77) == 0x01) &&
+			(vga.crtc.underline_location&0x1f)==line))
+				background = foreground;
+		if (vga.draw.char9dot) {
+			font <<=1; // 9 pixels
+			// extend to the 9th pixel if needed
+			if ((font&0x2) && (vga.attr.mode_control&0x04) &&
+				(chr>=0xc0) && (chr<=0xdf)) font |= 1;
+			for (Bitu n = 0; n < 9; n++) {
+				*draw++ = (font&0x100)? foreground:background;
+				font <<= 1;
+			}
 		} else {
-			chr=vidmem[(cx-1)*2];
-			col=vidmem[(cx-1)*2+1];
-			if (underline && ((col&0x07) == 0x01)) font=0xff;
-			else font=vga.draw.font_tables[(col >> 3)&1][chr*32+line];
-			fg=col&0xf;
-			bg=(Bit8u)(TXT_BG_Table[col>>4]&0xff);
-		}
-		if (FontMask[col>>7]==0) font=0;
-		*draw++=(font&0x80)?fg:bg;		*draw++=(font&0x40)?fg:bg;
-		*draw++=(font&0x20)?fg:bg;		*draw++=(font&0x10)?fg:bg;
-		*draw++=(font&0x08)?fg:bg;		*draw++=(font&0x04)?fg:bg;
-		*draw++=(font&0x02)?fg:bg;
-		Bit8u last=(font&0x01)?fg:bg;
-		*draw++=last;
-		*draw++=((vga.attr.mode_control&0x04) && ((chr<0xc0) || (chr>0xdf))) ? bg : last;
-		if (pel_pan) {
-			if (underline && ((col&0x07) == 0x01)) font=0xff;
-			else font=(vga.draw.font_tables[(col >> 3)&1][chr*32+line])<<pel_pan;
+			for (Bitu n = 0; n < 8; n++) {
+				*draw++ = (font&0x80)? foreground:background;
+				font <<= 1;
+			}
 		}
 	}
-	if (!vga.draw.cursor.enabled || !(vga.draw.cursor.count&0x8)) goto skip_cursor;
-	font_addr = (vga.draw.cursor.address-vidstart) >> 1;
-	if (font_addr>=0 && font_addr<(Bits)vga.draw.blocks) {
-		if (line<vga.draw.cursor.sline) goto skip_cursor;
-		if (line>vga.draw.cursor.eline) goto skip_cursor;
-		draw=&TempLine[font_addr*9];
-		Bit8u fg=vga.tandy.draw_base[vga.draw.cursor.address+1]&0xf;
-		*draw++=fg;		*draw++=fg;		*draw++=fg;		*draw++=fg;
-		*draw++=fg;		*draw++=fg;		*draw++=fg;		*draw++=fg;
+	// draw the text mode cursor if needed
+	if ((vga.draw.cursor.count&0x8) && (line >= vga.draw.cursor.sline) &&
+		(line <= vga.draw.cursor.eline) && vga.draw.cursor.enabled) {
+		// the adress of the attribute that makes up the cell the cursor is in
+		Bits attr_addr = (vga.draw.cursor.address-vidstart) >> 1;
+		if (attr_addr >= 0 && attr_addr < (Bits)vga.draw.blocks) {
+			Bitu index = attr_addr * (vga.draw.char9dot? 9:8);
+			draw = (Bit8u*)(&TempLine[index]) + 16 - vga.draw.panning;
+			
+			Bitu foreground = vga.tandy.draw_base[vga.draw.cursor.address+1] & 0xf;
+			for (Bitu i = 0; i < 8; i++) {
+				*draw++ = foreground;
+			}
+		}
 	}
-skip_cursor:
-	return TempLine;
+	return TempLine+16;
 }
 */
-
-static Bit8u * VGA_TEXT_Xlat16_Draw_Line_9(Bitu vidstart, Bitu line) {
-	Bits font_addr;
-	Bit16u * draw=(Bit16u *)TempLine;
-	bool underline=(Bitu)(vga.crtc.underline_location&0x1f)==line;
-	Bit8u pel_pan=(Bit8u)vga.draw.panning;
-	if ((vga.attr.mode_control&0x20) && (vga.draw.lines_done>=vga.draw.split_line)) pel_pan=0;
-	const Bit8u* vidmem = VGA_Text_Memwrap(vidstart);
-	Bit8u chr=vidmem[0];
-	Bit8u col=vidmem[1];
-	Bit8u font=(vga.draw.font_tables[(col >> 3)&1][chr*32+line])<<pel_pan;
-	if (underline && ((col&0x07) == 0x01)) font=0xff;
-	Bit8u fg=col&0xf;
-	Bit8u bg=(Bit8u)(TXT_BG_Table[col>>4]&0xff);
-	Bitu draw_blocks=vga.draw.blocks;
-	draw_blocks++;
-	for (Bitu cx=1;cx<draw_blocks;cx++) {
-		if (pel_pan) {
-			chr=vidmem[cx*2];
-			col=vidmem[cx*2+1];
-			if (underline && ((col&0x07) == 0x01)) font|=0xff>>(8-pel_pan);
-			else font|=vga.draw.font_tables[(col >> 3)&1][chr*32+line]>>(8-pel_pan);
-			fg=col&0xf;
-			bg=(Bit8u)(TXT_BG_Table[col>>4]&0xff);
+// combined 8/9-dot wide text mode 16bpp line drawing function
+static Bit8u* VGA_TEXT_Xlat16_Draw_Line(Bitu vidstart, Bitu line) {
+	// keep it aligned:
+	Bit16u* draw = ((Bit16u*)TempLine) + 16 - vga.draw.panning;
+	const Bit8u* vidmem = VGA_Text_Memwrap(vidstart); // pointer to chars+attribs
+	Bitu blocks = vga.draw.blocks;
+	if (vga.draw.panning) blocks++; // if the text is panned part of an 
+									// additional character becomes visible
+	while (blocks--) { // for each character in the line
+		Bitu chr = *vidmem++;
+		Bitu attr = *vidmem++;
+		// the font pattern
+		Bitu font = vga.draw.font_tables[(attr >> 3)&1][(chr<<5)+line];
+		
+		Bitu background = attr >> 4;
+		// if blinking is enabled bit7 is not mapped to attributes
+		if (vga.draw.blinking) background &= ~0x8;
+		// choose foreground color if blinking not set for this cell or blink on
+		Bitu foreground = (vga.draw.blink || (!(attr&0x80)))?
+			(attr&0xf):background;
+		// underline: all foreground [freevga: 0x77, previous 0x7]
+		if (GCC_UNLIKELY(((attr&0x77) == 0x01) &&
+			(vga.crtc.underline_location&0x1f)==line))
+				background = foreground;
+		if (vga.draw.char9dot) {
+			font <<=1; // 9 pixels
+			// extend to the 9th pixel if needed
+			if ((font&0x2) && (vga.attr.mode_control&0x04) &&
+				(chr>=0xc0) && (chr<=0xdf)) font |= 1;
+			for (Bitu n = 0; n < 9; n++) {
+				*draw++ = vga.dac.xlat16[(font&0x100)? foreground:background];
+				font <<= 1;
+			}
 		} else {
-			chr=vidmem[(cx-1)*2];
-			col=vidmem[(cx-1)*2+1];
-			if (underline && ((col&0x07) == 0x01)) font=0xff;
-			else font=vga.draw.font_tables[(col >> 3)&1][chr*32+line];
-			fg=col&0xf;
-			bg=(Bit8u)(TXT_BG_Table[col>>4]&0xff);
-		}
-		if (FontMask[col>>7]==0) font=0;
-		Bit8u mask=0x80;
-		for (int i = 0; i < 7; i++) {
-			*draw++=vga.dac.xlat16[font&mask?fg:bg];
-			mask>>=1;
-		}
-		Bit16u lastval=vga.dac.xlat16[font&mask?fg:bg];
-		*draw++=lastval;
-		*draw++=(((vga.attr.mode_control&0x04) && ((chr<0xc0) || (chr>0xdf))) && 
-			!(underline && ((col&0x07) == 0x01))) ? 
-			(vga.dac.xlat16[bg]) : lastval;
-		if (pel_pan) {
-			if (underline && ((col&0x07) == 0x01)) font=0xff;
-			else font=(vga.draw.font_tables[(col >> 3)&1][chr*32+line])<<pel_pan;
+			for (Bitu n = 0; n < 8; n++) {
+				*draw++ = vga.dac.xlat16[(font&0x80)? foreground:background];
+				font <<= 1;
+			}
 		}
 	}
-	if (!vga.draw.cursor.enabled || !(vga.draw.cursor.count&0x8)) goto skip_cursor;
-	font_addr = (vga.draw.cursor.address-vidstart) >> 1;
-	if (font_addr>=0 && font_addr<(Bits)vga.draw.blocks) {
-		if (line<vga.draw.cursor.sline) goto skip_cursor;
-		if (line>vga.draw.cursor.eline) goto skip_cursor;
-		draw=(Bit16u*)&TempLine[font_addr*18];
-		Bit8u fg=vga.tandy.draw_base[vga.draw.cursor.address+1]&0xf;
-		for(int i = 0; i < 8; i++) {
-			*draw++ = vga.dac.xlat16[fg];
+	// draw the text mode cursor if needed
+	if ((vga.draw.cursor.count&0x8) && (line >= vga.draw.cursor.sline) &&
+		(line <= vga.draw.cursor.eline) && vga.draw.cursor.enabled) {
+		// the adress of the attribute that makes up the cell the cursor is in
+		Bits attr_addr = (vga.draw.cursor.address-vidstart) >> 1;
+		if (attr_addr >= 0 && attr_addr < (Bits)vga.draw.blocks) {
+			Bitu index = attr_addr * (vga.draw.char9dot? 18:16);
+			draw = (Bit16u*)(&TempLine[index]) + 16 - vga.draw.panning;
+			
+			Bitu foreground = vga.tandy.draw_base[vga.draw.cursor.address+1] & 0xf;
+			for (Bitu i = 0; i < 8; i++) {
+				*draw++ = vga.dac.xlat16[foreground];
+			}
 		}
-		//if(underline && ((col&0x07) == 0x01)) 
-		//	*draw = vga.dac.xlat16[fg];
 	}
-skip_cursor:
-	return TempLine;
+	return TempLine+32;
 }
 
 #ifdef VGA_KEEP_CHANGES
@@ -628,22 +580,75 @@
 
 
 static void VGA_ProcessSplit() {
-	// On the EGA the address is always reset to 0.
-	if ((vga.attr.mode_control&0x20) || (machine==MCH_EGA)) {
+	if (vga.attr.mode_control&0x20) {
 		vga.draw.address=0;
+		// reset panning to 0 here so we don't have to check for 
+		// it in the character draw functions. It will be set back
+		// to its proper value in v-retrace
+		vga.draw.panning=0; 
 	} else {
 		// In text mode only the characters are shifted by panning, not the address;
 		// this is done in the text line draw function.
 		vga.draw.address = vga.draw.byte_panning_shift*vga.draw.bytes_skip;
-		if (!(vga.mode==M_TEXT)) vga.draw.address += vga.draw.panning;
+		if ((vga.mode!=M_TEXT)&&(machine!=MCH_EGA)) vga.draw.address += vga.draw.panning;
 	}
 	vga.draw.address_line=0;
 }
 
+static Bit8u bg_color_index = 0; // screen-off black index
 static void VGA_DrawSingleLine(Bitu /*blah*/) {
 	if (GCC_UNLIKELY(vga.attr.disabled)) {
-		// draw blanked line (DoWhackaDo, Alien Carnage, TV sports Football)
-		memset(TempLine, 0, sizeof(TempLine));
+		switch(machine) {
+		case MCH_PCJR:
+			// Displays the border color when screen is disabled
+			bg_color_index = vga.tandy.border_color;
+			break;
+		case MCH_TANDY:
+			// Either the PCJr way or the CGA way
+			if (vga.tandy.gfx_control& 0x4) { 
+				bg_color_index = vga.tandy.border_color;
+			} else if (vga.mode==M_TANDY4) 
+				bg_color_index = vga.attr.palette[0];
+			else bg_color_index = 0;
+			break;
+		case MCH_CGA:
+			// the background color
+			bg_color_index = vga.attr.overscan_color;
+			break;
+		case MCH_EGA:
+		case MCH_VGA:
+			// DoWhackaDo, Alien Carnage, TV sports Football
+			// when disabled by attribute index bit 5:
+			//  ET3000, ET4000, Paradise display the border color
+			//  S3 displays the content of the currently selected attribute register
+			// when disabled by sequencer the screen is black "257th color"
+			
+			// the DAC table may not match the bits of the overscan register
+			// so use black for this case too...
+			//if (vga.attr.disabled& 2) {
+			if (vga.dac.xlat16[bg_color_index] != 0) {
+				for(Bitu i = 0; i < 256; i++)
+					if (vga.dac.xlat16[i] == 0) {
+						bg_color_index = i;
+						break;
+					}
+			}
+			//} else 
+            //    bg_color_index = vga.attr.overscan_color;
+			break;
+		default:
+			bg_color_index = 0;
+			break;
+		}
+		if (vga.draw.bpp==8) {
+			memset(TempLine, bg_color_index, sizeof(TempLine));
+		} else if (vga.draw.bpp==16) {
+			Bit16u* wptr = (Bit16u*) TempLine;
+			Bit16u value = vga.dac.xlat16[bg_color_index];
+			for (Bitu i = 0; i < sizeof(TempLine)/2; i++) {
+				wptr[i] = value;
+			}
+		}
 		RENDER_DrawLine(TempLine);
 	} else {
 		Bit8u * data=VGA_DrawLine( vga.draw.address, vga.draw.address_line );	
@@ -662,6 +667,29 @@
 	} else RENDER_EndUpdate(false);
 }
 
+static void VGA_DrawEGASingleLine(Bitu /*blah*/) {
+	if (GCC_UNLIKELY(vga.attr.disabled)) {
+		memset(TempLine, 0, sizeof(TempLine));
+		RENDER_DrawLine(TempLine);
+	} else {
+		Bitu address = vga.draw.address;
+		if (vga.mode!=M_TEXT) address += vga.draw.panning;
+		Bit8u * data=VGA_DrawLine(address, vga.draw.address_line );	
+		RENDER_DrawLine(data);
+	}
+
+	vga.draw.address_line++;
+	if (vga.draw.address_line>=vga.draw.address_line_total) {
+		vga.draw.address_line=0;
+		vga.draw.address+=vga.draw.address_add;
+	}
+	vga.draw.lines_done++;
+	if (vga.draw.split_line==vga.draw.lines_done) VGA_ProcessSplit();
+	if (vga.draw.lines_done < vga.draw.lines_total) {
+		PIC_AddEvent(VGA_DrawEGASingleLine,(float)vga.draw.delay.htotal);
+	} else RENDER_EndUpdate(false);
+}
+
 static void VGA_DrawPart(Bitu lines) {
 	while (lines--) {
 		Bit8u * data=VGA_DrawLine( vga.draw.address, vga.draw.address_line );
@@ -771,7 +799,6 @@
 		VGA_DisplayStartLatch(0);
 		break;
 	case MCH_VGA:
-	case MCH_EGA:
 		PIC_AddEvent(VGA_DisplayStartLatch, (float)vga.draw.delay.vrstart);
 		PIC_AddEvent(VGA_PanningLatch, (float)vga.draw.delay.vrend);
 		// EGA: 82c435 datasheet: interrupt happens at display end
@@ -779,12 +806,16 @@
 		// add a little amount of time to make sure the last drawpart has already fired
 		PIC_AddEvent(VGA_VertInterrupt,(float)(vga.draw.delay.vdend + 0.005));
 		break;
+	case MCH_EGA:
+		PIC_AddEvent(VGA_DisplayStartLatch, (float)vga.draw.delay.vrend);
+		PIC_AddEvent(VGA_VertInterrupt,(float)(vga.draw.delay.vdend + 0.005));
+		break;
 	default:
 		E_Exit("This new machine needs implementation in VGA_VerticalTimer too.");
 		break;
 	}
 	//Check if we can actually render, else skip the rest (frameskip)
-	if (!RENDER_StartUpdate())
+	if (vga.draw.vga_override || !RENDER_StartUpdate())
 		return;
 
 	vga.draw.address_line = vga.config.hlines_skip;
@@ -798,7 +829,11 @@
 	vga.draw.address = vga.config.real_start;
 	vga.draw.byte_panning_shift = 0;
 	// go figure...
-	if (machine==MCH_EGA) vga.draw.split_line*=2;
+	if (machine==MCH_EGA) {
+		if (vga.draw.doubleheight) // Spacepigs EGA Megademo
+			vga.draw.split_line*=2;
+		vga.draw.split_line++; // EGA adds one buggy scanline
+	}
 //	if (machine==MCH_EGA) vga.draw.split_line = ((((vga.config.line_compare&0x5ff)+1)*2-1)/vga.draw.lines_scaled);
 #ifdef VGA_KEEP_CHANGES
 	bool startaddr_changed=false;
@@ -811,13 +846,13 @@
 		vga.draw.byte_panning_shift = 8;
 		vga.draw.address += vga.draw.bytes_skip;
 		vga.draw.address *= vga.draw.byte_panning_shift;
-		vga.draw.address += vga.draw.panning;
+		if (machine!=MCH_EGA) vga.draw.address += vga.draw.panning;
 #ifdef VGA_KEEP_CHANGES
 		startaddr_changed=true;
 #endif
 		break;
 	case M_VGA:
-		if(vga.config.compatible_chain4 && (vga.crtc.underline_location & 0x40)) {
+		if (vga.config.compatible_chain4 && (vga.crtc.underline_location & 0x40)) {
 			vga.draw.linear_base = vga.fastmem;
 			vga.draw.linear_mask = 0xffff;
 		} else {
@@ -851,9 +886,12 @@
 		/* check for blinking and blinking change delay */
 		FontMask[1]=(vga.draw.blinking & (vga.draw.cursor.count >> 4)) ?
 			0 : 0xffffffff;
+		/* if blinking is enabled, 'blink' will toggle between true
+		 * and false. Otherwise it's true */
+		vga.draw.blink = ((vga.draw.blinking & (vga.draw.cursor.count >> 4))
+			|| !vga.draw.blinking) ? true:false;
 		break;
 	case M_HERC_GFX:
-		break;
 	case M_CGA4:case M_CGA2:
 		vga.draw.address=(vga.draw.address*2)&0x1fff;
 		break;
@@ -889,16 +927,19 @@
 		PIC_AddEvent(VGA_DrawPart,(float)vga.draw.delay.parts + draw_skip,vga.draw.parts_lines);
 		break;
 	case LINE:
+	case EGALINE:
 		if (GCC_UNLIKELY(vga.draw.lines_done < vga.draw.lines_total)) {
 			LOG(LOG_VGAMISC,LOG_NORMAL)( "Lines left: %d", 
 				vga.draw.lines_total-vga.draw.lines_done);
-			PIC_RemoveEvents(VGA_DrawSingleLine);
+			if (vga.draw.mode==EGALINE) PIC_RemoveEvents(VGA_DrawEGASingleLine);
+			else PIC_RemoveEvents(VGA_DrawSingleLine);
 			RENDER_EndUpdate(true);
 		}
 		vga.draw.lines_done = 0;
-		PIC_AddEvent(VGA_DrawSingleLine,(float)(vga.draw.delay.htotal/4.0 + draw_skip));
+		if (vga.draw.mode==EGALINE)
+			PIC_AddEvent(VGA_DrawEGASingleLine,(float)(vga.draw.delay.htotal/4.0 + draw_skip));
+		else PIC_AddEvent(VGA_DrawSingleLine,(float)(vga.draw.delay.htotal/4.0 + draw_skip));
 		break;
-	//case EGALINE:
 	}
 }
 
@@ -980,8 +1021,13 @@
 	switch (machine) {
 	case MCH_CGA:
 	case MCH_PCJR:
+	case MCH_TANDY:
 		vga.draw.mode = LINE;
 		break;
+	case MCH_EGA:
+		// Note: The Paradise SVGA uses the same panning mechanism as EGA
+		vga.draw.mode = EGALINE;
+		break;
 	case MCH_VGA:
 		if (svgaCard==SVGA_None) {
 			vga.draw.mode = LINE;
@@ -1035,7 +1081,6 @@
 		vtotal += 2;
 		hdend += 1;
 		vdend += 1;
-		vbstart += 1;
 
 		hbend = hbstart + ((hbend - hbstart) & 0x3F);
 		hrend = vga.crtc.end_horizontal_retrace & 0x1f;
@@ -1050,10 +1095,16 @@
 		if ( !vrend) vrend = vrstart + 0xf + 1;
 		else vrend = vrstart + vrend;
 
-		vbend = (vbend - vbstart) & 0x7f;
-		if ( !vbend) vbend = vbstart + 0x7f + 1;
-		else vbend = vbstart + vbend;
-
+		// Special case vbstart==0:
+		// Most graphics cards agree that lines zero to vbend are
+		// blanked. ET4000 doesn't blank at all if vbstart==vbend.
+		// ET3000 blanks lines 1 to vbend (255/6 lines).
+		if (vbstart != 0) {
+			vbstart += 1;
+			vbend = (vbend - vbstart) & 0x7f;
+			if ( !vbend) vbend = vbstart + 0x7f + 1;
+			else vbend = vbstart + vbend;
+		}
 		vbend++;
 			
 		if (svga.get_clock) {
@@ -1077,13 +1128,13 @@
 			htotal*=2;
 		}
 		vga.draw.address_line_total=(vga.crtc.maximum_scan_line&0x1f)+1;
-		if(IS_VGA_ARCH && (svgaCard==SVGA_None) && (vga.mode==M_EGA || vga.mode==M_VGA)) {
+		if (IS_VGA_ARCH && (svgaCard==SVGA_None) && (vga.mode==M_EGA || vga.mode==M_VGA)) {
 			// vgaonly; can't use with CGA because these use address_line for their
 			// own purposes.
 			// Set the low resolution modes to have as many lines as are scanned - 
 			// Quite a few demos change the max_scanline register at display time
 			// to get SFX: Majic12 show, Magic circle, Copper, GBU, Party91
-			if( vga.crtc.maximum_scan_line&0x80) vga.draw.address_line_total*=2;
+			if ( vga.crtc.maximum_scan_line&0x80) vga.draw.address_line_total*=2;
 			vga.draw.double_scan=false;
 		}
 		else if (IS_VGA_ARCH) vga.draw.double_scan=(vga.crtc.maximum_scan_line&0x80)>0;
@@ -1148,37 +1199,62 @@
 	// Vertical blanking tricks
 	vblank_skip = 0;
 	if (IS_VGA_ARCH) { // others need more investigation
-		if (vbend > vtotal) {
-			// blanking wraps to the start of the screen
-			vblank_skip = vbend&0x7f;
-			
-			// on blanking wrap to 0, the first line is not blanked
-			// this is used by the S3 BIOS and other S3 drivers in some SVGA modes
-			if((vbend&0x7f)==1) vblank_skip = 0;
-			
-			// it might also cut some lines off the bottom
-			if(vbstart < vdend) {
-				vdend = vbstart;
-			}
-			LOG(LOG_VGA,LOG_WARN)("Blanking wrap to line %d", vblank_skip);
-		} else if (vbstart==1) {
-			// blanking is used to cut lines at the start of the screen
-			vblank_skip = vbend;
-			LOG(LOG_VGA,LOG_WARN)("Upper %d lines of the screen blanked", vblank_skip);
-		} else if (vbstart < vdend) {
-			if(vbend < vdend) {
-				// the game wants a black bar somewhere on the screen
-				LOG(LOG_VGA,LOG_WARN)("Unsupported blanking: line %d-%d",vbstart,vbend);
-			} else {
-				// blanking is used to cut off some lines from the bottom
-				vdend = vbstart;
+		if (vbstart < vtotal) { // There will be no blanking at all otherwise
+			if (vbend > vtotal) {
+				// blanking wraps to the start of the screen
+				vblank_skip = vbend&0x7f;
+				
+				// on blanking wrap to 0, the first line is not blanked
+				// this is used by the S3 BIOS and other S3 drivers in some SVGA modes
+				if ((vbend&0x7f)==1) vblank_skip = 0;
+				
+				// it might also cut some lines off the bottom
+				if (vbstart < vdend) {
+					vdend = vbstart;
+				}
+				LOG(LOG_VGA,LOG_WARN)("Blanking wrap to line %d", vblank_skip);
+			} else if (vbstart<=1) {
+				// blanking is used to cut lines at the start of the screen
+				vblank_skip = vbend;
+				LOG(LOG_VGA,LOG_WARN)("Upper %d lines of the screen blanked", vblank_skip);
+			} else if (vbstart < vdend) {
+				if (vbend < vdend) {
+					// the game wants a black bar somewhere on the screen
+					LOG(LOG_VGA,LOG_WARN)("Unsupported blanking: line %d-%d",vbstart,vbend);
+				} else {
+					// blanking is used to cut off some lines from the bottom
+					vdend = vbstart;
+				}
 			}
+			vdend -= vblank_skip;
 		}
-		vdend -= vblank_skip;
 	}
 	// Display end
 	vga.draw.delay.vdend = vdend * vga.draw.delay.htotal;
 
+	// EGA frequency dependent monitor palette
+	if (machine == MCH_EGA) {
+		if (vga.misc_output & 1) {
+			// EGA card is in color mode
+			if ((1.0f/vga.draw.delay.htotal) > 19.0f) {
+				// 64 color EGA mode
+				VGA_ATTR_SetEGAMonitorPalette(EGA);
+			} else {
+				// 16 color CGA mode compatibility
+				VGA_ATTR_SetEGAMonitorPalette(CGA);
+			}
+		} else {
+			// EGA card in monochrome mode
+			// It is not meant to be autodetected that way, you either
+			// have a monochrome or color monitor connected and
+			// the EGA switches configured appropriately.
+			// But this would only be a problem if a program sets 
+			// the adapter to monochrome mode and still expects color output.
+			// Such a program should be shot to the moon...
+			VGA_ATTR_SetEGAMonitorPalette(MONO);
+		}
+	}
+
 	vga.draw.parts_total=VGA_PARTS;
 	/*
       6  Horizontal Sync Polarity. Negative if set
@@ -1264,7 +1340,7 @@
 	case M_LIN8:
 		if (vga.crtc.mode_control & 0x8)
 			width >>=1;
-		else if(svgaCard == SVGA_S3Trio && !(vga.s3.reg_3a&0x10)) {
+		else if (svgaCard == SVGA_S3Trio && !(vga.s3.reg_3a&0x10)) {
 			doublewidth=true;
 			width >>=1;
 		}
@@ -1298,6 +1374,7 @@
 		vga.draw.blocks = width;
 		width<<=3;
 		if ((IS_VGA_ARCH) && (svgaCard==SVGA_None)) {
+			// This would also be required for EGA in Spacepigs Megademo
 			bpp=16;
 			VGA_DrawLine = VGA_Draw_Xlat16_Linear_Line;
 		} else VGA_DrawLine=VGA_Draw_Linear_Line;
@@ -1327,17 +1404,22 @@
 		aspect_ratio=1.0;
 		vga.draw.blocks=width;
 		doublewidth=(vga.seq.clocking_mode & 0x8) > 0;
-		if ((IS_VGA_ARCH) && (svgaCard==SVGA_None) && !(vga.seq.clocking_mode&0x01)) {
-			width*=9;				/* 9 bit wide text font */
-			VGA_DrawLine=VGA_TEXT_Xlat16_Draw_Line_9;
+		if ((IS_VGA_ARCH) && (svgaCard==SVGA_None)) {
+			// vgaonly: allow 9-pixel wide fonts
+			if (vga.seq.clocking_mode&0x01) {
+				vga.draw.char9dot = false;
+				width*=8;
+			} else {
+				vga.draw.char9dot = true;
+				width*=9;
+			}
+			VGA_DrawLine=VGA_TEXT_Xlat16_Draw_Line;
 			bpp=16;
-//			VGA_DrawLine=VGA_TEXT_Draw_Line_9;
 		} else {
-			width<<=3;				/* 8 bit wide text font */
-			if ((IS_VGA_ARCH) && (svgaCard==SVGA_None)) {
-				VGA_DrawLine=VGA_TEXT_Xlat16_Draw_Line;
-				bpp=16;
-			} else VGA_DrawLine=VGA_TEXT_Draw_Line;
+			// not vgaonly: force 8-pixel wide fonts
+			width*=8; // 8 bit wide text font
+			vga.draw.char9dot = false;
+			VGA_DrawLine=VGA_TEXT_Draw_Line;
 		}
 		break;
 	case M_HERC_GFX:
@@ -1415,7 +1497,7 @@
 	}
 	vga.draw.vblank_skip = vblank_skip;
 		
-	if(!(IS_VGA_ARCH && (svgaCard==SVGA_None) && (vga.mode==M_EGA || vga.mode==M_VGA))) {
+	if (!(IS_VGA_ARCH && (svgaCard==SVGA_None) && (vga.mode==M_EGA || vga.mode==M_VGA))) {
 		//Only check for extra double height in vga modes
 		//(line multiplying by address_line_total)
 		if (!doubleheight && (vga.mode<M_TEXT) && !(vga.draw.address_line_total & 1)) {
@@ -1440,8 +1522,10 @@
 	}
 //	LOG_MSG("ht %d vt %d ratio %f", htotal, vtotal, aspect_ratio );
 
+	bool fps_changed = false;
 	// need to change the vertical timing?
 	if (fabs(vga.draw.delay.vtotal - 1000.0 / fps) > 0.0001) {
+		fps_changed = true;
 		vga.draw.delay.vtotal = 1000.0 / fps;
 		VGA_KillDrawing();
 		PIC_RemoveEvents(VGA_Other_VertInterrupt);
@@ -1468,7 +1552,7 @@
 		(vga.draw.doublewidth != doublewidth) ||
 		(vga.draw.doubleheight != doubleheight) ||
 		(fabs(aspect_ratio - vga.draw.aspect_ratio) > 0.0001) ||
-		(vga.draw.bpp != bpp)) {
+		(vga.draw.bpp != bpp) || fps_changed) {
 
 		VGA_KillDrawing();
 
@@ -1485,14 +1569,31 @@
 		LOG(LOG_VGA,LOG_NORMAL)("%s width, %s height aspect %f",
 			doublewidth ? "double":"normal",doubleheight ? "double":"normal",aspect_ratio);
 #endif
-		RENDER_SetSize(width,height,bpp,(float)fps,aspect_ratio,doublewidth,doubleheight);
+		if (!vga.draw.vga_override) 
+			RENDER_SetSize(width, height, bpp, (float)fps, aspect_ratio,
+			doublewidth, doubleheight);
 	}
 }
 
 void VGA_KillDrawing(void) {
 	PIC_RemoveEvents(VGA_DrawPart);
 	PIC_RemoveEvents(VGA_DrawSingleLine);
+	PIC_RemoveEvents(VGA_DrawEGASingleLine);
 	vga.draw.parts_left = 0;
 	vga.draw.lines_done = ~0;
-	RENDER_EndUpdate(true);
+	if (!vga.draw.vga_override) RENDER_EndUpdate(true);
+}
+
+void VGA_SetOverride(bool vga_override) {
+	if (vga.draw.vga_override!=vga_override) {
+		
+		if (vga_override) {
+			VGA_KillDrawing();
+			vga.draw.vga_override=true;
+		} else {
+			vga.draw.vga_override=false;
+			vga.draw.width=0; // change it so the output window gets updated
+			VGA_SetupDrawing(0);
+		}
+	}
 }
diff -Nur dosbox-0.74/src/hardware/vga_gfx.cpp dosbox-0.74.patch/src/hardware/vga_gfx.cpp
--- dosbox-0.74/src/hardware/vga_gfx.cpp	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/hardware/vga_gfx.cpp	2016-12-11 18:35:15.546284005 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: vga_gfx.cpp,v 1.19 2009-05-27 09:15:41 qbix79 Exp $ */
 
 #include "dosbox.h"
 #include "inout.h"
diff -Nur dosbox-0.74/src/hardware/vga_memory.cpp dosbox-0.74.patch/src/hardware/vga_memory.cpp
--- dosbox-0.74/src/hardware/vga_memory.cpp	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/hardware/vga_memory.cpp	2016-12-11 18:35:15.546284005 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: vga_memory.cpp,v 1.53 2009-07-04 21:23:35 qbix79 Exp $ */
 
 #include <stdlib.h>
 #include <string.h>
@@ -161,19 +160,19 @@
 		addr = PAGING_GetPhysicalAddress(addr) & vgapages.mask;
 		addr += vga.svga.bank_read_full;
 		addr = CHECKED2(addr);
-		return 
-			(readHandler(addr+0) << 0) |
-			(readHandler(addr+1) << 8);
+		Bitu ret = (readHandler(addr+0) << 0);
+		ret     |= (readHandler(addr+1) << 8);
+		return  ret;
 	}
 	Bitu readd(PhysPt addr) {
 		addr = PAGING_GetPhysicalAddress(addr) & vgapages.mask;
 		addr += vga.svga.bank_read_full;
 		addr = CHECKED2(addr);
-		return 
-			(readHandler(addr+0) << 0)  |
-			(readHandler(addr+1) << 8)  |
-			(readHandler(addr+2) << 16) |
-			(readHandler(addr+3) << 24);
+		Bitu ret = (readHandler(addr+0) << 0);
+		ret     |= (readHandler(addr+1) << 8);
+		ret     |= (readHandler(addr+2) << 16);
+		ret     |= (readHandler(addr+3) << 24);
+		return ret;
 	}
 };
 
@@ -247,19 +246,19 @@
 		addr = PAGING_GetPhysicalAddress(addr) & vgapages.mask;
 		addr += vga.svga.bank_read_full;
 		addr = CHECKED(addr);
-		return 
-			(readHandler(addr+0) << 0) |
-			(readHandler(addr+1) << 8);
+		Bitu ret = (readHandler(addr+0) << 0);
+		ret     |= (readHandler(addr+1) << 8);
+		return ret;
 	}
 	Bitu readd(PhysPt addr) {
 		addr = PAGING_GetPhysicalAddress(addr) & vgapages.mask;
 		addr += vga.svga.bank_read_full;
 		addr = CHECKED(addr);
-		return 
-			(readHandler(addr+0) << 0)  |
-			(readHandler(addr+1) << 8)  |
-			(readHandler(addr+2) << 16) |
-			(readHandler(addr+3) << 24);
+		Bitu ret = (readHandler(addr+0) << 0);
+		ret     |= (readHandler(addr+1) << 8);
+		ret     |= (readHandler(addr+2) << 16);
+		ret     |= (readHandler(addr+3) << 24);
+		return ret;
 	}
 };
 
@@ -356,24 +355,24 @@
 		addr = PAGING_GetPhysicalAddress(addr) & vgapages.mask;
 		addr += vga.svga.bank_read_full;
 		addr = CHECKED(addr);
-		if (GCC_UNLIKELY(addr & 1))
-			return
-				(readHandler<Bit8u>( addr+0 ) << 0 ) | 
-				(readHandler<Bit8u>( addr+1 ) << 8 );
-		else
+		if (GCC_UNLIKELY(addr & 1)) {
+			Bitu ret = (readHandler<Bit8u>( addr+0 ) << 0 );
+			ret     |= (readHandler<Bit8u>( addr+1 ) << 8 );
+			return ret;
+		} else
 			return readHandler<Bit16u>( addr );
 	}
 	Bitu readd(PhysPt addr ) {
 		addr = PAGING_GetPhysicalAddress(addr) & vgapages.mask;
 		addr += vga.svga.bank_read_full;
 		addr = CHECKED(addr);
-		if (GCC_UNLIKELY(addr & 3))
-			return
-				(readHandler<Bit8u>( addr+0 ) << 0 ) | 
-				(readHandler<Bit8u>( addr+1 ) << 8 ) | 
-				(readHandler<Bit8u>( addr+2 ) << 16 ) | 
-				(readHandler<Bit8u>( addr+3 ) << 24 );
-		else
+		if (GCC_UNLIKELY(addr & 3)) {
+			Bitu ret = (readHandler<Bit8u>( addr+0 ) << 0 );
+			ret     |= (readHandler<Bit8u>( addr+1 ) << 8 );
+			ret     |= (readHandler<Bit8u>( addr+2 ) << 16 );
+			ret     |= (readHandler<Bit8u>( addr+3 ) << 24 );
+			return ret;
+		} else
 			return readHandler<Bit32u>( addr );
 	}
 	void writeb(PhysPt addr, Bitu val ) {
@@ -466,12 +465,29 @@
 	}
 	Bitu readb(PhysPt addr) {
 		addr = PAGING_GetPhysicalAddress(addr) & vgapages.mask;
-		return vga.draw.font[addr];
+		switch(vga.gfx.read_map_select) {
+		case 0: // character index
+			return vga.mem.linear[CHECKED3(vga.svga.bank_read_full+addr)];
+		case 1: // character attribute
+			return vga.mem.linear[CHECKED3(vga.svga.bank_read_full+addr+1)];
+		case 2: // font map
+			return vga.draw.font[addr];
+		default: // 3=unused, but still RAM that could save values
+			return 0;
+		}
 	}
 	void writeb(PhysPt addr,Bitu val){
 		addr = PAGING_GetPhysicalAddress(addr) & vgapages.mask;
-		if (vga.seq.map_mask & 0x4) {
+		
+		if (GCC_LIKELY(vga.seq.map_mask == 0x4)) {
 			vga.draw.font[addr]=(Bit8u)val;
+		} else {
+			if (vga.seq.map_mask & 0x4) // font map
+				vga.draw.font[addr]=(Bit8u)val;
+			if (vga.seq.map_mask & 0x2) // character attribute
+				vga.mem.linear[CHECKED3(vga.svga.bank_read_full+addr+1)]=(Bit8u)val;
+			if (vga.seq.map_mask & 0x1) // character index
+				vga.mem.linear[CHECKED3(vga.svga.bank_read_full+addr)]=(Bit8u)val;
 		}
 	}
 };
@@ -572,18 +588,18 @@
 	Bitu readw(PhysPt addr) {
 		addr = vga.svga.bank_read_full + (PAGING_GetPhysicalAddress(addr) & 0xffff);
 		addr = CHECKED4(addr);
-		return 
-			(readHandler(addr+0) << 0) |
-			(readHandler(addr+1) << 8);
+		Bitu ret = (readHandler(addr+0) << 0);
+		ret     |= (readHandler(addr+1) << 8);
+		return ret;
 	}
 	Bitu readd(PhysPt addr) {
 		addr = vga.svga.bank_read_full + (PAGING_GetPhysicalAddress(addr) & 0xffff);
 		addr = CHECKED4(addr);
-		return 
-			(readHandler(addr+0) << 0)  |
-			(readHandler(addr+1) << 8)  |
-			(readHandler(addr+2) << 16) |
-			(readHandler(addr+3) << 24);
+		Bitu ret = (readHandler(addr+0) << 0);
+		ret     |= (readHandler(addr+1) << 8);
+		ret     |= (readHandler(addr+2) << 16);
+		ret     |= (readHandler(addr+3) << 24);
+		return ret;
 	}
 };
 
@@ -684,6 +700,7 @@
 //			|PFLAG_NOCODE;
 	}
 	HostPt GetHostReadPt(Bitu phys_page) {
+		// Odd banks are limited to 16kB and repeated
 		if (vga.tandy.mem_bank & 1) 
 			phys_page&=0x03;
 		else 
@@ -703,9 +720,9 @@
 	}
 	HostPt GetHostReadPt(Bitu phys_page) {
 		phys_page-=0xb8;
-		//test for a unaliged bank, then replicate 2x16kb
-		if (vga.tandy.mem_bank & 1) 
-			phys_page&=0x03;
+		// The 16kB map area is repeated in the 32kB range
+		// On CGA CPU A14 is not decoded so it repeats there too
+		phys_page&=0x03;
 		return vga.tandy.mem_base + (phys_page * 4096);
 	}
 	HostPt GetHostWritePt(Bitu phys_page) {
diff -Nur dosbox-0.74/src/hardware/vga_misc.cpp dosbox-0.74.patch/src/hardware/vga_misc.cpp
--- dosbox-0.74/src/hardware/vga_misc.cpp	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/hardware/vga_misc.cpp	2016-12-11 18:35:15.546284005 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: vga_misc.cpp,v 1.39 2009-01-25 12:00:49 c2woody Exp $ */
 
 #include "dosbox.h"
 #include "inout.h"
diff -Nur dosbox-0.74/src/hardware/vga_other.cpp dosbox-0.74.patch/src/hardware/vga_other.cpp
--- dosbox-0.74/src/hardware/vga_other.cpp	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/hardware/vga_other.cpp	2016-12-11 18:35:15.546284005 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: vga_other.cpp,v 1.28 2009-07-11 10:25:24 c2woody Exp $ */
 
 #include <string.h>
 #include <math.h>
@@ -84,7 +83,9 @@
 		vga.draw.cursor.eline = (Bit8u)(val&0x1f);
 		break;
 	case 0x0C:	/* Start Address High Register */
-		vga.config.display_start=(vga.config.display_start & 0x00FF) | (val << 8);
+		// Bit 12 (depending on video mode) and 13 are actually masked too,
+		// but so far no need to implement it.
+		vga.config.display_start=(vga.config.display_start & 0x00FF) | ((val&0x3F) << 8);
 		break;
 	case 0x0D:	/* Start Address Low Register */
 		vga.config.display_start=(vga.config.display_start & 0xFF00) | val;
@@ -153,7 +154,31 @@
 	return (Bitu)(~0);
 }
 
+static void write_lightpen(Bitu port,Bitu val,Bitu) {
+	switch (port) {
+	case 0x3db:	// Clear lightpen latch
+		vga.other.lightpen_triggered = false;
+		break;
+	case 0x3dc:	// Preset lightpen latch
+		if (!vga.other.lightpen_triggered) {
+			vga.other.lightpen_triggered = true; // TODO: this shows at port 3ba/3da bit 1
+			
+			double timeInFrame = PIC_FullIndex()-vga.draw.delay.framestart;
+			double timeInLine = fmod(timeInFrame,vga.draw.delay.htotal);
+			Bitu current_scanline = (Bitu)(timeInFrame / vga.draw.delay.htotal);
+			
+			vga.other.lightpen = (Bit16u)((vga.draw.address_add/2) * (current_scanline/2));
+			vga.other.lightpen += (Bit16u)((timeInLine / vga.draw.delay.hdend) *
+				((float)(vga.draw.address_add/2)));
+		}
+		break;
+	}
+}
+
 static double hue_offset = 0.0;
+static Bit8u cga_comp = 0;
+static bool new_cga = 0;
+
 static Bit8u cga16_val = 0;
 static void update_cga16_color(void);
 static Bit8u herc_pal = 0;
@@ -164,57 +189,151 @@
 }
 
 static void update_cga16_color(void) {
-// Algorithm provided by NewRisingSun
-// His/Her algorithm is more complex and gives better results than the one below
-// However that algorithm doesn't fit in our vga pallette.
-// Therefore a simple variant is used, but the colours are bit lighter.
-
-// It uses an avarage over the bits to give smooth transitions from colour to colour
-// This is represented by the j variable. The i variable gives the 16 colours
-// The draw handler calculates the needed avarage and combines this with the colour
-// to match an entry that is generated here.
-
-	int baseR=0, baseG=0, baseB=0;
-	double sinhue,coshue,hue,basehue = 50.0;
-	double I,Q,Y,pixelI,pixelQ,R,G,B;
-	Bitu colorBit1,colorBit2,colorBit3,colorBit4,index;
-
-	if (cga16_val & 0x01) baseB += 0xa8;
-	if (cga16_val & 0x02) baseG += 0xa8;
-	if (cga16_val & 0x04) baseR += 0xa8;
-	if (cga16_val & 0x08) { baseR += 0x57; baseG += 0x57; baseB += 0x57; }
-	if (cga16_val & 0x20) basehue = 35.0;
-
-	hue = (basehue + hue_offset)*0.017453239;
-	sinhue = sin(hue);
-	coshue = cos(hue);
-
-	for(Bitu i = 0; i < 16;i++) {
-		for(Bitu j = 0;j < 5;j++) {
-			index = 0x80|(j << 4)|i; //use upperpart of vga pallette
-			colorBit4 = (i&1)>>0;
-			colorBit3 = (i&2)>>1;
-			colorBit2 = (i&4)>>2;
-			colorBit1 = (i&8)>>3;
-
-			//calculate lookup table
-			I = 0; Q = 0;
-			I += (double) colorBit1;
-			Q += (double) colorBit2;
-			I -= (double) colorBit3;
-			Q -= (double) colorBit4;
-			Y  = (double) j / 4.0; //calculated avarage is over 4 bits
-
-			pixelI = I * 1.0 / 3.0; //I* tvSaturnation / 3.0
-			pixelQ = Q * 1.0 / 3.0; //Q* tvSaturnation / 3.0
-			I = pixelI*coshue + pixelQ*sinhue;
-			Q = pixelQ*coshue - pixelI*sinhue;
-
-			R = Y + 0.956*I + 0.621*Q; if (R < 0.0) R = 0.0; if (R > 1.0) R = 1.0;
-			G = Y - 0.272*I - 0.647*Q; if (G < 0.0) G = 0.0; if (G > 1.0) G = 1.0;
-			B = Y - 1.105*I + 1.702*Q; if (B < 0.0) B = 0.0; if (B > 1.0) B = 1.0;
+// New algorithm based on code by reenigne
+// Works in all CGA graphics modes/color settings and can simulate older and newer CGA revisions
+	static const double tau = 6.28318531; // == 2*pi
+	static const double ns = 567.0/440;  // degrees of hue shift per nanosecond
+
+	double tv_brightness = 0.0; // hardcoded for simpler implementation
+	double tv_saturation = (new_cga ? 0.7 : 0.6);
+
+	bool bw = (vga.tandy.mode_control&4) != 0;
+	bool color_sel = (cga16_val&0x20) != 0;
+	bool background_i = (cga16_val&0x10) != 0;	// Really foreground intensity, but this is what the CGA schematic calls it.
+	bool bpp1 = (vga.tandy.mode_control&0x10) != 0;
+	Bit8u overscan = cga16_val&0x0f;  // aka foreground colour in 1bpp mode
+
+	double chroma_coefficient = new_cga ? 0.29 : 0.72;
+	double b_coefficient = new_cga ? 0.07 : 0;
+	double g_coefficient = new_cga ? 0.22 : 0;
+	double r_coefficient = new_cga ? 0.1 : 0;
+	double i_coefficient = new_cga ? 0.32 : 0.28;
+	double rgbi_coefficients[0x10];
+	for (int c = 0; c < 0x10; c++) {
+		double v = 0;
+		if ((c & 1) != 0)
+			v += b_coefficient;
+		if ((c & 2) != 0)
+			v += g_coefficient;
+		if ((c & 4) != 0)
+			v += r_coefficient;
+		if ((c & 8) != 0)
+			v += i_coefficient;
+		rgbi_coefficients[c] = v;
+	}
+
+	// The pixel clock delay calculation is not accurate for 2bpp, but the difference is small and a more accurate calculation would be too slow.
+	static const double rgbi_pixel_delay = 15.5*ns;
+	static const double chroma_pixel_delays[8] = {
+		0,        // Black:   no chroma
+		35*ns,    // Blue:    no XORs
+		44.5*ns,  // Green:   XOR on rising and falling edges
+		39.5*ns,  // Cyan:    XOR on falling but not rising edge
+		44.5*ns,  // Red:     XOR on rising and falling edges
+		39.5*ns,  // Magenta: XOR on falling but not rising edge
+		44.5*ns,  // Yellow:  XOR on rising and falling edges
+		39.5*ns}; // White:   XOR on falling but not rising edge
+	double pixel_clock_delay;
+	int o = overscan == 0 ? 15 : overscan;
+	if (overscan == 8)
+		pixel_clock_delay = rgbi_pixel_delay;
+	else {
+		double d = rgbi_coefficients[o];
+		pixel_clock_delay = (chroma_pixel_delays[o & 7]*chroma_coefficient + rgbi_pixel_delay*d)/(chroma_coefficient + d);
+	}
+	pixel_clock_delay -= 21.5*ns;  // correct for delay of color burst
+
+	double hue_adjust = (-(90-33)-hue_offset+pixel_clock_delay)*tau/360.0;
+	double chroma_signals[8][4];
+	for (Bit8u i=0; i<4; i++) {
+		chroma_signals[0][i] = 0;
+		chroma_signals[7][i] = 1;
+		for (Bit8u j=0; j<6; j++) {
+			static const double phases[6] = {
+				270 - 21.5*ns,  // blue
+				135 - 29.5*ns,  // green
+				180 - 21.5*ns,  // cyan
+				  0 - 21.5*ns,  // red
+				315 - 29.5*ns,  // magenta
+				 90 - 21.5*ns}; // yellow/burst
+			// All the duty cycle fractions are the same, just under 0.5 as the rising edge is delayed 2ns more than the falling edge.
+			static const double duty = 0.5 - 2*ns/360.0;
+
+			// We have a rectangle wave with period 1 (in units of the reciprocal of the color burst frequency) and duty
+			// cycle fraction "duty" and phase "phase". We band-limit this wave to frequency 2 and sample it at intervals of 1/4.
+			// We model our band-limited wave with 4 frequency components:
+			//   f(x) = a + b*sin(x*tau) + c*cos(x*tau) + d*sin(x*2*tau)
+			// Then:
+			//   a =   integral(0, 1, f(x)*dx) = duty
+			//   b = 2*integral(0, 1, f(x)*sin(x*tau)*dx) = 2*integral(0, duty, sin(x*tau)*dx) = 2*(1-cos(x*tau))/tau
+			//   c = 2*integral(0, 1, f(x)*cos(x*tau)*dx) = 2*integral(0, duty, cos(x*tau)*dx) = 2*sin(duty*tau)/tau
+			//   d = 2*integral(0, 1, f(x)*sin(x*2*tau)*dx) = 2*integral(0, duty, sin(x*4*pi)*dx) = 2*(1-cos(2*tau*duty))/(2*tau)
+			double a = duty;
+			double b = 2.0*(1.0-cos(duty*tau))/tau;
+			double c = 2.0*sin(duty*tau)/tau;
+			double d = 2.0*(1.0-cos(duty*2*tau))/(2*tau);
+
+			double x = (phases[j] + 21.5*ns + pixel_clock_delay)/360.0 + i/4.0;
 
-			RENDER_SetPal((Bit8u)index,static_cast<Bit8u>(R*baseR),static_cast<Bit8u>(G*baseG),static_cast<Bit8u>(B*baseB));
+			chroma_signals[j+1][i] = a + b*sin(x*tau) + c*cos(x*tau) + d*sin(x*2*tau);
+		}
+	}
+	Bitu CGApal[4] = {
+		overscan,
+		2 + (color_sel||bw ? 1 : 0) + (background_i ? 8 : 0),
+		4 + (color_sel&&!bw? 1 : 0) + (background_i ? 8 : 0),
+		6 + (color_sel||bw ? 1 : 0) + (background_i ? 8 : 0)
+	};
+	for (Bit8u x=0; x<4; x++) {	 // Position of pixel in question
+		bool even = (x & 1) == 0;
+		for (Bit8u bits=0; bits<(even ? 0x10 : 0x40); ++bits) {
+			double Y=0, I=0, Q=0;
+			for (Bit8u p=0; p<4; p++) {  // Position within color carrier cycle
+				// generate pixel pattern.
+				Bit8u rgbi;
+				if (bpp1)
+					rgbi = ((bits >> (3-p)) & (even ? 1 : 2)) != 0 ? overscan : 0;
+				else
+					if (even)
+						rgbi = CGApal[(bits >> (2-(p&2)))&3];
+					else
+						rgbi = CGApal[(bits >> (4-((p+1)&6)))&3];
+				Bit8u c = rgbi & 7;
+				if (bw && c != 0)
+					c = 7;
+
+				// calculate composite output
+				double chroma = chroma_signals[c][(p+x)&3]*chroma_coefficient;
+				double composite = chroma + rgbi_coefficients[rgbi];
+
+				Y+=composite;
+				if (!bw) { // burst on
+					I+=composite*2*cos(hue_adjust + (p+x)*tau/4.0);
+					Q+=composite*2*sin(hue_adjust + (p+x)*tau/4.0);
+				}
+			}
+
+			double contrast = 1 - tv_brightness;
+
+			Y = (contrast*Y/4.0) + tv_brightness; if (Y>1.0) Y=1.0; if (Y<0.0) Y=0.0;
+			I = (contrast*I/4.0) * tv_saturation; if (I>0.5957) I=0.5957; if (I<-0.5957) I=-0.5957;
+			Q = (contrast*Q/4.0) * tv_saturation; if (Q>0.5226) Q=0.5226; if (Q<-0.5226) Q=-0.5226;
+
+			static const double gamma = 2.2;
+
+			double R = Y + 0.9563*I + 0.6210*Q;	R = (R - 0.075) / (1-0.075); if (R<0) R=0; if (R>1) R=1;
+			double G = Y - 0.2721*I - 0.6474*Q;	G = (G - 0.075) / (1-0.075); if (G<0) G=0; if (G>1) G=1;
+			double B = Y - 1.1069*I + 1.7046*Q;	B = (B - 0.075) / (1-0.075); if (B<0) B=0; if (B>1) B=1;
+			R = pow(R, gamma);
+			G = pow(G, gamma);
+			B = pow(B, gamma);
+
+			int r = static_cast<int>(255*pow( 1.5073*R -0.3725*G -0.0832*B, 1/gamma)); if (r<0) r=0; if (r>255) r=255;
+			int g = static_cast<int>(255*pow(-0.0275*R +0.9350*G +0.0670*B, 1/gamma)); if (g<0) g=0; if (g>255) g=255;
+			int b = static_cast<int>(255*pow(-0.0272*R -0.0401*G +1.1677*B, 1/gamma)); if (b<0) b=0; if (b>255) b=255;
+
+			Bit8u index = bits | ((x & 1) == 0 ? 0x30 : 0x80) | ((x & 2) == 0 ? 0x40 : 0);
+			RENDER_SetPal(index,r,g,b);
 		}
 	}
 }
@@ -235,56 +354,159 @@
 	LOG_MSG("Hue at %f",hue_offset); 
 }
 
-static void write_color_select(Bit8u val) {
+static void write_cga_color_select(Bitu val) {
 	vga.tandy.color_select=val;
-	switch (vga.mode) {
+	switch(vga.mode) {
+	case  M_TANDY4: {
+		Bit8u base = (val & 0x10) ? 0x08 : 0;
+		Bit8u bg = val & 0xf;
+		if (vga.tandy.mode_control & 0x4)	// cyan red white
+			VGA_SetCGA4Table(bg, 3+base, 4+base, 7+base);
+		else if (val & 0x20)				// cyan magenta white
+			VGA_SetCGA4Table(bg, 3+base, 5+base, 7+base);
+		else								// green red brown
+			VGA_SetCGA4Table(bg, 2+base, 4+base, 6+base);
+		vga.tandy.border_color = bg;
+		vga.attr.overscan_color = bg;
+		break;
+	}
 	case M_TANDY2:
 		VGA_SetCGA2Table(0,val & 0xf);
-		break;
-	case M_TANDY4:
-		{
-			if ((machine==MCH_TANDY && (vga.tandy.gfx_control & 0x8)) ||
-				(machine==MCH_PCJR && (vga.tandy.mode_control==0x0b))) {
-				VGA_SetCGA4Table(0,1,2,3);
-				return;
-			}
-			Bit8u base=(val & 0x10) ? 0x08 : 0;
-			/* Check for BW Mode */
-			if (vga.tandy.mode_control & 0x4) {
-				VGA_SetCGA4Table(val & 0xf,3+base,4+base,7+base);
-			} else {
-				if (val & 0x20) VGA_SetCGA4Table(val & 0xf,3+base,5+base,7+base);
-				else VGA_SetCGA4Table(val & 0xf,2+base,4+base,6+base);
-			}
-		}
+		vga.attr.overscan_color = 0;
 		break;
 	case M_CGA16:
 		cga16_color_select(val);
 		break;
 	case M_TEXT:
-	case M_TANDY16:
+		vga.tandy.border_color = val & 0xf;
+		vga.attr.overscan_color = 0;
 		break;
 	}
 }
 
+static void write_cga(Bitu port,Bitu val,Bitu /*iolen*/) {
+	switch (port) {
+	case 0x3d8:
+		vga.tandy.mode_control=(Bit8u)val;
+		vga.attr.disabled = (val&0x8)? 0: 1; 
+		if (vga.tandy.mode_control & 0x2) {		// graphics mode
+			if (vga.tandy.mode_control & 0x10) {// highres mode
+				if (cga_comp==1 || (cga_comp==0 && !(val&0x4))) {	// composite display
+					VGA_SetMode(M_CGA16);		// composite ntsc 640x200 16 color mode
+				} else {
+					VGA_SetMode(M_TANDY2);
+				}
+			} else {							// lowres mode
+				if (cga_comp==1) {				// composite display
+					VGA_SetMode(M_CGA16);		// composite ntsc 640x200 16 color mode
+				} else {
+					VGA_SetMode(M_TANDY4);
+				}
+			}
+
+			write_cga_color_select(vga.tandy.color_select);
+		} else {
+			VGA_SetMode(M_TANDY_TEXT);
+		}
+		VGA_SetBlinking(val & 0x20);
+		break;
+	case 0x3d9: // color select
+		write_cga_color_select(val);
+		break;
+	}
+}
+
+static void CGAModel(bool pressed) {
+	if (!pressed) return;
+	new_cga = !new_cga;
+	update_cga16_color();
+	LOG_MSG("%s model CGA selected", new_cga ? "Late" : "Early");
+}
+ 
+static void Composite(bool pressed) {
+	if (!pressed) return;
+	if (++cga_comp>2) cga_comp=0;
+	LOG_MSG("Composite output: %s",(cga_comp==0)?"auto":((cga_comp==1)?"on":"off"));
+	// switch RGB and Composite if in graphics mode
+	if (vga.tandy.mode_control & 0x2)
+		write_cga(0x3d8,vga.tandy.mode_control,1);
+}
+
+static void tandy_update_palette() {
+	// TODO mask off bits if needed
+	if (machine == MCH_TANDY) {
+		switch (vga.mode) {
+		case M_TANDY2:
+			VGA_SetCGA2Table(vga.attr.palette[0],
+				vga.attr.palette[vga.tandy.color_select&0xf]);
+			break;
+		case M_TANDY4:
+			if (vga.tandy.gfx_control & 0x8) {
+				// 4-color high resolution - might be an idea to introduce M_TANDY4H
+				VGA_SetCGA4Table( // function sets both medium and highres 4color tables
+					vga.attr.palette[0], vga.attr.palette[1],
+					vga.attr.palette[2], vga.attr.palette[3]);
+			} else {
+				Bit8u color_set = 0;
+				Bit8u r_mask = 0xf;
+				if (vga.tandy.color_select & 0x10) color_set |= 8; // intensity
+				if (vga.tandy.color_select & 0x20) color_set |= 1; // Cyan Mag. White
+				if (vga.tandy.mode_control & 0x04) {			// Cyan Red White
+					color_set |= 1; 
+					r_mask &= ~1;
+				}
+				VGA_SetCGA4Table(
+					vga.attr.palette[vga.tandy.color_select&0xf],
+					vga.attr.palette[(2|color_set)& vga.tandy.palette_mask],
+					vga.attr.palette[(4|(color_set& r_mask))& vga.tandy.palette_mask],
+					vga.attr.palette[(6|color_set)& vga.tandy.palette_mask]);
+			}
+			break;
+		default:
+			break;
+		}
+	} else {
+		// PCJr
+		switch (vga.mode) {
+		case M_TANDY2:
+			VGA_SetCGA2Table(vga.attr.palette[0],vga.attr.palette[1]);
+			break;
+		case M_TANDY4:
+			VGA_SetCGA4Table(
+				vga.attr.palette[0], vga.attr.palette[1],
+				vga.attr.palette[2], vga.attr.palette[3]);
+			break;
+		default:
+			break;
+		}
+	}
+}
+
+void VGA_SetModeNow(VGAModes mode);
+
 static void TANDY_FindMode(void) {
 	if (vga.tandy.mode_control & 0x2) {
-		if (vga.tandy.gfx_control & 0x10) 
-			VGA_SetMode(M_TANDY16);
-		else if (vga.tandy.gfx_control & 0x08) 
+		if (vga.tandy.gfx_control & 0x10) {
+			if (vga.mode==M_TANDY4) {
+				VGA_SetModeNow(M_TANDY16);
+			} else VGA_SetMode(M_TANDY16);
+		}
+		else if (vga.tandy.gfx_control & 0x08) {
 			VGA_SetMode(M_TANDY4);
+		}
 		else if (vga.tandy.mode_control & 0x10)
 			VGA_SetMode(M_TANDY2);
-		else
-			VGA_SetMode(M_TANDY4);
-		write_color_select(vga.tandy.color_select);
+		else {
+			if (vga.mode==M_TANDY16) {
+				VGA_SetModeNow(M_TANDY4);
+			} else VGA_SetMode(M_TANDY4);
+		}
+		tandy_update_palette();
 	} else {
 		VGA_SetMode(M_TANDY_TEXT);
 	}
 }
 
-void VGA_SetModeNow(VGAModes mode);
-
 static void PCJr_FindMode(void) {
 	if (vga.tandy.mode_control & 0x2) {
 		if (vga.tandy.mode_control & 0x10) {
@@ -299,7 +521,7 @@
 			if (vga.mode==M_TANDY16) VGA_SetModeNow(M_TANDY4);
 			else VGA_SetMode(M_TANDY4);
 		}
-		write_color_select(vga.tandy.color_select);
+		tandy_update_palette();
 	} else {
 		VGA_SetMode(M_TANDY_TEXT);
 	}
@@ -327,11 +549,16 @@
 			vga.tandy.mode_control=val;
 			VGA_SetBlinking(val & 0x20);
 			PCJr_FindMode();
-			vga.attr.disabled = (val&0x8)? 0: 1;
+			if (val&0x8) vga.attr.disabled &= ~1;
+			else vga.attr.disabled |= 1;
 		} else {
 			LOG(LOG_VGAMISC,LOG_NORMAL)("Unhandled Write %2X to tandy reg %X",val,vga.tandy.reg_index);
 		}
 		break;
+	case 0x1:	/* Palette mask */
+		vga.tandy.palette_mask = val;
+		tandy_update_palette();
+		break;
 	case 0x2:	/* Border color */
 		vga.tandy.border_color=val;
 		break;
@@ -348,87 +575,56 @@
 		TandyCheckLineMask();
 		VGA_SetupHandlers();
 		break;
-	case 0x8:	/* Monitor mode seletion */
-		//Bit 1 select mode e, for 640x200x16, some double clocking thing?
-		//Bit 4 select 350 line mode for hercules emulation
-		LOG(LOG_VGAMISC,LOG_NORMAL)("Write %2X to tandy monitor mode",val );
-		break;
-	/* palette colors */
-	case 0x10: case 0x11: case 0x12: case 0x13:
-	case 0x14: case 0x15: case 0x16: case 0x17:
-	case 0x18: case 0x19: case 0x1a: case 0x1b:
-	case 0x1c: case 0x1d: case 0x1e: case 0x1f:
-		VGA_ATTR_SetPalette(vga.tandy.reg_index-0x10,val & 0xf);
-		break;
-	default:		
-		LOG(LOG_VGAMISC,LOG_NORMAL)("Unhandled Write %2X to tandy reg %X",val,vga.tandy.reg_index);
-	}
-}
-
-static void write_cga(Bitu port,Bitu val,Bitu /*iolen*/) {
-	switch (port) {
-	case 0x3d8:
-		vga.tandy.mode_control=(Bit8u)val;
-		vga.attr.disabled = (val&0x8)? 0: 1; 
-		if (vga.tandy.mode_control & 0x2) {
-			if (vga.tandy.mode_control & 0x10) {
-				if (!(val & 0x4) && machine==MCH_CGA) {
-					VGA_SetMode(M_CGA16);		//Video burst 16 160x200 color mode
-				} else {
-					VGA_SetMode(M_TANDY2);
-				}
-			} else VGA_SetMode(M_TANDY4);
-			write_color_select(vga.tandy.color_select);
-		} else {
-			VGA_SetMode(M_TANDY_TEXT);
-		}
-		VGA_SetBlinking(val & 0x20);
-		break;
-	case 0x3d9:
-		write_color_select((Bit8u)val);
-		break;
+	default:
+		if ((vga.tandy.reg_index & 0xf0) == 0x10) { // color palette
+			vga.attr.palette[vga.tandy.reg_index-0x10] = val&0xf;
+			tandy_update_palette();
+		} else
+			LOG(LOG_VGAMISC,LOG_NORMAL)("Unhandled Write %2X to tandy reg %X",val,vga.tandy.reg_index);
 	}
 }
 
 static void write_tandy(Bitu port,Bitu val,Bitu /*iolen*/) {
 	switch (port) {
 	case 0x3d8:
-		vga.tandy.mode_control=(Bit8u)val;
-		TandyCheckLineMask();
-		VGA_SetBlinking(val & 0x20);
-		TANDY_FindMode();
+		val &= 0x3f; // only bits 0-6 are used
+		if (vga.tandy.mode_control ^ val) {
+			vga.tandy.mode_control=(Bit8u)val;
+			if (val&0x8) vga.attr.disabled &= ~1;
+			else vga.attr.disabled |= 1;
+			TandyCheckLineMask();
+			VGA_SetBlinking(val & 0x20);
+			TANDY_FindMode();
+			VGA_StartResize();
+		}
 		break;
 	case 0x3d9:
-		write_color_select((Bit8u)val);
+		vga.tandy.color_select=val;
+		tandy_update_palette();
 		break;
 	case 0x3da:
 		vga.tandy.reg_index=(Bit8u)val;
-		break;
-	case 0x3db:	// Clear lightpen latch
-		vga.other.lightpen_triggered = false;
-		break;
-	case 0x3dc:	// Preset lightpen latch
-		if (!vga.other.lightpen_triggered) {
-			vga.other.lightpen_triggered = true; // TODO: this shows at port 3ba/3da bit 1
-			
-			double timeInFrame = PIC_FullIndex()-vga.draw.delay.framestart;
-			double timeInLine = fmod(timeInFrame,vga.draw.delay.htotal);
-			Bitu current_scanline = (Bitu)(timeInFrame / vga.draw.delay.htotal);
-			
-			vga.other.lightpen = (Bit16u)((vga.draw.address_add/2) * (current_scanline/2));
-			vga.other.lightpen += (Bit16u)((timeInLine / vga.draw.delay.hdend) *
-				((float)(vga.draw.address_add/2)));
-		}
+		//if (val&0x10) vga.attr.disabled |= 2;
+		//else vga.attr.disabled &= ~2;
 		break;
 //	case 0x3dd:	//Extended ram page address register:
-		break;
+//		break;
 	case 0x3de:
 		write_tandy_reg((Bit8u)val);
 		break;
 	case 0x3df:
+		// CRT/processor page register
+		// See the comments on the PCJr version of this register.
+		// A difference to it is:
+		// Bit 3-5: Processor page CPU_PG
+		// The remapped range is 32kB instead of 16. Therefore CPU_PG bit 0
+		// appears to be ORed with CPU A14 (to preserve some sort of
+		// backwards compatibility?), resulting in odd pages being mapped
+		// as 2x16kB. Implemeted in vga_memory.cpp Tandy handler.
+
 		vga.tandy.line_mask = (Bit8u)(val >> 6);
 		vga.tandy.draw_bank = val & ((vga.tandy.line_mask&2) ? 0x6 : 0x7);
-		vga.tandy.mem_bank = (val >> 3) & ((vga.tandy.line_mask&2) ? 0x6 : 0x7);
+		vga.tandy.mem_bank = (val >> 3) & 7;
 		TandyCheckLineMask();
 		VGA_SetupHandlers();
 		break;
@@ -437,18 +633,49 @@
 
 static void write_pcjr(Bitu port,Bitu val,Bitu /*iolen*/) {
 	switch (port) {
-	case 0x3d9:
-		write_color_select((Bit8u)val);
-		break;
 	case 0x3da:
 		if (vga.tandy.pcjr_flipflop) write_tandy_reg((Bit8u)val);
-		else vga.tandy.reg_index=(Bit8u)val;
+		else {
+			vga.tandy.reg_index=(Bit8u)val;
+			if (vga.tandy.reg_index & 0x10)
+				vga.attr.disabled |= 2;
+			else vga.attr.disabled &= ~2;
+		}
 		vga.tandy.pcjr_flipflop=!vga.tandy.pcjr_flipflop;
 		break;
 	case 0x3df:
+		// CRT/processor page register
+		
+		// Bit 0-2: CRT page PG0-2
+		// In one- and two bank modes, bit 0-2 select the 16kB memory
+		// area of system RAM that is displayed on the screen.
+		// In 4-banked modes, bit 1-2 select the 32kB memory area.
+		// Bit 2 only has effect when the PCJR upgrade to 128k is installed.
+		
+		// Bit 3-5: Processor page CPU_PG
+		// Selects the 16kB area of system RAM that is mapped to
+		// the B8000h IBM PC video memory window. Since A14-A16 of the 
+		// processor are unconditionally replaced with these bits when
+		// B8000h is accessed, the 16kB area is mapped to the 32kB
+		// range twice in a row. (Scuba Venture writes across the boundary)
+		
+		// Bit 6-7: Video Address mode
+		// 0: CRTC addresses A0-12 directly, accessing 8k characters
+		//    (+8k attributes). Used in text modes (one bank).
+		//    PG0-2 in effect. 16k range.
+		// 1: CRTC A12 is replaced with CRTC RA0 (see max_scanline).
+		//    This results in the even/odd scanline two bank system.
+		//    PG0-2 in effect. 16k range.
+		// 2: Documented as unused. CRTC addresses A0-12, PG0 is replaced
+		//    with RA1. Looks like nonsense.
+		//    PG1-2 in effect. 32k range which cannot be used completely.
+		// 3: CRTC A12 is replaced with CRTC RA0, PG0 is replaced with
+		//    CRTC RA1. This results in the 4-bank mode.
+		//    PG1-2 in effect. 32k range.
+
 		vga.tandy.line_mask = (Bit8u)(val >> 6);
 		vga.tandy.draw_bank = val & ((vga.tandy.line_mask&2) ? 0x6 : 0x7);
-		vga.tandy.mem_bank = (val >> 3) & ((vga.tandy.line_mask&2) ? 0x6 : 0x7);
+		vga.tandy.mem_bank = (val >> 3) & 7;
 		vga.tandy.draw_base = &MemBase[vga.tandy.draw_bank * 16 * 1024];
 		vga.tandy.mem_base = &MemBase[vga.tandy.mem_bank * 16 * 1024];
 		TandyCheckLineMask();
@@ -516,7 +743,12 @@
 		break;
 		}
 	case 0x3bf:
-		vga.herc.enable_bits=(Bit8u)val;
+		if ( vga.herc.enable_bits ^ val) {
+			vga.herc.enable_bits=val;
+			// Bit 1 enables the upper 32k of video memory,
+			// so update the handlers
+			VGA_SetupHandlers();
+		}
 		break;
 	}
 }
@@ -572,6 +804,10 @@
 		for (i=0;i<256;i++)	memcpy(&vga.draw.font[i*32],&int10_font_08[i*8],8);
 		vga.draw.font_tables[0]=vga.draw.font_tables[1]=vga.draw.font;
 	}
+	if (machine==MCH_CGA || IS_TANDY_ARCH || machine==MCH_HERC) {
+		IO_RegisterWriteHandler(0x3db,write_lightpen,IO_MB);
+		IO_RegisterWriteHandler(0x3dc,write_lightpen,IO_MB);
+	}
 	if (machine==MCH_HERC) {
 		extern Bit8u int10_font_14[256 * 14];
 		for (i=0;i<256;i++)	memcpy(&vga.draw.font[i*32],&int10_font_14[i*14],14);
@@ -581,25 +817,27 @@
 	if (machine==MCH_CGA) {
 		IO_RegisterWriteHandler(0x3d8,write_cga,IO_MB);
 		IO_RegisterWriteHandler(0x3d9,write_cga,IO_MB);
-		IO_RegisterWriteHandler(0x3db,write_tandy,IO_MB);
-		IO_RegisterWriteHandler(0x3dc,write_tandy,IO_MB);
 		MAPPER_AddHandler(IncreaseHue,MK_f11,MMOD2,"inchue","Inc Hue");
 		MAPPER_AddHandler(DecreaseHue,MK_f11,0,"dechue","Dec Hue");
+		MAPPER_AddHandler(CGAModel,MK_f11,MMOD1|MMOD2,"cgamodel","CGA Model");
+		MAPPER_AddHandler(Composite,MK_f12,0,"cgacomp","CGA Comp");
 	}
 	if (machine==MCH_TANDY) {
 		write_tandy( 0x3df, 0x0, 0 );
 		IO_RegisterWriteHandler(0x3d8,write_tandy,IO_MB);
 		IO_RegisterWriteHandler(0x3d9,write_tandy,IO_MB);
+		IO_RegisterWriteHandler(0x3da,write_tandy,IO_MB);
 		IO_RegisterWriteHandler(0x3de,write_tandy,IO_MB);
 		IO_RegisterWriteHandler(0x3df,write_tandy,IO_MB);
-		IO_RegisterWriteHandler(0x3da,write_tandy,IO_MB);
 	}
 	if (machine==MCH_PCJR) {
 		//write_pcjr will setup base address
 		write_pcjr( 0x3df, 0x7 | (0x7 << 3), 0 );
-		IO_RegisterWriteHandler(0x3d9,write_pcjr,IO_MB);
 		IO_RegisterWriteHandler(0x3da,write_pcjr,IO_MB);
 		IO_RegisterWriteHandler(0x3df,write_pcjr,IO_MB);
+		// additional CRTC access documented
+		IO_RegisterWriteHandler(0x3d0,write_crtc_index_other,IO_MB);
+		IO_RegisterWriteHandler(0x3d1,write_crtc_data_other,IO_MB);
 	}
 	if (machine==MCH_HERC) {
 		Bitu base=0x3b0;
diff -Nur dosbox-0.74/src/hardware/vga_paradise.cpp dosbox-0.74.patch/src/hardware/vga_paradise.cpp
--- dosbox-0.74/src/hardware/vga_paradise.cpp	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/hardware/vga_paradise.cpp	2016-12-11 18:35:15.546284005 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: vga_paradise.cpp,v 1.4 2009-05-27 09:15:41 qbix79 Exp $ */
 
 #include "dosbox.h"
 #include "setup.h"
diff -Nur dosbox-0.74/src/hardware/vga_s3.cpp dosbox-0.74.patch/src/hardware/vga_s3.cpp
--- dosbox-0.74/src/hardware/vga_s3.cpp	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/hardware/vga_s3.cpp	2016-12-11 18:35:15.546284005 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: vga_s3.cpp,v 1.18 2009-03-15 11:28:35 c2woody Exp $ */
 
 #include "dosbox.h"
 #include "inout.h"
@@ -342,7 +341,7 @@
 		vga.svga.bank_write = vga.svga.bank_read;
 		VGA_SetupHandlers();
 		break;
-	case 0x6b:	// BIOS scratchpad: LFB adress
+	case 0x6b:	// BIOS scratchpad: LFB address
 		vga.s3.reg_6b=(Bit8u)val;
 		break;
 	default:
diff -Nur dosbox-0.74/src/hardware/vga_seq.cpp dosbox-0.74.patch/src/hardware/vga_seq.cpp
--- dosbox-0.74/src/hardware/vga_seq.cpp	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/hardware/vga_seq.cpp	2016-12-11 18:35:15.546284005 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: vga_seq.cpp,v 1.24 2009-05-27 09:15:41 qbix79 Exp $ */
 
 #include "dosbox.h"
 #include "inout.h"
diff -Nur dosbox-0.74/src/hardware/vga_tseng.cpp dosbox-0.74.patch/src/hardware/vga_tseng.cpp
--- dosbox-0.74/src/hardware/vga_tseng.cpp	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/hardware/vga_tseng.cpp	2016-12-11 18:35:15.546284005 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: vga_tseng.cpp,v 1.5 2009-05-27 09:15:41 qbix79 Exp $ */
 
 
 #include "dosbox.h"
diff -Nur dosbox-0.74/src/hardware/vga_xga.cpp dosbox-0.74.patch/src/hardware/vga_xga.cpp
--- dosbox-0.74/src/hardware/vga_xga.cpp	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/hardware/vga_xga.cpp	2016-12-11 18:35:15.546284005 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: vga_xga.cpp,v 1.17 2009-05-27 09:15:41 qbix79 Exp $ */
 
 #include <string.h>
 #include "dosbox.h"
diff -Nur dosbox-0.74/src/ints/bios.cpp dosbox-0.74.patch/src/ints/bios.cpp
--- dosbox-0.74/src/ints/bios.cpp	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/ints/bios.cpp	2016-12-11 18:35:15.546284005 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: bios.cpp,v 1.78 2009-10-10 13:26:46 h-a-l-9000 Exp $ */
 
 #include "dosbox.h"
 #include "mem.h"
@@ -27,10 +26,13 @@
 #include "inout.h"
 #include "pic.h"
 #include "hardware.h"
+#include "pci_bus.h"
 #include "joystick.h"
 #include "mouse.h"
 #include "setup.h"
 #include "serialport.h"
+#include <time.h>
+#include <sys/timeb.h>
 
 
 /* if mem_systems 0 then size_extended is reported as the real size else 
@@ -312,7 +314,8 @@
 	case 0x00:	/* Get System time */
 		{
 			Bit32u ticks=mem_readd(BIOS_TIMER);
-			reg_al=0;		/* Midnight never passes :) */
+			reg_al=mem_readb(BIOS_24_HOURS_FLAG);
+			mem_writeb(BIOS_24_HOURS_FLAG,0); // reset the "flag"
 			reg_cx=(Bit16u)(ticks >> 16);
 			reg_dx=(Bit16u)(ticks & 0xffff);
 			break;
@@ -352,8 +355,120 @@
 		TandyDAC_Handler(reg_ah);
 		break;
 	case 0xb1:		/* PCI Bios Calls */
-		LOG(LOG_BIOS,LOG_ERROR)("INT1A:PCI bios call %2X",reg_al);
+		LOG(LOG_BIOS,LOG_WARN)("INT1A:PCI bios call %2X",reg_al);
+#if defined(PCI_FUNCTIONALITY_ENABLED)
+		switch (reg_al) {
+			case 0x01:	// installation check
+				if (PCI_IsInitialized()) {
+					reg_ah=0x00;
+					reg_al=0x01;	// cfg space mechanism 1 supported
+					reg_bx=0x0210;	// ver 2.10
+					reg_cx=0x0000;	// only one PCI bus
+					reg_edx=0x20494350;
+					reg_edi=PCI_GetPModeInterface();
+					CALLBACK_SCF(false);
+				} else {
+					CALLBACK_SCF(true);
+				}
+				break;
+			case 0x02: {	// find device
+				Bitu devnr=0;
+				Bitu count=0x100;
+				Bit32u devicetag=(reg_cx<<16)|reg_dx;
+				Bits found=-1;
+				for (Bitu i=0; i<=count; i++) {
+					IO_WriteD(0xcf8,0x80000000|(i<<8));	// query unique device/subdevice entries
+					if (IO_ReadD(0xcfc)==devicetag) {
+						if (devnr==reg_si) {
+							found=i;
+							break;
+						} else {
+							// device found, but not the SIth device
+							devnr++;
+						}
+					}
+				}
+				if (found>=0) {
+					reg_ah=0x00;
+					reg_bh=0x00;	// bus 0
+					reg_bl=(Bit8u)(found&0xff);
+					CALLBACK_SCF(false);
+				} else {
+					reg_ah=0x86;	// device not found
+					CALLBACK_SCF(true);
+				}
+				}
+				break;
+			case 0x03: {	// find device by class code
+				Bitu devnr=0;
+				Bitu count=0x100;
+				Bit32u classtag=reg_ecx&0xffffff;
+				Bits found=-1;
+				for (Bitu i=0; i<=count; i++) {
+					IO_WriteD(0xcf8,0x80000000|(i<<8));	// query unique device/subdevice entries
+					if (IO_ReadD(0xcfc)!=0xffffffff) {
+						IO_WriteD(0xcf8,0x80000000|(i<<8)|0x08);
+						if ((IO_ReadD(0xcfc)>>8)==classtag) {
+							if (devnr==reg_si) {
+								found=i;
+								break;
+							} else {
+								// device found, but not the SIth device
+								devnr++;
+							}
+						}
+					}
+				}
+				if (found>=0) {
+					reg_ah=0x00;
+					reg_bh=0x00;	// bus 0
+					reg_bl=(Bit8u)(found&0xff);
+					CALLBACK_SCF(false);
+				} else {
+					reg_ah=0x86;	// device not found
+					CALLBACK_SCF(true);
+				}
+				}
+				break;
+			case 0x08:	// read configuration byte
+				IO_WriteD(0xcf8,0x80000000|(reg_bx<<8)|(reg_di&0xfc));
+				reg_cl=IO_ReadB(0xcfc+(reg_di&3));
+				CALLBACK_SCF(false);
+				break;
+			case 0x09:	// read configuration word
+				IO_WriteD(0xcf8,0x80000000|(reg_bx<<8)|(reg_di&0xfc));
+				reg_cx=IO_ReadW(0xcfc+(reg_di&2));
+				CALLBACK_SCF(false);
+				break;
+			case 0x0a:	// read configuration dword
+				IO_WriteD(0xcf8,0x80000000|(reg_bx<<8)|(reg_di&0xfc));
+				reg_ecx=IO_ReadD(0xcfc+(reg_di&3));
+				CALLBACK_SCF(false);
+				break;
+			case 0x0b:	// write configuration byte
+				IO_WriteD(0xcf8,0x80000000|(reg_bx<<8)|(reg_di&0xfc));
+				IO_WriteB(0xcfc+(reg_di&3),reg_cl);
+				CALLBACK_SCF(false);
+				break;
+			case 0x0c:	// write configuration word
+				IO_WriteD(0xcf8,0x80000000|(reg_bx<<8)|(reg_di&0xfc));
+				IO_WriteW(0xcfc+(reg_di&2),reg_cx);
+				CALLBACK_SCF(false);
+				break;
+			case 0x0d:	// write configuration dword
+				IO_WriteD(0xcf8,0x80000000|(reg_bx<<8)|(reg_di&0xfc));
+				IO_WriteD(0xcfc+(reg_di&3),reg_ecx);
+				CALLBACK_SCF(false);
+				break;
+			default:
+				LOG(LOG_BIOS,LOG_ERROR)("INT1A:PCI BIOS: unknown function %x (%x %x %x)",
+					reg_ax,reg_bx,reg_cx,reg_dx);
+				CALLBACK_SCF(true);
+				break;
+		}
+#else
 		CALLBACK_SCF(true);
+#endif
 		break;
 	default:
 		LOG(LOG_BIOS,LOG_ERROR)("INT1A:Undefined call %2X",reg_ah);
@@ -372,9 +487,45 @@
 #ifndef DOSBOX_CLOCKSYNC
 #define DOSBOX_CLOCKSYNC 0
 #endif
+
+static void BIOS_HostTimeSync() {
+	/* Setup time and date */
+	struct timeb timebuffer;
+	ftime(&timebuffer);
+	
+	struct tm *loctime;
+	loctime = localtime (&timebuffer.time);
+
+	/*
+	loctime->tm_hour = 23;
+	loctime->tm_min = 59;
+	loctime->tm_sec = 45;
+	loctime->tm_mday = 28;
+	loctime->tm_mon = 2-1;
+	loctime->tm_year = 2007 - 1900;
+	*/
+
+	dos.date.day=(Bit8u)loctime->tm_mday;
+	dos.date.month=(Bit8u)loctime->tm_mon+1;
+	dos.date.year=(Bit16u)loctime->tm_year+1900;
+
+	Bit32u ticks=(Bit32u)(((double)(
+		loctime->tm_hour*3600*1000+
+		loctime->tm_min*60*1000+
+		loctime->tm_sec*1000+
+		timebuffer.millitm))*(((double)PIT_TICK_RATE/65536.0)/1000.0));
+	mem_writed(BIOS_TIMER,ticks);
+}
+
 static Bitu INT8_Handler(void) {
 	/* Increase the bios tick counter */
 	Bit32u value = mem_readd(BIOS_TIMER) + 1;
+	if(value >= 0x1800B0) {
+		// time wrap at midnight
+		mem_writeb(BIOS_24_HOURS_FLAG,mem_readb(BIOS_24_HOURS_FLAG)+1);
+		value=0;
+	}
+
 #if DOSBOX_CLOCKSYNC
 	static bool check = false;
 	if((value %50)==0) {
@@ -434,18 +585,16 @@
 	return CBRET_NONE;
 }
 
-static Bit8u INT14_Wait(Bit16u port, Bit8u mask, Bit8u timeout) {
+static bool INT14_Wait(Bit16u port, Bit8u mask, Bit8u timeout, Bit8u* retval) {
 	double starttime = PIC_FullIndex();
 	double timeout_f = timeout * 1000.0;
-	Bit8u retval;
-	while (((retval = IO_ReadB(port)) & mask) != mask) {
+	while (((*retval = IO_ReadB(port)) & mask) != mask) {
 		if (starttime < (PIC_FullIndex() - timeout_f)) {
-			retval |= 0x80;
-			break;
+			return false;
 		}
 		CALLBACK_Idle();
 	}
-	return retval;
+	return true;
 }
 
 static Bitu INT14_Handler(void) {
@@ -500,7 +649,7 @@
 		CALLBACK_SCF(false);
 		break;
 	}
-	case 0x01: { // Transmit character
+	case 0x01: // Transmit character
 		// Parameters:				Return:
 		// AL: character			AL: unchanged
 		// AH: 0x01					AH: line status from just before the char was sent
@@ -510,20 +659,19 @@
 
 		// set DTR & RTS on
 		IO_WriteB(port+4,0x3);
-
 		// wait for DSR & CTS
-		reg_ah = INT14_Wait(port+6, 0x30, timeout);
-		if (!(reg_ah & 0x80)) {
+		if (INT14_Wait(port+6, 0x30, timeout, &reg_ah)) {
 			// wait for TX buffer empty
-			reg_ah = INT14_Wait(port+5, 0x20, timeout);
-			if (!(reg_ah & 0x80)) {
+			if (INT14_Wait(port+5, 0x20, timeout, &reg_ah)) {
 				// fianlly send the character
 				IO_WriteB(port,reg_al);
-			}
-		} // else timed out
+			} else
+				reg_ah |= 0x80;
+		} else // timed out
+			reg_ah |= 0x80;
+
 		CALLBACK_SCF(false);
 		break;
-	}
 	case 0x02: // Read character
 		// Parameters:				Return:
 		// AH: 0x02					AL: received character
@@ -537,15 +685,16 @@
 		IO_WriteB(port+4,0x1);
 
 		// wait for DSR
-		reg_ah = INT14_Wait(port+6, 0x20, timeout);
-		if (!(reg_ah & 0x80)) {
+		if (INT14_Wait(port+6, 0x20, timeout, &reg_ah)) {
 			// wait for character to arrive
-			reg_ah = INT14_Wait(port+5, 0x01, timeout);
-			if (!(reg_ah & 0x80)) {
+			if (INT14_Wait(port+5, 0x01, timeout, &reg_ah)) {
 				reg_ah &= 0x1E;
 				reg_al = IO_ReadB(port);
-			}
-		}
+			} else
+				reg_ah |= 0x80;
+		} else
+			reg_ah |= 0x80;
+
 		CALLBACK_SCF(false);
 		break;
 	case 0x03: // get status
@@ -678,6 +827,7 @@
 				CALLBACK_Idle();
 			}
 			CALLBACK_SCF(false);
+			break;
 		}
 	case 0x87:	/* Copy extended memory */
 		{
@@ -847,14 +997,14 @@
 		CALLBACK_Setup(call_irq0,INT8_Handler,CB_IRQ0,Real2Phys(BIOS_DEFAULT_IRQ0_LOCATION),"IRQ 0 Clock");
 		RealSetVec(0x08,BIOS_DEFAULT_IRQ0_LOCATION);
 		// pseudocode for CB_IRQ0:
+		//	sti
 		//	callback INT8_Handler
-		//	push ax,dx,ds
+		//	push ds,ax,dx
 		//	int 0x1c
 		//	cli
-		//	pop ds,dx
 		//	mov al, 0x20
 		//	out 0x20, al
-		//	pop ax
+		//	pop dx,ax,ds
 		//	iret
 
 		mem_writed(BIOS_TIMER,0);			//Calculate the correct time
@@ -869,7 +1019,7 @@
 		if (IS_TANDY_ARCH) {
 			/* reduce reported memory size for the Tandy (32k graphics memory
 			   at the end of the conventional 640k) */
-			if (machine==MCH_TANDY) mem_writew(BIOS_MEMORY_SIZE,608);
+			if (machine==MCH_TANDY) mem_writew(BIOS_MEMORY_SIZE,624);
 			else mem_writew(BIOS_MEMORY_SIZE,640);
 			mem_writew(BIOS_TRUE_MEMORY_SIZE,640);
 		} else mem_writew(BIOS_MEMORY_SIZE,640);
@@ -909,14 +1059,29 @@
 		callback[9].Set_RealVec(0x71);
 
 		/* Reboot */
+		// This handler is an exit for more than only reboots, since we
+		// don't handle these cases
 		callback[10].Install(&Reboot_Handler,CB_IRET,"reboot");
+		
+		// INT 18h: Enter BASIC
+		// Non-IBM BIOS would display "NO ROM BASIC" here
 		callback[10].Set_RealVec(0x18);
 		RealPt rptr = callback[10].Get_RealPointer();
+
+		// INT 19h: Boot function
+		// This is not a complete reboot as it happens after the POST
+		// We don't handle it, so use the reboot function as exit.
 		RealSetVec(0x19,rptr);
-		// set system BIOS entry point too
-		phys_writeb(0xFFFF0,0xEA);	// FARJMP
-		phys_writew(0xFFFF1,RealOff(rptr));	// offset
-		phys_writew(0xFFFF3,RealSeg(rptr));	// segment
+
+		// The farjump at the processor reset entry point (jumps to POST routine)
+		phys_writeb(0xFFFF0,0xEA);		// FARJMP
+		phys_writew(0xFFFF1,RealOff(BIOS_DEFAULT_RESET_LOCATION));	// offset
+		phys_writew(0xFFFF3,RealSeg(BIOS_DEFAULT_RESET_LOCATION));	// segment
+
+		// Compatible POST routine location: jump to the callback
+		phys_writeb(Real2Phys(BIOS_DEFAULT_RESET_LOCATION)+0,0xEA);				// FARJMP
+		phys_writew(Real2Phys(BIOS_DEFAULT_RESET_LOCATION)+1,RealOff(rptr));	// offset
+		phys_writew(Real2Phys(BIOS_DEFAULT_RESET_LOCATION)+3,RealSeg(rptr));	// segment
 
 		/* Irq 2 */
 		Bitu call_irq2=CALLBACK_Allocate();	
@@ -1078,6 +1243,7 @@
 		size_extended=IO_Read(0x71);
 		IO_Write(0x70,0x31);
 		size_extended|=(IO_Read(0x71) << 8);
+		BIOS_HostTimeSync();
 	}
 	~BIOS(){
 		/* abort DAC playing */
diff -Nur dosbox-0.74/src/ints/bios_disk.cpp dosbox-0.74.patch/src/ints/bios_disk.cpp
--- dosbox-0.74/src/ints/bios_disk.cpp	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/ints/bios_disk.cpp	2016-12-11 18:35:15.546284005 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,11 +16,11 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: bios_disk.cpp,v 1.40 2009-08-23 17:24:54 c2woody Exp $ */
 
 #include "dosbox.h"
 #include "callback.h"
 #include "bios.h"
+#include "bios_disk.h"
 #include "regs.h"
 #include "mem.h"
 #include "dos_inc.h" /* for Drives[] */
@@ -86,13 +86,26 @@
 	}
 }
 
+void incrementFDD(void) {
+	Bit16u equipment=mem_readw(BIOS_CONFIGURATION);
+	if(equipment&1) {
+		Bitu numofdisks = (equipment>>6)&3;
+		numofdisks++;
+		if(numofdisks > 1) numofdisks=1;//max 2 floppies at the moment
+		equipment&=~0x00C0;
+		equipment|=(numofdisks<<6);
+	} else equipment|=1;
+	mem_writew(BIOS_CONFIGURATION,equipment);
+	CMOS_SetRegister(0x14, (Bit8u)(equipment&0xff));
+}
+
 void swapInDisks(void) {
 	bool allNull = true;
 	Bits diskcount = 0;
 	Bits swapPos = swapPosition;
 	int i;
 
-	/* Check to make sure there's atleast one setup image */
+	/* Check to make sure that  there is at least one setup image */
 	for(i=0;i<MAX_SWAPPABLE_DISKS;i++) {
 		if(diskSwap[i]!=NULL) {
 			allNull = false;
@@ -150,8 +163,9 @@
 
 	bytenum = sectnum * sector_size;
 
-	fseek(diskimg,bytenum,SEEK_SET);
-	fread(data, 1, sector_size, diskimg);
+	if (bytenum!=current_fpos) fseek(diskimg,bytenum,SEEK_SET);
+	size_t ret=fread(data, 1, sector_size, diskimg);
+	current_fpos=bytenum+ret;
 
 	return 0x00;
 }
@@ -162,7 +176,6 @@
 	sectnum = ( (cylinder * heads + head) * sectors ) + sector - 1L;
 
 	return Write_AbsoluteSector(sectnum, data);
-
 }
 
 
@@ -173,8 +186,9 @@
 
 	//LOG_MSG("Writing sectors to %ld at bytenum %d", sectnum, bytenum);
 
-	fseek(diskimg,bytenum,SEEK_SET);
+	if (bytenum!=current_fpos) fseek(diskimg,bytenum,SEEK_SET);
 	size_t ret=fwrite(data, sector_size, 1, diskimg);
+	current_fpos=bytenum+ret;
 
 	return ((ret>0)?0x00:0x05);
 
@@ -185,7 +199,9 @@
 	cylinders = 0;
 	sectors = 0;
 	sector_size = 512;
+	current_fpos = 0;
 	diskimg = imgFile;
+	fseek(diskimg,0,SEEK_SET);
 	
 	memset(diskname,0,512);
 	if(strlen((const char *)imgName) > 511) {
@@ -217,16 +233,7 @@
 		if(!founddisk) {
 			active = false;
 		} else {
-			Bit16u equipment=mem_readw(BIOS_CONFIGURATION);
-			if(equipment&1) {
-				Bitu numofdisks = (equipment>>6)&3;
-				numofdisks++;
-				if(numofdisks > 1) numofdisks=1;//max 2 floppies at the moment
-				equipment&=~0x00C0;
-				equipment|=(numofdisks<<6);
-			} else equipment|=1;
-			mem_writew(BIOS_CONFIGURATION,equipment);
-			CMOS_SetRegister(0x14, (Bit8u)(equipment&0xff));
+			incrementFDD();
 		}
 	}
 }
@@ -327,12 +334,14 @@
 				if ((machine==MCH_CGA) || (machine==MCH_PCJR)) {
 					/* those bioses call floppy drive reset for invalid drive values */
 					if (((imageDiskList[0]) && (imageDiskList[0]->active)) || ((imageDiskList[1]) && (imageDiskList[1]->active))) {
+						if (machine!=MCH_PCJR && reg_dl<0x80) reg_ip++;
 						last_status = 0x00;
 						CALLBACK_SCF(false);
 					}
 				}
 				return CBRET_NONE;
 			}
+			if (machine!=MCH_PCJR && reg_dl<0x80) reg_ip++;
 			last_status = 0x00;
 			CALLBACK_SCF(false);
 		}
@@ -494,7 +503,7 @@
 void BIOS_SetupDisks(void) {
 /* TODO Start the time correctly */
 	call_int13=CALLBACK_Allocate();	
-	CALLBACK_Setup(call_int13,&INT13_DiskHandler,CB_IRET,"Int 13 Bios disk");
+	CALLBACK_Setup(call_int13,&INT13_DiskHandler,CB_INT13,"Int 13 Bios disk");
 	RealSetVec(0x13,CALLBACK_RealPointer(call_int13));
 	int i;
 	for(i=0;i<4;i++) {
diff -Nur dosbox-0.74/src/ints/bios_keyboard.cpp dosbox-0.74.patch/src/ints/bios_keyboard.cpp
--- dosbox-0.74/src/ints/bios_keyboard.cpp	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/ints/bios_keyboard.cpp	2016-12-11 18:35:15.546284005 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: bios_keyboard.cpp,v 1.36 2009-06-11 16:05:17 c2woody Exp $ */
 
 #include "dosbox.h"
 #include "callback.h"
@@ -33,6 +32,8 @@
  * Define the following if this is the case */
 #if SDL_VERSION_ATLEAST(1, 2, 14)
 #define CAN_USE_LOCK 1
+/* For lower versions of SDL we also use a slight hack to get the startup states of numclock and capslock right.
+ * The proper way is in the mapper, but the repeating key is an unwanted side effect for lower versions of SDL */
 #endif
 
 static Bitu call_int16,call_irq1,call_irq6;
@@ -381,7 +382,7 @@
 				add_key(scan_to_scanascii[scancode].normal+0x5000);
 			} else if (flags1 &0x04) {
 				add_key((scan_to_scanascii[scancode].control&0xff00)|0xe0);
-			} else if( ((flags1 &0x3) != 0) || ((flags1 &0x20) != 0) ) {
+			} else if( ((flags1 &0x3) != 0) || ((flags1 &0x20) != 0) ) { //Due to |0xe0 results are identical. 
 				add_key((scan_to_scanascii[scancode].shift&0xff00)|0xe0);
 			} else add_key((scan_to_scanascii[scancode].normal&0xff00)|0xe0);
 			break;
@@ -392,7 +393,7 @@
 			mem_writeb(BIOS_KEYBOARD_TOKEN,token);
 		} else if (flags1 &0x04) {
 			add_key(scan_to_scanascii[scancode].control);
-		} else if( ((flags1 &0x3) != 0) || ((flags1 &0x20) != 0) ) {
+		} else if( ((flags1 &0x3) != 0) ^ ((flags1 &0x20) != 0) ) { //Xor shift and numlock (both means off)
 			add_key(scan_to_scanascii[scancode].shift);
 		} else add_key(scan_to_scanascii[scancode].normal);
 		break;
@@ -513,7 +514,7 @@
 		break;
 	case 0x01: /* CHECK FOR KEYSTROKE */
 		// enable interrupt-flag after IRET of this int16
-		mem_writew(SegPhys(ss)+reg_sp+4,(mem_readw(SegPhys(ss)+reg_sp+4) | FLAG_IF));
+		CALLBACK_SIF(true);
 		for (;;) {
 			if (check_key(temp)) {
 				if (!IsEnhancedKey(temp)) {
@@ -534,6 +535,8 @@
 		}
 		break;
 	case 0x11: /* CHECK FOR KEYSTROKE (enhanced keyboards only) */
+		// enable interrupt-flag after IRET of this int16
+		CALLBACK_SIF(true);
 		if (!check_key(temp)) {
 			CALLBACK_SZF(true);
 		} else {
@@ -545,7 +548,7 @@
 			reg_ax=temp;
 		}
 		break;
-	case 0x02:	/* GET SHIFT FlAGS */
+	case 0x02:	/* GET SHIFT FLAGS */
 		reg_al=mem_readb(BIOS_KEYBOARD_FLAGS1);
 		break;
 	case 0x03:	/* SET TYPEMATIC RATE AND DELAY */
@@ -564,8 +567,10 @@
 		else reg_al=1;
 		break;
 	case 0x12: /* GET EXTENDED SHIFT STATES */
-		reg_al=mem_readb(BIOS_KEYBOARD_FLAGS1);
-		reg_ah=mem_readb(BIOS_KEYBOARD_FLAGS2);		
+		reg_al = mem_readb(BIOS_KEYBOARD_FLAGS1);
+		reg_ah = (mem_readb(BIOS_KEYBOARD_FLAGS2)&0x73)   |
+		         ((mem_readb(BIOS_KEYBOARD_FLAGS2)&4)<<5) | // SysReq pressed, bit 7
+		         (mem_readb(BIOS_KEYBOARD_FLAGS3)&0x0c);    // Right Ctrl/Alt pressed, bits 2,3
 		break;
 	case 0x55:
 		/* Weird call used by some dos apps */
@@ -591,10 +596,15 @@
 	mem_writew(BIOS_KEYBOARD_BUFFER_HEAD,0x1e);
 	mem_writew(BIOS_KEYBOARD_BUFFER_TAIL,0x1e);
 	Bit8u flag1 = 0;
-	Bit8u leds = 16; /* Ack recieved */
-//MAPPER_Init takes care of this now ?
-//	if(startup_state_capslock) { flag1|=0x40; leds|=0x04;}
-//	if(startup_state_numlock){ flag1|=0x20; leds|=0x02;}
+	Bit8u leds = 16; /* Ack received */
+
+#if SDL_VERSION_ATLEAST(1, 2, 14)
+//Nothing, mapper handles all.
+#else
+	if (startup_state_capslock) { flag1|=0x40; leds|=0x04;}
+	if (startup_state_numlock)  { flag1|=0x20; leds|=0x02;}
+#endif
+
 	mem_writeb(BIOS_KEYBOARD_FLAGS1,flag1);
 	mem_writeb(BIOS_KEYBOARD_FLAGS2,0);
 	mem_writeb(BIOS_KEYBOARD_FLAGS3,16); /* Enhanced keyboard installed */	
diff -Nur dosbox-0.74/src/ints/ems.cpp dosbox-0.74.patch/src/ints/ems.cpp
--- dosbox-0.74/src/ints/ems.cpp	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/ints/ems.cpp	2016-12-11 18:35:15.546284005 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: ems.cpp,v 1.65 2009-10-11 17:11:52 c2woody Exp $ */
 
 #include <string.h>
 #include <stdlib.h>
@@ -32,6 +31,7 @@
 #include "setup.h"
 #include "support.h"
 #include "cpu.h"
+#include "dma.h"
 
 #define EMM_PAGEFRAME	0xE000
 #define EMM_PAGEFRAME4K	((EMM_PAGEFRAME*16)/4096)
@@ -88,6 +88,8 @@
 	EMM_Mapping page_map[EMM_MAX_PHYS];
 };
 
+static Bitu ems_type;
+
 static EMM_Handle emm_handles[EMM_MAX_HANDLES];
 static EMM_Mapping emm_mappings[EMM_MAX_PHYS];
 static EMM_Mapping emm_segmentmappings[0x40];
@@ -97,7 +99,8 @@
 
 class device_EMM : public DOS_Device {
 public:
-	device_EMM() {
+	device_EMM(bool is_emm386_avail) {
+		is_emm386=is_emm386_avail;
 		SetName("EMMXXXX0");
 		GEMMIS_seg=0;
 	}
@@ -108,11 +111,12 @@
 	}
 	bool Seek(Bit32u * /*pos*/,Bit32u /*type*/){return false;}
 	bool Close(){return false;}
-	Bit16u GetInformation(void){return 0xc080;}
+	Bit16u GetInformation(void){return 0xc0c0;}
 	bool ReadFromControlChannel(PhysPt bufptr,Bit16u size,Bit16u * retcode);
 	bool WriteToControlChannel(PhysPt /*bufptr*/,Bit16u /*size*/,Bit16u * /*retcode*/){return true;}
 private:
 	Bit8u cache;
+	bool is_emm386;
 };
 
 bool device_EMM::ReadFromControlChannel(PhysPt bufptr,Bit16u size,Bit16u * retcode) { 
@@ -125,6 +129,7 @@
 			*retcode=6;
 			return true;
 		case 0x01: {
+			if (!is_emm386) return false;
 			if (size!=6) return false;
 			if (GEMMIS_seg==0) GEMMIS_seg=DOS_GetMemory(0x20);
 			PhysPt GEMMIS_addr=PhysMake(GEMMIS_seg,0);
@@ -181,12 +186,14 @@
 			return true;
 			}
 		case 0x02:
+			if (!is_emm386) return false;
 			if (size!=2) return false;
 			mem_writeb(bufptr+0x00,EMM_VERSION>>4);		// version 4
 			mem_writeb(bufptr+0x01,EMM_MINOR_VERSION);
 			*retcode=2;
 			return true;
 		case 0x03:
+			if (!is_emm386) return false;
 			if (EMM_MINOR_VERSION < 0x2d) return false;
 			if (size!=4) return false;
 			mem_writew(bufptr+0x00,(Bit16u)(MEM_TotalPages()*4));	// max size (kb)
@@ -323,7 +330,23 @@
 static Bit8u EMM_MapSegment(Bitu segment,Bit16u handle,Bit16u log_page) {
 //	LOG_MSG("EMS MapSegment handle %d segment %d log %d",handle,segment,log_page);
 
-	if (((segment>=0xa000) && (segment<0xb000)) || ((segment>=EMM_PAGEFRAME-0x1000) && (segment<EMM_PAGEFRAME+0x1000))) {
+	bool valid_segment=false;
+
+	if ((ems_type==1) || (ems_type==3)) {
+		if (segment<0xf000+0x1000) valid_segment=true;
+	} else {
+		if ((segment>=0xa000) && (segment<0xb000)) {
+			valid_segment=true;		// allow mapping of graphics memory
+		}
+		if ((segment>=EMM_PAGEFRAME) && (segment<EMM_PAGEFRAME+0x1000)) {
+			valid_segment=true;		// allow mapping of EMS page frame
+		}
+/*		if ((segment>=EMM_PAGEFRAME-0x1000) && (segment<EMM_PAGEFRAME)) {
+			valid_segment=true;
+		} */
+	}
+
+	if (valid_segment) {
 		Bit32s tphysPage = ((Bit32s)segment-EMM_PAGEFRAME)/(0x1000/EMM_MAX_PHYS);
 
 		/* unmapping doesn't need valid handle (as handle isn't used) */
@@ -466,7 +489,7 @@
 				mem_writew(data,segment);data+=2;
 				MEM_BlockWrite(data,&emm_mappings[page],sizeof(EMM_Mapping));
 				data+=sizeof(EMM_Mapping);
-			} else if (((segment>=EMM_PAGEFRAME-0x1000) && (segment<EMM_PAGEFRAME)) || ((segment>=0xa000) && (segment<0xb000))) {
+			} else if ((ems_type==1) || (ems_type==3) || ((segment>=EMM_PAGEFRAME-0x1000) && (segment<EMM_PAGEFRAME)) || ((segment>=0xa000) && (segment<0xb000))) {
 				mem_writew(data,segment);data+=2;
 				MEM_BlockWrite(data,&emm_segmentmappings[segment>>10],sizeof(EMM_Mapping));
 				data+=sizeof(EMM_Mapping);
@@ -483,7 +506,7 @@
 			if ((segment>=EMM_PAGEFRAME) && (segment<EMM_PAGEFRAME+0x1000)) {
 				Bit16u page = (segment-EMM_PAGEFRAME) / (EMM_PAGE_SIZE>>4);
 				MEM_BlockRead(data,&emm_mappings[page],sizeof(EMM_Mapping));
-			} else if (((segment>=EMM_PAGEFRAME-0x1000) && (segment<EMM_PAGEFRAME)) || ((segment>=0xa000) && (segment<0xb000))) {
+			} else if ((ems_type==1) || (ems_type==3) || ((segment>=EMM_PAGEFRAME-0x1000) && (segment<EMM_PAGEFRAME)) || ((segment>=0xa000) && (segment<0xb000))) {
 				MEM_BlockRead(data,&emm_segmentmappings[segment>>10],sizeof(EMM_Mapping));
 			} else {
 				return EMM_ILL_PHYS;
@@ -1056,7 +1079,7 @@
 
 		reg_esp+=6;		// skip ip of CALL and error code of EXCEPTION 0x0d
 
-		/* Get adress of faulting instruction */
+		/* Get address of faulting instruction */
 		Bit16u v86_cs=mem_readw(SegPhys(ss)+((reg_esp+4) & cpu.stack.mask));
 		Bit16u v86_ip=mem_readw(SegPhys(ss)+((reg_esp+0) & cpu.stack.mask));
 		Bit8u v86_opcode=mem_readb((v86_cs<<4)+v86_ip);
@@ -1262,9 +1285,25 @@
 	return CBRET_NONE;
 }
 
+Bitu GetEMSType(Section_prop * section) {
+	Bitu rtype = 0;
+	std::string emstypestr(section->Get_string("ems"));
+	if (emstypestr=="true") {
+		rtype = 1;	// mixed mode
+	} else if (emstypestr=="emsboard") {
+		rtype = 2;
+	} else if (emstypestr=="emm386") {
+		rtype = 3;
+	} else {
+		rtype = 0;
+	}
+	return rtype;
+}
+
 
 class EMS: public Module_base {
 private:
+	DOS_Device * emm_device;
 	/* location in protected unfreeable memory where the ems name and callback are
 	 * stored  32 bytes.*/
 	static Bit16u ems_baseseg;
@@ -1273,7 +1312,9 @@
 	Bitu call_int67;
 
 public:
-	EMS(Section* configuration):Module_base(configuration){
+	EMS(Section* configuration):Module_base(configuration) {
+		emm_device=NULL;
+		ems_type=0;
 
 		/* Virtual DMA interrupt callback */
 		call_vdma.Install(&INT4B_Handler,CB_IRET,"Int 4b vdma");
@@ -1283,8 +1324,11 @@
 		GEMMIS_seg=0;
 		
 		Section_prop * section=static_cast<Section_prop *>(configuration);
-		if (!section->Get_bool("ems")) return;
+		ems_type=GetEMSType(section);
+		if (ems_type<=0) return;
+
 		if (machine==MCH_PCJR) {
+			ems_type=0;
 			LOG_MSG("EMS disabled for PCJr machine");
 			return;
 		}
@@ -1302,8 +1346,8 @@
 
 		/* Register the ems device */
 		//TODO MAYBE put it in the class.
-		DOS_Device * newdev = new device_EMM();
-		DOS_AddDevice(newdev);
+		emm_device = new device_EMM(ems_type!=2);
+		DOS_AddDevice(emm_device);
 
 		/* Clear handle and page tables */
 		Bitu i;
@@ -1321,63 +1365,69 @@
 			emm_segmentmappings[i].handle=NULL_HANDLE;
 		}
 
-		EMM_AllocateSystemHandle(8);	// allocate OS-dedicated handle (ems handle zero, 128kb)
+		EMM_AllocateSystemHandle(24);	// allocate OS-dedicated handle (ems handle zero, 384kb)
 
+		if (ems_type==3) {
+			DMA_SetWrapping(0xffffffff);	// emm386-bug that disables dma wrapping
+		}
 
 		if (!ENABLE_VCPI) return;
 
-		/* Install a callback that handles VCPI-requests in protected mode requests */
-		call_vcpi.Install(&VCPI_PM_Handler,CB_IRETD,"VCPI PM");
-		vcpi.pm_interface=(call_vcpi.Get_callback())*CB_SIZE;
-
-		/* Initialize private data area and set up descriptor tables */
-		SetupVCPI();
-
-		if (!vcpi.enabled) return;
-
-		/* Install v86-callback that handles interrupts occuring
-		   in v86 mode, including protection fault exceptions */
-		call_v86mon.Install(&V86_Monitor,CB_IRET,"V86 Monitor");
-
-		mem_writeb(vcpi.private_area+0x2e00,(Bit8u)0xFE);       //GRP 4
-		mem_writeb(vcpi.private_area+0x2e01,(Bit8u)0x38);       //Extra Callback instruction
-		mem_writew(vcpi.private_area+0x2e02,call_v86mon.Get_callback());		//The immediate word
-		mem_writeb(vcpi.private_area+0x2e04,(Bit8u)0x66);
-		mem_writeb(vcpi.private_area+0x2e05,(Bit8u)0xCF);       //A IRETD Instruction
-
-		/* Testcode only, starts up dosbox in v86-mode */
-		if (ENABLE_V86_STARTUP) {
-			/* Prepare V86-task */
-			CPU_SET_CRX(0, 1);
-			CPU_LGDT(0xff, vcpi.private_area+0x0000);
-			CPU_LIDT(0x7ff, vcpi.private_area+0x2000);
-			if (CPU_LLDT(0x08)) LOG_MSG("VCPI:Could not load LDT");
-			if (CPU_LTR(0x10)) LOG_MSG("VCPI:Could not load TR");
-
-			CPU_Push32(SegValue(gs));
-			CPU_Push32(SegValue(fs));
-			CPU_Push32(SegValue(ds));
-			CPU_Push32(SegValue(es));
-			CPU_Push32(SegValue(ss));
-			CPU_Push32(0x23002);
-			CPU_Push32(SegValue(cs));
-			CPU_Push32(reg_eip&0xffff);
-			/* Switch to V86-mode */
-			cpu.cpl=0;
-			CPU_IRET(true,0);
+		if (ems_type!=2) {
+			/* Install a callback that handles VCPI-requests in protected mode requests */
+			call_vcpi.Install(&VCPI_PM_Handler,CB_IRETD,"VCPI PM");
+			vcpi.pm_interface=(call_vcpi.Get_callback())*CB_SIZE;
+
+			/* Initialize private data area and set up descriptor tables */
+			SetupVCPI();
+
+			if (!vcpi.enabled) return;
+
+			/* Install v86-callback that handles interrupts occuring
+			   in v86 mode, including protection fault exceptions */
+			call_v86mon.Install(&V86_Monitor,CB_IRET,"V86 Monitor");
+
+			mem_writeb(vcpi.private_area+0x2e00,(Bit8u)0xFE);       //GRP 4
+			mem_writeb(vcpi.private_area+0x2e01,(Bit8u)0x38);       //Extra Callback instruction
+			mem_writew(vcpi.private_area+0x2e02,call_v86mon.Get_callback());		//The immediate word
+			mem_writeb(vcpi.private_area+0x2e04,(Bit8u)0x66);
+			mem_writeb(vcpi.private_area+0x2e05,(Bit8u)0xCF);       //A IRETD Instruction
+
+			/* Testcode only, starts up dosbox in v86-mode */
+			if (ENABLE_V86_STARTUP) {
+				/* Prepare V86-task */
+				CPU_SET_CRX(0, 1);
+				CPU_LGDT(0xff, vcpi.private_area+0x0000);
+				CPU_LIDT(0x7ff, vcpi.private_area+0x2000);
+				if (CPU_LLDT(0x08)) LOG_MSG("VCPI:Could not load LDT");
+				if (CPU_LTR(0x10)) LOG_MSG("VCPI:Could not load TR");
+
+				CPU_Push32(SegValue(gs));
+				CPU_Push32(SegValue(fs));
+				CPU_Push32(SegValue(ds));
+				CPU_Push32(SegValue(es));
+				CPU_Push32(SegValue(ss));
+				CPU_Push32(0x23002);
+				CPU_Push32(SegValue(cs));
+				CPU_Push32(reg_eip&0xffff);
+				/* Switch to V86-mode */
+				cpu.cpl=0;
+				CPU_IRET(true,0);
+			}
 		}
 	}
 	
 	~EMS() {
-		Section_prop * section=static_cast<Section_prop *>(m_configuration);
-		if (!section->Get_bool("ems")) return;
+		if (ems_type<=0) return;
 
 		/* Undo Biosclearing */
 		BIOS_ZeroExtendedSize(false);
  
 		/* Remove ems device */
-		device_EMM newdev;
-		DOS_DelDevice(&newdev);
+		if (emm_device!=NULL) {
+			DOS_DelDevice(emm_device);
+			emm_device=NULL;
+		}
 		GEMMIS_seg=0;
 
 		/* Remove the emsname and callback hack */
diff -Nur dosbox-0.74/src/ints/int10_char.cpp dosbox-0.74.patch/src/ints/int10_char.cpp
--- dosbox-0.74/src/ints/int10_char.cpp	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/ints/int10_char.cpp	2016-12-11 18:35:15.546284005 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: int10_char.cpp,v 1.60 2009-10-15 20:36:56 c2woody Exp $ */
 
 /* Character displaying moving functions */
 
@@ -202,9 +201,23 @@
 	if(clr>=ncols) clr=(Bit8u)ncols-1;
 	clr++;
 
-	/* Get the correct page */
-	if(page==0xFF) page=real_readb(BIOSMEM_SEG,BIOSMEM_CURRENT_PAGE);
-	PhysPt base=CurMode->pstart+page*real_readw(BIOSMEM_SEG,BIOSMEM_PAGE_SIZE);
+	/* Get the correct page: current start address for current page (0xFF),
+	   otherwise calculate from page number and page size */
+	PhysPt base=CurMode->pstart;
+	if (page==0xff) base+=real_readw(BIOSMEM_SEG,BIOSMEM_CURRENT_START);
+	else base+=page*real_readw(BIOSMEM_SEG,BIOSMEM_PAGE_SIZE);
+	
+	if (GCC_UNLIKELY(machine==MCH_PCJR)) {
+		if (real_readb(BIOSMEM_SEG, BIOSMEM_CURRENT_MODE) >= 9) {
+			// PCJr cannot handle these modes at 0xb800
+			// See INT10_PutPixel M_TANDY16
+			Bitu cpupage =
+				(real_readb(BIOSMEM_SEG, BIOSMEM_CRTCPU_PAGE) >> 3) & 0x7;
+
+			base = cpupage << 14;
+			base += page*real_readw(BIOSMEM_SEG,BIOSMEM_PAGE_SIZE);
+		}
+	}
 
 	/* See how much lines need to be copied */
 	Bit8u start,end;Bits next;
diff -Nur dosbox-0.74/src/ints/int10.cpp dosbox-0.74.patch/src/ints/int10.cpp
--- dosbox-0.74/src/ints/int10.cpp	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/ints/int10.cpp	2016-12-11 18:35:15.550284005 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: int10.cpp,v 1.56 2009-09-06 19:25:34 c2woody Exp $ */
 
 #include "dosbox.h"
 #include "mem.h"
@@ -107,7 +106,9 @@
 		INT10_ReadCharAttr(&reg_ax,reg_bh);
 		break;						
 	case 0x09:								/* Write Character & Attribute at cursor CX times */
-		INT10_WriteChar(reg_al,reg_bl,reg_bh,reg_cx,true);
+		if (real_readb(BIOSMEM_SEG,BIOSMEM_CURRENT_MODE)==0x11)
+			INT10_WriteChar(reg_al,(reg_bl&0x80)|0x3f,reg_bh,reg_cx,true);
+		else INT10_WriteChar(reg_al,reg_bl,reg_bh,reg_cx,true);
 		break;
 	case 0x0A:								/* Write Character at cursor CX times */
 		INT10_WriteChar(reg_al,reg_bl,reg_bh,reg_cx,false);
@@ -138,8 +139,8 @@
 		reg_ah=(Bit8u)real_readw(BIOSMEM_SEG,BIOSMEM_NB_COLS);
 		break;					
 	case 0x10:								/* Palette functions */
-		if ((machine==MCH_CGA) || ((!IS_VGA_ARCH) && (reg_al>0x02))) break;
-		//TODO: subfunction 0x03 for ega
+		if (!IS_EGAVGA_ARCH && (reg_al>0x02)) break;
+		else if (!IS_VGA_ARCH && (reg_al>0x03)) break;
 		switch (reg_al) {
 		case 0x00:							/* SET SINGLE PALETTE REGISTER */
 			INT10_SetSinglePaletteRegister(reg_bl,reg_bh);
@@ -163,7 +164,7 @@
 			INT10_GetAllPaletteRegisters(SegPhys(es)+reg_dx);
 			break;
 		case 0x10:							/* SET INDIVIDUAL DAC REGISTER */
-			INT10_SetSingleDacRegister(reg_bl,reg_dh,reg_ch,reg_cl);
+			INT10_SetSingleDACRegister(reg_bl,reg_dh,reg_ch,reg_cl);
 			break;
 		case 0x12:							/* SET BLOCK OF DAC REGISTERS */
 			INT10_SetDACBlock(reg_bx,reg_cx,SegPhys(es)+reg_dx);
@@ -172,7 +173,7 @@
 			INT10_SelectDACPage(reg_bl,reg_bh);
 			break;
 		case 0x15:							/* GET INDIVIDUAL DAC REGISTER */
-			INT10_GetSingleDacRegister(reg_bl,&reg_dh,&reg_ch,&reg_cl);
+			INT10_GetSingleDACRegister(reg_bl,&reg_dh,&reg_ch,&reg_cl);
 			break;
 		case 0x17:							/* GET BLOCK OF DAC REGISTER */
 			INT10_GetDACBlock(reg_bx,reg_cx,SegPhys(es)+reg_dx);
@@ -209,11 +210,11 @@
 			break;
 		case 0x01:			/* Load 8x14 font */
 		case 0x11:
-			INT10_LoadFont(Real2Phys(int10.rom.font_14),reg_al==0x11,256,0,0,14);
+			INT10_LoadFont(Real2Phys(int10.rom.font_14),reg_al==0x11,256,0,reg_bl,14);
 			break;
 		case 0x02:			/* Load 8x8 font */
 		case 0x12:
-			INT10_LoadFont(Real2Phys(int10.rom.font_8_first),reg_al==0x12,256,0,0,8);
+			INT10_LoadFont(Real2Phys(int10.rom.font_8_first),reg_al==0x12,256,0,reg_bl,8);
 			break;
 		case 0x03:			/* Set Block Specifier */
 			IO_Write(0x3c4,0x3);IO_Write(0x3c5,reg_bl);
@@ -221,7 +222,7 @@
 		case 0x04:			/* Load 8x16 font */
 		case 0x14:
 			if (!IS_VGA_ARCH) break;
-			INT10_LoadFont(Real2Phys(int10.rom.font_16),reg_al==0x14,256,0,0,16);
+			INT10_LoadFont(Real2Phys(int10.rom.font_16),reg_al==0x14,256,0,reg_bl,16);
 			break;
 /* Graphics mode calls */
 		case 0x20:			/* Set User 8x8 Graphics characters */
@@ -302,13 +303,8 @@
 				break;
 			}
 			if ((reg_bh<=7) || (svgaCard==SVGA_TsengET4K)) {
-				if (machine==MCH_EGA) {
-					reg_cx=0x0e;
-					reg_dl=0x18;
-				} else {
-					reg_cx=real_readw(BIOSMEM_SEG,BIOSMEM_CHAR_HEIGHT);
-					reg_dl=real_readb(BIOSMEM_SEG,BIOSMEM_NB_ROWS);
-				}
+				reg_cx=real_readw(BIOSMEM_SEG,BIOSMEM_CHAR_HEIGHT);
+				reg_dl=real_readb(BIOSMEM_SEG,BIOSMEM_NB_ROWS);
 			}
 			break;
 		default:
@@ -379,7 +375,7 @@
 				reg_al=0x12;
 				break;	
 			}		
-		case 0x32:							/* Video adressing */
+		case 0x32:							/* Video addressing */
 			if (!IS_VGA_ARCH) break;
 			LOG(LOG_INT10,LOG_ERROR)("Function 12:Call %2X not handled",reg_bl);
 			if (svgaCard==SVGA_TsengET4K) reg_al&=1;
@@ -716,11 +712,18 @@
 
 
 static void INT10_InitVGA(void) {
-/* switch to color mode and enable CPU access 480 lines */
-	IO_Write(0x3c2,0xc3);
-	/* More than 64k */
-	IO_Write(0x3c4,0x04);
-	IO_Write(0x3c5,0x02);
+	if (IS_EGAVGA_ARCH) {
+		/* switch to color mode and enable CPU access 480 lines */
+		IO_Write(0x3c2,0xc3);
+		/* More than 64k */
+		IO_Write(0x3c4,0x04);
+		IO_Write(0x3c5,0x02);
+		if (IS_VGA_ARCH) {
+			/* Initialize DAC */
+			IO_Write(0x3c8,0);
+			for (Bitu i=0;i<3*256;i++) IO_Write(0x3c9,0);
+		}
+	}
 }
 
 static void SetupTandyBios(void) {
diff -Nur dosbox-0.74/src/ints/int10.h dosbox-0.74.patch/src/ints/int10.h
--- dosbox-0.74/src/ints/int10.h	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/ints/int10.h	2016-12-11 18:35:15.550284005 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: int10.h,v 1.42 2009-09-06 19:25:34 c2woody Exp $ */
 
 #include "vga.h"
 
@@ -187,8 +186,8 @@
 void INT10_GetSinglePaletteRegister(Bit8u reg,Bit8u * val);
 void INT10_GetOverscanBorderColor(Bit8u * val);
 void INT10_GetAllPaletteRegisters(PhysPt data);
-void INT10_SetSingleDacRegister(Bit8u index,Bit8u red,Bit8u green,Bit8u blue);
-void INT10_GetSingleDacRegister(Bit8u index,Bit8u * red,Bit8u * green,Bit8u * blue);
+void INT10_SetSingleDACRegister(Bit8u index,Bit8u red,Bit8u green,Bit8u blue);
+void INT10_GetSingleDACRegister(Bit8u index,Bit8u * red,Bit8u * green,Bit8u * blue);
 void INT10_SetDACBlock(Bit16u index,Bit16u count,PhysPt data);
 void INT10_GetDACBlock(Bit16u index,Bit16u count,PhysPt data);
 void INT10_SelectDACPage(Bit8u function,Bit8u mode);
diff -Nur dosbox-0.74/src/ints/int10_memory.cpp dosbox-0.74.patch/src/ints/int10_memory.cpp
--- dosbox-0.74/src/ints/int10_memory.cpp	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/ints/int10_memory.cpp	2016-12-11 18:35:15.550284005 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: int10_memory.cpp,v 1.30 2009-09-06 19:25:34 c2woody Exp $ */
 
 #include "dosbox.h"
 #include "mem.h"
@@ -50,7 +49,7 @@
 	PhysPt ftwhere=PhysMake(0xa000,map_offset[map & 0x7]+(Bit16u)(offset*32));
 	IO_Write(0x3c4,0x2);IO_Write(0x3c5,0x4);	//Enable plane 2
 	IO_Write(0x3ce,0x6);Bitu old_6=IO_Read(0x3cf);
-	IO_Write(0x3cf,0x0);	//Disable odd/even and a0000 adressing
+	IO_Write(0x3cf,0x0);	//Disable odd/even and a0000 addressing
 	for (Bitu i=0;i<count;i++) {
 		MEM_BlockCopy(ftwhere,font,height);
 		ftwhere+=32;
@@ -58,7 +57,7 @@
 	}
 	IO_Write(0x3c4,0x2);IO_Write(0x3c5,0x3);	//Enable textmode planes (0,1)
 	IO_Write(0x3ce,0x6);
-	if (IS_VGA_ARCH) IO_Write(0x3cf,(Bit8u)old_6);	//odd/even and b8000 adressing
+	if (IS_VGA_ARCH) IO_Write(0x3cf,(Bit8u)old_6);	//odd/even and b8000 addressing
 	else IO_Write(0x3cf,0x0e);
 	/* Reload tables and registers with new values based on this height */
 	if (reload) {
@@ -66,9 +65,21 @@
 		Bit16u base=real_readw(BIOSMEM_SEG,BIOSMEM_CRTC_ADDRESS);
 		IO_Write(base,0x9);
 		IO_Write(base+1,(IO_Read(base+1) & 0xe0)|(height-1));
-		//Vertical display end bios says, but should stay the same?
+		// Vertical display end bios says, but should stay the same?
+		// Not on EGA.
+        Bitu rows = CurMode->sheight/height;
+		if (machine==MCH_EGA) {
+			Bitu displayend = rows*height - 1;
+			IO_Write(base,0x12);
+			IO_Write(base+1,(Bit8u)(displayend & 0xff));
+			IO_Write(base,0x7);
+			// Note: IBM EGA registers can't be read
+			Bitu v_overflow = IO_Read(base+1) & ~0x2;
+			if (displayend & 0x100) v_overflow |= 0x2;
+			IO_Write(base+1,(Bit8u)v_overflow);
+		}
 		//Rows setting in bios segment
-		real_writeb(BIOSMEM_SEG,BIOSMEM_NB_ROWS,(CurMode->sheight/height)-1);
+		real_writeb(BIOSMEM_SEG,BIOSMEM_NB_ROWS,rows-1);
 		real_writeb(BIOSMEM_SEG,BIOSMEM_CHAR_HEIGHT,(Bit8u)height);
 		//TODO Reprogram cursor size?
 	}
@@ -143,7 +154,7 @@
 			int10.rom.video_dcc_table=RealMake(0xC000,int10.rom.used);
 			phys_writeb(rom_base+int10.rom.used++,0x10);	// number of entries
 			phys_writeb(rom_base+int10.rom.used++,1);		// version number
-			phys_writeb(rom_base+int10.rom.used++,8);		// maximal display code
+			phys_writeb(rom_base+int10.rom.used++,8);		// maximum display code
 			phys_writeb(rom_base+int10.rom.used++,0);		// reserved
 			// display combination codes
 			phys_writew(rom_base+int10.rom.used,0x0000);	int10.rom.used+=2;
diff -Nur dosbox-0.74/src/ints/int10_misc.cpp dosbox-0.74.patch/src/ints/int10_misc.cpp
--- dosbox-0.74/src/ints/int10_misc.cpp	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/ints/int10_misc.cpp	2016-12-11 18:35:15.550284005 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: int10_misc.cpp,v 1.21 2009-05-27 09:15:42 qbix79 Exp $ */
 
 #include "dosbox.h"
 #include "mem.h"
diff -Nur dosbox-0.74/src/ints/int10_modes.cpp dosbox-0.74.patch/src/ints/int10_modes.cpp
--- dosbox-0.74/src/ints/int10_modes.cpp	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/ints/int10_modes.cpp	2016-12-11 18:35:15.550284005 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: int10_modes.cpp,v 1.91 2009-10-19 16:00:22 h-a-l-9000 Exp $ */
 
 #include <string.h>
 
@@ -54,8 +53,8 @@
 { 0x012  ,M_EGA    ,640 ,480 ,80 ,30 ,8 ,16 ,1 ,0xA0000 ,0xA000 ,100 ,525 ,80 ,480 ,0	},
 { 0x013  ,M_VGA    ,320 ,200 ,40 ,25 ,8 ,8  ,1 ,0xA0000 ,0x2000 ,100 ,449 ,80 ,400 ,0   },
 
-{ 0x054  ,M_TEXT   ,1056,688, 132,43, 8, 16, 1 ,0xB8000 ,0x4000, 192, 800, 132,688, 0   },
-{ 0x055  ,M_TEXT   ,1056,400, 132,25, 8, 16, 1 ,0xB8000 ,0x2000, 192, 449, 132,400, 0   },
+{ 0x054  ,M_TEXT   ,1056,344, 132,43, 8,  8, 1 ,0xB8000 ,0x4000, 160, 449, 132,344, 0   },
+{ 0x055  ,M_TEXT   ,1056,400, 132,25, 8, 16, 1 ,0xB8000 ,0x2000, 160, 449, 132,400, 0   },
 
 /* Alias of mode 101 */
 { 0x069  ,M_LIN8   ,640 ,480 ,80 ,30 ,8 ,16 ,1 ,0xA0000 ,0x10000,100 ,525 ,80 ,480 ,0	},
@@ -72,6 +71,14 @@
 { 0x106  ,M_LIN4   ,1280,1024,160,64 ,8 ,16 ,1 ,0xA0000 ,0x10000,212 ,1066,160,1024,0	},
 { 0x107  ,M_LIN8   ,1280,1024,160,64 ,8 ,16 ,1 ,0xA0000 ,0x10000,212 ,1066,160,1024,0	},
 
+/* VESA text modes */ 
+{ 0x108  ,M_TEXT   ,640 ,480,  80,60, 8,  8 ,2 ,0xB8000 ,0x4000, 100 ,525 ,80 ,480 ,0   },
+{ 0x109  ,M_TEXT   ,1056,400, 132,25, 8, 16, 1 ,0xB8000 ,0x2000, 160, 449, 132,400, 0   },
+{ 0x10A  ,M_TEXT   ,1056,688, 132,43, 8,  8, 1 ,0xB8000 ,0x4000, 160, 449, 132,344, 0   },
+{ 0x10B  ,M_TEXT   ,1056,400, 132,50, 8,  8, 1 ,0xB8000 ,0x4000, 160, 449, 132,400, 0   },
+{ 0x10C  ,M_TEXT   ,1056,480, 132,60, 8,  8, 2 ,0xB8000 ,0x4000, 160, 531, 132,480, 0   },
+
+/* VESA higher color modes */
 { 0x10D  ,M_LIN15  ,320 ,200 ,40 ,25 ,8 ,8  ,1 ,0xA0000 ,0x10000,100 ,449 ,80 ,400 , _VGA_PIXEL_DOUBLE | _EGA_LINE_DOUBLE },
 { 0x10E  ,M_LIN16  ,320 ,200 ,40 ,25 ,8 ,8  ,1 ,0xA0000 ,0x10000,100 ,449 ,80 ,400 , _VGA_PIXEL_DOUBLE | _EGA_LINE_DOUBLE },
 { 0x10F  ,M_LIN32  ,320 ,200 ,40 ,25 ,8 ,8  ,1 ,0xA0000 ,0x10000,50  ,449 ,40 ,400 , _VGA_PIXEL_DOUBLE | _EGA_LINE_DOUBLE },
@@ -81,10 +88,10 @@
 { 0x113  ,M_LIN15  ,800 ,600 ,100,37 ,8 ,16 ,1 ,0xA0000 ,0x10000,264 ,628 ,200,600 ,0   },
 { 0x114  ,M_LIN16  ,800 ,600 ,100,37 ,8 ,16 ,1 ,0xA0000 ,0x10000,264 ,628 ,200,600 ,0   },
 { 0x115  ,M_LIN32  ,800 ,600 ,100,37 ,8 ,16 ,1 ,0xA0000 ,0x10000,132 ,628 ,100,600 ,0   },
-
 { 0x116  ,M_LIN15  ,1024,768 ,128,48 ,8 ,16 ,1 ,0xA0000 ,0x10000,336 ,806 ,256,768 ,0	},
 { 0x117  ,M_LIN16  ,1024,768 ,128,48 ,8 ,16 ,1 ,0xA0000 ,0x10000,336 ,806 ,256,768 ,0	},
 { 0x118  ,M_LIN32  ,1024,768 ,128,48 ,8 ,16 ,1 ,0xA0000 ,0x10000,168 ,806 ,128,768 ,0	},
+
 /* those should be interlaced but ok */
 //{ 0x119  ,M_LIN15  ,1280,1024,160,64 ,8 ,16 ,1 ,0xA0000 ,0x10000,424 ,1066,320,1024,0	},
 //{ 0x11A  ,M_LIN16  ,1280,1024,160,64 ,8 ,16 ,1 ,0xA0000 ,0x10000,424 ,1066,320,1024,0	},
@@ -246,6 +253,7 @@
 { 0x008  ,M_TANDY16,160 ,200 ,20 ,25 ,8 ,8  ,8 ,0xB8000 ,0x2000 ,56  ,127 ,40 ,100 ,0   },
 { 0x009  ,M_TANDY16,320 ,200 ,40 ,25 ,8 ,8  ,8 ,0xB8000 ,0x2000 ,113 ,63  ,80 ,50  ,0   },
 { 0x00A  ,M_CGA4   ,640 ,200 ,80 ,25 ,8 ,8  ,8 ,0xB8000 ,0x2000 ,113 ,63  ,80 ,50  ,0   },
+//{ 0x00E  ,M_TANDY16,640 ,200 ,80 ,25 ,8 ,8  ,8 ,0xA0000 ,0x10000 ,113 ,256 ,80 ,200 ,0   },
 {0xFFFF  ,M_ERROR  ,0   ,0   ,0  ,0  ,0 ,0  ,0 ,0x00000 ,0x0000 ,0   ,0   ,0  ,0   ,0 	},
 };
 
@@ -318,7 +326,7 @@
 	{0x15,0x15,0x15}, {0x15,0x15,0x3f}, {0x15,0x3f,0x15}, {0x15,0x3f,0x3f}, {0x3f,0x15,0x15}, {0x3f,0x15,0x3f}, {0x3f,0x3f,0x15}, {0x3f,0x3f,0x3f},
 };
 
-static Bit8u vga_palette[256][3]=
+static Bit8u vga_palette[248][3]=
 {
   {0x00,0x00,0x00},{0x00,0x00,0x2a},{0x00,0x2a,0x00},{0x00,0x2a,0x2a},{0x2a,0x00,0x00},{0x2a,0x00,0x2a},{0x2a,0x15,0x00},{0x2a,0x2a,0x2a},
   {0x15,0x15,0x15},{0x15,0x15,0x3f},{0x15,0x3f,0x15},{0x15,0x3f,0x3f},{0x3f,0x15,0x15},{0x3f,0x15,0x3f},{0x3f,0x3f,0x15},{0x3f,0x3f,0x3f},
@@ -353,8 +361,7 @@
   {0x08,0x10,0x08},{0x08,0x10,0x0a},{0x08,0x10,0x0c},{0x08,0x10,0x0e},{0x08,0x10,0x10},{0x08,0x0e,0x10},{0x08,0x0c,0x10},{0x08,0x0a,0x10},
   {0x0b,0x0b,0x10},{0x0c,0x0b,0x10},{0x0d,0x0b,0x10},{0x0f,0x0b,0x10},{0x10,0x0b,0x10},{0x10,0x0b,0x0f},{0x10,0x0b,0x0d},{0x10,0x0b,0x0c},
   {0x10,0x0b,0x0b},{0x10,0x0c,0x0b},{0x10,0x0d,0x0b},{0x10,0x0f,0x0b},{0x10,0x10,0x0b},{0x0f,0x10,0x0b},{0x0d,0x10,0x0b},{0x0c,0x10,0x0b},
-  {0x0b,0x10,0x0b},{0x0b,0x10,0x0c},{0x0b,0x10,0x0d},{0x0b,0x10,0x0f},{0x0b,0x10,0x10},{0x0b,0x0f,0x10},{0x0b,0x0d,0x10},{0x0b,0x0c,0x10},
-  {0x00,0x00,0x00},{0x00,0x00,0x00},{0x00,0x00,0x00},{0x00,0x00,0x00},{0x00,0x00,0x00},{0x00,0x00,0x00},{0x00,0x00,0x00},{0x00,0x00,0x00}
+  {0x0b,0x10,0x0b},{0x0b,0x10,0x0c},{0x0b,0x10,0x0d},{0x0b,0x10,0x0f},{0x0b,0x10,0x10},{0x0b,0x0f,0x10},{0x0b,0x0d,0x10},{0x0b,0x0c,0x10}
 };
 VideoModeBlock * CurMode;
 
@@ -397,7 +404,7 @@
 		case M_LIN15:
 		case M_LIN16:
 		case M_LIN32:
-			/* Hack we just acess the memory directly */
+			/* Hack we just access the memory directly */
 			memset(vga.mem.linear,0,vga.vmemsize);
 			memset(vga.fastmem, 0, vga.vmemsize<<1);
 		}
@@ -547,6 +554,11 @@
 		default:
 			IO_WriteB(0x3de,0x0);break;
 		}
+		// write palette
+		for(Bitu i = 0; i < 16; i++) {
+			IO_WriteB(0x3da,i+0x10);
+			IO_WriteB(0x3de,i);
+		}
 		//Clear extended mapping
 		IO_WriteB(0x3da,0x5);
 		IO_WriteB(0x3de,0x0);
@@ -587,8 +599,9 @@
 
 		if (CurMode->mode == 0x6 || CurMode->mode==0xa) color_select=0x3f;
 		else color_select=0x30;
-		IO_WriteB(0x3d9,color_select);
 		real_writeb(BIOSMEM_SEG,BIOSMEM_CURRENT_PAL,color_select);
+		INT10_SetColorSelect(1);
+		INT10_SetBackgroundBorder(0);
 		break;
 	}
 
@@ -1032,6 +1045,8 @@
 		break;
 	case M_LIN4:
 	case M_EGA:
+		if (CurMode->mode == 0x0f)
+			gfx_data[0x7]=0x05;		// only planes 0 and 2 are used
 		gfx_data[0x6]|=0x05;		//graphics mode at 0xa000-affff
 		break;
 	case M_CGA4:
@@ -1061,12 +1076,14 @@
 		att_data[0x10]=0x01;		//Color Graphics
 		switch (CurMode->mode) {
 		case 0x0f:
-			att_data[0x10]|=0x0a;	//Monochrome
-			att_data[0x01]=0x08;
-			att_data[0x04]=0x18;
-			att_data[0x05]=0x18;
-			att_data[0x09]=0x08;
-			att_data[0x0d]=0x18;
+			att_data[0x12]=0x05;	// planes 0 and 2 enabled
+			att_data[0x10]|=0x0a;	// monochrome and blinking
+	
+			att_data[0x01]=0x08; // low-intensity
+			att_data[0x04]=0x18; // blink-on case
+			att_data[0x05]=0x18; // high-intensity
+			att_data[0x09]=0x08; // low-intensity in blink-off case
+			att_data[0x0d]=0x18; // high-intensity in blink-off
 			break;
 		case 0x11:
 			for (i=1;i<16;i++) att_data[i]=0x3f;
@@ -1211,7 +1228,10 @@
 		case M_LIN15:
 		case M_LIN16:
 		case M_LIN32:
-			for (i=0;i<256;i++) {
+			// IBM and clones use 248 default colors in the palette for 256-color mode.
+			// The last 8 colors of the palette are only initialized to 0 at BIOS init.
+			// Palette index is left at 0xf8 as on most clones, IBM leaves it at 0x10.
+			for (i=0;i<248;i++) {
 				IO_Write(0x3c9,vga_palette[i][0]);
 				IO_Write(0x3c9,vga_palette[i][1]);
 				IO_Write(0x3c9,vga_palette[i][2]);
diff -Nur dosbox-0.74/src/ints/int10_pal.cpp dosbox-0.74.patch/src/ints/int10_pal.cpp
--- dosbox-0.74/src/ints/int10_pal.cpp	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/ints/int10_pal.cpp	2016-12-11 18:35:15.550284005 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -35,9 +35,44 @@
 
 void INT10_SetSinglePaletteRegister(Bit8u reg,Bit8u val) {
 	switch (machine) {
-	case TANDY_ARCH_CASE:
+	case MCH_PCJR:
+		reg&=0xf;
 		IO_Read(VGAREG_TDY_RESET);
 		WriteTandyACTL(reg+0x10,val);
+		IO_Write(0x3da,0x0); // palette back on
+		break;
+	case MCH_TANDY:
+		// TODO waits for vertical retrace
+		switch(vga.mode) {
+		case M_TANDY2:
+			if (reg >= 0x10) break;
+			else if (reg==1) reg = 0x1f;
+			else reg |= 0x10;
+			WriteTandyACTL(reg+0x10,val);
+			break;
+		case M_TANDY4: {
+			if (CurMode->mode!=0x0a) {
+				// Palette values are kept constand by the BIOS.
+				// The four colors are mapped to special palette values by hardware.
+				// 3D8/3D9 registers influence this mapping. We need to figure out
+				// which entry is used for the requested color.
+				if (reg > 3) break;
+				if (reg != 0) { // 0 is assumed to be at 0
+					Bit8u color_select=real_readb(BIOSMEM_SEG,BIOSMEM_CURRENT_PAL);
+					reg = reg*2+8; // Green Red Brown
+					if (color_select& 0x20) reg++; // Cyan Magenta White
+				}
+				WriteTandyACTL(reg+0x10,val);
+			} 
+			// 4-color high resolution mode 0x0a isn't handled specially
+			else WriteTandyACTL(reg+0x10,val);
+			break;
+		}
+		default:
+			WriteTandyACTL(reg+0x10,val);
+			break;
+		}
+		IO_Write(0x3da,0x0); // palette back on
 		break;
 	case EGAVGA_ARCH_CASE:
 		if (!IS_VGA_ARCH) reg&=0x1f;
@@ -57,6 +92,7 @@
 	case TANDY_ARCH_CASE:
 		IO_Read(VGAREG_TDY_RESET);
 		WriteTandyACTL(0x02,val);
+		IO_Write(VGAREG_TDY_ADDRESS, 0); // enable the screen
 		break;
 	case EGAVGA_ARCH_CASE:
 		ResetACTL();
@@ -96,25 +132,42 @@
 }
 
 void INT10_ToggleBlinkingBit(Bit8u state) {
-	Bit8u value;
-//	state&=0x01;
-	if ((state>1) && (svgaCard==SVGA_S3Trio)) return;
-	ResetACTL();
-	
-	IO_Write(VGAREG_ACTL_ADDRESS,0x10);
-	value=IO_Read(VGAREG_ACTL_READ_DATA);
-	if (state<=1) {
-		value&=0xf7;
-		value|=state<<3;
-	}
+	if(IS_VGA_ARCH) {
+		Bit8u value;
+	//	state&=0x01;
+		if ((state>1) && (svgaCard==SVGA_S3Trio)) return;
+		ResetACTL();
+		
+		IO_Write(VGAREG_ACTL_ADDRESS,0x10);
+		value=IO_Read(VGAREG_ACTL_READ_DATA);
+		if (state<=1) {
+			value&=0xf7;
+			value|=state<<3;
+		}
 
-	ResetACTL();
-	IO_Write(VGAREG_ACTL_ADDRESS,0x10);
-	IO_Write(VGAREG_ACTL_WRITE_DATA,value);
-	IO_Write(VGAREG_ACTL_ADDRESS,32);		//Enable output and protect palette
+		ResetACTL();
+		IO_Write(VGAREG_ACTL_ADDRESS,0x10);
+		IO_Write(VGAREG_ACTL_WRITE_DATA,value);
+		IO_Write(VGAREG_ACTL_ADDRESS,32);		//Enable output and protect palette
 
-	if (state<=1) {
-		Bit8u msrval=real_readb(BIOSMEM_SEG,BIOSMEM_CURRENT_MSR)&0xdf;
+		if (state<=1) {
+			Bit8u msrval=real_readb(BIOSMEM_SEG,BIOSMEM_CURRENT_MSR)&0xdf;
+			if (state) msrval|=0x20;
+			real_writeb(BIOSMEM_SEG,BIOSMEM_CURRENT_MSR,msrval);
+		}
+	} else { // EGA
+		// Usually it reads this from the mode list in ROM
+		if (CurMode->type!=M_TEXT) return;
+
+		Bit8u value = (CurMode->cwidth==9)? 0x4:0x0;
+		if (state) value |= 0x8;
+		
+		ResetACTL();
+		IO_Write(VGAREG_ACTL_ADDRESS,0x10);
+		IO_Write(VGAREG_ACTL_WRITE_DATA,value);
+		IO_Write(VGAREG_ACTL_ADDRESS,0x20);
+
+		Bit8u msrval=real_readb(BIOSMEM_SEG,BIOSMEM_CURRENT_MSR)& ~0x20;
 		if (state) msrval|=0x20;
 		real_writeb(BIOSMEM_SEG,BIOSMEM_CURRENT_MSR,msrval);
 	}
@@ -151,14 +204,23 @@
 	ResetACTL();
 }
 
-void INT10_SetSingleDacRegister(Bit8u index,Bit8u red,Bit8u green,Bit8u blue) {
+void INT10_SetSingleDACRegister(Bit8u index,Bit8u red,Bit8u green,Bit8u blue) {
 	IO_Write(VGAREG_DAC_WRITE_ADDRESS,(Bit8u)index);
-	IO_Write(VGAREG_DAC_DATA,red);
-	IO_Write(VGAREG_DAC_DATA,green);
-	IO_Write(VGAREG_DAC_DATA,blue);
+	if ((real_readb(BIOSMEM_SEG,BIOSMEM_MODESET_CTL)&0x06)==0) {
+		IO_Write(VGAREG_DAC_DATA,red);
+		IO_Write(VGAREG_DAC_DATA,green);
+		IO_Write(VGAREG_DAC_DATA,blue);
+	} else {
+		/* calculate clamped intensity, taken from VGABIOS */
+		Bit32u i=(( 77*red + 151*green + 28*blue ) + 0x80) >> 8;
+		Bit8u ic=(i>0x3f) ? 0x3f : ((Bit8u)(i & 0xff));
+		IO_Write(VGAREG_DAC_DATA,ic);
+		IO_Write(VGAREG_DAC_DATA,ic);
+		IO_Write(VGAREG_DAC_DATA,ic);
+	}
 }
 
-void INT10_GetSingleDacRegister(Bit8u index,Bit8u * red,Bit8u * green,Bit8u * blue) {
+void INT10_GetSingleDACRegister(Bit8u index,Bit8u * red,Bit8u * green,Bit8u * blue) {
 	IO_Write(VGAREG_DAC_READ_ADDRESS,index);
 	*red=IO_Read(VGAREG_DAC_DATA);
 	*green=IO_Read(VGAREG_DAC_DATA);
@@ -167,10 +229,25 @@
 
 void INT10_SetDACBlock(Bit16u index,Bit16u count,PhysPt data) {
  	IO_Write(VGAREG_DAC_WRITE_ADDRESS,(Bit8u)index);
-	for (;count>0;count--) {
-		IO_Write(VGAREG_DAC_DATA,mem_readb(data++));
-		IO_Write(VGAREG_DAC_DATA,mem_readb(data++));
-		IO_Write(VGAREG_DAC_DATA,mem_readb(data++));
+	if ((real_readb(BIOSMEM_SEG,BIOSMEM_MODESET_CTL)&0x06)==0) {
+		for (;count>0;count--) {
+			IO_Write(VGAREG_DAC_DATA,mem_readb(data++));
+			IO_Write(VGAREG_DAC_DATA,mem_readb(data++));
+			IO_Write(VGAREG_DAC_DATA,mem_readb(data++));
+		}
+	} else {
+		for (;count>0;count--) {
+			Bit8u red=mem_readb(data++);
+			Bit8u green=mem_readb(data++);
+			Bit8u blue=mem_readb(data++);
+
+			/* calculate clamped intensity, taken from VGABIOS */
+			Bit32u i=(( 77*red + 151*green + 28*blue ) + 0x80) >> 8;
+			Bit8u ic=(i>0x3f) ? 0x3f : ((Bit8u)(i & 0xff));
+			IO_Write(VGAREG_DAC_DATA,ic);
+			IO_Write(VGAREG_DAC_DATA,ic);
+			IO_Write(VGAREG_DAC_DATA,ic);
+		}
 	}
 }
 
@@ -225,28 +302,67 @@
 
 void INT10_GetPelMask(Bit8u & mask) {
 	mask=IO_Read(VGAREG_PEL_MASK);
-}	
+}
 
 void INT10_SetBackgroundBorder(Bit8u val) {
-	Bit8u temp=real_readb(BIOSMEM_SEG,BIOSMEM_CURRENT_PAL);
-	temp=(temp & 0xe0) | (val & 0x1f);
-	real_writeb(BIOSMEM_SEG,BIOSMEM_CURRENT_PAL,temp);
-	if (machine == MCH_CGA || IS_TANDY_ARCH)
-		IO_Write(0x3d9,temp);
-	else if (IS_EGAVGA_ARCH) {
+	Bit8u color_select=real_readb(BIOSMEM_SEG,BIOSMEM_CURRENT_PAL);
+	color_select=(color_select & 0xe0) | (val & 0x1f);
+	real_writeb(BIOSMEM_SEG,BIOSMEM_CURRENT_PAL,color_select);
+	
+	switch (machine) {
+	case MCH_CGA:
+		// only write the color select register
+		IO_Write(0x3d9,color_select);
+		break;
+	case MCH_TANDY:
+		// TODO handle val == 0x1x, wait for retrace
+		switch(CurMode->mode) {
+		default: // modes 0-5: write to color select and border
+			INT10_SetOverscanBorderColor(val);
+			IO_Write(0x3d9, color_select);
+			break;
+		case 0x06: // 2-color: only write the color select register
+			IO_Write(0x3d9, color_select);
+			break;
+		case 0x07: // Tandy monochrome not implemented
+			break; 
+		case 0x08:
+		case 0x09: // 16-color: write to color select, border and pal. index 0
+			INT10_SetOverscanBorderColor(val);
+			INT10_SetSinglePaletteRegister(0, val);
+			IO_Write(0x3d9, color_select);
+			break;
+		case 0x0a: // 4-color highres:
+			// write zero to color select, write palette to indexes 1-3
+			// TODO palette
+			IO_Write(0x3d9, 0);
+			break;
+		}
+		break;
+	case MCH_PCJR:
+		IO_Read(VGAREG_TDY_RESET); // reset the flipflop
+		if (vga.mode!=M_TANDY_TEXT) {
+			IO_Write(VGAREG_TDY_ADDRESS, 0x10);
+			IO_Write(VGAREG_PCJR_DATA, color_select&0xf);
+		}
+		IO_Write(VGAREG_TDY_ADDRESS, 0x2); // border color
+		IO_Write(VGAREG_PCJR_DATA, color_select&0xf);
+		break;
+	case EGAVGA_ARCH_CASE:
 		val = ((val << 1) & 0x10) | (val & 0x7);
-		/* Aways set the overscan color */
+		/* Always set the overscan color */
 		INT10_SetSinglePaletteRegister( 0x11, val );
 		/* Don't set any extra colors when in text mode */
 		if (CurMode->mode <= 3)
 			return;
 		INT10_SetSinglePaletteRegister( 0, val );
-		val = (temp & 0x10) | 2 | ((temp & 0x20) >> 5);
+		val = (color_select & 0x10) | 2 | ((color_select & 0x20) >> 5);
 		INT10_SetSinglePaletteRegister( 1, val );
 		val+=2;
 		INT10_SetSinglePaletteRegister( 2, val );
 		val+=2;
 		INT10_SetSinglePaletteRegister( 3, val );
+		break;
 	}
 }
 
@@ -254,8 +370,32 @@
 	Bit8u temp=real_readb(BIOSMEM_SEG,BIOSMEM_CURRENT_PAL);
 	temp=(temp & 0xdf) | ((val & 1) ? 0x20 : 0x0);
 	real_writeb(BIOSMEM_SEG,BIOSMEM_CURRENT_PAL,temp);
-	if (machine == MCH_CGA || IS_TANDY_ARCH)
+	if (machine == MCH_CGA || machine==MCH_TANDY)
 		IO_Write(0x3d9,temp);
+	else if (machine == MCH_PCJR) {
+		IO_Read(VGAREG_TDY_RESET); // reset the flipflop
+		switch(vga.mode) {
+		case M_TANDY2:
+			IO_Write(VGAREG_TDY_ADDRESS, 0x11);
+			IO_Write(VGAREG_PCJR_DATA, val&1? 0xf:0);
+			break;
+		case M_TANDY4:
+			for(Bit8u i = 0x11; i < 0x14; i++) {
+				const Bit8u t4_table[] = {0,2,4,6, 0,3,5,0xf};
+				IO_Write(VGAREG_TDY_ADDRESS, i);
+				IO_Write(VGAREG_PCJR_DATA, t4_table[(i-0x10)+(val&1? 4:0)]);
+			}
+			break;
+		default:
+			// 16-color modes: always write the same palette
+			for(Bit8u i = 0x11; i < 0x20; i++) {
+				IO_Write(VGAREG_TDY_ADDRESS, i);
+				IO_Write(VGAREG_PCJR_DATA, i-0x10);
+			}
+			break;
+		}
+		IO_Write(VGAREG_TDY_ADDRESS, 0); // enable palette
+	}
 	else if (IS_EGAVGA_ARCH) {
 		if (CurMode->mode <= 3) //Maybe even skip the total function!
 			return;
@@ -279,6 +419,6 @@
 		/* calculate clamped intensity, taken from VGABIOS */
 		Bit32u i=(( 77*red + 151*green + 28*blue ) + 0x80) >> 8;
 		Bit8u ic=(i>0x3f) ? 0x3f : ((Bit8u)(i & 0xff));
-		INT10_SetSingleDacRegister(start_reg+ct,ic,ic,ic);
+		INT10_SetSingleDACRegister(start_reg+ct,ic,ic,ic);
 	}
 }
diff -Nur dosbox-0.74/src/ints/int10_put_pixel.cpp dosbox-0.74.patch/src/ints/int10_put_pixel.cpp
--- dosbox-0.74/src/ints/int10_put_pixel.cpp	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/ints/int10_put_pixel.cpp	2016-12-11 18:35:15.550284005 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: int10_put_pixel.cpp,v 1.23 2009-05-27 09:15:42 qbix79 Exp $ */
 
 #include "dosbox.h"
 #include "mem.h"
@@ -31,34 +30,44 @@
 
 	switch (CurMode->type) {
 	case M_CGA4:
-		{
-				if (real_readb(BIOSMEM_SEG,BIOSMEM_CURRENT_MODE)<=5) {
-					Bit16u off=(y>>1)*80+(x>>2);
-					if (y&1) off+=8*1024;
-
-					Bit8u old=real_readb(0xb800,off);
-					if (color & 0x80) {
-						color&=3;
-						old^=color << (2*(3-(x&3)));
-					} else {
-						old=(old&cga_masks[x&3])|((color&3) << (2*(3-(x&3))));
-					}
-					real_writeb(0xb800,off,old);
-				} else {
-					Bit16u off=(y>>2)*160+((x>>2)&(~1));
-					off+=(8*1024) * (y & 3);
+	{
+		if (real_readb(BIOSMEM_SEG,BIOSMEM_CURRENT_MODE)<=5) {
+			// this is a 16k mode
+			Bit16u off=(y>>1)*80+(x>>2);
+			if (y&1) off+=8*1024;
 
-					Bit16u old=real_readw(0xb800,off);
-					if (color & 0x80) {
-						old^=(color&1) << (7-(x&7));
-						old^=((color&2)>>1) << ((7-(x&7))+8);
-					} else {
-						old=(old&(~(0x101<<(7-(x&7))))) | ((color&1) << (7-(x&7))) | (((color&2)>>1) << ((7-(x&7))+8));
-					}
-					real_writew(0xb800,off,old);
-				}
+			Bit8u old=real_readb(0xb800,off);
+			if (color & 0x80) {
+				color&=3;
+				old^=color << (2*(3-(x&3)));
+			} else {
+				old=(old&cga_masks[x&3])|((color&3) << (2*(3-(x&3))));
+			}
+			real_writeb(0xb800,off,old);
+		} else {
+			// a 32k mode: PCJr special case (see M_TANDY16)
+			Bit16u seg;
+			if (machine==MCH_PCJR) {
+				Bitu cpupage =
+					(real_readb(BIOSMEM_SEG, BIOSMEM_CRTCPU_PAGE) >> 3) & 0x7;
+				seg = cpupage << 10; // A14-16 to addr bits 14-16
+			} else
+				seg = 0xb800;
+
+			Bit16u off=(y>>2)*160+((x>>2)&(~1));
+			off+=(8*1024) * (y & 3);
+
+			Bit16u old=real_readw(seg,off);
+			if (color & 0x80) {
+				old^=(color&1) << (7-(x&7));
+				old^=((color&2)>>1) << ((7-(x&7))+8);
+			} else {
+				old=(old&(~(0x101<<(7-(x&7))))) | ((color&1) << (7-(x&7))) | (((color&2)>>1) << ((7-(x&7))+8));
+			}
+			real_writew(seg,off,old);
 		}
-		break;
+	}
+	break;
 	case M_CGA2:
 		{
 				Bit16u off=(y>>1)*80+(x>>3);
@@ -74,26 +83,50 @@
 		}
 		break;
 	case M_TANDY16:
-		{
-			IO_Write(0x3d4,0x09);
-			Bit8u scanlines_m1=IO_Read(0x3d5);
-			Bit16u off=(y>>((scanlines_m1==1)?1:2))*(CurMode->swidth>>1)+(x>>1);
-			off+=(8*1024) * (y & scanlines_m1);
-			Bit8u old=real_readb(0xb800,off);
-			Bit8u p[2];
-			p[1] = (old >> 4) & 0xf;
-			p[0] = old & 0xf;
-			Bitu ind = 1-(x & 0x1);
+	{
+		// find out if we are in a 32k mode (0x9 or 0xa)
+		// This requires special handling on the PCJR
+		// because only 16k are mapped at 0xB800
+		bool is_32k = (real_readb(BIOSMEM_SEG, BIOSMEM_CURRENT_MODE) >= 9)?
+			true:false;
+
+		Bit16u segment, offset;
+		if (is_32k) {
+			if (machine==MCH_PCJR) {
+				Bitu cpupage =
+					(real_readb(BIOSMEM_SEG, BIOSMEM_CRTCPU_PAGE) >> 3) & 0x7;
+				segment = cpupage << 10; // A14-16 to addr bits 14-16
+			} else
+				segment = 0xb800;
+			// bits 1 and 0 of y select the bank
+			// two pixels per byte (thus x>>1)
+			offset = (y >> 2) * (CurMode->swidth >> 1) + (x>>1);
+			// select the scanline bank
+			offset += (8*1024) * (y & 3);
+		} else {
+			segment = 0xb800;
+			// bit 0 of y selects the bank
+			offset = (y >> 1) * (CurMode->swidth >> 1) + (x>>1);
+			offset += (8*1024) * (y & 1);
+		}
 
-			if (color & 0x80) {
-	 			p[ind]^=(color & 0x7f);
-			} else {
-				p[ind]=color;
-			}
-			old = (p[1] << 4) | p[0];
-			real_writeb(0xb800,off,old);
+		// update the pixel
+		Bit8u old=real_readb(segment, offset);
+		Bit8u p[2];
+		p[1] = (old >> 4) & 0xf;
+		p[0] = old & 0xf;
+		Bitu ind = 1-(x & 0x1);
+
+		if (color & 0x80) {
+			// color is to be XORed
+	 		p[ind]^=(color & 0x7f);
+		} else {
+			p[ind]=color;
 		}
-		break;
+		old = (p[1] << 4) | p[0];
+		real_writeb(segment,offset, old);
+	}
+	break;
 	case M_LIN4:
 		if ((machine!=MCH_VGA) || (svgaCard!=SVGA_TsengET4K) ||
 				(CurMode->swidth>800)) {
diff -Nur dosbox-0.74/src/ints/int10_vesa.cpp dosbox-0.74.patch/src/ints/int10_vesa.cpp
--- dosbox-0.74/src/ints/int10_vesa.cpp	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/ints/int10_vesa.cpp	2016-12-11 18:35:15.550284005 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: int10_vesa.cpp,v 1.40 2009-07-31 15:36:01 c2woody Exp $ */
 
 #include <string.h>
 #include <stddef.h>
@@ -29,6 +28,13 @@
 #include "int10.h"
 #include "dos_inc.h"
 
+#define VESA_SUCCESS          0x00
+#define VESA_FAIL             0x01
+#define VESA_HW_UNSUPPORTED   0x02
+#define VESA_MODE_UNSUPPORTED 0x03
+// internal definition to pass to the caller
+#define VESA_UNIMPLEMENTED    0xFF
+
 static struct {
 	Bitu setwindow;
 	Bitu pmStart;
@@ -117,7 +123,7 @@
 	mem_writed(buffer+0x0a,0x0);					//Capabilities and flags
 	mem_writed(buffer+0x0e,int10.rom.vesa_modes);	//VESA Mode list
 	mem_writew(buffer+0x12,(Bit16u)(vga.vmemsize/(64*1024))); // memory size in 64kb blocks
-	return 0x00;
+	return VESA_SUCCESS;
 }
 
 Bit8u VESA_GetSVGAModeInformation(Bit16u mode,Bit16u seg,Bit16u off) {
@@ -136,14 +142,13 @@
 	while (ModeList_VGA[i].mode!=0xffff) {
 		if (mode==ModeList_VGA[i].mode) goto foundit; else i++;
 	}
-	return 0x01;
+	return VESA_FAIL;
 foundit:
 	if ((int10.vesa_oldvbe) && (ModeList_VGA[i].mode>=0x120)) return 0x01;
 	VideoModeBlock * mblock=&ModeList_VGA[i];
 	switch (mblock->type) {
 	case M_LIN4:
 		pageSize = mblock->sheight * mblock->swidth/2;
-		pageSize = (pageSize | 15) & ~ 15;
 		var_write(&minfo.BytesPerScanLine,mblock->swidth/8);
 		var_write(&minfo.NumberOfPlanes,0x4);
 		var_write(&minfo.BitsPerPixel,4);
@@ -152,7 +157,6 @@
 		break;
 	case M_LIN8:
 		pageSize = mblock->sheight * mblock->swidth;
-		pageSize = (pageSize | 15) & ~ 15;
 		var_write(&minfo.BytesPerScanLine,mblock->swidth);
 		var_write(&minfo.NumberOfPlanes,0x1);
 		var_write(&minfo.BitsPerPixel,8);
@@ -162,7 +166,6 @@
 		break;
 	case M_LIN15:
 		pageSize = mblock->sheight * mblock->swidth*2;
-		pageSize = (pageSize | 15) & ~ 15;
 		var_write(&minfo.BytesPerScanLine,mblock->swidth*2);
 		var_write(&minfo.NumberOfPlanes,0x1);
 		var_write(&minfo.BitsPerPixel,15);
@@ -180,7 +183,6 @@
 		break;
 	case M_LIN16:
 		pageSize = mblock->sheight * mblock->swidth*2;
-		pageSize = (pageSize | 15) & ~ 15;
 		var_write(&minfo.BytesPerScanLine,mblock->swidth*2);
 		var_write(&minfo.NumberOfPlanes,0x1);
 		var_write(&minfo.BitsPerPixel,16);
@@ -196,7 +198,6 @@
 		break;
 	case M_LIN32:
 		pageSize = mblock->sheight * mblock->swidth*4;
-		pageSize = (pageSize | 15) & ~ 15;
 		var_write(&minfo.BytesPerScanLine,mblock->swidth*4);
 		var_write(&minfo.NumberOfPlanes,0x1);
 		var_write(&minfo.BitsPerPixel,32);
@@ -212,36 +213,40 @@
 		modeAttributes = 0x1b;	// Color, graphics
 		if (!int10.vesa_nolfb) modeAttributes |= 0x80;	// linear framebuffer
 		break;
-/*	case M_TEXT:
-		pageSize = mblock->sheight/8 * mblock->swidth*2/8;
-		pageSize = (pageSize | 15) & ~ 15;
-		var_write(&minfo.BytesPerScanLine,mblock->swidth*2/8);
+	case M_TEXT:
+		pageSize = 0;
+		var_write(&minfo.BytesPerScanLine, mblock->twidth * 2);
 		var_write(&minfo.NumberOfPlanes,0x4);
 		var_write(&minfo.BitsPerPixel,4);
-		var_write(&minfo.MemoryModel,0);	//Text
+		var_write(&minfo.MemoryModel,0);	// text
 		modeAttributes = 0x0f;	//Color, text, bios output
-		break; */
+		break;
 	default:
-		return 0x1;
-	}
-	var_write(&minfo.WinAAttributes,0x7);	// Exists/readable/writable
-	
-	if(pageSize > vga.vmemsize) {
-		// Mode not supported by current hardware configuration
-		var_write(&minfo.ModeAttributes, modeAttributes & ~0x1);
-		var_write(&minfo.NumberOfImagePages,0);
-	} else {
-		var_write(&minfo.ModeAttributes, modeAttributes);
-		Bitu pages = (vga.vmemsize / pageSize)-1;
-		var_write(&minfo.NumberOfImagePages,pages);
+		return VESA_FAIL;
 	}
+	if (pageSize & 0xFFFF) {
+		// It is documented that many applications assume 64k-aligned page sizes
+		// VBETEST is one of them
+		pageSize += 0x10000;
+		pageSize &= ~0xFFFF;
+	}
+	Bitu pages = 0;
+	if (pageSize > vga.vmemsize) {
+		// mode not supported by current hardware configuration
+		modeAttributes &= ~0x1;
+	} else if (pageSize) {
+		pages = (vga.vmemsize / pageSize)-1;
+	}
+	var_write(&minfo.NumberOfImagePages, pages);
+	var_write(&minfo.ModeAttributes, modeAttributes);
+	var_write(&minfo.WinAAttributes, 0x7);	// Exists/readable/writable
 
 	if (mblock->type==M_TEXT) {
 		var_write(&minfo.WinGranularity,32);
 		var_write(&minfo.WinSize,32);
 		var_write(&minfo.WinASegment,0xb800);
-		var_write(&minfo.XResolution,mblock->swidth/8);
-		var_write(&minfo.YResolution,mblock->sheight/8);
+		var_write(&minfo.XResolution,mblock->twidth);
+		var_write(&minfo.YResolution,mblock->theight);
 	} else {
 		var_write(&minfo.WinGranularity,64);
 		var_write(&minfo.WinSize,64);
@@ -257,46 +262,46 @@
 	if (!int10.vesa_nolfb) var_write(&minfo.PhysBasePtr,S3_LFB_BASE);
 
 	MEM_BlockWrite(buf,&minfo,sizeof(MODE_INFO));
-	return 0x00;
+	return VESA_SUCCESS;
 }
 
 
 Bit8u VESA_SetSVGAMode(Bit16u mode) {
 	if (INT10_SetVideoMode(mode)) {
 		int10.vesa_setmode=mode&0x7fff;
-		return 0x00;
+		return VESA_SUCCESS;
 	}
-	return 0x01;
+	return VESA_FAIL;
 }
 
 Bit8u VESA_GetSVGAMode(Bit16u & mode) {
 	if (int10.vesa_setmode!=0xffff) mode=int10.vesa_setmode;
 	else mode=CurMode->mode;
-	return 0x00;
+	return VESA_SUCCESS;
 }
 
 Bit8u VESA_SetCPUWindow(Bit8u window,Bit8u address) {
-	if (window) return 0x1;
+	if (window) return VESA_FAIL;
 	if (((Bit32u)(address)*64*1024<vga.vmemsize)) {
 		IO_Write(0x3d4,0x6a);
 		IO_Write(0x3d5,(Bit8u)address);
-		return 0x0;
-	} else return 0x1;
+		return VESA_SUCCESS;
+	} else return VESA_FAIL;
 }
 
 Bit8u VESA_GetCPUWindow(Bit8u window,Bit16u & address) {
-	if (window) return 0x1;
+	if (window) return VESA_FAIL;
 	IO_Write(0x3d4,0x6a);
 	address=IO_Read(0x3d5);
-	return 0x0;
+	return VESA_SUCCESS;
 }
 
 
 Bit8u VESA_SetPalette(PhysPt data,Bitu index,Bitu count) {
 //Structure is (vesa 3.0 doc): blue,green,red,alignment
 	Bit8u r,g,b;
-	if (index>255) return 0x1;
-	if (index+count>256) return 0x1;
+	if (index>255) return VESA_FAIL;
+	if (index+count>256) return VESA_FAIL;
 	IO_Write(0x3c8,(Bit8u)index);
 	while (count) {
 		b = mem_readb(data++);
@@ -308,14 +313,14 @@
 		IO_Write(0x3c9,b);
 		count--;
 	}
-	return 0x00;
+	return VESA_SUCCESS;
 }
 
 
 Bit8u VESA_GetPalette(PhysPt data,Bitu index,Bitu count) {
 	Bit8u r,g,b;
-	if (index>255) return 0x1;
-	if (index+count>256) return 0x1;
+	if (index>255) return VESA_FAIL;
+	if (index+count>256) return VESA_FAIL;
 	IO_Write(0x3c7,(Bit8u)index);
 	while (count) {
 		r = IO_Read(0x3c9);
@@ -327,114 +332,182 @@
 		data++;
 		count--;
 	}
-	return 0x00;
+	return VESA_SUCCESS;
 }
 
+// maximum offset for the S3 Trio64 is 10 bits
+#define S3_MAX_OFFSET 0x3ff
 
 Bit8u VESA_ScanLineLength(Bit8u subcall,Bit16u val, Bit16u & bytes,Bit16u & pixels,Bit16u & lines) {
-	Bit8u bpp;
+	// offset register: virtual scanline length
+	Bitu pixels_per_offset;
+	Bitu bytes_per_offset = 8;
+	Bitu vmemsize = vga.vmemsize;
+	Bitu new_offset = vga.config.scan_len;
+	Bitu screen_height = CurMode->sheight;
+
 	switch (CurMode->type) {
+	case M_TEXT:
+		vmemsize = 0x8000;      // we have only the 32kB window here
+		screen_height = CurMode->theight;
+		pixels_per_offset = 16; // two characters each 8 pixels wide
+		bytes_per_offset = 4;   // 2 characters + 2 attributes
+		break;
 	case M_LIN4:
-		bpp = 1;
+		pixels_per_offset = 16;
 		break;
 	case M_LIN8:
-		bpp=1;
+		pixels_per_offset = 8;
 		break;
 	case M_LIN15:
 	case M_LIN16:
-		bpp=2;
+		pixels_per_offset = 4;
 		break;
 	case M_LIN32:
-		bpp=4;
+		pixels_per_offset = 2;
 		break;
 	default:
-		return 0x1;
+		return VESA_MODE_UNSUPPORTED;
 	}
 	switch (subcall) {
-	case 0x00:	/* Set in pixels */
-		if(CurMode->type==M_LIN4) vga.config.scan_len=val/2;
-		else vga.config.scan_len = (val * bpp);
-		break;
-	case 0x02:	/* Set in bytes */
-		if(CurMode->type==M_LIN4) vga.config.scan_len = val*4;
-		else vga.config.scan_len = val;
-		break;
-	case 0x03:	/* Get maximum */
-		bytes=0x400*4;
-		pixels=bytes/bpp;
-		lines = (Bit16u)(vga.vmemsize / bytes);
-		return 0x00;
-	case 0x01:	/* Get lengths */
+	case 0x00: // set scan length in pixels
+		new_offset = val / pixels_per_offset;
+		if (val % pixels_per_offset) new_offset++;
+		
+		if (new_offset > S3_MAX_OFFSET)
+			return VESA_HW_UNSUPPORTED; // scanline too long
+		vga.config.scan_len = new_offset;
+		VGA_CheckScanLength();
+		break;
+
+	case 0x01: // get current scanline length
+		// implemented at the end of this function
+		break;
+
+	case 0x02: // set scan length in bytes
+		new_offset = val / bytes_per_offset;
+		if (val % bytes_per_offset) new_offset++;
+		
+		if (new_offset > S3_MAX_OFFSET)
+			return VESA_HW_UNSUPPORTED; // scanline too long
+		vga.config.scan_len = new_offset;
+		VGA_CheckScanLength();
+		break;
+
+	case 0x03: // get maximum scan line length
+		// the smaller of either the hardware maximum scanline length or
+		// the limit to get full y resolution of this mode
+		new_offset = S3_MAX_OFFSET;
+		if ((new_offset * bytes_per_offset * screen_height) > vmemsize)
+			new_offset = vmemsize / (bytes_per_offset * screen_height);
 		break;
+
 	default:
-		return 0x1;			//Illegal call
+		return VESA_UNIMPLEMENTED;
 	}
-	if (subcall!=0x01) {
-		/* Write the scan line to video card the simple way */
-		if (vga.config.scan_len & 7)
-			vga.config.scan_len += 8;
-		vga.config.scan_len /= 8;
-	}
-	if(CurMode->type==M_LIN4) {
-		pixels=(vga.config.scan_len*16)/bpp;
-		bytes=vga.config.scan_len*2;
-		lines = (Bit16u)(vga.vmemsize /( bytes*4));
-	}
-	else {
-		pixels=(vga.config.scan_len*8)/bpp;
-		bytes=vga.config.scan_len*8;
-		lines = (Bit16u)(vga.vmemsize / bytes);
-	}
-	VGA_StartResize();
-	return 0x0;
+
+	// set up the return values
+	bytes = (Bit16u)(new_offset * bytes_per_offset);
+	pixels = (Bit16u)(new_offset * pixels_per_offset);
+	if (!bytes)
+		// return failure on division by zero
+		// some real VESA BIOS implementations may crash here
+		return VESA_FAIL;
+
+	lines = (Bit16u)(vmemsize / bytes);
+	
+	if (CurMode->type==M_TEXT)
+		lines *= CurMode->cheight;
+
+	return VESA_SUCCESS;
 }
 
 Bit8u VESA_SetDisplayStart(Bit16u x,Bit16u y) {
-	//TODO Maybe do things differently with lowres double line modes?	
-	Bitu start;
+	// TODO wait for retrace in case bl==0x80
+	Bitu pixels_per_offset;
+	Bitu panning_factor = 1;
+
 	switch (CurMode->type) {
+	case M_TEXT:
 	case M_LIN4:
-		start=vga.config.scan_len*16*y+x;
-		vga.config.display_start=start/8;
-		IO_Read(0x3da);
-		IO_Write(0x3c0,0x13+32);
-		IO_Write(0x3c0,start % 8);
+		pixels_per_offset = 16;
 		break;
 	case M_LIN8:
-		start=vga.config.scan_len*8*y+x;
-		vga.config.display_start=start/4;
-		IO_Read(0x3da);
-		IO_Write(0x3c0,0x13+32);
-		IO_Write(0x3c0,(start % 4)*2);
+		panning_factor = 2; // the panning register ignores bit0 in this mode
+		pixels_per_offset = 8;
 		break;
-	case M_LIN16:
 	case M_LIN15:
-		start=vga.config.scan_len*8*y+x*2;
-		vga.config.display_start=start/4;
+	case M_LIN16:
+		panning_factor = 2; // this may be DOSBox specific
+		pixels_per_offset = 4;
 		break;
 	case M_LIN32:
-		start=vga.config.scan_len*8*y+x*4;
-		vga.config.display_start=start/4;
+		pixels_per_offset = 2;
 		break;
 	default:
-		return 0x1;
+		return VESA_MODE_UNSUPPORTED;
 	}
-	return 0x00;
+	// We would have to divide y by the character height for text modes and
+	// write the remainder to the CRTC preset row scan register,
+	// but VBE2 BIOSes that actually get that far also don't.
+	// Only a VBE3 BIOS got it right.
+	Bitu virtual_screen_width = vga.config.scan_len * pixels_per_offset;
+	Bitu new_start_pixel = virtual_screen_width * y + x;
+	Bitu new_crtc_start = new_start_pixel / (pixels_per_offset/2);
+	Bitu new_panning = new_start_pixel % (pixels_per_offset/2);
+	new_panning *= panning_factor;
+
+	vga.config.display_start = new_crtc_start;
+	
+	// Setting the panning register is nice as it allows for super smooth
+	// scrolling, but if we hit the retrace pulse there may be flicker as
+	// panning and display start are latched at different times. 
+
+	IO_Read(0x3da);              // reset attribute flipflop
+	IO_Write(0x3c0,0x13 | 0x20); // panning register, screen on
+	IO_Write(0x3c0,new_panning);
+
+	return VESA_SUCCESS;
 }
 
 Bit8u VESA_GetDisplayStart(Bit16u & x,Bit16u & y) {
-	Bitu times=(vga.config.display_start*4)/(vga.config.scan_len*8);
-	Bitu rem=(vga.config.display_start*4) % (vga.config.scan_len*8);
-	Bitu pan=vga.config.pel_panning;
+	Bitu pixels_per_offset;
+	Bitu panning_factor = 1;
+
 	switch (CurMode->type) {
+	case M_TEXT:
+		pixels_per_offset = 16;
+		break;
+	case M_LIN4:
+		pixels_per_offset = 16;
+		break;
 	case M_LIN8:
-		y=(Bit16u)times;
-		x=(Bit16u)(rem+pan);
+		panning_factor = 2;
+		pixels_per_offset = 8;
+		break;
+	case M_LIN15:
+	case M_LIN16:
+		panning_factor = 2;
+		pixels_per_offset = 4;
+		break;
+	case M_LIN32:
+		pixels_per_offset = 2;
 		break;
 	default:
-		return 0x1;
+		return VESA_MODE_UNSUPPORTED;
 	}
-	return 0x00;
+
+	IO_Read(0x3da);              // reset attribute flipflop
+	IO_Write(0x3c0,0x13 | 0x20); // panning register, screen on
+	Bit8u panning = IO_Read(0x3c1);
+
+	Bitu virtual_screen_width = vga.config.scan_len * pixels_per_offset;
+	Bitu start_pixel = vga.config.display_start * (pixels_per_offset/2) 
+		+ panning / panning_factor;
+	
+	y = start_pixel / virtual_screen_width;
+	x = start_pixel % virtual_screen_width;
+	return VESA_SUCCESS;
 }
 
 static Bitu VESA_SetWindow(void) {
@@ -453,6 +526,10 @@
 	return 0;
 }
 static Bitu VESA_PMSetStart(void) {
+	// This function is from VBE2 and directly sets the VGA
+	// display start address.
+
+	// TODO wait for retrace in case bl==0x80
 	Bit32u start = (reg_dx << 16) | reg_cx;
 	vga.config.display_start = start;
 	return 0;
diff -Nur dosbox-0.74/src/ints/int10_video_state.cpp dosbox-0.74.patch/src/ints/int10_video_state.cpp
--- dosbox-0.74/src/ints/int10_video_state.cpp	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/ints/int10_video_state.cpp	2016-12-11 18:35:15.550284005 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: int10_video_state.cpp,v 1.3 2009-05-27 09:15:42 qbix79 Exp $ */
 
 #include "dosbox.h"
 #include "mem.h"
diff -Nur dosbox-0.74/src/ints/int10_vptable.cpp dosbox-0.74.patch/src/ints/int10_vptable.cpp
--- dosbox-0.74/src/ints/int10_vptable.cpp	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/ints/int10_vptable.cpp	2016-12-11 18:35:15.550284005 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: int10_vptable.cpp,v 1.6 2009-08-01 13:39:48 c2woody Exp $ */
 
 #include "dosbox.h"
 #include "mem.h"
diff -Nur dosbox-0.74/src/ints/Makefile.in dosbox-0.74.patch/src/ints/Makefile.in
--- dosbox-0.74/src/ints/Makefile.in	2010-05-12 11:57:44.000000000 +0200
+++ dosbox-0.74.patch/src/ints/Makefile.in	1970-01-01 01:00:00.000000000 +0100
@@ -1,468 +0,0 @@
-# Makefile.in generated by automake 1.11.1 from Makefile.am.
-# @configure_input@
-
-# Copyright (C) 1994, 1995, 1996, 1997, 1998, 1999, 2000, 2001, 2002,
-# 2003, 2004, 2005, 2006, 2007, 2008, 2009  Free Software Foundation,
-# Inc.
-# This Makefile.in is free software; the Free Software Foundation
-# gives unlimited permission to copy and/or distribute it,
-# with or without modifications, as long as this notice is preserved.
-
-# This program is distributed in the hope that it will be useful,
-# but WITHOUT ANY WARRANTY, to the extent permitted by law; without
-# even the implied warranty of MERCHANTABILITY or FITNESS FOR A
-# PARTICULAR PURPOSE.
-
-@SET_MAKE@
-
-VPATH = @srcdir@
-pkgdatadir = $(datadir)/@PACKAGE@
-pkgincludedir = $(includedir)/@PACKAGE@
-pkglibdir = $(libdir)/@PACKAGE@
-pkglibexecdir = $(libexecdir)/@PACKAGE@
-am__cd = CDPATH="$${ZSH_VERSION+.}$(PATH_SEPARATOR)" && cd
-install_sh_DATA = $(install_sh) -c -m 644
-install_sh_PROGRAM = $(install_sh) -c
-install_sh_SCRIPT = $(install_sh) -c
-INSTALL_HEADER = $(INSTALL_DATA)
-transform = $(program_transform_name)
-NORMAL_INSTALL = :
-PRE_INSTALL = :
-POST_INSTALL = :
-NORMAL_UNINSTALL = :
-PRE_UNINSTALL = :
-POST_UNINSTALL = :
-build_triplet = @build@
-host_triplet = @host@
-subdir = src/ints
-DIST_COMMON = $(srcdir)/Makefile.am $(srcdir)/Makefile.in
-ACLOCAL_M4 = $(top_srcdir)/aclocal.m4
-am__aclocal_m4_deps = $(top_srcdir)/acinclude.m4 \
-	$(top_srcdir)/configure.in
-am__configure_deps = $(am__aclocal_m4_deps) $(CONFIGURE_DEPENDENCIES) \
-	$(ACLOCAL_M4)
-mkinstalldirs = $(install_sh) -d
-CONFIG_HEADER = $(top_builddir)/config.h
-CONFIG_CLEAN_FILES =
-CONFIG_CLEAN_VPATH_FILES =
-LIBRARIES = $(noinst_LIBRARIES)
-AR = ar
-ARFLAGS = cru
-libints_a_AR = $(AR) $(ARFLAGS)
-libints_a_LIBADD =
-am_libints_a_OBJECTS = mouse.$(OBJEXT) xms.$(OBJEXT) ems.$(OBJEXT) \
-	int10.$(OBJEXT) int10_char.$(OBJEXT) int10_memory.$(OBJEXT) \
-	int10_misc.$(OBJEXT) int10_modes.$(OBJEXT) \
-	int10_vesa.$(OBJEXT) int10_pal.$(OBJEXT) \
-	int10_put_pixel.$(OBJEXT) int10_video_state.$(OBJEXT) \
-	int10_vptable.$(OBJEXT) bios.$(OBJEXT) bios_disk.$(OBJEXT) \
-	bios_keyboard.$(OBJEXT)
-libints_a_OBJECTS = $(am_libints_a_OBJECTS)
-DEFAULT_INCLUDES = -I.@am__isrc@ -I$(top_builddir)
-depcomp = $(SHELL) $(top_srcdir)/depcomp
-am__depfiles_maybe = depfiles
-am__mv = mv -f
-CXXCOMPILE = $(CXX) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) \
-	$(AM_CPPFLAGS) $(CPPFLAGS) $(AM_CXXFLAGS) $(CXXFLAGS)
-CXXLD = $(CXX)
-CXXLINK = $(CXXLD) $(AM_CXXFLAGS) $(CXXFLAGS) $(AM_LDFLAGS) $(LDFLAGS) \
-	-o $@
-COMPILE = $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) \
-	$(CPPFLAGS) $(AM_CFLAGS) $(CFLAGS)
-CCLD = $(CC)
-LINK = $(CCLD) $(AM_CFLAGS) $(CFLAGS) $(AM_LDFLAGS) $(LDFLAGS) -o $@
-SOURCES = $(libints_a_SOURCES)
-DIST_SOURCES = $(libints_a_SOURCES)
-ETAGS = etags
-CTAGS = ctags
-DISTFILES = $(DIST_COMMON) $(DIST_SOURCES) $(TEXINFOS) $(EXTRA_DIST)
-ACLOCAL = @ACLOCAL@
-ALSA_CFLAGS = @ALSA_CFLAGS@
-ALSA_LIBS = @ALSA_LIBS@
-AMTAR = @AMTAR@
-AUTOCONF = @AUTOCONF@
-AUTOHEADER = @AUTOHEADER@
-AUTOMAKE = @AUTOMAKE@
-AWK = @AWK@
-CC = @CC@
-CCDEPMODE = @CCDEPMODE@
-CFLAGS = @CFLAGS@
-CPP = @CPP@
-CPPFLAGS = @CPPFLAGS@
-CXX = @CXX@
-CXXDEPMODE = @CXXDEPMODE@
-CXXFLAGS = @CXXFLAGS@
-CYGPATH_W = @CYGPATH_W@
-DEFS = @DEFS@
-DEPDIR = @DEPDIR@
-ECHO_C = @ECHO_C@
-ECHO_N = @ECHO_N@
-ECHO_T = @ECHO_T@
-EGREP = @EGREP@
-EXEEXT = @EXEEXT@
-GREP = @GREP@
-INSTALL = @INSTALL@
-INSTALL_DATA = @INSTALL_DATA@
-INSTALL_PROGRAM = @INSTALL_PROGRAM@
-INSTALL_SCRIPT = @INSTALL_SCRIPT@
-INSTALL_STRIP_PROGRAM = @INSTALL_STRIP_PROGRAM@
-LDFLAGS = @LDFLAGS@
-LIBOBJS = @LIBOBJS@
-LIBS = @LIBS@
-LTLIBOBJS = @LTLIBOBJS@
-MAKEINFO = @MAKEINFO@
-MKDIR_P = @MKDIR_P@
-OBJEXT = @OBJEXT@
-PACKAGE = @PACKAGE@
-PACKAGE_BUGREPORT = @PACKAGE_BUGREPORT@
-PACKAGE_NAME = @PACKAGE_NAME@
-PACKAGE_STRING = @PACKAGE_STRING@
-PACKAGE_TARNAME = @PACKAGE_TARNAME@
-PACKAGE_URL = @PACKAGE_URL@
-PACKAGE_VERSION = @PACKAGE_VERSION@
-PATH_SEPARATOR = @PATH_SEPARATOR@
-RANLIB = @RANLIB@
-SDL_CFLAGS = @SDL_CFLAGS@
-SDL_CONFIG = @SDL_CONFIG@
-SDL_LIBS = @SDL_LIBS@
-SET_MAKE = @SET_MAKE@
-SHELL = @SHELL@
-STRIP = @STRIP@
-VERSION = @VERSION@
-WINDRES = @WINDRES@
-abs_builddir = @abs_builddir@
-abs_srcdir = @abs_srcdir@
-abs_top_builddir = @abs_top_builddir@
-abs_top_srcdir = @abs_top_srcdir@
-ac_ct_CC = @ac_ct_CC@
-ac_ct_CXX = @ac_ct_CXX@
-am__include = @am__include@
-am__leading_dot = @am__leading_dot@
-am__quote = @am__quote@
-am__tar = @am__tar@
-am__untar = @am__untar@
-bindir = @bindir@
-build = @build@
-build_alias = @build_alias@
-build_cpu = @build_cpu@
-build_os = @build_os@
-build_vendor = @build_vendor@
-builddir = @builddir@
-datadir = @datadir@
-datarootdir = @datarootdir@
-docdir = @docdir@
-dvidir = @dvidir@
-exec_prefix = @exec_prefix@
-host = @host@
-host_alias = @host_alias@
-host_cpu = @host_cpu@
-host_os = @host_os@
-host_vendor = @host_vendor@
-htmldir = @htmldir@
-includedir = @includedir@
-infodir = @infodir@
-install_sh = @install_sh@
-libdir = @libdir@
-libexecdir = @libexecdir@
-localedir = @localedir@
-localstatedir = @localstatedir@
-mandir = @mandir@
-mkdir_p = @mkdir_p@
-oldincludedir = @oldincludedir@
-pdfdir = @pdfdir@
-prefix = @prefix@
-program_transform_name = @program_transform_name@
-psdir = @psdir@
-sbindir = @sbindir@
-sharedstatedir = @sharedstatedir@
-srcdir = @srcdir@
-sysconfdir = @sysconfdir@
-target_alias = @target_alias@
-top_build_prefix = @top_build_prefix@
-top_builddir = @top_builddir@
-top_srcdir = @top_srcdir@
-AM_CPPFLAGS = -I$(top_srcdir)/include
-noinst_LIBRARIES = libints.a
-libints_a_SOURCES = mouse.cpp xms.cpp xms.h ems.cpp \
-                    int10.cpp int10.h int10_char.cpp int10_memory.cpp int10_misc.cpp int10_modes.cpp \
-                    int10_vesa.cpp int10_pal.cpp int10_put_pixel.cpp int10_video_state.cpp int10_vptable.cpp \
-                    bios.cpp bios_disk.cpp bios_keyboard.cpp 
-
-all: all-am
-
-.SUFFIXES:
-.SUFFIXES: .cpp .o .obj
-$(srcdir)/Makefile.in:  $(srcdir)/Makefile.am  $(am__configure_deps)
-	@for dep in $?; do \
-	  case '$(am__configure_deps)' in \
-	    *$$dep*) \
-	      ( cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh ) \
-	        && { if test -f $@; then exit 0; else break; fi; }; \
-	      exit 1;; \
-	  esac; \
-	done; \
-	echo ' cd $(top_srcdir) && $(AUTOMAKE) --gnu src/ints/Makefile'; \
-	$(am__cd) $(top_srcdir) && \
-	  $(AUTOMAKE) --gnu src/ints/Makefile
-.PRECIOUS: Makefile
-Makefile: $(srcdir)/Makefile.in $(top_builddir)/config.status
-	@case '$?' in \
-	  *config.status*) \
-	    cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh;; \
-	  *) \
-	    echo ' cd $(top_builddir) && $(SHELL) ./config.status $(subdir)/$@ $(am__depfiles_maybe)'; \
-	    cd $(top_builddir) && $(SHELL) ./config.status $(subdir)/$@ $(am__depfiles_maybe);; \
-	esac;
-
-$(top_builddir)/config.status: $(top_srcdir)/configure $(CONFIG_STATUS_DEPENDENCIES)
-	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
-
-$(top_srcdir)/configure:  $(am__configure_deps)
-	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
-$(ACLOCAL_M4):  $(am__aclocal_m4_deps)
-	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
-$(am__aclocal_m4_deps):
-
-clean-noinstLIBRARIES:
-	-test -z "$(noinst_LIBRARIES)" || rm -f $(noinst_LIBRARIES)
-libints.a: $(libints_a_OBJECTS) $(libints_a_DEPENDENCIES) 
-	-rm -f libints.a
-	$(libints_a_AR) libints.a $(libints_a_OBJECTS) $(libints_a_LIBADD)
-	$(RANLIB) libints.a
-
-mostlyclean-compile:
-	-rm -f *.$(OBJEXT)
-
-distclean-compile:
-	-rm -f *.tab.c
-
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/bios.Po@am__quote@
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/bios_disk.Po@am__quote@
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/bios_keyboard.Po@am__quote@
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/ems.Po@am__quote@
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/int10.Po@am__quote@
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/int10_char.Po@am__quote@
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/int10_memory.Po@am__quote@
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/int10_misc.Po@am__quote@
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/int10_modes.Po@am__quote@
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/int10_pal.Po@am__quote@
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/int10_put_pixel.Po@am__quote@
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/int10_vesa.Po@am__quote@
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/int10_video_state.Po@am__quote@
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/int10_vptable.Po@am__quote@
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/mouse.Po@am__quote@
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/xms.Po@am__quote@
-
-.cpp.o:
-@am__fastdepCXX_TRUE@	$(CXXCOMPILE) -MT $@ -MD -MP -MF $(DEPDIR)/$*.Tpo -c -o $@ $<
-@am__fastdepCXX_TRUE@	$(am__mv) $(DEPDIR)/$*.Tpo $(DEPDIR)/$*.Po
-@AMDEP_TRUE@@am__fastdepCXX_FALSE@	source='$<' object='$@' libtool=no @AMDEPBACKSLASH@
-@AMDEP_TRUE@@am__fastdepCXX_FALSE@	DEPDIR=$(DEPDIR) $(CXXDEPMODE) $(depcomp) @AMDEPBACKSLASH@
-@am__fastdepCXX_FALSE@	$(CXXCOMPILE) -c -o $@ $<
-
-.cpp.obj:
-@am__fastdepCXX_TRUE@	$(CXXCOMPILE) -MT $@ -MD -MP -MF $(DEPDIR)/$*.Tpo -c -o $@ `$(CYGPATH_W) '$<'`
-@am__fastdepCXX_TRUE@	$(am__mv) $(DEPDIR)/$*.Tpo $(DEPDIR)/$*.Po
-@AMDEP_TRUE@@am__fastdepCXX_FALSE@	source='$<' object='$@' libtool=no @AMDEPBACKSLASH@
-@AMDEP_TRUE@@am__fastdepCXX_FALSE@	DEPDIR=$(DEPDIR) $(CXXDEPMODE) $(depcomp) @AMDEPBACKSLASH@
-@am__fastdepCXX_FALSE@	$(CXXCOMPILE) -c -o $@ `$(CYGPATH_W) '$<'`
-
-ID: $(HEADERS) $(SOURCES) $(LISP) $(TAGS_FILES)
-	list='$(SOURCES) $(HEADERS) $(LISP) $(TAGS_FILES)'; \
-	unique=`for i in $$list; do \
-	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
-	  done | \
-	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
-	      END { if (nonempty) { for (i in files) print i; }; }'`; \
-	mkid -fID $$unique
-tags: TAGS
-
-TAGS:  $(HEADERS) $(SOURCES)  $(TAGS_DEPENDENCIES) \
-		$(TAGS_FILES) $(LISP)
-	set x; \
-	here=`pwd`; \
-	list='$(SOURCES) $(HEADERS)  $(LISP) $(TAGS_FILES)'; \
-	unique=`for i in $$list; do \
-	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
-	  done | \
-	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
-	      END { if (nonempty) { for (i in files) print i; }; }'`; \
-	shift; \
-	if test -z "$(ETAGS_ARGS)$$*$$unique"; then :; else \
-	  test -n "$$unique" || unique=$$empty_fix; \
-	  if test $$# -gt 0; then \
-	    $(ETAGS) $(ETAGSFLAGS) $(AM_ETAGSFLAGS) $(ETAGS_ARGS) \
-	      "$$@" $$unique; \
-	  else \
-	    $(ETAGS) $(ETAGSFLAGS) $(AM_ETAGSFLAGS) $(ETAGS_ARGS) \
-	      $$unique; \
-	  fi; \
-	fi
-ctags: CTAGS
-CTAGS:  $(HEADERS) $(SOURCES)  $(TAGS_DEPENDENCIES) \
-		$(TAGS_FILES) $(LISP)
-	list='$(SOURCES) $(HEADERS)  $(LISP) $(TAGS_FILES)'; \
-	unique=`for i in $$list; do \
-	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
-	  done | \
-	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
-	      END { if (nonempty) { for (i in files) print i; }; }'`; \
-	test -z "$(CTAGS_ARGS)$$unique" \
-	  || $(CTAGS) $(CTAGSFLAGS) $(AM_CTAGSFLAGS) $(CTAGS_ARGS) \
-	     $$unique
-
-GTAGS:
-	here=`$(am__cd) $(top_builddir) && pwd` \
-	  && $(am__cd) $(top_srcdir) \
-	  && gtags -i $(GTAGS_ARGS) "$$here"
-
-distclean-tags:
-	-rm -f TAGS ID GTAGS GRTAGS GSYMS GPATH tags
-
-distdir: $(DISTFILES)
-	@srcdirstrip=`echo "$(srcdir)" | sed 's/[].[^$$\\*]/\\\\&/g'`; \
-	topsrcdirstrip=`echo "$(top_srcdir)" | sed 's/[].[^$$\\*]/\\\\&/g'`; \
-	list='$(DISTFILES)'; \
-	  dist_files=`for file in $$list; do echo $$file; done | \
-	  sed -e "s|^$$srcdirstrip/||;t" \
-	      -e "s|^$$topsrcdirstrip/|$(top_builddir)/|;t"`; \
-	case $$dist_files in \
-	  */*) $(MKDIR_P) `echo "$$dist_files" | \
-			   sed '/\//!d;s|^|$(distdir)/|;s,/[^/]*$$,,' | \
-			   sort -u` ;; \
-	esac; \
-	for file in $$dist_files; do \
-	  if test -f $$file || test -d $$file; then d=.; else d=$(srcdir); fi; \
-	  if test -d $$d/$$file; then \
-	    dir=`echo "/$$file" | sed -e 's,/[^/]*$$,,'`; \
-	    if test -d "$(distdir)/$$file"; then \
-	      find "$(distdir)/$$file" -type d ! -perm -700 -exec chmod u+rwx {} \;; \
-	    fi; \
-	    if test -d $(srcdir)/$$file && test $$d != $(srcdir); then \
-	      cp -fpR $(srcdir)/$$file "$(distdir)$$dir" || exit 1; \
-	      find "$(distdir)/$$file" -type d ! -perm -700 -exec chmod u+rwx {} \;; \
-	    fi; \
-	    cp -fpR $$d/$$file "$(distdir)$$dir" || exit 1; \
-	  else \
-	    test -f "$(distdir)/$$file" \
-	    || cp -p $$d/$$file "$(distdir)/$$file" \
-	    || exit 1; \
-	  fi; \
-	done
-check-am: all-am
-check: check-am
-all-am: Makefile $(LIBRARIES)
-installdirs:
-install: install-am
-install-exec: install-exec-am
-install-data: install-data-am
-uninstall: uninstall-am
-
-install-am: all-am
-	@$(MAKE) $(AM_MAKEFLAGS) install-exec-am install-data-am
-
-installcheck: installcheck-am
-install-strip:
-	$(MAKE) $(AM_MAKEFLAGS) INSTALL_PROGRAM="$(INSTALL_STRIP_PROGRAM)" \
-	  install_sh_PROGRAM="$(INSTALL_STRIP_PROGRAM)" INSTALL_STRIP_FLAG=-s \
-	  `test -z '$(STRIP)' || \
-	    echo "INSTALL_PROGRAM_ENV=STRIPPROG='$(STRIP)'"` install
-mostlyclean-generic:
-
-clean-generic:
-
-distclean-generic:
-	-test -z "$(CONFIG_CLEAN_FILES)" || rm -f $(CONFIG_CLEAN_FILES)
-	-test . = "$(srcdir)" || test -z "$(CONFIG_CLEAN_VPATH_FILES)" || rm -f $(CONFIG_CLEAN_VPATH_FILES)
-
-maintainer-clean-generic:
-	@echo "This command is intended for maintainers to use"
-	@echo "it deletes files that may require special tools to rebuild."
-clean: clean-am
-
-clean-am: clean-generic clean-noinstLIBRARIES mostlyclean-am
-
-distclean: distclean-am
-	-rm -rf ./$(DEPDIR)
-	-rm -f Makefile
-distclean-am: clean-am distclean-compile distclean-generic \
-	distclean-tags
-
-dvi: dvi-am
-
-dvi-am:
-
-html: html-am
-
-html-am:
-
-info: info-am
-
-info-am:
-
-install-data-am:
-
-install-dvi: install-dvi-am
-
-install-dvi-am:
-
-install-exec-am:
-
-install-html: install-html-am
-
-install-html-am:
-
-install-info: install-info-am
-
-install-info-am:
-
-install-man:
-
-install-pdf: install-pdf-am
-
-install-pdf-am:
-
-install-ps: install-ps-am
-
-install-ps-am:
-
-installcheck-am:
-
-maintainer-clean: maintainer-clean-am
-	-rm -rf ./$(DEPDIR)
-	-rm -f Makefile
-maintainer-clean-am: distclean-am maintainer-clean-generic
-
-mostlyclean: mostlyclean-am
-
-mostlyclean-am: mostlyclean-compile mostlyclean-generic
-
-pdf: pdf-am
-
-pdf-am:
-
-ps: ps-am
-
-ps-am:
-
-uninstall-am:
-
-.MAKE: install-am install-strip
-
-.PHONY: CTAGS GTAGS all all-am check check-am clean clean-generic \
-	clean-noinstLIBRARIES ctags distclean distclean-compile \
-	distclean-generic distclean-tags distdir dvi dvi-am html \
-	html-am info info-am install install-am install-data \
-	install-data-am install-dvi install-dvi-am install-exec \
-	install-exec-am install-html install-html-am install-info \
-	install-info-am install-man install-pdf install-pdf-am \
-	install-ps install-ps-am install-strip installcheck \
-	installcheck-am installdirs maintainer-clean \
-	maintainer-clean-generic mostlyclean mostlyclean-compile \
-	mostlyclean-generic pdf pdf-am ps ps-am tags uninstall \
-	uninstall-am
-
-
-# Tell versions [3.59,3.63) of GNU make to not export all variables.
-# Otherwise a system limit (for SysV at least) may be exceeded.
-.NOEXPORT:
diff -Nur dosbox-0.74/src/ints/mouse.cpp dosbox-0.74.patch/src/ints/mouse.cpp
--- dosbox-0.74/src/ints/mouse.cpp	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/ints/mouse.cpp	2016-12-11 18:35:15.550284005 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: mouse.cpp,v 1.80 2009-06-16 19:00:26 qbix79 Exp $ */
 
 #include <string.h>
 #include <math.h>
@@ -51,8 +50,8 @@
 #define QUEUE_SIZE 32
 #define MOUSE_BUTTONS 3
 #define MOUSE_IRQ 12
-#define POS_X ((Bit16s)(mouse.x) & mouse.granMask)
-#define POS_Y (Bit16s)(mouse.y)
+#define POS_X (static_cast<Bit16s>(mouse.x) & mouse.gran_x)
+#define POS_Y (static_cast<Bit16s>(mouse.y) & mouse.gran_y)
 
 #define CURSORX 16
 #define CURSORY 16
@@ -126,7 +125,7 @@
 	bool timer_in_progress;
 	bool in_UIR;
 	Bit8u mode;
-	Bit16s granMask;
+	Bit16s gran_x,gran_y;
 } mouse;
 
 bool Mouse_SetPS2State(bool use) {
@@ -256,6 +255,7 @@
 	// Save Background
 	mouse.backposx		= POS_X>>3;
 	mouse.backposy		= POS_Y>>3;
+	if (mouse.mode < 2) mouse.backposx >>= 1; 
 
 	//use current page (CV program)
 	Bit8u page = real_readb(BIOSMEM_SEG,BIOSMEM_CURRENT_PAGE);
@@ -454,8 +454,12 @@
 	if((fabs(yrel) > 1.0) || (mouse.senv_y < 1.0)) dy *= mouse.senv_y;
 	if (useps2callback) dy *= 2;	
 
-	mouse.mickey_x += dx;
-	mouse.mickey_y += dy;
+	mouse.mickey_x += (dx * mouse.mickeysPerPixel_x);
+	mouse.mickey_y += (dy * mouse.mickeysPerPixel_y);
+	if (mouse.mickey_x >= 32768.0) mouse.mickey_x -= 65536.0;
+	else if (mouse.mickey_x <= -32769.0) mouse.mickey_x += 65536.0;
+	if (mouse.mickey_y >= 32768.0) mouse.mickey_y -= 65536.0;
+	else if (mouse.mickey_y <= -32769.0) mouse.mickey_y += 65536.0;
 	if (emulate) {
 		mouse.x += dx;
 		mouse.y += dy;
@@ -484,6 +488,11 @@
 		if (mouse.x < mouse.min_x) mouse.x = mouse.min_x;
 		if (mouse.y > mouse.max_y) mouse.y = mouse.max_y;
 		if (mouse.y < mouse.min_y) mouse.y = mouse.min_y;
+	} else {
+		if (mouse.x >= 32768.0) mouse.x -= 65536.0;
+		else if (mouse.x <= -32769.0) mouse.x += 65536.0;
+		if (mouse.y >= 32768.0) mouse.y -= 65536.0;
+		else if (mouse.y <= -32769.0) mouse.y += 65536.0;
 	}
 	Mouse_AddEvent(MOUSE_HAS_MOVED);
 	DrawCursor();
@@ -583,43 +592,48 @@
 
 //Does way to much. Many things should be moved to mouse reset one day
 void Mouse_NewVideoMode(void) {
-	mouse.inhibit_draw=false;
+	mouse.inhibit_draw = false;
 	/* Get the correct resolution from the current video mode */
-	Bit8u mode=mem_readb(BIOS_VIDEO_MODE);
+	Bit8u mode = mem_readb(BIOS_VIDEO_MODE);
 	if(mode == mouse.mode) {LOG(LOG_MOUSE,LOG_NORMAL)("New video is the same as the old"); /*return;*/}
+	mouse.gran_x = (Bit16s)0xffff;
+	mouse.gran_y = (Bit16s)0xffff;
 	switch (mode) {
 	case 0x00:
 	case 0x01:
 	case 0x02:
-	case 0x03: {
-		Bitu rows=real_readb(BIOSMEM_SEG,BIOSMEM_NB_ROWS);
-		if ((rows==0) || (rows>250)) rows=25-1;
-		mouse.max_y=8*(rows+1)-1;
+	case 0x03:
+	case 0x07: {
+		mouse.gran_x = (mode<2)?0xfff0:0xfff8;
+		mouse.gran_y = (Bit16s)0xfff8;
+		Bitu rows = real_readb(BIOSMEM_SEG,BIOSMEM_NB_ROWS);
+		if ((rows == 0) || (rows > 250)) rows = 25 - 1;
+		mouse.max_y = 8*(rows+1) - 1;
 		break;
 	}
 	case 0x04:
 	case 0x05:
 	case 0x06:
-	case 0x07:
 	case 0x08:
 	case 0x09:
 	case 0x0a:
 	case 0x0d:
 	case 0x0e:
 	case 0x13:
-		mouse.max_y=199;
+		if (mode == 0x0d || mode == 0x13) mouse.gran_x = (Bit16s)0xfffe;
+		mouse.max_y = 199;
 		break;
 	case 0x0f:
 	case 0x10:
-		mouse.max_y=349;
+		mouse.max_y = 349;
 		break;
 	case 0x11:
 	case 0x12:
-		mouse.max_y=479;
+		mouse.max_y = 479;
 		break;
 	default:
 		LOG(LOG_MOUSE,LOG_ERROR)("Unhandled videomode %X on reset",mode);
-		mouse.inhibit_draw=true;
+		mouse.inhibit_draw = true;
 		return;
 	}
 	mouse.mode = mode;
@@ -627,7 +641,6 @@
 	mouse.max_x = 639;
 	mouse.min_x = 0;
 	mouse.min_y = 0;
-	mouse.granMask = (mode == 0x0d || mode == 0x13) ? 0xfffe : 0xffff;
 
 	mouse.events = 0;
 	mouse.timer_in_progress = false;
@@ -793,8 +806,8 @@
 		mouse.textXorMask = reg_dx;
 		break;
 	case 0x0b:	/* Read Motion Data */
-		reg_cx=(Bit16s)(mouse.mickey_x*mouse.mickeysPerPixel_x);
-		reg_dx=(Bit16s)(mouse.mickey_y*mouse.mickeysPerPixel_y);
+		reg_cx=static_cast<Bit16s>(mouse.mickey_x);
+		reg_dx=static_cast<Bit16s>(mouse.mickey_y);
 		mouse.mickey_x=0;
 		mouse.mickey_y=0;
 		break;
@@ -916,6 +929,12 @@
 		reg_cx=(Bit16u)mouse.max_x;
 		reg_dx=(Bit16u)mouse.max_y;
 		break;
+	case 0x2a:	/* Get cursor hot spot */
+		reg_al=(Bit8u)-mouse.hidden;	// Microsoft uses a negative byte counter for cursor visibility
+		reg_bx=(Bit16u)mouse.hotx;
+		reg_cx=(Bit16u)mouse.hoty;
+		reg_dx=0x04;	// PS/2 mouse type
+		break;
 	case 0x31: /* Get Current Minimum/Maximum virtual coordinates */
 		reg_ax=(Bit16u)mouse.min_x;
 		reg_bx=(Bit16u)mouse.min_y;
@@ -997,8 +1016,8 @@
 			reg_bx=mouse.event_queue[mouse.events].buttons;
 			reg_cx=POS_X;
 			reg_dx=POS_Y;
-			reg_si=(Bit16s)(mouse.mickey_x*mouse.mickeysPerPixel_x);
-			reg_di=(Bit16s)(mouse.mickey_y*mouse.mickeysPerPixel_y);
+			reg_si=static_cast<Bit16s>(mouse.mickey_x);
+			reg_di=static_cast<Bit16s>(mouse.mickey_y);
 			CPU_Push16(RealSeg(CALLBACK_RealPointer(int74_ret_callback)));
 			CPU_Push16(RealOff(CALLBACK_RealPointer(int74_ret_callback)));
 			SegSet16(cs, mouse.sub_seg);
@@ -1008,7 +1027,7 @@
 		} else if (useps2callback) {
 			CPU_Push16(RealSeg(CALLBACK_RealPointer(int74_ret_callback)));
 			CPU_Push16(RealOff(CALLBACK_RealPointer(int74_ret_callback)));
-			DoPS2Callback(mouse.event_queue[mouse.events].buttons, POS_X, POS_Y);
+			DoPS2Callback(mouse.event_queue[mouse.events].buttons, static_cast<Bit16s>(mouse.x), static_cast<Bit16s>(mouse.y));
 		} else {
 			SegSet16(cs, RealSeg(CALLBACK_RealPointer(int74_ret_callback)));
 			reg_ip = RealOff(CALLBACK_RealPointer(int74_ret_callback));
diff -Nur dosbox-0.74/src/ints/xms.cpp dosbox-0.74.patch/src/ints/xms.cpp
--- dosbox-0.74/src/ints/xms.cpp	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/ints/xms.cpp	2016-12-11 18:35:15.550284005 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,10 +16,10 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: xms.cpp,v 1.55 2009-05-27 09:15:42 qbix79 Exp $ */
 
 #include <stdlib.h>
 #include <string.h>
+#include <stddef.h>
 #include "dosbox.h"
 #include "callback.h"
 #include "mem.h"
@@ -412,6 +412,8 @@
 	return CBRET_NONE;
 }
 
+Bitu GetEMSType(Section_prop * section);
+
 class XMS: public Module_base {
 private:
 	CALLBACK_HandlerObject callbackhandler;
@@ -445,7 +447,8 @@
 
 		/* Set up UMB chain */
 		umb_available=section->Get_bool("umb");
-		DOS_BuildUMBChain(section->Get_bool("umb"),section->Get_bool("ems"));
+		bool ems_available = GetEMSType(section)>0;
+		DOS_BuildUMBChain(section->Get_bool("umb"),ems_available);
 	}
 
 	~XMS(){
diff -Nur dosbox-0.74/src/ints/xms.h dosbox-0.74.patch/src/ints/xms.h
--- dosbox-0.74/src/ints/xms.h	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/ints/xms.h	2016-12-11 18:35:15.550284005 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
diff -Nur dosbox-0.74/src/libs/gui_tk/Doxyfile dosbox-0.74.patch/src/libs/gui_tk/Doxyfile
--- dosbox-0.74/src/libs/gui_tk/Doxyfile	1970-01-01 01:00:00.000000000 +0100
+++ dosbox-0.74.patch/src/libs/gui_tk/Doxyfile	2016-12-11 18:35:15.550284005 +0100
@@ -0,0 +1,238 @@
+# Doxyfile 1.5.2
+
+#---------------------------------------------------------------------------
+# Project related configuration options
+#---------------------------------------------------------------------------
+DOXYFILE_ENCODING      = UTF-8
+PROJECT_NAME           = gui::tk
+PROJECT_NUMBER         = "Version 1.0"
+OUTPUT_DIRECTORY       = 
+CREATE_SUBDIRS         = NO
+OUTPUT_LANGUAGE        = English
+BRIEF_MEMBER_DESC      = YES
+REPEAT_BRIEF           = YES
+ABBREVIATE_BRIEF       = "The $name class" \
+                         "The $name widget" \
+                         "The $name file" \
+                         is \
+                         provides \
+                         specifies \
+                         contains \
+                         represents \
+                         a \
+                         an \
+                         the
+ALWAYS_DETAILED_SEC    = NO
+INLINE_INHERITED_MEMB  = NO
+FULL_PATH_NAMES        = YES
+STRIP_FROM_PATH        = .
+STRIP_FROM_INC_PATH    = 
+SHORT_NAMES            = NO
+JAVADOC_AUTOBRIEF      = NO
+MULTILINE_CPP_IS_BRIEF = NO
+DETAILS_AT_TOP         = YES
+INHERIT_DOCS           = YES
+SEPARATE_MEMBER_PAGES  = NO
+TAB_SIZE               = 8
+ALIASES                = 
+OPTIMIZE_OUTPUT_FOR_C  = NO
+OPTIMIZE_OUTPUT_JAVA   = NO
+BUILTIN_STL_SUPPORT    = YES
+CPP_CLI_SUPPORT        = NO
+DISTRIBUTE_GROUP_DOC   = NO
+SUBGROUPING            = YES
+#---------------------------------------------------------------------------
+# Build related configuration options
+#---------------------------------------------------------------------------
+EXTRACT_ALL            = NO
+EXTRACT_PRIVATE        = NO
+EXTRACT_STATIC         = NO
+EXTRACT_LOCAL_CLASSES  = YES
+EXTRACT_LOCAL_METHODS  = NO
+HIDE_UNDOC_MEMBERS     = NO
+HIDE_UNDOC_CLASSES     = NO
+HIDE_FRIEND_COMPOUNDS  = NO
+HIDE_IN_BODY_DOCS      = NO
+INTERNAL_DOCS          = NO
+CASE_SENSE_NAMES       = YES
+HIDE_SCOPE_NAMES       = NO
+SHOW_INCLUDE_FILES     = YES
+INLINE_INFO            = YES
+SORT_MEMBER_DOCS       = YES
+SORT_BRIEF_DOCS        = NO
+SORT_BY_SCOPE_NAME     = NO
+GENERATE_TODOLIST      = YES
+GENERATE_TESTLIST      = YES
+GENERATE_BUGLIST       = YES
+GENERATE_DEPRECATEDLIST= YES
+ENABLED_SECTIONS       = 
+MAX_INITIALIZER_LINES  = 30
+SHOW_USED_FILES        = YES
+SHOW_DIRECTORIES       = YES
+FILE_VERSION_FILTER    = 
+#---------------------------------------------------------------------------
+# configuration options related to warning and progress messages
+#---------------------------------------------------------------------------
+QUIET                  = NO
+WARNINGS               = YES
+WARN_IF_UNDOCUMENTED   = NO
+WARN_IF_DOC_ERROR      = YES
+WARN_NO_PARAMDOC       = NO
+WARN_FORMAT            = "$file:$line: $text"
+WARN_LOGFILE           = 
+#---------------------------------------------------------------------------
+# configuration options related to the input files
+#---------------------------------------------------------------------------
+INPUT                  = .
+INPUT_ENCODING         = UTF-8
+FILE_PATTERNS          = gui_tk.h \
+                         gui_tk.cpp
+RECURSIVE              = NO
+EXCLUDE                = 
+EXCLUDE_SYMLINKS       = NO
+EXCLUDE_PATTERNS       = 
+EXCLUDE_SYMBOLS        = 
+EXAMPLE_PATH           = 
+EXAMPLE_PATTERNS       = *
+EXAMPLE_RECURSIVE      = NO
+IMAGE_PATH             = 
+INPUT_FILTER           = 
+FILTER_PATTERNS        = 
+FILTER_SOURCE_FILES    = NO
+#---------------------------------------------------------------------------
+# configuration options related to source browsing
+#---------------------------------------------------------------------------
+SOURCE_BROWSER         = YES
+INLINE_SOURCES         = NO
+STRIP_CODE_COMMENTS    = YES
+REFERENCED_BY_RELATION = YES
+REFERENCES_RELATION    = YES
+REFERENCES_LINK_SOURCE = YES
+USE_HTAGS              = NO
+VERBATIM_HEADERS       = YES
+#---------------------------------------------------------------------------
+# configuration options related to the alphabetical class index
+#---------------------------------------------------------------------------
+ALPHABETICAL_INDEX     = NO
+COLS_IN_ALPHA_INDEX    = 5
+IGNORE_PREFIX          = 
+#---------------------------------------------------------------------------
+# configuration options related to the HTML output
+#---------------------------------------------------------------------------
+GENERATE_HTML          = YES
+HTML_OUTPUT            = html
+HTML_FILE_EXTENSION    = .html
+HTML_HEADER            = 
+HTML_FOOTER            = 
+HTML_STYLESHEET        = 
+HTML_ALIGN_MEMBERS     = YES
+GENERATE_HTMLHELP      = NO
+CHM_FILE               = 
+HHC_LOCATION           = 
+GENERATE_CHI           = NO
+BINARY_TOC             = NO
+TOC_EXPAND             = NO
+DISABLE_INDEX          = NO
+ENUM_VALUES_PER_LINE   = 4
+GENERATE_TREEVIEW      = NO
+TREEVIEW_WIDTH         = 250
+#---------------------------------------------------------------------------
+# configuration options related to the LaTeX output
+#---------------------------------------------------------------------------
+GENERATE_LATEX         = NO
+LATEX_OUTPUT           = latex
+LATEX_CMD_NAME         = latex
+MAKEINDEX_CMD_NAME     = makeindex
+COMPACT_LATEX          = NO
+PAPER_TYPE             = a4wide
+EXTRA_PACKAGES         = 
+LATEX_HEADER           = 
+PDF_HYPERLINKS         = NO
+USE_PDFLATEX           = NO
+LATEX_BATCHMODE        = NO
+LATEX_HIDE_INDICES     = NO
+#---------------------------------------------------------------------------
+# configuration options related to the RTF output
+#---------------------------------------------------------------------------
+GENERATE_RTF           = NO
+RTF_OUTPUT             = rtf
+COMPACT_RTF            = NO
+RTF_HYPERLINKS         = NO
+RTF_STYLESHEET_FILE    = 
+RTF_EXTENSIONS_FILE    = 
+#---------------------------------------------------------------------------
+# configuration options related to the man page output
+#---------------------------------------------------------------------------
+GENERATE_MAN           = NO
+MAN_OUTPUT             = man
+MAN_EXTENSION          = .3
+MAN_LINKS              = NO
+#---------------------------------------------------------------------------
+# configuration options related to the XML output
+#---------------------------------------------------------------------------
+GENERATE_XML           = NO
+XML_OUTPUT             = xml
+XML_SCHEMA             = 
+XML_DTD                = 
+XML_PROGRAMLISTING     = YES
+#---------------------------------------------------------------------------
+# configuration options for the AutoGen Definitions output
+#---------------------------------------------------------------------------
+GENERATE_AUTOGEN_DEF   = NO
+#---------------------------------------------------------------------------
+# configuration options related to the Perl module output
+#---------------------------------------------------------------------------
+GENERATE_PERLMOD       = NO
+PERLMOD_LATEX          = NO
+PERLMOD_PRETTY         = YES
+PERLMOD_MAKEVAR_PREFIX = 
+#---------------------------------------------------------------------------
+# Configuration options related to the preprocessor   
+#---------------------------------------------------------------------------
+ENABLE_PREPROCESSING   = YES
+MACRO_EXPANSION        = NO
+EXPAND_ONLY_PREDEF     = NO
+SEARCH_INCLUDES        = YES
+INCLUDE_PATH           = 
+INCLUDE_FILE_PATTERNS  = 
+PREDEFINED             = TESTING SDL_MAJOR_VERSION
+EXPAND_AS_DEFINED      = 
+SKIP_FUNCTION_MACROS   = YES
+#---------------------------------------------------------------------------
+# Configuration::additions related to external references   
+#---------------------------------------------------------------------------
+TAGFILES               = 
+GENERATE_TAGFILE       = DOSBox.tag
+ALLEXTERNALS           = NO
+EXTERNAL_GROUPS        = YES
+PERL_PATH              = /usr/bin/perl
+#---------------------------------------------------------------------------
+# Configuration options related to the dot tool   
+#---------------------------------------------------------------------------
+CLASS_DIAGRAMS         = YES
+MSCGEN_PATH            = 
+HIDE_UNDOC_RELATIONS   = YES
+HAVE_DOT               = YES
+CLASS_GRAPH            = YES
+COLLABORATION_GRAPH    = YES
+GROUP_GRAPHS           = YES
+UML_LOOK               = YES
+TEMPLATE_RELATIONS     = YES
+INCLUDE_GRAPH          = YES
+INCLUDED_BY_GRAPH      = YES
+CALL_GRAPH             = YES
+CALLER_GRAPH           = YES
+GRAPHICAL_HIERARCHY    = YES
+DIRECTORY_GRAPH        = YES
+DOT_IMAGE_FORMAT       = png
+DOT_PATH               = 
+DOTFILE_DIRS           = 
+DOT_GRAPH_MAX_NODES    = 50
+DOT_TRANSPARENT        = YES
+DOT_MULTI_TARGETS      = YES
+GENERATE_LEGEND        = YES
+DOT_CLEANUP            = YES
+#---------------------------------------------------------------------------
+# Configuration::additions related to the search engine   
+#---------------------------------------------------------------------------
+SEARCHENGINE           = NO
diff -Nur dosbox-0.74/src/libs/gui_tk/gui_tk.cpp dosbox-0.74.patch/src/libs/gui_tk/gui_tk.cpp
--- dosbox-0.74/src/libs/gui_tk/gui_tk.cpp	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/libs/gui_tk/gui_tk.cpp	2016-12-11 18:35:15.554284005 +0100
@@ -20,7 +20,6 @@
 /* TODO:
   - make menu a bufferedwindow with shadow
 */
-/* $Id: gui_tk.cpp,v 1.5 2009-02-01 16:06:26 qbix79 Exp $ */
 
 /** \file
  *  \brief Implementation file for gui_tk.
diff -Nur dosbox-0.74/src/libs/gui_tk/gui_tk.h dosbox-0.74.patch/src/libs/gui_tk/gui_tk.h
--- dosbox-0.74/src/libs/gui_tk/gui_tk.h	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/libs/gui_tk/gui_tk.h	2016-12-11 18:35:15.554284005 +0100
@@ -102,7 +102,6 @@
  * along with this program.  If not, see <http://www.gnu.org/licenses/>
  */
 
-/* $Id: gui_tk.h,v 1.6 2009-05-17 15:28:05 c2woody Exp $ */
 
 #ifndef GUI__TOOLKIT_H
 #define GUI__TOOLKIT_H
diff -Nur dosbox-0.74/src/libs/gui_tk/Makefile.in dosbox-0.74.patch/src/libs/gui_tk/Makefile.in
--- dosbox-0.74/src/libs/gui_tk/Makefile.in	2010-05-12 11:57:44.000000000 +0200
+++ dosbox-0.74.patch/src/libs/gui_tk/Makefile.in	1970-01-01 01:00:00.000000000 +0100
@@ -1,443 +0,0 @@
-# Makefile.in generated by automake 1.11.1 from Makefile.am.
-# @configure_input@
-
-# Copyright (C) 1994, 1995, 1996, 1997, 1998, 1999, 2000, 2001, 2002,
-# 2003, 2004, 2005, 2006, 2007, 2008, 2009  Free Software Foundation,
-# Inc.
-# This Makefile.in is free software; the Free Software Foundation
-# gives unlimited permission to copy and/or distribute it,
-# with or without modifications, as long as this notice is preserved.
-
-# This program is distributed in the hope that it will be useful,
-# but WITHOUT ANY WARRANTY, to the extent permitted by law; without
-# even the implied warranty of MERCHANTABILITY or FITNESS FOR A
-# PARTICULAR PURPOSE.
-
-@SET_MAKE@
-
-VPATH = @srcdir@
-pkgdatadir = $(datadir)/@PACKAGE@
-pkgincludedir = $(includedir)/@PACKAGE@
-pkglibdir = $(libdir)/@PACKAGE@
-pkglibexecdir = $(libexecdir)/@PACKAGE@
-am__cd = CDPATH="$${ZSH_VERSION+.}$(PATH_SEPARATOR)" && cd
-install_sh_DATA = $(install_sh) -c -m 644
-install_sh_PROGRAM = $(install_sh) -c
-install_sh_SCRIPT = $(install_sh) -c
-INSTALL_HEADER = $(INSTALL_DATA)
-transform = $(program_transform_name)
-NORMAL_INSTALL = :
-PRE_INSTALL = :
-POST_INSTALL = :
-NORMAL_UNINSTALL = :
-PRE_UNINSTALL = :
-POST_UNINSTALL = :
-build_triplet = @build@
-host_triplet = @host@
-subdir = src/libs/gui_tk
-DIST_COMMON = $(srcdir)/Makefile.am $(srcdir)/Makefile.in
-ACLOCAL_M4 = $(top_srcdir)/aclocal.m4
-am__aclocal_m4_deps = $(top_srcdir)/acinclude.m4 \
-	$(top_srcdir)/configure.in
-am__configure_deps = $(am__aclocal_m4_deps) $(CONFIGURE_DEPENDENCIES) \
-	$(ACLOCAL_M4)
-mkinstalldirs = $(install_sh) -d
-CONFIG_HEADER = $(top_builddir)/config.h
-CONFIG_CLEAN_FILES =
-CONFIG_CLEAN_VPATH_FILES =
-LIBRARIES = $(noinst_LIBRARIES)
-AR = ar
-ARFLAGS = cru
-libgui_tk_a_AR = $(AR) $(ARFLAGS)
-libgui_tk_a_LIBADD =
-am_libgui_tk_a_OBJECTS = gui_tk.$(OBJEXT)
-libgui_tk_a_OBJECTS = $(am_libgui_tk_a_OBJECTS)
-DEFAULT_INCLUDES = -I.@am__isrc@ -I$(top_builddir)
-depcomp = $(SHELL) $(top_srcdir)/depcomp
-am__depfiles_maybe = depfiles
-am__mv = mv -f
-CXXCOMPILE = $(CXX) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) \
-	$(AM_CPPFLAGS) $(CPPFLAGS) $(AM_CXXFLAGS) $(CXXFLAGS)
-CXXLD = $(CXX)
-CXXLINK = $(CXXLD) $(AM_CXXFLAGS) $(CXXFLAGS) $(AM_LDFLAGS) $(LDFLAGS) \
-	-o $@
-COMPILE = $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) \
-	$(CPPFLAGS) $(AM_CFLAGS) $(CFLAGS)
-CCLD = $(CC)
-LINK = $(CCLD) $(AM_CFLAGS) $(CFLAGS) $(AM_LDFLAGS) $(LDFLAGS) -o $@
-SOURCES = $(libgui_tk_a_SOURCES)
-DIST_SOURCES = $(libgui_tk_a_SOURCES)
-ETAGS = etags
-CTAGS = ctags
-DISTFILES = $(DIST_COMMON) $(DIST_SOURCES) $(TEXINFOS) $(EXTRA_DIST)
-ACLOCAL = @ACLOCAL@
-ALSA_CFLAGS = @ALSA_CFLAGS@
-ALSA_LIBS = @ALSA_LIBS@
-AMTAR = @AMTAR@
-AUTOCONF = @AUTOCONF@
-AUTOHEADER = @AUTOHEADER@
-AUTOMAKE = @AUTOMAKE@
-AWK = @AWK@
-CC = @CC@
-CCDEPMODE = @CCDEPMODE@
-CFLAGS = @CFLAGS@
-CPP = @CPP@
-CPPFLAGS = @CPPFLAGS@
-CXX = @CXX@
-CXXDEPMODE = @CXXDEPMODE@
-CXXFLAGS = @CXXFLAGS@
-CYGPATH_W = @CYGPATH_W@
-DEFS = @DEFS@
-DEPDIR = @DEPDIR@
-ECHO_C = @ECHO_C@
-ECHO_N = @ECHO_N@
-ECHO_T = @ECHO_T@
-EGREP = @EGREP@
-EXEEXT = @EXEEXT@
-GREP = @GREP@
-INSTALL = @INSTALL@
-INSTALL_DATA = @INSTALL_DATA@
-INSTALL_PROGRAM = @INSTALL_PROGRAM@
-INSTALL_SCRIPT = @INSTALL_SCRIPT@
-INSTALL_STRIP_PROGRAM = @INSTALL_STRIP_PROGRAM@
-LDFLAGS = @LDFLAGS@
-LIBOBJS = @LIBOBJS@
-LIBS = @LIBS@
-LTLIBOBJS = @LTLIBOBJS@
-MAKEINFO = @MAKEINFO@
-MKDIR_P = @MKDIR_P@
-OBJEXT = @OBJEXT@
-PACKAGE = @PACKAGE@
-PACKAGE_BUGREPORT = @PACKAGE_BUGREPORT@
-PACKAGE_NAME = @PACKAGE_NAME@
-PACKAGE_STRING = @PACKAGE_STRING@
-PACKAGE_TARNAME = @PACKAGE_TARNAME@
-PACKAGE_URL = @PACKAGE_URL@
-PACKAGE_VERSION = @PACKAGE_VERSION@
-PATH_SEPARATOR = @PATH_SEPARATOR@
-RANLIB = @RANLIB@
-SDL_CFLAGS = @SDL_CFLAGS@
-SDL_CONFIG = @SDL_CONFIG@
-SDL_LIBS = @SDL_LIBS@
-SET_MAKE = @SET_MAKE@
-SHELL = @SHELL@
-STRIP = @STRIP@
-VERSION = @VERSION@
-WINDRES = @WINDRES@
-abs_builddir = @abs_builddir@
-abs_srcdir = @abs_srcdir@
-abs_top_builddir = @abs_top_builddir@
-abs_top_srcdir = @abs_top_srcdir@
-ac_ct_CC = @ac_ct_CC@
-ac_ct_CXX = @ac_ct_CXX@
-am__include = @am__include@
-am__leading_dot = @am__leading_dot@
-am__quote = @am__quote@
-am__tar = @am__tar@
-am__untar = @am__untar@
-bindir = @bindir@
-build = @build@
-build_alias = @build_alias@
-build_cpu = @build_cpu@
-build_os = @build_os@
-build_vendor = @build_vendor@
-builddir = @builddir@
-datadir = @datadir@
-datarootdir = @datarootdir@
-docdir = @docdir@
-dvidir = @dvidir@
-exec_prefix = @exec_prefix@
-host = @host@
-host_alias = @host_alias@
-host_cpu = @host_cpu@
-host_os = @host_os@
-host_vendor = @host_vendor@
-htmldir = @htmldir@
-includedir = @includedir@
-infodir = @infodir@
-install_sh = @install_sh@
-libdir = @libdir@
-libexecdir = @libexecdir@
-localedir = @localedir@
-localstatedir = @localstatedir@
-mandir = @mandir@
-mkdir_p = @mkdir_p@
-oldincludedir = @oldincludedir@
-pdfdir = @pdfdir@
-prefix = @prefix@
-program_transform_name = @program_transform_name@
-psdir = @psdir@
-sbindir = @sbindir@
-sharedstatedir = @sharedstatedir@
-srcdir = @srcdir@
-sysconfdir = @sysconfdir@
-target_alias = @target_alias@
-top_build_prefix = @top_build_prefix@
-top_builddir = @top_builddir@
-top_srcdir = @top_srcdir@
-AM_CPPFLAGS = -I$(top_srcdir)/include
-noinst_LIBRARIES = libgui_tk.a
-libgui_tk_a_SOURCES = gui_tk.cpp gui_tk.h
-all: all-am
-
-.SUFFIXES:
-.SUFFIXES: .cpp .o .obj
-$(srcdir)/Makefile.in:  $(srcdir)/Makefile.am  $(am__configure_deps)
-	@for dep in $?; do \
-	  case '$(am__configure_deps)' in \
-	    *$$dep*) \
-	      ( cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh ) \
-	        && { if test -f $@; then exit 0; else break; fi; }; \
-	      exit 1;; \
-	  esac; \
-	done; \
-	echo ' cd $(top_srcdir) && $(AUTOMAKE) --gnu src/libs/gui_tk/Makefile'; \
-	$(am__cd) $(top_srcdir) && \
-	  $(AUTOMAKE) --gnu src/libs/gui_tk/Makefile
-.PRECIOUS: Makefile
-Makefile: $(srcdir)/Makefile.in $(top_builddir)/config.status
-	@case '$?' in \
-	  *config.status*) \
-	    cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh;; \
-	  *) \
-	    echo ' cd $(top_builddir) && $(SHELL) ./config.status $(subdir)/$@ $(am__depfiles_maybe)'; \
-	    cd $(top_builddir) && $(SHELL) ./config.status $(subdir)/$@ $(am__depfiles_maybe);; \
-	esac;
-
-$(top_builddir)/config.status: $(top_srcdir)/configure $(CONFIG_STATUS_DEPENDENCIES)
-	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
-
-$(top_srcdir)/configure:  $(am__configure_deps)
-	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
-$(ACLOCAL_M4):  $(am__aclocal_m4_deps)
-	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
-$(am__aclocal_m4_deps):
-
-clean-noinstLIBRARIES:
-	-test -z "$(noinst_LIBRARIES)" || rm -f $(noinst_LIBRARIES)
-libgui_tk.a: $(libgui_tk_a_OBJECTS) $(libgui_tk_a_DEPENDENCIES) 
-	-rm -f libgui_tk.a
-	$(libgui_tk_a_AR) libgui_tk.a $(libgui_tk_a_OBJECTS) $(libgui_tk_a_LIBADD)
-	$(RANLIB) libgui_tk.a
-
-mostlyclean-compile:
-	-rm -f *.$(OBJEXT)
-
-distclean-compile:
-	-rm -f *.tab.c
-
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/gui_tk.Po@am__quote@
-
-.cpp.o:
-@am__fastdepCXX_TRUE@	$(CXXCOMPILE) -MT $@ -MD -MP -MF $(DEPDIR)/$*.Tpo -c -o $@ $<
-@am__fastdepCXX_TRUE@	$(am__mv) $(DEPDIR)/$*.Tpo $(DEPDIR)/$*.Po
-@AMDEP_TRUE@@am__fastdepCXX_FALSE@	source='$<' object='$@' libtool=no @AMDEPBACKSLASH@
-@AMDEP_TRUE@@am__fastdepCXX_FALSE@	DEPDIR=$(DEPDIR) $(CXXDEPMODE) $(depcomp) @AMDEPBACKSLASH@
-@am__fastdepCXX_FALSE@	$(CXXCOMPILE) -c -o $@ $<
-
-.cpp.obj:
-@am__fastdepCXX_TRUE@	$(CXXCOMPILE) -MT $@ -MD -MP -MF $(DEPDIR)/$*.Tpo -c -o $@ `$(CYGPATH_W) '$<'`
-@am__fastdepCXX_TRUE@	$(am__mv) $(DEPDIR)/$*.Tpo $(DEPDIR)/$*.Po
-@AMDEP_TRUE@@am__fastdepCXX_FALSE@	source='$<' object='$@' libtool=no @AMDEPBACKSLASH@
-@AMDEP_TRUE@@am__fastdepCXX_FALSE@	DEPDIR=$(DEPDIR) $(CXXDEPMODE) $(depcomp) @AMDEPBACKSLASH@
-@am__fastdepCXX_FALSE@	$(CXXCOMPILE) -c -o $@ `$(CYGPATH_W) '$<'`
-
-ID: $(HEADERS) $(SOURCES) $(LISP) $(TAGS_FILES)
-	list='$(SOURCES) $(HEADERS) $(LISP) $(TAGS_FILES)'; \
-	unique=`for i in $$list; do \
-	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
-	  done | \
-	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
-	      END { if (nonempty) { for (i in files) print i; }; }'`; \
-	mkid -fID $$unique
-tags: TAGS
-
-TAGS:  $(HEADERS) $(SOURCES)  $(TAGS_DEPENDENCIES) \
-		$(TAGS_FILES) $(LISP)
-	set x; \
-	here=`pwd`; \
-	list='$(SOURCES) $(HEADERS)  $(LISP) $(TAGS_FILES)'; \
-	unique=`for i in $$list; do \
-	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
-	  done | \
-	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
-	      END { if (nonempty) { for (i in files) print i; }; }'`; \
-	shift; \
-	if test -z "$(ETAGS_ARGS)$$*$$unique"; then :; else \
-	  test -n "$$unique" || unique=$$empty_fix; \
-	  if test $$# -gt 0; then \
-	    $(ETAGS) $(ETAGSFLAGS) $(AM_ETAGSFLAGS) $(ETAGS_ARGS) \
-	      "$$@" $$unique; \
-	  else \
-	    $(ETAGS) $(ETAGSFLAGS) $(AM_ETAGSFLAGS) $(ETAGS_ARGS) \
-	      $$unique; \
-	  fi; \
-	fi
-ctags: CTAGS
-CTAGS:  $(HEADERS) $(SOURCES)  $(TAGS_DEPENDENCIES) \
-		$(TAGS_FILES) $(LISP)
-	list='$(SOURCES) $(HEADERS)  $(LISP) $(TAGS_FILES)'; \
-	unique=`for i in $$list; do \
-	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
-	  done | \
-	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
-	      END { if (nonempty) { for (i in files) print i; }; }'`; \
-	test -z "$(CTAGS_ARGS)$$unique" \
-	  || $(CTAGS) $(CTAGSFLAGS) $(AM_CTAGSFLAGS) $(CTAGS_ARGS) \
-	     $$unique
-
-GTAGS:
-	here=`$(am__cd) $(top_builddir) && pwd` \
-	  && $(am__cd) $(top_srcdir) \
-	  && gtags -i $(GTAGS_ARGS) "$$here"
-
-distclean-tags:
-	-rm -f TAGS ID GTAGS GRTAGS GSYMS GPATH tags
-
-distdir: $(DISTFILES)
-	@srcdirstrip=`echo "$(srcdir)" | sed 's/[].[^$$\\*]/\\\\&/g'`; \
-	topsrcdirstrip=`echo "$(top_srcdir)" | sed 's/[].[^$$\\*]/\\\\&/g'`; \
-	list='$(DISTFILES)'; \
-	  dist_files=`for file in $$list; do echo $$file; done | \
-	  sed -e "s|^$$srcdirstrip/||;t" \
-	      -e "s|^$$topsrcdirstrip/|$(top_builddir)/|;t"`; \
-	case $$dist_files in \
-	  */*) $(MKDIR_P) `echo "$$dist_files" | \
-			   sed '/\//!d;s|^|$(distdir)/|;s,/[^/]*$$,,' | \
-			   sort -u` ;; \
-	esac; \
-	for file in $$dist_files; do \
-	  if test -f $$file || test -d $$file; then d=.; else d=$(srcdir); fi; \
-	  if test -d $$d/$$file; then \
-	    dir=`echo "/$$file" | sed -e 's,/[^/]*$$,,'`; \
-	    if test -d "$(distdir)/$$file"; then \
-	      find "$(distdir)/$$file" -type d ! -perm -700 -exec chmod u+rwx {} \;; \
-	    fi; \
-	    if test -d $(srcdir)/$$file && test $$d != $(srcdir); then \
-	      cp -fpR $(srcdir)/$$file "$(distdir)$$dir" || exit 1; \
-	      find "$(distdir)/$$file" -type d ! -perm -700 -exec chmod u+rwx {} \;; \
-	    fi; \
-	    cp -fpR $$d/$$file "$(distdir)$$dir" || exit 1; \
-	  else \
-	    test -f "$(distdir)/$$file" \
-	    || cp -p $$d/$$file "$(distdir)/$$file" \
-	    || exit 1; \
-	  fi; \
-	done
-check-am: all-am
-check: check-am
-all-am: Makefile $(LIBRARIES)
-installdirs:
-install: install-am
-install-exec: install-exec-am
-install-data: install-data-am
-uninstall: uninstall-am
-
-install-am: all-am
-	@$(MAKE) $(AM_MAKEFLAGS) install-exec-am install-data-am
-
-installcheck: installcheck-am
-install-strip:
-	$(MAKE) $(AM_MAKEFLAGS) INSTALL_PROGRAM="$(INSTALL_STRIP_PROGRAM)" \
-	  install_sh_PROGRAM="$(INSTALL_STRIP_PROGRAM)" INSTALL_STRIP_FLAG=-s \
-	  `test -z '$(STRIP)' || \
-	    echo "INSTALL_PROGRAM_ENV=STRIPPROG='$(STRIP)'"` install
-mostlyclean-generic:
-
-clean-generic:
-
-distclean-generic:
-	-test -z "$(CONFIG_CLEAN_FILES)" || rm -f $(CONFIG_CLEAN_FILES)
-	-test . = "$(srcdir)" || test -z "$(CONFIG_CLEAN_VPATH_FILES)" || rm -f $(CONFIG_CLEAN_VPATH_FILES)
-
-maintainer-clean-generic:
-	@echo "This command is intended for maintainers to use"
-	@echo "it deletes files that may require special tools to rebuild."
-clean: clean-am
-
-clean-am: clean-generic clean-noinstLIBRARIES mostlyclean-am
-
-distclean: distclean-am
-	-rm -rf ./$(DEPDIR)
-	-rm -f Makefile
-distclean-am: clean-am distclean-compile distclean-generic \
-	distclean-tags
-
-dvi: dvi-am
-
-dvi-am:
-
-html: html-am
-
-html-am:
-
-info: info-am
-
-info-am:
-
-install-data-am:
-
-install-dvi: install-dvi-am
-
-install-dvi-am:
-
-install-exec-am:
-
-install-html: install-html-am
-
-install-html-am:
-
-install-info: install-info-am
-
-install-info-am:
-
-install-man:
-
-install-pdf: install-pdf-am
-
-install-pdf-am:
-
-install-ps: install-ps-am
-
-install-ps-am:
-
-installcheck-am:
-
-maintainer-clean: maintainer-clean-am
-	-rm -rf ./$(DEPDIR)
-	-rm -f Makefile
-maintainer-clean-am: distclean-am maintainer-clean-generic
-
-mostlyclean: mostlyclean-am
-
-mostlyclean-am: mostlyclean-compile mostlyclean-generic
-
-pdf: pdf-am
-
-pdf-am:
-
-ps: ps-am
-
-ps-am:
-
-uninstall-am:
-
-.MAKE: install-am install-strip
-
-.PHONY: CTAGS GTAGS all all-am check check-am clean clean-generic \
-	clean-noinstLIBRARIES ctags distclean distclean-compile \
-	distclean-generic distclean-tags distdir dvi dvi-am html \
-	html-am info info-am install install-am install-data \
-	install-data-am install-dvi install-dvi-am install-exec \
-	install-exec-am install-html install-html-am install-info \
-	install-info-am install-man install-pdf install-pdf-am \
-	install-ps install-ps-am install-strip installcheck \
-	installcheck-am installdirs maintainer-clean \
-	maintainer-clean-generic mostlyclean mostlyclean-compile \
-	mostlyclean-generic pdf pdf-am ps ps-am tags uninstall \
-	uninstall-am
-
-
-# Tell versions [3.59,3.63) of GNU make to not export all variables.
-# Otherwise a system limit (for SysV at least) may be exceeded.
-.NOEXPORT:
diff -Nur dosbox-0.74/src/libs/Makefile.in dosbox-0.74.patch/src/libs/Makefile.in
--- dosbox-0.74/src/libs/Makefile.in	2010-05-12 11:57:44.000000000 +0200
+++ dosbox-0.74.patch/src/libs/Makefile.in	1970-01-01 01:00:00.000000000 +0100
@@ -1,539 +0,0 @@
-# Makefile.in generated by automake 1.11.1 from Makefile.am.
-# @configure_input@
-
-# Copyright (C) 1994, 1995, 1996, 1997, 1998, 1999, 2000, 2001, 2002,
-# 2003, 2004, 2005, 2006, 2007, 2008, 2009  Free Software Foundation,
-# Inc.
-# This Makefile.in is free software; the Free Software Foundation
-# gives unlimited permission to copy and/or distribute it,
-# with or without modifications, as long as this notice is preserved.
-
-# This program is distributed in the hope that it will be useful,
-# but WITHOUT ANY WARRANTY, to the extent permitted by law; without
-# even the implied warranty of MERCHANTABILITY or FITNESS FOR A
-# PARTICULAR PURPOSE.
-
-@SET_MAKE@
-VPATH = @srcdir@
-pkgdatadir = $(datadir)/@PACKAGE@
-pkgincludedir = $(includedir)/@PACKAGE@
-pkglibdir = $(libdir)/@PACKAGE@
-pkglibexecdir = $(libexecdir)/@PACKAGE@
-am__cd = CDPATH="$${ZSH_VERSION+.}$(PATH_SEPARATOR)" && cd
-install_sh_DATA = $(install_sh) -c -m 644
-install_sh_PROGRAM = $(install_sh) -c
-install_sh_SCRIPT = $(install_sh) -c
-INSTALL_HEADER = $(INSTALL_DATA)
-transform = $(program_transform_name)
-NORMAL_INSTALL = :
-PRE_INSTALL = :
-POST_INSTALL = :
-NORMAL_UNINSTALL = :
-PRE_UNINSTALL = :
-POST_UNINSTALL = :
-build_triplet = @build@
-host_triplet = @host@
-subdir = src/libs
-DIST_COMMON = $(srcdir)/Makefile.am $(srcdir)/Makefile.in
-ACLOCAL_M4 = $(top_srcdir)/aclocal.m4
-am__aclocal_m4_deps = $(top_srcdir)/acinclude.m4 \
-	$(top_srcdir)/configure.in
-am__configure_deps = $(am__aclocal_m4_deps) $(CONFIGURE_DEPENDENCIES) \
-	$(ACLOCAL_M4)
-mkinstalldirs = $(install_sh) -d
-CONFIG_HEADER = $(top_builddir)/config.h
-CONFIG_CLEAN_FILES =
-CONFIG_CLEAN_VPATH_FILES =
-SOURCES =
-DIST_SOURCES =
-RECURSIVE_TARGETS = all-recursive check-recursive dvi-recursive \
-	html-recursive info-recursive install-data-recursive \
-	install-dvi-recursive install-exec-recursive \
-	install-html-recursive install-info-recursive \
-	install-pdf-recursive install-ps-recursive install-recursive \
-	installcheck-recursive installdirs-recursive pdf-recursive \
-	ps-recursive uninstall-recursive
-RECURSIVE_CLEAN_TARGETS = mostlyclean-recursive clean-recursive	\
-  distclean-recursive maintainer-clean-recursive
-AM_RECURSIVE_TARGETS = $(RECURSIVE_TARGETS:-recursive=) \
-	$(RECURSIVE_CLEAN_TARGETS:-recursive=) tags TAGS ctags CTAGS \
-	distdir
-ETAGS = etags
-CTAGS = ctags
-DIST_SUBDIRS = $(SUBDIRS)
-DISTFILES = $(DIST_COMMON) $(DIST_SOURCES) $(TEXINFOS) $(EXTRA_DIST)
-am__relativize = \
-  dir0=`pwd`; \
-  sed_first='s,^\([^/]*\)/.*$$,\1,'; \
-  sed_rest='s,^[^/]*/*,,'; \
-  sed_last='s,^.*/\([^/]*\)$$,\1,'; \
-  sed_butlast='s,/*[^/]*$$,,'; \
-  while test -n "$$dir1"; do \
-    first=`echo "$$dir1" | sed -e "$$sed_first"`; \
-    if test "$$first" != "."; then \
-      if test "$$first" = ".."; then \
-        dir2=`echo "$$dir0" | sed -e "$$sed_last"`/"$$dir2"; \
-        dir0=`echo "$$dir0" | sed -e "$$sed_butlast"`; \
-      else \
-        first2=`echo "$$dir2" | sed -e "$$sed_first"`; \
-        if test "$$first2" = "$$first"; then \
-          dir2=`echo "$$dir2" | sed -e "$$sed_rest"`; \
-        else \
-          dir2="../$$dir2"; \
-        fi; \
-        dir0="$$dir0"/"$$first"; \
-      fi; \
-    fi; \
-    dir1=`echo "$$dir1" | sed -e "$$sed_rest"`; \
-  done; \
-  reldir="$$dir2"
-ACLOCAL = @ACLOCAL@
-ALSA_CFLAGS = @ALSA_CFLAGS@
-ALSA_LIBS = @ALSA_LIBS@
-AMTAR = @AMTAR@
-AUTOCONF = @AUTOCONF@
-AUTOHEADER = @AUTOHEADER@
-AUTOMAKE = @AUTOMAKE@
-AWK = @AWK@
-CC = @CC@
-CCDEPMODE = @CCDEPMODE@
-CFLAGS = @CFLAGS@
-CPP = @CPP@
-CPPFLAGS = @CPPFLAGS@
-CXX = @CXX@
-CXXDEPMODE = @CXXDEPMODE@
-CXXFLAGS = @CXXFLAGS@
-CYGPATH_W = @CYGPATH_W@
-DEFS = @DEFS@
-DEPDIR = @DEPDIR@
-ECHO_C = @ECHO_C@
-ECHO_N = @ECHO_N@
-ECHO_T = @ECHO_T@
-EGREP = @EGREP@
-EXEEXT = @EXEEXT@
-GREP = @GREP@
-INSTALL = @INSTALL@
-INSTALL_DATA = @INSTALL_DATA@
-INSTALL_PROGRAM = @INSTALL_PROGRAM@
-INSTALL_SCRIPT = @INSTALL_SCRIPT@
-INSTALL_STRIP_PROGRAM = @INSTALL_STRIP_PROGRAM@
-LDFLAGS = @LDFLAGS@
-LIBOBJS = @LIBOBJS@
-LIBS = @LIBS@
-LTLIBOBJS = @LTLIBOBJS@
-MAKEINFO = @MAKEINFO@
-MKDIR_P = @MKDIR_P@
-OBJEXT = @OBJEXT@
-PACKAGE = @PACKAGE@
-PACKAGE_BUGREPORT = @PACKAGE_BUGREPORT@
-PACKAGE_NAME = @PACKAGE_NAME@
-PACKAGE_STRING = @PACKAGE_STRING@
-PACKAGE_TARNAME = @PACKAGE_TARNAME@
-PACKAGE_URL = @PACKAGE_URL@
-PACKAGE_VERSION = @PACKAGE_VERSION@
-PATH_SEPARATOR = @PATH_SEPARATOR@
-RANLIB = @RANLIB@
-SDL_CFLAGS = @SDL_CFLAGS@
-SDL_CONFIG = @SDL_CONFIG@
-SDL_LIBS = @SDL_LIBS@
-SET_MAKE = @SET_MAKE@
-SHELL = @SHELL@
-STRIP = @STRIP@
-VERSION = @VERSION@
-WINDRES = @WINDRES@
-abs_builddir = @abs_builddir@
-abs_srcdir = @abs_srcdir@
-abs_top_builddir = @abs_top_builddir@
-abs_top_srcdir = @abs_top_srcdir@
-ac_ct_CC = @ac_ct_CC@
-ac_ct_CXX = @ac_ct_CXX@
-am__include = @am__include@
-am__leading_dot = @am__leading_dot@
-am__quote = @am__quote@
-am__tar = @am__tar@
-am__untar = @am__untar@
-bindir = @bindir@
-build = @build@
-build_alias = @build_alias@
-build_cpu = @build_cpu@
-build_os = @build_os@
-build_vendor = @build_vendor@
-builddir = @builddir@
-datadir = @datadir@
-datarootdir = @datarootdir@
-docdir = @docdir@
-dvidir = @dvidir@
-exec_prefix = @exec_prefix@
-host = @host@
-host_alias = @host_alias@
-host_cpu = @host_cpu@
-host_os = @host_os@
-host_vendor = @host_vendor@
-htmldir = @htmldir@
-includedir = @includedir@
-infodir = @infodir@
-install_sh = @install_sh@
-libdir = @libdir@
-libexecdir = @libexecdir@
-localedir = @localedir@
-localstatedir = @localstatedir@
-mandir = @mandir@
-mkdir_p = @mkdir_p@
-oldincludedir = @oldincludedir@
-pdfdir = @pdfdir@
-prefix = @prefix@
-program_transform_name = @program_transform_name@
-psdir = @psdir@
-sbindir = @sbindir@
-sharedstatedir = @sharedstatedir@
-srcdir = @srcdir@
-sysconfdir = @sysconfdir@
-target_alias = @target_alias@
-top_build_prefix = @top_build_prefix@
-top_builddir = @top_builddir@
-top_srcdir = @top_srcdir@
-AM_CPPFLAGS = -I$(top_srcdir)/include
-SUBDIRS = zmbv gui_tk
-all: all-recursive
-
-.SUFFIXES:
-$(srcdir)/Makefile.in:  $(srcdir)/Makefile.am  $(am__configure_deps)
-	@for dep in $?; do \
-	  case '$(am__configure_deps)' in \
-	    *$$dep*) \
-	      ( cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh ) \
-	        && { if test -f $@; then exit 0; else break; fi; }; \
-	      exit 1;; \
-	  esac; \
-	done; \
-	echo ' cd $(top_srcdir) && $(AUTOMAKE) --gnu src/libs/Makefile'; \
-	$(am__cd) $(top_srcdir) && \
-	  $(AUTOMAKE) --gnu src/libs/Makefile
-.PRECIOUS: Makefile
-Makefile: $(srcdir)/Makefile.in $(top_builddir)/config.status
-	@case '$?' in \
-	  *config.status*) \
-	    cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh;; \
-	  *) \
-	    echo ' cd $(top_builddir) && $(SHELL) ./config.status $(subdir)/$@ $(am__depfiles_maybe)'; \
-	    cd $(top_builddir) && $(SHELL) ./config.status $(subdir)/$@ $(am__depfiles_maybe);; \
-	esac;
-
-$(top_builddir)/config.status: $(top_srcdir)/configure $(CONFIG_STATUS_DEPENDENCIES)
-	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
-
-$(top_srcdir)/configure:  $(am__configure_deps)
-	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
-$(ACLOCAL_M4):  $(am__aclocal_m4_deps)
-	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
-$(am__aclocal_m4_deps):
-
-# This directory's subdirectories are mostly independent; you can cd
-# into them and run `make' without going through this Makefile.
-# To change the values of `make' variables: instead of editing Makefiles,
-# (1) if the variable is set in `config.status', edit `config.status'
-#     (which will cause the Makefiles to be regenerated when you run `make');
-# (2) otherwise, pass the desired values on the `make' command line.
-$(RECURSIVE_TARGETS):
-	@fail= failcom='exit 1'; \
-	for f in x $$MAKEFLAGS; do \
-	  case $$f in \
-	    *=* | --[!k]*);; \
-	    *k*) failcom='fail=yes';; \
-	  esac; \
-	done; \
-	dot_seen=no; \
-	target=`echo $@ | sed s/-recursive//`; \
-	list='$(SUBDIRS)'; for subdir in $$list; do \
-	  echo "Making $$target in $$subdir"; \
-	  if test "$$subdir" = "."; then \
-	    dot_seen=yes; \
-	    local_target="$$target-am"; \
-	  else \
-	    local_target="$$target"; \
-	  fi; \
-	  ($(am__cd) $$subdir && $(MAKE) $(AM_MAKEFLAGS) $$local_target) \
-	  || eval $$failcom; \
-	done; \
-	if test "$$dot_seen" = "no"; then \
-	  $(MAKE) $(AM_MAKEFLAGS) "$$target-am" || exit 1; \
-	fi; test -z "$$fail"
-
-$(RECURSIVE_CLEAN_TARGETS):
-	@fail= failcom='exit 1'; \
-	for f in x $$MAKEFLAGS; do \
-	  case $$f in \
-	    *=* | --[!k]*);; \
-	    *k*) failcom='fail=yes';; \
-	  esac; \
-	done; \
-	dot_seen=no; \
-	case "$@" in \
-	  distclean-* | maintainer-clean-*) list='$(DIST_SUBDIRS)' ;; \
-	  *) list='$(SUBDIRS)' ;; \
-	esac; \
-	rev=''; for subdir in $$list; do \
-	  if test "$$subdir" = "."; then :; else \
-	    rev="$$subdir $$rev"; \
-	  fi; \
-	done; \
-	rev="$$rev ."; \
-	target=`echo $@ | sed s/-recursive//`; \
-	for subdir in $$rev; do \
-	  echo "Making $$target in $$subdir"; \
-	  if test "$$subdir" = "."; then \
-	    local_target="$$target-am"; \
-	  else \
-	    local_target="$$target"; \
-	  fi; \
-	  ($(am__cd) $$subdir && $(MAKE) $(AM_MAKEFLAGS) $$local_target) \
-	  || eval $$failcom; \
-	done && test -z "$$fail"
-tags-recursive:
-	list='$(SUBDIRS)'; for subdir in $$list; do \
-	  test "$$subdir" = . || ($(am__cd) $$subdir && $(MAKE) $(AM_MAKEFLAGS) tags); \
-	done
-ctags-recursive:
-	list='$(SUBDIRS)'; for subdir in $$list; do \
-	  test "$$subdir" = . || ($(am__cd) $$subdir && $(MAKE) $(AM_MAKEFLAGS) ctags); \
-	done
-
-ID: $(HEADERS) $(SOURCES) $(LISP) $(TAGS_FILES)
-	list='$(SOURCES) $(HEADERS) $(LISP) $(TAGS_FILES)'; \
-	unique=`for i in $$list; do \
-	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
-	  done | \
-	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
-	      END { if (nonempty) { for (i in files) print i; }; }'`; \
-	mkid -fID $$unique
-tags: TAGS
-
-TAGS: tags-recursive $(HEADERS) $(SOURCES)  $(TAGS_DEPENDENCIES) \
-		$(TAGS_FILES) $(LISP)
-	set x; \
-	here=`pwd`; \
-	if ($(ETAGS) --etags-include --version) >/dev/null 2>&1; then \
-	  include_option=--etags-include; \
-	  empty_fix=.; \
-	else \
-	  include_option=--include; \
-	  empty_fix=; \
-	fi; \
-	list='$(SUBDIRS)'; for subdir in $$list; do \
-	  if test "$$subdir" = .; then :; else \
-	    test ! -f $$subdir/TAGS || \
-	      set "$$@" "$$include_option=$$here/$$subdir/TAGS"; \
-	  fi; \
-	done; \
-	list='$(SOURCES) $(HEADERS)  $(LISP) $(TAGS_FILES)'; \
-	unique=`for i in $$list; do \
-	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
-	  done | \
-	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
-	      END { if (nonempty) { for (i in files) print i; }; }'`; \
-	shift; \
-	if test -z "$(ETAGS_ARGS)$$*$$unique"; then :; else \
-	  test -n "$$unique" || unique=$$empty_fix; \
-	  if test $$# -gt 0; then \
-	    $(ETAGS) $(ETAGSFLAGS) $(AM_ETAGSFLAGS) $(ETAGS_ARGS) \
-	      "$$@" $$unique; \
-	  else \
-	    $(ETAGS) $(ETAGSFLAGS) $(AM_ETAGSFLAGS) $(ETAGS_ARGS) \
-	      $$unique; \
-	  fi; \
-	fi
-ctags: CTAGS
-CTAGS: ctags-recursive $(HEADERS) $(SOURCES)  $(TAGS_DEPENDENCIES) \
-		$(TAGS_FILES) $(LISP)
-	list='$(SOURCES) $(HEADERS)  $(LISP) $(TAGS_FILES)'; \
-	unique=`for i in $$list; do \
-	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
-	  done | \
-	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
-	      END { if (nonempty) { for (i in files) print i; }; }'`; \
-	test -z "$(CTAGS_ARGS)$$unique" \
-	  || $(CTAGS) $(CTAGSFLAGS) $(AM_CTAGSFLAGS) $(CTAGS_ARGS) \
-	     $$unique
-
-GTAGS:
-	here=`$(am__cd) $(top_builddir) && pwd` \
-	  && $(am__cd) $(top_srcdir) \
-	  && gtags -i $(GTAGS_ARGS) "$$here"
-
-distclean-tags:
-	-rm -f TAGS ID GTAGS GRTAGS GSYMS GPATH tags
-
-distdir: $(DISTFILES)
-	@srcdirstrip=`echo "$(srcdir)" | sed 's/[].[^$$\\*]/\\\\&/g'`; \
-	topsrcdirstrip=`echo "$(top_srcdir)" | sed 's/[].[^$$\\*]/\\\\&/g'`; \
-	list='$(DISTFILES)'; \
-	  dist_files=`for file in $$list; do echo $$file; done | \
-	  sed -e "s|^$$srcdirstrip/||;t" \
-	      -e "s|^$$topsrcdirstrip/|$(top_builddir)/|;t"`; \
-	case $$dist_files in \
-	  */*) $(MKDIR_P) `echo "$$dist_files" | \
-			   sed '/\//!d;s|^|$(distdir)/|;s,/[^/]*$$,,' | \
-			   sort -u` ;; \
-	esac; \
-	for file in $$dist_files; do \
-	  if test -f $$file || test -d $$file; then d=.; else d=$(srcdir); fi; \
-	  if test -d $$d/$$file; then \
-	    dir=`echo "/$$file" | sed -e 's,/[^/]*$$,,'`; \
-	    if test -d "$(distdir)/$$file"; then \
-	      find "$(distdir)/$$file" -type d ! -perm -700 -exec chmod u+rwx {} \;; \
-	    fi; \
-	    if test -d $(srcdir)/$$file && test $$d != $(srcdir); then \
-	      cp -fpR $(srcdir)/$$file "$(distdir)$$dir" || exit 1; \
-	      find "$(distdir)/$$file" -type d ! -perm -700 -exec chmod u+rwx {} \;; \
-	    fi; \
-	    cp -fpR $$d/$$file "$(distdir)$$dir" || exit 1; \
-	  else \
-	    test -f "$(distdir)/$$file" \
-	    || cp -p $$d/$$file "$(distdir)/$$file" \
-	    || exit 1; \
-	  fi; \
-	done
-	@list='$(DIST_SUBDIRS)'; for subdir in $$list; do \
-	  if test "$$subdir" = .; then :; else \
-	    test -d "$(distdir)/$$subdir" \
-	    || $(MKDIR_P) "$(distdir)/$$subdir" \
-	    || exit 1; \
-	  fi; \
-	done
-	@list='$(DIST_SUBDIRS)'; for subdir in $$list; do \
-	  if test "$$subdir" = .; then :; else \
-	    dir1=$$subdir; dir2="$(distdir)/$$subdir"; \
-	    $(am__relativize); \
-	    new_distdir=$$reldir; \
-	    dir1=$$subdir; dir2="$(top_distdir)"; \
-	    $(am__relativize); \
-	    new_top_distdir=$$reldir; \
-	    echo " (cd $$subdir && $(MAKE) $(AM_MAKEFLAGS) top_distdir="$$new_top_distdir" distdir="$$new_distdir" \\"; \
-	    echo "     am__remove_distdir=: am__skip_length_check=: am__skip_mode_fix=: distdir)"; \
-	    ($(am__cd) $$subdir && \
-	      $(MAKE) $(AM_MAKEFLAGS) \
-	        top_distdir="$$new_top_distdir" \
-	        distdir="$$new_distdir" \
-		am__remove_distdir=: \
-		am__skip_length_check=: \
-		am__skip_mode_fix=: \
-	        distdir) \
-	      || exit 1; \
-	  fi; \
-	done
-check-am: all-am
-check: check-recursive
-all-am: Makefile
-installdirs: installdirs-recursive
-installdirs-am:
-install: install-recursive
-install-exec: install-exec-recursive
-install-data: install-data-recursive
-uninstall: uninstall-recursive
-
-install-am: all-am
-	@$(MAKE) $(AM_MAKEFLAGS) install-exec-am install-data-am
-
-installcheck: installcheck-recursive
-install-strip:
-	$(MAKE) $(AM_MAKEFLAGS) INSTALL_PROGRAM="$(INSTALL_STRIP_PROGRAM)" \
-	  install_sh_PROGRAM="$(INSTALL_STRIP_PROGRAM)" INSTALL_STRIP_FLAG=-s \
-	  `test -z '$(STRIP)' || \
-	    echo "INSTALL_PROGRAM_ENV=STRIPPROG='$(STRIP)'"` install
-mostlyclean-generic:
-
-clean-generic:
-
-distclean-generic:
-	-test -z "$(CONFIG_CLEAN_FILES)" || rm -f $(CONFIG_CLEAN_FILES)
-	-test . = "$(srcdir)" || test -z "$(CONFIG_CLEAN_VPATH_FILES)" || rm -f $(CONFIG_CLEAN_VPATH_FILES)
-
-maintainer-clean-generic:
-	@echo "This command is intended for maintainers to use"
-	@echo "it deletes files that may require special tools to rebuild."
-clean: clean-recursive
-
-clean-am: clean-generic mostlyclean-am
-
-distclean: distclean-recursive
-	-rm -f Makefile
-distclean-am: clean-am distclean-generic distclean-tags
-
-dvi: dvi-recursive
-
-dvi-am:
-
-html: html-recursive
-
-html-am:
-
-info: info-recursive
-
-info-am:
-
-install-data-am:
-
-install-dvi: install-dvi-recursive
-
-install-dvi-am:
-
-install-exec-am:
-
-install-html: install-html-recursive
-
-install-html-am:
-
-install-info: install-info-recursive
-
-install-info-am:
-
-install-man:
-
-install-pdf: install-pdf-recursive
-
-install-pdf-am:
-
-install-ps: install-ps-recursive
-
-install-ps-am:
-
-installcheck-am:
-
-maintainer-clean: maintainer-clean-recursive
-	-rm -f Makefile
-maintainer-clean-am: distclean-am maintainer-clean-generic
-
-mostlyclean: mostlyclean-recursive
-
-mostlyclean-am: mostlyclean-generic
-
-pdf: pdf-recursive
-
-pdf-am:
-
-ps: ps-recursive
-
-ps-am:
-
-uninstall-am:
-
-.MAKE: $(RECURSIVE_CLEAN_TARGETS) $(RECURSIVE_TARGETS) ctags-recursive \
-	install-am install-strip tags-recursive
-
-.PHONY: $(RECURSIVE_CLEAN_TARGETS) $(RECURSIVE_TARGETS) CTAGS GTAGS \
-	all all-am check check-am clean clean-generic ctags \
-	ctags-recursive distclean distclean-generic distclean-tags \
-	distdir dvi dvi-am html html-am info info-am install \
-	install-am install-data install-data-am install-dvi \
-	install-dvi-am install-exec install-exec-am install-html \
-	install-html-am install-info install-info-am install-man \
-	install-pdf install-pdf-am install-ps install-ps-am \
-	install-strip installcheck installcheck-am installdirs \
-	installdirs-am maintainer-clean maintainer-clean-generic \
-	mostlyclean mostlyclean-generic pdf pdf-am ps ps-am tags \
-	tags-recursive uninstall uninstall-am
-
-
-# Tell versions [3.59,3.63) of GNU make to not export all variables.
-# Otherwise a system limit (for SysV at least) may be exceeded.
-.NOEXPORT:
diff -Nur dosbox-0.74/src/libs/zmbv/drvproc.cpp dosbox-0.74.patch/src/libs/zmbv/drvproc.cpp
--- dosbox-0.74/src/libs/zmbv/drvproc.cpp	1970-01-01 01:00:00.000000000 +0100
+++ dosbox-0.74.patch/src/libs/zmbv/drvproc.cpp	2016-12-11 18:35:15.554284005 +0100
@@ -0,0 +1,212 @@
+/*
+ *  Copyright (C) 2002-2013  The DOSBox Team
+ *
+ *  This program is free software; you can redistribute it and/or modify
+ *  it under the terms of the GNU General Public License as published by
+ *  the Free Software Foundation; either version 2 of the License, or
+ *  (at your option) any later version.
+ *
+ *  This program is distributed in the hope that it will be useful,
+ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *  GNU General Public License for more details.
+ *
+ *  You should have received a copy of the GNU General Public License
+ *  along with this program; if not, write to the Free Software
+ *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+ */
+//
+// Zipped Motion Block Video
+//
+// Based on Huffyuv by Ben Rudiak-Gould.
+// which was based on MSYUV sample code, which is:
+// Copyright (c) 1993 Microsoft Corporation.
+// All Rights Reserved.
+//
+
+#include "zmbv_vfw.h"
+
+/***************************************************************************
+ * DriverProc  -  The entry point for an installable driver.
+ *
+ * PARAMETERS
+ * dwDriverId:  For most messages, <dwDriverId> is the DWORD
+ *     value that the driver returns in response to a <DRV_OPEN> message.
+ *     Each time that the driver is opened, through the <DrvOpen> API,
+ *     the driver receives a <DRV_OPEN> message and can return an
+ *     arbitrary, non-zero value. The installable driver interface
+ *     saves this value and returns a unique driver handle to the
+ *     application. Whenever the application sends a message to the
+ *     driver using the driver handle, the interface routes the message
+ *     to this entry point and passes the corresponding <dwDriverId>.
+ *     This mechanism allows the driver to use the same or different
+ *     identifiers for multiple opens but ensures that driver handles
+ *     are unique at the application interface layer.
+ *
+ *     The following messages are not related to a particular open
+ *     instance of the driver. For these messages, the dwDriverId
+ *     will always be zero.
+ *
+ *         DRV_LOAD, DRV_FREE, DRV_ENABLE, DRV_DISABLE, DRV_OPEN
+ *
+ * hDriver: This is the handle returned to the application by the
+ *    driver interface.
+ *
+ * uiMessage: The requested action to be performed. Message
+ *     values below <DRV_RESERVED> are used for globally defined messages.
+ *     Message values from <DRV_RESERVED> to <DRV_USER> are used for
+ *     defined driver protocols. Messages above <DRV_USER> are used
+ *     for driver specific messages.
+ *
+ * lParam1: Data for this message.  Defined separately for
+ *     each message
+ *
+ * lParam2: Data for this message.  Defined separately for
+ *     each message
+ *
+ * RETURNS
+ *   Defined separately for each message.
+ *
+ ***************************************************************************/
+LRESULT PASCAL DriverProc(DWORD dwDriverID, HDRVR hDriver, UINT uiMessage, LPARAM lParam1, LPARAM lParam2) {
+  CodecInst* pi = (CodecInst*)dwDriverID;
+
+  switch (uiMessage) {
+    case DRV_LOAD:
+      return (LRESULT)1L;
+
+    case DRV_FREE:
+      return (LRESULT)1L;
+
+    case DRV_OPEN:
+      // GAAH! This used to return a pointer to 0xFFFF0000 when lParam==0!
+      return (LRESULT)(DWORD)(UINT) Open((ICOPEN*) lParam2);
+
+    case DRV_CLOSE:
+      if (pi) Close(pi);
+      return (LRESULT)1L;
+
+    /*********************************************************************
+
+      state messages
+
+    *********************************************************************/
+
+    // cwk
+    case DRV_QUERYCONFIGURE:    // configuration from drivers applet
+      return (LRESULT)1L;
+
+    case DRV_CONFIGURE:
+      pi->Configure((HWND)lParam1);
+      return DRV_OK;
+
+    case ICM_CONFIGURE:
+      //
+      //  return ICERR_OK if you will do a configure box, error otherwise
+      //
+      if (lParam1 == -1)
+        return pi->QueryConfigure() ? ICERR_OK : ICERR_UNSUPPORTED;
+      else
+        return pi->Configure((HWND)lParam1);
+
+    case ICM_ABOUT:
+      //
+      //  return ICERR_OK if you will do a about box, error otherwise
+      //
+      if (lParam1 == -1)
+        return pi->QueryAbout() ? ICERR_OK : ICERR_UNSUPPORTED;
+      else
+        return pi->About((HWND)lParam1);
+
+    case ICM_GETSTATE:
+      return pi->GetState((LPVOID)lParam1, (DWORD)lParam2);
+
+    case ICM_SETSTATE:
+      return pi->SetState((LPVOID)lParam1, (DWORD)lParam2);
+
+    case ICM_GETINFO:
+      return pi->GetInfo((ICINFO*)lParam1, (DWORD)lParam2);
+
+    case ICM_GETDEFAULTQUALITY:
+      if (lParam1) {
+        *((LPDWORD)lParam1) = 10000;
+        return ICERR_OK;
+      }
+      break;
+
+    /*********************************************************************
+
+      compression messages
+
+    *********************************************************************/
+
+    case ICM_COMPRESS_QUERY:
+      return pi->CompressQuery((LPBITMAPINFOHEADER)lParam1, (LPBITMAPINFOHEADER)lParam2);
+
+    case ICM_COMPRESS_BEGIN:
+      return pi->CompressBegin((LPBITMAPINFOHEADER)lParam1, (LPBITMAPINFOHEADER)lParam2);
+
+    case ICM_COMPRESS_GET_FORMAT:
+      return pi->CompressGetFormat((LPBITMAPINFOHEADER)lParam1, (LPBITMAPINFOHEADER)lParam2);
+
+    case ICM_COMPRESS_GET_SIZE:
+      return pi->CompressGetSize((LPBITMAPINFOHEADER)lParam1, (LPBITMAPINFOHEADER)lParam2);
+
+    case ICM_COMPRESS:
+      return pi->Compress((ICCOMPRESS*)lParam1, (DWORD)lParam2);
+
+    case ICM_COMPRESS_END:
+      return pi->CompressEnd();
+
+    /*********************************************************************
+
+      decompress messages
+
+    *********************************************************************/
+
+    case ICM_DECOMPRESS_QUERY:
+      return pi->DecompressQuery((LPBITMAPINFOHEADER)lParam1, (LPBITMAPINFOHEADER)lParam2);
+
+    case ICM_DECOMPRESS_BEGIN:
+      return pi->DecompressBegin((LPBITMAPINFOHEADER)lParam1, (LPBITMAPINFOHEADER)lParam2);
+
+    case ICM_DECOMPRESS_GET_FORMAT:
+      return pi->DecompressGetFormat((LPBITMAPINFOHEADER)lParam1, (LPBITMAPINFOHEADER)lParam2);
+
+    case ICM_DECOMPRESS_GET_PALETTE:
+      return pi->DecompressGetPalette((LPBITMAPINFOHEADER)lParam1, (LPBITMAPINFOHEADER)lParam2);
+
+    case ICM_DECOMPRESS:
+      return pi->Decompress((ICDECOMPRESS*)lParam1, (DWORD)lParam2);
+
+    case ICM_DECOMPRESS_END:
+      return pi->DecompressEnd();
+
+    /*********************************************************************
+
+      standard driver messages
+
+    *********************************************************************/
+
+    case DRV_DISABLE:
+    case DRV_ENABLE:
+      return (LRESULT)1L;
+
+    case DRV_INSTALL:
+    case DRV_REMOVE:
+      return (LRESULT)DRV_OK;
+  }
+
+  if (uiMessage < DRV_USER)
+    return DefDriverProc(dwDriverID, hDriver, uiMessage, lParam1, lParam2);
+  else
+    return ICERR_UNSUPPORTED;
+}
+
+
+HMODULE hmoduleCodec=0;
+
+BOOL WINAPI DllMain(HINSTANCE hinstDLL, DWORD, LPVOID) {
+  hmoduleCodec = (HMODULE) hinstDLL;
+  return TRUE;
+}
diff -Nur dosbox-0.74/src/libs/zmbv/Makefile.in dosbox-0.74.patch/src/libs/zmbv/Makefile.in
--- dosbox-0.74/src/libs/zmbv/Makefile.in	2010-05-12 11:57:44.000000000 +0200
+++ dosbox-0.74.patch/src/libs/zmbv/Makefile.in	1970-01-01 01:00:00.000000000 +0100
@@ -1,336 +0,0 @@
-# Makefile.in generated by automake 1.11.1 from Makefile.am.
-# @configure_input@
-
-# Copyright (C) 1994, 1995, 1996, 1997, 1998, 1999, 2000, 2001, 2002,
-# 2003, 2004, 2005, 2006, 2007, 2008, 2009  Free Software Foundation,
-# Inc.
-# This Makefile.in is free software; the Free Software Foundation
-# gives unlimited permission to copy and/or distribute it,
-# with or without modifications, as long as this notice is preserved.
-
-# This program is distributed in the hope that it will be useful,
-# but WITHOUT ANY WARRANTY, to the extent permitted by law; without
-# even the implied warranty of MERCHANTABILITY or FITNESS FOR A
-# PARTICULAR PURPOSE.
-
-@SET_MAKE@
-VPATH = @srcdir@
-pkgdatadir = $(datadir)/@PACKAGE@
-pkgincludedir = $(includedir)/@PACKAGE@
-pkglibdir = $(libdir)/@PACKAGE@
-pkglibexecdir = $(libexecdir)/@PACKAGE@
-am__cd = CDPATH="$${ZSH_VERSION+.}$(PATH_SEPARATOR)" && cd
-install_sh_DATA = $(install_sh) -c -m 644
-install_sh_PROGRAM = $(install_sh) -c
-install_sh_SCRIPT = $(install_sh) -c
-INSTALL_HEADER = $(INSTALL_DATA)
-transform = $(program_transform_name)
-NORMAL_INSTALL = :
-PRE_INSTALL = :
-POST_INSTALL = :
-NORMAL_UNINSTALL = :
-PRE_UNINSTALL = :
-POST_UNINSTALL = :
-build_triplet = @build@
-host_triplet = @host@
-subdir = src/libs/zmbv
-DIST_COMMON = $(srcdir)/Makefile.am $(srcdir)/Makefile.in
-ACLOCAL_M4 = $(top_srcdir)/aclocal.m4
-am__aclocal_m4_deps = $(top_srcdir)/acinclude.m4 \
-	$(top_srcdir)/configure.in
-am__configure_deps = $(am__aclocal_m4_deps) $(CONFIGURE_DEPENDENCIES) \
-	$(ACLOCAL_M4)
-mkinstalldirs = $(install_sh) -d
-CONFIG_HEADER = $(top_builddir)/config.h
-CONFIG_CLEAN_FILES =
-CONFIG_CLEAN_VPATH_FILES =
-SOURCES =
-DIST_SOURCES =
-DISTFILES = $(DIST_COMMON) $(DIST_SOURCES) $(TEXINFOS) $(EXTRA_DIST)
-ACLOCAL = @ACLOCAL@
-ALSA_CFLAGS = @ALSA_CFLAGS@
-ALSA_LIBS = @ALSA_LIBS@
-AMTAR = @AMTAR@
-AUTOCONF = @AUTOCONF@
-AUTOHEADER = @AUTOHEADER@
-AUTOMAKE = @AUTOMAKE@
-AWK = @AWK@
-CC = @CC@
-CCDEPMODE = @CCDEPMODE@
-CFLAGS = @CFLAGS@
-CPP = @CPP@
-CPPFLAGS = @CPPFLAGS@
-CXX = @CXX@
-CXXDEPMODE = @CXXDEPMODE@
-CXXFLAGS = @CXXFLAGS@
-CYGPATH_W = @CYGPATH_W@
-DEFS = @DEFS@
-DEPDIR = @DEPDIR@
-ECHO_C = @ECHO_C@
-ECHO_N = @ECHO_N@
-ECHO_T = @ECHO_T@
-EGREP = @EGREP@
-EXEEXT = @EXEEXT@
-GREP = @GREP@
-INSTALL = @INSTALL@
-INSTALL_DATA = @INSTALL_DATA@
-INSTALL_PROGRAM = @INSTALL_PROGRAM@
-INSTALL_SCRIPT = @INSTALL_SCRIPT@
-INSTALL_STRIP_PROGRAM = @INSTALL_STRIP_PROGRAM@
-LDFLAGS = @LDFLAGS@
-LIBOBJS = @LIBOBJS@
-LIBS = @LIBS@
-LTLIBOBJS = @LTLIBOBJS@
-MAKEINFO = @MAKEINFO@
-MKDIR_P = @MKDIR_P@
-OBJEXT = @OBJEXT@
-PACKAGE = @PACKAGE@
-PACKAGE_BUGREPORT = @PACKAGE_BUGREPORT@
-PACKAGE_NAME = @PACKAGE_NAME@
-PACKAGE_STRING = @PACKAGE_STRING@
-PACKAGE_TARNAME = @PACKAGE_TARNAME@
-PACKAGE_URL = @PACKAGE_URL@
-PACKAGE_VERSION = @PACKAGE_VERSION@
-PATH_SEPARATOR = @PATH_SEPARATOR@
-RANLIB = @RANLIB@
-SDL_CFLAGS = @SDL_CFLAGS@
-SDL_CONFIG = @SDL_CONFIG@
-SDL_LIBS = @SDL_LIBS@
-SET_MAKE = @SET_MAKE@
-SHELL = @SHELL@
-STRIP = @STRIP@
-VERSION = @VERSION@
-WINDRES = @WINDRES@
-abs_builddir = @abs_builddir@
-abs_srcdir = @abs_srcdir@
-abs_top_builddir = @abs_top_builddir@
-abs_top_srcdir = @abs_top_srcdir@
-ac_ct_CC = @ac_ct_CC@
-ac_ct_CXX = @ac_ct_CXX@
-am__include = @am__include@
-am__leading_dot = @am__leading_dot@
-am__quote = @am__quote@
-am__tar = @am__tar@
-am__untar = @am__untar@
-bindir = @bindir@
-build = @build@
-build_alias = @build_alias@
-build_cpu = @build_cpu@
-build_os = @build_os@
-build_vendor = @build_vendor@
-builddir = @builddir@
-datadir = @datadir@
-datarootdir = @datarootdir@
-docdir = @docdir@
-dvidir = @dvidir@
-exec_prefix = @exec_prefix@
-host = @host@
-host_alias = @host_alias@
-host_cpu = @host_cpu@
-host_os = @host_os@
-host_vendor = @host_vendor@
-htmldir = @htmldir@
-includedir = @includedir@
-infodir = @infodir@
-install_sh = @install_sh@
-libdir = @libdir@
-libexecdir = @libexecdir@
-localedir = @localedir@
-localstatedir = @localstatedir@
-mandir = @mandir@
-mkdir_p = @mkdir_p@
-oldincludedir = @oldincludedir@
-pdfdir = @pdfdir@
-prefix = @prefix@
-program_transform_name = @program_transform_name@
-psdir = @psdir@
-sbindir = @sbindir@
-sharedstatedir = @sharedstatedir@
-srcdir = @srcdir@
-sysconfdir = @sysconfdir@
-target_alias = @target_alias@
-top_build_prefix = @top_build_prefix@
-top_builddir = @top_builddir@
-top_srcdir = @top_srcdir@
-EXTRA_DIST = zmbv.cpp zmbv.h
-all: all-am
-
-.SUFFIXES:
-$(srcdir)/Makefile.in:  $(srcdir)/Makefile.am  $(am__configure_deps)
-	@for dep in $?; do \
-	  case '$(am__configure_deps)' in \
-	    *$$dep*) \
-	      ( cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh ) \
-	        && { if test -f $@; then exit 0; else break; fi; }; \
-	      exit 1;; \
-	  esac; \
-	done; \
-	echo ' cd $(top_srcdir) && $(AUTOMAKE) --gnu src/libs/zmbv/Makefile'; \
-	$(am__cd) $(top_srcdir) && \
-	  $(AUTOMAKE) --gnu src/libs/zmbv/Makefile
-.PRECIOUS: Makefile
-Makefile: $(srcdir)/Makefile.in $(top_builddir)/config.status
-	@case '$?' in \
-	  *config.status*) \
-	    cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh;; \
-	  *) \
-	    echo ' cd $(top_builddir) && $(SHELL) ./config.status $(subdir)/$@ $(am__depfiles_maybe)'; \
-	    cd $(top_builddir) && $(SHELL) ./config.status $(subdir)/$@ $(am__depfiles_maybe);; \
-	esac;
-
-$(top_builddir)/config.status: $(top_srcdir)/configure $(CONFIG_STATUS_DEPENDENCIES)
-	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
-
-$(top_srcdir)/configure:  $(am__configure_deps)
-	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
-$(ACLOCAL_M4):  $(am__aclocal_m4_deps)
-	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
-$(am__aclocal_m4_deps):
-tags: TAGS
-TAGS:
-
-ctags: CTAGS
-CTAGS:
-
-
-distdir: $(DISTFILES)
-	@srcdirstrip=`echo "$(srcdir)" | sed 's/[].[^$$\\*]/\\\\&/g'`; \
-	topsrcdirstrip=`echo "$(top_srcdir)" | sed 's/[].[^$$\\*]/\\\\&/g'`; \
-	list='$(DISTFILES)'; \
-	  dist_files=`for file in $$list; do echo $$file; done | \
-	  sed -e "s|^$$srcdirstrip/||;t" \
-	      -e "s|^$$topsrcdirstrip/|$(top_builddir)/|;t"`; \
-	case $$dist_files in \
-	  */*) $(MKDIR_P) `echo "$$dist_files" | \
-			   sed '/\//!d;s|^|$(distdir)/|;s,/[^/]*$$,,' | \
-			   sort -u` ;; \
-	esac; \
-	for file in $$dist_files; do \
-	  if test -f $$file || test -d $$file; then d=.; else d=$(srcdir); fi; \
-	  if test -d $$d/$$file; then \
-	    dir=`echo "/$$file" | sed -e 's,/[^/]*$$,,'`; \
-	    if test -d "$(distdir)/$$file"; then \
-	      find "$(distdir)/$$file" -type d ! -perm -700 -exec chmod u+rwx {} \;; \
-	    fi; \
-	    if test -d $(srcdir)/$$file && test $$d != $(srcdir); then \
-	      cp -fpR $(srcdir)/$$file "$(distdir)$$dir" || exit 1; \
-	      find "$(distdir)/$$file" -type d ! -perm -700 -exec chmod u+rwx {} \;; \
-	    fi; \
-	    cp -fpR $$d/$$file "$(distdir)$$dir" || exit 1; \
-	  else \
-	    test -f "$(distdir)/$$file" \
-	    || cp -p $$d/$$file "$(distdir)/$$file" \
-	    || exit 1; \
-	  fi; \
-	done
-check-am: all-am
-check: check-am
-all-am: Makefile
-installdirs:
-install: install-am
-install-exec: install-exec-am
-install-data: install-data-am
-uninstall: uninstall-am
-
-install-am: all-am
-	@$(MAKE) $(AM_MAKEFLAGS) install-exec-am install-data-am
-
-installcheck: installcheck-am
-install-strip:
-	$(MAKE) $(AM_MAKEFLAGS) INSTALL_PROGRAM="$(INSTALL_STRIP_PROGRAM)" \
-	  install_sh_PROGRAM="$(INSTALL_STRIP_PROGRAM)" INSTALL_STRIP_FLAG=-s \
-	  `test -z '$(STRIP)' || \
-	    echo "INSTALL_PROGRAM_ENV=STRIPPROG='$(STRIP)'"` install
-mostlyclean-generic:
-
-clean-generic:
-
-distclean-generic:
-	-test -z "$(CONFIG_CLEAN_FILES)" || rm -f $(CONFIG_CLEAN_FILES)
-	-test . = "$(srcdir)" || test -z "$(CONFIG_CLEAN_VPATH_FILES)" || rm -f $(CONFIG_CLEAN_VPATH_FILES)
-
-maintainer-clean-generic:
-	@echo "This command is intended for maintainers to use"
-	@echo "it deletes files that may require special tools to rebuild."
-clean: clean-am
-
-clean-am: clean-generic mostlyclean-am
-
-distclean: distclean-am
-	-rm -f Makefile
-distclean-am: clean-am distclean-generic
-
-dvi: dvi-am
-
-dvi-am:
-
-html: html-am
-
-html-am:
-
-info: info-am
-
-info-am:
-
-install-data-am:
-
-install-dvi: install-dvi-am
-
-install-dvi-am:
-
-install-exec-am:
-
-install-html: install-html-am
-
-install-html-am:
-
-install-info: install-info-am
-
-install-info-am:
-
-install-man:
-
-install-pdf: install-pdf-am
-
-install-pdf-am:
-
-install-ps: install-ps-am
-
-install-ps-am:
-
-installcheck-am:
-
-maintainer-clean: maintainer-clean-am
-	-rm -f Makefile
-maintainer-clean-am: distclean-am maintainer-clean-generic
-
-mostlyclean: mostlyclean-am
-
-mostlyclean-am: mostlyclean-generic
-
-pdf: pdf-am
-
-pdf-am:
-
-ps: ps-am
-
-ps-am:
-
-uninstall-am:
-
-.MAKE: install-am install-strip
-
-.PHONY: all all-am check check-am clean clean-generic distclean \
-	distclean-generic distdir dvi dvi-am html html-am info info-am \
-	install install-am install-data install-data-am install-dvi \
-	install-dvi-am install-exec install-exec-am install-html \
-	install-html-am install-info install-info-am install-man \
-	install-pdf install-pdf-am install-ps install-ps-am \
-	install-strip installcheck installcheck-am installdirs \
-	maintainer-clean maintainer-clean-generic mostlyclean \
-	mostlyclean-generic pdf pdf-am ps ps-am uninstall uninstall-am
-
-
-# Tell versions [3.59,3.63) of GNU make to not export all variables.
-# Otherwise a system limit (for SysV at least) may be exceeded.
-.NOEXPORT:
diff -Nur dosbox-0.74/src/libs/zmbv/resource.h dosbox-0.74.patch/src/libs/zmbv/resource.h
--- dosbox-0.74/src/libs/zmbv/resource.h	1970-01-01 01:00:00.000000000 +0100
+++ dosbox-0.74.patch/src/libs/zmbv/resource.h	2016-12-11 18:35:15.554284005 +0100
@@ -0,0 +1,21 @@
+//{{NO_DEPENDENCIES}}
+// Microsoft Visual C++ generated include file.
+// Used by zmbv_vfw.rc
+//
+#define IDD_ABOUT                       101
+#define IDD_CONFIGURE                   102
+#define IDC_HOMEPAGE                    1000
+#define IDC_EMAIL                       1001
+#define IDC_SLIDER1                     1008
+
+// Next default values for new objects
+// 
+#ifdef APSTUDIO_INVOKED
+#ifndef APSTUDIO_READONLY_SYMBOLS
+#define _APS_NO_MFC                     1
+#define _APS_NEXT_RESOURCE_VALUE        103
+#define _APS_NEXT_COMMAND_VALUE         40001
+#define _APS_NEXT_CONTROL_VALUE         1009
+#define _APS_NEXT_SYMED_VALUE           101
+#endif
+#endif
diff -Nur dosbox-0.74/src/libs/zmbv/zmbv.cpp dosbox-0.74.patch/src/libs/zmbv/zmbv.cpp
--- dosbox-0.74/src/libs/zmbv/zmbv.cpp	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/libs/zmbv/zmbv.cpp	2016-12-11 18:35:15.554284005 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
diff -Nur dosbox-0.74/src/libs/zmbv/zmbv.def dosbox-0.74.patch/src/libs/zmbv/zmbv.def
--- dosbox-0.74/src/libs/zmbv/zmbv.def	1970-01-01 01:00:00.000000000 +0100
+++ dosbox-0.74.patch/src/libs/zmbv/zmbv.def	2016-12-11 18:35:15.554284005 +0100
@@ -0,0 +1,4 @@
+LIBRARY         ZMBV
+
+EXPORTS
+	DriverProc
diff -Nur dosbox-0.74/src/libs/zmbv/zmbv.h dosbox-0.74.patch/src/libs/zmbv/zmbv.h
--- dosbox-0.74/src/libs/zmbv/zmbv.h	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/libs/zmbv/zmbv.h	2016-12-11 18:35:15.554284005 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
diff -Nur dosbox-0.74/src/libs/zmbv/zmbv.inf dosbox-0.74.patch/src/libs/zmbv/zmbv.inf
--- dosbox-0.74/src/libs/zmbv/zmbv.inf	1970-01-01 01:00:00.000000000 +0100
+++ dosbox-0.74.patch/src/libs/zmbv/zmbv.inf	2016-12-11 18:35:15.554284005 +0100
@@ -0,0 +1,105 @@
+[Version]
+Signature="$CHICAGO$"
+Provider=%ZMBV_PUBLISHER%
+Class=MEDIA
+
+
+[DefaultInstall]
+CopyFiles=ZMBV.Files.Inf,ZMBV.Files.Dll
+AddReg=ZMBV.Reg9x
+UpdateInis=ZMBV.INIs
+
+[DefaultInstall.ntx86]
+CopyFiles=ZMBV.Files.Inf,ZMBV.Files.Dll
+AddReg=ZMBV.RegNTx86
+UpdateInis=ZMBV.INIs
+
+[DefaultInstall.ntamd64]
+CopyFiles=ZMBV.Files.Inf,ZMBV.Files.Dll.NTamd64
+AddReg=ZMBV.RegNTamd64
+UpdateInis=ZMBV.INIs
+
+[DefaultUnInstall]
+DelFiles=ZMBV.Files.Dll,ZMBV.Files.Inf,ZMBV.Files.Ini
+DelReg=ZMBV.Reg9x
+UpdateInis=ZMBV.INIs.Del
+
+[DefaultUnInstall.ntx86]
+DelFiles=ZMBV.Files.Dll,ZMBV.Files.Inf,ZMBV.Files.Ini
+DelReg=ZMBV.RegNTx86
+UpdateInis=ZMBV.INIs.Del
+
+[DefaultUnInstall.ntamd64]
+DelFiles=ZMBV.Files.Dll.NTamd64,ZMBV.Files.Inf,ZMBV.Files.Ini
+DelReg=ZMBV.RegNTamd64
+UpdateInis=ZMBV.INIs.Del
+
+[SourceDisksNames]
+1="Zip Motion Block Video codec","",1
+
+[SourceDisksFiles]
+ZMBV.INF=1
+
+[DestinationDirs]
+ZMBV.Files.Inf=17
+ZMBV.Files.Dll=11
+ZMBV.Files.Dll.NTamd64=10,SysWOW64
+ZMBV.Files.Ini=25
+
+[ZMBV.Files.Inf]
+zmbv.inf
+
+[ZMBV.Files.Dll]
+zmbv.dll
+
+[ZMBV.Files.Dll.NTamd64]
+zmbv.dll
+
+[ZMBV.Files.Ini]
+zmbv.ini
+
+[ZMBV.Reg9x]
+HKLM,SYSTEM\CurrentControlSet\Control\MediaResources\icm\VIDC.ZMBV,Description,,"%ZMBV_DISPLAY_NAME%"
+HKLM,SYSTEM\CurrentControlSet\Control\MediaResources\icm\VIDC.ZMBV,Driver,,"zmbv.dll"
+HKLM,SYSTEM\CurrentControlSet\Control\MediaResources\icm\VIDC.ZMBV,FriendlyName,,"%ZMBV_DISPLAY_NAME%"
+
+HKLM,Software\Microsoft\Windows\CurrentVersion\Uninstall\ZMBV
+HKLM,Software\Microsoft\Windows\CurrentVersion\Uninstall\ZMBV,DisplayName,,"%ZMBV_UNINST_DISPLAY_NAME%"
+HKLM,Software\Microsoft\Windows\CurrentVersion\Uninstall\ZMBV,UninstallString,,"rundll.exe setupx.dll,InstallHinfSection DefaultUninstall 132 %17%\ZMBV.INF"
+
+[ZMBV.RegNTx86]
+HKLM,SOFTWARE\Microsoft\Windows NT\CurrentVersion\drivers.desc,zmbv.dll,,"%ZMBV_DISPLAY_NAME%"
+HKLM,SOFTWARE\Microsoft\Windows NT\CurrentVersion\drivers32,vidc.zmbv,,zmbv.dll
+
+HKLM,SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\ZMBV
+HKLM,SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\ZMBV,DisplayName,,"%ZMBV_UNINST_DISPLAY_NAME%"
+HKLM,SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\ZMBV,Publisher,,"%ZMBV_PUBLISHER%"
+HKLM,SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\ZMBV,URLInfoAbout,,"%ZMBV_URL_HOMEPAGE%"
+HKLM,SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\ZMBV,NoRepair,0x10001,01,00,00,00
+HKLM,SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\ZMBV,NoModify,0x10001,01,00,00,00
+HKLM,SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\ZMBV,UninstallString,,"rundll32.exe setupapi,InstallHinfSection DefaultUninstall 132 %17%\ZMBV.INF"
+
+[ZMBV.RegNTamd64]
+HKLM,SOFTWARE\Wow6432Node\Microsoft\Windows NT\CurrentVersion\drivers.desc,zmbv.dll,,"%ZMBV_DISPLAY_NAME%"
+HKLM,SOFTWARE\Wow6432Node\Microsoft\Windows NT\CurrentVersion\drivers32,vidc.zmbv,,zmbv.dll
+
+HKLM,SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\ZMBV
+HKLM,SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\ZMBV,DisplayName,,"%ZMBV_UNINST_DISPLAY_NAME%"
+HKLM,SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\ZMBV,Publisher,,"%ZMBV_PUBLISHER%"
+HKLM,SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\ZMBV,URLInfoAbout,,"%ZMBV_URL_HOMEPAGE%"
+HKLM,SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\ZMBV,NoRepair,0x10001,01,00,00,00
+HKLM,SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\ZMBV,NoModify,0x10001,01,00,00,00
+HKLM,SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\ZMBV,UninstallString,,"rundll32.exe setupapi.dll,InstallHinfSection DefaultUninstall 132 %17%\ZMBV.INF"
+
+[ZMBV.INIs]
+system.ini, drivers32,, "VIDC.ZMBV=zmbv.dll"
+
+[ZMBV.INIs.Del]
+system.ini, drivers32, "VIDC.ZMBV=zmbv.dll"
+
+[Strings]
+ZMBV_PUBLISHER = "DOSBox Team"
+ZMBV_DISPLAY_NAME = "Zip Motion Block Video [ZMBV]"
+ZMBV_UNINST_DISPLAY_NAME = "Zip Motion Block Video codec (Remove Only)"
+ZMBV_URL_HOMEPAGE = "http://www.dosbox.com/"
+CODEC_INSTALLATION_FINISHED = "Zip Motion Block Video codec installation is complete."
diff -Nur dosbox-0.74/src/libs/zmbv/zmbv.sln dosbox-0.74.patch/src/libs/zmbv/zmbv.sln
--- dosbox-0.74/src/libs/zmbv/zmbv.sln	1970-01-01 01:00:00.000000000 +0100
+++ dosbox-0.74.patch/src/libs/zmbv/zmbv.sln	2016-12-11 18:35:15.554284005 +0100
@@ -0,0 +1,21 @@
+Microsoft Visual Studio Solution File, Format Version 8.00
+Project("{8BC9CEB8-8B4A-11D0-8D11-00A0C91BC942}") = "zmbv", "zmbv.vcproj", "{619CF3F9-C373-4BD5-93DA-025F5E16F8FA}"
+	ProjectSection(ProjectDependencies) = postProject
+	EndProjectSection
+EndProject
+Global
+	GlobalSection(SolutionConfiguration) = preSolution
+		Debug = Debug
+		Release = Release
+	EndGlobalSection
+	GlobalSection(ProjectConfiguration) = postSolution
+		{619CF3F9-C373-4BD5-93DA-025F5E16F8FA}.Debug.ActiveCfg = Debug|Win32
+		{619CF3F9-C373-4BD5-93DA-025F5E16F8FA}.Debug.Build.0 = Debug|Win32
+		{619CF3F9-C373-4BD5-93DA-025F5E16F8FA}.Release.ActiveCfg = Release|Win32
+		{619CF3F9-C373-4BD5-93DA-025F5E16F8FA}.Release.Build.0 = Release|Win32
+	EndGlobalSection
+	GlobalSection(ExtensibilityGlobals) = postSolution
+	EndGlobalSection
+	GlobalSection(ExtensibilityAddIns) = postSolution
+	EndGlobalSection
+EndGlobal
diff -Nur dosbox-0.74/src/libs/zmbv/zmbv.vcproj dosbox-0.74.patch/src/libs/zmbv/zmbv.vcproj
--- dosbox-0.74/src/libs/zmbv/zmbv.vcproj	1970-01-01 01:00:00.000000000 +0100
+++ dosbox-0.74.patch/src/libs/zmbv/zmbv.vcproj	2016-12-11 18:35:15.554284005 +0100
@@ -0,0 +1,141 @@
+<?xml version="1.0" encoding="Windows-1252"?>
+<VisualStudioProject
+	ProjectType="Visual C++"
+	Version="7.10"
+	Name="zmbv"
+	ProjectGUID="{619CF3F9-C373-4BD5-93DA-025F5E16F8FA}"
+	Keyword="Win32Proj">
+	<Platforms>
+		<Platform
+			Name="Win32"/>
+	</Platforms>
+	<Configurations>
+		<Configuration
+			Name="Debug|Win32"
+			OutputDirectory="Debug"
+			IntermediateDirectory="Debug"
+			ConfigurationType="2"
+			CharacterSet="2">
+			<Tool
+				Name="VCCLCompilerTool"
+				Optimization="0"
+				PreprocessorDefinitions="WIN32;_DEBUG;_WINDOWS"
+				MinimalRebuild="TRUE"
+				BasicRuntimeChecks="3"
+				RuntimeLibrary="5"
+				BufferSecurityCheck="TRUE"
+				UsePrecompiledHeader="0"
+				WarningLevel="3"
+				Detect64BitPortabilityProblems="TRUE"
+				DebugInformationFormat="4"/>
+			<Tool
+				Name="VCCustomBuildTool"/>
+			<Tool
+				Name="VCLinkerTool"
+				AdditionalDependencies="winmm.lib odbc32.lib odbccp32.lib zlib.lib"
+				OutputFile="$(OutDir)/zmbv.dll"
+				LinkIncremental="2"
+				ModuleDefinitionFile="zmbv.def"
+				GenerateDebugInformation="TRUE"
+				ProgramDatabaseFile="$(OutDir)/zmbv.pdb"
+				SubSystem="2"
+				TargetMachine="1"/>
+			<Tool
+				Name="VCMIDLTool"/>
+			<Tool
+				Name="VCPostBuildEventTool"/>
+			<Tool
+				Name="VCPreBuildEventTool"/>
+			<Tool
+				Name="VCPreLinkEventTool"/>
+			<Tool
+				Name="VCResourceCompilerTool"/>
+			<Tool
+				Name="VCWebServiceProxyGeneratorTool"/>
+			<Tool
+				Name="VCXMLDataGeneratorTool"/>
+			<Tool
+				Name="VCWebDeploymentTool"/>
+			<Tool
+				Name="VCManagedWrapperGeneratorTool"/>
+			<Tool
+				Name="VCAuxiliaryManagedWrapperGeneratorTool"/>
+		</Configuration>
+		<Configuration
+			Name="Release|Win32"
+			OutputDirectory="Release"
+			IntermediateDirectory="Release"
+			ConfigurationType="2"
+			CharacterSet="2">
+			<Tool
+				Name="VCCLCompilerTool"
+				PreprocessorDefinitions="WIN32;NDEBUG;_WINDOWS"
+				RuntimeLibrary="4"
+				UsePrecompiledHeader="0"
+				WarningLevel="3"
+				Detect64BitPortabilityProblems="TRUE"
+				DebugInformationFormat="3"/>
+			<Tool
+				Name="VCCustomBuildTool"/>
+			<Tool
+				Name="VCLinkerTool"
+				AdditionalDependencies="winmm.lib odbc32.lib odbccp32.lib zlib.lib"
+				OutputFile="$(OutDir)/zmbv.dll"
+				LinkIncremental="1"
+				ModuleDefinitionFile="zmbv.def"
+				GenerateDebugInformation="TRUE"
+				MapExports="TRUE"
+				SubSystem="2"
+				OptimizeReferences="2"
+				EnableCOMDATFolding="2"
+				TargetMachine="1"/>
+			<Tool
+				Name="VCMIDLTool"/>
+			<Tool
+				Name="VCPostBuildEventTool"/>
+			<Tool
+				Name="VCPreBuildEventTool"/>
+			<Tool
+				Name="VCPreLinkEventTool"/>
+			<Tool
+				Name="VCResourceCompilerTool"/>
+			<Tool
+				Name="VCWebServiceProxyGeneratorTool"/>
+			<Tool
+				Name="VCXMLDataGeneratorTool"/>
+			<Tool
+				Name="VCWebDeploymentTool"/>
+			<Tool
+				Name="VCManagedWrapperGeneratorTool"/>
+			<Tool
+				Name="VCAuxiliaryManagedWrapperGeneratorTool"/>
+		</Configuration>
+	</Configurations>
+	<References>
+	</References>
+	<Files>
+		<File
+			RelativePath=".\drvproc.cpp">
+		</File>
+		<File
+			RelativePath=".\Resource.h">
+		</File>
+		<File
+			RelativePath=".\zmbv.cpp">
+		</File>
+		<File
+			RelativePath=".\zmbv.def">
+		</File>
+		<File
+			RelativePath=".\zmbv.h">
+		</File>
+		<File
+			RelativePath=".\zmbv_vfw.cpp">
+		</File>
+		<File
+			RelativePath=".\zmbv_vfw.rc">
+		</File>
+	</Files>
+	<Globals>
+	</Globals>
+</VisualStudioProject>
diff -Nur dosbox-0.74/src/libs/zmbv/zmbv_vfw.cpp dosbox-0.74.patch/src/libs/zmbv/zmbv_vfw.cpp
--- dosbox-0.74/src/libs/zmbv/zmbv_vfw.cpp	1970-01-01 01:00:00.000000000 +0100
+++ dosbox-0.74.patch/src/libs/zmbv/zmbv_vfw.cpp	2016-12-11 18:35:15.554284005 +0100
@@ -0,0 +1,397 @@
+/*
+ *  Copyright (C) 2002-2013  The DOSBox Team
+ *
+ *  This program is free software; you can redistribute it and/or modify
+ *  it under the terms of the GNU General Public License as published by
+ *  the Free Software Foundation; either version 2 of the License, or
+ *  (at your option) any later version.
+ *
+ *  This program is distributed in the hope that it will be useful,
+ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *  GNU General Public License for more details.
+ *
+ *  You should have received a copy of the GNU General Public License
+ *  along with this program; if not, write to the Free Software
+ *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+ */
+//
+// Zipped Motion Block Video
+//
+// Based on Huffyuv by Ben Rudiak-Gould.
+// which was based on MSYUV sample code, which is:
+// Copyright (c) 1993 Microsoft Corporation.
+// All Rights Reserved.
+//
+
+#include "zmbv_vfw.h"
+#include "resource.h"
+
+#include <crtdbg.h>
+#include <string.h>
+
+TCHAR szDescription[] = TEXT("Zipped Motion Block Video v0.1");
+TCHAR szName[]        = TEXT(CODEC_4CC);
+
+#define VERSION         0x00000001      // 0.1
+
+/********************************************************************
+********************************************************************/
+
+CodecInst *encode_table_owner, *decode_table_owner;
+
+/********************************************************************
+********************************************************************/
+
+void Msg(const char fmt[], ...) {
+  DWORD written;
+  char buf[2000];
+  va_list val;
+  
+  va_start(val, fmt);
+  wvsprintf(buf, fmt, val);
+
+  const COORD _80x50 = {80,50};
+  static BOOL startup = (AllocConsole(), SetConsoleScreenBufferSize(GetStdHandle(STD_OUTPUT_HANDLE), _80x50));
+  WriteConsole(GetStdHandle(STD_OUTPUT_HANDLE), buf, lstrlen(buf), &written, 0);
+}
+
+
+/********************************************************************
+********************************************************************/
+
+CodecInst::CodecInst() {
+	codec = 0;
+}
+
+CodecInst* Open(ICOPEN* icinfo) {
+  if (icinfo && icinfo->fccType != ICTYPE_VIDEO)
+      return NULL;
+
+  CodecInst* pinst = new CodecInst();
+
+  if (icinfo) icinfo->dwError = pinst ? ICERR_OK : ICERR_MEMORY;
+
+  return pinst;
+}
+
+DWORD Close(CodecInst* pinst) {
+//    delete pinst;       // this caused problems when deleting at app close time
+    return 1;
+}
+
+/********************************************************************
+********************************************************************/
+
+
+/********************************************************************
+********************************************************************/
+
+BOOL CodecInst::QueryAbout() { return TRUE; }
+
+static BOOL CALLBACK AboutDialogProc(HWND hwndDlg, UINT uMsg, WPARAM wParam, LPARAM lParam) {
+  if (uMsg == WM_COMMAND) {
+    switch (LOWORD(wParam)) {
+    case IDOK:
+      EndDialog(hwndDlg, 0);
+      break;
+    case IDC_HOMEPAGE:
+      ShellExecute(NULL, NULL, "http://www.dosbox.com", NULL, NULL, SW_SHOW);
+      break;
+    case IDC_EMAIL:
+      ShellExecute(NULL, NULL, "mailto:dosbox.crew@gmail.com", NULL, NULL, SW_SHOW);
+      break;
+    }
+  }
+  return FALSE;
+}
+DWORD CodecInst::About(HWND hwnd) {
+  DialogBox(hmoduleCodec, MAKEINTRESOURCE(IDD_ABOUT), hwnd, AboutDialogProc);
+  return ICERR_OK;
+}
+
+static BOOL CALLBACK ConfigureDialogProc(HWND hwndDlg, UINT uMsg, WPARAM wParam, LPARAM lParam) {
+
+  if (uMsg == WM_INITDIALOG) {
+
+  } else if (uMsg == WM_COMMAND) {
+
+    switch (LOWORD(wParam)) {
+
+    case IDOK:
+
+    case IDCANCEL:
+      EndDialog(hwndDlg, 0);
+      break;
+
+    default:
+      return AboutDialogProc(hwndDlg, uMsg, wParam, lParam);    // handle email and home-page buttons
+    }
+  }
+  return FALSE;
+}
+
+BOOL CodecInst::QueryConfigure() { return TRUE; }
+
+DWORD CodecInst::Configure(HWND hwnd) {
+  DialogBox(hmoduleCodec, MAKEINTRESOURCE(IDD_CONFIGURE), hwnd, ConfigureDialogProc);
+  return ICERR_OK;
+}
+
+
+/********************************************************************
+********************************************************************/
+
+
+// we have no state information which needs to be stored
+
+DWORD CodecInst::GetState(LPVOID pv, DWORD dwSize) { return 0; }
+
+DWORD CodecInst::SetState(LPVOID pv, DWORD dwSize) { return 0; }
+
+
+DWORD CodecInst::GetInfo(ICINFO* icinfo, DWORD dwSize) {
+  if (icinfo == NULL)
+    return sizeof(ICINFO);
+
+  if (dwSize < sizeof(ICINFO))
+    return 0;
+
+  icinfo->dwSize            = sizeof(ICINFO);
+  icinfo->fccType           = ICTYPE_VIDEO;
+  memcpy(&icinfo->fccHandler,CODEC_4CC, 4);
+  icinfo->dwFlags           = VIDCF_FASTTEMPORALC | VIDCF_FASTTEMPORALD | VIDCF_TEMPORAL;
+
+  icinfo->dwVersion         = VERSION;
+  icinfo->dwVersionICM      = ICVERSION;
+  MultiByteToWideChar(CP_ACP, 0, szDescription, -1, icinfo->szDescription, sizeof(icinfo->szDescription)/sizeof(WCHAR));
+  MultiByteToWideChar(CP_ACP, 0, szName, -1, icinfo->szName, sizeof(icinfo->szName)/sizeof(WCHAR));
+
+  return sizeof(ICINFO);
+}
+
+/********************************************************************
+****************************************************************/
+
+static int GetInputBitDepth(const BITMAPINFOHEADER *lpbiIn) {
+	if (lpbiIn->biCompression == BI_RGB) {
+		if (lpbiIn->biPlanes != 1)
+			return -1;
+
+		switch(lpbiIn->biBitCount) {
+			case 8:
+				return 8;
+			case 16:
+				return 15;		// Standard Windows 16-bit RGB is 1555.
+			case 32:
+				return 32;
+		}
+
+	} else if (lpbiIn->biCompression == BI_BITFIELDS) {
+		// BI_BITFIELDS RGB masks lie right after the BITMAPINFOHEADER structure,
+		// at (ptr+40). This is true even for a BITMAPV4HEADER or BITMAPV5HEADER.
+		const DWORD *masks = (const DWORD *)(lpbiIn + 1);
+
+		if (lpbiIn->biBitCount == 16) {
+			// Test for 16 (555)
+			if (masks[0] == 0x7C00 && masks[1] == 0x03E0 && masks[2] == 0x001F)
+				return 15;
+
+			// Test for 16 (565)
+			if (masks[0] == 0xF800 && masks[1] == 0x07E0 && masks[2] == 0x001F)
+				return 16;
+		} else if (lpbiIn->biBitCount == 32) {
+			if (masks[0] == 0xFF0000 && masks[1] == 0x00FF00 && masks[2] == 0x0000FF)
+				return 32;
+		}
+	}
+
+	return -1;
+}
+
+static bool CanCompress(LPBITMAPINFOHEADER lpbiIn, LPBITMAPINFOHEADER lpbiOut, bool requireOutput) {
+	if (lpbiIn) {
+		if (GetInputBitDepth(lpbiIn) < 0)
+			return false;
+	} else return false;
+	if (lpbiOut) {
+		if (memcmp(&lpbiOut->biCompression,CODEC_4CC, 4))
+			return false;
+	} else return !requireOutput;
+	return true;
+}
+
+/********************************************************************
+****************************************************************/
+
+DWORD CodecInst::CompressQuery(LPBITMAPINFOHEADER lpbiIn, LPBITMAPINFOHEADER lpbiOut) {
+	if (CanCompress(lpbiIn,lpbiOut,false)) return ICERR_OK;
+	return ICERR_BADFORMAT;
+}
+
+DWORD CodecInst::CompressGetFormat(LPBITMAPINFOHEADER lpbiIn, LPBITMAPINFOHEADER lpbiOut) {
+	if (!lpbiOut)
+		return sizeof(BITMAPINFOHEADER);
+	lpbiOut->biSize			= sizeof(BITMAPINFOHEADER);
+	lpbiOut->biWidth		= lpbiIn->biWidth;
+	lpbiOut->biHeight		= lpbiIn->biHeight;
+	lpbiOut->biPlanes		= 1;
+	lpbiOut->biCompression	= *(const DWORD *)CODEC_4CC;
+	lpbiOut->biBitCount		= lpbiIn->biBitCount;
+	lpbiOut->biSizeImage	= lpbiIn->biWidth * lpbiIn->biHeight * lpbiIn->biBitCount/8 + 1024;
+	lpbiOut->biXPelsPerMeter = lpbiIn->biXPelsPerMeter;
+	lpbiOut->biYPelsPerMeter = lpbiIn->biYPelsPerMeter;
+	lpbiOut->biClrUsed		= 0;
+	lpbiOut->biClrImportant	= 0;
+	return ICERR_OK;
+}
+
+DWORD CodecInst::CompressBegin(LPBITMAPINFOHEADER lpbiIn, LPBITMAPINFOHEADER lpbiOut) {
+	CompressEnd();  // free resources if necessary
+	if (!CanCompress(lpbiIn, lpbiOut, true))
+		return ICERR_BADFORMAT;
+	codec = new VideoCodec();
+	if (!codec)
+		return ICERR_MEMORY;
+	if (!codec->SetupCompress( lpbiIn->biWidth, lpbiIn->biHeight))
+		return ICERR_MEMORY;
+	return ICERR_OK;
+}
+
+DWORD CodecInst::CompressGetSize(LPBITMAPINFOHEADER lpbiIn, LPBITMAPINFOHEADER lpbiOut) {
+	if (!CanCompress(lpbiIn, lpbiOut, true))
+		return ICERR_BADFORMAT;
+	return lpbiIn->biWidth * lpbiIn->biHeight * lpbiIn->biBitCount/8 + 1024;
+}
+
+DWORD CodecInst::Compress(ICCOMPRESS* icinfo, DWORD dwSize) {
+	int i, pitch;
+	zmbv_format_t format;
+	LPBITMAPINFOHEADER lpbiIn=icinfo->lpbiInput;
+	LPBITMAPINFOHEADER lpbiOut=icinfo->lpbiOutput;
+	if (!CanCompress(lpbiIn, lpbiOut, true))
+		return ICERR_BADFORMAT;
+	if (!icinfo->lpInput || !icinfo->lpOutput)
+		return ICERR_ABORT;
+	switch (GetInputBitDepth(lpbiIn)) {
+	case 8:
+		format = ZMBV_FORMAT_8BPP;
+		pitch = lpbiIn->biWidth;
+		break;
+	case 15:
+		format = ZMBV_FORMAT_15BPP;
+		pitch = lpbiIn->biWidth * 2;
+		break;
+	case 16:
+		format = ZMBV_FORMAT_16BPP;
+		pitch = lpbiIn->biWidth * 2;
+		break;
+	case 32:
+		format = ZMBV_FORMAT_32BPP;
+		pitch = lpbiIn->biWidth * 4;
+		break;
+	}
+
+	// DIB scanlines for RGB formats are always aligned to DWORD.
+	pitch = (pitch + 3) & ~3;
+
+	// force a key frame if requested by the client
+	int flags = 0;
+	if (icinfo->dwFlags & ICCOMPRESS_KEYFRAME)
+		flags |= 1;
+
+	codec->PrepareCompressFrame( flags, format, 0, icinfo->lpOutput, 99999999);
+	char *readPt = (char *)icinfo->lpInput + pitch*(lpbiIn->biHeight - 1);
+	for(i = 0;i<lpbiIn->biHeight;i++) {
+		codec->CompressLines(1, (void **)&readPt );
+		readPt -= pitch;
+	}
+	lpbiOut->biSizeImage = codec->FinishCompressFrame();
+
+	if (flags & 1)
+		*icinfo->lpdwFlags = AVIIF_KEYFRAME;
+	else
+		*icinfo->lpdwFlags = 0;
+
+	return ICERR_OK;
+}
+
+
+DWORD CodecInst::CompressEnd() {
+	if (codec) 
+		delete codec;
+	codec = 0;
+	return ICERR_OK;
+}
+
+/********************************************************************
+********************************************************************/
+
+static bool CanDecompress(LPBITMAPINFOHEADER lpbiIn, LPBITMAPINFOHEADER lpbiOut) {
+	if (memcmp(&lpbiIn->biCompression,CODEC_4CC,4))
+		return false;
+	if (lpbiOut) {
+		if (lpbiOut->biCompression!=0) return false;
+		if (lpbiOut->biBitCount != 24) return false;
+		if (lpbiIn->biWidth!=lpbiOut->biWidth || lpbiIn->biHeight!=lpbiOut->biHeight)
+            return false;
+	}
+	return true;
+}
+
+/********************************************************************
+********************************************************************/
+
+
+DWORD CodecInst::DecompressQuery(LPBITMAPINFOHEADER lpbiIn, LPBITMAPINFOHEADER lpbiOut) {
+	return CanDecompress(lpbiIn, lpbiOut) ? ICERR_OK : ICERR_BADFORMAT;
+}
+
+DWORD CodecInst::DecompressGetFormat(LPBITMAPINFOHEADER lpbiIn, LPBITMAPINFOHEADER lpbiOut) {
+	if (memcmp(&lpbiIn->biCompression,CODEC_4CC,4))
+		 return ICERR_BADFORMAT;
+	if (!lpbiOut) return sizeof(BITMAPINFOHEADER);
+	*lpbiOut = *lpbiIn;
+	lpbiOut->biPlanes		= 1;
+	lpbiOut->biSize			= sizeof(BITMAPINFOHEADER);
+	lpbiOut->biBitCount		= 24;
+	lpbiOut->biSizeImage	= ((lpbiOut->biWidth*3 + 3) & ~3) * lpbiOut->biHeight;
+	lpbiOut->biCompression	= BI_RGB;
+	lpbiOut->biClrUsed		= 0;
+	lpbiOut->biClrImportant	= 0;
+	return ICERR_OK;
+}
+
+DWORD CodecInst::DecompressBegin(LPBITMAPINFOHEADER lpbiIn, LPBITMAPINFOHEADER lpbiOut) {
+	DecompressEnd();  // free resources if necessary
+	if (!CanDecompress(lpbiIn, lpbiOut))
+		return ICERR_BADFORMAT;
+	codec=new VideoCodec();
+	if (!codec)
+		return ICERR_MEMORY;
+	if (!codec->SetupDecompress( lpbiIn->biWidth, lpbiIn->biHeight))
+		return ICERR_MEMORY;
+	return ICERR_OK;
+}
+
+DWORD CodecInst::Decompress(ICDECOMPRESS* icinfo, DWORD dwSize) {
+	if (!codec || !icinfo)
+		return ICERR_ABORT;
+	if (codec->DecompressFrame( icinfo->lpInput, icinfo->lpbiInput->biSizeImage)) {
+		codec->Output_UpsideDown_24(icinfo->lpOutput);
+	} else return ICERR_DONTDRAW;
+	return ICERR_OK;
+}
+
+
+// palette-mapped output only
+DWORD CodecInst::DecompressGetPalette(LPBITMAPINFOHEADER lpbiIn, LPBITMAPINFOHEADER lpbiOut) {
+	return ICERR_BADFORMAT;
+}
+
+DWORD CodecInst::DecompressEnd() {
+	if (codec) 
+		delete codec;
+	codec = 0;
+	return ICERR_OK;
+}
diff -Nur dosbox-0.74/src/libs/zmbv/zmbv_vfw.h dosbox-0.74.patch/src/libs/zmbv/zmbv_vfw.h
--- dosbox-0.74/src/libs/zmbv/zmbv_vfw.h	1970-01-01 01:00:00.000000000 +0100
+++ dosbox-0.74.patch/src/libs/zmbv/zmbv_vfw.h	2016-12-11 18:35:15.554284005 +0100
@@ -0,0 +1,61 @@
+//
+// Huffyuv v2.1.1, by Ben Rudiak-Gould.
+// http://www.math.berkeley.edu/~benrg/huffyuv.html
+//
+// This file is copyright 2000 Ben Rudiak-Gould, and distributed under
+// the terms of the GNU General Public License, v2 or later.  See
+// http://www.gnu.org/copyleft/gpl.html.
+//
+// I edit these files in 10-point Verdana, a proportionally-spaced font.
+// You may notice formatting oddities if you use a monospaced font.
+//
+
+
+#include <windows.h>
+#include <vfw.h>
+#include <zlib.h>
+#include "zmbv.h"
+#pragma hdrstop
+
+extern HMODULE hmoduleCodec;
+
+
+// huffyuv.cpp
+
+class CodecInst {
+private:
+	VideoCodec * codec;
+public:
+  CodecInst();
+  ~CodecInst();
+
+  BOOL QueryAbout();
+  DWORD About(HWND hwnd);
+
+  BOOL QueryConfigure();
+  DWORD Configure(HWND hwnd);
+
+  DWORD GetState(LPVOID pv, DWORD dwSize);
+  DWORD SetState(LPVOID pv, DWORD dwSize);
+
+  DWORD GetInfo(ICINFO* icinfo, DWORD dwSize);
+
+  DWORD CompressQuery(LPBITMAPINFOHEADER lpbiIn, LPBITMAPINFOHEADER lpbiOut);
+  DWORD CompressGetFormat(LPBITMAPINFOHEADER lpbiIn, LPBITMAPINFOHEADER lpbiOut);
+  DWORD CompressBegin(LPBITMAPINFOHEADER lpbiIn, LPBITMAPINFOHEADER lpbiOut);
+  DWORD CompressGetSize(LPBITMAPINFOHEADER lpbiIn, LPBITMAPINFOHEADER lpbiOut);
+  DWORD Compress(ICCOMPRESS* icinfo, DWORD dwSize);
+  DWORD CompressEnd();
+
+  DWORD DecompressQuery(LPBITMAPINFOHEADER lpbiIn, LPBITMAPINFOHEADER lpbiOut);
+  DWORD DecompressGetFormat(LPBITMAPINFOHEADER lpbiIn, LPBITMAPINFOHEADER lpbiOut);
+  DWORD DecompressBegin(LPBITMAPINFOHEADER lpbiIn, LPBITMAPINFOHEADER lpbiOut);
+  
+  DWORD Decompress(ICDECOMPRESS* icinfo, DWORD dwSize);
+  DWORD DecompressGetPalette(LPBITMAPINFOHEADER lpbiIn, LPBITMAPINFOHEADER lpbiOut);
+  DWORD DecompressEnd();
+};
+
+CodecInst* Open(ICOPEN* icinfo);
+DWORD Close(CodecInst* pinst);
+
diff -Nur dosbox-0.74/src/libs/zmbv/zmbv_vfw.rc dosbox-0.74.patch/src/libs/zmbv/zmbv_vfw.rc
--- dosbox-0.74/src/libs/zmbv/zmbv_vfw.rc	1970-01-01 01:00:00.000000000 +0100
+++ dosbox-0.74.patch/src/libs/zmbv/zmbv_vfw.rc	2016-12-11 18:35:15.554284005 +0100
@@ -0,0 +1,123 @@
+// Microsoft Visual C++ generated resource script.
+//
+#include "resource.h"
+
+#define APSTUDIO_READONLY_SYMBOLS
+/////////////////////////////////////////////////////////////////////////////
+//
+// Generated from the TEXTINCLUDE 2 resource.
+//
+#include "winres.h"
+
+/////////////////////////////////////////////////////////////////////////////
+#undef APSTUDIO_READONLY_SYMBOLS
+
+/////////////////////////////////////////////////////////////////////////////
+// English (U.S.) resources
+
+#if !defined(AFX_RESOURCE_DLL) || defined(AFX_TARG_ENU)
+#ifdef _WIN32
+LANGUAGE LANG_ENGLISH, SUBLANG_ENGLISH_US
+#pragma code_page(1252)
+#endif //_WIN32
+
+#ifdef APSTUDIO_INVOKED
+/////////////////////////////////////////////////////////////////////////////
+//
+// TEXTINCLUDE
+//
+
+1 TEXTINCLUDE
+BEGIN
+    "resource.h\0"
+END
+
+2 TEXTINCLUDE
+BEGIN
+    "#include ""winres.h""\r\n"
+    "\0"
+END
+
+3 TEXTINCLUDE
+BEGIN
+    "\r\n"
+    "\0"
+END
+
+#endif    // APSTUDIO_INVOKED
+
+
+/////////////////////////////////////////////////////////////////////////////
+//
+// Dialog
+//
+
+IDD_ABOUT DIALOGEX 0, 0, 167, 55
+STYLE DS_SETFONT | DS_MODALFRAME | DS_CENTER | WS_POPUP | WS_CAPTION |
+    WS_SYSMENU
+CAPTION "DOSBox Video Codec v0.1"
+FONT 8, "MS Sans Serif", 0, 0, 0x0
+BEGIN
+    DEFPUSHBUTTON   "OK",IDOK,131,34,29,14
+    CTEXT           "Zipped Motion Block Video v 0.1\nCopyright 2009-2013 DOSBox Team",
+                    IDC_STATIC,7,7,153,25,SS_NOPREFIX
+    PUSHBUTTON      "Email author",IDC_EMAIL,7,34,50,14
+    PUSHBUTTON      "Visit home page",IDC_HOMEPAGE,59,34,58,14
+END
+
+IDD_CONFIGURE DIALOGEX 0, 0, 213, 146
+STYLE DS_SETFONT | DS_MODALFRAME | DS_CENTER | WS_POPUP | WS_CAPTION |
+    WS_SYSMENU
+CAPTION "ZMBV configuration dialog"
+FONT 8, "MS Sans Serif", 0, 0, 0x0
+BEGIN
+    PUSHBUTTON      "Email author",IDC_EMAIL,44,86,50,14
+    PUSHBUTTON      "Visit home page",IDC_HOMEPAGE,109,87,58,14
+    DEFPUSHBUTTON   "OK",IDOK,44,125,50,14
+    PUSHBUTTON      "Cancel",IDCANCEL,117,125,50,14
+    CONTROL         "",IDC_SLIDER1,"msctls_trackbar32",TBS_BOTH |
+                    TBS_NOTICKS | WS_TABSTOP,57,30,92,18
+END
+
+
+/////////////////////////////////////////////////////////////////////////////
+//
+// DESIGNINFO
+//
+
+#ifdef APSTUDIO_INVOKED
+GUIDELINES DESIGNINFO
+BEGIN
+    IDD_ABOUT, DIALOG
+    BEGIN
+        LEFTMARGIN, 7
+        RIGHTMARGIN, 160
+        TOPMARGIN, 7
+        BOTTOMMARGIN, 48
+    END
+
+    IDD_CONFIGURE, DIALOG
+    BEGIN
+        LEFTMARGIN, 44
+        RIGHTMARGIN, 167
+        TOPMARGIN, 6
+        BOTTOMMARGIN, 139
+    END
+END
+#endif    // APSTUDIO_INVOKED
+
+#endif    // English (U.S.) resources
+/////////////////////////////////////////////////////////////////////////////
+
+
+
+#ifndef APSTUDIO_INVOKED
+/////////////////////////////////////////////////////////////////////////////
+//
+// Generated from the TEXTINCLUDE 3 resource.
+//
+
+
+/////////////////////////////////////////////////////////////////////////////
+#endif    // not APSTUDIO_INVOKED
+
diff -Nur dosbox-0.74/src/Makefile.in dosbox-0.74.patch/src/Makefile.in
--- dosbox-0.74/src/Makefile.in	2010-05-12 11:57:43.000000000 +0200
+++ dosbox-0.74.patch/src/Makefile.in	1970-01-01 01:00:00.000000000 +0100
@@ -1,640 +0,0 @@
-# Makefile.in generated by automake 1.11.1 from Makefile.am.
-# @configure_input@
-
-# Copyright (C) 1994, 1995, 1996, 1997, 1998, 1999, 2000, 2001, 2002,
-# 2003, 2004, 2005, 2006, 2007, 2008, 2009  Free Software Foundation,
-# Inc.
-# This Makefile.in is free software; the Free Software Foundation
-# gives unlimited permission to copy and/or distribute it,
-# with or without modifications, as long as this notice is preserved.
-
-# This program is distributed in the hope that it will be useful,
-# but WITHOUT ANY WARRANTY, to the extent permitted by law; without
-# even the implied warranty of MERCHANTABILITY or FITNESS FOR A
-# PARTICULAR PURPOSE.
-
-@SET_MAKE@
-
-VPATH = @srcdir@
-pkgdatadir = $(datadir)/@PACKAGE@
-pkgincludedir = $(includedir)/@PACKAGE@
-pkglibdir = $(libdir)/@PACKAGE@
-pkglibexecdir = $(libexecdir)/@PACKAGE@
-am__cd = CDPATH="$${ZSH_VERSION+.}$(PATH_SEPARATOR)" && cd
-install_sh_DATA = $(install_sh) -c -m 644
-install_sh_PROGRAM = $(install_sh) -c
-install_sh_SCRIPT = $(install_sh) -c
-INSTALL_HEADER = $(INSTALL_DATA)
-transform = $(program_transform_name)
-NORMAL_INSTALL = :
-PRE_INSTALL = :
-POST_INSTALL = :
-NORMAL_UNINSTALL = :
-PRE_UNINSTALL = :
-POST_UNINSTALL = :
-build_triplet = @build@
-host_triplet = @host@
-bin_PROGRAMS = dosbox$(EXEEXT)
-subdir = src
-DIST_COMMON = $(srcdir)/Makefile.am $(srcdir)/Makefile.in
-ACLOCAL_M4 = $(top_srcdir)/aclocal.m4
-am__aclocal_m4_deps = $(top_srcdir)/acinclude.m4 \
-	$(top_srcdir)/configure.in
-am__configure_deps = $(am__aclocal_m4_deps) $(CONFIGURE_DEPENDENCIES) \
-	$(ACLOCAL_M4)
-mkinstalldirs = $(install_sh) -d
-CONFIG_HEADER = $(top_builddir)/config.h
-CONFIG_CLEAN_FILES =
-CONFIG_CLEAN_VPATH_FILES =
-am__installdirs = "$(DESTDIR)$(bindir)"
-PROGRAMS = $(bin_PROGRAMS)
-am__dosbox_SOURCES_DIST = dosbox.cpp winres.rc
-@HAVE_WINDRES_TRUE@am__objects_1 = winres.$(OBJEXT)
-am_dosbox_OBJECTS = dosbox.$(OBJEXT) $(am__objects_1)
-dosbox_OBJECTS = $(am_dosbox_OBJECTS)
-dosbox_DEPENDENCIES = cpu/libcpu.a debug/libdebug.a dos/libdos.a \
-	fpu/libfpu.a hardware/libhardware.a gui/libgui.a \
-	ints/libints.a misc/libmisc.a shell/libshell.a \
-	hardware/serialport/libserial.a libs/gui_tk/libgui_tk.a
-DEFAULT_INCLUDES = -I.@am__isrc@ -I$(top_builddir)
-depcomp = $(SHELL) $(top_srcdir)/depcomp
-am__depfiles_maybe = depfiles
-am__mv = mv -f
-CXXCOMPILE = $(CXX) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) \
-	$(AM_CPPFLAGS) $(CPPFLAGS) $(AM_CXXFLAGS) $(CXXFLAGS)
-CXXLD = $(CXX)
-CXXLINK = $(CXXLD) $(AM_CXXFLAGS) $(CXXFLAGS) $(AM_LDFLAGS) $(LDFLAGS) \
-	-o $@
-SOURCES = $(dosbox_SOURCES)
-DIST_SOURCES = $(am__dosbox_SOURCES_DIST)
-RECURSIVE_TARGETS = all-recursive check-recursive dvi-recursive \
-	html-recursive info-recursive install-data-recursive \
-	install-dvi-recursive install-exec-recursive \
-	install-html-recursive install-info-recursive \
-	install-pdf-recursive install-ps-recursive install-recursive \
-	installcheck-recursive installdirs-recursive pdf-recursive \
-	ps-recursive uninstall-recursive
-RECURSIVE_CLEAN_TARGETS = mostlyclean-recursive clean-recursive	\
-  distclean-recursive maintainer-clean-recursive
-AM_RECURSIVE_TARGETS = $(RECURSIVE_TARGETS:-recursive=) \
-	$(RECURSIVE_CLEAN_TARGETS:-recursive=) tags TAGS ctags CTAGS \
-	distdir
-ETAGS = etags
-CTAGS = ctags
-DIST_SUBDIRS = $(SUBDIRS)
-DISTFILES = $(DIST_COMMON) $(DIST_SOURCES) $(TEXINFOS) $(EXTRA_DIST)
-am__relativize = \
-  dir0=`pwd`; \
-  sed_first='s,^\([^/]*\)/.*$$,\1,'; \
-  sed_rest='s,^[^/]*/*,,'; \
-  sed_last='s,^.*/\([^/]*\)$$,\1,'; \
-  sed_butlast='s,/*[^/]*$$,,'; \
-  while test -n "$$dir1"; do \
-    first=`echo "$$dir1" | sed -e "$$sed_first"`; \
-    if test "$$first" != "."; then \
-      if test "$$first" = ".."; then \
-        dir2=`echo "$$dir0" | sed -e "$$sed_last"`/"$$dir2"; \
-        dir0=`echo "$$dir0" | sed -e "$$sed_butlast"`; \
-      else \
-        first2=`echo "$$dir2" | sed -e "$$sed_first"`; \
-        if test "$$first2" = "$$first"; then \
-          dir2=`echo "$$dir2" | sed -e "$$sed_rest"`; \
-        else \
-          dir2="../$$dir2"; \
-        fi; \
-        dir0="$$dir0"/"$$first"; \
-      fi; \
-    fi; \
-    dir1=`echo "$$dir1" | sed -e "$$sed_rest"`; \
-  done; \
-  reldir="$$dir2"
-ACLOCAL = @ACLOCAL@
-ALSA_CFLAGS = @ALSA_CFLAGS@
-ALSA_LIBS = @ALSA_LIBS@
-AMTAR = @AMTAR@
-AUTOCONF = @AUTOCONF@
-AUTOHEADER = @AUTOHEADER@
-AUTOMAKE = @AUTOMAKE@
-AWK = @AWK@
-CC = @CC@
-CCDEPMODE = @CCDEPMODE@
-CFLAGS = @CFLAGS@
-CPP = @CPP@
-CPPFLAGS = @CPPFLAGS@
-CXX = @CXX@
-CXXDEPMODE = @CXXDEPMODE@
-CXXFLAGS = @CXXFLAGS@
-CYGPATH_W = @CYGPATH_W@
-DEFS = @DEFS@
-DEPDIR = @DEPDIR@
-ECHO_C = @ECHO_C@
-ECHO_N = @ECHO_N@
-ECHO_T = @ECHO_T@
-EGREP = @EGREP@
-EXEEXT = @EXEEXT@
-GREP = @GREP@
-INSTALL = @INSTALL@
-INSTALL_DATA = @INSTALL_DATA@
-INSTALL_PROGRAM = @INSTALL_PROGRAM@
-INSTALL_SCRIPT = @INSTALL_SCRIPT@
-INSTALL_STRIP_PROGRAM = @INSTALL_STRIP_PROGRAM@
-LDFLAGS = @LDFLAGS@
-LIBOBJS = @LIBOBJS@
-LIBS = @LIBS@
-LTLIBOBJS = @LTLIBOBJS@
-MAKEINFO = @MAKEINFO@
-MKDIR_P = @MKDIR_P@
-OBJEXT = @OBJEXT@
-PACKAGE = @PACKAGE@
-PACKAGE_BUGREPORT = @PACKAGE_BUGREPORT@
-PACKAGE_NAME = @PACKAGE_NAME@
-PACKAGE_STRING = @PACKAGE_STRING@
-PACKAGE_TARNAME = @PACKAGE_TARNAME@
-PACKAGE_URL = @PACKAGE_URL@
-PACKAGE_VERSION = @PACKAGE_VERSION@
-PATH_SEPARATOR = @PATH_SEPARATOR@
-RANLIB = @RANLIB@
-SDL_CFLAGS = @SDL_CFLAGS@
-SDL_CONFIG = @SDL_CONFIG@
-SDL_LIBS = @SDL_LIBS@
-SET_MAKE = @SET_MAKE@
-SHELL = @SHELL@
-STRIP = @STRIP@
-VERSION = @VERSION@
-WINDRES = @WINDRES@
-abs_builddir = @abs_builddir@
-abs_srcdir = @abs_srcdir@
-abs_top_builddir = @abs_top_builddir@
-abs_top_srcdir = @abs_top_srcdir@
-ac_ct_CC = @ac_ct_CC@
-ac_ct_CXX = @ac_ct_CXX@
-am__include = @am__include@
-am__leading_dot = @am__leading_dot@
-am__quote = @am__quote@
-am__tar = @am__tar@
-am__untar = @am__untar@
-bindir = @bindir@
-build = @build@
-build_alias = @build_alias@
-build_cpu = @build_cpu@
-build_os = @build_os@
-build_vendor = @build_vendor@
-builddir = @builddir@
-datadir = @datadir@
-datarootdir = @datarootdir@
-docdir = @docdir@
-dvidir = @dvidir@
-exec_prefix = @exec_prefix@
-host = @host@
-host_alias = @host_alias@
-host_cpu = @host_cpu@
-host_os = @host_os@
-host_vendor = @host_vendor@
-htmldir = @htmldir@
-includedir = @includedir@
-infodir = @infodir@
-install_sh = @install_sh@
-libdir = @libdir@
-libexecdir = @libexecdir@
-localedir = @localedir@
-localstatedir = @localstatedir@
-mandir = @mandir@
-mkdir_p = @mkdir_p@
-oldincludedir = @oldincludedir@
-pdfdir = @pdfdir@
-prefix = @prefix@
-program_transform_name = @program_transform_name@
-psdir = @psdir@
-sbindir = @sbindir@
-sharedstatedir = @sharedstatedir@
-srcdir = @srcdir@
-sysconfdir = @sysconfdir@
-target_alias = @target_alias@
-top_build_prefix = @top_build_prefix@
-top_builddir = @top_builddir@
-top_srcdir = @top_srcdir@
-AM_CPPFLAGS = -I$(top_srcdir)/include
-SUBDIRS = cpu debug dos fpu gui hardware libs ints misc shell platform 
-@HAVE_WINDRES_TRUE@ico_stuff = winres.rc
-dosbox_SOURCES = dosbox.cpp $(ico_stuff)
-dosbox_LDADD = cpu/libcpu.a debug/libdebug.a dos/libdos.a fpu/libfpu.a  hardware/libhardware.a gui/libgui.a \
-               ints/libints.a misc/libmisc.a shell/libshell.a hardware/serialport/libserial.a libs/gui_tk/libgui_tk.a
-
-EXTRA_DIST = winres.rc dosbox.ico
-all: all-recursive
-
-.SUFFIXES:
-.SUFFIXES: .cpp .o .obj .rc
-$(srcdir)/Makefile.in:  $(srcdir)/Makefile.am  $(am__configure_deps)
-	@for dep in $?; do \
-	  case '$(am__configure_deps)' in \
-	    *$$dep*) \
-	      ( cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh ) \
-	        && { if test -f $@; then exit 0; else break; fi; }; \
-	      exit 1;; \
-	  esac; \
-	done; \
-	echo ' cd $(top_srcdir) && $(AUTOMAKE) --gnu src/Makefile'; \
-	$(am__cd) $(top_srcdir) && \
-	  $(AUTOMAKE) --gnu src/Makefile
-.PRECIOUS: Makefile
-Makefile: $(srcdir)/Makefile.in $(top_builddir)/config.status
-	@case '$?' in \
-	  *config.status*) \
-	    cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh;; \
-	  *) \
-	    echo ' cd $(top_builddir) && $(SHELL) ./config.status $(subdir)/$@ $(am__depfiles_maybe)'; \
-	    cd $(top_builddir) && $(SHELL) ./config.status $(subdir)/$@ $(am__depfiles_maybe);; \
-	esac;
-
-$(top_builddir)/config.status: $(top_srcdir)/configure $(CONFIG_STATUS_DEPENDENCIES)
-	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
-
-$(top_srcdir)/configure:  $(am__configure_deps)
-	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
-$(ACLOCAL_M4):  $(am__aclocal_m4_deps)
-	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
-$(am__aclocal_m4_deps):
-install-binPROGRAMS: $(bin_PROGRAMS)
-	@$(NORMAL_INSTALL)
-	test -z "$(bindir)" || $(MKDIR_P) "$(DESTDIR)$(bindir)"
-	@list='$(bin_PROGRAMS)'; test -n "$(bindir)" || list=; \
-	for p in $$list; do echo "$$p $$p"; done | \
-	sed 's/$(EXEEXT)$$//' | \
-	while read p p1; do if test -f $$p; \
-	  then echo "$$p"; echo "$$p"; else :; fi; \
-	done | \
-	sed -e 'p;s,.*/,,;n;h' -e 's|.*|.|' \
-	    -e 'p;x;s,.*/,,;s/$(EXEEXT)$$//;$(transform);s/$$/$(EXEEXT)/' | \
-	sed 'N;N;N;s,\n, ,g' | \
-	$(AWK) 'BEGIN { files["."] = ""; dirs["."] = 1 } \
-	  { d=$$3; if (dirs[d] != 1) { print "d", d; dirs[d] = 1 } \
-	    if ($$2 == $$4) files[d] = files[d] " " $$1; \
-	    else { print "f", $$3 "/" $$4, $$1; } } \
-	  END { for (d in files) print "f", d, files[d] }' | \
-	while read type dir files; do \
-	    if test "$$dir" = .; then dir=; else dir=/$$dir; fi; \
-	    test -z "$$files" || { \
-	      echo " $(INSTALL_PROGRAM_ENV) $(INSTALL_PROGRAM) $$files '$(DESTDIR)$(bindir)$$dir'"; \
-	      $(INSTALL_PROGRAM_ENV) $(INSTALL_PROGRAM) $$files "$(DESTDIR)$(bindir)$$dir" || exit $$?; \
-	    } \
-	; done
-
-uninstall-binPROGRAMS:
-	@$(NORMAL_UNINSTALL)
-	@list='$(bin_PROGRAMS)'; test -n "$(bindir)" || list=; \
-	files=`for p in $$list; do echo "$$p"; done | \
-	  sed -e 'h;s,^.*/,,;s/$(EXEEXT)$$//;$(transform)' \
-	      -e 's/$$/$(EXEEXT)/' `; \
-	test -n "$$list" || exit 0; \
-	echo " ( cd '$(DESTDIR)$(bindir)' && rm -f" $$files ")"; \
-	cd "$(DESTDIR)$(bindir)" && rm -f $$files
-
-clean-binPROGRAMS:
-	-test -z "$(bin_PROGRAMS)" || rm -f $(bin_PROGRAMS)
-dosbox$(EXEEXT): $(dosbox_OBJECTS) $(dosbox_DEPENDENCIES) 
-	@rm -f dosbox$(EXEEXT)
-	$(CXXLINK) $(dosbox_OBJECTS) $(dosbox_LDADD) $(LIBS)
-
-mostlyclean-compile:
-	-rm -f *.$(OBJEXT)
-
-distclean-compile:
-	-rm -f *.tab.c
-
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/dosbox.Po@am__quote@
-
-.cpp.o:
-@am__fastdepCXX_TRUE@	$(CXXCOMPILE) -MT $@ -MD -MP -MF $(DEPDIR)/$*.Tpo -c -o $@ $<
-@am__fastdepCXX_TRUE@	$(am__mv) $(DEPDIR)/$*.Tpo $(DEPDIR)/$*.Po
-@AMDEP_TRUE@@am__fastdepCXX_FALSE@	source='$<' object='$@' libtool=no @AMDEPBACKSLASH@
-@AMDEP_TRUE@@am__fastdepCXX_FALSE@	DEPDIR=$(DEPDIR) $(CXXDEPMODE) $(depcomp) @AMDEPBACKSLASH@
-@am__fastdepCXX_FALSE@	$(CXXCOMPILE) -c -o $@ $<
-
-.cpp.obj:
-@am__fastdepCXX_TRUE@	$(CXXCOMPILE) -MT $@ -MD -MP -MF $(DEPDIR)/$*.Tpo -c -o $@ `$(CYGPATH_W) '$<'`
-@am__fastdepCXX_TRUE@	$(am__mv) $(DEPDIR)/$*.Tpo $(DEPDIR)/$*.Po
-@AMDEP_TRUE@@am__fastdepCXX_FALSE@	source='$<' object='$@' libtool=no @AMDEPBACKSLASH@
-@AMDEP_TRUE@@am__fastdepCXX_FALSE@	DEPDIR=$(DEPDIR) $(CXXDEPMODE) $(depcomp) @AMDEPBACKSLASH@
-@am__fastdepCXX_FALSE@	$(CXXCOMPILE) -c -o $@ `$(CYGPATH_W) '$<'`
-
-# This directory's subdirectories are mostly independent; you can cd
-# into them and run `make' without going through this Makefile.
-# To change the values of `make' variables: instead of editing Makefiles,
-# (1) if the variable is set in `config.status', edit `config.status'
-#     (which will cause the Makefiles to be regenerated when you run `make');
-# (2) otherwise, pass the desired values on the `make' command line.
-$(RECURSIVE_TARGETS):
-	@fail= failcom='exit 1'; \
-	for f in x $$MAKEFLAGS; do \
-	  case $$f in \
-	    *=* | --[!k]*);; \
-	    *k*) failcom='fail=yes';; \
-	  esac; \
-	done; \
-	dot_seen=no; \
-	target=`echo $@ | sed s/-recursive//`; \
-	list='$(SUBDIRS)'; for subdir in $$list; do \
-	  echo "Making $$target in $$subdir"; \
-	  if test "$$subdir" = "."; then \
-	    dot_seen=yes; \
-	    local_target="$$target-am"; \
-	  else \
-	    local_target="$$target"; \
-	  fi; \
-	  ($(am__cd) $$subdir && $(MAKE) $(AM_MAKEFLAGS) $$local_target) \
-	  || eval $$failcom; \
-	done; \
-	if test "$$dot_seen" = "no"; then \
-	  $(MAKE) $(AM_MAKEFLAGS) "$$target-am" || exit 1; \
-	fi; test -z "$$fail"
-
-$(RECURSIVE_CLEAN_TARGETS):
-	@fail= failcom='exit 1'; \
-	for f in x $$MAKEFLAGS; do \
-	  case $$f in \
-	    *=* | --[!k]*);; \
-	    *k*) failcom='fail=yes';; \
-	  esac; \
-	done; \
-	dot_seen=no; \
-	case "$@" in \
-	  distclean-* | maintainer-clean-*) list='$(DIST_SUBDIRS)' ;; \
-	  *) list='$(SUBDIRS)' ;; \
-	esac; \
-	rev=''; for subdir in $$list; do \
-	  if test "$$subdir" = "."; then :; else \
-	    rev="$$subdir $$rev"; \
-	  fi; \
-	done; \
-	rev="$$rev ."; \
-	target=`echo $@ | sed s/-recursive//`; \
-	for subdir in $$rev; do \
-	  echo "Making $$target in $$subdir"; \
-	  if test "$$subdir" = "."; then \
-	    local_target="$$target-am"; \
-	  else \
-	    local_target="$$target"; \
-	  fi; \
-	  ($(am__cd) $$subdir && $(MAKE) $(AM_MAKEFLAGS) $$local_target) \
-	  || eval $$failcom; \
-	done && test -z "$$fail"
-tags-recursive:
-	list='$(SUBDIRS)'; for subdir in $$list; do \
-	  test "$$subdir" = . || ($(am__cd) $$subdir && $(MAKE) $(AM_MAKEFLAGS) tags); \
-	done
-ctags-recursive:
-	list='$(SUBDIRS)'; for subdir in $$list; do \
-	  test "$$subdir" = . || ($(am__cd) $$subdir && $(MAKE) $(AM_MAKEFLAGS) ctags); \
-	done
-
-ID: $(HEADERS) $(SOURCES) $(LISP) $(TAGS_FILES)
-	list='$(SOURCES) $(HEADERS) $(LISP) $(TAGS_FILES)'; \
-	unique=`for i in $$list; do \
-	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
-	  done | \
-	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
-	      END { if (nonempty) { for (i in files) print i; }; }'`; \
-	mkid -fID $$unique
-tags: TAGS
-
-TAGS: tags-recursive $(HEADERS) $(SOURCES)  $(TAGS_DEPENDENCIES) \
-		$(TAGS_FILES) $(LISP)
-	set x; \
-	here=`pwd`; \
-	if ($(ETAGS) --etags-include --version) >/dev/null 2>&1; then \
-	  include_option=--etags-include; \
-	  empty_fix=.; \
-	else \
-	  include_option=--include; \
-	  empty_fix=; \
-	fi; \
-	list='$(SUBDIRS)'; for subdir in $$list; do \
-	  if test "$$subdir" = .; then :; else \
-	    test ! -f $$subdir/TAGS || \
-	      set "$$@" "$$include_option=$$here/$$subdir/TAGS"; \
-	  fi; \
-	done; \
-	list='$(SOURCES) $(HEADERS)  $(LISP) $(TAGS_FILES)'; \
-	unique=`for i in $$list; do \
-	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
-	  done | \
-	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
-	      END { if (nonempty) { for (i in files) print i; }; }'`; \
-	shift; \
-	if test -z "$(ETAGS_ARGS)$$*$$unique"; then :; else \
-	  test -n "$$unique" || unique=$$empty_fix; \
-	  if test $$# -gt 0; then \
-	    $(ETAGS) $(ETAGSFLAGS) $(AM_ETAGSFLAGS) $(ETAGS_ARGS) \
-	      "$$@" $$unique; \
-	  else \
-	    $(ETAGS) $(ETAGSFLAGS) $(AM_ETAGSFLAGS) $(ETAGS_ARGS) \
-	      $$unique; \
-	  fi; \
-	fi
-ctags: CTAGS
-CTAGS: ctags-recursive $(HEADERS) $(SOURCES)  $(TAGS_DEPENDENCIES) \
-		$(TAGS_FILES) $(LISP)
-	list='$(SOURCES) $(HEADERS)  $(LISP) $(TAGS_FILES)'; \
-	unique=`for i in $$list; do \
-	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
-	  done | \
-	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
-	      END { if (nonempty) { for (i in files) print i; }; }'`; \
-	test -z "$(CTAGS_ARGS)$$unique" \
-	  || $(CTAGS) $(CTAGSFLAGS) $(AM_CTAGSFLAGS) $(CTAGS_ARGS) \
-	     $$unique
-
-GTAGS:
-	here=`$(am__cd) $(top_builddir) && pwd` \
-	  && $(am__cd) $(top_srcdir) \
-	  && gtags -i $(GTAGS_ARGS) "$$here"
-
-distclean-tags:
-	-rm -f TAGS ID GTAGS GRTAGS GSYMS GPATH tags
-
-distdir: $(DISTFILES)
-	@srcdirstrip=`echo "$(srcdir)" | sed 's/[].[^$$\\*]/\\\\&/g'`; \
-	topsrcdirstrip=`echo "$(top_srcdir)" | sed 's/[].[^$$\\*]/\\\\&/g'`; \
-	list='$(DISTFILES)'; \
-	  dist_files=`for file in $$list; do echo $$file; done | \
-	  sed -e "s|^$$srcdirstrip/||;t" \
-	      -e "s|^$$topsrcdirstrip/|$(top_builddir)/|;t"`; \
-	case $$dist_files in \
-	  */*) $(MKDIR_P) `echo "$$dist_files" | \
-			   sed '/\//!d;s|^|$(distdir)/|;s,/[^/]*$$,,' | \
-			   sort -u` ;; \
-	esac; \
-	for file in $$dist_files; do \
-	  if test -f $$file || test -d $$file; then d=.; else d=$(srcdir); fi; \
-	  if test -d $$d/$$file; then \
-	    dir=`echo "/$$file" | sed -e 's,/[^/]*$$,,'`; \
-	    if test -d "$(distdir)/$$file"; then \
-	      find "$(distdir)/$$file" -type d ! -perm -700 -exec chmod u+rwx {} \;; \
-	    fi; \
-	    if test -d $(srcdir)/$$file && test $$d != $(srcdir); then \
-	      cp -fpR $(srcdir)/$$file "$(distdir)$$dir" || exit 1; \
-	      find "$(distdir)/$$file" -type d ! -perm -700 -exec chmod u+rwx {} \;; \
-	    fi; \
-	    cp -fpR $$d/$$file "$(distdir)$$dir" || exit 1; \
-	  else \
-	    test -f "$(distdir)/$$file" \
-	    || cp -p $$d/$$file "$(distdir)/$$file" \
-	    || exit 1; \
-	  fi; \
-	done
-	@list='$(DIST_SUBDIRS)'; for subdir in $$list; do \
-	  if test "$$subdir" = .; then :; else \
-	    test -d "$(distdir)/$$subdir" \
-	    || $(MKDIR_P) "$(distdir)/$$subdir" \
-	    || exit 1; \
-	  fi; \
-	done
-	@list='$(DIST_SUBDIRS)'; for subdir in $$list; do \
-	  if test "$$subdir" = .; then :; else \
-	    dir1=$$subdir; dir2="$(distdir)/$$subdir"; \
-	    $(am__relativize); \
-	    new_distdir=$$reldir; \
-	    dir1=$$subdir; dir2="$(top_distdir)"; \
-	    $(am__relativize); \
-	    new_top_distdir=$$reldir; \
-	    echo " (cd $$subdir && $(MAKE) $(AM_MAKEFLAGS) top_distdir="$$new_top_distdir" distdir="$$new_distdir" \\"; \
-	    echo "     am__remove_distdir=: am__skip_length_check=: am__skip_mode_fix=: distdir)"; \
-	    ($(am__cd) $$subdir && \
-	      $(MAKE) $(AM_MAKEFLAGS) \
-	        top_distdir="$$new_top_distdir" \
-	        distdir="$$new_distdir" \
-		am__remove_distdir=: \
-		am__skip_length_check=: \
-		am__skip_mode_fix=: \
-	        distdir) \
-	      || exit 1; \
-	  fi; \
-	done
-check-am: all-am
-check: check-recursive
-all-am: Makefile $(PROGRAMS)
-installdirs: installdirs-recursive
-installdirs-am:
-	for dir in "$(DESTDIR)$(bindir)"; do \
-	  test -z "$$dir" || $(MKDIR_P) "$$dir"; \
-	done
-install: install-recursive
-install-exec: install-exec-recursive
-install-data: install-data-recursive
-uninstall: uninstall-recursive
-
-install-am: all-am
-	@$(MAKE) $(AM_MAKEFLAGS) install-exec-am install-data-am
-
-installcheck: installcheck-recursive
-install-strip:
-	$(MAKE) $(AM_MAKEFLAGS) INSTALL_PROGRAM="$(INSTALL_STRIP_PROGRAM)" \
-	  install_sh_PROGRAM="$(INSTALL_STRIP_PROGRAM)" INSTALL_STRIP_FLAG=-s \
-	  `test -z '$(STRIP)' || \
-	    echo "INSTALL_PROGRAM_ENV=STRIPPROG='$(STRIP)'"` install
-mostlyclean-generic:
-
-clean-generic:
-
-distclean-generic:
-	-test -z "$(CONFIG_CLEAN_FILES)" || rm -f $(CONFIG_CLEAN_FILES)
-	-test . = "$(srcdir)" || test -z "$(CONFIG_CLEAN_VPATH_FILES)" || rm -f $(CONFIG_CLEAN_VPATH_FILES)
-
-maintainer-clean-generic:
-	@echo "This command is intended for maintainers to use"
-	@echo "it deletes files that may require special tools to rebuild."
-clean: clean-recursive
-
-clean-am: clean-binPROGRAMS clean-generic mostlyclean-am
-
-distclean: distclean-recursive
-	-rm -rf ./$(DEPDIR)
-	-rm -f Makefile
-distclean-am: clean-am distclean-compile distclean-generic \
-	distclean-tags
-
-dvi: dvi-recursive
-
-dvi-am:
-
-html: html-recursive
-
-html-am:
-
-info: info-recursive
-
-info-am:
-
-install-data-am:
-
-install-dvi: install-dvi-recursive
-
-install-dvi-am:
-
-install-exec-am: install-binPROGRAMS
-
-install-html: install-html-recursive
-
-install-html-am:
-
-install-info: install-info-recursive
-
-install-info-am:
-
-install-man:
-
-install-pdf: install-pdf-recursive
-
-install-pdf-am:
-
-install-ps: install-ps-recursive
-
-install-ps-am:
-
-installcheck-am:
-
-maintainer-clean: maintainer-clean-recursive
-	-rm -rf ./$(DEPDIR)
-	-rm -f Makefile
-maintainer-clean-am: distclean-am maintainer-clean-generic
-
-mostlyclean: mostlyclean-recursive
-
-mostlyclean-am: mostlyclean-compile mostlyclean-generic
-
-pdf: pdf-recursive
-
-pdf-am:
-
-ps: ps-recursive
-
-ps-am:
-
-uninstall-am: uninstall-binPROGRAMS
-
-.MAKE: $(RECURSIVE_CLEAN_TARGETS) $(RECURSIVE_TARGETS) ctags-recursive \
-	install-am install-strip tags-recursive
-
-.PHONY: $(RECURSIVE_CLEAN_TARGETS) $(RECURSIVE_TARGETS) CTAGS GTAGS \
-	all all-am check check-am clean clean-binPROGRAMS \
-	clean-generic ctags ctags-recursive distclean \
-	distclean-compile distclean-generic distclean-tags distdir dvi \
-	dvi-am html html-am info info-am install install-am \
-	install-binPROGRAMS install-data install-data-am install-dvi \
-	install-dvi-am install-exec install-exec-am install-html \
-	install-html-am install-info install-info-am install-man \
-	install-pdf install-pdf-am install-ps install-ps-am \
-	install-strip installcheck installcheck-am installdirs \
-	installdirs-am maintainer-clean maintainer-clean-generic \
-	mostlyclean mostlyclean-compile mostlyclean-generic pdf pdf-am \
-	ps ps-am tags tags-recursive uninstall uninstall-am \
-	uninstall-binPROGRAMS
-
-
-.rc.o:
-	$(WINDRES) -o $@ $<
-
-# Tell versions [3.59,3.63) of GNU make to not export all variables.
-# Otherwise a system limit (for SysV at least) may be exceeded.
-.NOEXPORT:
diff -Nur dosbox-0.74/src/misc/cross.cpp dosbox-0.74.patch/src/misc/cross.cpp
--- dosbox-0.74/src/misc/cross.cpp	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/misc/cross.cpp	2016-12-11 18:35:15.554284005 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: cross.cpp,v 1.7 2009-05-26 17:43:39 qbix79 Exp $ */
 
 #include "dosbox.h"
 #include "cross.h"
@@ -122,6 +121,19 @@
 #endif
 }
 
+bool Cross::IsPathAbsolute(std::string const& in) {
+	// Absolute paths
+#if defined (WIN32) || defined(OS2)
+	// drive letter
+	if (in.size() > 2 && in[1] == ':' ) return true;
+	// UNC path
+	else if (in.size() > 2 && in[0]=='\\' && in[1]=='\\') return true;
+#else
+	if (in.size() > 1 && in[0] == '/' ) return true;
+#endif
+	return false;
+}
+
 #if defined (WIN32)
 
 dir_information* open_directory(const char* dirname) {
diff -Nur dosbox-0.74/src/misc/Makefile.in dosbox-0.74.patch/src/misc/Makefile.in
--- dosbox-0.74/src/misc/Makefile.in	2010-05-12 11:57:44.000000000 +0200
+++ dosbox-0.74.patch/src/misc/Makefile.in	1970-01-01 01:00:00.000000000 +0100
@@ -1,444 +0,0 @@
-# Makefile.in generated by automake 1.11.1 from Makefile.am.
-# @configure_input@
-
-# Copyright (C) 1994, 1995, 1996, 1997, 1998, 1999, 2000, 2001, 2002,
-# 2003, 2004, 2005, 2006, 2007, 2008, 2009  Free Software Foundation,
-# Inc.
-# This Makefile.in is free software; the Free Software Foundation
-# gives unlimited permission to copy and/or distribute it,
-# with or without modifications, as long as this notice is preserved.
-
-# This program is distributed in the hope that it will be useful,
-# but WITHOUT ANY WARRANTY, to the extent permitted by law; without
-# even the implied warranty of MERCHANTABILITY or FITNESS FOR A
-# PARTICULAR PURPOSE.
-
-@SET_MAKE@
-
-VPATH = @srcdir@
-pkgdatadir = $(datadir)/@PACKAGE@
-pkgincludedir = $(includedir)/@PACKAGE@
-pkglibdir = $(libdir)/@PACKAGE@
-pkglibexecdir = $(libexecdir)/@PACKAGE@
-am__cd = CDPATH="$${ZSH_VERSION+.}$(PATH_SEPARATOR)" && cd
-install_sh_DATA = $(install_sh) -c -m 644
-install_sh_PROGRAM = $(install_sh) -c
-install_sh_SCRIPT = $(install_sh) -c
-INSTALL_HEADER = $(INSTALL_DATA)
-transform = $(program_transform_name)
-NORMAL_INSTALL = :
-PRE_INSTALL = :
-POST_INSTALL = :
-NORMAL_UNINSTALL = :
-PRE_UNINSTALL = :
-POST_UNINSTALL = :
-build_triplet = @build@
-host_triplet = @host@
-subdir = src/misc
-DIST_COMMON = $(srcdir)/Makefile.am $(srcdir)/Makefile.in
-ACLOCAL_M4 = $(top_srcdir)/aclocal.m4
-am__aclocal_m4_deps = $(top_srcdir)/acinclude.m4 \
-	$(top_srcdir)/configure.in
-am__configure_deps = $(am__aclocal_m4_deps) $(CONFIGURE_DEPENDENCIES) \
-	$(ACLOCAL_M4)
-mkinstalldirs = $(install_sh) -d
-CONFIG_HEADER = $(top_builddir)/config.h
-CONFIG_CLEAN_FILES =
-CONFIG_CLEAN_VPATH_FILES =
-LIBRARIES = $(noinst_LIBRARIES)
-AR = ar
-ARFLAGS = cru
-libmisc_a_AR = $(AR) $(ARFLAGS)
-libmisc_a_LIBADD =
-am_libmisc_a_OBJECTS = cross.$(OBJEXT) messages.$(OBJEXT) \
-	programs.$(OBJEXT) setup.$(OBJEXT) support.$(OBJEXT)
-libmisc_a_OBJECTS = $(am_libmisc_a_OBJECTS)
-DEFAULT_INCLUDES = -I.@am__isrc@ -I$(top_builddir)
-depcomp = $(SHELL) $(top_srcdir)/depcomp
-am__depfiles_maybe = depfiles
-am__mv = mv -f
-CXXCOMPILE = $(CXX) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) \
-	$(AM_CPPFLAGS) $(CPPFLAGS) $(AM_CXXFLAGS) $(CXXFLAGS)
-CXXLD = $(CXX)
-CXXLINK = $(CXXLD) $(AM_CXXFLAGS) $(CXXFLAGS) $(AM_LDFLAGS) $(LDFLAGS) \
-	-o $@
-SOURCES = $(libmisc_a_SOURCES)
-DIST_SOURCES = $(libmisc_a_SOURCES)
-ETAGS = etags
-CTAGS = ctags
-DISTFILES = $(DIST_COMMON) $(DIST_SOURCES) $(TEXINFOS) $(EXTRA_DIST)
-ACLOCAL = @ACLOCAL@
-ALSA_CFLAGS = @ALSA_CFLAGS@
-ALSA_LIBS = @ALSA_LIBS@
-AMTAR = @AMTAR@
-AUTOCONF = @AUTOCONF@
-AUTOHEADER = @AUTOHEADER@
-AUTOMAKE = @AUTOMAKE@
-AWK = @AWK@
-CC = @CC@
-CCDEPMODE = @CCDEPMODE@
-CFLAGS = @CFLAGS@
-CPP = @CPP@
-CPPFLAGS = @CPPFLAGS@
-CXX = @CXX@
-CXXDEPMODE = @CXXDEPMODE@
-CXXFLAGS = @CXXFLAGS@
-CYGPATH_W = @CYGPATH_W@
-DEFS = @DEFS@
-DEPDIR = @DEPDIR@
-ECHO_C = @ECHO_C@
-ECHO_N = @ECHO_N@
-ECHO_T = @ECHO_T@
-EGREP = @EGREP@
-EXEEXT = @EXEEXT@
-GREP = @GREP@
-INSTALL = @INSTALL@
-INSTALL_DATA = @INSTALL_DATA@
-INSTALL_PROGRAM = @INSTALL_PROGRAM@
-INSTALL_SCRIPT = @INSTALL_SCRIPT@
-INSTALL_STRIP_PROGRAM = @INSTALL_STRIP_PROGRAM@
-LDFLAGS = @LDFLAGS@
-LIBOBJS = @LIBOBJS@
-LIBS = @LIBS@
-LTLIBOBJS = @LTLIBOBJS@
-MAKEINFO = @MAKEINFO@
-MKDIR_P = @MKDIR_P@
-OBJEXT = @OBJEXT@
-PACKAGE = @PACKAGE@
-PACKAGE_BUGREPORT = @PACKAGE_BUGREPORT@
-PACKAGE_NAME = @PACKAGE_NAME@
-PACKAGE_STRING = @PACKAGE_STRING@
-PACKAGE_TARNAME = @PACKAGE_TARNAME@
-PACKAGE_URL = @PACKAGE_URL@
-PACKAGE_VERSION = @PACKAGE_VERSION@
-PATH_SEPARATOR = @PATH_SEPARATOR@
-RANLIB = @RANLIB@
-SDL_CFLAGS = @SDL_CFLAGS@
-SDL_CONFIG = @SDL_CONFIG@
-SDL_LIBS = @SDL_LIBS@
-SET_MAKE = @SET_MAKE@
-SHELL = @SHELL@
-STRIP = @STRIP@
-VERSION = @VERSION@
-WINDRES = @WINDRES@
-abs_builddir = @abs_builddir@
-abs_srcdir = @abs_srcdir@
-abs_top_builddir = @abs_top_builddir@
-abs_top_srcdir = @abs_top_srcdir@
-ac_ct_CC = @ac_ct_CC@
-ac_ct_CXX = @ac_ct_CXX@
-am__include = @am__include@
-am__leading_dot = @am__leading_dot@
-am__quote = @am__quote@
-am__tar = @am__tar@
-am__untar = @am__untar@
-bindir = @bindir@
-build = @build@
-build_alias = @build_alias@
-build_cpu = @build_cpu@
-build_os = @build_os@
-build_vendor = @build_vendor@
-builddir = @builddir@
-datadir = @datadir@
-datarootdir = @datarootdir@
-docdir = @docdir@
-dvidir = @dvidir@
-exec_prefix = @exec_prefix@
-host = @host@
-host_alias = @host_alias@
-host_cpu = @host_cpu@
-host_os = @host_os@
-host_vendor = @host_vendor@
-htmldir = @htmldir@
-includedir = @includedir@
-infodir = @infodir@
-install_sh = @install_sh@
-libdir = @libdir@
-libexecdir = @libexecdir@
-localedir = @localedir@
-localstatedir = @localstatedir@
-mandir = @mandir@
-mkdir_p = @mkdir_p@
-oldincludedir = @oldincludedir@
-pdfdir = @pdfdir@
-prefix = @prefix@
-program_transform_name = @program_transform_name@
-psdir = @psdir@
-sbindir = @sbindir@
-sharedstatedir = @sharedstatedir@
-srcdir = @srcdir@
-sysconfdir = @sysconfdir@
-target_alias = @target_alias@
-top_build_prefix = @top_build_prefix@
-top_builddir = @top_builddir@
-top_srcdir = @top_srcdir@
-AM_CPPFLAGS = -I$(top_srcdir)/include
-noinst_LIBRARIES = libmisc.a
-libmisc_a_SOURCES = cross.cpp messages.cpp programs.cpp setup.cpp support.cpp
-all: all-am
-
-.SUFFIXES:
-.SUFFIXES: .cpp .o .obj
-$(srcdir)/Makefile.in:  $(srcdir)/Makefile.am  $(am__configure_deps)
-	@for dep in $?; do \
-	  case '$(am__configure_deps)' in \
-	    *$$dep*) \
-	      ( cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh ) \
-	        && { if test -f $@; then exit 0; else break; fi; }; \
-	      exit 1;; \
-	  esac; \
-	done; \
-	echo ' cd $(top_srcdir) && $(AUTOMAKE) --gnu src/misc/Makefile'; \
-	$(am__cd) $(top_srcdir) && \
-	  $(AUTOMAKE) --gnu src/misc/Makefile
-.PRECIOUS: Makefile
-Makefile: $(srcdir)/Makefile.in $(top_builddir)/config.status
-	@case '$?' in \
-	  *config.status*) \
-	    cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh;; \
-	  *) \
-	    echo ' cd $(top_builddir) && $(SHELL) ./config.status $(subdir)/$@ $(am__depfiles_maybe)'; \
-	    cd $(top_builddir) && $(SHELL) ./config.status $(subdir)/$@ $(am__depfiles_maybe);; \
-	esac;
-
-$(top_builddir)/config.status: $(top_srcdir)/configure $(CONFIG_STATUS_DEPENDENCIES)
-	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
-
-$(top_srcdir)/configure:  $(am__configure_deps)
-	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
-$(ACLOCAL_M4):  $(am__aclocal_m4_deps)
-	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
-$(am__aclocal_m4_deps):
-
-clean-noinstLIBRARIES:
-	-test -z "$(noinst_LIBRARIES)" || rm -f $(noinst_LIBRARIES)
-libmisc.a: $(libmisc_a_OBJECTS) $(libmisc_a_DEPENDENCIES) 
-	-rm -f libmisc.a
-	$(libmisc_a_AR) libmisc.a $(libmisc_a_OBJECTS) $(libmisc_a_LIBADD)
-	$(RANLIB) libmisc.a
-
-mostlyclean-compile:
-	-rm -f *.$(OBJEXT)
-
-distclean-compile:
-	-rm -f *.tab.c
-
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/cross.Po@am__quote@
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/messages.Po@am__quote@
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/programs.Po@am__quote@
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/setup.Po@am__quote@
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/support.Po@am__quote@
-
-.cpp.o:
-@am__fastdepCXX_TRUE@	$(CXXCOMPILE) -MT $@ -MD -MP -MF $(DEPDIR)/$*.Tpo -c -o $@ $<
-@am__fastdepCXX_TRUE@	$(am__mv) $(DEPDIR)/$*.Tpo $(DEPDIR)/$*.Po
-@AMDEP_TRUE@@am__fastdepCXX_FALSE@	source='$<' object='$@' libtool=no @AMDEPBACKSLASH@
-@AMDEP_TRUE@@am__fastdepCXX_FALSE@	DEPDIR=$(DEPDIR) $(CXXDEPMODE) $(depcomp) @AMDEPBACKSLASH@
-@am__fastdepCXX_FALSE@	$(CXXCOMPILE) -c -o $@ $<
-
-.cpp.obj:
-@am__fastdepCXX_TRUE@	$(CXXCOMPILE) -MT $@ -MD -MP -MF $(DEPDIR)/$*.Tpo -c -o $@ `$(CYGPATH_W) '$<'`
-@am__fastdepCXX_TRUE@	$(am__mv) $(DEPDIR)/$*.Tpo $(DEPDIR)/$*.Po
-@AMDEP_TRUE@@am__fastdepCXX_FALSE@	source='$<' object='$@' libtool=no @AMDEPBACKSLASH@
-@AMDEP_TRUE@@am__fastdepCXX_FALSE@	DEPDIR=$(DEPDIR) $(CXXDEPMODE) $(depcomp) @AMDEPBACKSLASH@
-@am__fastdepCXX_FALSE@	$(CXXCOMPILE) -c -o $@ `$(CYGPATH_W) '$<'`
-
-ID: $(HEADERS) $(SOURCES) $(LISP) $(TAGS_FILES)
-	list='$(SOURCES) $(HEADERS) $(LISP) $(TAGS_FILES)'; \
-	unique=`for i in $$list; do \
-	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
-	  done | \
-	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
-	      END { if (nonempty) { for (i in files) print i; }; }'`; \
-	mkid -fID $$unique
-tags: TAGS
-
-TAGS:  $(HEADERS) $(SOURCES)  $(TAGS_DEPENDENCIES) \
-		$(TAGS_FILES) $(LISP)
-	set x; \
-	here=`pwd`; \
-	list='$(SOURCES) $(HEADERS)  $(LISP) $(TAGS_FILES)'; \
-	unique=`for i in $$list; do \
-	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
-	  done | \
-	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
-	      END { if (nonempty) { for (i in files) print i; }; }'`; \
-	shift; \
-	if test -z "$(ETAGS_ARGS)$$*$$unique"; then :; else \
-	  test -n "$$unique" || unique=$$empty_fix; \
-	  if test $$# -gt 0; then \
-	    $(ETAGS) $(ETAGSFLAGS) $(AM_ETAGSFLAGS) $(ETAGS_ARGS) \
-	      "$$@" $$unique; \
-	  else \
-	    $(ETAGS) $(ETAGSFLAGS) $(AM_ETAGSFLAGS) $(ETAGS_ARGS) \
-	      $$unique; \
-	  fi; \
-	fi
-ctags: CTAGS
-CTAGS:  $(HEADERS) $(SOURCES)  $(TAGS_DEPENDENCIES) \
-		$(TAGS_FILES) $(LISP)
-	list='$(SOURCES) $(HEADERS)  $(LISP) $(TAGS_FILES)'; \
-	unique=`for i in $$list; do \
-	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
-	  done | \
-	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
-	      END { if (nonempty) { for (i in files) print i; }; }'`; \
-	test -z "$(CTAGS_ARGS)$$unique" \
-	  || $(CTAGS) $(CTAGSFLAGS) $(AM_CTAGSFLAGS) $(CTAGS_ARGS) \
-	     $$unique
-
-GTAGS:
-	here=`$(am__cd) $(top_builddir) && pwd` \
-	  && $(am__cd) $(top_srcdir) \
-	  && gtags -i $(GTAGS_ARGS) "$$here"
-
-distclean-tags:
-	-rm -f TAGS ID GTAGS GRTAGS GSYMS GPATH tags
-
-distdir: $(DISTFILES)
-	@srcdirstrip=`echo "$(srcdir)" | sed 's/[].[^$$\\*]/\\\\&/g'`; \
-	topsrcdirstrip=`echo "$(top_srcdir)" | sed 's/[].[^$$\\*]/\\\\&/g'`; \
-	list='$(DISTFILES)'; \
-	  dist_files=`for file in $$list; do echo $$file; done | \
-	  sed -e "s|^$$srcdirstrip/||;t" \
-	      -e "s|^$$topsrcdirstrip/|$(top_builddir)/|;t"`; \
-	case $$dist_files in \
-	  */*) $(MKDIR_P) `echo "$$dist_files" | \
-			   sed '/\//!d;s|^|$(distdir)/|;s,/[^/]*$$,,' | \
-			   sort -u` ;; \
-	esac; \
-	for file in $$dist_files; do \
-	  if test -f $$file || test -d $$file; then d=.; else d=$(srcdir); fi; \
-	  if test -d $$d/$$file; then \
-	    dir=`echo "/$$file" | sed -e 's,/[^/]*$$,,'`; \
-	    if test -d "$(distdir)/$$file"; then \
-	      find "$(distdir)/$$file" -type d ! -perm -700 -exec chmod u+rwx {} \;; \
-	    fi; \
-	    if test -d $(srcdir)/$$file && test $$d != $(srcdir); then \
-	      cp -fpR $(srcdir)/$$file "$(distdir)$$dir" || exit 1; \
-	      find "$(distdir)/$$file" -type d ! -perm -700 -exec chmod u+rwx {} \;; \
-	    fi; \
-	    cp -fpR $$d/$$file "$(distdir)$$dir" || exit 1; \
-	  else \
-	    test -f "$(distdir)/$$file" \
-	    || cp -p $$d/$$file "$(distdir)/$$file" \
-	    || exit 1; \
-	  fi; \
-	done
-check-am: all-am
-check: check-am
-all-am: Makefile $(LIBRARIES)
-installdirs:
-install: install-am
-install-exec: install-exec-am
-install-data: install-data-am
-uninstall: uninstall-am
-
-install-am: all-am
-	@$(MAKE) $(AM_MAKEFLAGS) install-exec-am install-data-am
-
-installcheck: installcheck-am
-install-strip:
-	$(MAKE) $(AM_MAKEFLAGS) INSTALL_PROGRAM="$(INSTALL_STRIP_PROGRAM)" \
-	  install_sh_PROGRAM="$(INSTALL_STRIP_PROGRAM)" INSTALL_STRIP_FLAG=-s \
-	  `test -z '$(STRIP)' || \
-	    echo "INSTALL_PROGRAM_ENV=STRIPPROG='$(STRIP)'"` install
-mostlyclean-generic:
-
-clean-generic:
-
-distclean-generic:
-	-test -z "$(CONFIG_CLEAN_FILES)" || rm -f $(CONFIG_CLEAN_FILES)
-	-test . = "$(srcdir)" || test -z "$(CONFIG_CLEAN_VPATH_FILES)" || rm -f $(CONFIG_CLEAN_VPATH_FILES)
-
-maintainer-clean-generic:
-	@echo "This command is intended for maintainers to use"
-	@echo "it deletes files that may require special tools to rebuild."
-clean: clean-am
-
-clean-am: clean-generic clean-noinstLIBRARIES mostlyclean-am
-
-distclean: distclean-am
-	-rm -rf ./$(DEPDIR)
-	-rm -f Makefile
-distclean-am: clean-am distclean-compile distclean-generic \
-	distclean-tags
-
-dvi: dvi-am
-
-dvi-am:
-
-html: html-am
-
-html-am:
-
-info: info-am
-
-info-am:
-
-install-data-am:
-
-install-dvi: install-dvi-am
-
-install-dvi-am:
-
-install-exec-am:
-
-install-html: install-html-am
-
-install-html-am:
-
-install-info: install-info-am
-
-install-info-am:
-
-install-man:
-
-install-pdf: install-pdf-am
-
-install-pdf-am:
-
-install-ps: install-ps-am
-
-install-ps-am:
-
-installcheck-am:
-
-maintainer-clean: maintainer-clean-am
-	-rm -rf ./$(DEPDIR)
-	-rm -f Makefile
-maintainer-clean-am: distclean-am maintainer-clean-generic
-
-mostlyclean: mostlyclean-am
-
-mostlyclean-am: mostlyclean-compile mostlyclean-generic
-
-pdf: pdf-am
-
-pdf-am:
-
-ps: ps-am
-
-ps-am:
-
-uninstall-am:
-
-.MAKE: install-am install-strip
-
-.PHONY: CTAGS GTAGS all all-am check check-am clean clean-generic \
-	clean-noinstLIBRARIES ctags distclean distclean-compile \
-	distclean-generic distclean-tags distdir dvi dvi-am html \
-	html-am info info-am install install-am install-data \
-	install-data-am install-dvi install-dvi-am install-exec \
-	install-exec-am install-html install-html-am install-info \
-	install-info-am install-man install-pdf install-pdf-am \
-	install-ps install-ps-am install-strip installcheck \
-	installcheck-am installdirs maintainer-clean \
-	maintainer-clean-generic mostlyclean mostlyclean-compile \
-	mostlyclean-generic pdf pdf-am ps ps-am tags uninstall \
-	uninstall-am
-
-
-# Tell versions [3.59,3.63) of GNU make to not export all variables.
-# Otherwise a system limit (for SysV at least) may be exceeded.
-.NOEXPORT:
diff -Nur dosbox-0.74/src/misc/messages.cpp dosbox-0.74.patch/src/misc/messages.cpp
--- dosbox-0.74/src/misc/messages.cpp	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/misc/messages.cpp	2016-12-11 18:35:15.554284005 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: messages.cpp,v 1.23 2009-06-17 08:52:35 qbix79 Exp $ */
 
 #include <stdio.h>
 #include <stdlib.h>
@@ -99,7 +98,7 @@
 			strcpy(name,linein+1);
 		/* End of string marker */
 		} else if (linein[0]=='.') {
-			/* Replace/Add the string to the internal langaugefile */
+			/* Replace/Add the string to the internal languagefile */
 			/* Remove last newline (marker is \n.\n) */
 			size_t ll = strlen(string);
 			if(ll && string[ll - 1] == '\n') string[ll - 1] = 0; //Second if should not be needed, but better be safe.
@@ -124,13 +123,14 @@
 }
 
 
-void MSG_Write(const char * location) {
+bool MSG_Write(const char * location) {
 	FILE* out=fopen(location,"w+t");
-	if(out==NULL) return;//maybe an error?
+	if(out==NULL) return false;//maybe an error?
 	for(itmb tel=Lang.begin();tel!=Lang.end();tel++){
 		fprintf(out,":%s\n%s\n.\n",(*tel).name.c_str(),(*tel).val.c_str());
 	}
 	fclose(out);
+	return true;
 }
 
 void MSG_Init(Section_prop * section) {
diff -Nur dosbox-0.74/src/misc/programs.cpp dosbox-0.74.patch/src/misc/programs.cpp
--- dosbox-0.74/src/misc/programs.cpp	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/misc/programs.cpp	2016-12-11 18:35:15.558284005 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,9 +16,9 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: programs.cpp,v 1.37 2009-05-27 09:15:42 qbix79 Exp $ */
 
 #include <vector>
+#include <sstream>
 #include <ctype.h>
 #include <stdlib.h>
 #include <stdarg.h>
@@ -78,7 +78,7 @@
 	HostPt writer=(HostPt)&index;
 	for (;size>0;size--) *writer++=mem_readb(reader++);
 	Program * new_program;
-	if(index > internal_progs.size()) E_Exit("something is messing with the memory");
+	if (index > internal_progs.size()) E_Exit("something is messing with the memory");
 	PROGRAMS_Main * handler = internal_progs[index];
 	(*handler)(&new_program);
 	new_program->Run();
@@ -120,7 +120,7 @@
 	 * Length of arguments can be ~120. but switch when above 100 to be sure
 	 */
 
-	if(/*control->SecureMode() ||*/ cmd->Get_arglength() > 100) {	
+	if (/*control->SecureMode() ||*/ cmd->Get_arglength() > 100) {	
 		CommandLine* temp = new CommandLine(cmd->GetFileName(),full_arguments.c_str());
 		delete cmd;
 		cmd = temp;
@@ -128,6 +128,7 @@
 	full_arguments.assign(""); //Clear so it gets even more save
 }
 
+static char last_written_character = 0;//For 0xA to OxD 0xA expansion
 void Program::WriteOut(const char * format,...) {
 	char buf[2048];
 	va_list msg;
@@ -139,10 +140,10 @@
 	Bit16u size = (Bit16u)strlen(buf);
 	for(Bit16u i = 0; i < size;i++) {
 		Bit8u out;Bit16u s=1;
-		if(buf[i] == 0xA && i > 0 && buf[i-1] !=0xD) {
+		if (buf[i] == 0xA && last_written_character != 0xD) {
 			out = 0xD;DOS_WriteFile(STDOUT,&out,&s);
 		}
-		out = buf[i];
+		last_written_character = out = buf[i];
 		DOS_WriteFile(STDOUT,&out,&s);
 	}
 	
@@ -154,10 +155,10 @@
 	char const* buf = format;
 	for(Bit16u i = 0; i < size;i++) {
 		Bit8u out;Bit16u s=1;
-		if(buf[i] == 0xA && i > 0 && buf[i-1] !=0xD) {
+		if (buf[i] == 0xA && last_written_character != 0xD) {
 			out = 0xD;DOS_WriteFile(STDOUT,&out,&s);
 		}
-		out = buf[i];
+		last_written_character = out = buf[i];
 		DOS_WriteFile(STDOUT,&out,&s);
 	}
 
@@ -243,149 +244,505 @@
 	return true;
 }
 
+bool MSG_Write(const char *);
+void restart_program(std::vector<std::string> & parameters);
+
 class CONFIG : public Program {
 public:
 	void Run(void);
-};
-
-void MSG_Write(const char *);
-
-void CONFIG::Run(void) {
-	FILE * f;
-	if (cmd->FindString("-writeconf",temp_line,true) 
-			|| cmd->FindString("-wc",temp_line,true)) {
-		/* In secure mode don't allow a new configfile to be created */
-		if(control->SecureMode()) {
-			WriteOut(MSG_Get("PROGRAM_CONFIG_SECURE_DISALLOW"));
-			return;
+private:
+	void restart(const char* useconfig);
+	
+	void writeconf(std::string name, bool configdir) {
+		if (configdir) {
+			// write file to the default config directory
+			std::string config_path;
+			Cross::GetPlatformConfigDir(config_path);
+			name = config_path + name;
 		}
-		f=fopen(temp_line.c_str(),"wb+");
-		if (!f) {
-			WriteOut(MSG_Get("PROGRAM_CONFIG_FILE_ERROR"),temp_line.c_str());
-			return;
+		WriteOut(MSG_Get("PROGRAM_CONFIG_FILE_WHICH"),name.c_str());
+		if (!control->PrintConfig(name.c_str())) {
+			WriteOut(MSG_Get("PROGRAM_CONFIG_FILE_ERROR"),name.c_str());
 		}
-		fclose(f);
-		control->PrintConfig(temp_line.c_str());
 		return;
 	}
-	if (cmd->FindString("-writelang",temp_line,true)
-			||cmd->FindString("-wl",temp_line,true)) {
-		/* In secure mode don't allow a new languagefile to be created
-		 * Who knows which kind of file we would overwriting. */
-		if(control->SecureMode()) {
+	
+	bool securemode_check() {
+		if (control->SecureMode()) {
 			WriteOut(MSG_Get("PROGRAM_CONFIG_SECURE_DISALLOW"));
-			return;
-		}
-		f=fopen(temp_line.c_str(),"wb+");
-		if (!f) {
-			WriteOut(MSG_Get("PROGRAM_CONFIG_FILE_ERROR"),temp_line.c_str());
-			return;
+			return true;
 		}
-		fclose(f);
-		MSG_Write(temp_line.c_str());
-		return;
+		return false;
 	}
+};
 
-	/* Code for switching to secure mode */
-	if(cmd->FindExist("-securemode",true)) {
-		control->SwitchToSecureMode();
-		WriteOut(MSG_Get("PROGRAM_CONFIG_SECURE_ON"));
-		return;
-	}
-   
-	/* Code for getting the current configuration.           *
-	 * Official format: config -get "section property"       *
-	 * As a bonus it will set %CONFIG% to this value as well */
-	if(cmd->FindString("-get",temp_line,true)) {
-		std::string temp2 = "";
-		cmd->GetStringRemain(temp2);//So -get n1 n2= can be used without quotes
-		if(temp2 != "") temp_line = temp_line + " " + temp2;
-
-		std::string::size_type space = temp_line.find(" ");
-		if(space == std::string::npos) {
-			WriteOut(MSG_Get("PROGRAM_CONFIG_GET_SYNTAX"));
+void CONFIG::Run(void) {
+	static const char* const params[] = {
+		"-r", "-wcp", "-wcd", "-wc", "-writeconf", "-l", "-rmconf",
+		"-h", "-help", "-?", "-axclear", "-axadd", "-axtype", "-get", "-set",
+		"-writelang", "-wl", "-securemode", "" };
+	enum prs {
+		P_NOMATCH, P_NOPARAMS, // fixed return values for GetParameterFromList
+		P_RESTART,
+		P_WRITECONF_PORTABLE, P_WRITECONF_DEFAULT, P_WRITECONF, P_WRITECONF2,
+		P_LISTCONF,	P_KILLCONF,
+		P_HELP, P_HELP2, P_HELP3,
+		P_AUTOEXEC_CLEAR, P_AUTOEXEC_ADD, P_AUTOEXEC_TYPE,
+		P_GETPROP, P_SETPROP,
+		P_WRITELANG, P_WRITELANG2,
+		P_SECURE
+	} presult = P_NOMATCH;
+	
+	bool first = true;
+	std::vector<std::string> pvars;
+	// Loop through the passed parameters
+	while(presult != P_NOPARAMS) {
+		presult = (enum prs)cmd->GetParameterFromList(params, pvars);
+		switch(presult) {
+		
+		case P_RESTART:
+			if (securemode_check()) return;
+			if (pvars.size() == 0) restart_program(control->startup_params);
+			else {
+				std::vector<std::string> restart_params;
+				restart_params.push_back(control->cmdline->GetFileName());
+				for(size_t i = 0; i < pvars.size(); i++) {
+					restart_params.push_back(pvars[i]);
+					if (pvars[i].find(' ') != std::string::npos) {
+						pvars[i] = "\""+pvars[i]+"\""; // add back spaces
+					}
+				}
+				// the rest on the commandline, too
+				cmd->FillVector(restart_params);
+				restart_program(restart_params);
+			}
 			return;
+		
+		case P_LISTCONF: {
+			Bitu size = control->configfiles.size();
+			std::string config_path;
+			Cross::GetPlatformConfigDir(config_path);
+			WriteOut(MSG_Get("PROGRAM_CONFIG_CONFDIR"), VERSION,config_path.c_str());
+			if (size==0) WriteOut(MSG_Get("PROGRAM_CONFIG_NOCONFIGFILE"));
+			else {
+				WriteOut(MSG_Get("PROGRAM_CONFIG_PRIMARY_CONF"),control->configfiles.front().c_str());
+				if (size > 1) {
+					WriteOut(MSG_Get("PROGRAM_CONFIG_ADDITIONAL_CONF"));
+					for(Bitu i = 1; i < size; i++)
+						WriteOut("%s\n",control->configfiles[i].c_str());
+				}
+			}
+			if (control->startup_params.size() > 0) {
+				std::string test;
+				for(size_t k = 0; k < control->startup_params.size(); k++)
+					test += control->startup_params[k] + " ";
+				WriteOut(MSG_Get("PROGRAM_CONFIG_PRINT_STARTUP"), test.c_str());
+			}
+			break;
+		}
+		case P_WRITECONF: case P_WRITECONF2:
+			if (securemode_check()) return;
+			if (pvars.size() > 1) return;
+			else if (pvars.size() == 1) {
+				// write config to specific file, except if it is an absolute path
+				writeconf(pvars[0], !Cross::IsPathAbsolute(pvars[0]));
+			} else {
+				// -wc without parameter: write primary config file
+				if (control->configfiles.size()) writeconf(control->configfiles[0], false);
+				else WriteOut(MSG_Get("PROGRAM_CONFIG_NOCONFIGFILE"));
+			}
+			break;
+		case P_WRITECONF_DEFAULT: {
+			// write to /userdir/dosbox0.xx.conf
+			if (securemode_check()) return;
+			if (pvars.size() > 0) return;
+			std::string confname;
+			Cross::GetPlatformConfigName(confname);
+			writeconf(confname, true);
+			break;
 		}
-		//Copy the found property to a new string and erase from templine (mind the space)
-		std::string prop = temp_line.substr(space+1); temp_line.erase(space);
+		case P_WRITECONF_PORTABLE:
+			if (securemode_check()) return;
+			if (pvars.size() > 1) return;
+			else if (pvars.size() == 1) {
+				// write config to startup directory
+				writeconf(pvars[0], false);
+			} else {
+				// -wcp without parameter: write dosbox.conf to startup directory
+				if (control->configfiles.size()) writeconf(std::string("dosbox.conf"), false);
+				else WriteOut(MSG_Get("PROGRAM_CONFIG_NOCONFIGFILE"));
+			}
+			break;
 
-		Section* sec = control->GetSection(temp_line.c_str());
-		if(!sec) {
-			WriteOut(MSG_Get("PROGRAM_CONFIG_SECTION_ERROR"),temp_line.c_str());
+		case P_NOPARAMS:
+			if (!first) break;
+
+		case P_NOMATCH:
+			WriteOut(MSG_Get("PROGRAM_CONFIG_USAGE"));
 			return;
+
+		case P_HELP: case P_HELP2: case P_HELP3: {
+			switch(pvars.size()) {
+			case 0:
+				WriteOut(MSG_Get("PROGRAM_CONFIG_USAGE"));
+				return;
+			case 1: {
+				if (!strcasecmp("sections",pvars[0].c_str())) {
+					// list the sections
+					WriteOut(MSG_Get("PROGRAM_CONFIG_HLP_SECTLIST"));
+					Bitu i = 0;
+					while(true) {
+						Section* sec = control->GetSection(i++);
+						if (!sec) break;
+						WriteOut("%s\n",sec->GetName());
+					}
+					return;
+				}
+				// if it's a section, leave it as one-param
+				Section* sec = control->GetSection(pvars[0].c_str());
+				if (!sec) {
+					// could be a property
+					sec = control->GetSectionFromProperty(pvars[0].c_str());
+					if (!sec) {
+						WriteOut(MSG_Get("PROGRAM_CONFIG_PROPERTY_ERROR"));
+						return;
+					}
+					pvars.insert(pvars.begin(),std::string(sec->GetName()));
+				}
+				break;
+			}
+			case 2: {
+				// sanity check
+				Section* sec = control->GetSection(pvars[0].c_str());
+				Section* sec2 = control->GetSectionFromProperty(pvars[1].c_str());
+				if (sec != sec2) {
+					WriteOut(MSG_Get("PROGRAM_CONFIG_PROPERTY_ERROR"));
+				}
+				break;
+			}
+			default:
+				WriteOut(MSG_Get("PROGRAM_CONFIG_USAGE"));
+				return;
+			}	
+			// if we have one value in pvars, it's a section
+			// two values are section + property
+			Section* sec = control->GetSection(pvars[0].c_str());
+			if (sec==NULL) {
+				WriteOut(MSG_Get("PROGRAM_CONFIG_PROPERTY_ERROR"));
+				return;
+			}
+			Section_prop* psec = dynamic_cast <Section_prop*>(sec);
+			if (psec==NULL) {
+				// failed; maybe it's the autoexec section?
+				Section_line* pline = dynamic_cast <Section_line*>(sec);
+				if (pline==NULL) E_Exit("Section dynamic cast failed.");
+
+				WriteOut(MSG_Get("PROGRAM_CONFIG_HLP_LINEHLP"),
+					pline->GetName(),
+					// this is 'unclean' but the autoexec section has no help associated
+					MSG_Get("AUTOEXEC_CONFIGFILE_HELP"),
+					pline->data.c_str() );
+				return;
+			} 
+			if (pvars.size()==1) {
+				size_t i = 0;
+				WriteOut(MSG_Get("PROGRAM_CONFIG_HLP_SECTHLP"),pvars[0].c_str());
+				while(true) {
+					// list the properties
+					Property* p = psec->Get_prop(i++);
+					if (p==NULL) break;
+					WriteOut("%s\n", p->propname.c_str());
+				}
+			} else {
+				// find the property by it's name
+				size_t i = 0;
+				while (true) {
+					Property *p = psec->Get_prop(i++);
+					if (p==NULL) break;
+					if (!strcasecmp(p->propname.c_str(),pvars[1].c_str())) {
+						// found it; make the list of possible values
+						std::string propvalues;
+						std::vector<Value> pv = p->GetValues();
+						
+						if (p->Get_type()==Value::V_BOOL) {
+							// possible values for boolean are true, false
+							propvalues += "true, false";
+						} else if (p->Get_type()==Value::V_INT) {
+							// print min, max for integer values if used
+							Prop_int* pint = dynamic_cast <Prop_int*>(p);
+							if (pint==NULL) E_Exit("Int property dynamic cast failed.");
+							if (pint->getMin() != pint->getMax()) {
+								std::ostringstream oss;
+								oss << pint->getMin();
+								oss << "..";
+								oss << pint->getMax();
+								propvalues += oss.str();
+							}
+						}
+						for(Bitu k = 0; k < pv.size(); k++) {
+							if (pv[k].ToString() =="%u")
+								propvalues += MSG_Get("PROGRAM_CONFIG_HLP_POSINT");
+							else propvalues += pv[k].ToString();
+							if ((k+1) < pv.size()) propvalues += ", ";
+						}
+
+						WriteOut(MSG_Get("PROGRAM_CONFIG_HLP_PROPHLP"),
+							p->propname.c_str(),
+							sec->GetName(),
+							p->Get_help(),propvalues.c_str(),
+							p->Get_Default_Value().ToString().c_str(),
+							p->GetValue().ToString().c_str());
+						// print 'changability'
+						if (p->getChange()==Property::Changeable::OnlyAtStart) {
+							WriteOut(MSG_Get("PROGRAM_CONFIG_HLP_NOCHANGE"));
+						}
+						return;
+					}
+				}
+				break;
+			}
+			return;
+		}
+		case P_AUTOEXEC_CLEAR: {
+			Section_line* sec = dynamic_cast <Section_line*>
+				(control->GetSection(std::string("autoexec")));
+			sec->data.clear();
+			break;
 		}
-		std::string val = sec->GetPropValue(prop.c_str());
-		if(val == NO_SUCH_PROPERTY) {
-			WriteOut(MSG_Get("PROGRAM_CONFIG_NO_PROPERTY"),prop.c_str(),temp_line.c_str());   
+		case P_AUTOEXEC_ADD: {
+			if (pvars.size() == 0) {
+				WriteOut(MSG_Get("PROGRAM_CONFIG_MISSINGPARAM"));
+				return;
+			}
+			Section_line* sec = dynamic_cast <Section_line*>
+				(control->GetSection(std::string("autoexec")));
+
+			for(Bitu i = 0; i < pvars.size(); i++) sec->HandleInputline(pvars[i]);
+			break;
+		}
+		case P_AUTOEXEC_TYPE: {
+			Section_line* sec = dynamic_cast <Section_line*>
+				(control->GetSection(std::string("autoexec")));
+			WriteOut("\n%s",sec->data.c_str());
+			break;
+		}
+		case P_GETPROP: {
+			// "section property"
+			// "property"
+			// "section"
+			// "section" "property"
+			if (pvars.size()==0) {
+				WriteOut(MSG_Get("PROGRAM_CONFIG_GET_SYNTAX"));
+				return;
+			}
+			std::string::size_type spcpos = pvars[0].find_first_of(' ');
+			// split on the ' '
+			if (spcpos != std::string::npos) {
+				pvars.insert(++pvars.begin(),pvars[0].substr(spcpos+1));
+				pvars[0].erase(spcpos);
+			}
+			switch(pvars.size()) {
+			case 1: {
+				// property/section only
+				// is it a section?
+				Section* sec = control->GetSection(pvars[0].c_str());
+				if (sec) {
+					// list properties in section
+					Bitu i = 0;
+					Section_prop* psec = dynamic_cast <Section_prop*>(sec);
+					if (psec==NULL) {
+						// autoexec section
+						Section_line* pline = dynamic_cast <Section_line*>(sec);
+						if (pline==NULL) E_Exit("Section dynamic cast failed.");
+
+						WriteOut("%s",pline->data.c_str());
+						break;
+					}
+					while(true) {
+						// list the properties
+						Property* p = psec->Get_prop(i++);
+						if (p==NULL) break;
+						WriteOut("%s=%s\n", p->propname.c_str(),
+							p->GetValue().ToString().c_str());
+					}
+				} else {
+					// no: maybe it's a property?
+					sec = control->GetSectionFromProperty(pvars[0].c_str());
+					if (!sec) {
+						WriteOut(MSG_Get("PROGRAM_CONFIG_PROPERTY_ERROR"));
+						return;
+					}
+					// it's a property name
+					std::string val = sec->GetPropValue(pvars[0].c_str());
+					WriteOut("%s",val.c_str());
+					first_shell->SetEnv("CONFIG",val.c_str());
+				}
+				break;
+			}
+			case 2: {
+				// section + property
+				Section* sec = control->GetSection(pvars[0].c_str());
+				if (!sec) {
+					WriteOut(MSG_Get("PROGRAM_CONFIG_SECTION_ERROR"));
+					return;
+				}
+				std::string val = sec->GetPropValue(pvars[1].c_str());
+				if (val == NO_SUCH_PROPERTY) {
+					WriteOut(MSG_Get("PROGRAM_CONFIG_NO_PROPERTY"),
+						pvars[1].c_str(),pvars[0].c_str());   
+					return;
+				}
+				WriteOut("%s",val.c_str());
+				first_shell->SetEnv("CONFIG",val.c_str());
+				break;
+			}
+			default:
+				WriteOut(MSG_Get("PROGRAM_CONFIG_GET_SYNTAX"));
+				return;
+			}
 			return;
 		}
-		WriteOut("%s",val.c_str());
-		first_shell->SetEnv("CONFIG",val.c_str());
-		return;
-	}
+		case P_SETPROP:	{
+			// Code for the configuration changes
+			// Official format: config -set "section property=value"
+			// Accepted: with or without -set, 
+			// "section property value"
+			// "section property=value"
+			// "property" "value"
+			// "section" "property=value"
+			// "section" "property=value" "value" "value" ...
+			// "section" "property" "value" "value" ...
+			// "section property" "value" "value" ...
+			// "property" "value" "value" ...
+			// "property=value" "value" "value" ...
 
+			if (pvars.size()==0) {
+				WriteOut(MSG_Get("PROGRAM_CONFIG_SET_SYNTAX"));
+				return;
+			}
 
+			// add rest of command
+			std::string rest;
+			if (cmd->GetStringRemain(rest)) pvars.push_back(rest);
+
+			// attempt to split off the first word
+			std::string::size_type spcpos = pvars[0].find_first_of(' ');
+			std::string::size_type equpos = pvars[0].find_first_of('=');
+
+			if ((equpos != std::string::npos) && 
+				((spcpos == std::string::npos) || (equpos < spcpos))) {
+				// If we have a '=' possibly before a ' ' split on the =
+				pvars.insert(++pvars.begin(),pvars[0].substr(equpos+1));
+				pvars[0].erase(equpos);
+				// As we had a = the first thing must be a property now
+				Section* sec=control->GetSectionFromProperty(pvars[0].c_str());
+				if (sec) pvars.insert(pvars.begin(),std::string(sec->GetName()));
+				else {
+					WriteOut(MSG_Get("PROGRAM_CONFIG_PROPERTY_ERROR"));
+					return;
+				}
+				// order in the vector should be ok now
+			} else {
+				if ((spcpos != std::string::npos) &&
+					((equpos == std::string::npos) || (spcpos < equpos))) {
+					// ' ' before a possible '=', split on the ' '
+					pvars.insert(++pvars.begin(),pvars[0].substr(spcpos+1));
+					pvars[0].erase(spcpos);
+				}
+				// check if the first parameter is a section or property
+				Section* sec = control->GetSection(pvars[0].c_str());
+				if (!sec) {
+					// not a section: little duplicate from above
+					Section* sec=control->GetSectionFromProperty(pvars[0].c_str());
+					if (sec) pvars.insert(pvars.begin(),std::string(sec->GetName()));
+					else {
+						WriteOut(MSG_Get("PROGRAM_CONFIG_PROPERTY_ERROR"));
+						return;
+					}
+				} else {
+					// first of pvars is most likely a section, but could still be gus
+					// have a look at the second parameter
+					if (pvars.size() < 2) {
+						WriteOut(MSG_Get("PROGRAM_CONFIG_SET_SYNTAX"));
+						return;
+					}
+					std::string::size_type spcpos2 = pvars[1].find_first_of(' ');
+					std::string::size_type equpos2 = pvars[1].find_first_of('=');
+					if ((equpos2 != std::string::npos) && 
+						((spcpos2 == std::string::npos) || (equpos2 < spcpos2))) {
+						// split on the =
+						pvars.insert(pvars.begin()+2,pvars[1].substr(equpos2+1));
+						pvars[1].erase(equpos2);
+					} else if ((spcpos2 != std::string::npos) &&
+						((equpos2 == std::string::npos) || (spcpos2 < equpos2))) {
+						// split on the ' '
+						pvars.insert(pvars.begin()+2,pvars[1].substr(spcpos2+1));
+						pvars[1].erase(spcpos2);
+					}
+					// is this a property?
+					Section* sec2 = control->GetSectionFromProperty(pvars[1].c_str());
+					if (!sec2) {
+						// not a property, 
+						Section* sec3 = control->GetSectionFromProperty(pvars[0].c_str());
+						if (sec3) {
+							// section and property name are identical
+							pvars.insert(pvars.begin(),pvars[0]);
+						} // else has been checked above already
+					}
+				}
+			}
+			if(pvars.size() < 3) {
+				WriteOut(MSG_Get("PROGRAM_CONFIG_SET_SYNTAX"));
+				return;
+			}
+			// check if the property actually exists in the section
+			Section* sec2 = control->GetSectionFromProperty(pvars[1].c_str());
+			if (!sec2) {
+				WriteOut(MSG_Get("PROGRAM_CONFIG_NO_PROPERTY"),
+					pvars[1].c_str(),pvars[0].c_str());
+				return;
+			}
+			// Input has been parsed (pvar[0]=section, [1]=property, [2]=value)
+			// now execute
+			Section* tsec = control->GetSection(pvars[0]);
+			std::string value;
+			value += pvars[2];
+			for(Bitu i = 3; i < pvars.size(); i++) value += (std::string(" ") + pvars[i]);
+			std::string inputline = pvars[1] + "=" + value;
+			
+			tsec->ExecuteDestroy(false);
+			bool change_success = tsec->HandleInputline(inputline.c_str());
+			if (!change_success) WriteOut(MSG_Get("PROGRAM_CONFIG_VALUE_ERROR"),
+				value.c_str(),pvars[1].c_str());
+			tsec->ExecuteInit(false);
+			return;
+		}
+		case P_WRITELANG: case P_WRITELANG2:
+			// In secure mode don't allow a new languagefile to be created
+			// Who knows which kind of file we would overwrite.
+			if (securemode_check()) return;
+			if (pvars.size() < 1) {
+				WriteOut(MSG_Get("PROGRAM_CONFIG_MISSINGPARAM"));
+				return;
+			}
+			if (!MSG_Write(pvars[0].c_str())) {
+				WriteOut(MSG_Get("PROGRAM_CONFIG_FILE_ERROR"),pvars[0].c_str());
+				return;
+			}
+			break;
 
-	/* Code for the configuration changes                                  *
-	 * Official format: config -set "section property=value"               *
-	 * Accepted: without quotes and/or without -set and/or without section *
-	 *           and/or the "=" replaced by a " "                          */
-
-	if (cmd->FindString("-set",temp_line,true)) { //get all arguments
-		std::string temp2 = "";
-		cmd->GetStringRemain(temp2);//So -set n1 n2=n3 can be used without quotes
-		if(temp2!="") temp_line = temp_line + " " + temp2;
-	} else 	if(!cmd->GetStringRemain(temp_line)) {//no set 
-			WriteOut(MSG_Get("PROGRAM_CONFIG_USAGE")); //and no arguments specified
+		case P_SECURE:
+			// Code for switching to secure mode
+			control->SwitchToSecureMode();
+			WriteOut(MSG_Get("PROGRAM_CONFIG_SECURE_ON"));
 			return;
-	};
-	//Wanted input: n1 n2=n3
-	char copy[1024];
-	strcpy(copy,temp_line.c_str());
-	//seperate section from property
-	const char* temp = strchr(copy,' ');
-	if((temp && *temp) || (temp=strchr(copy,'=')) ) copy[temp++ - copy]= 0;
-	else {
-		WriteOut(MSG_Get("PROGRAM_CONFIG_USAGE"));
-		return;
-	}
-	//if n1 n2 n3 then replace last space with =
-	const char* sign = strchr(temp,'=');
-	if(!sign) {
-		sign = strchr(temp,' ');
-		if(sign) {
-			copy[sign - copy] = '=';
-		} else {
-			//2 items specified (no space nor = between n2 and n3
-			//assume that they posted: property value
-			//Try to determine the section.
-			Section* sec=control->GetSectionFromProperty(copy);
-			if(!sec){
-				if(control->GetSectionFromProperty(temp)) return; //Weird situation:ignore
-				WriteOut(MSG_Get("PROGRAM_CONFIG_PROPERTY_ERROR"),copy);
-				return;
-			} //Hack to allow config ems true
-			char buffer[1024];strcpy(buffer,copy);strcat(buffer,"=");strcat(buffer,temp);
-			sign = strchr(buffer,' '); 
-			if(sign) buffer[sign - buffer] = '=';
-			strcpy(copy,sec->GetName());
-			temp = buffer;
+
+		default:
+			E_Exit("bug");
+			break;
 		}
+		first = false;
 	}
-	
-	/* Input processed. Now the real job starts
-	 * copy contains the likely "sectionname" 
-	 * temp contains "property=value" 
-	 * the section is destroyed and a new input line is given to
-	 * the configuration parser. Then the section is restarted.
-	 */
-	char* inputline = const_cast<char*>(temp);
-	Section* sec = 0;
-	sec = control->GetSection(copy);
-	if(!sec) { WriteOut(MSG_Get("PROGRAM_CONFIG_SECTION_ERROR"),copy);return;}
-	sec->ExecuteDestroy(false);
-	sec->HandleInputline(inputline);
-	sec->ExecuteInit(false);
 	return;
 }
 
@@ -401,12 +758,49 @@
 	CALLBACK_Setup(call_program,&PROGRAMS_Handler,CB_RETF,"internal program");
 	PROGRAMS_MakeFile("CONFIG.COM",CONFIG_ProgramStart);
 
-	MSG_Add("PROGRAM_CONFIG_FILE_ERROR","Can't open file %s\n");
-	MSG_Add("PROGRAM_CONFIG_USAGE","Config tool:\nUse -writeconf filename to write the current config.\nUse -writelang filename to write the current language strings.\n");
+	// listconf
+	MSG_Add("PROGRAM_CONFIG_NOCONFIGFILE","No config file loaded!\n");
+	MSG_Add("PROGRAM_CONFIG_PRIMARY_CONF","Primary config file: \n%s\n");
+	MSG_Add("PROGRAM_CONFIG_ADDITIONAL_CONF","Additional config files:\n");
+	MSG_Add("PROGRAM_CONFIG_CONFDIR","DOSBox %s configuration directory: \n%s\n\n");
+	
+	// writeconf
+	MSG_Add("PROGRAM_CONFIG_FILE_ERROR","\nCan't open file %s\n");
+	MSG_Add("PROGRAM_CONFIG_FILE_WHICH","Writing config file %s");
+	
+	// help
+	MSG_Add("PROGRAM_CONFIG_USAGE","Config tool:\n"\
+		"-writeconf or -wc without parameter: write to primary loaded config file.\n"\
+		"-writeconf or -wc with filename: write file to config directory.\n"\
+		"Use -writelang or -wl filename to write the current language strings.\n"\
+		"-r [parameters]\n Restart DOSBox, either using the previous parameters or any that are appended.\n"\
+		"-wcp [filename]\n Write config file to the program directory, dosbox.conf or the specified \n filename.\n"\
+		"-wcd\n Write to the default config file in the config directory.\n"\
+		"-l lists configuration parameters.\n"\
+		"-h, -help, -? sections / sectionname / propertyname\n"\
+		" Without parameters, displays this help screen. Add \"sections\" for a list of\n sections."\
+		" For info about a specific section or property add its name behind.\n"\
+		"-axclear clears the autoexec section.\n"\
+		"-axadd [line] adds a line to the autoexec section.\n"\
+		"-axtype prints the content of the autoexec section.\n"\
+		"-securemode switches to secure mode.\n"\
+		"-get \"section property\" returns the value of the property.\n"\
+		"-set \"section property=value\" sets the value." );
+	MSG_Add("PROGRAM_CONFIG_HLP_PROPHLP","Purpose of property \"%s\" (contained in section \"%s\"):\n%s\n\nPossible Values: %s\nDefault value: %s\nCurrent value: %s\n");
+	MSG_Add("PROGRAM_CONFIG_HLP_LINEHLP","Purpose of section \"%s\":\n%s\nCurrent value:\n%s\n");
+	MSG_Add("PROGRAM_CONFIG_HLP_NOCHANGE","This property cannot be changed at runtime.\n");
+	MSG_Add("PROGRAM_CONFIG_HLP_POSINT","positive integer"); 
+	MSG_Add("PROGRAM_CONFIG_HLP_SECTHLP","Section %s contains the following properties:\n");				
+	MSG_Add("PROGRAM_CONFIG_HLP_SECTLIST","DOSBox configuration contains the following sections:\n\n");
+
 	MSG_Add("PROGRAM_CONFIG_SECURE_ON","Switched to secure mode.\n");
 	MSG_Add("PROGRAM_CONFIG_SECURE_DISALLOW","This operation is not permitted in secure mode.\n");
 	MSG_Add("PROGRAM_CONFIG_SECTION_ERROR","Section %s doesn't exist.\n");
+	MSG_Add("PROGRAM_CONFIG_VALUE_ERROR","\"%s\" is not a valid value for property %s.\n");
 	MSG_Add("PROGRAM_CONFIG_PROPERTY_ERROR","No such section or property.\n");
 	MSG_Add("PROGRAM_CONFIG_NO_PROPERTY","There is no property %s in section %s.\n");
+	MSG_Add("PROGRAM_CONFIG_SET_SYNTAX","Correct syntax: config -set \"section property\".\n");
 	MSG_Add("PROGRAM_CONFIG_GET_SYNTAX","Correct syntax: config -get \"section property\".\n");
+	MSG_Add("PROGRAM_CONFIG_PRINT_STARTUP","\nDOSBox was started with the following command line parameters:\n%s");
+	MSG_Add("PROGRAM_CONFIG_MISSINGPARAM","Missing parameter.");
 }
diff -Nur dosbox-0.74/src/misc/setup.cpp dosbox-0.74.patch/src/misc/setup.cpp
--- dosbox-0.74/src/misc/setup.cpp	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/misc/setup.cpp	2016-12-11 18:35:15.558284005 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: setup.cpp,v 1.56 2009-05-27 09:15:42 qbix79 Exp $ */
 
 #include "dosbox.h"
 #include "cross.h"
@@ -29,6 +28,8 @@
 #include <list>
 #include <stdlib.h>
 #include <stdio.h>
+#include <limits>
+#include <limits.h>
 
 using namespace std;
 static std::string current_config_dir; // Set by parseconfigfile so Prop_path can use it to construct the realpath
@@ -104,7 +105,7 @@
 	}
 	return false;
 }
-void Value::SetValue(string const& in,Etype _type) throw(WrongType) {
+bool Value::SetValue(string const& in,Etype _type) throw(WrongType) {
 	/* Throw exception if the current type isn't the wanted type 
 	 * Unless the wanted type is current.
 	 */
@@ -113,21 +114,22 @@
 		if(type != V_NONE && type != _type) throw WrongType();
 		type = _type;
 	}
+	bool retval = true;
 	switch(type){
 		case V_HEX:
-			set_hex(in);
+			retval = set_hex(in);
 			break;
 		case V_INT:
-			set_int(in);
+			retval = set_int(in);
 			break;
 		case V_BOOL:
-			set_bool(in);
+			retval = set_bool(in);
 			break;
 		case V_STRING:
 			set_string(in);
 			break;
 		case V_DOUBLE:
-			set_double(in);
+			retval = set_double(in);
 			break;
 
 		case V_NONE:
@@ -137,39 +139,51 @@
 			throw WrongType();
 			break;
 	}
+	return retval;
 }
 
-void Value::set_hex(std::string const& in) {
+bool Value::set_hex(std::string const& in) {
 	istringstream input(in);
 	input.flags(ios::hex);
-	int result = 0;
+	Bits result = INT_MIN;
 	input >> result;
+	if(result == INT_MIN) return false;
 	_hex = result;
+	return true;
 }
 
-void Value::set_int(string const &in) {
+bool Value::set_int(string const &in) {
 	istringstream input(in);
-	int result = 0;
+	Bits result = INT_MIN;
 	input >> result;
+	if(result == INT_MIN) return false;
 	_int = result;
+	return true;
 }
-void Value::set_double(string const &in) {
+bool Value::set_double(string const &in) {
 	istringstream input(in);
-	double result = 0;
+	double result = std::numeric_limits<double>::infinity();
 	input >> result;
+	if(result == std::numeric_limits<double>::infinity()) return false;
 	_double = result;
+	return true;
 }
 
-void Value::set_bool(string const &in) {
+bool Value::set_bool(string const &in) {
 	istringstream input(in);
 	string result;
 	input >> result;
-	_bool = true;
 	lowcase(result);
-	/* valid false entries: 0 ,d*, f*, off  everything else gets true */
-	if( !result.size() ) return;
-	if(result[0] == '0' || result[0] == 'd' || result[0] == 'f' || result == "off") 
+	_bool = true; // TODO
+	if(!result.size()) return false;
+	
+	if(result=="0" || result=="disabled" || result=="false" || result=="off") {
 		_bool = false;
+	} else if(result=="1" || result=="enabled" || result=="true" || result=="on") {
+		_bool = true;
+	} else return false;
+	
+	return true;
 }
 
 void Value::set_string(string const & in) {
@@ -242,27 +256,30 @@
 	return false;
 }
 
-void Prop_double::SetValue(std::string const& input){
-	Value val(input,Value::V_DOUBLE);
-	SetVal(val,false,true);
+bool Prop_double::SetValue(std::string const& input){
+	Value val;
+	if(!val.SetValue(input,Value::V_DOUBLE)) return false;
+	return SetVal(val,false,true);
 }
 
 //void Property::SetValue(char* input){ 
 //	value.SetValue(input, Value::V_CURRENT);
 //}
-void Prop_int::SetValue(std::string const& input){;
-	Value val(input,Value::V_INT);
-	SetVal(val,false,true);
+bool Prop_int::SetValue(std::string const& input){;
+	Value val;
+	if(!val.SetValue(input,Value::V_INT)) return false;
+	bool retval = SetVal(val,false,true);
+	return retval;
 }
 
-void Prop_string::SetValue(std::string const& input){
+bool Prop_string::SetValue(std::string const& input){
 	//Special version for lowcase stuff
 	std::string temp(input);
 	//suggested values always case insensitive. 
 	//If there are none then it can be paths and such which are case sensitive
 	if(!suggested_values.empty()) lowcase(temp);
 	Value val(temp,Value::V_STRING);
-	SetVal(val,false,true);
+	return SetVal(val,false,true);
 }
 bool Prop_string::CheckValue(Value const& in, bool warn){
 	if(suggested_values.empty()) return true;
@@ -271,25 +288,25 @@
 			return true;
 		}
 		if((*it).ToString() == "%u") {
-			Bitu value;
+			Bit32u value;
 			if(sscanf(in.ToString().c_str(),"%u",&value) == 1) {
 				return true;
 			}
 		}
 	}
-	if(warn) LOG_MSG("\"%s\" is not a valid value for variable: %s.\nIt might now be reset it to default value: %s",in.ToString().c_str(),propname.c_str(),default_value.ToString().c_str());
+	if(warn) LOG_MSG("\"%s\" is not a valid value for variable: %s.\nIt might now be reset to the default value: %s",in.ToString().c_str(),propname.c_str(),default_value.ToString().c_str());
 	return false;
 }
 
-void Prop_path::SetValue(std::string const& input){
+bool Prop_path::SetValue(std::string const& input){
 	//Special version to merge realpath with it
 
 	Value val(input,Value::V_STRING);
-	SetVal(val,false,true);
+	bool retval = SetVal(val,false,true);
 
 	if(input.empty()) {
 		realpath = "";
-		return;
+		return false;
 	}
 	std::string workcopy(input);
 	Cross::ResolveHomedir(workcopy); //Parse ~ and friends
@@ -297,20 +314,18 @@
 	if( current_config_dir.empty()) realpath = workcopy;
 	else realpath = current_config_dir + CROSS_FILESPLIT + workcopy;
 	//Absolute paths
-#if defined (WIN32) || defined(OS2)
-	if( workcopy.size() > 2 && workcopy[1] == ':' ) realpath = workcopy;
-#else
-	if( workcopy.size() > 1 && workcopy[0] == '/' ) realpath = workcopy;
-#endif
+	if (Cross::IsPathAbsolute(workcopy)) realpath = workcopy;
+	return retval;
 }
 	
-void Prop_bool::SetValue(std::string const& input){
-	value.SetValue(input,Value::V_BOOL);
+bool Prop_bool::SetValue(std::string const& input){
+	return value.SetValue(input,Value::V_BOOL);
 }
 
-void Prop_hex::SetValue(std::string const& input){
-	Value val(input,Value::V_HEX);
-	SetVal(val,false,true);
+bool Prop_hex::SetValue(std::string const& input){
+	Value val;
+	val.SetValue(input,Value::V_HEX);
+	return SetVal(val,false,true);
 }
 
 void Prop_multival::make_default_value(){
@@ -331,15 +346,15 @@
    
 
 //TODO checkvalue stuff
-void Prop_multival_remain::SetValue(std::string const& input) {
+bool Prop_multival_remain::SetValue(std::string const& input) {
 	Value val(input,Value::V_STRING);
-	SetVal(val,false,true);
+	bool retval = SetVal(val,false,true);
 
 	std::string local(input);
 	int i = 0,number_of_properties = 0;
 	Property *p = section->Get_prop(0);
 	//No properties in this section. do nothing
-	if(!p) return;
+	if(!p) return false;
 	
 	while( (section->Get_prop(number_of_properties)) )
 		number_of_properties++;
@@ -364,22 +379,23 @@
 		Value valtest (in,p->Get_type());
 		if(!p->CheckValue(valtest,true)) {
 			make_default_value();
-			return;
+			return false;
 		}
 		p->SetValue(in);
 	}
+	return retval;
 }
 
 //TODO checkvalue stuff
-void Prop_multival::SetValue(std::string const& input) {
+bool Prop_multival::SetValue(std::string const& input) {
 	Value val(input,Value::V_STRING);
-	SetVal(val,false,true);
+	bool retval = SetVal(val,false,true);
 
 	std::string local(input);
 	int i = 0;
 	Property *p = section->Get_prop(0);
 	//No properties in this section. do nothing
-	if(!p) return;
+	if(!p) return false;
 	string::size_type loc = string::npos;
 	while( (p = section->Get_prop(i++)) ) {
 		//trim leading seperators
@@ -398,11 +414,12 @@
 		Value valtest (in,p->Get_type());
 		if(!p->CheckValue(valtest,true)) {
 			make_default_value();
-			return;
+			return false;
 		}
 		p->SetValue(in);
 
 	}
+	return retval;
 }
 
 const std::vector<Value>& Property::GetValues() const {
@@ -563,20 +580,20 @@
 }
 
 //TODO double c_str
-void Section_prop::HandleInputline(string const& gegevens){
+bool Section_prop::HandleInputline(string const& gegevens){
 	string str1 = gegevens;
 	string::size_type loc = str1.find('=');
-	if(loc == string::npos) return;
+	if(loc == string::npos) return false;
 	string name = str1.substr(0,loc);
 	string val = str1.substr(loc + 1);
 	/* trim the results incase there were spaces somewhere */
 	trim(name);trim(val);
 	for(it tel=properties.begin();tel!=properties.end();tel++){
 		if(!strcasecmp((*tel)->propname.c_str(),name.c_str())){
-			(*tel)->SetValue(val);
-			return;
+			return (*tel)->SetValue(val);
 		}
 	}
+	return false;
 }
 
 void Section_prop::PrintData(FILE* outfile) const {
@@ -596,9 +613,10 @@
 	return NO_SUCH_PROPERTY;
 }
 
-void Section_line::HandleInputline(string const& line){ 
+bool Section_line::HandleInputline(string const& line){ 
 	data+=line;
 	data+="\n";
+	return true;
 }
 
 void Section_line::PrintData(FILE* outfile) const {
@@ -633,7 +651,7 @@
 			}
 			i=0;
 			char prefix[80];
-			snprintf(prefix,80, "\n# %*s  ", maxwidth, "");
+			snprintf(prefix,80, "\n# %*s  ", (int)maxwidth, "");
 			while ((p = sec->Get_prop(i++))) {		
 				std::string help = p->Get_help();
 				std::string::size_type pos = std::string::npos;
@@ -641,7 +659,7 @@
 					help.replace(pos, 1, prefix);
 				}
 		     
-				fprintf(outfile, "# %*s: %s", maxwidth, p->propname.c_str(), help.c_str());
+				fprintf(outfile, "# %*s: %s", (int)maxwidth, p->propname.c_str(), help.c_str());
 
 				std::vector<Value> values = p->GetValues();
 				if (!values.empty()) {
@@ -770,11 +788,13 @@
 
 
 bool Config::ParseConfigFile(char const * const configfilename){
-	static bool first_configfile = true;
+	//static bool first_configfile = true;
 	ifstream in(configfilename);
 	if (!in) return false;
-	const char * settings_type = first_configfile?"primary":"additional";
-	first_configfile = false;
+	const char * settings_type;
+	settings_type = (configfiles.size() == 0)? "primary":"additional";
+	configfiles.push_back(configfilename);
+	
 	LOG_MSG("CONFIG:Loading %s settings from config file %s", settings_type,configfilename);
 
 	//Get directory from configfilename, used with relative paths.
@@ -824,6 +844,10 @@
 	return true;
 }
 
+/*const char* Config::GetPrimaryConfigFile() {
+	return configfile.c_str();
+}*/
+
 void Config::ParseEnv(char ** envp) {
 	for(char** env=envp; *env;env++) {
 		char copy[1024];
@@ -850,6 +874,7 @@
 
 
 void Config::StartUp(void) {
+	initialised=true;
 	(*_start_function)();
 }
 
@@ -930,6 +955,39 @@
 	return true;
 }
 
+/* Only used for parsing command.com /C 
+ * Allowing /C dir and /Cdir
+ * Restoring quotes back into the commands so command /C mount d "/tmp/a b" works as intended
+ */
+bool CommandLine::FindStringRemainBegin(char const * const name,std::string & value) {
+	cmd_it it;value="";
+	if (!FindEntry(name,it)) {
+		size_t len = strlen(name);
+			for (it=cmds.begin();it!=cmds.end();it++) {
+				if (strncasecmp(name,(*it).c_str(),len)==0) {
+					std::string temp = ((*it).c_str() + len);
+					//Restore quotes for correct parsing in later stages
+					if(temp.find(" ") != std::string::npos)
+						value = std::string("\"") + temp + std::string("\"");
+					else
+						value = temp;
+					break;
+				}
+			}
+		if( it == cmds.end()) return false;
+	}
+	it++;
+	for (;it!=cmds.end();it++) {
+		value += " ";
+		std::string temp = (*it);
+		if(temp.find(" ") != std::string::npos)
+			value += std::string("\"") + temp + std::string("\"");
+		else
+			value += temp;
+	}
+	return true;
+}
+
 bool CommandLine::GetStringRemain(std::string & value) {
 	if(!cmds.size()) return false;
 		
@@ -946,6 +1004,90 @@
 	return (unsigned int)cmds.size();
 }
 
+void CommandLine::FillVector(std::vector<std::string> & vector) {
+	for(cmd_it it=cmds.begin(); it != cmds.end(); it++) {
+		vector.push_back((*it));
+	}
+	// add back the \" if the parameter contained a space
+	for(Bitu i = 0; i < vector.size(); i++) {
+		if(vector[i].find(' ') != std::string::npos) {
+			vector[i] = "\""+vector[i]+"\"";
+		}
+	}
+}
+
+int CommandLine::GetParameterFromList(const char* const params[], std::vector<std::string> & output) {
+	// return values: 0 = P_NOMATCH, 1 = P_NOPARAMS
+	// TODO return nomoreparams
+	int retval = 1;
+	output.clear();
+	enum {
+		P_START, P_FIRSTNOMATCH, P_FIRSTMATCH
+	} parsestate = P_START;
+	cmd_it it = cmds.begin();
+	while(it!=cmds.end()) {
+		bool found = false;
+		for(Bitu i = 0; *params[i]!=0; i++) {
+			if (!strcasecmp((*it).c_str(),params[i])) {
+				// found a parameter
+				found = true;
+				switch(parsestate) {
+				case P_START:
+					retval = i+2;
+					parsestate = P_FIRSTMATCH;
+					break;
+				case P_FIRSTMATCH:
+				case P_FIRSTNOMATCH:
+					return retval;
+				}
+			}
+		}
+		if(!found) 
+			switch(parsestate) {
+			case P_START:
+				retval = 0; // no match
+				parsestate = P_FIRSTNOMATCH;
+				output.push_back(*it);
+				break;
+			case P_FIRSTMATCH:
+			case P_FIRSTNOMATCH:
+				output.push_back(*it);
+				break;
+			}
+		cmd_it itold = it;
+		it++;
+		cmds.erase(itold);
+
+	}
+	
+	return retval;
+/*
+bool CommandLine::FindEntry(char const * const name,cmd_it & it,bool neednext) {
+	for (it=cmds.begin();it!=cmds.end();it++) {
+		if (!strcasecmp((*it).c_str(),name)) {
+			cmd_it itnext=it;itnext++;
+			if (neednext && (itnext==cmds.end())) return false;
+			return true;
+		}
+	}
+	return false;
+*/
+
+
+/*
+	cmd_it it=cmds.begin();value=(*it++);
+	while(it != cmds.end()) {
+		if(params.
+
+		it++;
+	}
+*/
+	// find next parameter
+	//return -1;
+
+}
+
+
 CommandLine::CommandLine(int argc,char const * const argv[]) {
 	if (argc>0) {
 		file_name=argv[0];
diff -Nur dosbox-0.74/src/misc/support.cpp dosbox-0.74.patch/src/misc/support.cpp
--- dosbox-0.74/src/misc/support.cpp	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/misc/support.cpp	2016-12-11 18:35:15.558284005 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: support.cpp,v 1.37 2009-05-27 09:15:42 qbix79 Exp $ */
 
 #include <string.h>
 #include <stdlib.h>
diff -Nur dosbox-0.74/src/platform/Makefile.in dosbox-0.74.patch/src/platform/Makefile.in
--- dosbox-0.74/src/platform/Makefile.in	2010-05-12 11:57:44.000000000 +0200
+++ dosbox-0.74.patch/src/platform/Makefile.in	1970-01-01 01:00:00.000000000 +0100
@@ -1,539 +0,0 @@
-# Makefile.in generated by automake 1.11.1 from Makefile.am.
-# @configure_input@
-
-# Copyright (C) 1994, 1995, 1996, 1997, 1998, 1999, 2000, 2001, 2002,
-# 2003, 2004, 2005, 2006, 2007, 2008, 2009  Free Software Foundation,
-# Inc.
-# This Makefile.in is free software; the Free Software Foundation
-# gives unlimited permission to copy and/or distribute it,
-# with or without modifications, as long as this notice is preserved.
-
-# This program is distributed in the hope that it will be useful,
-# but WITHOUT ANY WARRANTY, to the extent permitted by law; without
-# even the implied warranty of MERCHANTABILITY or FITNESS FOR A
-# PARTICULAR PURPOSE.
-
-@SET_MAKE@
-VPATH = @srcdir@
-pkgdatadir = $(datadir)/@PACKAGE@
-pkgincludedir = $(includedir)/@PACKAGE@
-pkglibdir = $(libdir)/@PACKAGE@
-pkglibexecdir = $(libexecdir)/@PACKAGE@
-am__cd = CDPATH="$${ZSH_VERSION+.}$(PATH_SEPARATOR)" && cd
-install_sh_DATA = $(install_sh) -c -m 644
-install_sh_PROGRAM = $(install_sh) -c
-install_sh_SCRIPT = $(install_sh) -c
-INSTALL_HEADER = $(INSTALL_DATA)
-transform = $(program_transform_name)
-NORMAL_INSTALL = :
-PRE_INSTALL = :
-POST_INSTALL = :
-NORMAL_UNINSTALL = :
-PRE_UNINSTALL = :
-POST_UNINSTALL = :
-build_triplet = @build@
-host_triplet = @host@
-subdir = src/platform
-DIST_COMMON = $(srcdir)/Makefile.am $(srcdir)/Makefile.in
-ACLOCAL_M4 = $(top_srcdir)/aclocal.m4
-am__aclocal_m4_deps = $(top_srcdir)/acinclude.m4 \
-	$(top_srcdir)/configure.in
-am__configure_deps = $(am__aclocal_m4_deps) $(CONFIGURE_DEPENDENCIES) \
-	$(ACLOCAL_M4)
-mkinstalldirs = $(install_sh) -d
-CONFIG_HEADER = $(top_builddir)/config.h
-CONFIG_CLEAN_FILES =
-CONFIG_CLEAN_VPATH_FILES =
-SOURCES =
-DIST_SOURCES =
-RECURSIVE_TARGETS = all-recursive check-recursive dvi-recursive \
-	html-recursive info-recursive install-data-recursive \
-	install-dvi-recursive install-exec-recursive \
-	install-html-recursive install-info-recursive \
-	install-pdf-recursive install-ps-recursive install-recursive \
-	installcheck-recursive installdirs-recursive pdf-recursive \
-	ps-recursive uninstall-recursive
-RECURSIVE_CLEAN_TARGETS = mostlyclean-recursive clean-recursive	\
-  distclean-recursive maintainer-clean-recursive
-AM_RECURSIVE_TARGETS = $(RECURSIVE_TARGETS:-recursive=) \
-	$(RECURSIVE_CLEAN_TARGETS:-recursive=) tags TAGS ctags CTAGS \
-	distdir
-ETAGS = etags
-CTAGS = ctags
-DIST_SUBDIRS = $(SUBDIRS)
-DISTFILES = $(DIST_COMMON) $(DIST_SOURCES) $(TEXINFOS) $(EXTRA_DIST)
-am__relativize = \
-  dir0=`pwd`; \
-  sed_first='s,^\([^/]*\)/.*$$,\1,'; \
-  sed_rest='s,^[^/]*/*,,'; \
-  sed_last='s,^.*/\([^/]*\)$$,\1,'; \
-  sed_butlast='s,/*[^/]*$$,,'; \
-  while test -n "$$dir1"; do \
-    first=`echo "$$dir1" | sed -e "$$sed_first"`; \
-    if test "$$first" != "."; then \
-      if test "$$first" = ".."; then \
-        dir2=`echo "$$dir0" | sed -e "$$sed_last"`/"$$dir2"; \
-        dir0=`echo "$$dir0" | sed -e "$$sed_butlast"`; \
-      else \
-        first2=`echo "$$dir2" | sed -e "$$sed_first"`; \
-        if test "$$first2" = "$$first"; then \
-          dir2=`echo "$$dir2" | sed -e "$$sed_rest"`; \
-        else \
-          dir2="../$$dir2"; \
-        fi; \
-        dir0="$$dir0"/"$$first"; \
-      fi; \
-    fi; \
-    dir1=`echo "$$dir1" | sed -e "$$sed_rest"`; \
-  done; \
-  reldir="$$dir2"
-ACLOCAL = @ACLOCAL@
-ALSA_CFLAGS = @ALSA_CFLAGS@
-ALSA_LIBS = @ALSA_LIBS@
-AMTAR = @AMTAR@
-AUTOCONF = @AUTOCONF@
-AUTOHEADER = @AUTOHEADER@
-AUTOMAKE = @AUTOMAKE@
-AWK = @AWK@
-CC = @CC@
-CCDEPMODE = @CCDEPMODE@
-CFLAGS = @CFLAGS@
-CPP = @CPP@
-CPPFLAGS = @CPPFLAGS@
-CXX = @CXX@
-CXXDEPMODE = @CXXDEPMODE@
-CXXFLAGS = @CXXFLAGS@
-CYGPATH_W = @CYGPATH_W@
-DEFS = @DEFS@
-DEPDIR = @DEPDIR@
-ECHO_C = @ECHO_C@
-ECHO_N = @ECHO_N@
-ECHO_T = @ECHO_T@
-EGREP = @EGREP@
-EXEEXT = @EXEEXT@
-GREP = @GREP@
-INSTALL = @INSTALL@
-INSTALL_DATA = @INSTALL_DATA@
-INSTALL_PROGRAM = @INSTALL_PROGRAM@
-INSTALL_SCRIPT = @INSTALL_SCRIPT@
-INSTALL_STRIP_PROGRAM = @INSTALL_STRIP_PROGRAM@
-LDFLAGS = @LDFLAGS@
-LIBOBJS = @LIBOBJS@
-LIBS = @LIBS@
-LTLIBOBJS = @LTLIBOBJS@
-MAKEINFO = @MAKEINFO@
-MKDIR_P = @MKDIR_P@
-OBJEXT = @OBJEXT@
-PACKAGE = @PACKAGE@
-PACKAGE_BUGREPORT = @PACKAGE_BUGREPORT@
-PACKAGE_NAME = @PACKAGE_NAME@
-PACKAGE_STRING = @PACKAGE_STRING@
-PACKAGE_TARNAME = @PACKAGE_TARNAME@
-PACKAGE_URL = @PACKAGE_URL@
-PACKAGE_VERSION = @PACKAGE_VERSION@
-PATH_SEPARATOR = @PATH_SEPARATOR@
-RANLIB = @RANLIB@
-SDL_CFLAGS = @SDL_CFLAGS@
-SDL_CONFIG = @SDL_CONFIG@
-SDL_LIBS = @SDL_LIBS@
-SET_MAKE = @SET_MAKE@
-SHELL = @SHELL@
-STRIP = @STRIP@
-VERSION = @VERSION@
-WINDRES = @WINDRES@
-abs_builddir = @abs_builddir@
-abs_srcdir = @abs_srcdir@
-abs_top_builddir = @abs_top_builddir@
-abs_top_srcdir = @abs_top_srcdir@
-ac_ct_CC = @ac_ct_CC@
-ac_ct_CXX = @ac_ct_CXX@
-am__include = @am__include@
-am__leading_dot = @am__leading_dot@
-am__quote = @am__quote@
-am__tar = @am__tar@
-am__untar = @am__untar@
-bindir = @bindir@
-build = @build@
-build_alias = @build_alias@
-build_cpu = @build_cpu@
-build_os = @build_os@
-build_vendor = @build_vendor@
-builddir = @builddir@
-datadir = @datadir@
-datarootdir = @datarootdir@
-docdir = @docdir@
-dvidir = @dvidir@
-exec_prefix = @exec_prefix@
-host = @host@
-host_alias = @host_alias@
-host_cpu = @host_cpu@
-host_os = @host_os@
-host_vendor = @host_vendor@
-htmldir = @htmldir@
-includedir = @includedir@
-infodir = @infodir@
-install_sh = @install_sh@
-libdir = @libdir@
-libexecdir = @libexecdir@
-localedir = @localedir@
-localstatedir = @localstatedir@
-mandir = @mandir@
-mkdir_p = @mkdir_p@
-oldincludedir = @oldincludedir@
-pdfdir = @pdfdir@
-prefix = @prefix@
-program_transform_name = @program_transform_name@
-psdir = @psdir@
-sbindir = @sbindir@
-sharedstatedir = @sharedstatedir@
-srcdir = @srcdir@
-sysconfdir = @sysconfdir@
-target_alias = @target_alias@
-top_build_prefix = @top_build_prefix@
-top_builddir = @top_builddir@
-top_srcdir = @top_srcdir@
-SUBDIRS = visualc
-EXTRA_DIST = sdl-win32.diff
-all: all-recursive
-
-.SUFFIXES:
-$(srcdir)/Makefile.in:  $(srcdir)/Makefile.am  $(am__configure_deps)
-	@for dep in $?; do \
-	  case '$(am__configure_deps)' in \
-	    *$$dep*) \
-	      ( cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh ) \
-	        && { if test -f $@; then exit 0; else break; fi; }; \
-	      exit 1;; \
-	  esac; \
-	done; \
-	echo ' cd $(top_srcdir) && $(AUTOMAKE) --gnu src/platform/Makefile'; \
-	$(am__cd) $(top_srcdir) && \
-	  $(AUTOMAKE) --gnu src/platform/Makefile
-.PRECIOUS: Makefile
-Makefile: $(srcdir)/Makefile.in $(top_builddir)/config.status
-	@case '$?' in \
-	  *config.status*) \
-	    cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh;; \
-	  *) \
-	    echo ' cd $(top_builddir) && $(SHELL) ./config.status $(subdir)/$@ $(am__depfiles_maybe)'; \
-	    cd $(top_builddir) && $(SHELL) ./config.status $(subdir)/$@ $(am__depfiles_maybe);; \
-	esac;
-
-$(top_builddir)/config.status: $(top_srcdir)/configure $(CONFIG_STATUS_DEPENDENCIES)
-	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
-
-$(top_srcdir)/configure:  $(am__configure_deps)
-	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
-$(ACLOCAL_M4):  $(am__aclocal_m4_deps)
-	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
-$(am__aclocal_m4_deps):
-
-# This directory's subdirectories are mostly independent; you can cd
-# into them and run `make' without going through this Makefile.
-# To change the values of `make' variables: instead of editing Makefiles,
-# (1) if the variable is set in `config.status', edit `config.status'
-#     (which will cause the Makefiles to be regenerated when you run `make');
-# (2) otherwise, pass the desired values on the `make' command line.
-$(RECURSIVE_TARGETS):
-	@fail= failcom='exit 1'; \
-	for f in x $$MAKEFLAGS; do \
-	  case $$f in \
-	    *=* | --[!k]*);; \
-	    *k*) failcom='fail=yes';; \
-	  esac; \
-	done; \
-	dot_seen=no; \
-	target=`echo $@ | sed s/-recursive//`; \
-	list='$(SUBDIRS)'; for subdir in $$list; do \
-	  echo "Making $$target in $$subdir"; \
-	  if test "$$subdir" = "."; then \
-	    dot_seen=yes; \
-	    local_target="$$target-am"; \
-	  else \
-	    local_target="$$target"; \
-	  fi; \
-	  ($(am__cd) $$subdir && $(MAKE) $(AM_MAKEFLAGS) $$local_target) \
-	  || eval $$failcom; \
-	done; \
-	if test "$$dot_seen" = "no"; then \
-	  $(MAKE) $(AM_MAKEFLAGS) "$$target-am" || exit 1; \
-	fi; test -z "$$fail"
-
-$(RECURSIVE_CLEAN_TARGETS):
-	@fail= failcom='exit 1'; \
-	for f in x $$MAKEFLAGS; do \
-	  case $$f in \
-	    *=* | --[!k]*);; \
-	    *k*) failcom='fail=yes';; \
-	  esac; \
-	done; \
-	dot_seen=no; \
-	case "$@" in \
-	  distclean-* | maintainer-clean-*) list='$(DIST_SUBDIRS)' ;; \
-	  *) list='$(SUBDIRS)' ;; \
-	esac; \
-	rev=''; for subdir in $$list; do \
-	  if test "$$subdir" = "."; then :; else \
-	    rev="$$subdir $$rev"; \
-	  fi; \
-	done; \
-	rev="$$rev ."; \
-	target=`echo $@ | sed s/-recursive//`; \
-	for subdir in $$rev; do \
-	  echo "Making $$target in $$subdir"; \
-	  if test "$$subdir" = "."; then \
-	    local_target="$$target-am"; \
-	  else \
-	    local_target="$$target"; \
-	  fi; \
-	  ($(am__cd) $$subdir && $(MAKE) $(AM_MAKEFLAGS) $$local_target) \
-	  || eval $$failcom; \
-	done && test -z "$$fail"
-tags-recursive:
-	list='$(SUBDIRS)'; for subdir in $$list; do \
-	  test "$$subdir" = . || ($(am__cd) $$subdir && $(MAKE) $(AM_MAKEFLAGS) tags); \
-	done
-ctags-recursive:
-	list='$(SUBDIRS)'; for subdir in $$list; do \
-	  test "$$subdir" = . || ($(am__cd) $$subdir && $(MAKE) $(AM_MAKEFLAGS) ctags); \
-	done
-
-ID: $(HEADERS) $(SOURCES) $(LISP) $(TAGS_FILES)
-	list='$(SOURCES) $(HEADERS) $(LISP) $(TAGS_FILES)'; \
-	unique=`for i in $$list; do \
-	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
-	  done | \
-	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
-	      END { if (nonempty) { for (i in files) print i; }; }'`; \
-	mkid -fID $$unique
-tags: TAGS
-
-TAGS: tags-recursive $(HEADERS) $(SOURCES)  $(TAGS_DEPENDENCIES) \
-		$(TAGS_FILES) $(LISP)
-	set x; \
-	here=`pwd`; \
-	if ($(ETAGS) --etags-include --version) >/dev/null 2>&1; then \
-	  include_option=--etags-include; \
-	  empty_fix=.; \
-	else \
-	  include_option=--include; \
-	  empty_fix=; \
-	fi; \
-	list='$(SUBDIRS)'; for subdir in $$list; do \
-	  if test "$$subdir" = .; then :; else \
-	    test ! -f $$subdir/TAGS || \
-	      set "$$@" "$$include_option=$$here/$$subdir/TAGS"; \
-	  fi; \
-	done; \
-	list='$(SOURCES) $(HEADERS)  $(LISP) $(TAGS_FILES)'; \
-	unique=`for i in $$list; do \
-	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
-	  done | \
-	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
-	      END { if (nonempty) { for (i in files) print i; }; }'`; \
-	shift; \
-	if test -z "$(ETAGS_ARGS)$$*$$unique"; then :; else \
-	  test -n "$$unique" || unique=$$empty_fix; \
-	  if test $$# -gt 0; then \
-	    $(ETAGS) $(ETAGSFLAGS) $(AM_ETAGSFLAGS) $(ETAGS_ARGS) \
-	      "$$@" $$unique; \
-	  else \
-	    $(ETAGS) $(ETAGSFLAGS) $(AM_ETAGSFLAGS) $(ETAGS_ARGS) \
-	      $$unique; \
-	  fi; \
-	fi
-ctags: CTAGS
-CTAGS: ctags-recursive $(HEADERS) $(SOURCES)  $(TAGS_DEPENDENCIES) \
-		$(TAGS_FILES) $(LISP)
-	list='$(SOURCES) $(HEADERS)  $(LISP) $(TAGS_FILES)'; \
-	unique=`for i in $$list; do \
-	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
-	  done | \
-	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
-	      END { if (nonempty) { for (i in files) print i; }; }'`; \
-	test -z "$(CTAGS_ARGS)$$unique" \
-	  || $(CTAGS) $(CTAGSFLAGS) $(AM_CTAGSFLAGS) $(CTAGS_ARGS) \
-	     $$unique
-
-GTAGS:
-	here=`$(am__cd) $(top_builddir) && pwd` \
-	  && $(am__cd) $(top_srcdir) \
-	  && gtags -i $(GTAGS_ARGS) "$$here"
-
-distclean-tags:
-	-rm -f TAGS ID GTAGS GRTAGS GSYMS GPATH tags
-
-distdir: $(DISTFILES)
-	@srcdirstrip=`echo "$(srcdir)" | sed 's/[].[^$$\\*]/\\\\&/g'`; \
-	topsrcdirstrip=`echo "$(top_srcdir)" | sed 's/[].[^$$\\*]/\\\\&/g'`; \
-	list='$(DISTFILES)'; \
-	  dist_files=`for file in $$list; do echo $$file; done | \
-	  sed -e "s|^$$srcdirstrip/||;t" \
-	      -e "s|^$$topsrcdirstrip/|$(top_builddir)/|;t"`; \
-	case $$dist_files in \
-	  */*) $(MKDIR_P) `echo "$$dist_files" | \
-			   sed '/\//!d;s|^|$(distdir)/|;s,/[^/]*$$,,' | \
-			   sort -u` ;; \
-	esac; \
-	for file in $$dist_files; do \
-	  if test -f $$file || test -d $$file; then d=.; else d=$(srcdir); fi; \
-	  if test -d $$d/$$file; then \
-	    dir=`echo "/$$file" | sed -e 's,/[^/]*$$,,'`; \
-	    if test -d "$(distdir)/$$file"; then \
-	      find "$(distdir)/$$file" -type d ! -perm -700 -exec chmod u+rwx {} \;; \
-	    fi; \
-	    if test -d $(srcdir)/$$file && test $$d != $(srcdir); then \
-	      cp -fpR $(srcdir)/$$file "$(distdir)$$dir" || exit 1; \
-	      find "$(distdir)/$$file" -type d ! -perm -700 -exec chmod u+rwx {} \;; \
-	    fi; \
-	    cp -fpR $$d/$$file "$(distdir)$$dir" || exit 1; \
-	  else \
-	    test -f "$(distdir)/$$file" \
-	    || cp -p $$d/$$file "$(distdir)/$$file" \
-	    || exit 1; \
-	  fi; \
-	done
-	@list='$(DIST_SUBDIRS)'; for subdir in $$list; do \
-	  if test "$$subdir" = .; then :; else \
-	    test -d "$(distdir)/$$subdir" \
-	    || $(MKDIR_P) "$(distdir)/$$subdir" \
-	    || exit 1; \
-	  fi; \
-	done
-	@list='$(DIST_SUBDIRS)'; for subdir in $$list; do \
-	  if test "$$subdir" = .; then :; else \
-	    dir1=$$subdir; dir2="$(distdir)/$$subdir"; \
-	    $(am__relativize); \
-	    new_distdir=$$reldir; \
-	    dir1=$$subdir; dir2="$(top_distdir)"; \
-	    $(am__relativize); \
-	    new_top_distdir=$$reldir; \
-	    echo " (cd $$subdir && $(MAKE) $(AM_MAKEFLAGS) top_distdir="$$new_top_distdir" distdir="$$new_distdir" \\"; \
-	    echo "     am__remove_distdir=: am__skip_length_check=: am__skip_mode_fix=: distdir)"; \
-	    ($(am__cd) $$subdir && \
-	      $(MAKE) $(AM_MAKEFLAGS) \
-	        top_distdir="$$new_top_distdir" \
-	        distdir="$$new_distdir" \
-		am__remove_distdir=: \
-		am__skip_length_check=: \
-		am__skip_mode_fix=: \
-	        distdir) \
-	      || exit 1; \
-	  fi; \
-	done
-check-am: all-am
-check: check-recursive
-all-am: Makefile
-installdirs: installdirs-recursive
-installdirs-am:
-install: install-recursive
-install-exec: install-exec-recursive
-install-data: install-data-recursive
-uninstall: uninstall-recursive
-
-install-am: all-am
-	@$(MAKE) $(AM_MAKEFLAGS) install-exec-am install-data-am
-
-installcheck: installcheck-recursive
-install-strip:
-	$(MAKE) $(AM_MAKEFLAGS) INSTALL_PROGRAM="$(INSTALL_STRIP_PROGRAM)" \
-	  install_sh_PROGRAM="$(INSTALL_STRIP_PROGRAM)" INSTALL_STRIP_FLAG=-s \
-	  `test -z '$(STRIP)' || \
-	    echo "INSTALL_PROGRAM_ENV=STRIPPROG='$(STRIP)'"` install
-mostlyclean-generic:
-
-clean-generic:
-
-distclean-generic:
-	-test -z "$(CONFIG_CLEAN_FILES)" || rm -f $(CONFIG_CLEAN_FILES)
-	-test . = "$(srcdir)" || test -z "$(CONFIG_CLEAN_VPATH_FILES)" || rm -f $(CONFIG_CLEAN_VPATH_FILES)
-
-maintainer-clean-generic:
-	@echo "This command is intended for maintainers to use"
-	@echo "it deletes files that may require special tools to rebuild."
-clean: clean-recursive
-
-clean-am: clean-generic mostlyclean-am
-
-distclean: distclean-recursive
-	-rm -f Makefile
-distclean-am: clean-am distclean-generic distclean-tags
-
-dvi: dvi-recursive
-
-dvi-am:
-
-html: html-recursive
-
-html-am:
-
-info: info-recursive
-
-info-am:
-
-install-data-am:
-
-install-dvi: install-dvi-recursive
-
-install-dvi-am:
-
-install-exec-am:
-
-install-html: install-html-recursive
-
-install-html-am:
-
-install-info: install-info-recursive
-
-install-info-am:
-
-install-man:
-
-install-pdf: install-pdf-recursive
-
-install-pdf-am:
-
-install-ps: install-ps-recursive
-
-install-ps-am:
-
-installcheck-am:
-
-maintainer-clean: maintainer-clean-recursive
-	-rm -f Makefile
-maintainer-clean-am: distclean-am maintainer-clean-generic
-
-mostlyclean: mostlyclean-recursive
-
-mostlyclean-am: mostlyclean-generic
-
-pdf: pdf-recursive
-
-pdf-am:
-
-ps: ps-recursive
-
-ps-am:
-
-uninstall-am:
-
-.MAKE: $(RECURSIVE_CLEAN_TARGETS) $(RECURSIVE_TARGETS) ctags-recursive \
-	install-am install-strip tags-recursive
-
-.PHONY: $(RECURSIVE_CLEAN_TARGETS) $(RECURSIVE_TARGETS) CTAGS GTAGS \
-	all all-am check check-am clean clean-generic ctags \
-	ctags-recursive distclean distclean-generic distclean-tags \
-	distdir dvi dvi-am html html-am info info-am install \
-	install-am install-data install-data-am install-dvi \
-	install-dvi-am install-exec install-exec-am install-html \
-	install-html-am install-info install-info-am install-man \
-	install-pdf install-pdf-am install-ps install-ps-am \
-	install-strip installcheck installcheck-am installdirs \
-	installdirs-am maintainer-clean maintainer-clean-generic \
-	mostlyclean mostlyclean-generic pdf pdf-am ps ps-am tags \
-	tags-recursive uninstall uninstall-am
-
-
-# Tell versions [3.59,3.63) of GNU make to not export all variables.
-# Otherwise a system limit (for SysV at least) may be exceeded.
-.NOEXPORT:
diff -Nur dosbox-0.74/src/platform/visualc/config.h dosbox-0.74.patch/src/platform/visualc/config.h
--- dosbox-0.74/src/platform/visualc/config.h	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/platform/visualc/config.h	2016-12-11 18:35:15.558284005 +0100
@@ -1,4 +1,4 @@
-#define VERSION "0.74"
+#define VERSION "SVN"
 
 /* Define to 1 to enable internal debugger, requires libcurses */
 #define C_DEBUG 0
diff -Nur dosbox-0.74/src/platform/visualc/Makefile.in dosbox-0.74.patch/src/platform/visualc/Makefile.in
--- dosbox-0.74/src/platform/visualc/Makefile.in	2010-05-12 11:57:44.000000000 +0200
+++ dosbox-0.74.patch/src/platform/visualc/Makefile.in	1970-01-01 01:00:00.000000000 +0100
@@ -1,336 +0,0 @@
-# Makefile.in generated by automake 1.11.1 from Makefile.am.
-# @configure_input@
-
-# Copyright (C) 1994, 1995, 1996, 1997, 1998, 1999, 2000, 2001, 2002,
-# 2003, 2004, 2005, 2006, 2007, 2008, 2009  Free Software Foundation,
-# Inc.
-# This Makefile.in is free software; the Free Software Foundation
-# gives unlimited permission to copy and/or distribute it,
-# with or without modifications, as long as this notice is preserved.
-
-# This program is distributed in the hope that it will be useful,
-# but WITHOUT ANY WARRANTY, to the extent permitted by law; without
-# even the implied warranty of MERCHANTABILITY or FITNESS FOR A
-# PARTICULAR PURPOSE.
-
-@SET_MAKE@
-VPATH = @srcdir@
-pkgdatadir = $(datadir)/@PACKAGE@
-pkgincludedir = $(includedir)/@PACKAGE@
-pkglibdir = $(libdir)/@PACKAGE@
-pkglibexecdir = $(libexecdir)/@PACKAGE@
-am__cd = CDPATH="$${ZSH_VERSION+.}$(PATH_SEPARATOR)" && cd
-install_sh_DATA = $(install_sh) -c -m 644
-install_sh_PROGRAM = $(install_sh) -c
-install_sh_SCRIPT = $(install_sh) -c
-INSTALL_HEADER = $(INSTALL_DATA)
-transform = $(program_transform_name)
-NORMAL_INSTALL = :
-PRE_INSTALL = :
-POST_INSTALL = :
-NORMAL_UNINSTALL = :
-PRE_UNINSTALL = :
-POST_UNINSTALL = :
-build_triplet = @build@
-host_triplet = @host@
-subdir = src/platform/visualc
-DIST_COMMON = $(srcdir)/Makefile.am $(srcdir)/Makefile.in
-ACLOCAL_M4 = $(top_srcdir)/aclocal.m4
-am__aclocal_m4_deps = $(top_srcdir)/acinclude.m4 \
-	$(top_srcdir)/configure.in
-am__configure_deps = $(am__aclocal_m4_deps) $(CONFIGURE_DEPENDENCIES) \
-	$(ACLOCAL_M4)
-mkinstalldirs = $(install_sh) -d
-CONFIG_HEADER = $(top_builddir)/config.h
-CONFIG_CLEAN_FILES =
-CONFIG_CLEAN_VPATH_FILES =
-SOURCES =
-DIST_SOURCES =
-DISTFILES = $(DIST_COMMON) $(DIST_SOURCES) $(TEXINFOS) $(EXTRA_DIST)
-ACLOCAL = @ACLOCAL@
-ALSA_CFLAGS = @ALSA_CFLAGS@
-ALSA_LIBS = @ALSA_LIBS@
-AMTAR = @AMTAR@
-AUTOCONF = @AUTOCONF@
-AUTOHEADER = @AUTOHEADER@
-AUTOMAKE = @AUTOMAKE@
-AWK = @AWK@
-CC = @CC@
-CCDEPMODE = @CCDEPMODE@
-CFLAGS = @CFLAGS@
-CPP = @CPP@
-CPPFLAGS = @CPPFLAGS@
-CXX = @CXX@
-CXXDEPMODE = @CXXDEPMODE@
-CXXFLAGS = @CXXFLAGS@
-CYGPATH_W = @CYGPATH_W@
-DEFS = @DEFS@
-DEPDIR = @DEPDIR@
-ECHO_C = @ECHO_C@
-ECHO_N = @ECHO_N@
-ECHO_T = @ECHO_T@
-EGREP = @EGREP@
-EXEEXT = @EXEEXT@
-GREP = @GREP@
-INSTALL = @INSTALL@
-INSTALL_DATA = @INSTALL_DATA@
-INSTALL_PROGRAM = @INSTALL_PROGRAM@
-INSTALL_SCRIPT = @INSTALL_SCRIPT@
-INSTALL_STRIP_PROGRAM = @INSTALL_STRIP_PROGRAM@
-LDFLAGS = @LDFLAGS@
-LIBOBJS = @LIBOBJS@
-LIBS = @LIBS@
-LTLIBOBJS = @LTLIBOBJS@
-MAKEINFO = @MAKEINFO@
-MKDIR_P = @MKDIR_P@
-OBJEXT = @OBJEXT@
-PACKAGE = @PACKAGE@
-PACKAGE_BUGREPORT = @PACKAGE_BUGREPORT@
-PACKAGE_NAME = @PACKAGE_NAME@
-PACKAGE_STRING = @PACKAGE_STRING@
-PACKAGE_TARNAME = @PACKAGE_TARNAME@
-PACKAGE_URL = @PACKAGE_URL@
-PACKAGE_VERSION = @PACKAGE_VERSION@
-PATH_SEPARATOR = @PATH_SEPARATOR@
-RANLIB = @RANLIB@
-SDL_CFLAGS = @SDL_CFLAGS@
-SDL_CONFIG = @SDL_CONFIG@
-SDL_LIBS = @SDL_LIBS@
-SET_MAKE = @SET_MAKE@
-SHELL = @SHELL@
-STRIP = @STRIP@
-VERSION = @VERSION@
-WINDRES = @WINDRES@
-abs_builddir = @abs_builddir@
-abs_srcdir = @abs_srcdir@
-abs_top_builddir = @abs_top_builddir@
-abs_top_srcdir = @abs_top_srcdir@
-ac_ct_CC = @ac_ct_CC@
-ac_ct_CXX = @ac_ct_CXX@
-am__include = @am__include@
-am__leading_dot = @am__leading_dot@
-am__quote = @am__quote@
-am__tar = @am__tar@
-am__untar = @am__untar@
-bindir = @bindir@
-build = @build@
-build_alias = @build_alias@
-build_cpu = @build_cpu@
-build_os = @build_os@
-build_vendor = @build_vendor@
-builddir = @builddir@
-datadir = @datadir@
-datarootdir = @datarootdir@
-docdir = @docdir@
-dvidir = @dvidir@
-exec_prefix = @exec_prefix@
-host = @host@
-host_alias = @host_alias@
-host_cpu = @host_cpu@
-host_os = @host_os@
-host_vendor = @host_vendor@
-htmldir = @htmldir@
-includedir = @includedir@
-infodir = @infodir@
-install_sh = @install_sh@
-libdir = @libdir@
-libexecdir = @libexecdir@
-localedir = @localedir@
-localstatedir = @localstatedir@
-mandir = @mandir@
-mkdir_p = @mkdir_p@
-oldincludedir = @oldincludedir@
-pdfdir = @pdfdir@
-prefix = @prefix@
-program_transform_name = @program_transform_name@
-psdir = @psdir@
-sbindir = @sbindir@
-sharedstatedir = @sharedstatedir@
-srcdir = @srcdir@
-sysconfdir = @sysconfdir@
-target_alias = @target_alias@
-top_build_prefix = @top_build_prefix@
-top_builddir = @top_builddir@
-top_srcdir = @top_srcdir@
-EXTRA_DIST = unistd.h config.h ntddscsi.h ntddcdrm.h
-all: all-am
-
-.SUFFIXES:
-$(srcdir)/Makefile.in:  $(srcdir)/Makefile.am  $(am__configure_deps)
-	@for dep in $?; do \
-	  case '$(am__configure_deps)' in \
-	    *$$dep*) \
-	      ( cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh ) \
-	        && { if test -f $@; then exit 0; else break; fi; }; \
-	      exit 1;; \
-	  esac; \
-	done; \
-	echo ' cd $(top_srcdir) && $(AUTOMAKE) --gnu src/platform/visualc/Makefile'; \
-	$(am__cd) $(top_srcdir) && \
-	  $(AUTOMAKE) --gnu src/platform/visualc/Makefile
-.PRECIOUS: Makefile
-Makefile: $(srcdir)/Makefile.in $(top_builddir)/config.status
-	@case '$?' in \
-	  *config.status*) \
-	    cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh;; \
-	  *) \
-	    echo ' cd $(top_builddir) && $(SHELL) ./config.status $(subdir)/$@ $(am__depfiles_maybe)'; \
-	    cd $(top_builddir) && $(SHELL) ./config.status $(subdir)/$@ $(am__depfiles_maybe);; \
-	esac;
-
-$(top_builddir)/config.status: $(top_srcdir)/configure $(CONFIG_STATUS_DEPENDENCIES)
-	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
-
-$(top_srcdir)/configure:  $(am__configure_deps)
-	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
-$(ACLOCAL_M4):  $(am__aclocal_m4_deps)
-	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
-$(am__aclocal_m4_deps):
-tags: TAGS
-TAGS:
-
-ctags: CTAGS
-CTAGS:
-
-
-distdir: $(DISTFILES)
-	@srcdirstrip=`echo "$(srcdir)" | sed 's/[].[^$$\\*]/\\\\&/g'`; \
-	topsrcdirstrip=`echo "$(top_srcdir)" | sed 's/[].[^$$\\*]/\\\\&/g'`; \
-	list='$(DISTFILES)'; \
-	  dist_files=`for file in $$list; do echo $$file; done | \
-	  sed -e "s|^$$srcdirstrip/||;t" \
-	      -e "s|^$$topsrcdirstrip/|$(top_builddir)/|;t"`; \
-	case $$dist_files in \
-	  */*) $(MKDIR_P) `echo "$$dist_files" | \
-			   sed '/\//!d;s|^|$(distdir)/|;s,/[^/]*$$,,' | \
-			   sort -u` ;; \
-	esac; \
-	for file in $$dist_files; do \
-	  if test -f $$file || test -d $$file; then d=.; else d=$(srcdir); fi; \
-	  if test -d $$d/$$file; then \
-	    dir=`echo "/$$file" | sed -e 's,/[^/]*$$,,'`; \
-	    if test -d "$(distdir)/$$file"; then \
-	      find "$(distdir)/$$file" -type d ! -perm -700 -exec chmod u+rwx {} \;; \
-	    fi; \
-	    if test -d $(srcdir)/$$file && test $$d != $(srcdir); then \
-	      cp -fpR $(srcdir)/$$file "$(distdir)$$dir" || exit 1; \
-	      find "$(distdir)/$$file" -type d ! -perm -700 -exec chmod u+rwx {} \;; \
-	    fi; \
-	    cp -fpR $$d/$$file "$(distdir)$$dir" || exit 1; \
-	  else \
-	    test -f "$(distdir)/$$file" \
-	    || cp -p $$d/$$file "$(distdir)/$$file" \
-	    || exit 1; \
-	  fi; \
-	done
-check-am: all-am
-check: check-am
-all-am: Makefile
-installdirs:
-install: install-am
-install-exec: install-exec-am
-install-data: install-data-am
-uninstall: uninstall-am
-
-install-am: all-am
-	@$(MAKE) $(AM_MAKEFLAGS) install-exec-am install-data-am
-
-installcheck: installcheck-am
-install-strip:
-	$(MAKE) $(AM_MAKEFLAGS) INSTALL_PROGRAM="$(INSTALL_STRIP_PROGRAM)" \
-	  install_sh_PROGRAM="$(INSTALL_STRIP_PROGRAM)" INSTALL_STRIP_FLAG=-s \
-	  `test -z '$(STRIP)' || \
-	    echo "INSTALL_PROGRAM_ENV=STRIPPROG='$(STRIP)'"` install
-mostlyclean-generic:
-
-clean-generic:
-
-distclean-generic:
-	-test -z "$(CONFIG_CLEAN_FILES)" || rm -f $(CONFIG_CLEAN_FILES)
-	-test . = "$(srcdir)" || test -z "$(CONFIG_CLEAN_VPATH_FILES)" || rm -f $(CONFIG_CLEAN_VPATH_FILES)
-
-maintainer-clean-generic:
-	@echo "This command is intended for maintainers to use"
-	@echo "it deletes files that may require special tools to rebuild."
-clean: clean-am
-
-clean-am: clean-generic mostlyclean-am
-
-distclean: distclean-am
-	-rm -f Makefile
-distclean-am: clean-am distclean-generic
-
-dvi: dvi-am
-
-dvi-am:
-
-html: html-am
-
-html-am:
-
-info: info-am
-
-info-am:
-
-install-data-am:
-
-install-dvi: install-dvi-am
-
-install-dvi-am:
-
-install-exec-am:
-
-install-html: install-html-am
-
-install-html-am:
-
-install-info: install-info-am
-
-install-info-am:
-
-install-man:
-
-install-pdf: install-pdf-am
-
-install-pdf-am:
-
-install-ps: install-ps-am
-
-install-ps-am:
-
-installcheck-am:
-
-maintainer-clean: maintainer-clean-am
-	-rm -f Makefile
-maintainer-clean-am: distclean-am maintainer-clean-generic
-
-mostlyclean: mostlyclean-am
-
-mostlyclean-am: mostlyclean-generic
-
-pdf: pdf-am
-
-pdf-am:
-
-ps: ps-am
-
-ps-am:
-
-uninstall-am:
-
-.MAKE: install-am install-strip
-
-.PHONY: all all-am check check-am clean clean-generic distclean \
-	distclean-generic distdir dvi dvi-am html html-am info info-am \
-	install install-am install-data install-data-am install-dvi \
-	install-dvi-am install-exec install-exec-am install-html \
-	install-html-am install-info install-info-am install-man \
-	install-pdf install-pdf-am install-ps install-ps-am \
-	install-strip installcheck installcheck-am installdirs \
-	maintainer-clean maintainer-clean-generic mostlyclean \
-	mostlyclean-generic pdf pdf-am ps ps-am uninstall uninstall-am
-
-
-# Tell versions [3.59,3.63) of GNU make to not export all variables.
-# Otherwise a system limit (for SysV at least) may be exceeded.
-.NOEXPORT:
diff -Nur dosbox-0.74/src/shell/Makefile.in dosbox-0.74.patch/src/shell/Makefile.in
--- dosbox-0.74/src/shell/Makefile.in	2010-05-12 11:57:44.000000000 +0200
+++ dosbox-0.74.patch/src/shell/Makefile.in	1970-01-01 01:00:00.000000000 +0100
@@ -1,443 +0,0 @@
-# Makefile.in generated by automake 1.11.1 from Makefile.am.
-# @configure_input@
-
-# Copyright (C) 1994, 1995, 1996, 1997, 1998, 1999, 2000, 2001, 2002,
-# 2003, 2004, 2005, 2006, 2007, 2008, 2009  Free Software Foundation,
-# Inc.
-# This Makefile.in is free software; the Free Software Foundation
-# gives unlimited permission to copy and/or distribute it,
-# with or without modifications, as long as this notice is preserved.
-
-# This program is distributed in the hope that it will be useful,
-# but WITHOUT ANY WARRANTY, to the extent permitted by law; without
-# even the implied warranty of MERCHANTABILITY or FITNESS FOR A
-# PARTICULAR PURPOSE.
-
-@SET_MAKE@
-
-VPATH = @srcdir@
-pkgdatadir = $(datadir)/@PACKAGE@
-pkgincludedir = $(includedir)/@PACKAGE@
-pkglibdir = $(libdir)/@PACKAGE@
-pkglibexecdir = $(libexecdir)/@PACKAGE@
-am__cd = CDPATH="$${ZSH_VERSION+.}$(PATH_SEPARATOR)" && cd
-install_sh_DATA = $(install_sh) -c -m 644
-install_sh_PROGRAM = $(install_sh) -c
-install_sh_SCRIPT = $(install_sh) -c
-INSTALL_HEADER = $(INSTALL_DATA)
-transform = $(program_transform_name)
-NORMAL_INSTALL = :
-PRE_INSTALL = :
-POST_INSTALL = :
-NORMAL_UNINSTALL = :
-PRE_UNINSTALL = :
-POST_UNINSTALL = :
-build_triplet = @build@
-host_triplet = @host@
-subdir = src/shell
-DIST_COMMON = $(srcdir)/Makefile.am $(srcdir)/Makefile.in
-ACLOCAL_M4 = $(top_srcdir)/aclocal.m4
-am__aclocal_m4_deps = $(top_srcdir)/acinclude.m4 \
-	$(top_srcdir)/configure.in
-am__configure_deps = $(am__aclocal_m4_deps) $(CONFIGURE_DEPENDENCIES) \
-	$(ACLOCAL_M4)
-mkinstalldirs = $(install_sh) -d
-CONFIG_HEADER = $(top_builddir)/config.h
-CONFIG_CLEAN_FILES =
-CONFIG_CLEAN_VPATH_FILES =
-LIBRARIES = $(noinst_LIBRARIES)
-AR = ar
-ARFLAGS = cru
-libshell_a_AR = $(AR) $(ARFLAGS)
-libshell_a_LIBADD =
-am_libshell_a_OBJECTS = shell.$(OBJEXT) shell_batch.$(OBJEXT) \
-	shell_cmds.$(OBJEXT) shell_misc.$(OBJEXT)
-libshell_a_OBJECTS = $(am_libshell_a_OBJECTS)
-DEFAULT_INCLUDES = -I.@am__isrc@ -I$(top_builddir)
-depcomp = $(SHELL) $(top_srcdir)/depcomp
-am__depfiles_maybe = depfiles
-am__mv = mv -f
-CXXCOMPILE = $(CXX) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) \
-	$(AM_CPPFLAGS) $(CPPFLAGS) $(AM_CXXFLAGS) $(CXXFLAGS)
-CXXLD = $(CXX)
-CXXLINK = $(CXXLD) $(AM_CXXFLAGS) $(CXXFLAGS) $(AM_LDFLAGS) $(LDFLAGS) \
-	-o $@
-SOURCES = $(libshell_a_SOURCES)
-DIST_SOURCES = $(libshell_a_SOURCES)
-ETAGS = etags
-CTAGS = ctags
-DISTFILES = $(DIST_COMMON) $(DIST_SOURCES) $(TEXINFOS) $(EXTRA_DIST)
-ACLOCAL = @ACLOCAL@
-ALSA_CFLAGS = @ALSA_CFLAGS@
-ALSA_LIBS = @ALSA_LIBS@
-AMTAR = @AMTAR@
-AUTOCONF = @AUTOCONF@
-AUTOHEADER = @AUTOHEADER@
-AUTOMAKE = @AUTOMAKE@
-AWK = @AWK@
-CC = @CC@
-CCDEPMODE = @CCDEPMODE@
-CFLAGS = @CFLAGS@
-CPP = @CPP@
-CPPFLAGS = @CPPFLAGS@
-CXX = @CXX@
-CXXDEPMODE = @CXXDEPMODE@
-CXXFLAGS = @CXXFLAGS@
-CYGPATH_W = @CYGPATH_W@
-DEFS = @DEFS@
-DEPDIR = @DEPDIR@
-ECHO_C = @ECHO_C@
-ECHO_N = @ECHO_N@
-ECHO_T = @ECHO_T@
-EGREP = @EGREP@
-EXEEXT = @EXEEXT@
-GREP = @GREP@
-INSTALL = @INSTALL@
-INSTALL_DATA = @INSTALL_DATA@
-INSTALL_PROGRAM = @INSTALL_PROGRAM@
-INSTALL_SCRIPT = @INSTALL_SCRIPT@
-INSTALL_STRIP_PROGRAM = @INSTALL_STRIP_PROGRAM@
-LDFLAGS = @LDFLAGS@
-LIBOBJS = @LIBOBJS@
-LIBS = @LIBS@
-LTLIBOBJS = @LTLIBOBJS@
-MAKEINFO = @MAKEINFO@
-MKDIR_P = @MKDIR_P@
-OBJEXT = @OBJEXT@
-PACKAGE = @PACKAGE@
-PACKAGE_BUGREPORT = @PACKAGE_BUGREPORT@
-PACKAGE_NAME = @PACKAGE_NAME@
-PACKAGE_STRING = @PACKAGE_STRING@
-PACKAGE_TARNAME = @PACKAGE_TARNAME@
-PACKAGE_URL = @PACKAGE_URL@
-PACKAGE_VERSION = @PACKAGE_VERSION@
-PATH_SEPARATOR = @PATH_SEPARATOR@
-RANLIB = @RANLIB@
-SDL_CFLAGS = @SDL_CFLAGS@
-SDL_CONFIG = @SDL_CONFIG@
-SDL_LIBS = @SDL_LIBS@
-SET_MAKE = @SET_MAKE@
-SHELL = @SHELL@
-STRIP = @STRIP@
-VERSION = @VERSION@
-WINDRES = @WINDRES@
-abs_builddir = @abs_builddir@
-abs_srcdir = @abs_srcdir@
-abs_top_builddir = @abs_top_builddir@
-abs_top_srcdir = @abs_top_srcdir@
-ac_ct_CC = @ac_ct_CC@
-ac_ct_CXX = @ac_ct_CXX@
-am__include = @am__include@
-am__leading_dot = @am__leading_dot@
-am__quote = @am__quote@
-am__tar = @am__tar@
-am__untar = @am__untar@
-bindir = @bindir@
-build = @build@
-build_alias = @build_alias@
-build_cpu = @build_cpu@
-build_os = @build_os@
-build_vendor = @build_vendor@
-builddir = @builddir@
-datadir = @datadir@
-datarootdir = @datarootdir@
-docdir = @docdir@
-dvidir = @dvidir@
-exec_prefix = @exec_prefix@
-host = @host@
-host_alias = @host_alias@
-host_cpu = @host_cpu@
-host_os = @host_os@
-host_vendor = @host_vendor@
-htmldir = @htmldir@
-includedir = @includedir@
-infodir = @infodir@
-install_sh = @install_sh@
-libdir = @libdir@
-libexecdir = @libexecdir@
-localedir = @localedir@
-localstatedir = @localstatedir@
-mandir = @mandir@
-mkdir_p = @mkdir_p@
-oldincludedir = @oldincludedir@
-pdfdir = @pdfdir@
-prefix = @prefix@
-program_transform_name = @program_transform_name@
-psdir = @psdir@
-sbindir = @sbindir@
-sharedstatedir = @sharedstatedir@
-srcdir = @srcdir@
-sysconfdir = @sysconfdir@
-target_alias = @target_alias@
-top_build_prefix = @top_build_prefix@
-top_builddir = @top_builddir@
-top_srcdir = @top_srcdir@
-AM_CPPFLAGS = -I$(top_srcdir)/include
-noinst_LIBRARIES = libshell.a
-libshell_a_SOURCES = shell.cpp shell_batch.cpp shell_cmds.cpp shell_misc.cpp
-all: all-am
-
-.SUFFIXES:
-.SUFFIXES: .cpp .o .obj
-$(srcdir)/Makefile.in:  $(srcdir)/Makefile.am  $(am__configure_deps)
-	@for dep in $?; do \
-	  case '$(am__configure_deps)' in \
-	    *$$dep*) \
-	      ( cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh ) \
-	        && { if test -f $@; then exit 0; else break; fi; }; \
-	      exit 1;; \
-	  esac; \
-	done; \
-	echo ' cd $(top_srcdir) && $(AUTOMAKE) --gnu src/shell/Makefile'; \
-	$(am__cd) $(top_srcdir) && \
-	  $(AUTOMAKE) --gnu src/shell/Makefile
-.PRECIOUS: Makefile
-Makefile: $(srcdir)/Makefile.in $(top_builddir)/config.status
-	@case '$?' in \
-	  *config.status*) \
-	    cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh;; \
-	  *) \
-	    echo ' cd $(top_builddir) && $(SHELL) ./config.status $(subdir)/$@ $(am__depfiles_maybe)'; \
-	    cd $(top_builddir) && $(SHELL) ./config.status $(subdir)/$@ $(am__depfiles_maybe);; \
-	esac;
-
-$(top_builddir)/config.status: $(top_srcdir)/configure $(CONFIG_STATUS_DEPENDENCIES)
-	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
-
-$(top_srcdir)/configure:  $(am__configure_deps)
-	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
-$(ACLOCAL_M4):  $(am__aclocal_m4_deps)
-	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
-$(am__aclocal_m4_deps):
-
-clean-noinstLIBRARIES:
-	-test -z "$(noinst_LIBRARIES)" || rm -f $(noinst_LIBRARIES)
-libshell.a: $(libshell_a_OBJECTS) $(libshell_a_DEPENDENCIES) 
-	-rm -f libshell.a
-	$(libshell_a_AR) libshell.a $(libshell_a_OBJECTS) $(libshell_a_LIBADD)
-	$(RANLIB) libshell.a
-
-mostlyclean-compile:
-	-rm -f *.$(OBJEXT)
-
-distclean-compile:
-	-rm -f *.tab.c
-
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/shell.Po@am__quote@
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/shell_batch.Po@am__quote@
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/shell_cmds.Po@am__quote@
-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/shell_misc.Po@am__quote@
-
-.cpp.o:
-@am__fastdepCXX_TRUE@	$(CXXCOMPILE) -MT $@ -MD -MP -MF $(DEPDIR)/$*.Tpo -c -o $@ $<
-@am__fastdepCXX_TRUE@	$(am__mv) $(DEPDIR)/$*.Tpo $(DEPDIR)/$*.Po
-@AMDEP_TRUE@@am__fastdepCXX_FALSE@	source='$<' object='$@' libtool=no @AMDEPBACKSLASH@
-@AMDEP_TRUE@@am__fastdepCXX_FALSE@	DEPDIR=$(DEPDIR) $(CXXDEPMODE) $(depcomp) @AMDEPBACKSLASH@
-@am__fastdepCXX_FALSE@	$(CXXCOMPILE) -c -o $@ $<
-
-.cpp.obj:
-@am__fastdepCXX_TRUE@	$(CXXCOMPILE) -MT $@ -MD -MP -MF $(DEPDIR)/$*.Tpo -c -o $@ `$(CYGPATH_W) '$<'`
-@am__fastdepCXX_TRUE@	$(am__mv) $(DEPDIR)/$*.Tpo $(DEPDIR)/$*.Po
-@AMDEP_TRUE@@am__fastdepCXX_FALSE@	source='$<' object='$@' libtool=no @AMDEPBACKSLASH@
-@AMDEP_TRUE@@am__fastdepCXX_FALSE@	DEPDIR=$(DEPDIR) $(CXXDEPMODE) $(depcomp) @AMDEPBACKSLASH@
-@am__fastdepCXX_FALSE@	$(CXXCOMPILE) -c -o $@ `$(CYGPATH_W) '$<'`
-
-ID: $(HEADERS) $(SOURCES) $(LISP) $(TAGS_FILES)
-	list='$(SOURCES) $(HEADERS) $(LISP) $(TAGS_FILES)'; \
-	unique=`for i in $$list; do \
-	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
-	  done | \
-	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
-	      END { if (nonempty) { for (i in files) print i; }; }'`; \
-	mkid -fID $$unique
-tags: TAGS
-
-TAGS:  $(HEADERS) $(SOURCES)  $(TAGS_DEPENDENCIES) \
-		$(TAGS_FILES) $(LISP)
-	set x; \
-	here=`pwd`; \
-	list='$(SOURCES) $(HEADERS)  $(LISP) $(TAGS_FILES)'; \
-	unique=`for i in $$list; do \
-	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
-	  done | \
-	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
-	      END { if (nonempty) { for (i in files) print i; }; }'`; \
-	shift; \
-	if test -z "$(ETAGS_ARGS)$$*$$unique"; then :; else \
-	  test -n "$$unique" || unique=$$empty_fix; \
-	  if test $$# -gt 0; then \
-	    $(ETAGS) $(ETAGSFLAGS) $(AM_ETAGSFLAGS) $(ETAGS_ARGS) \
-	      "$$@" $$unique; \
-	  else \
-	    $(ETAGS) $(ETAGSFLAGS) $(AM_ETAGSFLAGS) $(ETAGS_ARGS) \
-	      $$unique; \
-	  fi; \
-	fi
-ctags: CTAGS
-CTAGS:  $(HEADERS) $(SOURCES)  $(TAGS_DEPENDENCIES) \
-		$(TAGS_FILES) $(LISP)
-	list='$(SOURCES) $(HEADERS)  $(LISP) $(TAGS_FILES)'; \
-	unique=`for i in $$list; do \
-	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
-	  done | \
-	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
-	      END { if (nonempty) { for (i in files) print i; }; }'`; \
-	test -z "$(CTAGS_ARGS)$$unique" \
-	  || $(CTAGS) $(CTAGSFLAGS) $(AM_CTAGSFLAGS) $(CTAGS_ARGS) \
-	     $$unique
-
-GTAGS:
-	here=`$(am__cd) $(top_builddir) && pwd` \
-	  && $(am__cd) $(top_srcdir) \
-	  && gtags -i $(GTAGS_ARGS) "$$here"
-
-distclean-tags:
-	-rm -f TAGS ID GTAGS GRTAGS GSYMS GPATH tags
-
-distdir: $(DISTFILES)
-	@srcdirstrip=`echo "$(srcdir)" | sed 's/[].[^$$\\*]/\\\\&/g'`; \
-	topsrcdirstrip=`echo "$(top_srcdir)" | sed 's/[].[^$$\\*]/\\\\&/g'`; \
-	list='$(DISTFILES)'; \
-	  dist_files=`for file in $$list; do echo $$file; done | \
-	  sed -e "s|^$$srcdirstrip/||;t" \
-	      -e "s|^$$topsrcdirstrip/|$(top_builddir)/|;t"`; \
-	case $$dist_files in \
-	  */*) $(MKDIR_P) `echo "$$dist_files" | \
-			   sed '/\//!d;s|^|$(distdir)/|;s,/[^/]*$$,,' | \
-			   sort -u` ;; \
-	esac; \
-	for file in $$dist_files; do \
-	  if test -f $$file || test -d $$file; then d=.; else d=$(srcdir); fi; \
-	  if test -d $$d/$$file; then \
-	    dir=`echo "/$$file" | sed -e 's,/[^/]*$$,,'`; \
-	    if test -d "$(distdir)/$$file"; then \
-	      find "$(distdir)/$$file" -type d ! -perm -700 -exec chmod u+rwx {} \;; \
-	    fi; \
-	    if test -d $(srcdir)/$$file && test $$d != $(srcdir); then \
-	      cp -fpR $(srcdir)/$$file "$(distdir)$$dir" || exit 1; \
-	      find "$(distdir)/$$file" -type d ! -perm -700 -exec chmod u+rwx {} \;; \
-	    fi; \
-	    cp -fpR $$d/$$file "$(distdir)$$dir" || exit 1; \
-	  else \
-	    test -f "$(distdir)/$$file" \
-	    || cp -p $$d/$$file "$(distdir)/$$file" \
-	    || exit 1; \
-	  fi; \
-	done
-check-am: all-am
-check: check-am
-all-am: Makefile $(LIBRARIES)
-installdirs:
-install: install-am
-install-exec: install-exec-am
-install-data: install-data-am
-uninstall: uninstall-am
-
-install-am: all-am
-	@$(MAKE) $(AM_MAKEFLAGS) install-exec-am install-data-am
-
-installcheck: installcheck-am
-install-strip:
-	$(MAKE) $(AM_MAKEFLAGS) INSTALL_PROGRAM="$(INSTALL_STRIP_PROGRAM)" \
-	  install_sh_PROGRAM="$(INSTALL_STRIP_PROGRAM)" INSTALL_STRIP_FLAG=-s \
-	  `test -z '$(STRIP)' || \
-	    echo "INSTALL_PROGRAM_ENV=STRIPPROG='$(STRIP)'"` install
-mostlyclean-generic:
-
-clean-generic:
-
-distclean-generic:
-	-test -z "$(CONFIG_CLEAN_FILES)" || rm -f $(CONFIG_CLEAN_FILES)
-	-test . = "$(srcdir)" || test -z "$(CONFIG_CLEAN_VPATH_FILES)" || rm -f $(CONFIG_CLEAN_VPATH_FILES)
-
-maintainer-clean-generic:
-	@echo "This command is intended for maintainers to use"
-	@echo "it deletes files that may require special tools to rebuild."
-clean: clean-am
-
-clean-am: clean-generic clean-noinstLIBRARIES mostlyclean-am
-
-distclean: distclean-am
-	-rm -rf ./$(DEPDIR)
-	-rm -f Makefile
-distclean-am: clean-am distclean-compile distclean-generic \
-	distclean-tags
-
-dvi: dvi-am
-
-dvi-am:
-
-html: html-am
-
-html-am:
-
-info: info-am
-
-info-am:
-
-install-data-am:
-
-install-dvi: install-dvi-am
-
-install-dvi-am:
-
-install-exec-am:
-
-install-html: install-html-am
-
-install-html-am:
-
-install-info: install-info-am
-
-install-info-am:
-
-install-man:
-
-install-pdf: install-pdf-am
-
-install-pdf-am:
-
-install-ps: install-ps-am
-
-install-ps-am:
-
-installcheck-am:
-
-maintainer-clean: maintainer-clean-am
-	-rm -rf ./$(DEPDIR)
-	-rm -f Makefile
-maintainer-clean-am: distclean-am maintainer-clean-generic
-
-mostlyclean: mostlyclean-am
-
-mostlyclean-am: mostlyclean-compile mostlyclean-generic
-
-pdf: pdf-am
-
-pdf-am:
-
-ps: ps-am
-
-ps-am:
-
-uninstall-am:
-
-.MAKE: install-am install-strip
-
-.PHONY: CTAGS GTAGS all all-am check check-am clean clean-generic \
-	clean-noinstLIBRARIES ctags distclean distclean-compile \
-	distclean-generic distclean-tags distdir dvi dvi-am html \
-	html-am info info-am install install-am install-data \
-	install-data-am install-dvi install-dvi-am install-exec \
-	install-exec-am install-html install-html-am install-info \
-	install-info-am install-man install-pdf install-pdf-am \
-	install-ps install-ps-am install-strip installcheck \
-	installcheck-am installdirs maintainer-clean \
-	maintainer-clean-generic mostlyclean mostlyclean-compile \
-	mostlyclean-generic pdf pdf-am ps ps-am tags uninstall \
-	uninstall-am
-
-
-# Tell versions [3.59,3.63) of GNU make to not export all variables.
-# Otherwise a system limit (for SysV at least) may be exceeded.
-.NOEXPORT:
diff -Nur dosbox-0.74/src/shell/shell_batch.cpp dosbox-0.74.patch/src/shell/shell_batch.cpp
--- dosbox-0.74/src/shell/shell_batch.cpp	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/shell/shell_batch.cpp	2016-12-11 18:35:15.558284005 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: shell_batch.cpp,v 1.36 2009-07-03 19:36:56 qbix79 Exp $ */
 
 #include <stdlib.h>
 #include <string.h>
diff -Nur dosbox-0.74/src/shell/shell_cmds.cpp dosbox-0.74.patch/src/shell/shell_cmds.cpp
--- dosbox-0.74/src/shell/shell_cmds.cpp	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/shell/shell_cmds.cpp	2016-12-11 18:35:15.558284005 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,12 +16,12 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: shell_cmds.cpp,v 1.93 2009-09-21 21:04:25 h-a-l-9000 Exp $ */
 
 #include "dosbox.h"
 #include "shell.h"
 #include "callback.h"
 #include "regs.h"
+#include "bios.h"
 #include "../dos/drives.h"
 #include "support.h"
 #include "control.h"
@@ -30,6 +30,7 @@
 #include <cstdlib>
 #include <vector>
 #include <string>
+#include <time.h>
 
 static SHELL_Cmd cmd_list[]={
 {	"DIR",		0,			&DOS_Shell::CMD_DIR,		"SHELL_CMD_DIR_HELP"},
@@ -40,6 +41,7 @@
 {	"CHOICE",	1,			&DOS_Shell::CMD_CHOICE,		"SHELL_CMD_CHOICE_HELP"},
 {	"CLS",		0,			&DOS_Shell::CMD_CLS,		"SHELL_CMD_CLS_HELP"},
 {	"COPY",		0,			&DOS_Shell::CMD_COPY,		"SHELL_CMD_COPY_HELP"},
+{	"DATE",		0,			&DOS_Shell::CMD_DATE,		"SHELL_CMD_DATE_HELP"},
 {	"DEL",		0,			&DOS_Shell::CMD_DELETE,		"SHELL_CMD_DELETE_HELP"},
 {	"DELETE",	1,			&DOS_Shell::CMD_DELETE,		"SHELL_CMD_DELETE_HELP"},
 {	"ERASE",	1,			&DOS_Shell::CMD_DELETE,		"SHELL_CMD_DELETE_HELP"},
@@ -62,6 +64,7 @@
 {	"SET",		1,			&DOS_Shell::CMD_SET,		"SHELL_CMD_SET_HELP"},
 {	"SHIFT",	1,			&DOS_Shell::CMD_SHIFT,		"SHELL_CMD_SHIFT_HELP"},
 {	"SUBST",	1,			&DOS_Shell::CMD_SUBST,		"SHELL_CMD_SUBST_HELP"},
+{	"TIME",		0,			&DOS_Shell::CMD_TIME,		"SHELL_CMD_TIME_HELP"},
 {	"TYPE",		0,			&DOS_Shell::CMD_TYPE,		"SHELL_CMD_TYPE_HELP"},
 {	"VER",		0,			&DOS_Shell::CMD_VER,		"SHELL_CMD_VER_HELP"},
 {0,0,0,0}
@@ -108,7 +111,7 @@
 		if(val != NO_SUCH_PROPERTY) WriteOut("%s\n",val.c_str());
 		return true;
 	}
-	char newcom[1024]; newcom[0] = 0; strcpy(newcom,"z:\\config ");
+	char newcom[1024]; newcom[0] = 0; strcpy(newcom,"z:\\config -set ");
 	strcat(newcom,test->GetName());	strcat(newcom," ");
 	strcat(newcom,cmd_in);strcat(newcom,line);
 	DoCommand(newcom);
@@ -121,11 +124,12 @@
 	char cmd_buffer[CMD_MAXLINE];
 	char * cmd_write=cmd_buffer;
 	while (*line) {
-		if (*line==32) break;
-		if (*line=='/') break;
-		if (*line=='\t') break;
-		if (*line=='=') break;
-		if ((*line=='.') ||(*line =='\\')) {  //allow stuff like cd.. and dir.exe cd\kees
+		if (*line == 32) break;
+		if (*line == '/') break;
+		if (*line == '\t') break;
+		if (*line == '=') break;
+//		if (*line == ':') break; //This breaks drive switching as that is handled at a later stage. 
+		if ((*line == '.') ||(*line == '\\')) {  //allow stuff like cd.. and dir.exe cd\kees
 			*cmd_write=0;
 			Bit32u cmd_index=0;
 			while (cmd_list[cmd_index].name) {
@@ -285,7 +289,7 @@
 	args++;//skip first character. either a slash or dot or space
 	size_t len = strlen(args); //TODO check input of else ook nodig is.
 	if(len && args[len - 1] == '\r') {
-		LOG(LOG_MISC,LOG_WARN)("Hu ? carriage return allready present. Is this possible?");
+		LOG(LOG_MISC,LOG_WARN)("Hu ? carriage return already present. Is this possible?");
 		WriteOut("%s\n",args);
 	} else WriteOut("%s\r\n",args);
 }
@@ -366,8 +370,8 @@
 	}
 }
 
-static void FormatNumber(Bitu num,char * buf) {
-	Bitu numm,numk,numb,numg;
+static void FormatNumber(Bit32u num,char * buf) {
+	Bit32u numm,numk,numb,numg;
 	numb=num % 1000;
 	num/=1000;
 	numk=num % 1000;
@@ -571,6 +575,7 @@
 	while(ScanCMDBool(args,"A")) ;
 	ScanCMDBool(args,"Y");
 	ScanCMDBool(args,"-Y");
+	ScanCMDBool(args,"V");
 
 	char * rem=ScanCMDRemain(args);
 	if (rem) {
@@ -586,6 +591,14 @@
 	while ( (source_p = StripWord(args)) && *source_p ) {
 		do {
 			char* plus = strchr(source_p,'+');
+			// If StripWord() previously cut at a space before a plus then
+			// set concatenate flag on last source and remove leading plus.
+			if (plus == source_p && sources.size()) {
+				sources[sources.size()-1].concat = true;
+				// If spaces also followed plus then item is only a plus.
+				if (strlen(++source_p)==0) break;
+				plus = strchr(source_p,'+');
+			}
 			if (plus) *plus++ = 0;
 			safe_strncpy(source_x,source_p,CROSS_LEN);
 			bool has_drive_spec = false;
@@ -593,10 +606,10 @@
 			if (source_x_len>0) {
 				if (source_x[source_x_len-1]==':') has_drive_spec = true;
 			}
-			if (!has_drive_spec) {
+			if (!has_drive_spec  && !strpbrk(source_p,"*?") ) { //doubt that fu*\*.* is valid
 				if (DOS_FindFirst(source_p,0xffff & ~DOS_ATTR_VOLUME)) {
 					dta.GetResult(name,size,date,time,attr);
-					if (attr & DOS_ATTR_DIRECTORY && !strstr(source_p,"*.*"))
+					if (attr & DOS_ATTR_DIRECTORY)
 						strcat(source_x,"\\*.*");
 				}
 			}
@@ -739,6 +752,11 @@
 		}
 		return;
 	}
+	//There are args:
+	char * pcheck = args;
+	while ( *pcheck && (*pcheck == ' ' || *pcheck == '\t')) pcheck++;
+	if (*pcheck && strlen(pcheck) >3 && (strncasecmp(pcheck,"/p ",3) == 0)) E_Exit("Set /P is not supported. Use Choice!");
+
 	char * p=strpbrk(args, "=");
 	if (!p) {
 		if (!GetEnvStr(args,line)) WriteOut(MSG_Get("SHELL_CMD_SET_NOT_SET"),args);
@@ -930,6 +948,107 @@
 	this->call=false;
 }
 
+void DOS_Shell::CMD_DATE(char * args) {
+	HELP("DATE");	
+	if(ScanCMDBool(args,"H")) {
+		// synchronize date with host parameter
+		time_t curtime;
+		struct tm *loctime;
+		curtime = time (NULL);
+		loctime = localtime (&curtime);
+		
+		reg_cx = loctime->tm_year+1900;
+		reg_dh = loctime->tm_mon+1;
+		reg_dl = loctime->tm_mday;
+
+		reg_ah=0x2b; // set system date
+		CALLBACK_RunRealInt(0x21);
+		return;
+	}
+	// check if a date was passed in command line
+	Bit32u newday,newmonth,newyear;
+	if(sscanf(args,"%u-%u-%u",&newmonth,&newday,&newyear)==3) {
+		reg_cx = static_cast<Bit16u>(newyear);
+		reg_dh = static_cast<Bit8u>(newmonth);
+		reg_dl = static_cast<Bit8u>(newday);
+
+		reg_ah=0x2b; // set system date
+		CALLBACK_RunRealInt(0x21);
+		if(reg_al==0xff) WriteOut(MSG_Get("SHELL_CMD_DATE_ERROR"));
+		return;
+	}
+	// display the current date
+	reg_ah=0x2a; // get system date
+	CALLBACK_RunRealInt(0x21);
+
+	const char* datestring = MSG_Get("SHELL_CMD_DATE_DAYS");
+	Bit32u length;
+	char day[6] = {0};
+	if(sscanf(datestring,"%u",&length) && (length<5) && (strlen(datestring)==(length*7+1))) {
+		// date string appears valid
+		for(Bit32u i = 0; i < length; i++) day[i] = datestring[reg_al*length+1+i];
+	}
+	bool dateonly = ScanCMDBool(args,"T");
+	if(!dateonly) WriteOut(MSG_Get("SHELL_CMD_DATE_NOW"));
+
+	const char* formatstring = MSG_Get("SHELL_CMD_DATE_FORMAT");
+	if(strlen(formatstring)!=5) return;
+	char buffer[15] = {0};
+	Bitu bufferptr=0;
+	for(Bitu i = 0; i < 5; i++) {
+		if(i==1 || i==3) {
+			buffer[bufferptr] = formatstring[i];
+			bufferptr++;
+		} else {
+			if(formatstring[i]=='M') bufferptr += sprintf(buffer+bufferptr,"%02u",(Bit8u) reg_dh);
+			if(formatstring[i]=='D') bufferptr += sprintf(buffer+bufferptr,"%02u",(Bit8u) reg_dl);
+			if(formatstring[i]=='Y') bufferptr += sprintf(buffer+bufferptr,"%04u",(Bit16u) reg_cx);
+		}
+	}
+	WriteOut("%s %s\n",day, buffer);
+	if(!dateonly) WriteOut(MSG_Get("SHELL_CMD_DATE_SETHLP"));
+};
+
+void DOS_Shell::CMD_TIME(char * args) {
+	HELP("TIME");
+	if(ScanCMDBool(args,"H")) {
+		// synchronize time with host parameter
+		time_t curtime;
+		struct tm *loctime;
+		curtime = time (NULL);
+		loctime = localtime (&curtime);
+		
+		//reg_cx = loctime->;
+		//reg_dh = loctime->;
+		//reg_dl = loctime->;
+
+		// reg_ah=0x2d; // set system time TODO
+		// CALLBACK_RunRealInt(0x21);
+		
+		Bit32u ticks=(Bit32u)(((double)(loctime->tm_hour*3600+
+										loctime->tm_min*60+
+										loctime->tm_sec))*18.206481481);
+		mem_writed(BIOS_TIMER,ticks);
+		return;
+	}
+	bool timeonly = ScanCMDBool(args,"T");
+
+	reg_ah=0x2c; // get system time
+	CALLBACK_RunRealInt(0x21);
+/*
+		reg_dl= // 1/100 seconds
+		reg_dh= // seconds
+		reg_cl= // minutes
+		reg_ch= // hours
+*/
+	if(timeonly) {
+		WriteOut("%2u:%02u\n",reg_ch,reg_cl);
+	} else {
+		WriteOut(MSG_Get("SHELL_CMD_TIME_NOW"));
+		WriteOut("%2u:%02u:%02u,%02u\n",reg_ch,reg_cl,reg_dh,reg_dl);
+	}
+};
+
 void DOS_Shell::CMD_SUBST (char * args) {
 /* If more that one type can be substed think of something else 
  * E.g. make basedir member dos_drive instead of localdrive
@@ -945,17 +1064,22 @@
 		CommandLine command(0,args);
 
 		if (command.GetCount() != 2) throw 0 ;
-		command.FindCommand(2,arg);
-		if((arg=="/D" ) || (arg=="/d")) throw 1; //No removal (one day)
   
 		command.FindCommand(1,arg);
 		if( (arg.size()>1) && arg[1] !=':')  throw(0);
 		temp_str[0]=(char)toupper(args[0]);
+		command.FindCommand(2,arg);
+		if((arg=="/D") || (arg=="/d")) {
+			if(!Drives[temp_str[0]-'A'] ) throw 1; //targetdrive not in use
+			strcat(mountstring,"-u ");
+			strcat(mountstring,temp_str);
+			this->ParseLine(mountstring);
+			return;
+		}
 		if(Drives[temp_str[0]-'A'] ) throw 0; //targetdrive in use
 		strcat(mountstring,temp_str);
 		strcat(mountstring," ");
 
-		command.FindCommand(2,arg);
    		Bit8u drive;char fulldir[DOS_PATHLENGTH];
 		if (!DOS_MakeName(const_cast<char*>(arg.c_str()),fulldir,&drive)) throw 0;
 	
diff -Nur dosbox-0.74/src/shell/shell.cpp dosbox-0.74.patch/src/shell/shell.cpp
--- dosbox-0.74/src/shell/shell.cpp	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/shell/shell.cpp	2016-12-11 18:35:15.558284005 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: shell.cpp,v 1.100 2009-07-08 20:05:41 c2woody Exp $ */
 
 #include <stdlib.h>
 #include <stdarg.h>
@@ -50,14 +49,14 @@
 void VFILE_Remove(const char *name);
 
 void AutoexecObject::Install(const std::string &in) {
-	if(GCC_UNLIKELY(installed)) E_Exit("autoexec: allready created %s",buf.c_str());
+	if(GCC_UNLIKELY(installed)) E_Exit("autoexec: already created %s",buf.c_str());
 	installed = true;
 	buf = in;
 	autoexec_strings.push_back(buf);
 	this->CreateAutoexec();
 
 	//autoexec.bat is normally created AUTOEXEC_Init.
-	//But if we are allready running (first_shell)
+	//But if we are already running (first_shell)
 	//we have to update the envirionment to display changes
 
 	if(first_shell)	{
@@ -78,7 +77,7 @@
 }
 
 void AutoexecObject::InstallBefore(const std::string &in) {
-	if(GCC_UNLIKELY(installed)) E_Exit("autoexec: allready created %s",buf.c_str());
+	if(GCC_UNLIKELY(installed)) E_Exit("autoexec: already created %s",buf.c_str());
 	installed = true;
 	buf = in;
 	autoexec_strings.push_front(buf);
@@ -286,7 +285,7 @@
 void DOS_Shell::Run(void) {
 	char input_line[CMD_MAXLINE] = {0};
 	std::string line;
-	if (cmd->FindStringRemain("/C",line)) {
+	if (cmd->FindStringRemainBegin("/C",line)) {
 		strcpy(input_line,line.c_str());
 		char* sep = strpbrk(input_line,"\r\n"); //GTA installer
 		if (sep) *sep = 0;
@@ -412,7 +411,7 @@
 				if (access(buffer,F_OK)) goto nomount;
 				autoexec[12].Install(std::string("MOUNT C \"") + buffer + "\"");
 				autoexec[13].Install("C:");
-				/* Save the non modified filename (so boot and imgmount can use it (long filenames, case sensivitive)*/
+				/* Save the non-modified filename (so boot and imgmount can use it (long filenames, case sensivitive)) */
 				strcpy(orig,name);
 				upcase(name);
 				if(strstr(name,".BAT") != 0) {
@@ -425,10 +424,11 @@
 					/* Boot image files */
 					autoexec[15].Install(std::string("BOOT ") + orig);
 				} else if((strstr(name,".ISO") != 0) || (strstr(name,".CUE") !=0 )) {
-					if(secure) autoexec[14].Install("z:\\config.com -securemode");
 					/* imgmount CD image files */
-					autoexec[15].Install(std::string("IMGMOUNT D \"") + orig + std::string("\" -t iso"));
+					/* securemode gets a different number from the previous branches! */
+					autoexec[14].Install(std::string("IMGMOUNT D \"") + orig + std::string("\" -t iso"));
 					//autoexec[16].Install("D:");
+					if(secure) autoexec[15].Install("z:\\config.com -securemode");
 					/* Makes no sense to exit here */
 				} else {
 					if(secure) autoexec[14].Install("z:\\config.com -securemode");
@@ -465,6 +465,23 @@
 	MSG_Add("SHELL_CMD_CHDIR_HINT","To change to different drive type \033[31m%c:\033[0m\n");
 	MSG_Add("SHELL_CMD_CHDIR_HINT_2","directoryname is longer than 8 characters and/or contains spaces.\nTry \033[31mcd %s\033[0m\n");
 	MSG_Add("SHELL_CMD_CHDIR_HINT_3","You are still on drive Z:, change to a mounted drive with \033[31mC:\033[0m.\n");
+	MSG_Add("SHELL_CMD_DATE_HELP","Displays or changes the internal date.\n");
+	MSG_Add("SHELL_CMD_DATE_ERROR","The specified date is not correct.\n");
+	MSG_Add("SHELL_CMD_DATE_DAYS","3SunMonTueWedThuFriSat"); // "2SoMoDiMiDoFrSa"
+	MSG_Add("SHELL_CMD_DATE_NOW","Current date: ");
+	MSG_Add("SHELL_CMD_DATE_SETHLP","Type 'date MM-DD-YYYY' to change.\n");
+	MSG_Add("SHELL_CMD_DATE_FORMAT","M/D/Y");
+	MSG_Add("SHELL_CMD_DATE_HELP_LONG","DATE [[/T] [/H] [/S] | MM-DD-YYYY]\n"\
+									"  MM-DD-YYYY: new date to set\n"\
+									"  /S:         Permanently use host time and date as DOS time\n"\
+                                    "  /F:         Switch back to DOSBox internal time (opposite of /S)\n"\
+									"  /T:         Only display date\n"\
+									"  /H:         Synchronize with host\n");
+	MSG_Add("SHELL_CMD_TIME_HELP","Displays the internal time.\n");
+	MSG_Add("SHELL_CMD_TIME_NOW","Current time: ");
+	MSG_Add("SHELL_CMD_TIME_HELP_LONG","TIME [/T] [/H]\n"\
+									"  /T:         Display simple time\n"\
+									"  /H:         Synchronize with host\n");
 	MSG_Add("SHELL_CMD_MKDIR_ERROR","Unable to make: %s.\n");
 	MSG_Add("SHELL_CMD_RMDIR_ERROR","Unable to remove: %s.\n");
 	MSG_Add("SHELL_CMD_DEL_ERROR","Unable to delete: %s.\n");
@@ -487,14 +504,14 @@
 	MSG_Add("SHELL_CMD_PAUSE_HELP","Waits for 1 keystroke to continue.\n");
 	MSG_Add("SHELL_CMD_COPY_FAILURE","Copy failure : %s.\n");
 	MSG_Add("SHELL_CMD_COPY_SUCCESS","   %d File(s) copied.\n");
-	MSG_Add("SHELL_CMD_SUBST_NO_REMOVE","Removing drive not supported. Doing nothing.\n");
+	MSG_Add("SHELL_CMD_SUBST_NO_REMOVE","Unable to remove, drive not in use.\n");
 	MSG_Add("SHELL_CMD_SUBST_FAILURE","SUBST failed. You either made an error in your commandline or the target drive is already used.\nIt's only possible to use SUBST on Local drives");
 
 	MSG_Add("SHELL_STARTUP_BEGIN",
 		"\033[44;1m\xC9\xCD\xCD\xCD\xCD\xCD\xCD\xCD\xCD\xCD\xCD\xCD\xCD\xCD\xCD\xCD\xCD\xCD\xCD\xCD\xCD\xCD\xCD\xCD"
 		"\xCD\xCD\xCD\xCD\xCD\xCD\xCD\xCD\xCD\xCD\xCD\xCD\xCD\xCD\xCD\xCD\xCD\xCD\xCD\xCD\xCD\xCD\xCD\xCD"
 		"\xCD\xCD\xCD\xCD\xCD\xCD\xCD\xCD\xCD\xCD\xCD\xCD\xCD\xCD\xCD\xCD\xCD\xCD\xCD\xCD\xCD\xBB\n"
-		"\xBA \033[32mWelcome to DOSBox v%-8s\033[37m                                        \xBA\n"
+		"\xBA \033[32mWelcome to DOSBox %-8s\033[37m                                         \xBA\n"
 		"\xBA                                                                    \xBA\n"
 //		"\xBA DOSBox runs real and protected mode games.                         \xBA\n"
 		"\xBA For a short introduction for new users type: \033[33mINTRO\033[37m                 \xBA\n"
@@ -506,7 +523,8 @@
 		"\xBA                                                                    \xBA\n"
 	);
 	MSG_Add("SHELL_STARTUP_CGA","\xBA DOSBox supports Composite CGA mode.                                \xBA\n"
-	        "\xBA Use \033[31m(alt-)F11\033[37m to change the colours when in this mode.             \xBA\n"
+	        "\xBA Use \033[31mF12\033[37m to set composite output ON, OFF, or AUTO (default).        \xBA\n"
+	        "\xBA \033[31m(Alt-)F11\033[37m changes hue; \033[31mctrl-alt-F11\033[37m selects early/late CGA model.  \xBA\n"
 	        "\xBA                                                                    \xBA\n"
 	);
 	MSG_Add("SHELL_STARTUP_HERC","\xBA Use \033[31mF11\033[37m to cycle through white, amber, and green monochrome color. \xBA\n"
@@ -633,7 +651,7 @@
 	DOS_ForceDuplicateEntry(1,0);				/* "new" STDIN */
 	DOS_ForceDuplicateEntry(1,2);				/* STDERR */
 	DOS_OpenFile("CON",OPEN_READWRITE,&dummy);	/* STDAUX */
-	DOS_OpenFile("CON",OPEN_READWRITE,&dummy);	/* STDPRN */
+	DOS_OpenFile("PRN",OPEN_READWRITE,&dummy);	/* STDPRN */
 
 	psp.SetParent(psp_seg);
 	/* Set the environment */
diff -Nur dosbox-0.74/src/shell/shell_misc.cpp dosbox-0.74.patch/src/shell/shell_misc.cpp
--- dosbox-0.74/src/shell/shell_misc.cpp	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/shell/shell_misc.cpp	2016-12-11 18:35:15.558284005 +0100
@@ -1,5 +1,5 @@
 /*
- *  Copyright (C) 2002-2010  The DOSBox Team
+ *  Copyright (C) 2002-2013  The DOSBox Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -16,7 +16,6 @@
  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
  */
 
-/* $Id: shell_misc.cpp,v 1.54 2009-05-27 09:15:42 qbix79 Exp $ */
 
 #include <stdlib.h>
 #include <string.h>
@@ -57,7 +56,7 @@
 			Bit16u dummy;
 			DOS_CloseFile(input_handle);
 			DOS_OpenFile("con",2,&dummy);
-			LOG(LOG_MISC,LOG_ERROR)("Reopening the input handle.This is a bug!");
+			LOG(LOG_MISC,LOG_ERROR)("Reopening the input handle. This is a bug!");
 		}
 		if (!n) {
 			size=0;			//Kill the while loop
@@ -175,6 +174,24 @@
 						size++;
 					}
 					break;
+				case 15:		/* Shift-Tab */
+					if (l_completion.size()) {
+						if (it_completion == l_completion.begin()) it_completion = l_completion.end (); 
+						it_completion--;
+		
+						if (it_completion->length()) {
+							for (;str_index > completion_index; str_index--) {
+								// removes all characters
+								outc(8); outc(' '); outc(8);
+							}
+
+							strcpy(&line[completion_index], it_completion->c_str());
+							len = (Bit16u)it_completion->length();
+							str_len = str_index = completion_index + len;
+							size = CMD_MAXLINE - str_index - 2;
+							DOS_WriteFile(STDOUT, (Bit8u *)it_completion->c_str(), &len);
+						}
+					}
 				default:
 					break;
 				}
@@ -282,7 +299,7 @@
 						}
 						res=DOS_FindNext();
 					}
-					/* Add excutable list to front of completion list. */
+					/* Add executable list to front of completion list. */
 					std::copy(executable.begin(),executable.end(),std::front_inserter(l_completion));
 					it_completion = l_completion.begin();
 					dos.dta(save_dta);
@@ -456,7 +473,7 @@
 		/* Fill the command line */
 		CommandTail cmdtail;
 		cmdtail.count = 0;
-		memset(&cmdtail.buffer,0,126); //Else some part of the string is unitialized (valgrind)
+		memset(&cmdtail.buffer,0,127); //Else some part of the string is unitialized (valgrind)
 		if (strlen(line)>126) line[126]=0;
 		cmdtail.count=(Bit8u)strlen(line);
 		memcpy(cmdtail.buffer,line,strlen(line));
diff -Nur dosbox-0.74/src/winres.rc dosbox-0.74.patch/src/winres.rc
--- dosbox-0.74/src/winres.rc	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/src/winres.rc	2016-12-11 18:35:15.558284005 +0100
@@ -19,12 +19,12 @@
     BEGIN
         BLOCK "040904b0"
         BEGIN
-            VALUE "Comments", " 2002-2010 DOSBox Team, published under GNU GPL"
+            VALUE "Comments", " 2002-2013 DOSBox Team, published under GNU GPL"
             VALUE "CompanyName", "DOSBox Team"
             VALUE "FileDescription", "DOSBox DOS Emulator"
             VALUE "FileVersion", "0, 74, 0, 0"
             VALUE "InternalName", "DOSBox"
-            VALUE "LegalCopyright", "Copyright  2002-2010 DOSBox Team"
+            VALUE "LegalCopyright", "Copyright  2002-2013 DOSBox Team"
             VALUE "OriginalFilename", "dosbox.exe"
             VALUE "ProductName", "DOSBox DOS Emulator"
             VALUE "ProductVersion", "0, 74, 0, 0"
diff -Nur dosbox-0.74/update-to-74-2.patch dosbox-0.74.patch/update-to-74-2.patch
--- dosbox-0.74/update-to-74-2.patch	1970-01-01 01:00:00.000000000 +0100
+++ dosbox-0.74.patch/update-to-74-2.patch	2016-12-11 18:33:35.000000000 +0100
@@ -0,0 +1,53409 @@
+diff -Nur dosbox-0.74/acinclude.m4 dosbox/acinclude.m4
+--- dosbox-0.74/acinclude.m4	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/acinclude.m4	2014-01-12 14:43:47.000000000 +0100
+@@ -305,7 +305,7 @@
+ 
+ AH_TOP([
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+diff -Nur dosbox-0.74/aclocal.m4 dosbox/aclocal.m4
+--- dosbox-0.74/aclocal.m4	2010-05-10 20:59:01.000000000 +0200
++++ dosbox/aclocal.m4	1970-01-01 01:00:00.000000000 +0100
+@@ -1,964 +0,0 @@
+-# generated automatically by aclocal 1.11.1 -*- Autoconf -*-
+-
+-# Copyright (C) 1996, 1997, 1998, 1999, 2000, 2001, 2002, 2003, 2004,
+-# 2005, 2006, 2007, 2008, 2009  Free Software Foundation, Inc.
+-# This file is free software; the Free Software Foundation
+-# gives unlimited permission to copy and/or distribute it,
+-# with or without modifications, as long as this notice is preserved.
+-
+-# This program is distributed in the hope that it will be useful,
+-# but WITHOUT ANY WARRANTY, to the extent permitted by law; without
+-# even the implied warranty of MERCHANTABILITY or FITNESS FOR A
+-# PARTICULAR PURPOSE.
+-
+-m4_ifndef([AC_AUTOCONF_VERSION],
+-  [m4_copy([m4_PACKAGE_VERSION], [AC_AUTOCONF_VERSION])])dnl
+-m4_if(m4_defn([AC_AUTOCONF_VERSION]), [2.65],,
+-[m4_warning([this file was generated for autoconf 2.65.
+-You have another version of autoconf.  It may work, but is not guaranteed to.
+-If you have problems, you may need to regenerate the build system entirely.
+-To do so, use the procedure documented by the package, typically `autoreconf'.])])
+-
+-# Copyright (C) 2002, 2003, 2005, 2006, 2007, 2008  Free Software Foundation, Inc.
+-#
+-# This file is free software; the Free Software Foundation
+-# gives unlimited permission to copy and/or distribute it,
+-# with or without modifications, as long as this notice is preserved.
+-
+-# AM_AUTOMAKE_VERSION(VERSION)
+-# ----------------------------
+-# Automake X.Y traces this macro to ensure aclocal.m4 has been
+-# generated from the m4 files accompanying Automake X.Y.
+-# (This private macro should not be called outside this file.)
+-AC_DEFUN([AM_AUTOMAKE_VERSION],
+-[am__api_version='1.11'
+-dnl Some users find AM_AUTOMAKE_VERSION and mistake it for a way to
+-dnl require some minimum version.  Point them to the right macro.
+-m4_if([$1], [1.11.1], [],
+-      [AC_FATAL([Do not call $0, use AM_INIT_AUTOMAKE([$1]).])])dnl
+-])
+-
+-# _AM_AUTOCONF_VERSION(VERSION)
+-# -----------------------------
+-# aclocal traces this macro to find the Autoconf version.
+-# This is a private macro too.  Using m4_define simplifies
+-# the logic in aclocal, which can simply ignore this definition.
+-m4_define([_AM_AUTOCONF_VERSION], [])
+-
+-# AM_SET_CURRENT_AUTOMAKE_VERSION
+-# -------------------------------
+-# Call AM_AUTOMAKE_VERSION and AM_AUTOMAKE_VERSION so they can be traced.
+-# This function is AC_REQUIREd by AM_INIT_AUTOMAKE.
+-AC_DEFUN([AM_SET_CURRENT_AUTOMAKE_VERSION],
+-[AM_AUTOMAKE_VERSION([1.11.1])dnl
+-m4_ifndef([AC_AUTOCONF_VERSION],
+-  [m4_copy([m4_PACKAGE_VERSION], [AC_AUTOCONF_VERSION])])dnl
+-_AM_AUTOCONF_VERSION(m4_defn([AC_AUTOCONF_VERSION]))])
+-
+-# AM_AUX_DIR_EXPAND                                         -*- Autoconf -*-
+-
+-# Copyright (C) 2001, 2003, 2005  Free Software Foundation, Inc.
+-#
+-# This file is free software; the Free Software Foundation
+-# gives unlimited permission to copy and/or distribute it,
+-# with or without modifications, as long as this notice is preserved.
+-
+-# For projects using AC_CONFIG_AUX_DIR([foo]), Autoconf sets
+-# $ac_aux_dir to `$srcdir/foo'.  In other projects, it is set to
+-# `$srcdir', `$srcdir/..', or `$srcdir/../..'.
+-#
+-# Of course, Automake must honor this variable whenever it calls a
+-# tool from the auxiliary directory.  The problem is that $srcdir (and
+-# therefore $ac_aux_dir as well) can be either absolute or relative,
+-# depending on how configure is run.  This is pretty annoying, since
+-# it makes $ac_aux_dir quite unusable in subdirectories: in the top
+-# source directory, any form will work fine, but in subdirectories a
+-# relative path needs to be adjusted first.
+-#
+-# $ac_aux_dir/missing
+-#    fails when called from a subdirectory if $ac_aux_dir is relative
+-# $top_srcdir/$ac_aux_dir/missing
+-#    fails if $ac_aux_dir is absolute,
+-#    fails when called from a subdirectory in a VPATH build with
+-#          a relative $ac_aux_dir
+-#
+-# The reason of the latter failure is that $top_srcdir and $ac_aux_dir
+-# are both prefixed by $srcdir.  In an in-source build this is usually
+-# harmless because $srcdir is `.', but things will broke when you
+-# start a VPATH build or use an absolute $srcdir.
+-#
+-# So we could use something similar to $top_srcdir/$ac_aux_dir/missing,
+-# iff we strip the leading $srcdir from $ac_aux_dir.  That would be:
+-#   am_aux_dir='\$(top_srcdir)/'`expr "$ac_aux_dir" : "$srcdir//*\(.*\)"`
+-# and then we would define $MISSING as
+-#   MISSING="\${SHELL} $am_aux_dir/missing"
+-# This will work as long as MISSING is not called from configure, because
+-# unfortunately $(top_srcdir) has no meaning in configure.
+-# However there are other variables, like CC, which are often used in
+-# configure, and could therefore not use this "fixed" $ac_aux_dir.
+-#
+-# Another solution, used here, is to always expand $ac_aux_dir to an
+-# absolute PATH.  The drawback is that using absolute paths prevent a
+-# configured tree to be moved without reconfiguration.
+-
+-AC_DEFUN([AM_AUX_DIR_EXPAND],
+-[dnl Rely on autoconf to set up CDPATH properly.
+-AC_PREREQ([2.50])dnl
+-# expand $ac_aux_dir to an absolute path
+-am_aux_dir=`cd $ac_aux_dir && pwd`
+-])
+-
+-# AM_CONDITIONAL                                            -*- Autoconf -*-
+-
+-# Copyright (C) 1997, 2000, 2001, 2003, 2004, 2005, 2006, 2008
+-# Free Software Foundation, Inc.
+-#
+-# This file is free software; the Free Software Foundation
+-# gives unlimited permission to copy and/or distribute it,
+-# with or without modifications, as long as this notice is preserved.
+-
+-# serial 9
+-
+-# AM_CONDITIONAL(NAME, SHELL-CONDITION)
+-# -------------------------------------
+-# Define a conditional.
+-AC_DEFUN([AM_CONDITIONAL],
+-[AC_PREREQ(2.52)dnl
+- ifelse([$1], [TRUE],  [AC_FATAL([$0: invalid condition: $1])],
+-	[$1], [FALSE], [AC_FATAL([$0: invalid condition: $1])])dnl
+-AC_SUBST([$1_TRUE])dnl
+-AC_SUBST([$1_FALSE])dnl
+-_AM_SUBST_NOTMAKE([$1_TRUE])dnl
+-_AM_SUBST_NOTMAKE([$1_FALSE])dnl
+-m4_define([_AM_COND_VALUE_$1], [$2])dnl
+-if $2; then
+-  $1_TRUE=
+-  $1_FALSE='#'
+-else
+-  $1_TRUE='#'
+-  $1_FALSE=
+-fi
+-AC_CONFIG_COMMANDS_PRE(
+-[if test -z "${$1_TRUE}" && test -z "${$1_FALSE}"; then
+-  AC_MSG_ERROR([[conditional "$1" was never defined.
+-Usually this means the macro was only invoked conditionally.]])
+-fi])])
+-
+-# Copyright (C) 1999, 2000, 2001, 2002, 2003, 2004, 2005, 2006, 2009
+-# Free Software Foundation, Inc.
+-#
+-# This file is free software; the Free Software Foundation
+-# gives unlimited permission to copy and/or distribute it,
+-# with or without modifications, as long as this notice is preserved.
+-
+-# serial 10
+-
+-# There are a few dirty hacks below to avoid letting `AC_PROG_CC' be
+-# written in clear, in which case automake, when reading aclocal.m4,
+-# will think it sees a *use*, and therefore will trigger all it's
+-# C support machinery.  Also note that it means that autoscan, seeing
+-# CC etc. in the Makefile, will ask for an AC_PROG_CC use...
+-
+-
+-# _AM_DEPENDENCIES(NAME)
+-# ----------------------
+-# See how the compiler implements dependency checking.
+-# NAME is "CC", "CXX", "GCJ", or "OBJC".
+-# We try a few techniques and use that to set a single cache variable.
+-#
+-# We don't AC_REQUIRE the corresponding AC_PROG_CC since the latter was
+-# modified to invoke _AM_DEPENDENCIES(CC); we would have a circular
+-# dependency, and given that the user is not expected to run this macro,
+-# just rely on AC_PROG_CC.
+-AC_DEFUN([_AM_DEPENDENCIES],
+-[AC_REQUIRE([AM_SET_DEPDIR])dnl
+-AC_REQUIRE([AM_OUTPUT_DEPENDENCY_COMMANDS])dnl
+-AC_REQUIRE([AM_MAKE_INCLUDE])dnl
+-AC_REQUIRE([AM_DEP_TRACK])dnl
+-
+-ifelse([$1], CC,   [depcc="$CC"   am_compiler_list=],
+-       [$1], CXX,  [depcc="$CXX"  am_compiler_list=],
+-       [$1], OBJC, [depcc="$OBJC" am_compiler_list='gcc3 gcc'],
+-       [$1], UPC,  [depcc="$UPC"  am_compiler_list=],
+-       [$1], GCJ,  [depcc="$GCJ"  am_compiler_list='gcc3 gcc'],
+-                   [depcc="$$1"   am_compiler_list=])
+-
+-AC_CACHE_CHECK([dependency style of $depcc],
+-               [am_cv_$1_dependencies_compiler_type],
+-[if test -z "$AMDEP_TRUE" && test -f "$am_depcomp"; then
+-  # We make a subdir and do the tests there.  Otherwise we can end up
+-  # making bogus files that we don't know about and never remove.  For
+-  # instance it was reported that on HP-UX the gcc test will end up
+-  # making a dummy file named `D' -- because `-MD' means `put the output
+-  # in D'.
+-  mkdir conftest.dir
+-  # Copy depcomp to subdir because otherwise we won't find it if we're
+-  # using a relative directory.
+-  cp "$am_depcomp" conftest.dir
+-  cd conftest.dir
+-  # We will build objects and dependencies in a subdirectory because
+-  # it helps to detect inapplicable dependency modes.  For instance
+-  # both Tru64's cc and ICC support -MD to output dependencies as a
+-  # side effect of compilation, but ICC will put the dependencies in
+-  # the current directory while Tru64 will put them in the object
+-  # directory.
+-  mkdir sub
+-
+-  am_cv_$1_dependencies_compiler_type=none
+-  if test "$am_compiler_list" = ""; then
+-     am_compiler_list=`sed -n ['s/^#*\([a-zA-Z0-9]*\))$/\1/p'] < ./depcomp`
+-  fi
+-  am__universal=false
+-  m4_case([$1], [CC],
+-    [case " $depcc " in #(
+-     *\ -arch\ *\ -arch\ *) am__universal=true ;;
+-     esac],
+-    [CXX],
+-    [case " $depcc " in #(
+-     *\ -arch\ *\ -arch\ *) am__universal=true ;;
+-     esac])
+-
+-  for depmode in $am_compiler_list; do
+-    # Setup a source with many dependencies, because some compilers
+-    # like to wrap large dependency lists on column 80 (with \), and
+-    # we should not choose a depcomp mode which is confused by this.
+-    #
+-    # We need to recreate these files for each test, as the compiler may
+-    # overwrite some of them when testing with obscure command lines.
+-    # This happens at least with the AIX C compiler.
+-    : > sub/conftest.c
+-    for i in 1 2 3 4 5 6; do
+-      echo '#include "conftst'$i'.h"' >> sub/conftest.c
+-      # Using `: > sub/conftst$i.h' creates only sub/conftst1.h with
+-      # Solaris 8's {/usr,}/bin/sh.
+-      touch sub/conftst$i.h
+-    done
+-    echo "${am__include} ${am__quote}sub/conftest.Po${am__quote}" > confmf
+-
+-    # We check with `-c' and `-o' for the sake of the "dashmstdout"
+-    # mode.  It turns out that the SunPro C++ compiler does not properly
+-    # handle `-M -o', and we need to detect this.  Also, some Intel
+-    # versions had trouble with output in subdirs
+-    am__obj=sub/conftest.${OBJEXT-o}
+-    am__minus_obj="-o $am__obj"
+-    case $depmode in
+-    gcc)
+-      # This depmode causes a compiler race in universal mode.
+-      test "$am__universal" = false || continue
+-      ;;
+-    nosideeffect)
+-      # after this tag, mechanisms are not by side-effect, so they'll
+-      # only be used when explicitly requested
+-      if test "x$enable_dependency_tracking" = xyes; then
+-	continue
+-      else
+-	break
+-      fi
+-      ;;
+-    msvisualcpp | msvcmsys)
+-      # This compiler won't grok `-c -o', but also, the minuso test has
+-      # not run yet.  These depmodes are late enough in the game, and
+-      # so weak that their functioning should not be impacted.
+-      am__obj=conftest.${OBJEXT-o}
+-      am__minus_obj=
+-      ;;
+-    none) break ;;
+-    esac
+-    if depmode=$depmode \
+-       source=sub/conftest.c object=$am__obj \
+-       depfile=sub/conftest.Po tmpdepfile=sub/conftest.TPo \
+-       $SHELL ./depcomp $depcc -c $am__minus_obj sub/conftest.c \
+-         >/dev/null 2>conftest.err &&
+-       grep sub/conftst1.h sub/conftest.Po > /dev/null 2>&1 &&
+-       grep sub/conftst6.h sub/conftest.Po > /dev/null 2>&1 &&
+-       grep $am__obj sub/conftest.Po > /dev/null 2>&1 &&
+-       ${MAKE-make} -s -f confmf > /dev/null 2>&1; then
+-      # icc doesn't choke on unknown options, it will just issue warnings
+-      # or remarks (even with -Werror).  So we grep stderr for any message
+-      # that says an option was ignored or not supported.
+-      # When given -MP, icc 7.0 and 7.1 complain thusly:
+-      #   icc: Command line warning: ignoring option '-M'; no argument required
+-      # The diagnosis changed in icc 8.0:
+-      #   icc: Command line remark: option '-MP' not supported
+-      if (grep 'ignoring option' conftest.err ||
+-          grep 'not supported' conftest.err) >/dev/null 2>&1; then :; else
+-        am_cv_$1_dependencies_compiler_type=$depmode
+-        break
+-      fi
+-    fi
+-  done
+-
+-  cd ..
+-  rm -rf conftest.dir
+-else
+-  am_cv_$1_dependencies_compiler_type=none
+-fi
+-])
+-AC_SUBST([$1DEPMODE], [depmode=$am_cv_$1_dependencies_compiler_type])
+-AM_CONDITIONAL([am__fastdep$1], [
+-  test "x$enable_dependency_tracking" != xno \
+-  && test "$am_cv_$1_dependencies_compiler_type" = gcc3])
+-])
+-
+-
+-# AM_SET_DEPDIR
+-# -------------
+-# Choose a directory name for dependency files.
+-# This macro is AC_REQUIREd in _AM_DEPENDENCIES
+-AC_DEFUN([AM_SET_DEPDIR],
+-[AC_REQUIRE([AM_SET_LEADING_DOT])dnl
+-AC_SUBST([DEPDIR], ["${am__leading_dot}deps"])dnl
+-])
+-
+-
+-# AM_DEP_TRACK
+-# ------------
+-AC_DEFUN([AM_DEP_TRACK],
+-[AC_ARG_ENABLE(dependency-tracking,
+-[  --disable-dependency-tracking  speeds up one-time build
+-  --enable-dependency-tracking   do not reject slow dependency extractors])
+-if test "x$enable_dependency_tracking" != xno; then
+-  am_depcomp="$ac_aux_dir/depcomp"
+-  AMDEPBACKSLASH='\'
+-fi
+-AM_CONDITIONAL([AMDEP], [test "x$enable_dependency_tracking" != xno])
+-AC_SUBST([AMDEPBACKSLASH])dnl
+-_AM_SUBST_NOTMAKE([AMDEPBACKSLASH])dnl
+-])
+-
+-# Generate code to set up dependency tracking.              -*- Autoconf -*-
+-
+-# Copyright (C) 1999, 2000, 2001, 2002, 2003, 2004, 2005, 2008
+-# Free Software Foundation, Inc.
+-#
+-# This file is free software; the Free Software Foundation
+-# gives unlimited permission to copy and/or distribute it,
+-# with or without modifications, as long as this notice is preserved.
+-
+-#serial 5
+-
+-# _AM_OUTPUT_DEPENDENCY_COMMANDS
+-# ------------------------------
+-AC_DEFUN([_AM_OUTPUT_DEPENDENCY_COMMANDS],
+-[{
+-  # Autoconf 2.62 quotes --file arguments for eval, but not when files
+-  # are listed without --file.  Let's play safe and only enable the eval
+-  # if we detect the quoting.
+-  case $CONFIG_FILES in
+-  *\'*) eval set x "$CONFIG_FILES" ;;
+-  *)   set x $CONFIG_FILES ;;
+-  esac
+-  shift
+-  for mf
+-  do
+-    # Strip MF so we end up with the name of the file.
+-    mf=`echo "$mf" | sed -e 's/:.*$//'`
+-    # Check whether this is an Automake generated Makefile or not.
+-    # We used to match only the files named `Makefile.in', but
+-    # some people rename them; so instead we look at the file content.
+-    # Grep'ing the first line is not enough: some people post-process
+-    # each Makefile.in and add a new line on top of each file to say so.
+-    # Grep'ing the whole file is not good either: AIX grep has a line
+-    # limit of 2048, but all sed's we know have understand at least 4000.
+-    if sed -n 's,^#.*generated by automake.*,X,p' "$mf" | grep X >/dev/null 2>&1; then
+-      dirpart=`AS_DIRNAME("$mf")`
+-    else
+-      continue
+-    fi
+-    # Extract the definition of DEPDIR, am__include, and am__quote
+-    # from the Makefile without running `make'.
+-    DEPDIR=`sed -n 's/^DEPDIR = //p' < "$mf"`
+-    test -z "$DEPDIR" && continue
+-    am__include=`sed -n 's/^am__include = //p' < "$mf"`
+-    test -z "am__include" && continue
+-    am__quote=`sed -n 's/^am__quote = //p' < "$mf"`
+-    # When using ansi2knr, U may be empty or an underscore; expand it
+-    U=`sed -n 's/^U = //p' < "$mf"`
+-    # Find all dependency output files, they are included files with
+-    # $(DEPDIR) in their names.  We invoke sed twice because it is the
+-    # simplest approach to changing $(DEPDIR) to its actual value in the
+-    # expansion.
+-    for file in `sed -n "
+-      s/^$am__include $am__quote\(.*(DEPDIR).*\)$am__quote"'$/\1/p' <"$mf" | \
+-	 sed -e 's/\$(DEPDIR)/'"$DEPDIR"'/g' -e 's/\$U/'"$U"'/g'`; do
+-      # Make sure the directory exists.
+-      test -f "$dirpart/$file" && continue
+-      fdir=`AS_DIRNAME(["$file"])`
+-      AS_MKDIR_P([$dirpart/$fdir])
+-      # echo "creating $dirpart/$file"
+-      echo '# dummy' > "$dirpart/$file"
+-    done
+-  done
+-}
+-])# _AM_OUTPUT_DEPENDENCY_COMMANDS
+-
+-
+-# AM_OUTPUT_DEPENDENCY_COMMANDS
+-# -----------------------------
+-# This macro should only be invoked once -- use via AC_REQUIRE.
+-#
+-# This code is only required when automatic dependency tracking
+-# is enabled.  FIXME.  This creates each `.P' file that we will
+-# need in order to bootstrap the dependency handling code.
+-AC_DEFUN([AM_OUTPUT_DEPENDENCY_COMMANDS],
+-[AC_CONFIG_COMMANDS([depfiles],
+-     [test x"$AMDEP_TRUE" != x"" || _AM_OUTPUT_DEPENDENCY_COMMANDS],
+-     [AMDEP_TRUE="$AMDEP_TRUE" ac_aux_dir="$ac_aux_dir"])
+-])
+-
+-# Copyright (C) 1996, 1997, 2000, 2001, 2003, 2005
+-# Free Software Foundation, Inc.
+-#
+-# This file is free software; the Free Software Foundation
+-# gives unlimited permission to copy and/or distribute it,
+-# with or without modifications, as long as this notice is preserved.
+-
+-# serial 8
+-
+-# AM_CONFIG_HEADER is obsolete.  It has been replaced by AC_CONFIG_HEADERS.
+-AU_DEFUN([AM_CONFIG_HEADER], [AC_CONFIG_HEADERS($@)])
+-
+-# Do all the work for Automake.                             -*- Autoconf -*-
+-
+-# Copyright (C) 1996, 1997, 1998, 1999, 2000, 2001, 2002, 2003, 2004,
+-# 2005, 2006, 2008, 2009 Free Software Foundation, Inc.
+-#
+-# This file is free software; the Free Software Foundation
+-# gives unlimited permission to copy and/or distribute it,
+-# with or without modifications, as long as this notice is preserved.
+-
+-# serial 16
+-
+-# This macro actually does too much.  Some checks are only needed if
+-# your package does certain things.  But this isn't really a big deal.
+-
+-# AM_INIT_AUTOMAKE(PACKAGE, VERSION, [NO-DEFINE])
+-# AM_INIT_AUTOMAKE([OPTIONS])
+-# -----------------------------------------------
+-# The call with PACKAGE and VERSION arguments is the old style
+-# call (pre autoconf-2.50), which is being phased out.  PACKAGE
+-# and VERSION should now be passed to AC_INIT and removed from
+-# the call to AM_INIT_AUTOMAKE.
+-# We support both call styles for the transition.  After
+-# the next Automake release, Autoconf can make the AC_INIT
+-# arguments mandatory, and then we can depend on a new Autoconf
+-# release and drop the old call support.
+-AC_DEFUN([AM_INIT_AUTOMAKE],
+-[AC_PREREQ([2.62])dnl
+-dnl Autoconf wants to disallow AM_ names.  We explicitly allow
+-dnl the ones we care about.
+-m4_pattern_allow([^AM_[A-Z]+FLAGS$])dnl
+-AC_REQUIRE([AM_SET_CURRENT_AUTOMAKE_VERSION])dnl
+-AC_REQUIRE([AC_PROG_INSTALL])dnl
+-if test "`cd $srcdir && pwd`" != "`pwd`"; then
+-  # Use -I$(srcdir) only when $(srcdir) != ., so that make's output
+-  # is not polluted with repeated "-I."
+-  AC_SUBST([am__isrc], [' -I$(srcdir)'])_AM_SUBST_NOTMAKE([am__isrc])dnl
+-  # test to see if srcdir already configured
+-  if test -f $srcdir/config.status; then
+-    AC_MSG_ERROR([source directory already configured; run "make distclean" there first])
+-  fi
+-fi
+-
+-# test whether we have cygpath
+-if test -z "$CYGPATH_W"; then
+-  if (cygpath --version) >/dev/null 2>/dev/null; then
+-    CYGPATH_W='cygpath -w'
+-  else
+-    CYGPATH_W=echo
+-  fi
+-fi
+-AC_SUBST([CYGPATH_W])
+-
+-# Define the identity of the package.
+-dnl Distinguish between old-style and new-style calls.
+-m4_ifval([$2],
+-[m4_ifval([$3], [_AM_SET_OPTION([no-define])])dnl
+- AC_SUBST([PACKAGE], [$1])dnl
+- AC_SUBST([VERSION], [$2])],
+-[_AM_SET_OPTIONS([$1])dnl
+-dnl Diagnose old-style AC_INIT with new-style AM_AUTOMAKE_INIT.
+-m4_if(m4_ifdef([AC_PACKAGE_NAME], 1)m4_ifdef([AC_PACKAGE_VERSION], 1), 11,,
+-  [m4_fatal([AC_INIT should be called with package and version arguments])])dnl
+- AC_SUBST([PACKAGE], ['AC_PACKAGE_TARNAME'])dnl
+- AC_SUBST([VERSION], ['AC_PACKAGE_VERSION'])])dnl
+-
+-_AM_IF_OPTION([no-define],,
+-[AC_DEFINE_UNQUOTED(PACKAGE, "$PACKAGE", [Name of package])
+- AC_DEFINE_UNQUOTED(VERSION, "$VERSION", [Version number of package])])dnl
+-
+-# Some tools Automake needs.
+-AC_REQUIRE([AM_SANITY_CHECK])dnl
+-AC_REQUIRE([AC_ARG_PROGRAM])dnl
+-AM_MISSING_PROG(ACLOCAL, aclocal-${am__api_version})
+-AM_MISSING_PROG(AUTOCONF, autoconf)
+-AM_MISSING_PROG(AUTOMAKE, automake-${am__api_version})
+-AM_MISSING_PROG(AUTOHEADER, autoheader)
+-AM_MISSING_PROG(MAKEINFO, makeinfo)
+-AC_REQUIRE([AM_PROG_INSTALL_SH])dnl
+-AC_REQUIRE([AM_PROG_INSTALL_STRIP])dnl
+-AC_REQUIRE([AM_PROG_MKDIR_P])dnl
+-# We need awk for the "check" target.  The system "awk" is bad on
+-# some platforms.
+-AC_REQUIRE([AC_PROG_AWK])dnl
+-AC_REQUIRE([AC_PROG_MAKE_SET])dnl
+-AC_REQUIRE([AM_SET_LEADING_DOT])dnl
+-_AM_IF_OPTION([tar-ustar], [_AM_PROG_TAR([ustar])],
+-	      [_AM_IF_OPTION([tar-pax], [_AM_PROG_TAR([pax])],
+-			     [_AM_PROG_TAR([v7])])])
+-_AM_IF_OPTION([no-dependencies],,
+-[AC_PROVIDE_IFELSE([AC_PROG_CC],
+-		  [_AM_DEPENDENCIES(CC)],
+-		  [define([AC_PROG_CC],
+-			  defn([AC_PROG_CC])[_AM_DEPENDENCIES(CC)])])dnl
+-AC_PROVIDE_IFELSE([AC_PROG_CXX],
+-		  [_AM_DEPENDENCIES(CXX)],
+-		  [define([AC_PROG_CXX],
+-			  defn([AC_PROG_CXX])[_AM_DEPENDENCIES(CXX)])])dnl
+-AC_PROVIDE_IFELSE([AC_PROG_OBJC],
+-		  [_AM_DEPENDENCIES(OBJC)],
+-		  [define([AC_PROG_OBJC],
+-			  defn([AC_PROG_OBJC])[_AM_DEPENDENCIES(OBJC)])])dnl
+-])
+-_AM_IF_OPTION([silent-rules], [AC_REQUIRE([AM_SILENT_RULES])])dnl
+-dnl The `parallel-tests' driver may need to know about EXEEXT, so add the
+-dnl `am__EXEEXT' conditional if _AM_COMPILER_EXEEXT was seen.  This macro
+-dnl is hooked onto _AC_COMPILER_EXEEXT early, see below.
+-AC_CONFIG_COMMANDS_PRE(dnl
+-[m4_provide_if([_AM_COMPILER_EXEEXT],
+-  [AM_CONDITIONAL([am__EXEEXT], [test -n "$EXEEXT"])])])dnl
+-])
+-
+-dnl Hook into `_AC_COMPILER_EXEEXT' early to learn its expansion.  Do not
+-dnl add the conditional right here, as _AC_COMPILER_EXEEXT may be further
+-dnl mangled by Autoconf and run in a shell conditional statement.
+-m4_define([_AC_COMPILER_EXEEXT],
+-m4_defn([_AC_COMPILER_EXEEXT])[m4_provide([_AM_COMPILER_EXEEXT])])
+-
+-
+-# When config.status generates a header, we must update the stamp-h file.
+-# This file resides in the same directory as the config header
+-# that is generated.  The stamp files are numbered to have different names.
+-
+-# Autoconf calls _AC_AM_CONFIG_HEADER_HOOK (when defined) in the
+-# loop where config.status creates the headers, so we can generate
+-# our stamp files there.
+-AC_DEFUN([_AC_AM_CONFIG_HEADER_HOOK],
+-[# Compute $1's index in $config_headers.
+-_am_arg=$1
+-_am_stamp_count=1
+-for _am_header in $config_headers :; do
+-  case $_am_header in
+-    $_am_arg | $_am_arg:* )
+-      break ;;
+-    * )
+-      _am_stamp_count=`expr $_am_stamp_count + 1` ;;
+-  esac
+-done
+-echo "timestamp for $_am_arg" >`AS_DIRNAME(["$_am_arg"])`/stamp-h[]$_am_stamp_count])
+-
+-# Copyright (C) 2001, 2003, 2005, 2008  Free Software Foundation, Inc.
+-#
+-# This file is free software; the Free Software Foundation
+-# gives unlimited permission to copy and/or distribute it,
+-# with or without modifications, as long as this notice is preserved.
+-
+-# AM_PROG_INSTALL_SH
+-# ------------------
+-# Define $install_sh.
+-AC_DEFUN([AM_PROG_INSTALL_SH],
+-[AC_REQUIRE([AM_AUX_DIR_EXPAND])dnl
+-if test x"${install_sh}" != xset; then
+-  case $am_aux_dir in
+-  *\ * | *\	*)
+-    install_sh="\${SHELL} '$am_aux_dir/install-sh'" ;;
+-  *)
+-    install_sh="\${SHELL} $am_aux_dir/install-sh"
+-  esac
+-fi
+-AC_SUBST(install_sh)])
+-
+-# Copyright (C) 2003, 2005  Free Software Foundation, Inc.
+-#
+-# This file is free software; the Free Software Foundation
+-# gives unlimited permission to copy and/or distribute it,
+-# with or without modifications, as long as this notice is preserved.
+-
+-# serial 2
+-
+-# Check whether the underlying file-system supports filenames
+-# with a leading dot.  For instance MS-DOS doesn't.
+-AC_DEFUN([AM_SET_LEADING_DOT],
+-[rm -rf .tst 2>/dev/null
+-mkdir .tst 2>/dev/null
+-if test -d .tst; then
+-  am__leading_dot=.
+-else
+-  am__leading_dot=_
+-fi
+-rmdir .tst 2>/dev/null
+-AC_SUBST([am__leading_dot])])
+-
+-# Check to see how 'make' treats includes.	            -*- Autoconf -*-
+-
+-# Copyright (C) 2001, 2002, 2003, 2005, 2009  Free Software Foundation, Inc.
+-#
+-# This file is free software; the Free Software Foundation
+-# gives unlimited permission to copy and/or distribute it,
+-# with or without modifications, as long as this notice is preserved.
+-
+-# serial 4
+-
+-# AM_MAKE_INCLUDE()
+-# -----------------
+-# Check to see how make treats includes.
+-AC_DEFUN([AM_MAKE_INCLUDE],
+-[am_make=${MAKE-make}
+-cat > confinc << 'END'
+-am__doit:
+-	@echo this is the am__doit target
+-.PHONY: am__doit
+-END
+-# If we don't find an include directive, just comment out the code.
+-AC_MSG_CHECKING([for style of include used by $am_make])
+-am__include="#"
+-am__quote=
+-_am_result=none
+-# First try GNU make style include.
+-echo "include confinc" > confmf
+-# Ignore all kinds of additional output from `make'.
+-case `$am_make -s -f confmf 2> /dev/null` in #(
+-*the\ am__doit\ target*)
+-  am__include=include
+-  am__quote=
+-  _am_result=GNU
+-  ;;
+-esac
+-# Now try BSD make style include.
+-if test "$am__include" = "#"; then
+-   echo '.include "confinc"' > confmf
+-   case `$am_make -s -f confmf 2> /dev/null` in #(
+-   *the\ am__doit\ target*)
+-     am__include=.include
+-     am__quote="\""
+-     _am_result=BSD
+-     ;;
+-   esac
+-fi
+-AC_SUBST([am__include])
+-AC_SUBST([am__quote])
+-AC_MSG_RESULT([$_am_result])
+-rm -f confinc confmf
+-])
+-
+-# Fake the existence of programs that GNU maintainers use.  -*- Autoconf -*-
+-
+-# Copyright (C) 1997, 1999, 2000, 2001, 2003, 2004, 2005, 2008
+-# Free Software Foundation, Inc.
+-#
+-# This file is free software; the Free Software Foundation
+-# gives unlimited permission to copy and/or distribute it,
+-# with or without modifications, as long as this notice is preserved.
+-
+-# serial 6
+-
+-# AM_MISSING_PROG(NAME, PROGRAM)
+-# ------------------------------
+-AC_DEFUN([AM_MISSING_PROG],
+-[AC_REQUIRE([AM_MISSING_HAS_RUN])
+-$1=${$1-"${am_missing_run}$2"}
+-AC_SUBST($1)])
+-
+-
+-# AM_MISSING_HAS_RUN
+-# ------------------
+-# Define MISSING if not defined so far and test if it supports --run.
+-# If it does, set am_missing_run to use it, otherwise, to nothing.
+-AC_DEFUN([AM_MISSING_HAS_RUN],
+-[AC_REQUIRE([AM_AUX_DIR_EXPAND])dnl
+-AC_REQUIRE_AUX_FILE([missing])dnl
+-if test x"${MISSING+set}" != xset; then
+-  case $am_aux_dir in
+-  *\ * | *\	*)
+-    MISSING="\${SHELL} \"$am_aux_dir/missing\"" ;;
+-  *)
+-    MISSING="\${SHELL} $am_aux_dir/missing" ;;
+-  esac
+-fi
+-# Use eval to expand $SHELL
+-if eval "$MISSING --run true"; then
+-  am_missing_run="$MISSING --run "
+-else
+-  am_missing_run=
+-  AC_MSG_WARN([`missing' script is too old or missing])
+-fi
+-])
+-
+-# Copyright (C) 2003, 2004, 2005, 2006  Free Software Foundation, Inc.
+-#
+-# This file is free software; the Free Software Foundation
+-# gives unlimited permission to copy and/or distribute it,
+-# with or without modifications, as long as this notice is preserved.
+-
+-# AM_PROG_MKDIR_P
+-# ---------------
+-# Check for `mkdir -p'.
+-AC_DEFUN([AM_PROG_MKDIR_P],
+-[AC_PREREQ([2.60])dnl
+-AC_REQUIRE([AC_PROG_MKDIR_P])dnl
+-dnl Automake 1.8 to 1.9.6 used to define mkdir_p.  We now use MKDIR_P,
+-dnl while keeping a definition of mkdir_p for backward compatibility.
+-dnl @MKDIR_P@ is magic: AC_OUTPUT adjusts its value for each Makefile.
+-dnl However we cannot define mkdir_p as $(MKDIR_P) for the sake of
+-dnl Makefile.ins that do not define MKDIR_P, so we do our own
+-dnl adjustment using top_builddir (which is defined more often than
+-dnl MKDIR_P).
+-AC_SUBST([mkdir_p], ["$MKDIR_P"])dnl
+-case $mkdir_p in
+-  [[\\/$]]* | ?:[[\\/]]*) ;;
+-  */*) mkdir_p="\$(top_builddir)/$mkdir_p" ;;
+-esac
+-])
+-
+-# Helper functions for option handling.                     -*- Autoconf -*-
+-
+-# Copyright (C) 2001, 2002, 2003, 2005, 2008  Free Software Foundation, Inc.
+-#
+-# This file is free software; the Free Software Foundation
+-# gives unlimited permission to copy and/or distribute it,
+-# with or without modifications, as long as this notice is preserved.
+-
+-# serial 4
+-
+-# _AM_MANGLE_OPTION(NAME)
+-# -----------------------
+-AC_DEFUN([_AM_MANGLE_OPTION],
+-[[_AM_OPTION_]m4_bpatsubst($1, [[^a-zA-Z0-9_]], [_])])
+-
+-# _AM_SET_OPTION(NAME)
+-# ------------------------------
+-# Set option NAME.  Presently that only means defining a flag for this option.
+-AC_DEFUN([_AM_SET_OPTION],
+-[m4_define(_AM_MANGLE_OPTION([$1]), 1)])
+-
+-# _AM_SET_OPTIONS(OPTIONS)
+-# ----------------------------------
+-# OPTIONS is a space-separated list of Automake options.
+-AC_DEFUN([_AM_SET_OPTIONS],
+-[m4_foreach_w([_AM_Option], [$1], [_AM_SET_OPTION(_AM_Option)])])
+-
+-# _AM_IF_OPTION(OPTION, IF-SET, [IF-NOT-SET])
+-# -------------------------------------------
+-# Execute IF-SET if OPTION is set, IF-NOT-SET otherwise.
+-AC_DEFUN([_AM_IF_OPTION],
+-[m4_ifset(_AM_MANGLE_OPTION([$1]), [$2], [$3])])
+-
+-# Check to make sure that the build environment is sane.    -*- Autoconf -*-
+-
+-# Copyright (C) 1996, 1997, 2000, 2001, 2003, 2005, 2008
+-# Free Software Foundation, Inc.
+-#
+-# This file is free software; the Free Software Foundation
+-# gives unlimited permission to copy and/or distribute it,
+-# with or without modifications, as long as this notice is preserved.
+-
+-# serial 5
+-
+-# AM_SANITY_CHECK
+-# ---------------
+-AC_DEFUN([AM_SANITY_CHECK],
+-[AC_MSG_CHECKING([whether build environment is sane])
+-# Just in case
+-sleep 1
+-echo timestamp > conftest.file
+-# Reject unsafe characters in $srcdir or the absolute working directory
+-# name.  Accept space and tab only in the latter.
+-am_lf='
+-'
+-case `pwd` in
+-  *[[\\\"\#\$\&\'\`$am_lf]]*)
+-    AC_MSG_ERROR([unsafe absolute working directory name]);;
+-esac
+-case $srcdir in
+-  *[[\\\"\#\$\&\'\`$am_lf\ \	]]*)
+-    AC_MSG_ERROR([unsafe srcdir value: `$srcdir']);;
+-esac
+-
+-# Do `set' in a subshell so we don't clobber the current shell's
+-# arguments.  Must try -L first in case configure is actually a
+-# symlink; some systems play weird games with the mod time of symlinks
+-# (eg FreeBSD returns the mod time of the symlink's containing
+-# directory).
+-if (
+-   set X `ls -Lt "$srcdir/configure" conftest.file 2> /dev/null`
+-   if test "$[*]" = "X"; then
+-      # -L didn't work.
+-      set X `ls -t "$srcdir/configure" conftest.file`
+-   fi
+-   rm -f conftest.file
+-   if test "$[*]" != "X $srcdir/configure conftest.file" \
+-      && test "$[*]" != "X conftest.file $srcdir/configure"; then
+-
+-      # If neither matched, then we have a broken ls.  This can happen
+-      # if, for instance, CONFIG_SHELL is bash and it inherits a
+-      # broken ls alias from the environment.  This has actually
+-      # happened.  Such a system could not be considered "sane".
+-      AC_MSG_ERROR([ls -t appears to fail.  Make sure there is not a broken
+-alias in your environment])
+-   fi
+-
+-   test "$[2]" = conftest.file
+-   )
+-then
+-   # Ok.
+-   :
+-else
+-   AC_MSG_ERROR([newly created file is older than distributed files!
+-Check your system clock])
+-fi
+-AC_MSG_RESULT(yes)])
+-
+-# Copyright (C) 2001, 2003, 2005  Free Software Foundation, Inc.
+-#
+-# This file is free software; the Free Software Foundation
+-# gives unlimited permission to copy and/or distribute it,
+-# with or without modifications, as long as this notice is preserved.
+-
+-# AM_PROG_INSTALL_STRIP
+-# ---------------------
+-# One issue with vendor `install' (even GNU) is that you can't
+-# specify the program used to strip binaries.  This is especially
+-# annoying in cross-compiling environments, where the build's strip
+-# is unlikely to handle the host's binaries.
+-# Fortunately install-sh will honor a STRIPPROG variable, so we
+-# always use install-sh in `make install-strip', and initialize
+-# STRIPPROG with the value of the STRIP variable (set by the user).
+-AC_DEFUN([AM_PROG_INSTALL_STRIP],
+-[AC_REQUIRE([AM_PROG_INSTALL_SH])dnl
+-# Installed binaries are usually stripped using `strip' when the user
+-# run `make install-strip'.  However `strip' might not be the right
+-# tool to use in cross-compilation environments, therefore Automake
+-# will honor the `STRIP' environment variable to overrule this program.
+-dnl Don't test for $cross_compiling = yes, because it might be `maybe'.
+-if test "$cross_compiling" != no; then
+-  AC_CHECK_TOOL([STRIP], [strip], :)
+-fi
+-INSTALL_STRIP_PROGRAM="\$(install_sh) -c -s"
+-AC_SUBST([INSTALL_STRIP_PROGRAM])])
+-
+-# Copyright (C) 2006, 2008  Free Software Foundation, Inc.
+-#
+-# This file is free software; the Free Software Foundation
+-# gives unlimited permission to copy and/or distribute it,
+-# with or without modifications, as long as this notice is preserved.
+-
+-# serial 2
+-
+-# _AM_SUBST_NOTMAKE(VARIABLE)
+-# ---------------------------
+-# Prevent Automake from outputting VARIABLE = @VARIABLE@ in Makefile.in.
+-# This macro is traced by Automake.
+-AC_DEFUN([_AM_SUBST_NOTMAKE])
+-
+-# AM_SUBST_NOTMAKE(VARIABLE)
+-# ---------------------------
+-# Public sister of _AM_SUBST_NOTMAKE.
+-AC_DEFUN([AM_SUBST_NOTMAKE], [_AM_SUBST_NOTMAKE($@)])
+-
+-# Check how to create a tarball.                            -*- Autoconf -*-
+-
+-# Copyright (C) 2004, 2005  Free Software Foundation, Inc.
+-#
+-# This file is free software; the Free Software Foundation
+-# gives unlimited permission to copy and/or distribute it,
+-# with or without modifications, as long as this notice is preserved.
+-
+-# serial 2
+-
+-# _AM_PROG_TAR(FORMAT)
+-# --------------------
+-# Check how to create a tarball in format FORMAT.
+-# FORMAT should be one of `v7', `ustar', or `pax'.
+-#
+-# Substitute a variable $(am__tar) that is a command
+-# writing to stdout a FORMAT-tarball containing the directory
+-# $tardir.
+-#     tardir=directory && $(am__tar) > result.tar
+-#
+-# Substitute a variable $(am__untar) that extract such
+-# a tarball read from stdin.
+-#     $(am__untar) < result.tar
+-AC_DEFUN([_AM_PROG_TAR],
+-[# Always define AMTAR for backward compatibility.
+-AM_MISSING_PROG([AMTAR], [tar])
+-m4_if([$1], [v7],
+-     [am__tar='${AMTAR} chof - "$$tardir"'; am__untar='${AMTAR} xf -'],
+-     [m4_case([$1], [ustar],, [pax],,
+-              [m4_fatal([Unknown tar format])])
+-AC_MSG_CHECKING([how to create a $1 tar archive])
+-# Loop over all known methods to create a tar archive until one works.
+-_am_tools='gnutar m4_if([$1], [ustar], [plaintar]) pax cpio none'
+-_am_tools=${am_cv_prog_tar_$1-$_am_tools}
+-# Do not fold the above two line into one, because Tru64 sh and
+-# Solaris sh will not grok spaces in the rhs of `-'.
+-for _am_tool in $_am_tools
+-do
+-  case $_am_tool in
+-  gnutar)
+-    for _am_tar in tar gnutar gtar;
+-    do
+-      AM_RUN_LOG([$_am_tar --version]) && break
+-    done
+-    am__tar="$_am_tar --format=m4_if([$1], [pax], [posix], [$1]) -chf - "'"$$tardir"'
+-    am__tar_="$_am_tar --format=m4_if([$1], [pax], [posix], [$1]) -chf - "'"$tardir"'
+-    am__untar="$_am_tar -xf -"
+-    ;;
+-  plaintar)
+-    # Must skip GNU tar: if it does not support --format= it doesn't create
+-    # ustar tarball either.
+-    (tar --version) >/dev/null 2>&1 && continue
+-    am__tar='tar chf - "$$tardir"'
+-    am__tar_='tar chf - "$tardir"'
+-    am__untar='tar xf -'
+-    ;;
+-  pax)
+-    am__tar='pax -L -x $1 -w "$$tardir"'
+-    am__tar_='pax -L -x $1 -w "$tardir"'
+-    am__untar='pax -r'
+-    ;;
+-  cpio)
+-    am__tar='find "$$tardir" -print | cpio -o -H $1 -L'
+-    am__tar_='find "$tardir" -print | cpio -o -H $1 -L'
+-    am__untar='cpio -i -H $1 -d'
+-    ;;
+-  none)
+-    am__tar=false
+-    am__tar_=false
+-    am__untar=false
+-    ;;
+-  esac
+-
+-  # If the value was cached, stop now.  We just wanted to have am__tar
+-  # and am__untar set.
+-  test -n "${am_cv_prog_tar_$1}" && break
+-
+-  # tar/untar a dummy directory, and stop if the command works
+-  rm -rf conftest.dir
+-  mkdir conftest.dir
+-  echo GrepMe > conftest.dir/file
+-  AM_RUN_LOG([tardir=conftest.dir && eval $am__tar_ >conftest.tar])
+-  rm -rf conftest.dir
+-  if test -s conftest.tar; then
+-    AM_RUN_LOG([$am__untar <conftest.tar])
+-    grep GrepMe conftest.dir/file >/dev/null 2>&1 && break
+-  fi
+-done
+-rm -rf conftest.dir
+-
+-AC_CACHE_VAL([am_cv_prog_tar_$1], [am_cv_prog_tar_$1=$_am_tool])
+-AC_MSG_RESULT([$am_cv_prog_tar_$1])])
+-AC_SUBST([am__tar])
+-AC_SUBST([am__untar])
+-]) # _AM_PROG_TAR
+-
+-m4_include([acinclude.m4])
+diff -Nur dosbox-0.74/config.guess dosbox/config.guess
+--- dosbox-0.74/config.guess	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/config.guess	1970-01-01 01:00:00.000000000 +0100
+@@ -1,1502 +0,0 @@
+-#! /bin/sh
+-# Attempt to guess a canonical system name.
+-#   Copyright (C) 1992, 1993, 1994, 1995, 1996, 1997, 1998, 1999,
+-#   2000, 2001, 2002, 2003, 2004, 2005, 2006, 2007, 2008, 2009, 2010
+-#   Free Software Foundation, Inc.
+-
+-timestamp='2009-12-30'
+-
+-# This file is free software; you can redistribute it and/or modify it
+-# under the terms of the GNU General Public License as published by
+-# the Free Software Foundation; either version 2 of the License, or
+-# (at your option) any later version.
+-#
+-# This program is distributed in the hope that it will be useful, but
+-# WITHOUT ANY WARRANTY; without even the implied warranty of
+-# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
+-# General Public License for more details.
+-#
+-# You should have received a copy of the GNU General Public License
+-# along with this program; if not, write to the Free Software
+-# Foundation, Inc., 51 Franklin Street - Fifth Floor, Boston, MA
+-# 02110-1301, USA.
+-#
+-# As a special exception to the GNU General Public License, if you
+-# distribute this file as part of a program that contains a
+-# configuration script generated by Autoconf, you may include it under
+-# the same distribution terms that you use for the rest of that program.
+-
+-
+-# Originally written by Per Bothner.  Please send patches (context
+-# diff format) to <config-patches@gnu.org> and include a ChangeLog
+-# entry.
+-#
+-# This script attempts to guess a canonical system name similar to
+-# config.sub.  If it succeeds, it prints the system name on stdout, and
+-# exits with 0.  Otherwise, it exits with 1.
+-#
+-# You can get the latest version of this script from:
+-# http://git.savannah.gnu.org/gitweb/?p=config.git;a=blob_plain;f=config.guess;hb=HEAD
+-
+-me=`echo "$0" | sed -e 's,.*/,,'`
+-
+-usage="\
+-Usage: $0 [OPTION]
+-
+-Output the configuration name of the system \`$me' is run on.
+-
+-Operation modes:
+-  -h, --help         print this help, then exit
+-  -t, --time-stamp   print date of last modification, then exit
+-  -v, --version      print version number, then exit
+-
+-Report bugs and patches to <config-patches@gnu.org>."
+-
+-version="\
+-GNU config.guess ($timestamp)
+-
+-Originally written by Per Bothner.
+-Copyright (C) 1992, 1993, 1994, 1995, 1996, 1997, 1998, 1999, 2000,
+-2001, 2002, 2003, 2004, 2005, 2006, 2007, 2008, 2009, 2010 Free
+-Software Foundation, Inc.
+-
+-This is free software; see the source for copying conditions.  There is NO
+-warranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE."
+-
+-help="
+-Try \`$me --help' for more information."
+-
+-# Parse command line
+-while test $# -gt 0 ; do
+-  case $1 in
+-    --time-stamp | --time* | -t )
+-       echo "$timestamp" ; exit ;;
+-    --version | -v )
+-       echo "$version" ; exit ;;
+-    --help | --h* | -h )
+-       echo "$usage"; exit ;;
+-    -- )     # Stop option processing
+-       shift; break ;;
+-    - )	# Use stdin as input.
+-       break ;;
+-    -* )
+-       echo "$me: invalid option $1$help" >&2
+-       exit 1 ;;
+-    * )
+-       break ;;
+-  esac
+-done
+-
+-if test $# != 0; then
+-  echo "$me: too many arguments$help" >&2
+-  exit 1
+-fi
+-
+-trap 'exit 1' 1 2 15
+-
+-# CC_FOR_BUILD -- compiler used by this script. Note that the use of a
+-# compiler to aid in system detection is discouraged as it requires
+-# temporary files to be created and, as you can see below, it is a
+-# headache to deal with in a portable fashion.
+-
+-# Historically, `CC_FOR_BUILD' used to be named `HOST_CC'. We still
+-# use `HOST_CC' if defined, but it is deprecated.
+-
+-# Portable tmp directory creation inspired by the Autoconf team.
+-
+-set_cc_for_build='
+-trap "exitcode=\$?; (rm -f \$tmpfiles 2>/dev/null; rmdir \$tmp 2>/dev/null) && exit \$exitcode" 0 ;
+-trap "rm -f \$tmpfiles 2>/dev/null; rmdir \$tmp 2>/dev/null; exit 1" 1 2 13 15 ;
+-: ${TMPDIR=/tmp} ;
+- { tmp=`(umask 077 && mktemp -d "$TMPDIR/cgXXXXXX") 2>/dev/null` && test -n "$tmp" && test -d "$tmp" ; } ||
+- { test -n "$RANDOM" && tmp=$TMPDIR/cg$$-$RANDOM && (umask 077 && mkdir $tmp) ; } ||
+- { tmp=$TMPDIR/cg-$$ && (umask 077 && mkdir $tmp) && echo "Warning: creating insecure temp directory" >&2 ; } ||
+- { echo "$me: cannot create a temporary directory in $TMPDIR" >&2 ; exit 1 ; } ;
+-dummy=$tmp/dummy ;
+-tmpfiles="$dummy.c $dummy.o $dummy.rel $dummy" ;
+-case $CC_FOR_BUILD,$HOST_CC,$CC in
+- ,,)    echo "int x;" > $dummy.c ;
+-	for c in cc gcc c89 c99 ; do
+-	  if ($c -c -o $dummy.o $dummy.c) >/dev/null 2>&1 ; then
+-	     CC_FOR_BUILD="$c"; break ;
+-	  fi ;
+-	done ;
+-	if test x"$CC_FOR_BUILD" = x ; then
+-	  CC_FOR_BUILD=no_compiler_found ;
+-	fi
+-	;;
+- ,,*)   CC_FOR_BUILD=$CC ;;
+- ,*,*)  CC_FOR_BUILD=$HOST_CC ;;
+-esac ; set_cc_for_build= ;'
+-
+-# This is needed to find uname on a Pyramid OSx when run in the BSD universe.
+-# (ghazi@noc.rutgers.edu 1994-08-24)
+-if (test -f /.attbin/uname) >/dev/null 2>&1 ; then
+-	PATH=$PATH:/.attbin ; export PATH
+-fi
+-
+-UNAME_MACHINE=`(uname -m) 2>/dev/null` || UNAME_MACHINE=unknown
+-UNAME_RELEASE=`(uname -r) 2>/dev/null` || UNAME_RELEASE=unknown
+-UNAME_SYSTEM=`(uname -s) 2>/dev/null`  || UNAME_SYSTEM=unknown
+-UNAME_VERSION=`(uname -v) 2>/dev/null` || UNAME_VERSION=unknown
+-
+-# Note: order is significant - the case branches are not exclusive.
+-
+-case "${UNAME_MACHINE}:${UNAME_SYSTEM}:${UNAME_RELEASE}:${UNAME_VERSION}" in
+-    *:NetBSD:*:*)
+-	# NetBSD (nbsd) targets should (where applicable) match one or
+-	# more of the tupples: *-*-netbsdelf*, *-*-netbsdaout*,
+-	# *-*-netbsdecoff* and *-*-netbsd*.  For targets that recently
+-	# switched to ELF, *-*-netbsd* would select the old
+-	# object file format.  This provides both forward
+-	# compatibility and a consistent mechanism for selecting the
+-	# object file format.
+-	#
+-	# Note: NetBSD doesn't particularly care about the vendor
+-	# portion of the name.  We always set it to "unknown".
+-	sysctl="sysctl -n hw.machine_arch"
+-	UNAME_MACHINE_ARCH=`(/sbin/$sysctl 2>/dev/null || \
+-	    /usr/sbin/$sysctl 2>/dev/null || echo unknown)`
+-	case "${UNAME_MACHINE_ARCH}" in
+-	    armeb) machine=armeb-unknown ;;
+-	    arm*) machine=arm-unknown ;;
+-	    sh3el) machine=shl-unknown ;;
+-	    sh3eb) machine=sh-unknown ;;
+-	    sh5el) machine=sh5le-unknown ;;
+-	    *) machine=${UNAME_MACHINE_ARCH}-unknown ;;
+-	esac
+-	# The Operating System including object format, if it has switched
+-	# to ELF recently, or will in the future.
+-	case "${UNAME_MACHINE_ARCH}" in
+-	    arm*|i386|m68k|ns32k|sh3*|sparc|vax)
+-		eval $set_cc_for_build
+-		if echo __ELF__ | $CC_FOR_BUILD -E - 2>/dev/null \
+-			| grep -q __ELF__
+-		then
+-		    # Once all utilities can be ECOFF (netbsdecoff) or a.out (netbsdaout).
+-		    # Return netbsd for either.  FIX?
+-		    os=netbsd
+-		else
+-		    os=netbsdelf
+-		fi
+-		;;
+-	    *)
+-	        os=netbsd
+-		;;
+-	esac
+-	# The OS release
+-	# Debian GNU/NetBSD machines have a different userland, and
+-	# thus, need a distinct triplet. However, they do not need
+-	# kernel version information, so it can be replaced with a
+-	# suitable tag, in the style of linux-gnu.
+-	case "${UNAME_VERSION}" in
+-	    Debian*)
+-		release='-gnu'
+-		;;
+-	    *)
+-		release=`echo ${UNAME_RELEASE}|sed -e 's/[-_].*/\./'`
+-		;;
+-	esac
+-	# Since CPU_TYPE-MANUFACTURER-KERNEL-OPERATING_SYSTEM:
+-	# contains redundant information, the shorter form:
+-	# CPU_TYPE-MANUFACTURER-OPERATING_SYSTEM is used.
+-	echo "${machine}-${os}${release}"
+-	exit ;;
+-    *:OpenBSD:*:*)
+-	UNAME_MACHINE_ARCH=`arch | sed 's/OpenBSD.//'`
+-	echo ${UNAME_MACHINE_ARCH}-unknown-openbsd${UNAME_RELEASE}
+-	exit ;;
+-    *:ekkoBSD:*:*)
+-	echo ${UNAME_MACHINE}-unknown-ekkobsd${UNAME_RELEASE}
+-	exit ;;
+-    *:SolidBSD:*:*)
+-	echo ${UNAME_MACHINE}-unknown-solidbsd${UNAME_RELEASE}
+-	exit ;;
+-    macppc:MirBSD:*:*)
+-	echo powerpc-unknown-mirbsd${UNAME_RELEASE}
+-	exit ;;
+-    *:MirBSD:*:*)
+-	echo ${UNAME_MACHINE}-unknown-mirbsd${UNAME_RELEASE}
+-	exit ;;
+-    alpha:OSF1:*:*)
+-	case $UNAME_RELEASE in
+-	*4.0)
+-		UNAME_RELEASE=`/usr/sbin/sizer -v | awk '{print $3}'`
+-		;;
+-	*5.*)
+-	        UNAME_RELEASE=`/usr/sbin/sizer -v | awk '{print $4}'`
+-		;;
+-	esac
+-	# According to Compaq, /usr/sbin/psrinfo has been available on
+-	# OSF/1 and Tru64 systems produced since 1995.  I hope that
+-	# covers most systems running today.  This code pipes the CPU
+-	# types through head -n 1, so we only detect the type of CPU 0.
+-	ALPHA_CPU_TYPE=`/usr/sbin/psrinfo -v | sed -n -e 's/^  The alpha \(.*\) processor.*$/\1/p' | head -n 1`
+-	case "$ALPHA_CPU_TYPE" in
+-	    "EV4 (21064)")
+-		UNAME_MACHINE="alpha" ;;
+-	    "EV4.5 (21064)")
+-		UNAME_MACHINE="alpha" ;;
+-	    "LCA4 (21066/21068)")
+-		UNAME_MACHINE="alpha" ;;
+-	    "EV5 (21164)")
+-		UNAME_MACHINE="alphaev5" ;;
+-	    "EV5.6 (21164A)")
+-		UNAME_MACHINE="alphaev56" ;;
+-	    "EV5.6 (21164PC)")
+-		UNAME_MACHINE="alphapca56" ;;
+-	    "EV5.7 (21164PC)")
+-		UNAME_MACHINE="alphapca57" ;;
+-	    "EV6 (21264)")
+-		UNAME_MACHINE="alphaev6" ;;
+-	    "EV6.7 (21264A)")
+-		UNAME_MACHINE="alphaev67" ;;
+-	    "EV6.8CB (21264C)")
+-		UNAME_MACHINE="alphaev68" ;;
+-	    "EV6.8AL (21264B)")
+-		UNAME_MACHINE="alphaev68" ;;
+-	    "EV6.8CX (21264D)")
+-		UNAME_MACHINE="alphaev68" ;;
+-	    "EV6.9A (21264/EV69A)")
+-		UNAME_MACHINE="alphaev69" ;;
+-	    "EV7 (21364)")
+-		UNAME_MACHINE="alphaev7" ;;
+-	    "EV7.9 (21364A)")
+-		UNAME_MACHINE="alphaev79" ;;
+-	esac
+-	# A Pn.n version is a patched version.
+-	# A Vn.n version is a released version.
+-	# A Tn.n version is a released field test version.
+-	# A Xn.n version is an unreleased experimental baselevel.
+-	# 1.2 uses "1.2" for uname -r.
+-	echo ${UNAME_MACHINE}-dec-osf`echo ${UNAME_RELEASE} | sed -e 's/^[PVTX]//' | tr 'ABCDEFGHIJKLMNOPQRSTUVWXYZ' 'abcdefghijklmnopqrstuvwxyz'`
+-	exit ;;
+-    Alpha\ *:Windows_NT*:*)
+-	# How do we know it's Interix rather than the generic POSIX subsystem?
+-	# Should we change UNAME_MACHINE based on the output of uname instead
+-	# of the specific Alpha model?
+-	echo alpha-pc-interix
+-	exit ;;
+-    21064:Windows_NT:50:3)
+-	echo alpha-dec-winnt3.5
+-	exit ;;
+-    Amiga*:UNIX_System_V:4.0:*)
+-	echo m68k-unknown-sysv4
+-	exit ;;
+-    *:[Aa]miga[Oo][Ss]:*:*)
+-	echo ${UNAME_MACHINE}-unknown-amigaos
+-	exit ;;
+-    *:[Mm]orph[Oo][Ss]:*:*)
+-	echo ${UNAME_MACHINE}-unknown-morphos
+-	exit ;;
+-    *:OS/390:*:*)
+-	echo i370-ibm-openedition
+-	exit ;;
+-    *:z/VM:*:*)
+-	echo s390-ibm-zvmoe
+-	exit ;;
+-    *:OS400:*:*)
+-        echo powerpc-ibm-os400
+-	exit ;;
+-    arm:RISC*:1.[012]*:*|arm:riscix:1.[012]*:*)
+-	echo arm-acorn-riscix${UNAME_RELEASE}
+-	exit ;;
+-    arm:riscos:*:*|arm:RISCOS:*:*)
+-	echo arm-unknown-riscos
+-	exit ;;
+-    SR2?01:HI-UX/MPP:*:* | SR8000:HI-UX/MPP:*:*)
+-	echo hppa1.1-hitachi-hiuxmpp
+-	exit ;;
+-    Pyramid*:OSx*:*:* | MIS*:OSx*:*:* | MIS*:SMP_DC-OSx*:*:*)
+-	# akee@wpdis03.wpafb.af.mil (Earle F. Ake) contributed MIS and NILE.
+-	if test "`(/bin/universe) 2>/dev/null`" = att ; then
+-		echo pyramid-pyramid-sysv3
+-	else
+-		echo pyramid-pyramid-bsd
+-	fi
+-	exit ;;
+-    NILE*:*:*:dcosx)
+-	echo pyramid-pyramid-svr4
+-	exit ;;
+-    DRS?6000:unix:4.0:6*)
+-	echo sparc-icl-nx6
+-	exit ;;
+-    DRS?6000:UNIX_SV:4.2*:7* | DRS?6000:isis:4.2*:7*)
+-	case `/usr/bin/uname -p` in
+-	    sparc) echo sparc-icl-nx7; exit ;;
+-	esac ;;
+-    s390x:SunOS:*:*)
+-	echo ${UNAME_MACHINE}-ibm-solaris2`echo ${UNAME_RELEASE}|sed -e 's/[^.]*//'`
+-	exit ;;
+-    sun4H:SunOS:5.*:*)
+-	echo sparc-hal-solaris2`echo ${UNAME_RELEASE}|sed -e 's/[^.]*//'`
+-	exit ;;
+-    sun4*:SunOS:5.*:* | tadpole*:SunOS:5.*:*)
+-	echo sparc-sun-solaris2`echo ${UNAME_RELEASE}|sed -e 's/[^.]*//'`
+-	exit ;;
+-    i86pc:AuroraUX:5.*:* | i86xen:AuroraUX:5.*:*)
+-	echo i386-pc-auroraux${UNAME_RELEASE}
+-	exit ;;
+-    i86pc:SunOS:5.*:* | i86xen:SunOS:5.*:*)
+-	eval $set_cc_for_build
+-	SUN_ARCH="i386"
+-	# If there is a compiler, see if it is configured for 64-bit objects.
+-	# Note that the Sun cc does not turn __LP64__ into 1 like gcc does.
+-	# This test works for both compilers.
+-	if [ "$CC_FOR_BUILD" != 'no_compiler_found' ]; then
+-	    if (echo '#ifdef __amd64'; echo IS_64BIT_ARCH; echo '#endif') | \
+-		(CCOPTS= $CC_FOR_BUILD -E - 2>/dev/null) | \
+-		grep IS_64BIT_ARCH >/dev/null
+-	    then
+-		SUN_ARCH="x86_64"
+-	    fi
+-	fi
+-	echo ${SUN_ARCH}-pc-solaris2`echo ${UNAME_RELEASE}|sed -e 's/[^.]*//'`
+-	exit ;;
+-    sun4*:SunOS:6*:*)
+-	# According to config.sub, this is the proper way to canonicalize
+-	# SunOS6.  Hard to guess exactly what SunOS6 will be like, but
+-	# it's likely to be more like Solaris than SunOS4.
+-	echo sparc-sun-solaris3`echo ${UNAME_RELEASE}|sed -e 's/[^.]*//'`
+-	exit ;;
+-    sun4*:SunOS:*:*)
+-	case "`/usr/bin/arch -k`" in
+-	    Series*|S4*)
+-		UNAME_RELEASE=`uname -v`
+-		;;
+-	esac
+-	# Japanese Language versions have a version number like `4.1.3-JL'.
+-	echo sparc-sun-sunos`echo ${UNAME_RELEASE}|sed -e 's/-/_/'`
+-	exit ;;
+-    sun3*:SunOS:*:*)
+-	echo m68k-sun-sunos${UNAME_RELEASE}
+-	exit ;;
+-    sun*:*:4.2BSD:*)
+-	UNAME_RELEASE=`(sed 1q /etc/motd | awk '{print substr($5,1,3)}') 2>/dev/null`
+-	test "x${UNAME_RELEASE}" = "x" && UNAME_RELEASE=3
+-	case "`/bin/arch`" in
+-	    sun3)
+-		echo m68k-sun-sunos${UNAME_RELEASE}
+-		;;
+-	    sun4)
+-		echo sparc-sun-sunos${UNAME_RELEASE}
+-		;;
+-	esac
+-	exit ;;
+-    aushp:SunOS:*:*)
+-	echo sparc-auspex-sunos${UNAME_RELEASE}
+-	exit ;;
+-    # The situation for MiNT is a little confusing.  The machine name
+-    # can be virtually everything (everything which is not
+-    # "atarist" or "atariste" at least should have a processor
+-    # > m68000).  The system name ranges from "MiNT" over "FreeMiNT"
+-    # to the lowercase version "mint" (or "freemint").  Finally
+-    # the system name "TOS" denotes a system which is actually not
+-    # MiNT.  But MiNT is downward compatible to TOS, so this should
+-    # be no problem.
+-    atarist[e]:*MiNT:*:* | atarist[e]:*mint:*:* | atarist[e]:*TOS:*:*)
+-        echo m68k-atari-mint${UNAME_RELEASE}
+-	exit ;;
+-    atari*:*MiNT:*:* | atari*:*mint:*:* | atarist[e]:*TOS:*:*)
+-	echo m68k-atari-mint${UNAME_RELEASE}
+-        exit ;;
+-    *falcon*:*MiNT:*:* | *falcon*:*mint:*:* | *falcon*:*TOS:*:*)
+-        echo m68k-atari-mint${UNAME_RELEASE}
+-	exit ;;
+-    milan*:*MiNT:*:* | milan*:*mint:*:* | *milan*:*TOS:*:*)
+-        echo m68k-milan-mint${UNAME_RELEASE}
+-        exit ;;
+-    hades*:*MiNT:*:* | hades*:*mint:*:* | *hades*:*TOS:*:*)
+-        echo m68k-hades-mint${UNAME_RELEASE}
+-        exit ;;
+-    *:*MiNT:*:* | *:*mint:*:* | *:*TOS:*:*)
+-        echo m68k-unknown-mint${UNAME_RELEASE}
+-        exit ;;
+-    m68k:machten:*:*)
+-	echo m68k-apple-machten${UNAME_RELEASE}
+-	exit ;;
+-    powerpc:machten:*:*)
+-	echo powerpc-apple-machten${UNAME_RELEASE}
+-	exit ;;
+-    RISC*:Mach:*:*)
+-	echo mips-dec-mach_bsd4.3
+-	exit ;;
+-    RISC*:ULTRIX:*:*)
+-	echo mips-dec-ultrix${UNAME_RELEASE}
+-	exit ;;
+-    VAX*:ULTRIX*:*:*)
+-	echo vax-dec-ultrix${UNAME_RELEASE}
+-	exit ;;
+-    2020:CLIX:*:* | 2430:CLIX:*:*)
+-	echo clipper-intergraph-clix${UNAME_RELEASE}
+-	exit ;;
+-    mips:*:*:UMIPS | mips:*:*:RISCos)
+-	eval $set_cc_for_build
+-	sed 's/^	//' << EOF >$dummy.c
+-#ifdef __cplusplus
+-#include <stdio.h>  /* for printf() prototype */
+-	int main (int argc, char *argv[]) {
+-#else
+-	int main (argc, argv) int argc; char *argv[]; {
+-#endif
+-	#if defined (host_mips) && defined (MIPSEB)
+-	#if defined (SYSTYPE_SYSV)
+-	  printf ("mips-mips-riscos%ssysv\n", argv[1]); exit (0);
+-	#endif
+-	#if defined (SYSTYPE_SVR4)
+-	  printf ("mips-mips-riscos%ssvr4\n", argv[1]); exit (0);
+-	#endif
+-	#if defined (SYSTYPE_BSD43) || defined(SYSTYPE_BSD)
+-	  printf ("mips-mips-riscos%sbsd\n", argv[1]); exit (0);
+-	#endif
+-	#endif
+-	  exit (-1);
+-	}
+-EOF
+-	$CC_FOR_BUILD -o $dummy $dummy.c &&
+-	  dummyarg=`echo "${UNAME_RELEASE}" | sed -n 's/\([0-9]*\).*/\1/p'` &&
+-	  SYSTEM_NAME=`$dummy $dummyarg` &&
+-	    { echo "$SYSTEM_NAME"; exit; }
+-	echo mips-mips-riscos${UNAME_RELEASE}
+-	exit ;;
+-    Motorola:PowerMAX_OS:*:*)
+-	echo powerpc-motorola-powermax
+-	exit ;;
+-    Motorola:*:4.3:PL8-*)
+-	echo powerpc-harris-powermax
+-	exit ;;
+-    Night_Hawk:*:*:PowerMAX_OS | Synergy:PowerMAX_OS:*:*)
+-	echo powerpc-harris-powermax
+-	exit ;;
+-    Night_Hawk:Power_UNIX:*:*)
+-	echo powerpc-harris-powerunix
+-	exit ;;
+-    m88k:CX/UX:7*:*)
+-	echo m88k-harris-cxux7
+-	exit ;;
+-    m88k:*:4*:R4*)
+-	echo m88k-motorola-sysv4
+-	exit ;;
+-    m88k:*:3*:R3*)
+-	echo m88k-motorola-sysv3
+-	exit ;;
+-    AViiON:dgux:*:*)
+-        # DG/UX returns AViiON for all architectures
+-        UNAME_PROCESSOR=`/usr/bin/uname -p`
+-	if [ $UNAME_PROCESSOR = mc88100 ] || [ $UNAME_PROCESSOR = mc88110 ]
+-	then
+-	    if [ ${TARGET_BINARY_INTERFACE}x = m88kdguxelfx ] || \
+-	       [ ${TARGET_BINARY_INTERFACE}x = x ]
+-	    then
+-		echo m88k-dg-dgux${UNAME_RELEASE}
+-	    else
+-		echo m88k-dg-dguxbcs${UNAME_RELEASE}
+-	    fi
+-	else
+-	    echo i586-dg-dgux${UNAME_RELEASE}
+-	fi
+- 	exit ;;
+-    M88*:DolphinOS:*:*)	# DolphinOS (SVR3)
+-	echo m88k-dolphin-sysv3
+-	exit ;;
+-    M88*:*:R3*:*)
+-	# Delta 88k system running SVR3
+-	echo m88k-motorola-sysv3
+-	exit ;;
+-    XD88*:*:*:*) # Tektronix XD88 system running UTekV (SVR3)
+-	echo m88k-tektronix-sysv3
+-	exit ;;
+-    Tek43[0-9][0-9]:UTek:*:*) # Tektronix 4300 system running UTek (BSD)
+-	echo m68k-tektronix-bsd
+-	exit ;;
+-    *:IRIX*:*:*)
+-	echo mips-sgi-irix`echo ${UNAME_RELEASE}|sed -e 's/-/_/g'`
+-	exit ;;
+-    ????????:AIX?:[12].1:2)   # AIX 2.2.1 or AIX 2.1.1 is RT/PC AIX.
+-	echo romp-ibm-aix     # uname -m gives an 8 hex-code CPU id
+-	exit ;;               # Note that: echo "'`uname -s`'" gives 'AIX '
+-    i*86:AIX:*:*)
+-	echo i386-ibm-aix
+-	exit ;;
+-    ia64:AIX:*:*)
+-	if [ -x /usr/bin/oslevel ] ; then
+-		IBM_REV=`/usr/bin/oslevel`
+-	else
+-		IBM_REV=${UNAME_VERSION}.${UNAME_RELEASE}
+-	fi
+-	echo ${UNAME_MACHINE}-ibm-aix${IBM_REV}
+-	exit ;;
+-    *:AIX:2:3)
+-	if grep bos325 /usr/include/stdio.h >/dev/null 2>&1; then
+-		eval $set_cc_for_build
+-		sed 's/^		//' << EOF >$dummy.c
+-		#include <sys/systemcfg.h>
+-
+-		main()
+-			{
+-			if (!__power_pc())
+-				exit(1);
+-			puts("powerpc-ibm-aix3.2.5");
+-			exit(0);
+-			}
+-EOF
+-		if $CC_FOR_BUILD -o $dummy $dummy.c && SYSTEM_NAME=`$dummy`
+-		then
+-			echo "$SYSTEM_NAME"
+-		else
+-			echo rs6000-ibm-aix3.2.5
+-		fi
+-	elif grep bos324 /usr/include/stdio.h >/dev/null 2>&1; then
+-		echo rs6000-ibm-aix3.2.4
+-	else
+-		echo rs6000-ibm-aix3.2
+-	fi
+-	exit ;;
+-    *:AIX:*:[456])
+-	IBM_CPU_ID=`/usr/sbin/lsdev -C -c processor -S available | sed 1q | awk '{ print $1 }'`
+-	if /usr/sbin/lsattr -El ${IBM_CPU_ID} | grep ' POWER' >/dev/null 2>&1; then
+-		IBM_ARCH=rs6000
+-	else
+-		IBM_ARCH=powerpc
+-	fi
+-	if [ -x /usr/bin/oslevel ] ; then
+-		IBM_REV=`/usr/bin/oslevel`
+-	else
+-		IBM_REV=${UNAME_VERSION}.${UNAME_RELEASE}
+-	fi
+-	echo ${IBM_ARCH}-ibm-aix${IBM_REV}
+-	exit ;;
+-    *:AIX:*:*)
+-	echo rs6000-ibm-aix
+-	exit ;;
+-    ibmrt:4.4BSD:*|romp-ibm:BSD:*)
+-	echo romp-ibm-bsd4.4
+-	exit ;;
+-    ibmrt:*BSD:*|romp-ibm:BSD:*)            # covers RT/PC BSD and
+-	echo romp-ibm-bsd${UNAME_RELEASE}   # 4.3 with uname added to
+-	exit ;;                             # report: romp-ibm BSD 4.3
+-    *:BOSX:*:*)
+-	echo rs6000-bull-bosx
+-	exit ;;
+-    DPX/2?00:B.O.S.:*:*)
+-	echo m68k-bull-sysv3
+-	exit ;;
+-    9000/[34]??:4.3bsd:1.*:*)
+-	echo m68k-hp-bsd
+-	exit ;;
+-    hp300:4.4BSD:*:* | 9000/[34]??:4.3bsd:2.*:*)
+-	echo m68k-hp-bsd4.4
+-	exit ;;
+-    9000/[34678]??:HP-UX:*:*)
+-	HPUX_REV=`echo ${UNAME_RELEASE}|sed -e 's/[^.]*.[0B]*//'`
+-	case "${UNAME_MACHINE}" in
+-	    9000/31? )            HP_ARCH=m68000 ;;
+-	    9000/[34]?? )         HP_ARCH=m68k ;;
+-	    9000/[678][0-9][0-9])
+-		if [ -x /usr/bin/getconf ]; then
+-		    sc_cpu_version=`/usr/bin/getconf SC_CPU_VERSION 2>/dev/null`
+-                    sc_kernel_bits=`/usr/bin/getconf SC_KERNEL_BITS 2>/dev/null`
+-                    case "${sc_cpu_version}" in
+-                      523) HP_ARCH="hppa1.0" ;; # CPU_PA_RISC1_0
+-                      528) HP_ARCH="hppa1.1" ;; # CPU_PA_RISC1_1
+-                      532)                      # CPU_PA_RISC2_0
+-                        case "${sc_kernel_bits}" in
+-                          32) HP_ARCH="hppa2.0n" ;;
+-                          64) HP_ARCH="hppa2.0w" ;;
+-			  '') HP_ARCH="hppa2.0" ;;   # HP-UX 10.20
+-                        esac ;;
+-                    esac
+-		fi
+-		if [ "${HP_ARCH}" = "" ]; then
+-		    eval $set_cc_for_build
+-		    sed 's/^              //' << EOF >$dummy.c
+-
+-              #define _HPUX_SOURCE
+-              #include <stdlib.h>
+-              #include <unistd.h>
+-
+-              int main ()
+-              {
+-              #if defined(_SC_KERNEL_BITS)
+-                  long bits = sysconf(_SC_KERNEL_BITS);
+-              #endif
+-                  long cpu  = sysconf (_SC_CPU_VERSION);
+-
+-                  switch (cpu)
+-              	{
+-              	case CPU_PA_RISC1_0: puts ("hppa1.0"); break;
+-              	case CPU_PA_RISC1_1: puts ("hppa1.1"); break;
+-              	case CPU_PA_RISC2_0:
+-              #if defined(_SC_KERNEL_BITS)
+-              	    switch (bits)
+-              		{
+-              		case 64: puts ("hppa2.0w"); break;
+-              		case 32: puts ("hppa2.0n"); break;
+-              		default: puts ("hppa2.0"); break;
+-              		} break;
+-              #else  /* !defined(_SC_KERNEL_BITS) */
+-              	    puts ("hppa2.0"); break;
+-              #endif
+-              	default: puts ("hppa1.0"); break;
+-              	}
+-                  exit (0);
+-              }
+-EOF
+-		    (CCOPTS= $CC_FOR_BUILD -o $dummy $dummy.c 2>/dev/null) && HP_ARCH=`$dummy`
+-		    test -z "$HP_ARCH" && HP_ARCH=hppa
+-		fi ;;
+-	esac
+-	if [ ${HP_ARCH} = "hppa2.0w" ]
+-	then
+-	    eval $set_cc_for_build
+-
+-	    # hppa2.0w-hp-hpux* has a 64-bit kernel and a compiler generating
+-	    # 32-bit code.  hppa64-hp-hpux* has the same kernel and a compiler
+-	    # generating 64-bit code.  GNU and HP use different nomenclature:
+-	    #
+-	    # $ CC_FOR_BUILD=cc ./config.guess
+-	    # => hppa2.0w-hp-hpux11.23
+-	    # $ CC_FOR_BUILD="cc +DA2.0w" ./config.guess
+-	    # => hppa64-hp-hpux11.23
+-
+-	    if echo __LP64__ | (CCOPTS= $CC_FOR_BUILD -E - 2>/dev/null) |
+-		grep -q __LP64__
+-	    then
+-		HP_ARCH="hppa2.0w"
+-	    else
+-		HP_ARCH="hppa64"
+-	    fi
+-	fi
+-	echo ${HP_ARCH}-hp-hpux${HPUX_REV}
+-	exit ;;
+-    ia64:HP-UX:*:*)
+-	HPUX_REV=`echo ${UNAME_RELEASE}|sed -e 's/[^.]*.[0B]*//'`
+-	echo ia64-hp-hpux${HPUX_REV}
+-	exit ;;
+-    3050*:HI-UX:*:*)
+-	eval $set_cc_for_build
+-	sed 's/^	//' << EOF >$dummy.c
+-	#include <unistd.h>
+-	int
+-	main ()
+-	{
+-	  long cpu = sysconf (_SC_CPU_VERSION);
+-	  /* The order matters, because CPU_IS_HP_MC68K erroneously returns
+-	     true for CPU_PA_RISC1_0.  CPU_IS_PA_RISC returns correct
+-	     results, however.  */
+-	  if (CPU_IS_PA_RISC (cpu))
+-	    {
+-	      switch (cpu)
+-		{
+-		  case CPU_PA_RISC1_0: puts ("hppa1.0-hitachi-hiuxwe2"); break;
+-		  case CPU_PA_RISC1_1: puts ("hppa1.1-hitachi-hiuxwe2"); break;
+-		  case CPU_PA_RISC2_0: puts ("hppa2.0-hitachi-hiuxwe2"); break;
+-		  default: puts ("hppa-hitachi-hiuxwe2"); break;
+-		}
+-	    }
+-	  else if (CPU_IS_HP_MC68K (cpu))
+-	    puts ("m68k-hitachi-hiuxwe2");
+-	  else puts ("unknown-hitachi-hiuxwe2");
+-	  exit (0);
+-	}
+-EOF
+-	$CC_FOR_BUILD -o $dummy $dummy.c && SYSTEM_NAME=`$dummy` &&
+-		{ echo "$SYSTEM_NAME"; exit; }
+-	echo unknown-hitachi-hiuxwe2
+-	exit ;;
+-    9000/7??:4.3bsd:*:* | 9000/8?[79]:4.3bsd:*:* )
+-	echo hppa1.1-hp-bsd
+-	exit ;;
+-    9000/8??:4.3bsd:*:*)
+-	echo hppa1.0-hp-bsd
+-	exit ;;
+-    *9??*:MPE/iX:*:* | *3000*:MPE/iX:*:*)
+-	echo hppa1.0-hp-mpeix
+-	exit ;;
+-    hp7??:OSF1:*:* | hp8?[79]:OSF1:*:* )
+-	echo hppa1.1-hp-osf
+-	exit ;;
+-    hp8??:OSF1:*:*)
+-	echo hppa1.0-hp-osf
+-	exit ;;
+-    i*86:OSF1:*:*)
+-	if [ -x /usr/sbin/sysversion ] ; then
+-	    echo ${UNAME_MACHINE}-unknown-osf1mk
+-	else
+-	    echo ${UNAME_MACHINE}-unknown-osf1
+-	fi
+-	exit ;;
+-    parisc*:Lites*:*:*)
+-	echo hppa1.1-hp-lites
+-	exit ;;
+-    C1*:ConvexOS:*:* | convex:ConvexOS:C1*:*)
+-	echo c1-convex-bsd
+-        exit ;;
+-    C2*:ConvexOS:*:* | convex:ConvexOS:C2*:*)
+-	if getsysinfo -f scalar_acc
+-	then echo c32-convex-bsd
+-	else echo c2-convex-bsd
+-	fi
+-        exit ;;
+-    C34*:ConvexOS:*:* | convex:ConvexOS:C34*:*)
+-	echo c34-convex-bsd
+-        exit ;;
+-    C38*:ConvexOS:*:* | convex:ConvexOS:C38*:*)
+-	echo c38-convex-bsd
+-        exit ;;
+-    C4*:ConvexOS:*:* | convex:ConvexOS:C4*:*)
+-	echo c4-convex-bsd
+-        exit ;;
+-    CRAY*Y-MP:*:*:*)
+-	echo ymp-cray-unicos${UNAME_RELEASE} | sed -e 's/\.[^.]*$/.X/'
+-	exit ;;
+-    CRAY*[A-Z]90:*:*:*)
+-	echo ${UNAME_MACHINE}-cray-unicos${UNAME_RELEASE} \
+-	| sed -e 's/CRAY.*\([A-Z]90\)/\1/' \
+-	      -e y/ABCDEFGHIJKLMNOPQRSTUVWXYZ/abcdefghijklmnopqrstuvwxyz/ \
+-	      -e 's/\.[^.]*$/.X/'
+-	exit ;;
+-    CRAY*TS:*:*:*)
+-	echo t90-cray-unicos${UNAME_RELEASE} | sed -e 's/\.[^.]*$/.X/'
+-	exit ;;
+-    CRAY*T3E:*:*:*)
+-	echo alphaev5-cray-unicosmk${UNAME_RELEASE} | sed -e 's/\.[^.]*$/.X/'
+-	exit ;;
+-    CRAY*SV1:*:*:*)
+-	echo sv1-cray-unicos${UNAME_RELEASE} | sed -e 's/\.[^.]*$/.X/'
+-	exit ;;
+-    *:UNICOS/mp:*:*)
+-	echo craynv-cray-unicosmp${UNAME_RELEASE} | sed -e 's/\.[^.]*$/.X/'
+-	exit ;;
+-    F30[01]:UNIX_System_V:*:* | F700:UNIX_System_V:*:*)
+-	FUJITSU_PROC=`uname -m | tr 'ABCDEFGHIJKLMNOPQRSTUVWXYZ' 'abcdefghijklmnopqrstuvwxyz'`
+-        FUJITSU_SYS=`uname -p | tr 'ABCDEFGHIJKLMNOPQRSTUVWXYZ' 'abcdefghijklmnopqrstuvwxyz' | sed -e 's/\///'`
+-        FUJITSU_REL=`echo ${UNAME_RELEASE} | sed -e 's/ /_/'`
+-        echo "${FUJITSU_PROC}-fujitsu-${FUJITSU_SYS}${FUJITSU_REL}"
+-        exit ;;
+-    5000:UNIX_System_V:4.*:*)
+-        FUJITSU_SYS=`uname -p | tr 'ABCDEFGHIJKLMNOPQRSTUVWXYZ' 'abcdefghijklmnopqrstuvwxyz' | sed -e 's/\///'`
+-        FUJITSU_REL=`echo ${UNAME_RELEASE} | tr 'ABCDEFGHIJKLMNOPQRSTUVWXYZ' 'abcdefghijklmnopqrstuvwxyz' | sed -e 's/ /_/'`
+-        echo "sparc-fujitsu-${FUJITSU_SYS}${FUJITSU_REL}"
+-	exit ;;
+-    i*86:BSD/386:*:* | i*86:BSD/OS:*:* | *:Ascend\ Embedded/OS:*:*)
+-	echo ${UNAME_MACHINE}-pc-bsdi${UNAME_RELEASE}
+-	exit ;;
+-    sparc*:BSD/OS:*:*)
+-	echo sparc-unknown-bsdi${UNAME_RELEASE}
+-	exit ;;
+-    *:BSD/OS:*:*)
+-	echo ${UNAME_MACHINE}-unknown-bsdi${UNAME_RELEASE}
+-	exit ;;
+-    *:FreeBSD:*:*)
+-	case ${UNAME_MACHINE} in
+-	    pc98)
+-		echo i386-unknown-freebsd`echo ${UNAME_RELEASE}|sed -e 's/[-(].*//'` ;;
+-	    amd64)
+-		echo x86_64-unknown-freebsd`echo ${UNAME_RELEASE}|sed -e 's/[-(].*//'` ;;
+-	    *)
+-		echo ${UNAME_MACHINE}-unknown-freebsd`echo ${UNAME_RELEASE}|sed -e 's/[-(].*//'` ;;
+-	esac
+-	exit ;;
+-    i*:CYGWIN*:*)
+-	echo ${UNAME_MACHINE}-pc-cygwin
+-	exit ;;
+-    *:MINGW*:*)
+-	echo ${UNAME_MACHINE}-pc-mingw32
+-	exit ;;
+-    i*:windows32*:*)
+-    	# uname -m includes "-pc" on this system.
+-    	echo ${UNAME_MACHINE}-mingw32
+-	exit ;;
+-    i*:PW*:*)
+-	echo ${UNAME_MACHINE}-pc-pw32
+-	exit ;;
+-    *:Interix*:*)
+-    	case ${UNAME_MACHINE} in
+-	    x86)
+-		echo i586-pc-interix${UNAME_RELEASE}
+-		exit ;;
+-	    authenticamd | genuineintel | EM64T)
+-		echo x86_64-unknown-interix${UNAME_RELEASE}
+-		exit ;;
+-	    IA64)
+-		echo ia64-unknown-interix${UNAME_RELEASE}
+-		exit ;;
+-	esac ;;
+-    [345]86:Windows_95:* | [345]86:Windows_98:* | [345]86:Windows_NT:*)
+-	echo i${UNAME_MACHINE}-pc-mks
+-	exit ;;
+-    8664:Windows_NT:*)
+-	echo x86_64-pc-mks
+-	exit ;;
+-    i*:Windows_NT*:* | Pentium*:Windows_NT*:*)
+-	# How do we know it's Interix rather than the generic POSIX subsystem?
+-	# It also conflicts with pre-2.0 versions of AT&T UWIN. Should we
+-	# UNAME_MACHINE based on the output of uname instead of i386?
+-	echo i586-pc-interix
+-	exit ;;
+-    i*:UWIN*:*)
+-	echo ${UNAME_MACHINE}-pc-uwin
+-	exit ;;
+-    amd64:CYGWIN*:*:* | x86_64:CYGWIN*:*:*)
+-	echo x86_64-unknown-cygwin
+-	exit ;;
+-    p*:CYGWIN*:*)
+-	echo powerpcle-unknown-cygwin
+-	exit ;;
+-    prep*:SunOS:5.*:*)
+-	echo powerpcle-unknown-solaris2`echo ${UNAME_RELEASE}|sed -e 's/[^.]*//'`
+-	exit ;;
+-    *:GNU:*:*)
+-	# the GNU system
+-	echo `echo ${UNAME_MACHINE}|sed -e 's,[-/].*$,,'`-unknown-gnu`echo ${UNAME_RELEASE}|sed -e 's,/.*$,,'`
+-	exit ;;
+-    *:GNU/*:*:*)
+-	# other systems with GNU libc and userland
+-	echo ${UNAME_MACHINE}-unknown-`echo ${UNAME_SYSTEM} | sed 's,^[^/]*/,,' | tr '[A-Z]' '[a-z]'``echo ${UNAME_RELEASE}|sed -e 's/[-(].*//'`-gnu
+-	exit ;;
+-    i*86:Minix:*:*)
+-	echo ${UNAME_MACHINE}-pc-minix
+-	exit ;;
+-    alpha:Linux:*:*)
+-	case `sed -n '/^cpu model/s/^.*: \(.*\)/\1/p' < /proc/cpuinfo` in
+-	  EV5)   UNAME_MACHINE=alphaev5 ;;
+-	  EV56)  UNAME_MACHINE=alphaev56 ;;
+-	  PCA56) UNAME_MACHINE=alphapca56 ;;
+-	  PCA57) UNAME_MACHINE=alphapca56 ;;
+-	  EV6)   UNAME_MACHINE=alphaev6 ;;
+-	  EV67)  UNAME_MACHINE=alphaev67 ;;
+-	  EV68*) UNAME_MACHINE=alphaev68 ;;
+-        esac
+-	objdump --private-headers /bin/sh | grep -q ld.so.1
+-	if test "$?" = 0 ; then LIBC="libc1" ; else LIBC="" ; fi
+-	echo ${UNAME_MACHINE}-unknown-linux-gnu${LIBC}
+-	exit ;;
+-    arm*:Linux:*:*)
+-	eval $set_cc_for_build
+-	if echo __ARM_EABI__ | $CC_FOR_BUILD -E - 2>/dev/null \
+-	    | grep -q __ARM_EABI__
+-	then
+-	    echo ${UNAME_MACHINE}-unknown-linux-gnu
+-	else
+-	    echo ${UNAME_MACHINE}-unknown-linux-gnueabi
+-	fi
+-	exit ;;
+-    avr32*:Linux:*:*)
+-	echo ${UNAME_MACHINE}-unknown-linux-gnu
+-	exit ;;
+-    cris:Linux:*:*)
+-	echo cris-axis-linux-gnu
+-	exit ;;
+-    crisv32:Linux:*:*)
+-	echo crisv32-axis-linux-gnu
+-	exit ;;
+-    frv:Linux:*:*)
+-    	echo frv-unknown-linux-gnu
+-	exit ;;
+-    i*86:Linux:*:*)
+-	LIBC=gnu
+-	eval $set_cc_for_build
+-	sed 's/^	//' << EOF >$dummy.c
+-	#ifdef __dietlibc__
+-	LIBC=dietlibc
+-	#endif
+-EOF
+-	eval `$CC_FOR_BUILD -E $dummy.c 2>/dev/null | grep '^LIBC'`
+-	echo "${UNAME_MACHINE}-pc-linux-${LIBC}"
+-	exit ;;
+-    ia64:Linux:*:*)
+-	echo ${UNAME_MACHINE}-unknown-linux-gnu
+-	exit ;;
+-    m32r*:Linux:*:*)
+-	echo ${UNAME_MACHINE}-unknown-linux-gnu
+-	exit ;;
+-    m68*:Linux:*:*)
+-	echo ${UNAME_MACHINE}-unknown-linux-gnu
+-	exit ;;
+-    mips:Linux:*:* | mips64:Linux:*:*)
+-	eval $set_cc_for_build
+-	sed 's/^	//' << EOF >$dummy.c
+-	#undef CPU
+-	#undef ${UNAME_MACHINE}
+-	#undef ${UNAME_MACHINE}el
+-	#if defined(__MIPSEL__) || defined(__MIPSEL) || defined(_MIPSEL) || defined(MIPSEL)
+-	CPU=${UNAME_MACHINE}el
+-	#else
+-	#if defined(__MIPSEB__) || defined(__MIPSEB) || defined(_MIPSEB) || defined(MIPSEB)
+-	CPU=${UNAME_MACHINE}
+-	#else
+-	CPU=
+-	#endif
+-	#endif
+-EOF
+-	eval `$CC_FOR_BUILD -E $dummy.c 2>/dev/null | grep '^CPU'`
+-	test x"${CPU}" != x && { echo "${CPU}-unknown-linux-gnu"; exit; }
+-	;;
+-    or32:Linux:*:*)
+-	echo or32-unknown-linux-gnu
+-	exit ;;
+-    padre:Linux:*:*)
+-	echo sparc-unknown-linux-gnu
+-	exit ;;
+-    parisc64:Linux:*:* | hppa64:Linux:*:*)
+-	echo hppa64-unknown-linux-gnu
+-	exit ;;
+-    parisc:Linux:*:* | hppa:Linux:*:*)
+-	# Look for CPU level
+-	case `grep '^cpu[^a-z]*:' /proc/cpuinfo 2>/dev/null | cut -d' ' -f2` in
+-	  PA7*) echo hppa1.1-unknown-linux-gnu ;;
+-	  PA8*) echo hppa2.0-unknown-linux-gnu ;;
+-	  *)    echo hppa-unknown-linux-gnu ;;
+-	esac
+-	exit ;;
+-    ppc64:Linux:*:*)
+-	echo powerpc64-unknown-linux-gnu
+-	exit ;;
+-    ppc:Linux:*:*)
+-	echo powerpc-unknown-linux-gnu
+-	exit ;;
+-    s390:Linux:*:* | s390x:Linux:*:*)
+-	echo ${UNAME_MACHINE}-ibm-linux
+-	exit ;;
+-    sh64*:Linux:*:*)
+-    	echo ${UNAME_MACHINE}-unknown-linux-gnu
+-	exit ;;
+-    sh*:Linux:*:*)
+-	echo ${UNAME_MACHINE}-unknown-linux-gnu
+-	exit ;;
+-    sparc:Linux:*:* | sparc64:Linux:*:*)
+-	echo ${UNAME_MACHINE}-unknown-linux-gnu
+-	exit ;;
+-    vax:Linux:*:*)
+-	echo ${UNAME_MACHINE}-dec-linux-gnu
+-	exit ;;
+-    x86_64:Linux:*:*)
+-	echo x86_64-unknown-linux-gnu
+-	exit ;;
+-    xtensa*:Linux:*:*)
+-    	echo ${UNAME_MACHINE}-unknown-linux-gnu
+-	exit ;;
+-    i*86:DYNIX/ptx:4*:*)
+-	# ptx 4.0 does uname -s correctly, with DYNIX/ptx in there.
+-	# earlier versions are messed up and put the nodename in both
+-	# sysname and nodename.
+-	echo i386-sequent-sysv4
+-	exit ;;
+-    i*86:UNIX_SV:4.2MP:2.*)
+-        # Unixware is an offshoot of SVR4, but it has its own version
+-        # number series starting with 2...
+-        # I am not positive that other SVR4 systems won't match this,
+-	# I just have to hope.  -- rms.
+-        # Use sysv4.2uw... so that sysv4* matches it.
+-	echo ${UNAME_MACHINE}-pc-sysv4.2uw${UNAME_VERSION}
+-	exit ;;
+-    i*86:OS/2:*:*)
+-	# If we were able to find `uname', then EMX Unix compatibility
+-	# is probably installed.
+-	echo ${UNAME_MACHINE}-pc-os2-emx
+-	exit ;;
+-    i*86:XTS-300:*:STOP)
+-	echo ${UNAME_MACHINE}-unknown-stop
+-	exit ;;
+-    i*86:atheos:*:*)
+-	echo ${UNAME_MACHINE}-unknown-atheos
+-	exit ;;
+-    i*86:syllable:*:*)
+-	echo ${UNAME_MACHINE}-pc-syllable
+-	exit ;;
+-    i*86:LynxOS:2.*:* | i*86:LynxOS:3.[01]*:* | i*86:LynxOS:4.[02]*:*)
+-	echo i386-unknown-lynxos${UNAME_RELEASE}
+-	exit ;;
+-    i*86:*DOS:*:*)
+-	echo ${UNAME_MACHINE}-pc-msdosdjgpp
+-	exit ;;
+-    i*86:*:4.*:* | i*86:SYSTEM_V:4.*:*)
+-	UNAME_REL=`echo ${UNAME_RELEASE} | sed 's/\/MP$//'`
+-	if grep Novell /usr/include/link.h >/dev/null 2>/dev/null; then
+-		echo ${UNAME_MACHINE}-univel-sysv${UNAME_REL}
+-	else
+-		echo ${UNAME_MACHINE}-pc-sysv${UNAME_REL}
+-	fi
+-	exit ;;
+-    i*86:*:5:[678]*)
+-    	# UnixWare 7.x, OpenUNIX and OpenServer 6.
+-	case `/bin/uname -X | grep "^Machine"` in
+-	    *486*)	     UNAME_MACHINE=i486 ;;
+-	    *Pentium)	     UNAME_MACHINE=i586 ;;
+-	    *Pent*|*Celeron) UNAME_MACHINE=i686 ;;
+-	esac
+-	echo ${UNAME_MACHINE}-unknown-sysv${UNAME_RELEASE}${UNAME_SYSTEM}${UNAME_VERSION}
+-	exit ;;
+-    i*86:*:3.2:*)
+-	if test -f /usr/options/cb.name; then
+-		UNAME_REL=`sed -n 's/.*Version //p' </usr/options/cb.name`
+-		echo ${UNAME_MACHINE}-pc-isc$UNAME_REL
+-	elif /bin/uname -X 2>/dev/null >/dev/null ; then
+-		UNAME_REL=`(/bin/uname -X|grep Release|sed -e 's/.*= //')`
+-		(/bin/uname -X|grep i80486 >/dev/null) && UNAME_MACHINE=i486
+-		(/bin/uname -X|grep '^Machine.*Pentium' >/dev/null) \
+-			&& UNAME_MACHINE=i586
+-		(/bin/uname -X|grep '^Machine.*Pent *II' >/dev/null) \
+-			&& UNAME_MACHINE=i686
+-		(/bin/uname -X|grep '^Machine.*Pentium Pro' >/dev/null) \
+-			&& UNAME_MACHINE=i686
+-		echo ${UNAME_MACHINE}-pc-sco$UNAME_REL
+-	else
+-		echo ${UNAME_MACHINE}-pc-sysv32
+-	fi
+-	exit ;;
+-    pc:*:*:*)
+-	# Left here for compatibility:
+-        # uname -m prints for DJGPP always 'pc', but it prints nothing about
+-        # the processor, so we play safe by assuming i586.
+-	# Note: whatever this is, it MUST be the same as what config.sub
+-	# prints for the "djgpp" host, or else GDB configury will decide that
+-	# this is a cross-build.
+-	echo i586-pc-msdosdjgpp
+-        exit ;;
+-    Intel:Mach:3*:*)
+-	echo i386-pc-mach3
+-	exit ;;
+-    paragon:*:*:*)
+-	echo i860-intel-osf1
+-	exit ;;
+-    i860:*:4.*:*) # i860-SVR4
+-	if grep Stardent /usr/include/sys/uadmin.h >/dev/null 2>&1 ; then
+-	  echo i860-stardent-sysv${UNAME_RELEASE} # Stardent Vistra i860-SVR4
+-	else # Add other i860-SVR4 vendors below as they are discovered.
+-	  echo i860-unknown-sysv${UNAME_RELEASE}  # Unknown i860-SVR4
+-	fi
+-	exit ;;
+-    mini*:CTIX:SYS*5:*)
+-	# "miniframe"
+-	echo m68010-convergent-sysv
+-	exit ;;
+-    mc68k:UNIX:SYSTEM5:3.51m)
+-	echo m68k-convergent-sysv
+-	exit ;;
+-    M680?0:D-NIX:5.3:*)
+-	echo m68k-diab-dnix
+-	exit ;;
+-    M68*:*:R3V[5678]*:*)
+-	test -r /sysV68 && { echo 'm68k-motorola-sysv'; exit; } ;;
+-    3[345]??:*:4.0:3.0 | 3[34]??A:*:4.0:3.0 | 3[34]??,*:*:4.0:3.0 | 3[34]??/*:*:4.0:3.0 | 4400:*:4.0:3.0 | 4850:*:4.0:3.0 | SKA40:*:4.0:3.0 | SDS2:*:4.0:3.0 | SHG2:*:4.0:3.0 | S7501*:*:4.0:3.0)
+-	OS_REL=''
+-	test -r /etc/.relid \
+-	&& OS_REL=.`sed -n 's/[^ ]* [^ ]* \([0-9][0-9]\).*/\1/p' < /etc/.relid`
+-	/bin/uname -p 2>/dev/null | grep 86 >/dev/null \
+-	  && { echo i486-ncr-sysv4.3${OS_REL}; exit; }
+-	/bin/uname -p 2>/dev/null | /bin/grep entium >/dev/null \
+-	  && { echo i586-ncr-sysv4.3${OS_REL}; exit; } ;;
+-    3[34]??:*:4.0:* | 3[34]??,*:*:4.0:*)
+-        /bin/uname -p 2>/dev/null | grep 86 >/dev/null \
+-          && { echo i486-ncr-sysv4; exit; } ;;
+-    NCR*:*:4.2:* | MPRAS*:*:4.2:*)
+-	OS_REL='.3'
+-	test -r /etc/.relid \
+-	    && OS_REL=.`sed -n 's/[^ ]* [^ ]* \([0-9][0-9]\).*/\1/p' < /etc/.relid`
+-	/bin/uname -p 2>/dev/null | grep 86 >/dev/null \
+-	    && { echo i486-ncr-sysv4.3${OS_REL}; exit; }
+-	/bin/uname -p 2>/dev/null | /bin/grep entium >/dev/null \
+-	    && { echo i586-ncr-sysv4.3${OS_REL}; exit; }
+-	/bin/uname -p 2>/dev/null | /bin/grep pteron >/dev/null \
+-	    && { echo i586-ncr-sysv4.3${OS_REL}; exit; } ;;
+-    m68*:LynxOS:2.*:* | m68*:LynxOS:3.0*:*)
+-	echo m68k-unknown-lynxos${UNAME_RELEASE}
+-	exit ;;
+-    mc68030:UNIX_System_V:4.*:*)
+-	echo m68k-atari-sysv4
+-	exit ;;
+-    TSUNAMI:LynxOS:2.*:*)
+-	echo sparc-unknown-lynxos${UNAME_RELEASE}
+-	exit ;;
+-    rs6000:LynxOS:2.*:*)
+-	echo rs6000-unknown-lynxos${UNAME_RELEASE}
+-	exit ;;
+-    PowerPC:LynxOS:2.*:* | PowerPC:LynxOS:3.[01]*:* | PowerPC:LynxOS:4.[02]*:*)
+-	echo powerpc-unknown-lynxos${UNAME_RELEASE}
+-	exit ;;
+-    SM[BE]S:UNIX_SV:*:*)
+-	echo mips-dde-sysv${UNAME_RELEASE}
+-	exit ;;
+-    RM*:ReliantUNIX-*:*:*)
+-	echo mips-sni-sysv4
+-	exit ;;
+-    RM*:SINIX-*:*:*)
+-	echo mips-sni-sysv4
+-	exit ;;
+-    *:SINIX-*:*:*)
+-	if uname -p 2>/dev/null >/dev/null ; then
+-		UNAME_MACHINE=`(uname -p) 2>/dev/null`
+-		echo ${UNAME_MACHINE}-sni-sysv4
+-	else
+-		echo ns32k-sni-sysv
+-	fi
+-	exit ;;
+-    PENTIUM:*:4.0*:*) # Unisys `ClearPath HMP IX 4000' SVR4/MP effort
+-                      # says <Richard.M.Bartel@ccMail.Census.GOV>
+-        echo i586-unisys-sysv4
+-        exit ;;
+-    *:UNIX_System_V:4*:FTX*)
+-	# From Gerald Hewes <hewes@openmarket.com>.
+-	# How about differentiating between stratus architectures? -djm
+-	echo hppa1.1-stratus-sysv4
+-	exit ;;
+-    *:*:*:FTX*)
+-	# From seanf@swdc.stratus.com.
+-	echo i860-stratus-sysv4
+-	exit ;;
+-    i*86:VOS:*:*)
+-	# From Paul.Green@stratus.com.
+-	echo ${UNAME_MACHINE}-stratus-vos
+-	exit ;;
+-    *:VOS:*:*)
+-	# From Paul.Green@stratus.com.
+-	echo hppa1.1-stratus-vos
+-	exit ;;
+-    mc68*:A/UX:*:*)
+-	echo m68k-apple-aux${UNAME_RELEASE}
+-	exit ;;
+-    news*:NEWS-OS:6*:*)
+-	echo mips-sony-newsos6
+-	exit ;;
+-    R[34]000:*System_V*:*:* | R4000:UNIX_SYSV:*:* | R*000:UNIX_SV:*:*)
+-	if [ -d /usr/nec ]; then
+-	        echo mips-nec-sysv${UNAME_RELEASE}
+-	else
+-	        echo mips-unknown-sysv${UNAME_RELEASE}
+-	fi
+-        exit ;;
+-    BeBox:BeOS:*:*)	# BeOS running on hardware made by Be, PPC only.
+-	echo powerpc-be-beos
+-	exit ;;
+-    BeMac:BeOS:*:*)	# BeOS running on Mac or Mac clone, PPC only.
+-	echo powerpc-apple-beos
+-	exit ;;
+-    BePC:BeOS:*:*)	# BeOS running on Intel PC compatible.
+-	echo i586-pc-beos
+-	exit ;;
+-    BePC:Haiku:*:*)	# Haiku running on Intel PC compatible.
+-	echo i586-pc-haiku
+-	exit ;;
+-    SX-4:SUPER-UX:*:*)
+-	echo sx4-nec-superux${UNAME_RELEASE}
+-	exit ;;
+-    SX-5:SUPER-UX:*:*)
+-	echo sx5-nec-superux${UNAME_RELEASE}
+-	exit ;;
+-    SX-6:SUPER-UX:*:*)
+-	echo sx6-nec-superux${UNAME_RELEASE}
+-	exit ;;
+-    SX-7:SUPER-UX:*:*)
+-	echo sx7-nec-superux${UNAME_RELEASE}
+-	exit ;;
+-    SX-8:SUPER-UX:*:*)
+-	echo sx8-nec-superux${UNAME_RELEASE}
+-	exit ;;
+-    SX-8R:SUPER-UX:*:*)
+-	echo sx8r-nec-superux${UNAME_RELEASE}
+-	exit ;;
+-    Power*:Rhapsody:*:*)
+-	echo powerpc-apple-rhapsody${UNAME_RELEASE}
+-	exit ;;
+-    *:Rhapsody:*:*)
+-	echo ${UNAME_MACHINE}-apple-rhapsody${UNAME_RELEASE}
+-	exit ;;
+-    *:Darwin:*:*)
+-	UNAME_PROCESSOR=`uname -p` || UNAME_PROCESSOR=unknown
+-	case $UNAME_PROCESSOR in
+-	    i386)
+-		eval $set_cc_for_build
+-		if [ "$CC_FOR_BUILD" != 'no_compiler_found' ]; then
+-		  if (echo '#ifdef __LP64__'; echo IS_64BIT_ARCH; echo '#endif') | \
+-		      (CCOPTS= $CC_FOR_BUILD -E - 2>/dev/null) | \
+-		      grep IS_64BIT_ARCH >/dev/null
+-		  then
+-		      UNAME_PROCESSOR="x86_64"
+-		  fi
+-		fi ;;
+-	    unknown) UNAME_PROCESSOR=powerpc ;;
+-	esac
+-	echo ${UNAME_PROCESSOR}-apple-darwin${UNAME_RELEASE}
+-	exit ;;
+-    *:procnto*:*:* | *:QNX:[0123456789]*:*)
+-	UNAME_PROCESSOR=`uname -p`
+-	if test "$UNAME_PROCESSOR" = "x86"; then
+-		UNAME_PROCESSOR=i386
+-		UNAME_MACHINE=pc
+-	fi
+-	echo ${UNAME_PROCESSOR}-${UNAME_MACHINE}-nto-qnx${UNAME_RELEASE}
+-	exit ;;
+-    *:QNX:*:4*)
+-	echo i386-pc-qnx
+-	exit ;;
+-    NSE-?:NONSTOP_KERNEL:*:*)
+-	echo nse-tandem-nsk${UNAME_RELEASE}
+-	exit ;;
+-    NSR-?:NONSTOP_KERNEL:*:*)
+-	echo nsr-tandem-nsk${UNAME_RELEASE}
+-	exit ;;
+-    *:NonStop-UX:*:*)
+-	echo mips-compaq-nonstopux
+-	exit ;;
+-    BS2000:POSIX*:*:*)
+-	echo bs2000-siemens-sysv
+-	exit ;;
+-    DS/*:UNIX_System_V:*:*)
+-	echo ${UNAME_MACHINE}-${UNAME_SYSTEM}-${UNAME_RELEASE}
+-	exit ;;
+-    *:Plan9:*:*)
+-	# "uname -m" is not consistent, so use $cputype instead. 386
+-	# is converted to i386 for consistency with other x86
+-	# operating systems.
+-	if test "$cputype" = "386"; then
+-	    UNAME_MACHINE=i386
+-	else
+-	    UNAME_MACHINE="$cputype"
+-	fi
+-	echo ${UNAME_MACHINE}-unknown-plan9
+-	exit ;;
+-    *:TOPS-10:*:*)
+-	echo pdp10-unknown-tops10
+-	exit ;;
+-    *:TENEX:*:*)
+-	echo pdp10-unknown-tenex
+-	exit ;;
+-    KS10:TOPS-20:*:* | KL10:TOPS-20:*:* | TYPE4:TOPS-20:*:*)
+-	echo pdp10-dec-tops20
+-	exit ;;
+-    XKL-1:TOPS-20:*:* | TYPE5:TOPS-20:*:*)
+-	echo pdp10-xkl-tops20
+-	exit ;;
+-    *:TOPS-20:*:*)
+-	echo pdp10-unknown-tops20
+-	exit ;;
+-    *:ITS:*:*)
+-	echo pdp10-unknown-its
+-	exit ;;
+-    SEI:*:*:SEIUX)
+-        echo mips-sei-seiux${UNAME_RELEASE}
+-	exit ;;
+-    *:DragonFly:*:*)
+-	echo ${UNAME_MACHINE}-unknown-dragonfly`echo ${UNAME_RELEASE}|sed -e 's/[-(].*//'`
+-	exit ;;
+-    *:*VMS:*:*)
+-    	UNAME_MACHINE=`(uname -p) 2>/dev/null`
+-	case "${UNAME_MACHINE}" in
+-	    A*) echo alpha-dec-vms ; exit ;;
+-	    I*) echo ia64-dec-vms ; exit ;;
+-	    V*) echo vax-dec-vms ; exit ;;
+-	esac ;;
+-    *:XENIX:*:SysV)
+-	echo i386-pc-xenix
+-	exit ;;
+-    i*86:skyos:*:*)
+-	echo ${UNAME_MACHINE}-pc-skyos`echo ${UNAME_RELEASE}` | sed -e 's/ .*$//'
+-	exit ;;
+-    i*86:rdos:*:*)
+-	echo ${UNAME_MACHINE}-pc-rdos
+-	exit ;;
+-    i*86:AROS:*:*)
+-	echo ${UNAME_MACHINE}-pc-aros
+-	exit ;;
+-esac
+-
+-#echo '(No uname command or uname output not recognized.)' 1>&2
+-#echo "${UNAME_MACHINE}:${UNAME_SYSTEM}:${UNAME_RELEASE}:${UNAME_VERSION}" 1>&2
+-
+-eval $set_cc_for_build
+-cat >$dummy.c <<EOF
+-#ifdef _SEQUENT_
+-# include <sys/types.h>
+-# include <sys/utsname.h>
+-#endif
+-main ()
+-{
+-#if defined (sony)
+-#if defined (MIPSEB)
+-  /* BFD wants "bsd" instead of "newsos".  Perhaps BFD should be changed,
+-     I don't know....  */
+-  printf ("mips-sony-bsd\n"); exit (0);
+-#else
+-#include <sys/param.h>
+-  printf ("m68k-sony-newsos%s\n",
+-#ifdef NEWSOS4
+-          "4"
+-#else
+-	  ""
+-#endif
+-         ); exit (0);
+-#endif
+-#endif
+-
+-#if defined (__arm) && defined (__acorn) && defined (__unix)
+-  printf ("arm-acorn-riscix\n"); exit (0);
+-#endif
+-
+-#if defined (hp300) && !defined (hpux)
+-  printf ("m68k-hp-bsd\n"); exit (0);
+-#endif
+-
+-#if defined (NeXT)
+-#if !defined (__ARCHITECTURE__)
+-#define __ARCHITECTURE__ "m68k"
+-#endif
+-  int version;
+-  version=`(hostinfo | sed -n 's/.*NeXT Mach \([0-9]*\).*/\1/p') 2>/dev/null`;
+-  if (version < 4)
+-    printf ("%s-next-nextstep%d\n", __ARCHITECTURE__, version);
+-  else
+-    printf ("%s-next-openstep%d\n", __ARCHITECTURE__, version);
+-  exit (0);
+-#endif
+-
+-#if defined (MULTIMAX) || defined (n16)
+-#if defined (UMAXV)
+-  printf ("ns32k-encore-sysv\n"); exit (0);
+-#else
+-#if defined (CMU)
+-  printf ("ns32k-encore-mach\n"); exit (0);
+-#else
+-  printf ("ns32k-encore-bsd\n"); exit (0);
+-#endif
+-#endif
+-#endif
+-
+-#if defined (__386BSD__)
+-  printf ("i386-pc-bsd\n"); exit (0);
+-#endif
+-
+-#if defined (sequent)
+-#if defined (i386)
+-  printf ("i386-sequent-dynix\n"); exit (0);
+-#endif
+-#if defined (ns32000)
+-  printf ("ns32k-sequent-dynix\n"); exit (0);
+-#endif
+-#endif
+-
+-#if defined (_SEQUENT_)
+-    struct utsname un;
+-
+-    uname(&un);
+-
+-    if (strncmp(un.version, "V2", 2) == 0) {
+-	printf ("i386-sequent-ptx2\n"); exit (0);
+-    }
+-    if (strncmp(un.version, "V1", 2) == 0) { /* XXX is V1 correct? */
+-	printf ("i386-sequent-ptx1\n"); exit (0);
+-    }
+-    printf ("i386-sequent-ptx\n"); exit (0);
+-
+-#endif
+-
+-#if defined (vax)
+-# if !defined (ultrix)
+-#  include <sys/param.h>
+-#  if defined (BSD)
+-#   if BSD == 43
+-      printf ("vax-dec-bsd4.3\n"); exit (0);
+-#   else
+-#    if BSD == 199006
+-      printf ("vax-dec-bsd4.3reno\n"); exit (0);
+-#    else
+-      printf ("vax-dec-bsd\n"); exit (0);
+-#    endif
+-#   endif
+-#  else
+-    printf ("vax-dec-bsd\n"); exit (0);
+-#  endif
+-# else
+-    printf ("vax-dec-ultrix\n"); exit (0);
+-# endif
+-#endif
+-
+-#if defined (alliant) && defined (i860)
+-  printf ("i860-alliant-bsd\n"); exit (0);
+-#endif
+-
+-  exit (1);
+-}
+-EOF
+-
+-$CC_FOR_BUILD -o $dummy $dummy.c 2>/dev/null && SYSTEM_NAME=`$dummy` &&
+-	{ echo "$SYSTEM_NAME"; exit; }
+-
+-# Apollos put the system type in the environment.
+-
+-test -d /usr/apollo && { echo ${ISP}-apollo-${SYSTYPE}; exit; }
+-
+-# Convex versions that predate uname can use getsysinfo(1)
+-
+-if [ -x /usr/convex/getsysinfo ]
+-then
+-    case `getsysinfo -f cpu_type` in
+-    c1*)
+-	echo c1-convex-bsd
+-	exit ;;
+-    c2*)
+-	if getsysinfo -f scalar_acc
+-	then echo c32-convex-bsd
+-	else echo c2-convex-bsd
+-	fi
+-	exit ;;
+-    c34*)
+-	echo c34-convex-bsd
+-	exit ;;
+-    c38*)
+-	echo c38-convex-bsd
+-	exit ;;
+-    c4*)
+-	echo c4-convex-bsd
+-	exit ;;
+-    esac
+-fi
+-
+-cat >&2 <<EOF
+-$0: unable to guess system type
+-
+-This script, last modified $timestamp, has failed to recognize
+-the operating system you are using. It is advised that you
+-download the most up to date version of the config scripts from
+-
+-  http://git.savannah.gnu.org/gitweb/?p=config.git;a=blob_plain;f=config.guess;hb=HEAD
+-and
+-  http://git.savannah.gnu.org/gitweb/?p=config.git;a=blob_plain;f=config.sub;hb=HEAD
+-
+-If the version you run ($0) is already up to date, please
+-send the following data and any information you think might be
+-pertinent to <config-patches@gnu.org> in order to provide the needed
+-information to handle your system.
+-
+-config.guess timestamp = $timestamp
+-
+-uname -m = `(uname -m) 2>/dev/null || echo unknown`
+-uname -r = `(uname -r) 2>/dev/null || echo unknown`
+-uname -s = `(uname -s) 2>/dev/null || echo unknown`
+-uname -v = `(uname -v) 2>/dev/null || echo unknown`
+-
+-/usr/bin/uname -p = `(/usr/bin/uname -p) 2>/dev/null`
+-/bin/uname -X     = `(/bin/uname -X) 2>/dev/null`
+-
+-hostinfo               = `(hostinfo) 2>/dev/null`
+-/bin/universe          = `(/bin/universe) 2>/dev/null`
+-/usr/bin/arch -k       = `(/usr/bin/arch -k) 2>/dev/null`
+-/bin/arch              = `(/bin/arch) 2>/dev/null`
+-/usr/bin/oslevel       = `(/usr/bin/oslevel) 2>/dev/null`
+-/usr/convex/getsysinfo = `(/usr/convex/getsysinfo) 2>/dev/null`
+-
+-UNAME_MACHINE = ${UNAME_MACHINE}
+-UNAME_RELEASE = ${UNAME_RELEASE}
+-UNAME_SYSTEM  = ${UNAME_SYSTEM}
+-UNAME_VERSION = ${UNAME_VERSION}
+-EOF
+-
+-exit 1
+-
+-# Local variables:
+-# eval: (add-hook 'write-file-hooks 'time-stamp)
+-# time-stamp-start: "timestamp='"
+-# time-stamp-format: "%:y-%02m-%02d"
+-# time-stamp-end: "'"
+-# End:
+diff -Nur dosbox-0.74/config.h.in dosbox/config.h.in
+--- dosbox-0.74/config.h.in	2010-05-10 21:01:28.000000000 +0200
++++ dosbox/config.h.in	1970-01-01 01:00:00.000000000 +0100
+@@ -1,310 +0,0 @@
+-/* config.h.in.  Generated from configure.in by autoheader.  */
+-
+-
+-/*
+- *  Copyright (C) 2002-2010  The DOSBox Team
+- *
+- *  This program is free software; you can redistribute it and/or modify
+- *  it under the terms of the GNU General Public License as published by
+- *  the Free Software Foundation; either version 2 of the License, or
+- *  (at your option) any later version.
+- *
+- *  This program is distributed in the hope that it will be useful,
+- *  but WITHOUT ANY WARRANTY; without even the implied warranty of
+- *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+- *  GNU Library General Public License for more details.
+- *
+- *  You should have received a copy of the GNU General Public License
+- *  along with this program; if not, write to the Free Software
+- *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+- */
+-
+-
+-/* Define if building universal (internal helper macro) */
+-#undef AC_APPLE_UNIVERSAL_BUILD
+-
+-/* Compiling on BSD */
+-#undef BSD
+-
+-/* Determines if the compilers supports always_inline attribute. */
+-#undef C_ATTRIBUTE_ALWAYS_INLINE
+-
+-/* Determines if the compilers supports fastcall attribute. */
+-#undef C_ATTRIBUTE_FASTCALL
+-
+-/* Define to 1 to use inlined memory functions in cpu core */
+-#undef C_CORE_INLINE
+-
+-/* Define to 1 to enable internal debugger, requires libcurses */
+-#undef C_DEBUG
+-
+-/* Define to 1 if you want serial passthrough support (Win32, Posix and OS/2).
+-   */
+-#undef C_DIRECTSERIAL
+-
+-/* Define to 1 to use x86 dynamic cpu core */
+-#undef C_DYNAMIC_X86
+-
+-/* Define to 1 to use recompiling cpu core. Can not be used together with the
+-   dynamic-x86 core */
+-#undef C_DYNREC
+-
+-/* Define to 1 to enable floating point emulation */
+-#undef C_FPU
+-
+-/* Define to 1 to use a x86 assembly fpu core */
+-#undef C_FPU_X86
+-
+-/* Determines if the compilers supports attributes for structures. */
+-#undef C_HAS_ATTRIBUTE
+-
+-/* Determines if the compilers supports __builtin_expect for branch
+-   prediction. */
+-#undef C_HAS_BUILTIN_EXPECT
+-
+-/* Define to 1 if you have the mprotect function */
+-#undef C_HAVE_MPROTECT
+-
+-/* Define to 1 to enable heavy debugging, also have to enable C_DEBUG */
+-#undef C_HEAVY_DEBUG
+-
+-/* Define to 1 to enable IPX over Internet networking, requires SDL_net */
+-#undef C_IPX
+-
+-/* Define to 1 to enable internal modem support, requires SDL_net */
+-#undef C_MODEM
+-
+-/* Define to 1 to use opengl display output support */
+-#undef C_OPENGL
+-
+-/* Define to 1 to enable SDL_sound support */
+-#undef C_SDL_SOUND
+-
+-/* Define to 1 if you have setpriority support */
+-#undef C_SET_PRIORITY
+-
+-/* Define to 1 to enable screenshots, requires libpng */
+-#undef C_SSHOT
+-
+-/* The type of cpu this target has */
+-#undef C_TARGETCPU
+-
+-/* Define to 1 to use a unaligned memory access */
+-#undef C_UNALIGNED_MEMORY
+-
+-/* define to 1 if you have XKBlib.h and X11 lib */
+-#undef C_X11_XKB
+-
+-/* libm doesn't include powf */
+-#undef DB_HAVE_NO_POWF
+-
+-/* struct dirent has d_type */
+-#undef DIRENT_HAS_D_TYPE
+-
+-/* environ can be included */
+-#undef ENVIRON_INCLUDED
+-
+-/* environ can be linked */
+-#undef ENVIRON_LINKED
+-
+-/* Define to 1 to use ALSA for MIDI */
+-#undef HAVE_ALSA
+-
+-/* Define to 1 if you have the <ddraw.h> header file. */
+-#undef HAVE_DDRAW_H
+-
+-/* Define to 1 if you have the <inttypes.h> header file. */
+-#undef HAVE_INTTYPES_H
+-
+-/* Define to 1 if you have the `asound' library (-lasound). */
+-#undef HAVE_LIBASOUND
+-
+-/* Define to 1 if you have the <memory.h> header file. */
+-#undef HAVE_MEMORY_H
+-
+-/* Define to 1 if you have the <netinet/in.h> header file. */
+-#undef HAVE_NETINET_IN_H
+-
+-/* Define to 1 if you have the <pwd.h> header file. */
+-#undef HAVE_PWD_H
+-
+-/* Define to 1 if you have the <stdint.h> header file. */
+-#undef HAVE_STDINT_H
+-
+-/* Define to 1 if you have the <stdlib.h> header file. */
+-#undef HAVE_STDLIB_H
+-
+-/* Define to 1 if you have the <strings.h> header file. */
+-#undef HAVE_STRINGS_H
+-
+-/* Define to 1 if you have the <string.h> header file. */
+-#undef HAVE_STRING_H
+-
+-/* Define to 1 if you have the <sys/socket.h> header file. */
+-#undef HAVE_SYS_SOCKET_H
+-
+-/* Define to 1 if you have the <sys/stat.h> header file. */
+-#undef HAVE_SYS_STAT_H
+-
+-/* Define to 1 if you have the <sys/types.h> header file. */
+-#undef HAVE_SYS_TYPES_H
+-
+-/* Define to 1 if you have the <unistd.h> header file. */
+-#undef HAVE_UNISTD_H
+-
+-/* Compiling on GNU/Linux */
+-#undef LINUX
+-
+-/* Compiling on Mac OS X */
+-#undef MACOSX
+-
+-/* Compiling on OS/2 EMX */
+-#undef OS2
+-
+-/* Name of package */
+-#undef PACKAGE
+-
+-/* Define to the address where bug reports for this package should be sent. */
+-#undef PACKAGE_BUGREPORT
+-
+-/* Define to the full name of this package. */
+-#undef PACKAGE_NAME
+-
+-/* Define to the full name and version of this package. */
+-#undef PACKAGE_STRING
+-
+-/* Define to the one symbol short name of this package. */
+-#undef PACKAGE_TARNAME
+-
+-/* Define to the home page for this package. */
+-#undef PACKAGE_URL
+-
+-/* Define to the version of this package. */
+-#undef PACKAGE_VERSION
+-
+-/* The size of `int *', as computed by sizeof. */
+-#undef SIZEOF_INT_P
+-
+-/* The size of `unsigned char', as computed by sizeof. */
+-#undef SIZEOF_UNSIGNED_CHAR
+-
+-/* The size of `unsigned int', as computed by sizeof. */
+-#undef SIZEOF_UNSIGNED_INT
+-
+-/* The size of `unsigned long', as computed by sizeof. */
+-#undef SIZEOF_UNSIGNED_LONG
+-
+-/* The size of `unsigned long long', as computed by sizeof. */
+-#undef SIZEOF_UNSIGNED_LONG_LONG
+-
+-/* The size of `unsigned short', as computed by sizeof. */
+-#undef SIZEOF_UNSIGNED_SHORT
+-
+-/* Define to 1 if you have the ANSI C header files. */
+-#undef STDC_HEADERS
+-
+-/* Define to 1 if your <sys/time.h> declares `struct tm'. */
+-#undef TM_IN_SYS_TIME
+-
+-/* Version number of package */
+-#undef VERSION
+-
+-/* Define WORDS_BIGENDIAN to 1 if your processor stores words with the most
+-   significant byte first (like Motorola and SPARC, unlike Intel). */
+-#if defined AC_APPLE_UNIVERSAL_BUILD
+-# if defined __BIG_ENDIAN__
+-#  define WORDS_BIGENDIAN 1
+-# endif
+-#else
+-# ifndef WORDS_BIGENDIAN
+-#  undef WORDS_BIGENDIAN
+-# endif
+-#endif
+-
+-/* Define to empty if `const' does not conform to ANSI C. */
+-#undef const
+-
+-/* Define to `__inline__' or `__inline' if that's what the C compiler
+-   calls it, or to nothing if 'inline' is not supported under any name.  */
+-#ifndef __cplusplus
+-#undef inline
+-#endif
+-
+-/* Define to `unsigned int' if <sys/types.h> does not define. */
+-#undef size_t
+-
+-/* Define to `int` if you don't have socklen_t */
+-#undef socklen_t
+-
+-#if C_ATTRIBUTE_ALWAYS_INLINE
+-#define INLINE inline __attribute__((always_inline))
+-#else
+-#define INLINE inline
+-#endif
+-
+-#if C_ATTRIBUTE_FASTCALL
+-#define DB_FASTCALL __attribute__((fastcall))
+-#else
+-#define DB_FASTCALL
+-#endif
+-
+-#if C_HAS_ATTRIBUTE
+-#define GCC_ATTRIBUTE(x) __attribute__ ((x))
+-#else
+-#define GCC_ATTRIBUTE(x) /* attribute not supported */
+-#endif
+-
+-#if C_HAS_BUILTIN_EXPECT
+-#define GCC_UNLIKELY(x) __builtin_expect((x),0)
+-#define GCC_LIKELY(x) __builtin_expect((x),1)
+-#else
+-#define GCC_UNLIKELY(x) (x)
+-#define GCC_LIKELY(x) (x)
+-#endif
+-
+-
+-typedef         double     Real64;
+-
+-#if SIZEOF_UNSIGNED_CHAR != 1
+-#  error "sizeof (unsigned char) != 1"
+-#else
+-  typedef unsigned char Bit8u;
+-  typedef   signed char Bit8s;
+-#endif
+-
+-#if SIZEOF_UNSIGNED_SHORT != 2
+-#  error "sizeof (unsigned short) != 2"
+-#else
+-  typedef unsigned short Bit16u;
+-  typedef   signed short Bit16s;
+-#endif
+-
+-#if SIZEOF_UNSIGNED_INT == 4
+-  typedef unsigned int Bit32u;
+-  typedef   signed int Bit32s;
+-#elif SIZEOF_UNSIGNED_LONG == 4
+-  typedef unsigned long Bit32u;
+-  typedef   signed long Bit32s;
+-#else
+-#  error "can't find sizeof(type) of 4 bytes!"
+-#endif
+-
+-#if SIZEOF_UNSIGNED_LONG == 8
+-  typedef unsigned long Bit64u;
+-  typedef   signed long Bit64s;
+-#elif SIZEOF_UNSIGNED_LONG_LONG == 8
+-  typedef unsigned long long Bit64u;
+-  typedef   signed long long Bit64s;
+-#else
+-#  error "can't find data type of 8 bytes"
+-#endif
+-
+-#if SIZEOF_INT_P == 4
+-  typedef Bit32u Bitu;
+-  typedef Bit32s Bits;
+-#else
+-  typedef Bit64u Bitu;
+-  typedef Bit64s Bits;
+-#endif
+-
+-
+diff -Nur dosbox-0.74/config.sub dosbox/config.sub
+--- dosbox-0.74/config.sub	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/config.sub	1970-01-01 01:00:00.000000000 +0100
+@@ -1,1714 +0,0 @@
+-#! /bin/sh
+-# Configuration validation subroutine script.
+-#   Copyright (C) 1992, 1993, 1994, 1995, 1996, 1997, 1998, 1999,
+-#   2000, 2001, 2002, 2003, 2004, 2005, 2006, 2007, 2008, 2009, 2010
+-#   Free Software Foundation, Inc.
+-
+-timestamp='2010-01-22'
+-
+-# This file is (in principle) common to ALL GNU software.
+-# The presence of a machine in this file suggests that SOME GNU software
+-# can handle that machine.  It does not imply ALL GNU software can.
+-#
+-# This file is free software; you can redistribute it and/or modify
+-# it under the terms of the GNU General Public License as published by
+-# the Free Software Foundation; either version 2 of the License, or
+-# (at your option) any later version.
+-#
+-# This program is distributed in the hope that it will be useful,
+-# but WITHOUT ANY WARRANTY; without even the implied warranty of
+-# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+-# GNU General Public License for more details.
+-#
+-# You should have received a copy of the GNU General Public License
+-# along with this program; if not, write to the Free Software
+-# Foundation, Inc., 51 Franklin Street - Fifth Floor, Boston, MA
+-# 02110-1301, USA.
+-#
+-# As a special exception to the GNU General Public License, if you
+-# distribute this file as part of a program that contains a
+-# configuration script generated by Autoconf, you may include it under
+-# the same distribution terms that you use for the rest of that program.
+-
+-
+-# Please send patches to <config-patches@gnu.org>.  Submit a context
+-# diff and a properly formatted GNU ChangeLog entry.
+-#
+-# Configuration subroutine to validate and canonicalize a configuration type.
+-# Supply the specified configuration type as an argument.
+-# If it is invalid, we print an error message on stderr and exit with code 1.
+-# Otherwise, we print the canonical config type on stdout and succeed.
+-
+-# You can get the latest version of this script from:
+-# http://git.savannah.gnu.org/gitweb/?p=config.git;a=blob_plain;f=config.sub;hb=HEAD
+-
+-# This file is supposed to be the same for all GNU packages
+-# and recognize all the CPU types, system types and aliases
+-# that are meaningful with *any* GNU software.
+-# Each package is responsible for reporting which valid configurations
+-# it does not support.  The user should be able to distinguish
+-# a failure to support a valid configuration from a meaningless
+-# configuration.
+-
+-# The goal of this file is to map all the various variations of a given
+-# machine specification into a single specification in the form:
+-#	CPU_TYPE-MANUFACTURER-OPERATING_SYSTEM
+-# or in some cases, the newer four-part form:
+-#	CPU_TYPE-MANUFACTURER-KERNEL-OPERATING_SYSTEM
+-# It is wrong to echo any other type of specification.
+-
+-me=`echo "$0" | sed -e 's,.*/,,'`
+-
+-usage="\
+-Usage: $0 [OPTION] CPU-MFR-OPSYS
+-       $0 [OPTION] ALIAS
+-
+-Canonicalize a configuration name.
+-
+-Operation modes:
+-  -h, --help         print this help, then exit
+-  -t, --time-stamp   print date of last modification, then exit
+-  -v, --version      print version number, then exit
+-
+-Report bugs and patches to <config-patches@gnu.org>."
+-
+-version="\
+-GNU config.sub ($timestamp)
+-
+-Copyright (C) 1992, 1993, 1994, 1995, 1996, 1997, 1998, 1999, 2000,
+-2001, 2002, 2003, 2004, 2005, 2006, 2007, 2008, 2009, 2010 Free
+-Software Foundation, Inc.
+-
+-This is free software; see the source for copying conditions.  There is NO
+-warranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE."
+-
+-help="
+-Try \`$me --help' for more information."
+-
+-# Parse command line
+-while test $# -gt 0 ; do
+-  case $1 in
+-    --time-stamp | --time* | -t )
+-       echo "$timestamp" ; exit ;;
+-    --version | -v )
+-       echo "$version" ; exit ;;
+-    --help | --h* | -h )
+-       echo "$usage"; exit ;;
+-    -- )     # Stop option processing
+-       shift; break ;;
+-    - )	# Use stdin as input.
+-       break ;;
+-    -* )
+-       echo "$me: invalid option $1$help"
+-       exit 1 ;;
+-
+-    *local*)
+-       # First pass through any local machine types.
+-       echo $1
+-       exit ;;
+-
+-    * )
+-       break ;;
+-  esac
+-done
+-
+-case $# in
+- 0) echo "$me: missing argument$help" >&2
+-    exit 1;;
+- 1) ;;
+- *) echo "$me: too many arguments$help" >&2
+-    exit 1;;
+-esac
+-
+-# Separate what the user gave into CPU-COMPANY and OS or KERNEL-OS (if any).
+-# Here we must recognize all the valid KERNEL-OS combinations.
+-maybe_os=`echo $1 | sed 's/^\(.*\)-\([^-]*-[^-]*\)$/\2/'`
+-case $maybe_os in
+-  nto-qnx* | linux-gnu* | linux-dietlibc | linux-newlib* | linux-uclibc* | \
+-  uclinux-uclibc* | uclinux-gnu* | kfreebsd*-gnu* | knetbsd*-gnu* | netbsd*-gnu* | \
+-  kopensolaris*-gnu* | \
+-  storm-chaos* | os2-emx* | rtmk-nova*)
+-    os=-$maybe_os
+-    basic_machine=`echo $1 | sed 's/^\(.*\)-\([^-]*-[^-]*\)$/\1/'`
+-    ;;
+-  *)
+-    basic_machine=`echo $1 | sed 's/-[^-]*$//'`
+-    if [ $basic_machine != $1 ]
+-    then os=`echo $1 | sed 's/.*-/-/'`
+-    else os=; fi
+-    ;;
+-esac
+-
+-### Let's recognize common machines as not being operating systems so
+-### that things like config.sub decstation-3100 work.  We also
+-### recognize some manufacturers as not being operating systems, so we
+-### can provide default operating systems below.
+-case $os in
+-	-sun*os*)
+-		# Prevent following clause from handling this invalid input.
+-		;;
+-	-dec* | -mips* | -sequent* | -encore* | -pc532* | -sgi* | -sony* | \
+-	-att* | -7300* | -3300* | -delta* | -motorola* | -sun[234]* | \
+-	-unicom* | -ibm* | -next | -hp | -isi* | -apollo | -altos* | \
+-	-convergent* | -ncr* | -news | -32* | -3600* | -3100* | -hitachi* |\
+-	-c[123]* | -convex* | -sun | -crds | -omron* | -dg | -ultra | -tti* | \
+-	-harris | -dolphin | -highlevel | -gould | -cbm | -ns | -masscomp | \
+-	-apple | -axis | -knuth | -cray | -microblaze)
+-		os=
+-		basic_machine=$1
+-		;;
+-        -bluegene*)
+-	        os=-cnk
+-		;;
+-	-sim | -cisco | -oki | -wec | -winbond)
+-		os=
+-		basic_machine=$1
+-		;;
+-	-scout)
+-		;;
+-	-wrs)
+-		os=-vxworks
+-		basic_machine=$1
+-		;;
+-	-chorusos*)
+-		os=-chorusos
+-		basic_machine=$1
+-		;;
+- 	-chorusrdb)
+- 		os=-chorusrdb
+-		basic_machine=$1
+- 		;;
+-	-hiux*)
+-		os=-hiuxwe2
+-		;;
+-	-sco6)
+-		os=-sco5v6
+-		basic_machine=`echo $1 | sed -e 's/86-.*/86-pc/'`
+-		;;
+-	-sco5)
+-		os=-sco3.2v5
+-		basic_machine=`echo $1 | sed -e 's/86-.*/86-pc/'`
+-		;;
+-	-sco4)
+-		os=-sco3.2v4
+-		basic_machine=`echo $1 | sed -e 's/86-.*/86-pc/'`
+-		;;
+-	-sco3.2.[4-9]*)
+-		os=`echo $os | sed -e 's/sco3.2./sco3.2v/'`
+-		basic_machine=`echo $1 | sed -e 's/86-.*/86-pc/'`
+-		;;
+-	-sco3.2v[4-9]*)
+-		# Don't forget version if it is 3.2v4 or newer.
+-		basic_machine=`echo $1 | sed -e 's/86-.*/86-pc/'`
+-		;;
+-	-sco5v6*)
+-		# Don't forget version if it is 3.2v4 or newer.
+-		basic_machine=`echo $1 | sed -e 's/86-.*/86-pc/'`
+-		;;
+-	-sco*)
+-		os=-sco3.2v2
+-		basic_machine=`echo $1 | sed -e 's/86-.*/86-pc/'`
+-		;;
+-	-udk*)
+-		basic_machine=`echo $1 | sed -e 's/86-.*/86-pc/'`
+-		;;
+-	-isc)
+-		os=-isc2.2
+-		basic_machine=`echo $1 | sed -e 's/86-.*/86-pc/'`
+-		;;
+-	-clix*)
+-		basic_machine=clipper-intergraph
+-		;;
+-	-isc*)
+-		basic_machine=`echo $1 | sed -e 's/86-.*/86-pc/'`
+-		;;
+-	-lynx*)
+-		os=-lynxos
+-		;;
+-	-ptx*)
+-		basic_machine=`echo $1 | sed -e 's/86-.*/86-sequent/'`
+-		;;
+-	-windowsnt*)
+-		os=`echo $os | sed -e 's/windowsnt/winnt/'`
+-		;;
+-	-psos*)
+-		os=-psos
+-		;;
+-	-mint | -mint[0-9]*)
+-		basic_machine=m68k-atari
+-		os=-mint
+-		;;
+-esac
+-
+-# Decode aliases for certain CPU-COMPANY combinations.
+-case $basic_machine in
+-	# Recognize the basic CPU types without company name.
+-	# Some are omitted here because they have special meanings below.
+-	1750a | 580 \
+-	| a29k \
+-	| alpha | alphaev[4-8] | alphaev56 | alphaev6[78] | alphapca5[67] \
+-	| alpha64 | alpha64ev[4-8] | alpha64ev56 | alpha64ev6[78] | alpha64pca5[67] \
+-	| am33_2.0 \
+-	| arc | arm | arm[bl]e | arme[lb] | armv[2345] | armv[345][lb] | avr | avr32 \
+-	| bfin \
+-	| c4x | clipper \
+-	| d10v | d30v | dlx | dsp16xx \
+-	| fido | fr30 | frv \
+-	| h8300 | h8500 | hppa | hppa1.[01] | hppa2.0 | hppa2.0[nw] | hppa64 \
+-	| i370 | i860 | i960 | ia64 \
+-	| ip2k | iq2000 \
+-	| lm32 \
+-	| m32c | m32r | m32rle | m68000 | m68k | m88k \
+-	| maxq | mb | microblaze | mcore | mep | metag \
+-	| mips | mipsbe | mipseb | mipsel | mipsle \
+-	| mips16 \
+-	| mips64 | mips64el \
+-	| mips64octeon | mips64octeonel \
+-	| mips64orion | mips64orionel \
+-	| mips64r5900 | mips64r5900el \
+-	| mips64vr | mips64vrel \
+-	| mips64vr4100 | mips64vr4100el \
+-	| mips64vr4300 | mips64vr4300el \
+-	| mips64vr5000 | mips64vr5000el \
+-	| mips64vr5900 | mips64vr5900el \
+-	| mipsisa32 | mipsisa32el \
+-	| mipsisa32r2 | mipsisa32r2el \
+-	| mipsisa64 | mipsisa64el \
+-	| mipsisa64r2 | mipsisa64r2el \
+-	| mipsisa64sb1 | mipsisa64sb1el \
+-	| mipsisa64sr71k | mipsisa64sr71kel \
+-	| mipstx39 | mipstx39el \
+-	| mn10200 | mn10300 \
+-	| moxie \
+-	| mt \
+-	| msp430 \
+-	| nios | nios2 \
+-	| ns16k | ns32k \
+-	| or32 \
+-	| pdp10 | pdp11 | pj | pjl \
+-	| powerpc | powerpc64 | powerpc64le | powerpcle | ppcbe \
+-	| pyramid \
+-	| rx \
+-	| score \
+-	| sh | sh[1234] | sh[24]a | sh[24]aeb | sh[23]e | sh[34]eb | sheb | shbe | shle | sh[1234]le | sh3ele \
+-	| sh64 | sh64le \
+-	| sparc | sparc64 | sparc64b | sparc64v | sparc86x | sparclet | sparclite \
+-	| sparcv8 | sparcv9 | sparcv9b | sparcv9v \
+-	| spu | strongarm \
+-	| tahoe | thumb | tic4x | tic80 | tron \
+-	| ubicom32 \
+-	| v850 | v850e \
+-	| we32k \
+-	| x86 | xc16x | xscale | xscalee[bl] | xstormy16 | xtensa \
+-	| z8k | z80)
+-		basic_machine=$basic_machine-unknown
+-		;;
+-	m6811 | m68hc11 | m6812 | m68hc12 | picochip)
+-		# Motorola 68HC11/12.
+-		basic_machine=$basic_machine-unknown
+-		os=-none
+-		;;
+-	m88110 | m680[12346]0 | m683?2 | m68360 | m5200 | v70 | w65 | z8k)
+-		;;
+-	ms1)
+-		basic_machine=mt-unknown
+-		;;
+-
+-	# We use `pc' rather than `unknown'
+-	# because (1) that's what they normally are, and
+-	# (2) the word "unknown" tends to confuse beginning users.
+-	i*86 | x86_64)
+-	  basic_machine=$basic_machine-pc
+-	  ;;
+-	# Object if more than one company name word.
+-	*-*-*)
+-		echo Invalid configuration \`$1\': machine \`$basic_machine\' not recognized 1>&2
+-		exit 1
+-		;;
+-	# Recognize the basic CPU types with company name.
+-	580-* \
+-	| a29k-* \
+-	| alpha-* | alphaev[4-8]-* | alphaev56-* | alphaev6[78]-* \
+-	| alpha64-* | alpha64ev[4-8]-* | alpha64ev56-* | alpha64ev6[78]-* \
+-	| alphapca5[67]-* | alpha64pca5[67]-* | arc-* \
+-	| arm-*  | armbe-* | armle-* | armeb-* | armv*-* \
+-	| avr-* | avr32-* \
+-	| bfin-* | bs2000-* \
+-	| c[123]* | c30-* | [cjt]90-* | c4x-* | c54x-* | c55x-* | c6x-* \
+-	| clipper-* | craynv-* | cydra-* \
+-	| d10v-* | d30v-* | dlx-* \
+-	| elxsi-* \
+-	| f30[01]-* | f700-* | fido-* | fr30-* | frv-* | fx80-* \
+-	| h8300-* | h8500-* \
+-	| hppa-* | hppa1.[01]-* | hppa2.0-* | hppa2.0[nw]-* | hppa64-* \
+-	| i*86-* | i860-* | i960-* | ia64-* \
+-	| ip2k-* | iq2000-* \
+-	| lm32-* \
+-	| m32c-* | m32r-* | m32rle-* \
+-	| m68000-* | m680[012346]0-* | m68360-* | m683?2-* | m68k-* \
+-	| m88110-* | m88k-* | maxq-* | mcore-* | metag-* | microblaze-* \
+-	| mips-* | mipsbe-* | mipseb-* | mipsel-* | mipsle-* \
+-	| mips16-* \
+-	| mips64-* | mips64el-* \
+-	| mips64octeon-* | mips64octeonel-* \
+-	| mips64orion-* | mips64orionel-* \
+-	| mips64r5900-* | mips64r5900el-* \
+-	| mips64vr-* | mips64vrel-* \
+-	| mips64vr4100-* | mips64vr4100el-* \
+-	| mips64vr4300-* | mips64vr4300el-* \
+-	| mips64vr5000-* | mips64vr5000el-* \
+-	| mips64vr5900-* | mips64vr5900el-* \
+-	| mipsisa32-* | mipsisa32el-* \
+-	| mipsisa32r2-* | mipsisa32r2el-* \
+-	| mipsisa64-* | mipsisa64el-* \
+-	| mipsisa64r2-* | mipsisa64r2el-* \
+-	| mipsisa64sb1-* | mipsisa64sb1el-* \
+-	| mipsisa64sr71k-* | mipsisa64sr71kel-* \
+-	| mipstx39-* | mipstx39el-* \
+-	| mmix-* \
+-	| mt-* \
+-	| msp430-* \
+-	| nios-* | nios2-* \
+-	| none-* | np1-* | ns16k-* | ns32k-* \
+-	| orion-* \
+-	| pdp10-* | pdp11-* | pj-* | pjl-* | pn-* | power-* \
+-	| powerpc-* | powerpc64-* | powerpc64le-* | powerpcle-* | ppcbe-* \
+-	| pyramid-* \
+-	| romp-* | rs6000-* | rx-* \
+-	| sh-* | sh[1234]-* | sh[24]a-* | sh[24]aeb-* | sh[23]e-* | sh[34]eb-* | sheb-* | shbe-* \
+-	| shle-* | sh[1234]le-* | sh3ele-* | sh64-* | sh64le-* \
+-	| sparc-* | sparc64-* | sparc64b-* | sparc64v-* | sparc86x-* | sparclet-* \
+-	| sparclite-* \
+-	| sparcv8-* | sparcv9-* | sparcv9b-* | sparcv9v-* | strongarm-* | sv1-* | sx?-* \
+-	| tahoe-* | thumb-* \
+-	| tic30-* | tic4x-* | tic54x-* | tic55x-* | tic6x-* | tic80-* \
+-	| tile-* | tilegx-* \
+-	| tron-* \
+-	| ubicom32-* \
+-	| v850-* | v850e-* | vax-* \
+-	| we32k-* \
+-	| x86-* | x86_64-* | xc16x-* | xps100-* | xscale-* | xscalee[bl]-* \
+-	| xstormy16-* | xtensa*-* \
+-	| ymp-* \
+-	| z8k-* | z80-*)
+-		;;
+-	# Recognize the basic CPU types without company name, with glob match.
+-	xtensa*)
+-		basic_machine=$basic_machine-unknown
+-		;;
+-	# Recognize the various machine names and aliases which stand
+-	# for a CPU type and a company and sometimes even an OS.
+-	386bsd)
+-		basic_machine=i386-unknown
+-		os=-bsd
+-		;;
+-	3b1 | 7300 | 7300-att | att-7300 | pc7300 | safari | unixpc)
+-		basic_machine=m68000-att
+-		;;
+-	3b*)
+-		basic_machine=we32k-att
+-		;;
+-	a29khif)
+-		basic_machine=a29k-amd
+-		os=-udi
+-		;;
+-    	abacus)
+-		basic_machine=abacus-unknown
+-		;;
+-	adobe68k)
+-		basic_machine=m68010-adobe
+-		os=-scout
+-		;;
+-	alliant | fx80)
+-		basic_machine=fx80-alliant
+-		;;
+-	altos | altos3068)
+-		basic_machine=m68k-altos
+-		;;
+-	am29k)
+-		basic_machine=a29k-none
+-		os=-bsd
+-		;;
+-	amd64)
+-		basic_machine=x86_64-pc
+-		;;
+-	amd64-*)
+-		basic_machine=x86_64-`echo $basic_machine | sed 's/^[^-]*-//'`
+-		;;
+-	amdahl)
+-		basic_machine=580-amdahl
+-		os=-sysv
+-		;;
+-	amiga | amiga-*)
+-		basic_machine=m68k-unknown
+-		;;
+-	amigaos | amigados)
+-		basic_machine=m68k-unknown
+-		os=-amigaos
+-		;;
+-	amigaunix | amix)
+-		basic_machine=m68k-unknown
+-		os=-sysv4
+-		;;
+-	apollo68)
+-		basic_machine=m68k-apollo
+-		os=-sysv
+-		;;
+-	apollo68bsd)
+-		basic_machine=m68k-apollo
+-		os=-bsd
+-		;;
+-	aros)
+-		basic_machine=i386-pc
+-		os=-aros
+-		;;
+-	aux)
+-		basic_machine=m68k-apple
+-		os=-aux
+-		;;
+-	balance)
+-		basic_machine=ns32k-sequent
+-		os=-dynix
+-		;;
+-	blackfin)
+-		basic_machine=bfin-unknown
+-		os=-linux
+-		;;
+-	blackfin-*)
+-		basic_machine=bfin-`echo $basic_machine | sed 's/^[^-]*-//'`
+-		os=-linux
+-		;;
+-	bluegene*)
+-		basic_machine=powerpc-ibm
+-		os=-cnk
+-		;;
+-	c90)
+-		basic_machine=c90-cray
+-		os=-unicos
+-		;;
+-        cegcc)
+-		basic_machine=arm-unknown
+-		os=-cegcc
+-		;;
+-	convex-c1)
+-		basic_machine=c1-convex
+-		os=-bsd
+-		;;
+-	convex-c2)
+-		basic_machine=c2-convex
+-		os=-bsd
+-		;;
+-	convex-c32)
+-		basic_machine=c32-convex
+-		os=-bsd
+-		;;
+-	convex-c34)
+-		basic_machine=c34-convex
+-		os=-bsd
+-		;;
+-	convex-c38)
+-		basic_machine=c38-convex
+-		os=-bsd
+-		;;
+-	cray | j90)
+-		basic_machine=j90-cray
+-		os=-unicos
+-		;;
+-	craynv)
+-		basic_machine=craynv-cray
+-		os=-unicosmp
+-		;;
+-	cr16)
+-		basic_machine=cr16-unknown
+-		os=-elf
+-		;;
+-	crds | unos)
+-		basic_machine=m68k-crds
+-		;;
+-	crisv32 | crisv32-* | etraxfs*)
+-		basic_machine=crisv32-axis
+-		;;
+-	cris | cris-* | etrax*)
+-		basic_machine=cris-axis
+-		;;
+-	crx)
+-		basic_machine=crx-unknown
+-		os=-elf
+-		;;
+-	da30 | da30-*)
+-		basic_machine=m68k-da30
+-		;;
+-	decstation | decstation-3100 | pmax | pmax-* | pmin | dec3100 | decstatn)
+-		basic_machine=mips-dec
+-		;;
+-	decsystem10* | dec10*)
+-		basic_machine=pdp10-dec
+-		os=-tops10
+-		;;
+-	decsystem20* | dec20*)
+-		basic_machine=pdp10-dec
+-		os=-tops20
+-		;;
+-	delta | 3300 | motorola-3300 | motorola-delta \
+-	      | 3300-motorola | delta-motorola)
+-		basic_machine=m68k-motorola
+-		;;
+-	delta88)
+-		basic_machine=m88k-motorola
+-		os=-sysv3
+-		;;
+-	dicos)
+-		basic_machine=i686-pc
+-		os=-dicos
+-		;;
+-	djgpp)
+-		basic_machine=i586-pc
+-		os=-msdosdjgpp
+-		;;
+-	dpx20 | dpx20-*)
+-		basic_machine=rs6000-bull
+-		os=-bosx
+-		;;
+-	dpx2* | dpx2*-bull)
+-		basic_machine=m68k-bull
+-		os=-sysv3
+-		;;
+-	ebmon29k)
+-		basic_machine=a29k-amd
+-		os=-ebmon
+-		;;
+-	elxsi)
+-		basic_machine=elxsi-elxsi
+-		os=-bsd
+-		;;
+-	encore | umax | mmax)
+-		basic_machine=ns32k-encore
+-		;;
+-	es1800 | OSE68k | ose68k | ose | OSE)
+-		basic_machine=m68k-ericsson
+-		os=-ose
+-		;;
+-	fx2800)
+-		basic_machine=i860-alliant
+-		;;
+-	genix)
+-		basic_machine=ns32k-ns
+-		;;
+-	gmicro)
+-		basic_machine=tron-gmicro
+-		os=-sysv
+-		;;
+-	go32)
+-		basic_machine=i386-pc
+-		os=-go32
+-		;;
+-	h3050r* | hiux*)
+-		basic_machine=hppa1.1-hitachi
+-		os=-hiuxwe2
+-		;;
+-	h8300hms)
+-		basic_machine=h8300-hitachi
+-		os=-hms
+-		;;
+-	h8300xray)
+-		basic_machine=h8300-hitachi
+-		os=-xray
+-		;;
+-	h8500hms)
+-		basic_machine=h8500-hitachi
+-		os=-hms
+-		;;
+-	harris)
+-		basic_machine=m88k-harris
+-		os=-sysv3
+-		;;
+-	hp300-*)
+-		basic_machine=m68k-hp
+-		;;
+-	hp300bsd)
+-		basic_machine=m68k-hp
+-		os=-bsd
+-		;;
+-	hp300hpux)
+-		basic_machine=m68k-hp
+-		os=-hpux
+-		;;
+-	hp3k9[0-9][0-9] | hp9[0-9][0-9])
+-		basic_machine=hppa1.0-hp
+-		;;
+-	hp9k2[0-9][0-9] | hp9k31[0-9])
+-		basic_machine=m68000-hp
+-		;;
+-	hp9k3[2-9][0-9])
+-		basic_machine=m68k-hp
+-		;;
+-	hp9k6[0-9][0-9] | hp6[0-9][0-9])
+-		basic_machine=hppa1.0-hp
+-		;;
+-	hp9k7[0-79][0-9] | hp7[0-79][0-9])
+-		basic_machine=hppa1.1-hp
+-		;;
+-	hp9k78[0-9] | hp78[0-9])
+-		# FIXME: really hppa2.0-hp
+-		basic_machine=hppa1.1-hp
+-		;;
+-	hp9k8[67]1 | hp8[67]1 | hp9k80[24] | hp80[24] | hp9k8[78]9 | hp8[78]9 | hp9k893 | hp893)
+-		# FIXME: really hppa2.0-hp
+-		basic_machine=hppa1.1-hp
+-		;;
+-	hp9k8[0-9][13679] | hp8[0-9][13679])
+-		basic_machine=hppa1.1-hp
+-		;;
+-	hp9k8[0-9][0-9] | hp8[0-9][0-9])
+-		basic_machine=hppa1.0-hp
+-		;;
+-	hppa-next)
+-		os=-nextstep3
+-		;;
+-	hppaosf)
+-		basic_machine=hppa1.1-hp
+-		os=-osf
+-		;;
+-	hppro)
+-		basic_machine=hppa1.1-hp
+-		os=-proelf
+-		;;
+-	i370-ibm* | ibm*)
+-		basic_machine=i370-ibm
+-		;;
+-# I'm not sure what "Sysv32" means.  Should this be sysv3.2?
+-	i*86v32)
+-		basic_machine=`echo $1 | sed -e 's/86.*/86-pc/'`
+-		os=-sysv32
+-		;;
+-	i*86v4*)
+-		basic_machine=`echo $1 | sed -e 's/86.*/86-pc/'`
+-		os=-sysv4
+-		;;
+-	i*86v)
+-		basic_machine=`echo $1 | sed -e 's/86.*/86-pc/'`
+-		os=-sysv
+-		;;
+-	i*86sol2)
+-		basic_machine=`echo $1 | sed -e 's/86.*/86-pc/'`
+-		os=-solaris2
+-		;;
+-	i386mach)
+-		basic_machine=i386-mach
+-		os=-mach
+-		;;
+-	i386-vsta | vsta)
+-		basic_machine=i386-unknown
+-		os=-vsta
+-		;;
+-	iris | iris4d)
+-		basic_machine=mips-sgi
+-		case $os in
+-		    -irix*)
+-			;;
+-		    *)
+-			os=-irix4
+-			;;
+-		esac
+-		;;
+-	isi68 | isi)
+-		basic_machine=m68k-isi
+-		os=-sysv
+-		;;
+-	m68knommu)
+-		basic_machine=m68k-unknown
+-		os=-linux
+-		;;
+-	m68knommu-*)
+-		basic_machine=m68k-`echo $basic_machine | sed 's/^[^-]*-//'`
+-		os=-linux
+-		;;
+-	m88k-omron*)
+-		basic_machine=m88k-omron
+-		;;
+-	magnum | m3230)
+-		basic_machine=mips-mips
+-		os=-sysv
+-		;;
+-	merlin)
+-		basic_machine=ns32k-utek
+-		os=-sysv
+-		;;
+-        microblaze)
+-		basic_machine=microblaze-xilinx
+-		;;
+-	mingw32)
+-		basic_machine=i386-pc
+-		os=-mingw32
+-		;;
+-	mingw32ce)
+-		basic_machine=arm-unknown
+-		os=-mingw32ce
+-		;;
+-	miniframe)
+-		basic_machine=m68000-convergent
+-		;;
+-	*mint | -mint[0-9]* | *MiNT | *MiNT[0-9]*)
+-		basic_machine=m68k-atari
+-		os=-mint
+-		;;
+-	mips3*-*)
+-		basic_machine=`echo $basic_machine | sed -e 's/mips3/mips64/'`
+-		;;
+-	mips3*)
+-		basic_machine=`echo $basic_machine | sed -e 's/mips3/mips64/'`-unknown
+-		;;
+-	monitor)
+-		basic_machine=m68k-rom68k
+-		os=-coff
+-		;;
+-	morphos)
+-		basic_machine=powerpc-unknown
+-		os=-morphos
+-		;;
+-	msdos)
+-		basic_machine=i386-pc
+-		os=-msdos
+-		;;
+-	ms1-*)
+-		basic_machine=`echo $basic_machine | sed -e 's/ms1-/mt-/'`
+-		;;
+-	mvs)
+-		basic_machine=i370-ibm
+-		os=-mvs
+-		;;
+-	ncr3000)
+-		basic_machine=i486-ncr
+-		os=-sysv4
+-		;;
+-	netbsd386)
+-		basic_machine=i386-unknown
+-		os=-netbsd
+-		;;
+-	netwinder)
+-		basic_machine=armv4l-rebel
+-		os=-linux
+-		;;
+-	news | news700 | news800 | news900)
+-		basic_machine=m68k-sony
+-		os=-newsos
+-		;;
+-	news1000)
+-		basic_machine=m68030-sony
+-		os=-newsos
+-		;;
+-	news-3600 | risc-news)
+-		basic_machine=mips-sony
+-		os=-newsos
+-		;;
+-	necv70)
+-		basic_machine=v70-nec
+-		os=-sysv
+-		;;
+-	next | m*-next )
+-		basic_machine=m68k-next
+-		case $os in
+-		    -nextstep* )
+-			;;
+-		    -ns2*)
+-		      os=-nextstep2
+-			;;
+-		    *)
+-		      os=-nextstep3
+-			;;
+-		esac
+-		;;
+-	nh3000)
+-		basic_machine=m68k-harris
+-		os=-cxux
+-		;;
+-	nh[45]000)
+-		basic_machine=m88k-harris
+-		os=-cxux
+-		;;
+-	nindy960)
+-		basic_machine=i960-intel
+-		os=-nindy
+-		;;
+-	mon960)
+-		basic_machine=i960-intel
+-		os=-mon960
+-		;;
+-	nonstopux)
+-		basic_machine=mips-compaq
+-		os=-nonstopux
+-		;;
+-	np1)
+-		basic_machine=np1-gould
+-		;;
+-	nsr-tandem)
+-		basic_machine=nsr-tandem
+-		;;
+-	op50n-* | op60c-*)
+-		basic_machine=hppa1.1-oki
+-		os=-proelf
+-		;;
+-	openrisc | openrisc-*)
+-		basic_machine=or32-unknown
+-		;;
+-	os400)
+-		basic_machine=powerpc-ibm
+-		os=-os400
+-		;;
+-	OSE68000 | ose68000)
+-		basic_machine=m68000-ericsson
+-		os=-ose
+-		;;
+-	os68k)
+-		basic_machine=m68k-none
+-		os=-os68k
+-		;;
+-	pa-hitachi)
+-		basic_machine=hppa1.1-hitachi
+-		os=-hiuxwe2
+-		;;
+-	paragon)
+-		basic_machine=i860-intel
+-		os=-osf
+-		;;
+-	parisc)
+-		basic_machine=hppa-unknown
+-		os=-linux
+-		;;
+-	parisc-*)
+-		basic_machine=hppa-`echo $basic_machine | sed 's/^[^-]*-//'`
+-		os=-linux
+-		;;
+-	pbd)
+-		basic_machine=sparc-tti
+-		;;
+-	pbb)
+-		basic_machine=m68k-tti
+-		;;
+-	pc532 | pc532-*)
+-		basic_machine=ns32k-pc532
+-		;;
+-	pc98)
+-		basic_machine=i386-pc
+-		;;
+-	pc98-*)
+-		basic_machine=i386-`echo $basic_machine | sed 's/^[^-]*-//'`
+-		;;
+-	pentium | p5 | k5 | k6 | nexgen | viac3)
+-		basic_machine=i586-pc
+-		;;
+-	pentiumpro | p6 | 6x86 | athlon | athlon_*)
+-		basic_machine=i686-pc
+-		;;
+-	pentiumii | pentium2 | pentiumiii | pentium3)
+-		basic_machine=i686-pc
+-		;;
+-	pentium4)
+-		basic_machine=i786-pc
+-		;;
+-	pentium-* | p5-* | k5-* | k6-* | nexgen-* | viac3-*)
+-		basic_machine=i586-`echo $basic_machine | sed 's/^[^-]*-//'`
+-		;;
+-	pentiumpro-* | p6-* | 6x86-* | athlon-*)
+-		basic_machine=i686-`echo $basic_machine | sed 's/^[^-]*-//'`
+-		;;
+-	pentiumii-* | pentium2-* | pentiumiii-* | pentium3-*)
+-		basic_machine=i686-`echo $basic_machine | sed 's/^[^-]*-//'`
+-		;;
+-	pentium4-*)
+-		basic_machine=i786-`echo $basic_machine | sed 's/^[^-]*-//'`
+-		;;
+-	pn)
+-		basic_machine=pn-gould
+-		;;
+-	power)	basic_machine=power-ibm
+-		;;
+-	ppc)	basic_machine=powerpc-unknown
+-		;;
+-	ppc-*)	basic_machine=powerpc-`echo $basic_machine | sed 's/^[^-]*-//'`
+-		;;
+-	ppcle | powerpclittle | ppc-le | powerpc-little)
+-		basic_machine=powerpcle-unknown
+-		;;
+-	ppcle-* | powerpclittle-*)
+-		basic_machine=powerpcle-`echo $basic_machine | sed 's/^[^-]*-//'`
+-		;;
+-	ppc64)	basic_machine=powerpc64-unknown
+-		;;
+-	ppc64-*) basic_machine=powerpc64-`echo $basic_machine | sed 's/^[^-]*-//'`
+-		;;
+-	ppc64le | powerpc64little | ppc64-le | powerpc64-little)
+-		basic_machine=powerpc64le-unknown
+-		;;
+-	ppc64le-* | powerpc64little-*)
+-		basic_machine=powerpc64le-`echo $basic_machine | sed 's/^[^-]*-//'`
+-		;;
+-	ps2)
+-		basic_machine=i386-ibm
+-		;;
+-	pw32)
+-		basic_machine=i586-unknown
+-		os=-pw32
+-		;;
+-	rdos)
+-		basic_machine=i386-pc
+-		os=-rdos
+-		;;
+-	rom68k)
+-		basic_machine=m68k-rom68k
+-		os=-coff
+-		;;
+-	rm[46]00)
+-		basic_machine=mips-siemens
+-		;;
+-	rtpc | rtpc-*)
+-		basic_machine=romp-ibm
+-		;;
+-	s390 | s390-*)
+-		basic_machine=s390-ibm
+-		;;
+-	s390x | s390x-*)
+-		basic_machine=s390x-ibm
+-		;;
+-	sa29200)
+-		basic_machine=a29k-amd
+-		os=-udi
+-		;;
+-	sb1)
+-		basic_machine=mipsisa64sb1-unknown
+-		;;
+-	sb1el)
+-		basic_machine=mipsisa64sb1el-unknown
+-		;;
+-	sde)
+-		basic_machine=mipsisa32-sde
+-		os=-elf
+-		;;
+-	sei)
+-		basic_machine=mips-sei
+-		os=-seiux
+-		;;
+-	sequent)
+-		basic_machine=i386-sequent
+-		;;
+-	sh)
+-		basic_machine=sh-hitachi
+-		os=-hms
+-		;;
+-	sh5el)
+-		basic_machine=sh5le-unknown
+-		;;
+-	sh64)
+-		basic_machine=sh64-unknown
+-		;;
+-	sparclite-wrs | simso-wrs)
+-		basic_machine=sparclite-wrs
+-		os=-vxworks
+-		;;
+-	sps7)
+-		basic_machine=m68k-bull
+-		os=-sysv2
+-		;;
+-	spur)
+-		basic_machine=spur-unknown
+-		;;
+-	st2000)
+-		basic_machine=m68k-tandem
+-		;;
+-	stratus)
+-		basic_machine=i860-stratus
+-		os=-sysv4
+-		;;
+-	sun2)
+-		basic_machine=m68000-sun
+-		;;
+-	sun2os3)
+-		basic_machine=m68000-sun
+-		os=-sunos3
+-		;;
+-	sun2os4)
+-		basic_machine=m68000-sun
+-		os=-sunos4
+-		;;
+-	sun3os3)
+-		basic_machine=m68k-sun
+-		os=-sunos3
+-		;;
+-	sun3os4)
+-		basic_machine=m68k-sun
+-		os=-sunos4
+-		;;
+-	sun4os3)
+-		basic_machine=sparc-sun
+-		os=-sunos3
+-		;;
+-	sun4os4)
+-		basic_machine=sparc-sun
+-		os=-sunos4
+-		;;
+-	sun4sol2)
+-		basic_machine=sparc-sun
+-		os=-solaris2
+-		;;
+-	sun3 | sun3-*)
+-		basic_machine=m68k-sun
+-		;;
+-	sun4)
+-		basic_machine=sparc-sun
+-		;;
+-	sun386 | sun386i | roadrunner)
+-		basic_machine=i386-sun
+-		;;
+-	sv1)
+-		basic_machine=sv1-cray
+-		os=-unicos
+-		;;
+-	symmetry)
+-		basic_machine=i386-sequent
+-		os=-dynix
+-		;;
+-	t3e)
+-		basic_machine=alphaev5-cray
+-		os=-unicos
+-		;;
+-	t90)
+-		basic_machine=t90-cray
+-		os=-unicos
+-		;;
+-	tic54x | c54x*)
+-		basic_machine=tic54x-unknown
+-		os=-coff
+-		;;
+-	tic55x | c55x*)
+-		basic_machine=tic55x-unknown
+-		os=-coff
+-		;;
+-	tic6x | c6x*)
+-		basic_machine=tic6x-unknown
+-		os=-coff
+-		;;
+-        # This must be matched before tile*.
+-        tilegx*)
+-		basic_machine=tilegx-unknown
+-		os=-linux-gnu
+-		;;
+-	tile*)
+-		basic_machine=tile-unknown
+-		os=-linux-gnu
+-		;;
+-	tx39)
+-		basic_machine=mipstx39-unknown
+-		;;
+-	tx39el)
+-		basic_machine=mipstx39el-unknown
+-		;;
+-	toad1)
+-		basic_machine=pdp10-xkl
+-		os=-tops20
+-		;;
+-	tower | tower-32)
+-		basic_machine=m68k-ncr
+-		;;
+-	tpf)
+-		basic_machine=s390x-ibm
+-		os=-tpf
+-		;;
+-	udi29k)
+-		basic_machine=a29k-amd
+-		os=-udi
+-		;;
+-	ultra3)
+-		basic_machine=a29k-nyu
+-		os=-sym1
+-		;;
+-	v810 | necv810)
+-		basic_machine=v810-nec
+-		os=-none
+-		;;
+-	vaxv)
+-		basic_machine=vax-dec
+-		os=-sysv
+-		;;
+-	vms)
+-		basic_machine=vax-dec
+-		os=-vms
+-		;;
+-	vpp*|vx|vx-*)
+-		basic_machine=f301-fujitsu
+-		;;
+-	vxworks960)
+-		basic_machine=i960-wrs
+-		os=-vxworks
+-		;;
+-	vxworks68)
+-		basic_machine=m68k-wrs
+-		os=-vxworks
+-		;;
+-	vxworks29k)
+-		basic_machine=a29k-wrs
+-		os=-vxworks
+-		;;
+-	w65*)
+-		basic_machine=w65-wdc
+-		os=-none
+-		;;
+-	w89k-*)
+-		basic_machine=hppa1.1-winbond
+-		os=-proelf
+-		;;
+-	xbox)
+-		basic_machine=i686-pc
+-		os=-mingw32
+-		;;
+-	xps | xps100)
+-		basic_machine=xps100-honeywell
+-		;;
+-	ymp)
+-		basic_machine=ymp-cray
+-		os=-unicos
+-		;;
+-	z8k-*-coff)
+-		basic_machine=z8k-unknown
+-		os=-sim
+-		;;
+-	z80-*-coff)
+-		basic_machine=z80-unknown
+-		os=-sim
+-		;;
+-	none)
+-		basic_machine=none-none
+-		os=-none
+-		;;
+-
+-# Here we handle the default manufacturer of certain CPU types.  It is in
+-# some cases the only manufacturer, in others, it is the most popular.
+-	w89k)
+-		basic_machine=hppa1.1-winbond
+-		;;
+-	op50n)
+-		basic_machine=hppa1.1-oki
+-		;;
+-	op60c)
+-		basic_machine=hppa1.1-oki
+-		;;
+-	romp)
+-		basic_machine=romp-ibm
+-		;;
+-	mmix)
+-		basic_machine=mmix-knuth
+-		;;
+-	rs6000)
+-		basic_machine=rs6000-ibm
+-		;;
+-	vax)
+-		basic_machine=vax-dec
+-		;;
+-	pdp10)
+-		# there are many clones, so DEC is not a safe bet
+-		basic_machine=pdp10-unknown
+-		;;
+-	pdp11)
+-		basic_machine=pdp11-dec
+-		;;
+-	we32k)
+-		basic_machine=we32k-att
+-		;;
+-	sh[1234] | sh[24]a | sh[24]aeb | sh[34]eb | sh[1234]le | sh[23]ele)
+-		basic_machine=sh-unknown
+-		;;
+-	sparc | sparcv8 | sparcv9 | sparcv9b | sparcv9v)
+-		basic_machine=sparc-sun
+-		;;
+-	cydra)
+-		basic_machine=cydra-cydrome
+-		;;
+-	orion)
+-		basic_machine=orion-highlevel
+-		;;
+-	orion105)
+-		basic_machine=clipper-highlevel
+-		;;
+-	mac | mpw | mac-mpw)
+-		basic_machine=m68k-apple
+-		;;
+-	pmac | pmac-mpw)
+-		basic_machine=powerpc-apple
+-		;;
+-	*-unknown)
+-		# Make sure to match an already-canonicalized machine name.
+-		;;
+-	*)
+-		echo Invalid configuration \`$1\': machine \`$basic_machine\' not recognized 1>&2
+-		exit 1
+-		;;
+-esac
+-
+-# Here we canonicalize certain aliases for manufacturers.
+-case $basic_machine in
+-	*-digital*)
+-		basic_machine=`echo $basic_machine | sed 's/digital.*/dec/'`
+-		;;
+-	*-commodore*)
+-		basic_machine=`echo $basic_machine | sed 's/commodore.*/cbm/'`
+-		;;
+-	*)
+-		;;
+-esac
+-
+-# Decode manufacturer-specific aliases for certain operating systems.
+-
+-if [ x"$os" != x"" ]
+-then
+-case $os in
+-        # First match some system type aliases
+-        # that might get confused with valid system types.
+-	# -solaris* is a basic system type, with this one exception.
+-        -auroraux)
+-	        os=-auroraux
+-		;;
+-	-solaris1 | -solaris1.*)
+-		os=`echo $os | sed -e 's|solaris1|sunos4|'`
+-		;;
+-	-solaris)
+-		os=-solaris2
+-		;;
+-	-svr4*)
+-		os=-sysv4
+-		;;
+-	-unixware*)
+-		os=-sysv4.2uw
+-		;;
+-	-gnu/linux*)
+-		os=`echo $os | sed -e 's|gnu/linux|linux-gnu|'`
+-		;;
+-	# First accept the basic system types.
+-	# The portable systems comes first.
+-	# Each alternative MUST END IN A *, to match a version number.
+-	# -sysv* is not here because it comes later, after sysvr4.
+-	-gnu* | -bsd* | -mach* | -minix* | -genix* | -ultrix* | -irix* \
+-	      | -*vms* | -sco* | -esix* | -isc* | -aix* | -cnk* | -sunos | -sunos[34]*\
+-	      | -hpux* | -unos* | -osf* | -luna* | -dgux* | -auroraux* | -solaris* \
+-	      | -sym* | -kopensolaris* \
+-	      | -amigaos* | -amigados* | -msdos* | -newsos* | -unicos* | -aof* \
+-	      | -aos* | -aros* \
+-	      | -nindy* | -vxsim* | -vxworks* | -ebmon* | -hms* | -mvs* \
+-	      | -clix* | -riscos* | -uniplus* | -iris* | -rtu* | -xenix* \
+-	      | -hiux* | -386bsd* | -knetbsd* | -mirbsd* | -netbsd* \
+-	      | -openbsd* | -solidbsd* \
+-	      | -ekkobsd* | -kfreebsd* | -freebsd* | -riscix* | -lynxos* \
+-	      | -bosx* | -nextstep* | -cxux* | -aout* | -elf* | -oabi* \
+-	      | -ptx* | -coff* | -ecoff* | -winnt* | -domain* | -vsta* \
+-	      | -udi* | -eabi* | -lites* | -ieee* | -go32* | -aux* \
+-	      | -chorusos* | -chorusrdb* | -cegcc* \
+-	      | -cygwin* | -pe* | -psos* | -moss* | -proelf* | -rtems* \
+-	      | -mingw32* | -linux-gnu* | -linux-newlib* | -linux-uclibc* \
+-	      | -uxpv* | -beos* | -mpeix* | -udk* \
+-	      | -interix* | -uwin* | -mks* | -rhapsody* | -darwin* | -opened* \
+-	      | -openstep* | -oskit* | -conix* | -pw32* | -nonstopux* \
+-	      | -storm-chaos* | -tops10* | -tenex* | -tops20* | -its* \
+-	      | -os2* | -vos* | -palmos* | -uclinux* | -nucleus* \
+-	      | -morphos* | -superux* | -rtmk* | -rtmk-nova* | -windiss* \
+-	      | -powermax* | -dnix* | -nx6 | -nx7 | -sei* | -dragonfly* \
+-	      | -skyos* | -haiku* | -rdos* | -toppers* | -drops* | -es*)
+-	# Remember, each alternative MUST END IN *, to match a version number.
+-		;;
+-	-qnx*)
+-		case $basic_machine in
+-		    x86-* | i*86-*)
+-			;;
+-		    *)
+-			os=-nto$os
+-			;;
+-		esac
+-		;;
+-	-nto-qnx*)
+-		;;
+-	-nto*)
+-		os=`echo $os | sed -e 's|nto|nto-qnx|'`
+-		;;
+-	-sim | -es1800* | -hms* | -xray | -os68k* | -none* | -v88r* \
+-	      | -windows* | -osx | -abug | -netware* | -os9* | -beos* | -haiku* \
+-	      | -macos* | -mpw* | -magic* | -mmixware* | -mon960* | -lnews*)
+-		;;
+-	-mac*)
+-		os=`echo $os | sed -e 's|mac|macos|'`
+-		;;
+-	-linux-dietlibc)
+-		os=-linux-dietlibc
+-		;;
+-	-linux*)
+-		os=`echo $os | sed -e 's|linux|linux-gnu|'`
+-		;;
+-	-sunos5*)
+-		os=`echo $os | sed -e 's|sunos5|solaris2|'`
+-		;;
+-	-sunos6*)
+-		os=`echo $os | sed -e 's|sunos6|solaris3|'`
+-		;;
+-	-opened*)
+-		os=-openedition
+-		;;
+-        -os400*)
+-		os=-os400
+-		;;
+-	-wince*)
+-		os=-wince
+-		;;
+-	-osfrose*)
+-		os=-osfrose
+-		;;
+-	-osf*)
+-		os=-osf
+-		;;
+-	-utek*)
+-		os=-bsd
+-		;;
+-	-dynix*)
+-		os=-bsd
+-		;;
+-	-acis*)
+-		os=-aos
+-		;;
+-	-atheos*)
+-		os=-atheos
+-		;;
+-	-syllable*)
+-		os=-syllable
+-		;;
+-	-386bsd)
+-		os=-bsd
+-		;;
+-	-ctix* | -uts*)
+-		os=-sysv
+-		;;
+-	-nova*)
+-		os=-rtmk-nova
+-		;;
+-	-ns2 )
+-		os=-nextstep2
+-		;;
+-	-nsk*)
+-		os=-nsk
+-		;;
+-	# Preserve the version number of sinix5.
+-	-sinix5.*)
+-		os=`echo $os | sed -e 's|sinix|sysv|'`
+-		;;
+-	-sinix*)
+-		os=-sysv4
+-		;;
+-        -tpf*)
+-		os=-tpf
+-		;;
+-	-triton*)
+-		os=-sysv3
+-		;;
+-	-oss*)
+-		os=-sysv3
+-		;;
+-	-svr4)
+-		os=-sysv4
+-		;;
+-	-svr3)
+-		os=-sysv3
+-		;;
+-	-sysvr4)
+-		os=-sysv4
+-		;;
+-	# This must come after -sysvr4.
+-	-sysv*)
+-		;;
+-	-ose*)
+-		os=-ose
+-		;;
+-	-es1800*)
+-		os=-ose
+-		;;
+-	-xenix)
+-		os=-xenix
+-		;;
+-	-*mint | -mint[0-9]* | -*MiNT | -MiNT[0-9]*)
+-		os=-mint
+-		;;
+-	-aros*)
+-		os=-aros
+-		;;
+-	-kaos*)
+-		os=-kaos
+-		;;
+-	-zvmoe)
+-		os=-zvmoe
+-		;;
+-	-dicos*)
+-		os=-dicos
+-		;;
+-        -nacl*)
+-	        ;;
+-	-none)
+-		;;
+-	*)
+-		# Get rid of the `-' at the beginning of $os.
+-		os=`echo $os | sed 's/[^-]*-//'`
+-		echo Invalid configuration \`$1\': system \`$os\' not recognized 1>&2
+-		exit 1
+-		;;
+-esac
+-else
+-
+-# Here we handle the default operating systems that come with various machines.
+-# The value should be what the vendor currently ships out the door with their
+-# machine or put another way, the most popular os provided with the machine.
+-
+-# Note that if you're going to try to match "-MANUFACTURER" here (say,
+-# "-sun"), then you have to tell the case statement up towards the top
+-# that MANUFACTURER isn't an operating system.  Otherwise, code above
+-# will signal an error saying that MANUFACTURER isn't an operating
+-# system, and we'll never get to this point.
+-
+-case $basic_machine in
+-        score-*)
+-		os=-elf
+-		;;
+-        spu-*)
+-		os=-elf
+-		;;
+-	*-acorn)
+-		os=-riscix1.2
+-		;;
+-	arm*-rebel)
+-		os=-linux
+-		;;
+-	arm*-semi)
+-		os=-aout
+-		;;
+-        c4x-* | tic4x-*)
+-        	os=-coff
+-		;;
+-	# This must come before the *-dec entry.
+-	pdp10-*)
+-		os=-tops20
+-		;;
+-	pdp11-*)
+-		os=-none
+-		;;
+-	*-dec | vax-*)
+-		os=-ultrix4.2
+-		;;
+-	m68*-apollo)
+-		os=-domain
+-		;;
+-	i386-sun)
+-		os=-sunos4.0.2
+-		;;
+-	m68000-sun)
+-		os=-sunos3
+-		# This also exists in the configure program, but was not the
+-		# default.
+-		# os=-sunos4
+-		;;
+-	m68*-cisco)
+-		os=-aout
+-		;;
+-        mep-*)
+-		os=-elf
+-		;;
+-	mips*-cisco)
+-		os=-elf
+-		;;
+-	mips*-*)
+-		os=-elf
+-		;;
+-	or32-*)
+-		os=-coff
+-		;;
+-	*-tti)	# must be before sparc entry or we get the wrong os.
+-		os=-sysv3
+-		;;
+-	sparc-* | *-sun)
+-		os=-sunos4.1.1
+-		;;
+-	*-be)
+-		os=-beos
+-		;;
+-	*-haiku)
+-		os=-haiku
+-		;;
+-	*-ibm)
+-		os=-aix
+-		;;
+-    	*-knuth)
+-		os=-mmixware
+-		;;
+-	*-wec)
+-		os=-proelf
+-		;;
+-	*-winbond)
+-		os=-proelf
+-		;;
+-	*-oki)
+-		os=-proelf
+-		;;
+-	*-hp)
+-		os=-hpux
+-		;;
+-	*-hitachi)
+-		os=-hiux
+-		;;
+-	i860-* | *-att | *-ncr | *-altos | *-motorola | *-convergent)
+-		os=-sysv
+-		;;
+-	*-cbm)
+-		os=-amigaos
+-		;;
+-	*-dg)
+-		os=-dgux
+-		;;
+-	*-dolphin)
+-		os=-sysv3
+-		;;
+-	m68k-ccur)
+-		os=-rtu
+-		;;
+-	m88k-omron*)
+-		os=-luna
+-		;;
+-	*-next )
+-		os=-nextstep
+-		;;
+-	*-sequent)
+-		os=-ptx
+-		;;
+-	*-crds)
+-		os=-unos
+-		;;
+-	*-ns)
+-		os=-genix
+-		;;
+-	i370-*)
+-		os=-mvs
+-		;;
+-	*-next)
+-		os=-nextstep3
+-		;;
+-	*-gould)
+-		os=-sysv
+-		;;
+-	*-highlevel)
+-		os=-bsd
+-		;;
+-	*-encore)
+-		os=-bsd
+-		;;
+-	*-sgi)
+-		os=-irix
+-		;;
+-	*-siemens)
+-		os=-sysv4
+-		;;
+-	*-masscomp)
+-		os=-rtu
+-		;;
+-	f30[01]-fujitsu | f700-fujitsu)
+-		os=-uxpv
+-		;;
+-	*-rom68k)
+-		os=-coff
+-		;;
+-	*-*bug)
+-		os=-coff
+-		;;
+-	*-apple)
+-		os=-macos
+-		;;
+-	*-atari*)
+-		os=-mint
+-		;;
+-	*)
+-		os=-none
+-		;;
+-esac
+-fi
+-
+-# Here we handle the case where we know the os, and the CPU type, but not the
+-# manufacturer.  We pick the logical manufacturer.
+-vendor=unknown
+-case $basic_machine in
+-	*-unknown)
+-		case $os in
+-			-riscix*)
+-				vendor=acorn
+-				;;
+-			-sunos*)
+-				vendor=sun
+-				;;
+-			-cnk*|-aix*)
+-				vendor=ibm
+-				;;
+-			-beos*)
+-				vendor=be
+-				;;
+-			-hpux*)
+-				vendor=hp
+-				;;
+-			-mpeix*)
+-				vendor=hp
+-				;;
+-			-hiux*)
+-				vendor=hitachi
+-				;;
+-			-unos*)
+-				vendor=crds
+-				;;
+-			-dgux*)
+-				vendor=dg
+-				;;
+-			-luna*)
+-				vendor=omron
+-				;;
+-			-genix*)
+-				vendor=ns
+-				;;
+-			-mvs* | -opened*)
+-				vendor=ibm
+-				;;
+-			-os400*)
+-				vendor=ibm
+-				;;
+-			-ptx*)
+-				vendor=sequent
+-				;;
+-			-tpf*)
+-				vendor=ibm
+-				;;
+-			-vxsim* | -vxworks* | -windiss*)
+-				vendor=wrs
+-				;;
+-			-aux*)
+-				vendor=apple
+-				;;
+-			-hms*)
+-				vendor=hitachi
+-				;;
+-			-mpw* | -macos*)
+-				vendor=apple
+-				;;
+-			-*mint | -mint[0-9]* | -*MiNT | -MiNT[0-9]*)
+-				vendor=atari
+-				;;
+-			-vos*)
+-				vendor=stratus
+-				;;
+-		esac
+-		basic_machine=`echo $basic_machine | sed "s/unknown/$vendor/"`
+-		;;
+-esac
+-
+-echo $basic_machine$os
+-exit
+-
+-# Local variables:
+-# eval: (add-hook 'write-file-hooks 'time-stamp)
+-# time-stamp-start: "timestamp='"
+-# time-stamp-format: "%:y-%02m-%02d"
+-# time-stamp-end: "'"
+-# End:
+diff -Nur dosbox-0.74/configure dosbox/configure
+--- dosbox-0.74/configure	2010-05-10 20:59:04.000000000 +0200
++++ dosbox/configure	1970-01-01 01:00:00.000000000 +0100
+@@ -1,8754 +0,0 @@
+-#! /bin/sh
+-# Guess values for system-dependent variables and create Makefiles.
+-# Generated by GNU Autoconf 2.65 for dosbox 0.74.
+-#
+-#
+-# Copyright (C) 1992, 1993, 1994, 1995, 1996, 1998, 1999, 2000, 2001,
+-# 2002, 2003, 2004, 2005, 2006, 2007, 2008, 2009 Free Software Foundation,
+-# Inc.
+-#
+-#
+-# This configure script is free software; the Free Software Foundation
+-# gives unlimited permission to copy, distribute and modify it.
+-## -------------------- ##
+-## M4sh Initialization. ##
+-## -------------------- ##
+-
+-# Be more Bourne compatible
+-DUALCASE=1; export DUALCASE # for MKS sh
+-if test -n "${ZSH_VERSION+set}" && (emulate sh) >/dev/null 2>&1; then :
+-  emulate sh
+-  NULLCMD=:
+-  # Pre-4.2 versions of Zsh do word splitting on ${1+"$@"}, which
+-  # is contrary to our usage.  Disable this feature.
+-  alias -g '${1+"$@"}'='"$@"'
+-  setopt NO_GLOB_SUBST
+-else
+-  case `(set -o) 2>/dev/null` in #(
+-  *posix*) :
+-    set -o posix ;; #(
+-  *) :
+-     ;;
+-esac
+-fi
+-
+-
+-as_nl='
+-'
+-export as_nl
+-# Printing a long string crashes Solaris 7 /usr/bin/printf.
+-as_echo='\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\'
+-as_echo=$as_echo$as_echo$as_echo$as_echo$as_echo
+-as_echo=$as_echo$as_echo$as_echo$as_echo$as_echo$as_echo
+-# Prefer a ksh shell builtin over an external printf program on Solaris,
+-# but without wasting forks for bash or zsh.
+-if test -z "$BASH_VERSION$ZSH_VERSION" \
+-    && (test "X`print -r -- $as_echo`" = "X$as_echo") 2>/dev/null; then
+-  as_echo='print -r --'
+-  as_echo_n='print -rn --'
+-elif (test "X`printf %s $as_echo`" = "X$as_echo") 2>/dev/null; then
+-  as_echo='printf %s\n'
+-  as_echo_n='printf %s'
+-else
+-  if test "X`(/usr/ucb/echo -n -n $as_echo) 2>/dev/null`" = "X-n $as_echo"; then
+-    as_echo_body='eval /usr/ucb/echo -n "$1$as_nl"'
+-    as_echo_n='/usr/ucb/echo -n'
+-  else
+-    as_echo_body='eval expr "X$1" : "X\\(.*\\)"'
+-    as_echo_n_body='eval
+-      arg=$1;
+-      case $arg in #(
+-      *"$as_nl"*)
+-	expr "X$arg" : "X\\(.*\\)$as_nl";
+-	arg=`expr "X$arg" : ".*$as_nl\\(.*\\)"`;;
+-      esac;
+-      expr "X$arg" : "X\\(.*\\)" | tr -d "$as_nl"
+-    '
+-    export as_echo_n_body
+-    as_echo_n='sh -c $as_echo_n_body as_echo'
+-  fi
+-  export as_echo_body
+-  as_echo='sh -c $as_echo_body as_echo'
+-fi
+-
+-# The user is always right.
+-if test "${PATH_SEPARATOR+set}" != set; then
+-  PATH_SEPARATOR=:
+-  (PATH='/bin;/bin'; FPATH=$PATH; sh -c :) >/dev/null 2>&1 && {
+-    (PATH='/bin:/bin'; FPATH=$PATH; sh -c :) >/dev/null 2>&1 ||
+-      PATH_SEPARATOR=';'
+-  }
+-fi
+-
+-
+-# IFS
+-# We need space, tab and new line, in precisely that order.  Quoting is
+-# there to prevent editors from complaining about space-tab.
+-# (If _AS_PATH_WALK were called with IFS unset, it would disable word
+-# splitting by setting IFS to empty value.)
+-IFS=" ""	$as_nl"
+-
+-# Find who we are.  Look in the path if we contain no directory separator.
+-case $0 in #((
+-  *[\\/]* ) as_myself=$0 ;;
+-  *) as_save_IFS=$IFS; IFS=$PATH_SEPARATOR
+-for as_dir in $PATH
+-do
+-  IFS=$as_save_IFS
+-  test -z "$as_dir" && as_dir=.
+-    test -r "$as_dir/$0" && as_myself=$as_dir/$0 && break
+-  done
+-IFS=$as_save_IFS
+-
+-     ;;
+-esac
+-# We did not find ourselves, most probably we were run as `sh COMMAND'
+-# in which case we are not to be found in the path.
+-if test "x$as_myself" = x; then
+-  as_myself=$0
+-fi
+-if test ! -f "$as_myself"; then
+-  $as_echo "$as_myself: error: cannot find myself; rerun with an absolute file name" >&2
+-  exit 1
+-fi
+-
+-# Unset variables that we do not need and which cause bugs (e.g. in
+-# pre-3.0 UWIN ksh).  But do not cause bugs in bash 2.01; the "|| exit 1"
+-# suppresses any "Segmentation fault" message there.  '((' could
+-# trigger a bug in pdksh 5.2.14.
+-for as_var in BASH_ENV ENV MAIL MAILPATH
+-do eval test x\${$as_var+set} = xset \
+-  && ( (unset $as_var) || exit 1) >/dev/null 2>&1 && unset $as_var || :
+-done
+-PS1='$ '
+-PS2='> '
+-PS4='+ '
+-
+-# NLS nuisances.
+-LC_ALL=C
+-export LC_ALL
+-LANGUAGE=C
+-export LANGUAGE
+-
+-# CDPATH.
+-(unset CDPATH) >/dev/null 2>&1 && unset CDPATH
+-
+-if test "x$CONFIG_SHELL" = x; then
+-  as_bourne_compatible="if test -n \"\${ZSH_VERSION+set}\" && (emulate sh) >/dev/null 2>&1; then :
+-  emulate sh
+-  NULLCMD=:
+-  # Pre-4.2 versions of Zsh do word splitting on \${1+\"\$@\"}, which
+-  # is contrary to our usage.  Disable this feature.
+-  alias -g '\${1+\"\$@\"}'='\"\$@\"'
+-  setopt NO_GLOB_SUBST
+-else
+-  case \`(set -o) 2>/dev/null\` in #(
+-  *posix*) :
+-    set -o posix ;; #(
+-  *) :
+-     ;;
+-esac
+-fi
+-"
+-  as_required="as_fn_return () { (exit \$1); }
+-as_fn_success () { as_fn_return 0; }
+-as_fn_failure () { as_fn_return 1; }
+-as_fn_ret_success () { return 0; }
+-as_fn_ret_failure () { return 1; }
+-
+-exitcode=0
+-as_fn_success || { exitcode=1; echo as_fn_success failed.; }
+-as_fn_failure && { exitcode=1; echo as_fn_failure succeeded.; }
+-as_fn_ret_success || { exitcode=1; echo as_fn_ret_success failed.; }
+-as_fn_ret_failure && { exitcode=1; echo as_fn_ret_failure succeeded.; }
+-if ( set x; as_fn_ret_success y && test x = \"\$1\" ); then :
+-
+-else
+-  exitcode=1; echo positional parameters were not saved.
+-fi
+-test x\$exitcode = x0 || exit 1"
+-  as_suggested="  as_lineno_1=";as_suggested=$as_suggested$LINENO;as_suggested=$as_suggested" as_lineno_1a=\$LINENO
+-  as_lineno_2=";as_suggested=$as_suggested$LINENO;as_suggested=$as_suggested" as_lineno_2a=\$LINENO
+-  eval 'test \"x\$as_lineno_1'\$as_run'\" != \"x\$as_lineno_2'\$as_run'\" &&
+-  test \"x\`expr \$as_lineno_1'\$as_run' + 1\`\" = \"x\$as_lineno_2'\$as_run'\"' || exit 1
+-test \$(( 1 + 1 )) = 2 || exit 1"
+-  if (eval "$as_required") 2>/dev/null; then :
+-  as_have_required=yes
+-else
+-  as_have_required=no
+-fi
+-  if test x$as_have_required = xyes && (eval "$as_suggested") 2>/dev/null; then :
+-
+-else
+-  as_save_IFS=$IFS; IFS=$PATH_SEPARATOR
+-as_found=false
+-for as_dir in /bin$PATH_SEPARATOR/usr/bin$PATH_SEPARATOR$PATH
+-do
+-  IFS=$as_save_IFS
+-  test -z "$as_dir" && as_dir=.
+-  as_found=:
+-  case $as_dir in #(
+-	 /*)
+-	   for as_base in sh bash ksh sh5; do
+-	     # Try only shells that exist, to save several forks.
+-	     as_shell=$as_dir/$as_base
+-	     if { test -f "$as_shell" || test -f "$as_shell.exe"; } &&
+-		    { $as_echo "$as_bourne_compatible""$as_required" | as_run=a "$as_shell"; } 2>/dev/null; then :
+-  CONFIG_SHELL=$as_shell as_have_required=yes
+-		   if { $as_echo "$as_bourne_compatible""$as_suggested" | as_run=a "$as_shell"; } 2>/dev/null; then :
+-  break 2
+-fi
+-fi
+-	   done;;
+-       esac
+-  as_found=false
+-done
+-$as_found || { if { test -f "$SHELL" || test -f "$SHELL.exe"; } &&
+-	      { $as_echo "$as_bourne_compatible""$as_required" | as_run=a "$SHELL"; } 2>/dev/null; then :
+-  CONFIG_SHELL=$SHELL as_have_required=yes
+-fi; }
+-IFS=$as_save_IFS
+-
+-
+-      if test "x$CONFIG_SHELL" != x; then :
+-  # We cannot yet assume a decent shell, so we have to provide a
+-	# neutralization value for shells without unset; and this also
+-	# works around shells that cannot unset nonexistent variables.
+-	BASH_ENV=/dev/null
+-	ENV=/dev/null
+-	(unset BASH_ENV) >/dev/null 2>&1 && unset BASH_ENV ENV
+-	export CONFIG_SHELL
+-	exec "$CONFIG_SHELL" "$as_myself" ${1+"$@"}
+-fi
+-
+-    if test x$as_have_required = xno; then :
+-  $as_echo "$0: This script requires a shell more modern than all"
+-  $as_echo "$0: the shells that I found on your system."
+-  if test x${ZSH_VERSION+set} = xset ; then
+-    $as_echo "$0: In particular, zsh $ZSH_VERSION has bugs and should"
+-    $as_echo "$0: be upgraded to zsh 4.3.4 or later."
+-  else
+-    $as_echo "$0: Please tell bug-autoconf@gnu.org about your system,
+-$0: including any error possibly output before this
+-$0: message. Then install a modern shell, or manually run
+-$0: the script under such a shell if you do have one."
+-  fi
+-  exit 1
+-fi
+-fi
+-fi
+-SHELL=${CONFIG_SHELL-/bin/sh}
+-export SHELL
+-# Unset more variables known to interfere with behavior of common tools.
+-CLICOLOR_FORCE= GREP_OPTIONS=
+-unset CLICOLOR_FORCE GREP_OPTIONS
+-
+-## --------------------- ##
+-## M4sh Shell Functions. ##
+-## --------------------- ##
+-# as_fn_unset VAR
+-# ---------------
+-# Portably unset VAR.
+-as_fn_unset ()
+-{
+-  { eval $1=; unset $1;}
+-}
+-as_unset=as_fn_unset
+-
+-# as_fn_set_status STATUS
+-# -----------------------
+-# Set $? to STATUS, without forking.
+-as_fn_set_status ()
+-{
+-  return $1
+-} # as_fn_set_status
+-
+-# as_fn_exit STATUS
+-# -----------------
+-# Exit the shell with STATUS, even in a "trap 0" or "set -e" context.
+-as_fn_exit ()
+-{
+-  set +e
+-  as_fn_set_status $1
+-  exit $1
+-} # as_fn_exit
+-
+-# as_fn_mkdir_p
+-# -------------
+-# Create "$as_dir" as a directory, including parents if necessary.
+-as_fn_mkdir_p ()
+-{
+-
+-  case $as_dir in #(
+-  -*) as_dir=./$as_dir;;
+-  esac
+-  test -d "$as_dir" || eval $as_mkdir_p || {
+-    as_dirs=
+-    while :; do
+-      case $as_dir in #(
+-      *\'*) as_qdir=`$as_echo "$as_dir" | sed "s/'/'\\\\\\\\''/g"`;; #'(
+-      *) as_qdir=$as_dir;;
+-      esac
+-      as_dirs="'$as_qdir' $as_dirs"
+-      as_dir=`$as_dirname -- "$as_dir" ||
+-$as_expr X"$as_dir" : 'X\(.*[^/]\)//*[^/][^/]*/*$' \| \
+-	 X"$as_dir" : 'X\(//\)[^/]' \| \
+-	 X"$as_dir" : 'X\(//\)$' \| \
+-	 X"$as_dir" : 'X\(/\)' \| . 2>/dev/null ||
+-$as_echo X"$as_dir" |
+-    sed '/^X\(.*[^/]\)\/\/*[^/][^/]*\/*$/{
+-	    s//\1/
+-	    q
+-	  }
+-	  /^X\(\/\/\)[^/].*/{
+-	    s//\1/
+-	    q
+-	  }
+-	  /^X\(\/\/\)$/{
+-	    s//\1/
+-	    q
+-	  }
+-	  /^X\(\/\).*/{
+-	    s//\1/
+-	    q
+-	  }
+-	  s/.*/./; q'`
+-      test -d "$as_dir" && break
+-    done
+-    test -z "$as_dirs" || eval "mkdir $as_dirs"
+-  } || test -d "$as_dir" || as_fn_error "cannot create directory $as_dir"
+-
+-
+-} # as_fn_mkdir_p
+-# as_fn_append VAR VALUE
+-# ----------------------
+-# Append the text in VALUE to the end of the definition contained in VAR. Take
+-# advantage of any shell optimizations that allow amortized linear growth over
+-# repeated appends, instead of the typical quadratic growth present in naive
+-# implementations.
+-if (eval "as_var=1; as_var+=2; test x\$as_var = x12") 2>/dev/null; then :
+-  eval 'as_fn_append ()
+-  {
+-    eval $1+=\$2
+-  }'
+-else
+-  as_fn_append ()
+-  {
+-    eval $1=\$$1\$2
+-  }
+-fi # as_fn_append
+-
+-# as_fn_arith ARG...
+-# ------------------
+-# Perform arithmetic evaluation on the ARGs, and store the result in the
+-# global $as_val. Take advantage of shells that can avoid forks. The arguments
+-# must be portable across $(()) and expr.
+-if (eval "test \$(( 1 + 1 )) = 2") 2>/dev/null; then :
+-  eval 'as_fn_arith ()
+-  {
+-    as_val=$(( $* ))
+-  }'
+-else
+-  as_fn_arith ()
+-  {
+-    as_val=`expr "$@" || test $? -eq 1`
+-  }
+-fi # as_fn_arith
+-
+-
+-# as_fn_error ERROR [LINENO LOG_FD]
+-# ---------------------------------
+-# Output "`basename $0`: error: ERROR" to stderr. If LINENO and LOG_FD are
+-# provided, also output the error to LOG_FD, referencing LINENO. Then exit the
+-# script with status $?, using 1 if that was 0.
+-as_fn_error ()
+-{
+-  as_status=$?; test $as_status -eq 0 && as_status=1
+-  if test "$3"; then
+-    as_lineno=${as_lineno-"$2"} as_lineno_stack=as_lineno_stack=$as_lineno_stack
+-    $as_echo "$as_me:${as_lineno-$LINENO}: error: $1" >&$3
+-  fi
+-  $as_echo "$as_me: error: $1" >&2
+-  as_fn_exit $as_status
+-} # as_fn_error
+-
+-if expr a : '\(a\)' >/dev/null 2>&1 &&
+-   test "X`expr 00001 : '.*\(...\)'`" = X001; then
+-  as_expr=expr
+-else
+-  as_expr=false
+-fi
+-
+-if (basename -- /) >/dev/null 2>&1 && test "X`basename -- / 2>&1`" = "X/"; then
+-  as_basename=basename
+-else
+-  as_basename=false
+-fi
+-
+-if (as_dir=`dirname -- /` && test "X$as_dir" = X/) >/dev/null 2>&1; then
+-  as_dirname=dirname
+-else
+-  as_dirname=false
+-fi
+-
+-as_me=`$as_basename -- "$0" ||
+-$as_expr X/"$0" : '.*/\([^/][^/]*\)/*$' \| \
+-	 X"$0" : 'X\(//\)$' \| \
+-	 X"$0" : 'X\(/\)' \| . 2>/dev/null ||
+-$as_echo X/"$0" |
+-    sed '/^.*\/\([^/][^/]*\)\/*$/{
+-	    s//\1/
+-	    q
+-	  }
+-	  /^X\/\(\/\/\)$/{
+-	    s//\1/
+-	    q
+-	  }
+-	  /^X\/\(\/\).*/{
+-	    s//\1/
+-	    q
+-	  }
+-	  s/.*/./; q'`
+-
+-# Avoid depending upon Character Ranges.
+-as_cr_letters='abcdefghijklmnopqrstuvwxyz'
+-as_cr_LETTERS='ABCDEFGHIJKLMNOPQRSTUVWXYZ'
+-as_cr_Letters=$as_cr_letters$as_cr_LETTERS
+-as_cr_digits='0123456789'
+-as_cr_alnum=$as_cr_Letters$as_cr_digits
+-
+-
+-  as_lineno_1=$LINENO as_lineno_1a=$LINENO
+-  as_lineno_2=$LINENO as_lineno_2a=$LINENO
+-  eval 'test "x$as_lineno_1'$as_run'" != "x$as_lineno_2'$as_run'" &&
+-  test "x`expr $as_lineno_1'$as_run' + 1`" = "x$as_lineno_2'$as_run'"' || {
+-  # Blame Lee E. McMahon (1931-1989) for sed's syntax.  :-)
+-  sed -n '
+-    p
+-    /[$]LINENO/=
+-  ' <$as_myself |
+-    sed '
+-      s/[$]LINENO.*/&-/
+-      t lineno
+-      b
+-      :lineno
+-      N
+-      :loop
+-      s/[$]LINENO\([^'$as_cr_alnum'_].*\n\)\(.*\)/\2\1\2/
+-      t loop
+-      s/-\n.*//
+-    ' >$as_me.lineno &&
+-  chmod +x "$as_me.lineno" ||
+-    { $as_echo "$as_me: error: cannot create $as_me.lineno; rerun with a POSIX shell" >&2; as_fn_exit 1; }
+-
+-  # Don't try to exec as it changes $[0], causing all sort of problems
+-  # (the dirname of $[0] is not the place where we might find the
+-  # original and so on.  Autoconf is especially sensitive to this).
+-  . "./$as_me.lineno"
+-  # Exit status is that of the last command.
+-  exit
+-}
+-
+-ECHO_C= ECHO_N= ECHO_T=
+-case `echo -n x` in #(((((
+--n*)
+-  case `echo 'xy\c'` in
+-  *c*) ECHO_T='	';;	# ECHO_T is single tab character.
+-  xy)  ECHO_C='\c';;
+-  *)   echo `echo ksh88 bug on AIX 6.1` > /dev/null
+-       ECHO_T='	';;
+-  esac;;
+-*)
+-  ECHO_N='-n';;
+-esac
+-
+-rm -f conf$$ conf$$.exe conf$$.file
+-if test -d conf$$.dir; then
+-  rm -f conf$$.dir/conf$$.file
+-else
+-  rm -f conf$$.dir
+-  mkdir conf$$.dir 2>/dev/null
+-fi
+-if (echo >conf$$.file) 2>/dev/null; then
+-  if ln -s conf$$.file conf$$ 2>/dev/null; then
+-    as_ln_s='ln -s'
+-    # ... but there are two gotchas:
+-    # 1) On MSYS, both `ln -s file dir' and `ln file dir' fail.
+-    # 2) DJGPP < 2.04 has no symlinks; `ln -s' creates a wrapper executable.
+-    # In both cases, we have to default to `cp -p'.
+-    ln -s conf$$.file conf$$.dir 2>/dev/null && test ! -f conf$$.exe ||
+-      as_ln_s='cp -p'
+-  elif ln conf$$.file conf$$ 2>/dev/null; then
+-    as_ln_s=ln
+-  else
+-    as_ln_s='cp -p'
+-  fi
+-else
+-  as_ln_s='cp -p'
+-fi
+-rm -f conf$$ conf$$.exe conf$$.dir/conf$$.file conf$$.file
+-rmdir conf$$.dir 2>/dev/null
+-
+-if mkdir -p . 2>/dev/null; then
+-  as_mkdir_p='mkdir -p "$as_dir"'
+-else
+-  test -d ./-p && rmdir ./-p
+-  as_mkdir_p=false
+-fi
+-
+-if test -x / >/dev/null 2>&1; then
+-  as_test_x='test -x'
+-else
+-  if ls -dL / >/dev/null 2>&1; then
+-    as_ls_L_option=L
+-  else
+-    as_ls_L_option=
+-  fi
+-  as_test_x='
+-    eval sh -c '\''
+-      if test -d "$1"; then
+-	test -d "$1/.";
+-      else
+-	case $1 in #(
+-	-*)set "./$1";;
+-	esac;
+-	case `ls -ld'$as_ls_L_option' "$1" 2>/dev/null` in #((
+-	???[sx]*):;;*)false;;esac;fi
+-    '\'' sh
+-  '
+-fi
+-as_executable_p=$as_test_x
+-
+-# Sed expression to map a string onto a valid CPP name.
+-as_tr_cpp="eval sed 'y%*$as_cr_letters%P$as_cr_LETTERS%;s%[^_$as_cr_alnum]%_%g'"
+-
+-# Sed expression to map a string onto a valid variable name.
+-as_tr_sh="eval sed 'y%*+%pp%;s%[^_$as_cr_alnum]%_%g'"
+-
+-
+-test -n "$DJDIR" || exec 7<&0 </dev/null
+-exec 6>&1
+-
+-# Name of the host.
+-# hostname on some systems (SVR3.2, Linux) returns a bogus exit status,
+-# so uname gets run too.
+-ac_hostname=`(hostname || uname -n) 2>/dev/null | sed 1q`
+-
+-#
+-# Initializations.
+-#
+-ac_default_prefix=/usr/local
+-ac_clean_files=
+-ac_config_libobj_dir=.
+-LIBOBJS=
+-cross_compiling=no
+-subdirs=
+-MFLAGS=
+-MAKEFLAGS=
+-
+-# Identity of this package.
+-PACKAGE_NAME='dosbox'
+-PACKAGE_TARNAME='dosbox'
+-PACKAGE_VERSION='0.74'
+-PACKAGE_STRING='dosbox 0.74'
+-PACKAGE_BUGREPORT=''
+-PACKAGE_URL=''
+-
+-ac_unique_file="README"
+-# Factoring default headers for most tests.
+-ac_includes_default="\
+-#include <stdio.h>
+-#ifdef HAVE_SYS_TYPES_H
+-# include <sys/types.h>
+-#endif
+-#ifdef HAVE_SYS_STAT_H
+-# include <sys/stat.h>
+-#endif
+-#ifdef STDC_HEADERS
+-# include <stdlib.h>
+-# include <stddef.h>
+-#else
+-# ifdef HAVE_STDLIB_H
+-#  include <stdlib.h>
+-# endif
+-#endif
+-#ifdef HAVE_STRING_H
+-# if !defined STDC_HEADERS && defined HAVE_MEMORY_H
+-#  include <memory.h>
+-# endif
+-# include <string.h>
+-#endif
+-#ifdef HAVE_STRINGS_H
+-# include <strings.h>
+-#endif
+-#ifdef HAVE_INTTYPES_H
+-# include <inttypes.h>
+-#endif
+-#ifdef HAVE_STDINT_H
+-# include <stdint.h>
+-#endif
+-#ifdef HAVE_UNISTD_H
+-# include <unistd.h>
+-#endif"
+-
+-ac_subst_vars='am__EXEEXT_FALSE
+-am__EXEEXT_TRUE
+-LTLIBOBJS
+-LIBOBJS
+-HAVE_WINDRES_FALSE
+-HAVE_WINDRES_TRUE
+-WINDRES
+-ALSA_LIBS
+-ALSA_CFLAGS
+-EGREP
+-GREP
+-SDL_LIBS
+-SDL_CFLAGS
+-SDL_CONFIG
+-RANLIB
+-am__fastdepCXX_FALSE
+-am__fastdepCXX_TRUE
+-CXXDEPMODE
+-ac_ct_CXX
+-CXXFLAGS
+-CXX
+-CPP
+-am__fastdepCC_FALSE
+-am__fastdepCC_TRUE
+-CCDEPMODE
+-AMDEPBACKSLASH
+-AMDEP_FALSE
+-AMDEP_TRUE
+-am__quote
+-am__include
+-DEPDIR
+-OBJEXT
+-EXEEXT
+-ac_ct_CC
+-CPPFLAGS
+-LDFLAGS
+-CFLAGS
+-CC
+-am__untar
+-am__tar
+-AMTAR
+-am__leading_dot
+-SET_MAKE
+-AWK
+-mkdir_p
+-MKDIR_P
+-INSTALL_STRIP_PROGRAM
+-STRIP
+-install_sh
+-MAKEINFO
+-AUTOHEADER
+-AUTOMAKE
+-AUTOCONF
+-ACLOCAL
+-VERSION
+-PACKAGE
+-CYGPATH_W
+-am__isrc
+-INSTALL_DATA
+-INSTALL_SCRIPT
+-INSTALL_PROGRAM
+-host_os
+-host_vendor
+-host_cpu
+-host
+-build_os
+-build_vendor
+-build_cpu
+-build
+-target_alias
+-host_alias
+-build_alias
+-LIBS
+-ECHO_T
+-ECHO_N
+-ECHO_C
+-DEFS
+-mandir
+-localedir
+-libdir
+-psdir
+-pdfdir
+-dvidir
+-htmldir
+-infodir
+-docdir
+-oldincludedir
+-includedir
+-localstatedir
+-sharedstatedir
+-sysconfdir
+-datadir
+-datarootdir
+-libexecdir
+-sbindir
+-bindir
+-program_transform_name
+-prefix
+-exec_prefix
+-PACKAGE_URL
+-PACKAGE_BUGREPORT
+-PACKAGE_STRING
+-PACKAGE_VERSION
+-PACKAGE_TARNAME
+-PACKAGE_NAME
+-PATH_SEPARATOR
+-SHELL'
+-ac_subst_files=''
+-ac_user_opts='
+-enable_option_checking
+-enable_dependency_tracking
+-with_sdl_prefix
+-with_sdl_exec_prefix
+-enable_sdltest
+-enable_alsa_midi
+-with_alsa_prefix
+-with_alsa_inc_prefix
+-enable_alsatest
+-enable_debug
+-enable_core_inline
+-enable_dynamic_core
+-enable_dynamic_x86
+-enable_dynrec
+-enable_fpu
+-enable_fpu_x86
+-enable_unaligned_memory
+-enable_opengl
+-'
+-      ac_precious_vars='build_alias
+-host_alias
+-target_alias
+-CC
+-CFLAGS
+-LDFLAGS
+-LIBS
+-CPPFLAGS
+-CPP
+-CXX
+-CXXFLAGS
+-CCC'
+-
+-
+-# Initialize some variables set by options.
+-ac_init_help=
+-ac_init_version=false
+-ac_unrecognized_opts=
+-ac_unrecognized_sep=
+-# The variables have the same names as the options, with
+-# dashes changed to underlines.
+-cache_file=/dev/null
+-exec_prefix=NONE
+-no_create=
+-no_recursion=
+-prefix=NONE
+-program_prefix=NONE
+-program_suffix=NONE
+-program_transform_name=s,x,x,
+-silent=
+-site=
+-srcdir=
+-verbose=
+-x_includes=NONE
+-x_libraries=NONE
+-
+-# Installation directory options.
+-# These are left unexpanded so users can "make install exec_prefix=/foo"
+-# and all the variables that are supposed to be based on exec_prefix
+-# by default will actually change.
+-# Use braces instead of parens because sh, perl, etc. also accept them.
+-# (The list follows the same order as the GNU Coding Standards.)
+-bindir='${exec_prefix}/bin'
+-sbindir='${exec_prefix}/sbin'
+-libexecdir='${exec_prefix}/libexec'
+-datarootdir='${prefix}/share'
+-datadir='${datarootdir}'
+-sysconfdir='${prefix}/etc'
+-sharedstatedir='${prefix}/com'
+-localstatedir='${prefix}/var'
+-includedir='${prefix}/include'
+-oldincludedir='/usr/include'
+-docdir='${datarootdir}/doc/${PACKAGE_TARNAME}'
+-infodir='${datarootdir}/info'
+-htmldir='${docdir}'
+-dvidir='${docdir}'
+-pdfdir='${docdir}'
+-psdir='${docdir}'
+-libdir='${exec_prefix}/lib'
+-localedir='${datarootdir}/locale'
+-mandir='${datarootdir}/man'
+-
+-ac_prev=
+-ac_dashdash=
+-for ac_option
+-do
+-  # If the previous option needs an argument, assign it.
+-  if test -n "$ac_prev"; then
+-    eval $ac_prev=\$ac_option
+-    ac_prev=
+-    continue
+-  fi
+-
+-  case $ac_option in
+-  *=*)	ac_optarg=`expr "X$ac_option" : '[^=]*=\(.*\)'` ;;
+-  *)	ac_optarg=yes ;;
+-  esac
+-
+-  # Accept the important Cygnus configure options, so we can diagnose typos.
+-
+-  case $ac_dashdash$ac_option in
+-  --)
+-    ac_dashdash=yes ;;
+-
+-  -bindir | --bindir | --bindi | --bind | --bin | --bi)
+-    ac_prev=bindir ;;
+-  -bindir=* | --bindir=* | --bindi=* | --bind=* | --bin=* | --bi=*)
+-    bindir=$ac_optarg ;;
+-
+-  -build | --build | --buil | --bui | --bu)
+-    ac_prev=build_alias ;;
+-  -build=* | --build=* | --buil=* | --bui=* | --bu=*)
+-    build_alias=$ac_optarg ;;
+-
+-  -cache-file | --cache-file | --cache-fil | --cache-fi \
+-  | --cache-f | --cache- | --cache | --cach | --cac | --ca | --c)
+-    ac_prev=cache_file ;;
+-  -cache-file=* | --cache-file=* | --cache-fil=* | --cache-fi=* \
+-  | --cache-f=* | --cache-=* | --cache=* | --cach=* | --cac=* | --ca=* | --c=*)
+-    cache_file=$ac_optarg ;;
+-
+-  --config-cache | -C)
+-    cache_file=config.cache ;;
+-
+-  -datadir | --datadir | --datadi | --datad)
+-    ac_prev=datadir ;;
+-  -datadir=* | --datadir=* | --datadi=* | --datad=*)
+-    datadir=$ac_optarg ;;
+-
+-  -datarootdir | --datarootdir | --datarootdi | --datarootd | --dataroot \
+-  | --dataroo | --dataro | --datar)
+-    ac_prev=datarootdir ;;
+-  -datarootdir=* | --datarootdir=* | --datarootdi=* | --datarootd=* \
+-  | --dataroot=* | --dataroo=* | --dataro=* | --datar=*)
+-    datarootdir=$ac_optarg ;;
+-
+-  -disable-* | --disable-*)
+-    ac_useropt=`expr "x$ac_option" : 'x-*disable-\(.*\)'`
+-    # Reject names that are not valid shell variable names.
+-    expr "x$ac_useropt" : ".*[^-+._$as_cr_alnum]" >/dev/null &&
+-      as_fn_error "invalid feature name: $ac_useropt"
+-    ac_useropt_orig=$ac_useropt
+-    ac_useropt=`$as_echo "$ac_useropt" | sed 's/[-+.]/_/g'`
+-    case $ac_user_opts in
+-      *"
+-"enable_$ac_useropt"
+-"*) ;;
+-      *) ac_unrecognized_opts="$ac_unrecognized_opts$ac_unrecognized_sep--disable-$ac_useropt_orig"
+-	 ac_unrecognized_sep=', ';;
+-    esac
+-    eval enable_$ac_useropt=no ;;
+-
+-  -docdir | --docdir | --docdi | --doc | --do)
+-    ac_prev=docdir ;;
+-  -docdir=* | --docdir=* | --docdi=* | --doc=* | --do=*)
+-    docdir=$ac_optarg ;;
+-
+-  -dvidir | --dvidir | --dvidi | --dvid | --dvi | --dv)
+-    ac_prev=dvidir ;;
+-  -dvidir=* | --dvidir=* | --dvidi=* | --dvid=* | --dvi=* | --dv=*)
+-    dvidir=$ac_optarg ;;
+-
+-  -enable-* | --enable-*)
+-    ac_useropt=`expr "x$ac_option" : 'x-*enable-\([^=]*\)'`
+-    # Reject names that are not valid shell variable names.
+-    expr "x$ac_useropt" : ".*[^-+._$as_cr_alnum]" >/dev/null &&
+-      as_fn_error "invalid feature name: $ac_useropt"
+-    ac_useropt_orig=$ac_useropt
+-    ac_useropt=`$as_echo "$ac_useropt" | sed 's/[-+.]/_/g'`
+-    case $ac_user_opts in
+-      *"
+-"enable_$ac_useropt"
+-"*) ;;
+-      *) ac_unrecognized_opts="$ac_unrecognized_opts$ac_unrecognized_sep--enable-$ac_useropt_orig"
+-	 ac_unrecognized_sep=', ';;
+-    esac
+-    eval enable_$ac_useropt=\$ac_optarg ;;
+-
+-  -exec-prefix | --exec_prefix | --exec-prefix | --exec-prefi \
+-  | --exec-pref | --exec-pre | --exec-pr | --exec-p | --exec- \
+-  | --exec | --exe | --ex)
+-    ac_prev=exec_prefix ;;
+-  -exec-prefix=* | --exec_prefix=* | --exec-prefix=* | --exec-prefi=* \
+-  | --exec-pref=* | --exec-pre=* | --exec-pr=* | --exec-p=* | --exec-=* \
+-  | --exec=* | --exe=* | --ex=*)
+-    exec_prefix=$ac_optarg ;;
+-
+-  -gas | --gas | --ga | --g)
+-    # Obsolete; use --with-gas.
+-    with_gas=yes ;;
+-
+-  -help | --help | --hel | --he | -h)
+-    ac_init_help=long ;;
+-  -help=r* | --help=r* | --hel=r* | --he=r* | -hr*)
+-    ac_init_help=recursive ;;
+-  -help=s* | --help=s* | --hel=s* | --he=s* | -hs*)
+-    ac_init_help=short ;;
+-
+-  -host | --host | --hos | --ho)
+-    ac_prev=host_alias ;;
+-  -host=* | --host=* | --hos=* | --ho=*)
+-    host_alias=$ac_optarg ;;
+-
+-  -htmldir | --htmldir | --htmldi | --htmld | --html | --htm | --ht)
+-    ac_prev=htmldir ;;
+-  -htmldir=* | --htmldir=* | --htmldi=* | --htmld=* | --html=* | --htm=* \
+-  | --ht=*)
+-    htmldir=$ac_optarg ;;
+-
+-  -includedir | --includedir | --includedi | --included | --include \
+-  | --includ | --inclu | --incl | --inc)
+-    ac_prev=includedir ;;
+-  -includedir=* | --includedir=* | --includedi=* | --included=* | --include=* \
+-  | --includ=* | --inclu=* | --incl=* | --inc=*)
+-    includedir=$ac_optarg ;;
+-
+-  -infodir | --infodir | --infodi | --infod | --info | --inf)
+-    ac_prev=infodir ;;
+-  -infodir=* | --infodir=* | --infodi=* | --infod=* | --info=* | --inf=*)
+-    infodir=$ac_optarg ;;
+-
+-  -libdir | --libdir | --libdi | --libd)
+-    ac_prev=libdir ;;
+-  -libdir=* | --libdir=* | --libdi=* | --libd=*)
+-    libdir=$ac_optarg ;;
+-
+-  -libexecdir | --libexecdir | --libexecdi | --libexecd | --libexec \
+-  | --libexe | --libex | --libe)
+-    ac_prev=libexecdir ;;
+-  -libexecdir=* | --libexecdir=* | --libexecdi=* | --libexecd=* | --libexec=* \
+-  | --libexe=* | --libex=* | --libe=*)
+-    libexecdir=$ac_optarg ;;
+-
+-  -localedir | --localedir | --localedi | --localed | --locale)
+-    ac_prev=localedir ;;
+-  -localedir=* | --localedir=* | --localedi=* | --localed=* | --locale=*)
+-    localedir=$ac_optarg ;;
+-
+-  -localstatedir | --localstatedir | --localstatedi | --localstated \
+-  | --localstate | --localstat | --localsta | --localst | --locals)
+-    ac_prev=localstatedir ;;
+-  -localstatedir=* | --localstatedir=* | --localstatedi=* | --localstated=* \
+-  | --localstate=* | --localstat=* | --localsta=* | --localst=* | --locals=*)
+-    localstatedir=$ac_optarg ;;
+-
+-  -mandir | --mandir | --mandi | --mand | --man | --ma | --m)
+-    ac_prev=mandir ;;
+-  -mandir=* | --mandir=* | --mandi=* | --mand=* | --man=* | --ma=* | --m=*)
+-    mandir=$ac_optarg ;;
+-
+-  -nfp | --nfp | --nf)
+-    # Obsolete; use --without-fp.
+-    with_fp=no ;;
+-
+-  -no-create | --no-create | --no-creat | --no-crea | --no-cre \
+-  | --no-cr | --no-c | -n)
+-    no_create=yes ;;
+-
+-  -no-recursion | --no-recursion | --no-recursio | --no-recursi \
+-  | --no-recurs | --no-recur | --no-recu | --no-rec | --no-re | --no-r)
+-    no_recursion=yes ;;
+-
+-  -oldincludedir | --oldincludedir | --oldincludedi | --oldincluded \
+-  | --oldinclude | --oldinclud | --oldinclu | --oldincl | --oldinc \
+-  | --oldin | --oldi | --old | --ol | --o)
+-    ac_prev=oldincludedir ;;
+-  -oldincludedir=* | --oldincludedir=* | --oldincludedi=* | --oldincluded=* \
+-  | --oldinclude=* | --oldinclud=* | --oldinclu=* | --oldincl=* | --oldinc=* \
+-  | --oldin=* | --oldi=* | --old=* | --ol=* | --o=*)
+-    oldincludedir=$ac_optarg ;;
+-
+-  -prefix | --prefix | --prefi | --pref | --pre | --pr | --p)
+-    ac_prev=prefix ;;
+-  -prefix=* | --prefix=* | --prefi=* | --pref=* | --pre=* | --pr=* | --p=*)
+-    prefix=$ac_optarg ;;
+-
+-  -program-prefix | --program-prefix | --program-prefi | --program-pref \
+-  | --program-pre | --program-pr | --program-p)
+-    ac_prev=program_prefix ;;
+-  -program-prefix=* | --program-prefix=* | --program-prefi=* \
+-  | --program-pref=* | --program-pre=* | --program-pr=* | --program-p=*)
+-    program_prefix=$ac_optarg ;;
+-
+-  -program-suffix | --program-suffix | --program-suffi | --program-suff \
+-  | --program-suf | --program-su | --program-s)
+-    ac_prev=program_suffix ;;
+-  -program-suffix=* | --program-suffix=* | --program-suffi=* \
+-  | --program-suff=* | --program-suf=* | --program-su=* | --program-s=*)
+-    program_suffix=$ac_optarg ;;
+-
+-  -program-transform-name | --program-transform-name \
+-  | --program-transform-nam | --program-transform-na \
+-  | --program-transform-n | --program-transform- \
+-  | --program-transform | --program-transfor \
+-  | --program-transfo | --program-transf \
+-  | --program-trans | --program-tran \
+-  | --progr-tra | --program-tr | --program-t)
+-    ac_prev=program_transform_name ;;
+-  -program-transform-name=* | --program-transform-name=* \
+-  | --program-transform-nam=* | --program-transform-na=* \
+-  | --program-transform-n=* | --program-transform-=* \
+-  | --program-transform=* | --program-transfor=* \
+-  | --program-transfo=* | --program-transf=* \
+-  | --program-trans=* | --program-tran=* \
+-  | --progr-tra=* | --program-tr=* | --program-t=*)
+-    program_transform_name=$ac_optarg ;;
+-
+-  -pdfdir | --pdfdir | --pdfdi | --pdfd | --pdf | --pd)
+-    ac_prev=pdfdir ;;
+-  -pdfdir=* | --pdfdir=* | --pdfdi=* | --pdfd=* | --pdf=* | --pd=*)
+-    pdfdir=$ac_optarg ;;
+-
+-  -psdir | --psdir | --psdi | --psd | --ps)
+-    ac_prev=psdir ;;
+-  -psdir=* | --psdir=* | --psdi=* | --psd=* | --ps=*)
+-    psdir=$ac_optarg ;;
+-
+-  -q | -quiet | --quiet | --quie | --qui | --qu | --q \
+-  | -silent | --silent | --silen | --sile | --sil)
+-    silent=yes ;;
+-
+-  -sbindir | --sbindir | --sbindi | --sbind | --sbin | --sbi | --sb)
+-    ac_prev=sbindir ;;
+-  -sbindir=* | --sbindir=* | --sbindi=* | --sbind=* | --sbin=* \
+-  | --sbi=* | --sb=*)
+-    sbindir=$ac_optarg ;;
+-
+-  -sharedstatedir | --sharedstatedir | --sharedstatedi \
+-  | --sharedstated | --sharedstate | --sharedstat | --sharedsta \
+-  | --sharedst | --shareds | --shared | --share | --shar \
+-  | --sha | --sh)
+-    ac_prev=sharedstatedir ;;
+-  -sharedstatedir=* | --sharedstatedir=* | --sharedstatedi=* \
+-  | --sharedstated=* | --sharedstate=* | --sharedstat=* | --sharedsta=* \
+-  | --sharedst=* | --shareds=* | --shared=* | --share=* | --shar=* \
+-  | --sha=* | --sh=*)
+-    sharedstatedir=$ac_optarg ;;
+-
+-  -site | --site | --sit)
+-    ac_prev=site ;;
+-  -site=* | --site=* | --sit=*)
+-    site=$ac_optarg ;;
+-
+-  -srcdir | --srcdir | --srcdi | --srcd | --src | --sr)
+-    ac_prev=srcdir ;;
+-  -srcdir=* | --srcdir=* | --srcdi=* | --srcd=* | --src=* | --sr=*)
+-    srcdir=$ac_optarg ;;
+-
+-  -sysconfdir | --sysconfdir | --sysconfdi | --sysconfd | --sysconf \
+-  | --syscon | --sysco | --sysc | --sys | --sy)
+-    ac_prev=sysconfdir ;;
+-  -sysconfdir=* | --sysconfdir=* | --sysconfdi=* | --sysconfd=* | --sysconf=* \
+-  | --syscon=* | --sysco=* | --sysc=* | --sys=* | --sy=*)
+-    sysconfdir=$ac_optarg ;;
+-
+-  -target | --target | --targe | --targ | --tar | --ta | --t)
+-    ac_prev=target_alias ;;
+-  -target=* | --target=* | --targe=* | --targ=* | --tar=* | --ta=* | --t=*)
+-    target_alias=$ac_optarg ;;
+-
+-  -v | -verbose | --verbose | --verbos | --verbo | --verb)
+-    verbose=yes ;;
+-
+-  -version | --version | --versio | --versi | --vers | -V)
+-    ac_init_version=: ;;
+-
+-  -with-* | --with-*)
+-    ac_useropt=`expr "x$ac_option" : 'x-*with-\([^=]*\)'`
+-    # Reject names that are not valid shell variable names.
+-    expr "x$ac_useropt" : ".*[^-+._$as_cr_alnum]" >/dev/null &&
+-      as_fn_error "invalid package name: $ac_useropt"
+-    ac_useropt_orig=$ac_useropt
+-    ac_useropt=`$as_echo "$ac_useropt" | sed 's/[-+.]/_/g'`
+-    case $ac_user_opts in
+-      *"
+-"with_$ac_useropt"
+-"*) ;;
+-      *) ac_unrecognized_opts="$ac_unrecognized_opts$ac_unrecognized_sep--with-$ac_useropt_orig"
+-	 ac_unrecognized_sep=', ';;
+-    esac
+-    eval with_$ac_useropt=\$ac_optarg ;;
+-
+-  -without-* | --without-*)
+-    ac_useropt=`expr "x$ac_option" : 'x-*without-\(.*\)'`
+-    # Reject names that are not valid shell variable names.
+-    expr "x$ac_useropt" : ".*[^-+._$as_cr_alnum]" >/dev/null &&
+-      as_fn_error "invalid package name: $ac_useropt"
+-    ac_useropt_orig=$ac_useropt
+-    ac_useropt=`$as_echo "$ac_useropt" | sed 's/[-+.]/_/g'`
+-    case $ac_user_opts in
+-      *"
+-"with_$ac_useropt"
+-"*) ;;
+-      *) ac_unrecognized_opts="$ac_unrecognized_opts$ac_unrecognized_sep--without-$ac_useropt_orig"
+-	 ac_unrecognized_sep=', ';;
+-    esac
+-    eval with_$ac_useropt=no ;;
+-
+-  --x)
+-    # Obsolete; use --with-x.
+-    with_x=yes ;;
+-
+-  -x-includes | --x-includes | --x-include | --x-includ | --x-inclu \
+-  | --x-incl | --x-inc | --x-in | --x-i)
+-    ac_prev=x_includes ;;
+-  -x-includes=* | --x-includes=* | --x-include=* | --x-includ=* | --x-inclu=* \
+-  | --x-incl=* | --x-inc=* | --x-in=* | --x-i=*)
+-    x_includes=$ac_optarg ;;
+-
+-  -x-libraries | --x-libraries | --x-librarie | --x-librari \
+-  | --x-librar | --x-libra | --x-libr | --x-lib | --x-li | --x-l)
+-    ac_prev=x_libraries ;;
+-  -x-libraries=* | --x-libraries=* | --x-librarie=* | --x-librari=* \
+-  | --x-librar=* | --x-libra=* | --x-libr=* | --x-lib=* | --x-li=* | --x-l=*)
+-    x_libraries=$ac_optarg ;;
+-
+-  -*) as_fn_error "unrecognized option: \`$ac_option'
+-Try \`$0 --help' for more information."
+-    ;;
+-
+-  *=*)
+-    ac_envvar=`expr "x$ac_option" : 'x\([^=]*\)='`
+-    # Reject names that are not valid shell variable names.
+-    case $ac_envvar in #(
+-      '' | [0-9]* | *[!_$as_cr_alnum]* )
+-      as_fn_error "invalid variable name: \`$ac_envvar'" ;;
+-    esac
+-    eval $ac_envvar=\$ac_optarg
+-    export $ac_envvar ;;
+-
+-  *)
+-    # FIXME: should be removed in autoconf 3.0.
+-    $as_echo "$as_me: WARNING: you should use --build, --host, --target" >&2
+-    expr "x$ac_option" : ".*[^-._$as_cr_alnum]" >/dev/null &&
+-      $as_echo "$as_me: WARNING: invalid host type: $ac_option" >&2
+-    : ${build_alias=$ac_option} ${host_alias=$ac_option} ${target_alias=$ac_option}
+-    ;;
+-
+-  esac
+-done
+-
+-if test -n "$ac_prev"; then
+-  ac_option=--`echo $ac_prev | sed 's/_/-/g'`
+-  as_fn_error "missing argument to $ac_option"
+-fi
+-
+-if test -n "$ac_unrecognized_opts"; then
+-  case $enable_option_checking in
+-    no) ;;
+-    fatal) as_fn_error "unrecognized options: $ac_unrecognized_opts" ;;
+-    *)     $as_echo "$as_me: WARNING: unrecognized options: $ac_unrecognized_opts" >&2 ;;
+-  esac
+-fi
+-
+-# Check all directory arguments for consistency.
+-for ac_var in	exec_prefix prefix bindir sbindir libexecdir datarootdir \
+-		datadir sysconfdir sharedstatedir localstatedir includedir \
+-		oldincludedir docdir infodir htmldir dvidir pdfdir psdir \
+-		libdir localedir mandir
+-do
+-  eval ac_val=\$$ac_var
+-  # Remove trailing slashes.
+-  case $ac_val in
+-    */ )
+-      ac_val=`expr "X$ac_val" : 'X\(.*[^/]\)' \| "X$ac_val" : 'X\(.*\)'`
+-      eval $ac_var=\$ac_val;;
+-  esac
+-  # Be sure to have absolute directory names.
+-  case $ac_val in
+-    [\\/$]* | ?:[\\/]* )  continue;;
+-    NONE | '' ) case $ac_var in *prefix ) continue;; esac;;
+-  esac
+-  as_fn_error "expected an absolute directory name for --$ac_var: $ac_val"
+-done
+-
+-# There might be people who depend on the old broken behavior: `$host'
+-# used to hold the argument of --host etc.
+-# FIXME: To remove some day.
+-build=$build_alias
+-host=$host_alias
+-target=$target_alias
+-
+-# FIXME: To remove some day.
+-if test "x$host_alias" != x; then
+-  if test "x$build_alias" = x; then
+-    cross_compiling=maybe
+-    $as_echo "$as_me: WARNING: If you wanted to set the --build type, don't use --host.
+-    If a cross compiler is detected then cross compile mode will be used." >&2
+-  elif test "x$build_alias" != "x$host_alias"; then
+-    cross_compiling=yes
+-  fi
+-fi
+-
+-ac_tool_prefix=
+-test -n "$host_alias" && ac_tool_prefix=$host_alias-
+-
+-test "$silent" = yes && exec 6>/dev/null
+-
+-
+-ac_pwd=`pwd` && test -n "$ac_pwd" &&
+-ac_ls_di=`ls -di .` &&
+-ac_pwd_ls_di=`cd "$ac_pwd" && ls -di .` ||
+-  as_fn_error "working directory cannot be determined"
+-test "X$ac_ls_di" = "X$ac_pwd_ls_di" ||
+-  as_fn_error "pwd does not report name of working directory"
+-
+-
+-# Find the source files, if location was not specified.
+-if test -z "$srcdir"; then
+-  ac_srcdir_defaulted=yes
+-  # Try the directory containing this script, then the parent directory.
+-  ac_confdir=`$as_dirname -- "$as_myself" ||
+-$as_expr X"$as_myself" : 'X\(.*[^/]\)//*[^/][^/]*/*$' \| \
+-	 X"$as_myself" : 'X\(//\)[^/]' \| \
+-	 X"$as_myself" : 'X\(//\)$' \| \
+-	 X"$as_myself" : 'X\(/\)' \| . 2>/dev/null ||
+-$as_echo X"$as_myself" |
+-    sed '/^X\(.*[^/]\)\/\/*[^/][^/]*\/*$/{
+-	    s//\1/
+-	    q
+-	  }
+-	  /^X\(\/\/\)[^/].*/{
+-	    s//\1/
+-	    q
+-	  }
+-	  /^X\(\/\/\)$/{
+-	    s//\1/
+-	    q
+-	  }
+-	  /^X\(\/\).*/{
+-	    s//\1/
+-	    q
+-	  }
+-	  s/.*/./; q'`
+-  srcdir=$ac_confdir
+-  if test ! -r "$srcdir/$ac_unique_file"; then
+-    srcdir=..
+-  fi
+-else
+-  ac_srcdir_defaulted=no
+-fi
+-if test ! -r "$srcdir/$ac_unique_file"; then
+-  test "$ac_srcdir_defaulted" = yes && srcdir="$ac_confdir or .."
+-  as_fn_error "cannot find sources ($ac_unique_file) in $srcdir"
+-fi
+-ac_msg="sources are in $srcdir, but \`cd $srcdir' does not work"
+-ac_abs_confdir=`(
+-	cd "$srcdir" && test -r "./$ac_unique_file" || as_fn_error "$ac_msg"
+-	pwd)`
+-# When building in place, set srcdir=.
+-if test "$ac_abs_confdir" = "$ac_pwd"; then
+-  srcdir=.
+-fi
+-# Remove unnecessary trailing slashes from srcdir.
+-# Double slashes in file names in object file debugging info
+-# mess up M-x gdb in Emacs.
+-case $srcdir in
+-*/) srcdir=`expr "X$srcdir" : 'X\(.*[^/]\)' \| "X$srcdir" : 'X\(.*\)'`;;
+-esac
+-for ac_var in $ac_precious_vars; do
+-  eval ac_env_${ac_var}_set=\${${ac_var}+set}
+-  eval ac_env_${ac_var}_value=\$${ac_var}
+-  eval ac_cv_env_${ac_var}_set=\${${ac_var}+set}
+-  eval ac_cv_env_${ac_var}_value=\$${ac_var}
+-done
+-
+-#
+-# Report the --help message.
+-#
+-if test "$ac_init_help" = "long"; then
+-  # Omit some internal or obsolete options to make the list less imposing.
+-  # This message is too long to be a string in the A/UX 3.1 sh.
+-  cat <<_ACEOF
+-\`configure' configures dosbox 0.74 to adapt to many kinds of systems.
+-
+-Usage: $0 [OPTION]... [VAR=VALUE]...
+-
+-To assign environment variables (e.g., CC, CFLAGS...), specify them as
+-VAR=VALUE.  See below for descriptions of some of the useful variables.
+-
+-Defaults for the options are specified in brackets.
+-
+-Configuration:
+-  -h, --help              display this help and exit
+-      --help=short        display options specific to this package
+-      --help=recursive    display the short help of all the included packages
+-  -V, --version           display version information and exit
+-  -q, --quiet, --silent   do not print \`checking...' messages
+-      --cache-file=FILE   cache test results in FILE [disabled]
+-  -C, --config-cache      alias for \`--cache-file=config.cache'
+-  -n, --no-create         do not create output files
+-      --srcdir=DIR        find the sources in DIR [configure dir or \`..']
+-
+-Installation directories:
+-  --prefix=PREFIX         install architecture-independent files in PREFIX
+-                          [$ac_default_prefix]
+-  --exec-prefix=EPREFIX   install architecture-dependent files in EPREFIX
+-                          [PREFIX]
+-
+-By default, \`make install' will install all the files in
+-\`$ac_default_prefix/bin', \`$ac_default_prefix/lib' etc.  You can specify
+-an installation prefix other than \`$ac_default_prefix' using \`--prefix',
+-for instance \`--prefix=\$HOME'.
+-
+-For better control, use the options below.
+-
+-Fine tuning of the installation directories:
+-  --bindir=DIR            user executables [EPREFIX/bin]
+-  --sbindir=DIR           system admin executables [EPREFIX/sbin]
+-  --libexecdir=DIR        program executables [EPREFIX/libexec]
+-  --sysconfdir=DIR        read-only single-machine data [PREFIX/etc]
+-  --sharedstatedir=DIR    modifiable architecture-independent data [PREFIX/com]
+-  --localstatedir=DIR     modifiable single-machine data [PREFIX/var]
+-  --libdir=DIR            object code libraries [EPREFIX/lib]
+-  --includedir=DIR        C header files [PREFIX/include]
+-  --oldincludedir=DIR     C header files for non-gcc [/usr/include]
+-  --datarootdir=DIR       read-only arch.-independent data root [PREFIX/share]
+-  --datadir=DIR           read-only architecture-independent data [DATAROOTDIR]
+-  --infodir=DIR           info documentation [DATAROOTDIR/info]
+-  --localedir=DIR         locale-dependent data [DATAROOTDIR/locale]
+-  --mandir=DIR            man documentation [DATAROOTDIR/man]
+-  --docdir=DIR            documentation root [DATAROOTDIR/doc/dosbox]
+-  --htmldir=DIR           html documentation [DOCDIR]
+-  --dvidir=DIR            dvi documentation [DOCDIR]
+-  --pdfdir=DIR            pdf documentation [DOCDIR]
+-  --psdir=DIR             ps documentation [DOCDIR]
+-_ACEOF
+-
+-  cat <<\_ACEOF
+-
+-Program names:
+-  --program-prefix=PREFIX            prepend PREFIX to installed program names
+-  --program-suffix=SUFFIX            append SUFFIX to installed program names
+-  --program-transform-name=PROGRAM   run sed PROGRAM on installed program names
+-
+-System types:
+-  --build=BUILD     configure for building on BUILD [guessed]
+-  --host=HOST       cross-compile to build programs to run on HOST [BUILD]
+-_ACEOF
+-fi
+-
+-if test -n "$ac_init_help"; then
+-  case $ac_init_help in
+-     short | recursive ) echo "Configuration of dosbox 0.74:";;
+-   esac
+-  cat <<\_ACEOF
+-
+-Optional Features:
+-  --disable-option-checking  ignore unrecognized --enable/--with options
+-  --disable-FEATURE       do not include FEATURE (same as --enable-FEATURE=no)
+-  --enable-FEATURE[=ARG]  include FEATURE [ARG=yes]
+-  --disable-dependency-tracking  speeds up one-time build
+-  --enable-dependency-tracking   do not reject slow dependency extractors
+-  --disable-sdltest       Do not try to compile and run a test SDL program
+-  --enable-alsa-midi      compile with alsa midi support (default yes)
+-  --disable-alsatest      Do not try to compile and run a test Alsa program
+-  --enable-debug          Enable debug mode
+-  --enable-core-inline    Enable inlined memory handling in CPU Core
+-  --disable-dynamic-core  Disable all dynamic cores
+-  --disable-dynamic-x86   Disable x86 dynamic cpu core
+-  --disable-dynrec        Disable recompiling cpu core
+-  --disable-fpu           Disable fpu support
+-  --disable-fpu-x86       Disable x86 assembly fpu core
+-  --disable-unaligned-memory
+-                          Disable unaligned memory access
+-  --disable-opengl        Disable opengl support
+-
+-Optional Packages:
+-  --with-PACKAGE[=ARG]    use PACKAGE [ARG=yes]
+-  --without-PACKAGE       do not use PACKAGE (same as --with-PACKAGE=no)
+-  --with-sdl-prefix=PFX   Prefix where SDL is installed (optional)
+-  --with-sdl-exec-prefix=PFX Exec prefix where SDL is installed (optional)
+-  --with-alsa-prefix=PFX  Prefix where Alsa library is installed(optional)
+-  --with-alsa-inc-prefix=PFX  Prefix where include libraries are (optional)
+-
+-Some influential environment variables:
+-  CC          C compiler command
+-  CFLAGS      C compiler flags
+-  LDFLAGS     linker flags, e.g. -L<lib dir> if you have libraries in a
+-              nonstandard directory <lib dir>
+-  LIBS        libraries to pass to the linker, e.g. -l<library>
+-  CPPFLAGS    (Objective) C/C++ preprocessor flags, e.g. -I<include dir> if
+-              you have headers in a nonstandard directory <include dir>
+-  CPP         C preprocessor
+-  CXX         C++ compiler command
+-  CXXFLAGS    C++ compiler flags
+-
+-Use these variables to override the choices made by `configure' or to help
+-it to find libraries and programs with nonstandard names/locations.
+-
+-Report bugs to the package provider.
+-_ACEOF
+-ac_status=$?
+-fi
+-
+-if test "$ac_init_help" = "recursive"; then
+-  # If there are subdirs, report their specific --help.
+-  for ac_dir in : $ac_subdirs_all; do test "x$ac_dir" = x: && continue
+-    test -d "$ac_dir" ||
+-      { cd "$srcdir" && ac_pwd=`pwd` && srcdir=. && test -d "$ac_dir"; } ||
+-      continue
+-    ac_builddir=.
+-
+-case "$ac_dir" in
+-.) ac_dir_suffix= ac_top_builddir_sub=. ac_top_build_prefix= ;;
+-*)
+-  ac_dir_suffix=/`$as_echo "$ac_dir" | sed 's|^\.[\\/]||'`
+-  # A ".." for each directory in $ac_dir_suffix.
+-  ac_top_builddir_sub=`$as_echo "$ac_dir_suffix" | sed 's|/[^\\/]*|/..|g;s|/||'`
+-  case $ac_top_builddir_sub in
+-  "") ac_top_builddir_sub=. ac_top_build_prefix= ;;
+-  *)  ac_top_build_prefix=$ac_top_builddir_sub/ ;;
+-  esac ;;
+-esac
+-ac_abs_top_builddir=$ac_pwd
+-ac_abs_builddir=$ac_pwd$ac_dir_suffix
+-# for backward compatibility:
+-ac_top_builddir=$ac_top_build_prefix
+-
+-case $srcdir in
+-  .)  # We are building in place.
+-    ac_srcdir=.
+-    ac_top_srcdir=$ac_top_builddir_sub
+-    ac_abs_top_srcdir=$ac_pwd ;;
+-  [\\/]* | ?:[\\/]* )  # Absolute name.
+-    ac_srcdir=$srcdir$ac_dir_suffix;
+-    ac_top_srcdir=$srcdir
+-    ac_abs_top_srcdir=$srcdir ;;
+-  *) # Relative name.
+-    ac_srcdir=$ac_top_build_prefix$srcdir$ac_dir_suffix
+-    ac_top_srcdir=$ac_top_build_prefix$srcdir
+-    ac_abs_top_srcdir=$ac_pwd/$srcdir ;;
+-esac
+-ac_abs_srcdir=$ac_abs_top_srcdir$ac_dir_suffix
+-
+-    cd "$ac_dir" || { ac_status=$?; continue; }
+-    # Check for guested configure.
+-    if test -f "$ac_srcdir/configure.gnu"; then
+-      echo &&
+-      $SHELL "$ac_srcdir/configure.gnu" --help=recursive
+-    elif test -f "$ac_srcdir/configure"; then
+-      echo &&
+-      $SHELL "$ac_srcdir/configure" --help=recursive
+-    else
+-      $as_echo "$as_me: WARNING: no configuration information is in $ac_dir" >&2
+-    fi || ac_status=$?
+-    cd "$ac_pwd" || { ac_status=$?; break; }
+-  done
+-fi
+-
+-test -n "$ac_init_help" && exit $ac_status
+-if $ac_init_version; then
+-  cat <<\_ACEOF
+-dosbox configure 0.74
+-generated by GNU Autoconf 2.65
+-
+-Copyright (C) 2009 Free Software Foundation, Inc.
+-This configure script is free software; the Free Software Foundation
+-gives unlimited permission to copy, distribute and modify it.
+-_ACEOF
+-  exit
+-fi
+-
+-## ------------------------ ##
+-## Autoconf initialization. ##
+-## ------------------------ ##
+-
+-# ac_fn_c_try_compile LINENO
+-# --------------------------
+-# Try to compile conftest.$ac_ext, and return whether this succeeded.
+-ac_fn_c_try_compile ()
+-{
+-  as_lineno=${as_lineno-"$1"} as_lineno_stack=as_lineno_stack=$as_lineno_stack
+-  rm -f conftest.$ac_objext
+-  if { { ac_try="$ac_compile"
+-case "(($ac_try" in
+-  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+-  *) ac_try_echo=$ac_try;;
+-esac
+-eval ac_try_echo="\"\$as_me:${as_lineno-$LINENO}: $ac_try_echo\""
+-$as_echo "$ac_try_echo"; } >&5
+-  (eval "$ac_compile") 2>conftest.err
+-  ac_status=$?
+-  if test -s conftest.err; then
+-    grep -v '^ *+' conftest.err >conftest.er1
+-    cat conftest.er1 >&5
+-    mv -f conftest.er1 conftest.err
+-  fi
+-  $as_echo "$as_me:${as_lineno-$LINENO}: \$? = $ac_status" >&5
+-  test $ac_status = 0; } && {
+-	 test -z "$ac_c_werror_flag" ||
+-	 test ! -s conftest.err
+-       } && test -s conftest.$ac_objext; then :
+-  ac_retval=0
+-else
+-  $as_echo "$as_me: failed program was:" >&5
+-sed 's/^/| /' conftest.$ac_ext >&5
+-
+-	ac_retval=1
+-fi
+-  eval $as_lineno_stack; test "x$as_lineno_stack" = x && { as_lineno=; unset as_lineno;}
+-  as_fn_set_status $ac_retval
+-
+-} # ac_fn_c_try_compile
+-
+-# ac_fn_c_try_cpp LINENO
+-# ----------------------
+-# Try to preprocess conftest.$ac_ext, and return whether this succeeded.
+-ac_fn_c_try_cpp ()
+-{
+-  as_lineno=${as_lineno-"$1"} as_lineno_stack=as_lineno_stack=$as_lineno_stack
+-  if { { ac_try="$ac_cpp conftest.$ac_ext"
+-case "(($ac_try" in
+-  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+-  *) ac_try_echo=$ac_try;;
+-esac
+-eval ac_try_echo="\"\$as_me:${as_lineno-$LINENO}: $ac_try_echo\""
+-$as_echo "$ac_try_echo"; } >&5
+-  (eval "$ac_cpp conftest.$ac_ext") 2>conftest.err
+-  ac_status=$?
+-  if test -s conftest.err; then
+-    grep -v '^ *+' conftest.err >conftest.er1
+-    cat conftest.er1 >&5
+-    mv -f conftest.er1 conftest.err
+-  fi
+-  $as_echo "$as_me:${as_lineno-$LINENO}: \$? = $ac_status" >&5
+-  test $ac_status = 0; } >/dev/null && {
+-	 test -z "$ac_c_preproc_warn_flag$ac_c_werror_flag" ||
+-	 test ! -s conftest.err
+-       }; then :
+-  ac_retval=0
+-else
+-  $as_echo "$as_me: failed program was:" >&5
+-sed 's/^/| /' conftest.$ac_ext >&5
+-
+-    ac_retval=1
+-fi
+-  eval $as_lineno_stack; test "x$as_lineno_stack" = x && { as_lineno=; unset as_lineno;}
+-  as_fn_set_status $ac_retval
+-
+-} # ac_fn_c_try_cpp
+-
+-# ac_fn_cxx_try_compile LINENO
+-# ----------------------------
+-# Try to compile conftest.$ac_ext, and return whether this succeeded.
+-ac_fn_cxx_try_compile ()
+-{
+-  as_lineno=${as_lineno-"$1"} as_lineno_stack=as_lineno_stack=$as_lineno_stack
+-  rm -f conftest.$ac_objext
+-  if { { ac_try="$ac_compile"
+-case "(($ac_try" in
+-  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+-  *) ac_try_echo=$ac_try;;
+-esac
+-eval ac_try_echo="\"\$as_me:${as_lineno-$LINENO}: $ac_try_echo\""
+-$as_echo "$ac_try_echo"; } >&5
+-  (eval "$ac_compile") 2>conftest.err
+-  ac_status=$?
+-  if test -s conftest.err; then
+-    grep -v '^ *+' conftest.err >conftest.er1
+-    cat conftest.er1 >&5
+-    mv -f conftest.er1 conftest.err
+-  fi
+-  $as_echo "$as_me:${as_lineno-$LINENO}: \$? = $ac_status" >&5
+-  test $ac_status = 0; } && {
+-	 test -z "$ac_cxx_werror_flag" ||
+-	 test ! -s conftest.err
+-       } && test -s conftest.$ac_objext; then :
+-  ac_retval=0
+-else
+-  $as_echo "$as_me: failed program was:" >&5
+-sed 's/^/| /' conftest.$ac_ext >&5
+-
+-	ac_retval=1
+-fi
+-  eval $as_lineno_stack; test "x$as_lineno_stack" = x && { as_lineno=; unset as_lineno;}
+-  as_fn_set_status $ac_retval
+-
+-} # ac_fn_cxx_try_compile
+-
+-# ac_fn_c_try_run LINENO
+-# ----------------------
+-# Try to link conftest.$ac_ext, and return whether this succeeded. Assumes
+-# that executables *can* be run.
+-ac_fn_c_try_run ()
+-{
+-  as_lineno=${as_lineno-"$1"} as_lineno_stack=as_lineno_stack=$as_lineno_stack
+-  if { { ac_try="$ac_link"
+-case "(($ac_try" in
+-  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+-  *) ac_try_echo=$ac_try;;
+-esac
+-eval ac_try_echo="\"\$as_me:${as_lineno-$LINENO}: $ac_try_echo\""
+-$as_echo "$ac_try_echo"; } >&5
+-  (eval "$ac_link") 2>&5
+-  ac_status=$?
+-  $as_echo "$as_me:${as_lineno-$LINENO}: \$? = $ac_status" >&5
+-  test $ac_status = 0; } && { ac_try='./conftest$ac_exeext'
+-  { { case "(($ac_try" in
+-  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+-  *) ac_try_echo=$ac_try;;
+-esac
+-eval ac_try_echo="\"\$as_me:${as_lineno-$LINENO}: $ac_try_echo\""
+-$as_echo "$ac_try_echo"; } >&5
+-  (eval "$ac_try") 2>&5
+-  ac_status=$?
+-  $as_echo "$as_me:${as_lineno-$LINENO}: \$? = $ac_status" >&5
+-  test $ac_status = 0; }; }; then :
+-  ac_retval=0
+-else
+-  $as_echo "$as_me: program exited with status $ac_status" >&5
+-       $as_echo "$as_me: failed program was:" >&5
+-sed 's/^/| /' conftest.$ac_ext >&5
+-
+-       ac_retval=$ac_status
+-fi
+-  rm -rf conftest.dSYM conftest_ipa8_conftest.oo
+-  eval $as_lineno_stack; test "x$as_lineno_stack" = x && { as_lineno=; unset as_lineno;}
+-  as_fn_set_status $ac_retval
+-
+-} # ac_fn_c_try_run
+-
+-# ac_fn_c_try_link LINENO
+-# -----------------------
+-# Try to link conftest.$ac_ext, and return whether this succeeded.
+-ac_fn_c_try_link ()
+-{
+-  as_lineno=${as_lineno-"$1"} as_lineno_stack=as_lineno_stack=$as_lineno_stack
+-  rm -f conftest.$ac_objext conftest$ac_exeext
+-  if { { ac_try="$ac_link"
+-case "(($ac_try" in
+-  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+-  *) ac_try_echo=$ac_try;;
+-esac
+-eval ac_try_echo="\"\$as_me:${as_lineno-$LINENO}: $ac_try_echo\""
+-$as_echo "$ac_try_echo"; } >&5
+-  (eval "$ac_link") 2>conftest.err
+-  ac_status=$?
+-  if test -s conftest.err; then
+-    grep -v '^ *+' conftest.err >conftest.er1
+-    cat conftest.er1 >&5
+-    mv -f conftest.er1 conftest.err
+-  fi
+-  $as_echo "$as_me:${as_lineno-$LINENO}: \$? = $ac_status" >&5
+-  test $ac_status = 0; } && {
+-	 test -z "$ac_c_werror_flag" ||
+-	 test ! -s conftest.err
+-       } && test -s conftest$ac_exeext && {
+-	 test "$cross_compiling" = yes ||
+-	 $as_test_x conftest$ac_exeext
+-       }; then :
+-  ac_retval=0
+-else
+-  $as_echo "$as_me: failed program was:" >&5
+-sed 's/^/| /' conftest.$ac_ext >&5
+-
+-	ac_retval=1
+-fi
+-  # Delete the IPA/IPO (Inter Procedural Analysis/Optimization) information
+-  # created by the PGI compiler (conftest_ipa8_conftest.oo), as it would
+-  # interfere with the next link command; also delete a directory that is
+-  # left behind by Apple's compiler.  We do this before executing the actions.
+-  rm -rf conftest.dSYM conftest_ipa8_conftest.oo
+-  eval $as_lineno_stack; test "x$as_lineno_stack" = x && { as_lineno=; unset as_lineno;}
+-  as_fn_set_status $ac_retval
+-
+-} # ac_fn_c_try_link
+-
+-# ac_fn_c_check_type LINENO TYPE VAR INCLUDES
+-# -------------------------------------------
+-# Tests whether TYPE exists after having included INCLUDES, setting cache
+-# variable VAR accordingly.
+-ac_fn_c_check_type ()
+-{
+-  as_lineno=${as_lineno-"$1"} as_lineno_stack=as_lineno_stack=$as_lineno_stack
+-  { $as_echo "$as_me:${as_lineno-$LINENO}: checking for $2" >&5
+-$as_echo_n "checking for $2... " >&6; }
+-if { as_var=$3; eval "test \"\${$as_var+set}\" = set"; }; then :
+-  $as_echo_n "(cached) " >&6
+-else
+-  eval "$3=no"
+-  cat confdefs.h - <<_ACEOF >conftest.$ac_ext
+-/* end confdefs.h.  */
+-$4
+-int
+-main ()
+-{
+-if (sizeof ($2))
+-	 return 0;
+-  ;
+-  return 0;
+-}
+-_ACEOF
+-if ac_fn_c_try_compile "$LINENO"; then :
+-  cat confdefs.h - <<_ACEOF >conftest.$ac_ext
+-/* end confdefs.h.  */
+-$4
+-int
+-main ()
+-{
+-if (sizeof (($2)))
+-	    return 0;
+-  ;
+-  return 0;
+-}
+-_ACEOF
+-if ac_fn_c_try_compile "$LINENO"; then :
+-
+-else
+-  eval "$3=yes"
+-fi
+-rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
+-fi
+-rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
+-fi
+-eval ac_res=\$$3
+-	       { $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_res" >&5
+-$as_echo "$ac_res" >&6; }
+-  eval $as_lineno_stack; test "x$as_lineno_stack" = x && { as_lineno=; unset as_lineno;}
+-
+-} # ac_fn_c_check_type
+-
+-# ac_fn_c_check_header_compile LINENO HEADER VAR INCLUDES
+-# -------------------------------------------------------
+-# Tests whether HEADER exists and can be compiled using the include files in
+-# INCLUDES, setting the cache variable VAR accordingly.
+-ac_fn_c_check_header_compile ()
+-{
+-  as_lineno=${as_lineno-"$1"} as_lineno_stack=as_lineno_stack=$as_lineno_stack
+-  { $as_echo "$as_me:${as_lineno-$LINENO}: checking for $2" >&5
+-$as_echo_n "checking for $2... " >&6; }
+-if { as_var=$3; eval "test \"\${$as_var+set}\" = set"; }; then :
+-  $as_echo_n "(cached) " >&6
+-else
+-  cat confdefs.h - <<_ACEOF >conftest.$ac_ext
+-/* end confdefs.h.  */
+-$4
+-#include <$2>
+-_ACEOF
+-if ac_fn_c_try_compile "$LINENO"; then :
+-  eval "$3=yes"
+-else
+-  eval "$3=no"
+-fi
+-rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
+-fi
+-eval ac_res=\$$3
+-	       { $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_res" >&5
+-$as_echo "$ac_res" >&6; }
+-  eval $as_lineno_stack; test "x$as_lineno_stack" = x && { as_lineno=; unset as_lineno;}
+-
+-} # ac_fn_c_check_header_compile
+-
+-# ac_fn_c_compute_int LINENO EXPR VAR INCLUDES
+-# --------------------------------------------
+-# Tries to find the compile-time value of EXPR in a program that includes
+-# INCLUDES, setting VAR accordingly. Returns whether the value could be
+-# computed
+-ac_fn_c_compute_int ()
+-{
+-  as_lineno=${as_lineno-"$1"} as_lineno_stack=as_lineno_stack=$as_lineno_stack
+-  if test "$cross_compiling" = yes; then
+-    # Depending upon the size, compute the lo and hi bounds.
+-cat confdefs.h - <<_ACEOF >conftest.$ac_ext
+-/* end confdefs.h.  */
+-$4
+-int
+-main ()
+-{
+-static int test_array [1 - 2 * !(($2) >= 0)];
+-test_array [0] = 0
+-
+-  ;
+-  return 0;
+-}
+-_ACEOF
+-if ac_fn_c_try_compile "$LINENO"; then :
+-  ac_lo=0 ac_mid=0
+-  while :; do
+-    cat confdefs.h - <<_ACEOF >conftest.$ac_ext
+-/* end confdefs.h.  */
+-$4
+-int
+-main ()
+-{
+-static int test_array [1 - 2 * !(($2) <= $ac_mid)];
+-test_array [0] = 0
+-
+-  ;
+-  return 0;
+-}
+-_ACEOF
+-if ac_fn_c_try_compile "$LINENO"; then :
+-  ac_hi=$ac_mid; break
+-else
+-  as_fn_arith $ac_mid + 1 && ac_lo=$as_val
+-			if test $ac_lo -le $ac_mid; then
+-			  ac_lo= ac_hi=
+-			  break
+-			fi
+-			as_fn_arith 2 '*' $ac_mid + 1 && ac_mid=$as_val
+-fi
+-rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
+-  done
+-else
+-  cat confdefs.h - <<_ACEOF >conftest.$ac_ext
+-/* end confdefs.h.  */
+-$4
+-int
+-main ()
+-{
+-static int test_array [1 - 2 * !(($2) < 0)];
+-test_array [0] = 0
+-
+-  ;
+-  return 0;
+-}
+-_ACEOF
+-if ac_fn_c_try_compile "$LINENO"; then :
+-  ac_hi=-1 ac_mid=-1
+-  while :; do
+-    cat confdefs.h - <<_ACEOF >conftest.$ac_ext
+-/* end confdefs.h.  */
+-$4
+-int
+-main ()
+-{
+-static int test_array [1 - 2 * !(($2) >= $ac_mid)];
+-test_array [0] = 0
+-
+-  ;
+-  return 0;
+-}
+-_ACEOF
+-if ac_fn_c_try_compile "$LINENO"; then :
+-  ac_lo=$ac_mid; break
+-else
+-  as_fn_arith '(' $ac_mid ')' - 1 && ac_hi=$as_val
+-			if test $ac_mid -le $ac_hi; then
+-			  ac_lo= ac_hi=
+-			  break
+-			fi
+-			as_fn_arith 2 '*' $ac_mid && ac_mid=$as_val
+-fi
+-rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
+-  done
+-else
+-  ac_lo= ac_hi=
+-fi
+-rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
+-fi
+-rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
+-# Binary search between lo and hi bounds.
+-while test "x$ac_lo" != "x$ac_hi"; do
+-  as_fn_arith '(' $ac_hi - $ac_lo ')' / 2 + $ac_lo && ac_mid=$as_val
+-  cat confdefs.h - <<_ACEOF >conftest.$ac_ext
+-/* end confdefs.h.  */
+-$4
+-int
+-main ()
+-{
+-static int test_array [1 - 2 * !(($2) <= $ac_mid)];
+-test_array [0] = 0
+-
+-  ;
+-  return 0;
+-}
+-_ACEOF
+-if ac_fn_c_try_compile "$LINENO"; then :
+-  ac_hi=$ac_mid
+-else
+-  as_fn_arith '(' $ac_mid ')' + 1 && ac_lo=$as_val
+-fi
+-rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
+-done
+-case $ac_lo in #((
+-?*) eval "$3=\$ac_lo"; ac_retval=0 ;;
+-'') ac_retval=1 ;;
+-esac
+-  else
+-    cat confdefs.h - <<_ACEOF >conftest.$ac_ext
+-/* end confdefs.h.  */
+-$4
+-static long int longval () { return $2; }
+-static unsigned long int ulongval () { return $2; }
+-#include <stdio.h>
+-#include <stdlib.h>
+-int
+-main ()
+-{
+-
+-  FILE *f = fopen ("conftest.val", "w");
+-  if (! f)
+-    return 1;
+-  if (($2) < 0)
+-    {
+-      long int i = longval ();
+-      if (i != ($2))
+-	return 1;
+-      fprintf (f, "%ld", i);
+-    }
+-  else
+-    {
+-      unsigned long int i = ulongval ();
+-      if (i != ($2))
+-	return 1;
+-      fprintf (f, "%lu", i);
+-    }
+-  /* Do not output a trailing newline, as this causes \r\n confusion
+-     on some platforms.  */
+-  return ferror (f) || fclose (f) != 0;
+-
+-  ;
+-  return 0;
+-}
+-_ACEOF
+-if ac_fn_c_try_run "$LINENO"; then :
+-  echo >>conftest.val; read $3 <conftest.val; ac_retval=0
+-else
+-  ac_retval=1
+-fi
+-rm -f core *.core core.conftest.* gmon.out bb.out conftest$ac_exeext \
+-  conftest.$ac_objext conftest.beam conftest.$ac_ext
+-rm -f conftest.val
+-
+-  fi
+-  eval $as_lineno_stack; test "x$as_lineno_stack" = x && { as_lineno=; unset as_lineno;}
+-  as_fn_set_status $ac_retval
+-
+-} # ac_fn_c_compute_int
+-
+-# ac_fn_c_check_header_mongrel LINENO HEADER VAR INCLUDES
+-# -------------------------------------------------------
+-# Tests whether HEADER exists, giving a warning if it cannot be compiled using
+-# the include files in INCLUDES and setting the cache variable VAR
+-# accordingly.
+-ac_fn_c_check_header_mongrel ()
+-{
+-  as_lineno=${as_lineno-"$1"} as_lineno_stack=as_lineno_stack=$as_lineno_stack
+-  if { as_var=$3; eval "test \"\${$as_var+set}\" = set"; }; then :
+-  { $as_echo "$as_me:${as_lineno-$LINENO}: checking for $2" >&5
+-$as_echo_n "checking for $2... " >&6; }
+-if { as_var=$3; eval "test \"\${$as_var+set}\" = set"; }; then :
+-  $as_echo_n "(cached) " >&6
+-fi
+-eval ac_res=\$$3
+-	       { $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_res" >&5
+-$as_echo "$ac_res" >&6; }
+-else
+-  # Is the header compilable?
+-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking $2 usability" >&5
+-$as_echo_n "checking $2 usability... " >&6; }
+-cat confdefs.h - <<_ACEOF >conftest.$ac_ext
+-/* end confdefs.h.  */
+-$4
+-#include <$2>
+-_ACEOF
+-if ac_fn_c_try_compile "$LINENO"; then :
+-  ac_header_compiler=yes
+-else
+-  ac_header_compiler=no
+-fi
+-rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
+-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_header_compiler" >&5
+-$as_echo "$ac_header_compiler" >&6; }
+-
+-# Is the header present?
+-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking $2 presence" >&5
+-$as_echo_n "checking $2 presence... " >&6; }
+-cat confdefs.h - <<_ACEOF >conftest.$ac_ext
+-/* end confdefs.h.  */
+-#include <$2>
+-_ACEOF
+-if ac_fn_c_try_cpp "$LINENO"; then :
+-  ac_header_preproc=yes
+-else
+-  ac_header_preproc=no
+-fi
+-rm -f conftest.err conftest.$ac_ext
+-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_header_preproc" >&5
+-$as_echo "$ac_header_preproc" >&6; }
+-
+-# So?  What about this header?
+-case $ac_header_compiler:$ac_header_preproc:$ac_c_preproc_warn_flag in #((
+-  yes:no: )
+-    { $as_echo "$as_me:${as_lineno-$LINENO}: WARNING: $2: accepted by the compiler, rejected by the preprocessor!" >&5
+-$as_echo "$as_me: WARNING: $2: accepted by the compiler, rejected by the preprocessor!" >&2;}
+-    { $as_echo "$as_me:${as_lineno-$LINENO}: WARNING: $2: proceeding with the compiler's result" >&5
+-$as_echo "$as_me: WARNING: $2: proceeding with the compiler's result" >&2;}
+-    ;;
+-  no:yes:* )
+-    { $as_echo "$as_me:${as_lineno-$LINENO}: WARNING: $2: present but cannot be compiled" >&5
+-$as_echo "$as_me: WARNING: $2: present but cannot be compiled" >&2;}
+-    { $as_echo "$as_me:${as_lineno-$LINENO}: WARNING: $2:     check for missing prerequisite headers?" >&5
+-$as_echo "$as_me: WARNING: $2:     check for missing prerequisite headers?" >&2;}
+-    { $as_echo "$as_me:${as_lineno-$LINENO}: WARNING: $2: see the Autoconf documentation" >&5
+-$as_echo "$as_me: WARNING: $2: see the Autoconf documentation" >&2;}
+-    { $as_echo "$as_me:${as_lineno-$LINENO}: WARNING: $2:     section \"Present But Cannot Be Compiled\"" >&5
+-$as_echo "$as_me: WARNING: $2:     section \"Present But Cannot Be Compiled\"" >&2;}
+-    { $as_echo "$as_me:${as_lineno-$LINENO}: WARNING: $2: proceeding with the compiler's result" >&5
+-$as_echo "$as_me: WARNING: $2: proceeding with the compiler's result" >&2;}
+-    ;;
+-esac
+-  { $as_echo "$as_me:${as_lineno-$LINENO}: checking for $2" >&5
+-$as_echo_n "checking for $2... " >&6; }
+-if { as_var=$3; eval "test \"\${$as_var+set}\" = set"; }; then :
+-  $as_echo_n "(cached) " >&6
+-else
+-  eval "$3=\$ac_header_compiler"
+-fi
+-eval ac_res=\$$3
+-	       { $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_res" >&5
+-$as_echo "$ac_res" >&6; }
+-fi
+-  eval $as_lineno_stack; test "x$as_lineno_stack" = x && { as_lineno=; unset as_lineno;}
+-
+-} # ac_fn_c_check_header_mongrel
+-
+-# ac_fn_c_check_func LINENO FUNC VAR
+-# ----------------------------------
+-# Tests whether FUNC exists, setting the cache variable VAR accordingly
+-ac_fn_c_check_func ()
+-{
+-  as_lineno=${as_lineno-"$1"} as_lineno_stack=as_lineno_stack=$as_lineno_stack
+-  { $as_echo "$as_me:${as_lineno-$LINENO}: checking for $2" >&5
+-$as_echo_n "checking for $2... " >&6; }
+-if { as_var=$3; eval "test \"\${$as_var+set}\" = set"; }; then :
+-  $as_echo_n "(cached) " >&6
+-else
+-  cat confdefs.h - <<_ACEOF >conftest.$ac_ext
+-/* end confdefs.h.  */
+-/* Define $2 to an innocuous variant, in case <limits.h> declares $2.
+-   For example, HP-UX 11i <limits.h> declares gettimeofday.  */
+-#define $2 innocuous_$2
+-
+-/* System header to define __stub macros and hopefully few prototypes,
+-    which can conflict with char $2 (); below.
+-    Prefer <limits.h> to <assert.h> if __STDC__ is defined, since
+-    <limits.h> exists even on freestanding compilers.  */
+-
+-#ifdef __STDC__
+-# include <limits.h>
+-#else
+-# include <assert.h>
+-#endif
+-
+-#undef $2
+-
+-/* Override any GCC internal prototype to avoid an error.
+-   Use char because int might match the return type of a GCC
+-   builtin and then its argument prototype would still apply.  */
+-#ifdef __cplusplus
+-extern "C"
+-#endif
+-char $2 ();
+-/* The GNU C library defines this for functions which it implements
+-    to always fail with ENOSYS.  Some functions are actually named
+-    something starting with __ and the normal name is an alias.  */
+-#if defined __stub_$2 || defined __stub___$2
+-choke me
+-#endif
+-
+-int
+-main ()
+-{
+-return $2 ();
+-  ;
+-  return 0;
+-}
+-_ACEOF
+-if ac_fn_c_try_link "$LINENO"; then :
+-  eval "$3=yes"
+-else
+-  eval "$3=no"
+-fi
+-rm -f core conftest.err conftest.$ac_objext \
+-    conftest$ac_exeext conftest.$ac_ext
+-fi
+-eval ac_res=\$$3
+-	       { $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_res" >&5
+-$as_echo "$ac_res" >&6; }
+-  eval $as_lineno_stack; test "x$as_lineno_stack" = x && { as_lineno=; unset as_lineno;}
+-
+-} # ac_fn_c_check_func
+-cat >config.log <<_ACEOF
+-This file contains any messages produced by compilers while
+-running configure, to aid debugging if configure makes a mistake.
+-
+-It was created by dosbox $as_me 0.74, which was
+-generated by GNU Autoconf 2.65.  Invocation command line was
+-
+-  $ $0 $@
+-
+-_ACEOF
+-exec 5>>config.log
+-{
+-cat <<_ASUNAME
+-## --------- ##
+-## Platform. ##
+-## --------- ##
+-
+-hostname = `(hostname || uname -n) 2>/dev/null | sed 1q`
+-uname -m = `(uname -m) 2>/dev/null || echo unknown`
+-uname -r = `(uname -r) 2>/dev/null || echo unknown`
+-uname -s = `(uname -s) 2>/dev/null || echo unknown`
+-uname -v = `(uname -v) 2>/dev/null || echo unknown`
+-
+-/usr/bin/uname -p = `(/usr/bin/uname -p) 2>/dev/null || echo unknown`
+-/bin/uname -X     = `(/bin/uname -X) 2>/dev/null     || echo unknown`
+-
+-/bin/arch              = `(/bin/arch) 2>/dev/null              || echo unknown`
+-/usr/bin/arch -k       = `(/usr/bin/arch -k) 2>/dev/null       || echo unknown`
+-/usr/convex/getsysinfo = `(/usr/convex/getsysinfo) 2>/dev/null || echo unknown`
+-/usr/bin/hostinfo      = `(/usr/bin/hostinfo) 2>/dev/null      || echo unknown`
+-/bin/machine           = `(/bin/machine) 2>/dev/null           || echo unknown`
+-/usr/bin/oslevel       = `(/usr/bin/oslevel) 2>/dev/null       || echo unknown`
+-/bin/universe          = `(/bin/universe) 2>/dev/null          || echo unknown`
+-
+-_ASUNAME
+-
+-as_save_IFS=$IFS; IFS=$PATH_SEPARATOR
+-for as_dir in $PATH
+-do
+-  IFS=$as_save_IFS
+-  test -z "$as_dir" && as_dir=.
+-    $as_echo "PATH: $as_dir"
+-  done
+-IFS=$as_save_IFS
+-
+-} >&5
+-
+-cat >&5 <<_ACEOF
+-
+-
+-## ----------- ##
+-## Core tests. ##
+-## ----------- ##
+-
+-_ACEOF
+-
+-
+-# Keep a trace of the command line.
+-# Strip out --no-create and --no-recursion so they do not pile up.
+-# Strip out --silent because we don't want to record it for future runs.
+-# Also quote any args containing shell meta-characters.
+-# Make two passes to allow for proper duplicate-argument suppression.
+-ac_configure_args=
+-ac_configure_args0=
+-ac_configure_args1=
+-ac_must_keep_next=false
+-for ac_pass in 1 2
+-do
+-  for ac_arg
+-  do
+-    case $ac_arg in
+-    -no-create | --no-c* | -n | -no-recursion | --no-r*) continue ;;
+-    -q | -quiet | --quiet | --quie | --qui | --qu | --q \
+-    | -silent | --silent | --silen | --sile | --sil)
+-      continue ;;
+-    *\'*)
+-      ac_arg=`$as_echo "$ac_arg" | sed "s/'/'\\\\\\\\''/g"` ;;
+-    esac
+-    case $ac_pass in
+-    1) as_fn_append ac_configure_args0 " '$ac_arg'" ;;
+-    2)
+-      as_fn_append ac_configure_args1 " '$ac_arg'"
+-      if test $ac_must_keep_next = true; then
+-	ac_must_keep_next=false # Got value, back to normal.
+-      else
+-	case $ac_arg in
+-	  *=* | --config-cache | -C | -disable-* | --disable-* \
+-	  | -enable-* | --enable-* | -gas | --g* | -nfp | --nf* \
+-	  | -q | -quiet | --q* | -silent | --sil* | -v | -verb* \
+-	  | -with-* | --with-* | -without-* | --without-* | --x)
+-	    case "$ac_configure_args0 " in
+-	      "$ac_configure_args1"*" '$ac_arg' "* ) continue ;;
+-	    esac
+-	    ;;
+-	  -* ) ac_must_keep_next=true ;;
+-	esac
+-      fi
+-      as_fn_append ac_configure_args " '$ac_arg'"
+-      ;;
+-    esac
+-  done
+-done
+-{ ac_configure_args0=; unset ac_configure_args0;}
+-{ ac_configure_args1=; unset ac_configure_args1;}
+-
+-# When interrupted or exit'd, cleanup temporary files, and complete
+-# config.log.  We remove comments because anyway the quotes in there
+-# would cause problems or look ugly.
+-# WARNING: Use '\'' to represent an apostrophe within the trap.
+-# WARNING: Do not start the trap code with a newline, due to a FreeBSD 4.0 bug.
+-trap 'exit_status=$?
+-  # Save into config.log some information that might help in debugging.
+-  {
+-    echo
+-
+-    cat <<\_ASBOX
+-## ---------------- ##
+-## Cache variables. ##
+-## ---------------- ##
+-_ASBOX
+-    echo
+-    # The following way of writing the cache mishandles newlines in values,
+-(
+-  for ac_var in `(set) 2>&1 | sed -n '\''s/^\([a-zA-Z_][a-zA-Z0-9_]*\)=.*/\1/p'\''`; do
+-    eval ac_val=\$$ac_var
+-    case $ac_val in #(
+-    *${as_nl}*)
+-      case $ac_var in #(
+-      *_cv_*) { $as_echo "$as_me:${as_lineno-$LINENO}: WARNING: cache variable $ac_var contains a newline" >&5
+-$as_echo "$as_me: WARNING: cache variable $ac_var contains a newline" >&2;} ;;
+-      esac
+-      case $ac_var in #(
+-      _ | IFS | as_nl) ;; #(
+-      BASH_ARGV | BASH_SOURCE) eval $ac_var= ;; #(
+-      *) { eval $ac_var=; unset $ac_var;} ;;
+-      esac ;;
+-    esac
+-  done
+-  (set) 2>&1 |
+-    case $as_nl`(ac_space='\'' '\''; set) 2>&1` in #(
+-    *${as_nl}ac_space=\ *)
+-      sed -n \
+-	"s/'\''/'\''\\\\'\'''\''/g;
+-	  s/^\\([_$as_cr_alnum]*_cv_[_$as_cr_alnum]*\\)=\\(.*\\)/\\1='\''\\2'\''/p"
+-      ;; #(
+-    *)
+-      sed -n "/^[_$as_cr_alnum]*_cv_[_$as_cr_alnum]*=/p"
+-      ;;
+-    esac |
+-    sort
+-)
+-    echo
+-
+-    cat <<\_ASBOX
+-## ----------------- ##
+-## Output variables. ##
+-## ----------------- ##
+-_ASBOX
+-    echo
+-    for ac_var in $ac_subst_vars
+-    do
+-      eval ac_val=\$$ac_var
+-      case $ac_val in
+-      *\'\''*) ac_val=`$as_echo "$ac_val" | sed "s/'\''/'\''\\\\\\\\'\'''\''/g"`;;
+-      esac
+-      $as_echo "$ac_var='\''$ac_val'\''"
+-    done | sort
+-    echo
+-
+-    if test -n "$ac_subst_files"; then
+-      cat <<\_ASBOX
+-## ------------------- ##
+-## File substitutions. ##
+-## ------------------- ##
+-_ASBOX
+-      echo
+-      for ac_var in $ac_subst_files
+-      do
+-	eval ac_val=\$$ac_var
+-	case $ac_val in
+-	*\'\''*) ac_val=`$as_echo "$ac_val" | sed "s/'\''/'\''\\\\\\\\'\'''\''/g"`;;
+-	esac
+-	$as_echo "$ac_var='\''$ac_val'\''"
+-      done | sort
+-      echo
+-    fi
+-
+-    if test -s confdefs.h; then
+-      cat <<\_ASBOX
+-## ----------- ##
+-## confdefs.h. ##
+-## ----------- ##
+-_ASBOX
+-      echo
+-      cat confdefs.h
+-      echo
+-    fi
+-    test "$ac_signal" != 0 &&
+-      $as_echo "$as_me: caught signal $ac_signal"
+-    $as_echo "$as_me: exit $exit_status"
+-  } >&5
+-  rm -f core *.core core.conftest.* &&
+-    rm -f -r conftest* confdefs* conf$$* $ac_clean_files &&
+-    exit $exit_status
+-' 0
+-for ac_signal in 1 2 13 15; do
+-  trap 'ac_signal='$ac_signal'; as_fn_exit 1' $ac_signal
+-done
+-ac_signal=0
+-
+-# confdefs.h avoids OS command line length limits that DEFS can exceed.
+-rm -f -r conftest* confdefs.h
+-
+-$as_echo "/* confdefs.h */" > confdefs.h
+-
+-# Predefined preprocessor variables.
+-
+-cat >>confdefs.h <<_ACEOF
+-#define PACKAGE_NAME "$PACKAGE_NAME"
+-_ACEOF
+-
+-cat >>confdefs.h <<_ACEOF
+-#define PACKAGE_TARNAME "$PACKAGE_TARNAME"
+-_ACEOF
+-
+-cat >>confdefs.h <<_ACEOF
+-#define PACKAGE_VERSION "$PACKAGE_VERSION"
+-_ACEOF
+-
+-cat >>confdefs.h <<_ACEOF
+-#define PACKAGE_STRING "$PACKAGE_STRING"
+-_ACEOF
+-
+-cat >>confdefs.h <<_ACEOF
+-#define PACKAGE_BUGREPORT "$PACKAGE_BUGREPORT"
+-_ACEOF
+-
+-cat >>confdefs.h <<_ACEOF
+-#define PACKAGE_URL "$PACKAGE_URL"
+-_ACEOF
+-
+-
+-# Let the site file select an alternate cache file if it wants to.
+-# Prefer an explicitly selected file to automatically selected ones.
+-ac_site_file1=NONE
+-ac_site_file2=NONE
+-if test -n "$CONFIG_SITE"; then
+-  ac_site_file1=$CONFIG_SITE
+-elif test "x$prefix" != xNONE; then
+-  ac_site_file1=$prefix/share/config.site
+-  ac_site_file2=$prefix/etc/config.site
+-else
+-  ac_site_file1=$ac_default_prefix/share/config.site
+-  ac_site_file2=$ac_default_prefix/etc/config.site
+-fi
+-for ac_site_file in "$ac_site_file1" "$ac_site_file2"
+-do
+-  test "x$ac_site_file" = xNONE && continue
+-  if test /dev/null != "$ac_site_file" && test -r "$ac_site_file"; then
+-    { $as_echo "$as_me:${as_lineno-$LINENO}: loading site script $ac_site_file" >&5
+-$as_echo "$as_me: loading site script $ac_site_file" >&6;}
+-    sed 's/^/| /' "$ac_site_file" >&5
+-    . "$ac_site_file"
+-  fi
+-done
+-
+-if test -r "$cache_file"; then
+-  # Some versions of bash will fail to source /dev/null (special files
+-  # actually), so we avoid doing that.  DJGPP emulates it as a regular file.
+-  if test /dev/null != "$cache_file" && test -f "$cache_file"; then
+-    { $as_echo "$as_me:${as_lineno-$LINENO}: loading cache $cache_file" >&5
+-$as_echo "$as_me: loading cache $cache_file" >&6;}
+-    case $cache_file in
+-      [\\/]* | ?:[\\/]* ) . "$cache_file";;
+-      *)                      . "./$cache_file";;
+-    esac
+-  fi
+-else
+-  { $as_echo "$as_me:${as_lineno-$LINENO}: creating cache $cache_file" >&5
+-$as_echo "$as_me: creating cache $cache_file" >&6;}
+-  >$cache_file
+-fi
+-
+-# Check that the precious variables saved in the cache have kept the same
+-# value.
+-ac_cache_corrupted=false
+-for ac_var in $ac_precious_vars; do
+-  eval ac_old_set=\$ac_cv_env_${ac_var}_set
+-  eval ac_new_set=\$ac_env_${ac_var}_set
+-  eval ac_old_val=\$ac_cv_env_${ac_var}_value
+-  eval ac_new_val=\$ac_env_${ac_var}_value
+-  case $ac_old_set,$ac_new_set in
+-    set,)
+-      { $as_echo "$as_me:${as_lineno-$LINENO}: error: \`$ac_var' was set to \`$ac_old_val' in the previous run" >&5
+-$as_echo "$as_me: error: \`$ac_var' was set to \`$ac_old_val' in the previous run" >&2;}
+-      ac_cache_corrupted=: ;;
+-    ,set)
+-      { $as_echo "$as_me:${as_lineno-$LINENO}: error: \`$ac_var' was not set in the previous run" >&5
+-$as_echo "$as_me: error: \`$ac_var' was not set in the previous run" >&2;}
+-      ac_cache_corrupted=: ;;
+-    ,);;
+-    *)
+-      if test "x$ac_old_val" != "x$ac_new_val"; then
+-	# differences in whitespace do not lead to failure.
+-	ac_old_val_w=`echo x $ac_old_val`
+-	ac_new_val_w=`echo x $ac_new_val`
+-	if test "$ac_old_val_w" != "$ac_new_val_w"; then
+-	  { $as_echo "$as_me:${as_lineno-$LINENO}: error: \`$ac_var' has changed since the previous run:" >&5
+-$as_echo "$as_me: error: \`$ac_var' has changed since the previous run:" >&2;}
+-	  ac_cache_corrupted=:
+-	else
+-	  { $as_echo "$as_me:${as_lineno-$LINENO}: warning: ignoring whitespace changes in \`$ac_var' since the previous run:" >&5
+-$as_echo "$as_me: warning: ignoring whitespace changes in \`$ac_var' since the previous run:" >&2;}
+-	  eval $ac_var=\$ac_old_val
+-	fi
+-	{ $as_echo "$as_me:${as_lineno-$LINENO}:   former value:  \`$ac_old_val'" >&5
+-$as_echo "$as_me:   former value:  \`$ac_old_val'" >&2;}
+-	{ $as_echo "$as_me:${as_lineno-$LINENO}:   current value: \`$ac_new_val'" >&5
+-$as_echo "$as_me:   current value: \`$ac_new_val'" >&2;}
+-      fi;;
+-  esac
+-  # Pass precious variables to config.status.
+-  if test "$ac_new_set" = set; then
+-    case $ac_new_val in
+-    *\'*) ac_arg=$ac_var=`$as_echo "$ac_new_val" | sed "s/'/'\\\\\\\\''/g"` ;;
+-    *) ac_arg=$ac_var=$ac_new_val ;;
+-    esac
+-    case " $ac_configure_args " in
+-      *" '$ac_arg' "*) ;; # Avoid dups.  Use of quotes ensures accuracy.
+-      *) as_fn_append ac_configure_args " '$ac_arg'" ;;
+-    esac
+-  fi
+-done
+-if $ac_cache_corrupted; then
+-  { $as_echo "$as_me:${as_lineno-$LINENO}: error: in \`$ac_pwd':" >&5
+-$as_echo "$as_me: error: in \`$ac_pwd':" >&2;}
+-  { $as_echo "$as_me:${as_lineno-$LINENO}: error: changes in the environment can compromise the build" >&5
+-$as_echo "$as_me: error: changes in the environment can compromise the build" >&2;}
+-  as_fn_error "run \`make distclean' and/or \`rm $cache_file' and start over" "$LINENO" 5
+-fi
+-## -------------------- ##
+-## Main body of script. ##
+-## -------------------- ##
+-
+-ac_ext=c
+-ac_cpp='$CPP $CPPFLAGS'
+-ac_compile='$CC -c $CFLAGS $CPPFLAGS conftest.$ac_ext >&5'
+-ac_link='$CC -o conftest$ac_exeext $CFLAGS $CPPFLAGS $LDFLAGS conftest.$ac_ext $LIBS >&5'
+-ac_compiler_gnu=$ac_cv_c_compiler_gnu
+-
+-
+-
+-
+-
+-ac_aux_dir=
+-for ac_dir in "$srcdir" "$srcdir/.." "$srcdir/../.."; do
+-  for ac_t in install-sh install.sh shtool; do
+-    if test -f "$ac_dir/$ac_t"; then
+-      ac_aux_dir=$ac_dir
+-      ac_install_sh="$ac_aux_dir/$ac_t -c"
+-      break 2
+-    fi
+-  done
+-done
+-if test -z "$ac_aux_dir"; then
+-  as_fn_error "cannot find install-sh, install.sh, or shtool in \"$srcdir\" \"$srcdir/..\" \"$srcdir/../..\"" "$LINENO" 5
+-fi
+-
+-# These three variables are undocumented and unsupported,
+-# and are intended to be withdrawn in a future Autoconf release.
+-# They can cause serious problems if a builder's source tree is in a directory
+-# whose full name contains unusual characters.
+-ac_config_guess="$SHELL $ac_aux_dir/config.guess"  # Please don't use this var.
+-ac_config_sub="$SHELL $ac_aux_dir/config.sub"  # Please don't use this var.
+-ac_configure="$SHELL $ac_aux_dir/configure"  # Please don't use this var.
+-
+-
+-# Make sure we can run config.sub.
+-$SHELL "$ac_aux_dir/config.sub" sun4 >/dev/null 2>&1 ||
+-  as_fn_error "cannot run $SHELL $ac_aux_dir/config.sub" "$LINENO" 5
+-
+-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking build system type" >&5
+-$as_echo_n "checking build system type... " >&6; }
+-if test "${ac_cv_build+set}" = set; then :
+-  $as_echo_n "(cached) " >&6
+-else
+-  ac_build_alias=$build_alias
+-test "x$ac_build_alias" = x &&
+-  ac_build_alias=`$SHELL "$ac_aux_dir/config.guess"`
+-test "x$ac_build_alias" = x &&
+-  as_fn_error "cannot guess build type; you must specify one" "$LINENO" 5
+-ac_cv_build=`$SHELL "$ac_aux_dir/config.sub" $ac_build_alias` ||
+-  as_fn_error "$SHELL $ac_aux_dir/config.sub $ac_build_alias failed" "$LINENO" 5
+-
+-fi
+-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_build" >&5
+-$as_echo "$ac_cv_build" >&6; }
+-case $ac_cv_build in
+-*-*-*) ;;
+-*) as_fn_error "invalid value of canonical build" "$LINENO" 5;;
+-esac
+-build=$ac_cv_build
+-ac_save_IFS=$IFS; IFS='-'
+-set x $ac_cv_build
+-shift
+-build_cpu=$1
+-build_vendor=$2
+-shift; shift
+-# Remember, the first character of IFS is used to create $*,
+-# except with old shells:
+-build_os=$*
+-IFS=$ac_save_IFS
+-case $build_os in *\ *) build_os=`echo "$build_os" | sed 's/ /-/g'`;; esac
+-
+-
+-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking host system type" >&5
+-$as_echo_n "checking host system type... " >&6; }
+-if test "${ac_cv_host+set}" = set; then :
+-  $as_echo_n "(cached) " >&6
+-else
+-  if test "x$host_alias" = x; then
+-  ac_cv_host=$ac_cv_build
+-else
+-  ac_cv_host=`$SHELL "$ac_aux_dir/config.sub" $host_alias` ||
+-    as_fn_error "$SHELL $ac_aux_dir/config.sub $host_alias failed" "$LINENO" 5
+-fi
+-
+-fi
+-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_host" >&5
+-$as_echo "$ac_cv_host" >&6; }
+-case $ac_cv_host in
+-*-*-*) ;;
+-*) as_fn_error "invalid value of canonical host" "$LINENO" 5;;
+-esac
+-host=$ac_cv_host
+-ac_save_IFS=$IFS; IFS='-'
+-set x $ac_cv_host
+-shift
+-host_cpu=$1
+-host_vendor=$2
+-shift; shift
+-# Remember, the first character of IFS is used to create $*,
+-# except with old shells:
+-host_os=$*
+-IFS=$ac_save_IFS
+-case $host_os in *\ *) host_os=`echo "$host_os" | sed 's/ /-/g'`;; esac
+-
+-
+-
+-
+-am__api_version='1.11'
+-
+-# Find a good install program.  We prefer a C program (faster),
+-# so one script is as good as another.  But avoid the broken or
+-# incompatible versions:
+-# SysV /etc/install, /usr/sbin/install
+-# SunOS /usr/etc/install
+-# IRIX /sbin/install
+-# AIX /bin/install
+-# AmigaOS /C/install, which installs bootblocks on floppy discs
+-# AIX 4 /usr/bin/installbsd, which doesn't work without a -g flag
+-# AFS /usr/afsws/bin/install, which mishandles nonexistent args
+-# SVR4 /usr/ucb/install, which tries to use the nonexistent group "staff"
+-# OS/2's system install, which has a completely different semantic
+-# ./install, which can be erroneously created by make from ./install.sh.
+-# Reject install programs that cannot install multiple files.
+-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for a BSD-compatible install" >&5
+-$as_echo_n "checking for a BSD-compatible install... " >&6; }
+-if test -z "$INSTALL"; then
+-if test "${ac_cv_path_install+set}" = set; then :
+-  $as_echo_n "(cached) " >&6
+-else
+-  as_save_IFS=$IFS; IFS=$PATH_SEPARATOR
+-for as_dir in $PATH
+-do
+-  IFS=$as_save_IFS
+-  test -z "$as_dir" && as_dir=.
+-    # Account for people who put trailing slashes in PATH elements.
+-case $as_dir/ in #((
+-  ./ | .// | /[cC]/* | \
+-  /etc/* | /usr/sbin/* | /usr/etc/* | /sbin/* | /usr/afsws/bin/* | \
+-  ?:[\\/]os2[\\/]install[\\/]* | ?:[\\/]OS2[\\/]INSTALL[\\/]* | \
+-  /usr/ucb/* ) ;;
+-  *)
+-    # OSF1 and SCO ODT 3.0 have their own names for install.
+-    # Don't use installbsd from OSF since it installs stuff as root
+-    # by default.
+-    for ac_prog in ginstall scoinst install; do
+-      for ac_exec_ext in '' $ac_executable_extensions; do
+-	if { test -f "$as_dir/$ac_prog$ac_exec_ext" && $as_test_x "$as_dir/$ac_prog$ac_exec_ext"; }; then
+-	  if test $ac_prog = install &&
+-	    grep dspmsg "$as_dir/$ac_prog$ac_exec_ext" >/dev/null 2>&1; then
+-	    # AIX install.  It has an incompatible calling convention.
+-	    :
+-	  elif test $ac_prog = install &&
+-	    grep pwplus "$as_dir/$ac_prog$ac_exec_ext" >/dev/null 2>&1; then
+-	    # program-specific install script used by HP pwplus--don't use.
+-	    :
+-	  else
+-	    rm -rf conftest.one conftest.two conftest.dir
+-	    echo one > conftest.one
+-	    echo two > conftest.two
+-	    mkdir conftest.dir
+-	    if "$as_dir/$ac_prog$ac_exec_ext" -c conftest.one conftest.two "`pwd`/conftest.dir" &&
+-	      test -s conftest.one && test -s conftest.two &&
+-	      test -s conftest.dir/conftest.one &&
+-	      test -s conftest.dir/conftest.two
+-	    then
+-	      ac_cv_path_install="$as_dir/$ac_prog$ac_exec_ext -c"
+-	      break 3
+-	    fi
+-	  fi
+-	fi
+-      done
+-    done
+-    ;;
+-esac
+-
+-  done
+-IFS=$as_save_IFS
+-
+-rm -rf conftest.one conftest.two conftest.dir
+-
+-fi
+-  if test "${ac_cv_path_install+set}" = set; then
+-    INSTALL=$ac_cv_path_install
+-  else
+-    # As a last resort, use the slow shell script.  Don't cache a
+-    # value for INSTALL within a source directory, because that will
+-    # break other packages using the cache if that directory is
+-    # removed, or if the value is a relative name.
+-    INSTALL=$ac_install_sh
+-  fi
+-fi
+-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $INSTALL" >&5
+-$as_echo "$INSTALL" >&6; }
+-
+-# Use test -z because SunOS4 sh mishandles braces in ${var-val}.
+-# It thinks the first close brace ends the variable substitution.
+-test -z "$INSTALL_PROGRAM" && INSTALL_PROGRAM='${INSTALL}'
+-
+-test -z "$INSTALL_SCRIPT" && INSTALL_SCRIPT='${INSTALL}'
+-
+-test -z "$INSTALL_DATA" && INSTALL_DATA='${INSTALL} -m 644'
+-
+-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking whether build environment is sane" >&5
+-$as_echo_n "checking whether build environment is sane... " >&6; }
+-# Just in case
+-sleep 1
+-echo timestamp > conftest.file
+-# Reject unsafe characters in $srcdir or the absolute working directory
+-# name.  Accept space and tab only in the latter.
+-am_lf='
+-'
+-case `pwd` in
+-  *[\\\"\#\$\&\'\`$am_lf]*)
+-    as_fn_error "unsafe absolute working directory name" "$LINENO" 5;;
+-esac
+-case $srcdir in
+-  *[\\\"\#\$\&\'\`$am_lf\ \	]*)
+-    as_fn_error "unsafe srcdir value: \`$srcdir'" "$LINENO" 5;;
+-esac
+-
+-# Do `set' in a subshell so we don't clobber the current shell's
+-# arguments.  Must try -L first in case configure is actually a
+-# symlink; some systems play weird games with the mod time of symlinks
+-# (eg FreeBSD returns the mod time of the symlink's containing
+-# directory).
+-if (
+-   set X `ls -Lt "$srcdir/configure" conftest.file 2> /dev/null`
+-   if test "$*" = "X"; then
+-      # -L didn't work.
+-      set X `ls -t "$srcdir/configure" conftest.file`
+-   fi
+-   rm -f conftest.file
+-   if test "$*" != "X $srcdir/configure conftest.file" \
+-      && test "$*" != "X conftest.file $srcdir/configure"; then
+-
+-      # If neither matched, then we have a broken ls.  This can happen
+-      # if, for instance, CONFIG_SHELL is bash and it inherits a
+-      # broken ls alias from the environment.  This has actually
+-      # happened.  Such a system could not be considered "sane".
+-      as_fn_error "ls -t appears to fail.  Make sure there is not a broken
+-alias in your environment" "$LINENO" 5
+-   fi
+-
+-   test "$2" = conftest.file
+-   )
+-then
+-   # Ok.
+-   :
+-else
+-   as_fn_error "newly created file is older than distributed files!
+-Check your system clock" "$LINENO" 5
+-fi
+-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: yes" >&5
+-$as_echo "yes" >&6; }
+-test "$program_prefix" != NONE &&
+-  program_transform_name="s&^&$program_prefix&;$program_transform_name"
+-# Use a double $ so make ignores it.
+-test "$program_suffix" != NONE &&
+-  program_transform_name="s&\$&$program_suffix&;$program_transform_name"
+-# Double any \ or $.
+-# By default was `s,x,x', remove it if useless.
+-ac_script='s/[\\$]/&&/g;s/;s,x,x,$//'
+-program_transform_name=`$as_echo "$program_transform_name" | sed "$ac_script"`
+-
+-# expand $ac_aux_dir to an absolute path
+-am_aux_dir=`cd $ac_aux_dir && pwd`
+-
+-if test x"${MISSING+set}" != xset; then
+-  case $am_aux_dir in
+-  *\ * | *\	*)
+-    MISSING="\${SHELL} \"$am_aux_dir/missing\"" ;;
+-  *)
+-    MISSING="\${SHELL} $am_aux_dir/missing" ;;
+-  esac
+-fi
+-# Use eval to expand $SHELL
+-if eval "$MISSING --run true"; then
+-  am_missing_run="$MISSING --run "
+-else
+-  am_missing_run=
+-  { $as_echo "$as_me:${as_lineno-$LINENO}: WARNING: \`missing' script is too old or missing" >&5
+-$as_echo "$as_me: WARNING: \`missing' script is too old or missing" >&2;}
+-fi
+-
+-if test x"${install_sh}" != xset; then
+-  case $am_aux_dir in
+-  *\ * | *\	*)
+-    install_sh="\${SHELL} '$am_aux_dir/install-sh'" ;;
+-  *)
+-    install_sh="\${SHELL} $am_aux_dir/install-sh"
+-  esac
+-fi
+-
+-# Installed binaries are usually stripped using `strip' when the user
+-# run `make install-strip'.  However `strip' might not be the right
+-# tool to use in cross-compilation environments, therefore Automake
+-# will honor the `STRIP' environment variable to overrule this program.
+-if test "$cross_compiling" != no; then
+-  if test -n "$ac_tool_prefix"; then
+-  # Extract the first word of "${ac_tool_prefix}strip", so it can be a program name with args.
+-set dummy ${ac_tool_prefix}strip; ac_word=$2
+-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for $ac_word" >&5
+-$as_echo_n "checking for $ac_word... " >&6; }
+-if test "${ac_cv_prog_STRIP+set}" = set; then :
+-  $as_echo_n "(cached) " >&6
+-else
+-  if test -n "$STRIP"; then
+-  ac_cv_prog_STRIP="$STRIP" # Let the user override the test.
+-else
+-as_save_IFS=$IFS; IFS=$PATH_SEPARATOR
+-for as_dir in $PATH
+-do
+-  IFS=$as_save_IFS
+-  test -z "$as_dir" && as_dir=.
+-    for ac_exec_ext in '' $ac_executable_extensions; do
+-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
+-    ac_cv_prog_STRIP="${ac_tool_prefix}strip"
+-    $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
+-    break 2
+-  fi
+-done
+-  done
+-IFS=$as_save_IFS
+-
+-fi
+-fi
+-STRIP=$ac_cv_prog_STRIP
+-if test -n "$STRIP"; then
+-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: $STRIP" >&5
+-$as_echo "$STRIP" >&6; }
+-else
+-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
+-$as_echo "no" >&6; }
+-fi
+-
+-
+-fi
+-if test -z "$ac_cv_prog_STRIP"; then
+-  ac_ct_STRIP=$STRIP
+-  # Extract the first word of "strip", so it can be a program name with args.
+-set dummy strip; ac_word=$2
+-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for $ac_word" >&5
+-$as_echo_n "checking for $ac_word... " >&6; }
+-if test "${ac_cv_prog_ac_ct_STRIP+set}" = set; then :
+-  $as_echo_n "(cached) " >&6
+-else
+-  if test -n "$ac_ct_STRIP"; then
+-  ac_cv_prog_ac_ct_STRIP="$ac_ct_STRIP" # Let the user override the test.
+-else
+-as_save_IFS=$IFS; IFS=$PATH_SEPARATOR
+-for as_dir in $PATH
+-do
+-  IFS=$as_save_IFS
+-  test -z "$as_dir" && as_dir=.
+-    for ac_exec_ext in '' $ac_executable_extensions; do
+-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
+-    ac_cv_prog_ac_ct_STRIP="strip"
+-    $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
+-    break 2
+-  fi
+-done
+-  done
+-IFS=$as_save_IFS
+-
+-fi
+-fi
+-ac_ct_STRIP=$ac_cv_prog_ac_ct_STRIP
+-if test -n "$ac_ct_STRIP"; then
+-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_ct_STRIP" >&5
+-$as_echo "$ac_ct_STRIP" >&6; }
+-else
+-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
+-$as_echo "no" >&6; }
+-fi
+-
+-  if test "x$ac_ct_STRIP" = x; then
+-    STRIP=":"
+-  else
+-    case $cross_compiling:$ac_tool_warned in
+-yes:)
+-{ $as_echo "$as_me:${as_lineno-$LINENO}: WARNING: using cross tools not prefixed with host triplet" >&5
+-$as_echo "$as_me: WARNING: using cross tools not prefixed with host triplet" >&2;}
+-ac_tool_warned=yes ;;
+-esac
+-    STRIP=$ac_ct_STRIP
+-  fi
+-else
+-  STRIP="$ac_cv_prog_STRIP"
+-fi
+-
+-fi
+-INSTALL_STRIP_PROGRAM="\$(install_sh) -c -s"
+-
+-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for a thread-safe mkdir -p" >&5
+-$as_echo_n "checking for a thread-safe mkdir -p... " >&6; }
+-if test -z "$MKDIR_P"; then
+-  if test "${ac_cv_path_mkdir+set}" = set; then :
+-  $as_echo_n "(cached) " >&6
+-else
+-  as_save_IFS=$IFS; IFS=$PATH_SEPARATOR
+-for as_dir in $PATH$PATH_SEPARATOR/opt/sfw/bin
+-do
+-  IFS=$as_save_IFS
+-  test -z "$as_dir" && as_dir=.
+-    for ac_prog in mkdir gmkdir; do
+-	 for ac_exec_ext in '' $ac_executable_extensions; do
+-	   { test -f "$as_dir/$ac_prog$ac_exec_ext" && $as_test_x "$as_dir/$ac_prog$ac_exec_ext"; } || continue
+-	   case `"$as_dir/$ac_prog$ac_exec_ext" --version 2>&1` in #(
+-	     'mkdir (GNU coreutils) '* | \
+-	     'mkdir (coreutils) '* | \
+-	     'mkdir (fileutils) '4.1*)
+-	       ac_cv_path_mkdir=$as_dir/$ac_prog$ac_exec_ext
+-	       break 3;;
+-	   esac
+-	 done
+-       done
+-  done
+-IFS=$as_save_IFS
+-
+-fi
+-
+-  test -d ./--version && rmdir ./--version
+-  if test "${ac_cv_path_mkdir+set}" = set; then
+-    MKDIR_P="$ac_cv_path_mkdir -p"
+-  else
+-    # As a last resort, use the slow shell script.  Don't cache a
+-    # value for MKDIR_P within a source directory, because that will
+-    # break other packages using the cache if that directory is
+-    # removed, or if the value is a relative name.
+-    MKDIR_P="$ac_install_sh -d"
+-  fi
+-fi
+-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $MKDIR_P" >&5
+-$as_echo "$MKDIR_P" >&6; }
+-
+-mkdir_p="$MKDIR_P"
+-case $mkdir_p in
+-  [\\/$]* | ?:[\\/]*) ;;
+-  */*) mkdir_p="\$(top_builddir)/$mkdir_p" ;;
+-esac
+-
+-for ac_prog in gawk mawk nawk awk
+-do
+-  # Extract the first word of "$ac_prog", so it can be a program name with args.
+-set dummy $ac_prog; ac_word=$2
+-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for $ac_word" >&5
+-$as_echo_n "checking for $ac_word... " >&6; }
+-if test "${ac_cv_prog_AWK+set}" = set; then :
+-  $as_echo_n "(cached) " >&6
+-else
+-  if test -n "$AWK"; then
+-  ac_cv_prog_AWK="$AWK" # Let the user override the test.
+-else
+-as_save_IFS=$IFS; IFS=$PATH_SEPARATOR
+-for as_dir in $PATH
+-do
+-  IFS=$as_save_IFS
+-  test -z "$as_dir" && as_dir=.
+-    for ac_exec_ext in '' $ac_executable_extensions; do
+-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
+-    ac_cv_prog_AWK="$ac_prog"
+-    $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
+-    break 2
+-  fi
+-done
+-  done
+-IFS=$as_save_IFS
+-
+-fi
+-fi
+-AWK=$ac_cv_prog_AWK
+-if test -n "$AWK"; then
+-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: $AWK" >&5
+-$as_echo "$AWK" >&6; }
+-else
+-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
+-$as_echo "no" >&6; }
+-fi
+-
+-
+-  test -n "$AWK" && break
+-done
+-
+-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking whether ${MAKE-make} sets \$(MAKE)" >&5
+-$as_echo_n "checking whether ${MAKE-make} sets \$(MAKE)... " >&6; }
+-set x ${MAKE-make}
+-ac_make=`$as_echo "$2" | sed 's/+/p/g; s/[^a-zA-Z0-9_]/_/g'`
+-if { as_var=ac_cv_prog_make_${ac_make}_set; eval "test \"\${$as_var+set}\" = set"; }; then :
+-  $as_echo_n "(cached) " >&6
+-else
+-  cat >conftest.make <<\_ACEOF
+-SHELL = /bin/sh
+-all:
+-	@echo '@@@%%%=$(MAKE)=@@@%%%'
+-_ACEOF
+-# GNU make sometimes prints "make[1]: Entering...", which would confuse us.
+-case `${MAKE-make} -f conftest.make 2>/dev/null` in
+-  *@@@%%%=?*=@@@%%%*)
+-    eval ac_cv_prog_make_${ac_make}_set=yes;;
+-  *)
+-    eval ac_cv_prog_make_${ac_make}_set=no;;
+-esac
+-rm -f conftest.make
+-fi
+-if eval test \$ac_cv_prog_make_${ac_make}_set = yes; then
+-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: yes" >&5
+-$as_echo "yes" >&6; }
+-  SET_MAKE=
+-else
+-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
+-$as_echo "no" >&6; }
+-  SET_MAKE="MAKE=${MAKE-make}"
+-fi
+-
+-rm -rf .tst 2>/dev/null
+-mkdir .tst 2>/dev/null
+-if test -d .tst; then
+-  am__leading_dot=.
+-else
+-  am__leading_dot=_
+-fi
+-rmdir .tst 2>/dev/null
+-
+-if test "`cd $srcdir && pwd`" != "`pwd`"; then
+-  # Use -I$(srcdir) only when $(srcdir) != ., so that make's output
+-  # is not polluted with repeated "-I."
+-  am__isrc=' -I$(srcdir)'
+-  # test to see if srcdir already configured
+-  if test -f $srcdir/config.status; then
+-    as_fn_error "source directory already configured; run \"make distclean\" there first" "$LINENO" 5
+-  fi
+-fi
+-
+-# test whether we have cygpath
+-if test -z "$CYGPATH_W"; then
+-  if (cygpath --version) >/dev/null 2>/dev/null; then
+-    CYGPATH_W='cygpath -w'
+-  else
+-    CYGPATH_W=echo
+-  fi
+-fi
+-
+-
+-# Define the identity of the package.
+- PACKAGE='dosbox'
+- VERSION='0.74'
+-
+-
+-cat >>confdefs.h <<_ACEOF
+-#define PACKAGE "$PACKAGE"
+-_ACEOF
+-
+-
+-cat >>confdefs.h <<_ACEOF
+-#define VERSION "$VERSION"
+-_ACEOF
+-
+-# Some tools Automake needs.
+-
+-ACLOCAL=${ACLOCAL-"${am_missing_run}aclocal-${am__api_version}"}
+-
+-
+-AUTOCONF=${AUTOCONF-"${am_missing_run}autoconf"}
+-
+-
+-AUTOMAKE=${AUTOMAKE-"${am_missing_run}automake-${am__api_version}"}
+-
+-
+-AUTOHEADER=${AUTOHEADER-"${am_missing_run}autoheader"}
+-
+-
+-MAKEINFO=${MAKEINFO-"${am_missing_run}makeinfo"}
+-
+-# We need awk for the "check" target.  The system "awk" is bad on
+-# some platforms.
+-# Always define AMTAR for backward compatibility.
+-
+-AMTAR=${AMTAR-"${am_missing_run}tar"}
+-
+-am__tar='${AMTAR} chof - "$$tardir"'; am__untar='${AMTAR} xf -'
+-
+-
+-
+-
+-
+-ac_config_headers="$ac_config_headers config.h"
+-
+-
+-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking whether ${MAKE-make} sets \$(MAKE)" >&5
+-$as_echo_n "checking whether ${MAKE-make} sets \$(MAKE)... " >&6; }
+-set x ${MAKE-make}
+-ac_make=`$as_echo "$2" | sed 's/+/p/g; s/[^a-zA-Z0-9_]/_/g'`
+-if { as_var=ac_cv_prog_make_${ac_make}_set; eval "test \"\${$as_var+set}\" = set"; }; then :
+-  $as_echo_n "(cached) " >&6
+-else
+-  cat >conftest.make <<\_ACEOF
+-SHELL = /bin/sh
+-all:
+-	@echo '@@@%%%=$(MAKE)=@@@%%%'
+-_ACEOF
+-# GNU make sometimes prints "make[1]: Entering...", which would confuse us.
+-case `${MAKE-make} -f conftest.make 2>/dev/null` in
+-  *@@@%%%=?*=@@@%%%*)
+-    eval ac_cv_prog_make_${ac_make}_set=yes;;
+-  *)
+-    eval ac_cv_prog_make_${ac_make}_set=no;;
+-esac
+-rm -f conftest.make
+-fi
+-if eval test \$ac_cv_prog_make_${ac_make}_set = yes; then
+-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: yes" >&5
+-$as_echo "yes" >&6; }
+-  SET_MAKE=
+-else
+-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
+-$as_echo "no" >&6; }
+-  SET_MAKE="MAKE=${MAKE-make}"
+-fi
+-
+-ac_ext=c
+-ac_cpp='$CPP $CPPFLAGS'
+-ac_compile='$CC -c $CFLAGS $CPPFLAGS conftest.$ac_ext >&5'
+-ac_link='$CC -o conftest$ac_exeext $CFLAGS $CPPFLAGS $LDFLAGS conftest.$ac_ext $LIBS >&5'
+-ac_compiler_gnu=$ac_cv_c_compiler_gnu
+-if test -n "$ac_tool_prefix"; then
+-  # Extract the first word of "${ac_tool_prefix}gcc", so it can be a program name with args.
+-set dummy ${ac_tool_prefix}gcc; ac_word=$2
+-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for $ac_word" >&5
+-$as_echo_n "checking for $ac_word... " >&6; }
+-if test "${ac_cv_prog_CC+set}" = set; then :
+-  $as_echo_n "(cached) " >&6
+-else
+-  if test -n "$CC"; then
+-  ac_cv_prog_CC="$CC" # Let the user override the test.
+-else
+-as_save_IFS=$IFS; IFS=$PATH_SEPARATOR
+-for as_dir in $PATH
+-do
+-  IFS=$as_save_IFS
+-  test -z "$as_dir" && as_dir=.
+-    for ac_exec_ext in '' $ac_executable_extensions; do
+-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
+-    ac_cv_prog_CC="${ac_tool_prefix}gcc"
+-    $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
+-    break 2
+-  fi
+-done
+-  done
+-IFS=$as_save_IFS
+-
+-fi
+-fi
+-CC=$ac_cv_prog_CC
+-if test -n "$CC"; then
+-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: $CC" >&5
+-$as_echo "$CC" >&6; }
+-else
+-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
+-$as_echo "no" >&6; }
+-fi
+-
+-
+-fi
+-if test -z "$ac_cv_prog_CC"; then
+-  ac_ct_CC=$CC
+-  # Extract the first word of "gcc", so it can be a program name with args.
+-set dummy gcc; ac_word=$2
+-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for $ac_word" >&5
+-$as_echo_n "checking for $ac_word... " >&6; }
+-if test "${ac_cv_prog_ac_ct_CC+set}" = set; then :
+-  $as_echo_n "(cached) " >&6
+-else
+-  if test -n "$ac_ct_CC"; then
+-  ac_cv_prog_ac_ct_CC="$ac_ct_CC" # Let the user override the test.
+-else
+-as_save_IFS=$IFS; IFS=$PATH_SEPARATOR
+-for as_dir in $PATH
+-do
+-  IFS=$as_save_IFS
+-  test -z "$as_dir" && as_dir=.
+-    for ac_exec_ext in '' $ac_executable_extensions; do
+-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
+-    ac_cv_prog_ac_ct_CC="gcc"
+-    $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
+-    break 2
+-  fi
+-done
+-  done
+-IFS=$as_save_IFS
+-
+-fi
+-fi
+-ac_ct_CC=$ac_cv_prog_ac_ct_CC
+-if test -n "$ac_ct_CC"; then
+-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_ct_CC" >&5
+-$as_echo "$ac_ct_CC" >&6; }
+-else
+-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
+-$as_echo "no" >&6; }
+-fi
+-
+-  if test "x$ac_ct_CC" = x; then
+-    CC=""
+-  else
+-    case $cross_compiling:$ac_tool_warned in
+-yes:)
+-{ $as_echo "$as_me:${as_lineno-$LINENO}: WARNING: using cross tools not prefixed with host triplet" >&5
+-$as_echo "$as_me: WARNING: using cross tools not prefixed with host triplet" >&2;}
+-ac_tool_warned=yes ;;
+-esac
+-    CC=$ac_ct_CC
+-  fi
+-else
+-  CC="$ac_cv_prog_CC"
+-fi
+-
+-if test -z "$CC"; then
+-          if test -n "$ac_tool_prefix"; then
+-    # Extract the first word of "${ac_tool_prefix}cc", so it can be a program name with args.
+-set dummy ${ac_tool_prefix}cc; ac_word=$2
+-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for $ac_word" >&5
+-$as_echo_n "checking for $ac_word... " >&6; }
+-if test "${ac_cv_prog_CC+set}" = set; then :
+-  $as_echo_n "(cached) " >&6
+-else
+-  if test -n "$CC"; then
+-  ac_cv_prog_CC="$CC" # Let the user override the test.
+-else
+-as_save_IFS=$IFS; IFS=$PATH_SEPARATOR
+-for as_dir in $PATH
+-do
+-  IFS=$as_save_IFS
+-  test -z "$as_dir" && as_dir=.
+-    for ac_exec_ext in '' $ac_executable_extensions; do
+-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
+-    ac_cv_prog_CC="${ac_tool_prefix}cc"
+-    $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
+-    break 2
+-  fi
+-done
+-  done
+-IFS=$as_save_IFS
+-
+-fi
+-fi
+-CC=$ac_cv_prog_CC
+-if test -n "$CC"; then
+-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: $CC" >&5
+-$as_echo "$CC" >&6; }
+-else
+-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
+-$as_echo "no" >&6; }
+-fi
+-
+-
+-  fi
+-fi
+-if test -z "$CC"; then
+-  # Extract the first word of "cc", so it can be a program name with args.
+-set dummy cc; ac_word=$2
+-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for $ac_word" >&5
+-$as_echo_n "checking for $ac_word... " >&6; }
+-if test "${ac_cv_prog_CC+set}" = set; then :
+-  $as_echo_n "(cached) " >&6
+-else
+-  if test -n "$CC"; then
+-  ac_cv_prog_CC="$CC" # Let the user override the test.
+-else
+-  ac_prog_rejected=no
+-as_save_IFS=$IFS; IFS=$PATH_SEPARATOR
+-for as_dir in $PATH
+-do
+-  IFS=$as_save_IFS
+-  test -z "$as_dir" && as_dir=.
+-    for ac_exec_ext in '' $ac_executable_extensions; do
+-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
+-    if test "$as_dir/$ac_word$ac_exec_ext" = "/usr/ucb/cc"; then
+-       ac_prog_rejected=yes
+-       continue
+-     fi
+-    ac_cv_prog_CC="cc"
+-    $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
+-    break 2
+-  fi
+-done
+-  done
+-IFS=$as_save_IFS
+-
+-if test $ac_prog_rejected = yes; then
+-  # We found a bogon in the path, so make sure we never use it.
+-  set dummy $ac_cv_prog_CC
+-  shift
+-  if test $# != 0; then
+-    # We chose a different compiler from the bogus one.
+-    # However, it has the same basename, so the bogon will be chosen
+-    # first if we set CC to just the basename; use the full file name.
+-    shift
+-    ac_cv_prog_CC="$as_dir/$ac_word${1+' '}$@"
+-  fi
+-fi
+-fi
+-fi
+-CC=$ac_cv_prog_CC
+-if test -n "$CC"; then
+-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: $CC" >&5
+-$as_echo "$CC" >&6; }
+-else
+-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
+-$as_echo "no" >&6; }
+-fi
+-
+-
+-fi
+-if test -z "$CC"; then
+-  if test -n "$ac_tool_prefix"; then
+-  for ac_prog in cl.exe
+-  do
+-    # Extract the first word of "$ac_tool_prefix$ac_prog", so it can be a program name with args.
+-set dummy $ac_tool_prefix$ac_prog; ac_word=$2
+-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for $ac_word" >&5
+-$as_echo_n "checking for $ac_word... " >&6; }
+-if test "${ac_cv_prog_CC+set}" = set; then :
+-  $as_echo_n "(cached) " >&6
+-else
+-  if test -n "$CC"; then
+-  ac_cv_prog_CC="$CC" # Let the user override the test.
+-else
+-as_save_IFS=$IFS; IFS=$PATH_SEPARATOR
+-for as_dir in $PATH
+-do
+-  IFS=$as_save_IFS
+-  test -z "$as_dir" && as_dir=.
+-    for ac_exec_ext in '' $ac_executable_extensions; do
+-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
+-    ac_cv_prog_CC="$ac_tool_prefix$ac_prog"
+-    $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
+-    break 2
+-  fi
+-done
+-  done
+-IFS=$as_save_IFS
+-
+-fi
+-fi
+-CC=$ac_cv_prog_CC
+-if test -n "$CC"; then
+-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: $CC" >&5
+-$as_echo "$CC" >&6; }
+-else
+-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
+-$as_echo "no" >&6; }
+-fi
+-
+-
+-    test -n "$CC" && break
+-  done
+-fi
+-if test -z "$CC"; then
+-  ac_ct_CC=$CC
+-  for ac_prog in cl.exe
+-do
+-  # Extract the first word of "$ac_prog", so it can be a program name with args.
+-set dummy $ac_prog; ac_word=$2
+-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for $ac_word" >&5
+-$as_echo_n "checking for $ac_word... " >&6; }
+-if test "${ac_cv_prog_ac_ct_CC+set}" = set; then :
+-  $as_echo_n "(cached) " >&6
+-else
+-  if test -n "$ac_ct_CC"; then
+-  ac_cv_prog_ac_ct_CC="$ac_ct_CC" # Let the user override the test.
+-else
+-as_save_IFS=$IFS; IFS=$PATH_SEPARATOR
+-for as_dir in $PATH
+-do
+-  IFS=$as_save_IFS
+-  test -z "$as_dir" && as_dir=.
+-    for ac_exec_ext in '' $ac_executable_extensions; do
+-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
+-    ac_cv_prog_ac_ct_CC="$ac_prog"
+-    $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
+-    break 2
+-  fi
+-done
+-  done
+-IFS=$as_save_IFS
+-
+-fi
+-fi
+-ac_ct_CC=$ac_cv_prog_ac_ct_CC
+-if test -n "$ac_ct_CC"; then
+-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_ct_CC" >&5
+-$as_echo "$ac_ct_CC" >&6; }
+-else
+-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
+-$as_echo "no" >&6; }
+-fi
+-
+-
+-  test -n "$ac_ct_CC" && break
+-done
+-
+-  if test "x$ac_ct_CC" = x; then
+-    CC=""
+-  else
+-    case $cross_compiling:$ac_tool_warned in
+-yes:)
+-{ $as_echo "$as_me:${as_lineno-$LINENO}: WARNING: using cross tools not prefixed with host triplet" >&5
+-$as_echo "$as_me: WARNING: using cross tools not prefixed with host triplet" >&2;}
+-ac_tool_warned=yes ;;
+-esac
+-    CC=$ac_ct_CC
+-  fi
+-fi
+-
+-fi
+-
+-
+-test -z "$CC" && { { $as_echo "$as_me:${as_lineno-$LINENO}: error: in \`$ac_pwd':" >&5
+-$as_echo "$as_me: error: in \`$ac_pwd':" >&2;}
+-as_fn_error "no acceptable C compiler found in \$PATH
+-See \`config.log' for more details." "$LINENO" 5; }
+-
+-# Provide some information about the compiler.
+-$as_echo "$as_me:${as_lineno-$LINENO}: checking for C compiler version" >&5
+-set X $ac_compile
+-ac_compiler=$2
+-for ac_option in --version -v -V -qversion; do
+-  { { ac_try="$ac_compiler $ac_option >&5"
+-case "(($ac_try" in
+-  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+-  *) ac_try_echo=$ac_try;;
+-esac
+-eval ac_try_echo="\"\$as_me:${as_lineno-$LINENO}: $ac_try_echo\""
+-$as_echo "$ac_try_echo"; } >&5
+-  (eval "$ac_compiler $ac_option >&5") 2>conftest.err
+-  ac_status=$?
+-  if test -s conftest.err; then
+-    sed '10a\
+-... rest of stderr output deleted ...
+-         10q' conftest.err >conftest.er1
+-    cat conftest.er1 >&5
+-  fi
+-  rm -f conftest.er1 conftest.err
+-  $as_echo "$as_me:${as_lineno-$LINENO}: \$? = $ac_status" >&5
+-  test $ac_status = 0; }
+-done
+-
+-cat confdefs.h - <<_ACEOF >conftest.$ac_ext
+-/* end confdefs.h.  */
+-
+-int
+-main ()
+-{
+-
+-  ;
+-  return 0;
+-}
+-_ACEOF
+-ac_clean_files_save=$ac_clean_files
+-ac_clean_files="$ac_clean_files a.out a.out.dSYM a.exe b.out"
+-# Try to create an executable without -o first, disregard a.out.
+-# It will help us diagnose broken compilers, and finding out an intuition
+-# of exeext.
+-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking whether the C compiler works" >&5
+-$as_echo_n "checking whether the C compiler works... " >&6; }
+-ac_link_default=`$as_echo "$ac_link" | sed 's/ -o *conftest[^ ]*//'`
+-
+-# The possible output files:
+-ac_files="a.out conftest.exe conftest a.exe a_out.exe b.out conftest.*"
+-
+-ac_rmfiles=
+-for ac_file in $ac_files
+-do
+-  case $ac_file in
+-    *.$ac_ext | *.xcoff | *.tds | *.d | *.pdb | *.xSYM | *.bb | *.bbg | *.map | *.inf | *.dSYM | *.o | *.obj ) ;;
+-    * ) ac_rmfiles="$ac_rmfiles $ac_file";;
+-  esac
+-done
+-rm -f $ac_rmfiles
+-
+-if { { ac_try="$ac_link_default"
+-case "(($ac_try" in
+-  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+-  *) ac_try_echo=$ac_try;;
+-esac
+-eval ac_try_echo="\"\$as_me:${as_lineno-$LINENO}: $ac_try_echo\""
+-$as_echo "$ac_try_echo"; } >&5
+-  (eval "$ac_link_default") 2>&5
+-  ac_status=$?
+-  $as_echo "$as_me:${as_lineno-$LINENO}: \$? = $ac_status" >&5
+-  test $ac_status = 0; }; then :
+-  # Autoconf-2.13 could set the ac_cv_exeext variable to `no'.
+-# So ignore a value of `no', otherwise this would lead to `EXEEXT = no'
+-# in a Makefile.  We should not override ac_cv_exeext if it was cached,
+-# so that the user can short-circuit this test for compilers unknown to
+-# Autoconf.
+-for ac_file in $ac_files ''
+-do
+-  test -f "$ac_file" || continue
+-  case $ac_file in
+-    *.$ac_ext | *.xcoff | *.tds | *.d | *.pdb | *.xSYM | *.bb | *.bbg | *.map | *.inf | *.dSYM | *.o | *.obj )
+-	;;
+-    [ab].out )
+-	# We found the default executable, but exeext='' is most
+-	# certainly right.
+-	break;;
+-    *.* )
+-	if test "${ac_cv_exeext+set}" = set && test "$ac_cv_exeext" != no;
+-	then :; else
+-	   ac_cv_exeext=`expr "$ac_file" : '[^.]*\(\..*\)'`
+-	fi
+-	# We set ac_cv_exeext here because the later test for it is not
+-	# safe: cross compilers may not add the suffix if given an `-o'
+-	# argument, so we may need to know it at that point already.
+-	# Even if this section looks crufty: it has the advantage of
+-	# actually working.
+-	break;;
+-    * )
+-	break;;
+-  esac
+-done
+-test "$ac_cv_exeext" = no && ac_cv_exeext=
+-
+-else
+-  ac_file=''
+-fi
+-if test -z "$ac_file"; then :
+-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
+-$as_echo "no" >&6; }
+-$as_echo "$as_me: failed program was:" >&5
+-sed 's/^/| /' conftest.$ac_ext >&5
+-
+-{ { $as_echo "$as_me:${as_lineno-$LINENO}: error: in \`$ac_pwd':" >&5
+-$as_echo "$as_me: error: in \`$ac_pwd':" >&2;}
+-{ as_fn_set_status 77
+-as_fn_error "C compiler cannot create executables
+-See \`config.log' for more details." "$LINENO" 5; }; }
+-else
+-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: yes" >&5
+-$as_echo "yes" >&6; }
+-fi
+-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for C compiler default output file name" >&5
+-$as_echo_n "checking for C compiler default output file name... " >&6; }
+-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_file" >&5
+-$as_echo "$ac_file" >&6; }
+-ac_exeext=$ac_cv_exeext
+-
+-rm -f -r a.out a.out.dSYM a.exe conftest$ac_cv_exeext b.out
+-ac_clean_files=$ac_clean_files_save
+-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for suffix of executables" >&5
+-$as_echo_n "checking for suffix of executables... " >&6; }
+-if { { ac_try="$ac_link"
+-case "(($ac_try" in
+-  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+-  *) ac_try_echo=$ac_try;;
+-esac
+-eval ac_try_echo="\"\$as_me:${as_lineno-$LINENO}: $ac_try_echo\""
+-$as_echo "$ac_try_echo"; } >&5
+-  (eval "$ac_link") 2>&5
+-  ac_status=$?
+-  $as_echo "$as_me:${as_lineno-$LINENO}: \$? = $ac_status" >&5
+-  test $ac_status = 0; }; then :
+-  # If both `conftest.exe' and `conftest' are `present' (well, observable)
+-# catch `conftest.exe'.  For instance with Cygwin, `ls conftest' will
+-# work properly (i.e., refer to `conftest.exe'), while it won't with
+-# `rm'.
+-for ac_file in conftest.exe conftest conftest.*; do
+-  test -f "$ac_file" || continue
+-  case $ac_file in
+-    *.$ac_ext | *.xcoff | *.tds | *.d | *.pdb | *.xSYM | *.bb | *.bbg | *.map | *.inf | *.dSYM | *.o | *.obj ) ;;
+-    *.* ) ac_cv_exeext=`expr "$ac_file" : '[^.]*\(\..*\)'`
+-	  break;;
+-    * ) break;;
+-  esac
+-done
+-else
+-  { { $as_echo "$as_me:${as_lineno-$LINENO}: error: in \`$ac_pwd':" >&5
+-$as_echo "$as_me: error: in \`$ac_pwd':" >&2;}
+-as_fn_error "cannot compute suffix of executables: cannot compile and link
+-See \`config.log' for more details." "$LINENO" 5; }
+-fi
+-rm -f conftest conftest$ac_cv_exeext
+-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_exeext" >&5
+-$as_echo "$ac_cv_exeext" >&6; }
+-
+-rm -f conftest.$ac_ext
+-EXEEXT=$ac_cv_exeext
+-ac_exeext=$EXEEXT
+-cat confdefs.h - <<_ACEOF >conftest.$ac_ext
+-/* end confdefs.h.  */
+-#include <stdio.h>
+-int
+-main ()
+-{
+-FILE *f = fopen ("conftest.out", "w");
+- return ferror (f) || fclose (f) != 0;
+-
+-  ;
+-  return 0;
+-}
+-_ACEOF
+-ac_clean_files="$ac_clean_files conftest.out"
+-# Check that the compiler produces executables we can run.  If not, either
+-# the compiler is broken, or we cross compile.
+-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking whether we are cross compiling" >&5
+-$as_echo_n "checking whether we are cross compiling... " >&6; }
+-if test "$cross_compiling" != yes; then
+-  { { ac_try="$ac_link"
+-case "(($ac_try" in
+-  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+-  *) ac_try_echo=$ac_try;;
+-esac
+-eval ac_try_echo="\"\$as_me:${as_lineno-$LINENO}: $ac_try_echo\""
+-$as_echo "$ac_try_echo"; } >&5
+-  (eval "$ac_link") 2>&5
+-  ac_status=$?
+-  $as_echo "$as_me:${as_lineno-$LINENO}: \$? = $ac_status" >&5
+-  test $ac_status = 0; }
+-  if { ac_try='./conftest$ac_cv_exeext'
+-  { { case "(($ac_try" in
+-  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+-  *) ac_try_echo=$ac_try;;
+-esac
+-eval ac_try_echo="\"\$as_me:${as_lineno-$LINENO}: $ac_try_echo\""
+-$as_echo "$ac_try_echo"; } >&5
+-  (eval "$ac_try") 2>&5
+-  ac_status=$?
+-  $as_echo "$as_me:${as_lineno-$LINENO}: \$? = $ac_status" >&5
+-  test $ac_status = 0; }; }; then
+-    cross_compiling=no
+-  else
+-    if test "$cross_compiling" = maybe; then
+-	cross_compiling=yes
+-    else
+-	{ { $as_echo "$as_me:${as_lineno-$LINENO}: error: in \`$ac_pwd':" >&5
+-$as_echo "$as_me: error: in \`$ac_pwd':" >&2;}
+-as_fn_error "cannot run C compiled programs.
+-If you meant to cross compile, use \`--host'.
+-See \`config.log' for more details." "$LINENO" 5; }
+-    fi
+-  fi
+-fi
+-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $cross_compiling" >&5
+-$as_echo "$cross_compiling" >&6; }
+-
+-rm -f conftest.$ac_ext conftest$ac_cv_exeext conftest.out
+-ac_clean_files=$ac_clean_files_save
+-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for suffix of object files" >&5
+-$as_echo_n "checking for suffix of object files... " >&6; }
+-if test "${ac_cv_objext+set}" = set; then :
+-  $as_echo_n "(cached) " >&6
+-else
+-  cat confdefs.h - <<_ACEOF >conftest.$ac_ext
+-/* end confdefs.h.  */
+-
+-int
+-main ()
+-{
+-
+-  ;
+-  return 0;
+-}
+-_ACEOF
+-rm -f conftest.o conftest.obj
+-if { { ac_try="$ac_compile"
+-case "(($ac_try" in
+-  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+-  *) ac_try_echo=$ac_try;;
+-esac
+-eval ac_try_echo="\"\$as_me:${as_lineno-$LINENO}: $ac_try_echo\""
+-$as_echo "$ac_try_echo"; } >&5
+-  (eval "$ac_compile") 2>&5
+-  ac_status=$?
+-  $as_echo "$as_me:${as_lineno-$LINENO}: \$? = $ac_status" >&5
+-  test $ac_status = 0; }; then :
+-  for ac_file in conftest.o conftest.obj conftest.*; do
+-  test -f "$ac_file" || continue;
+-  case $ac_file in
+-    *.$ac_ext | *.xcoff | *.tds | *.d | *.pdb | *.xSYM | *.bb | *.bbg | *.map | *.inf | *.dSYM ) ;;
+-    *) ac_cv_objext=`expr "$ac_file" : '.*\.\(.*\)'`
+-       break;;
+-  esac
+-done
+-else
+-  $as_echo "$as_me: failed program was:" >&5
+-sed 's/^/| /' conftest.$ac_ext >&5
+-
+-{ { $as_echo "$as_me:${as_lineno-$LINENO}: error: in \`$ac_pwd':" >&5
+-$as_echo "$as_me: error: in \`$ac_pwd':" >&2;}
+-as_fn_error "cannot compute suffix of object files: cannot compile
+-See \`config.log' for more details." "$LINENO" 5; }
+-fi
+-rm -f conftest.$ac_cv_objext conftest.$ac_ext
+-fi
+-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_objext" >&5
+-$as_echo "$ac_cv_objext" >&6; }
+-OBJEXT=$ac_cv_objext
+-ac_objext=$OBJEXT
+-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking whether we are using the GNU C compiler" >&5
+-$as_echo_n "checking whether we are using the GNU C compiler... " >&6; }
+-if test "${ac_cv_c_compiler_gnu+set}" = set; then :
+-  $as_echo_n "(cached) " >&6
+-else
+-  cat confdefs.h - <<_ACEOF >conftest.$ac_ext
+-/* end confdefs.h.  */
+-
+-int
+-main ()
+-{
+-#ifndef __GNUC__
+-       choke me
+-#endif
+-
+-  ;
+-  return 0;
+-}
+-_ACEOF
+-if ac_fn_c_try_compile "$LINENO"; then :
+-  ac_compiler_gnu=yes
+-else
+-  ac_compiler_gnu=no
+-fi
+-rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
+-ac_cv_c_compiler_gnu=$ac_compiler_gnu
+-
+-fi
+-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_c_compiler_gnu" >&5
+-$as_echo "$ac_cv_c_compiler_gnu" >&6; }
+-if test $ac_compiler_gnu = yes; then
+-  GCC=yes
+-else
+-  GCC=
+-fi
+-ac_test_CFLAGS=${CFLAGS+set}
+-ac_save_CFLAGS=$CFLAGS
+-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking whether $CC accepts -g" >&5
+-$as_echo_n "checking whether $CC accepts -g... " >&6; }
+-if test "${ac_cv_prog_cc_g+set}" = set; then :
+-  $as_echo_n "(cached) " >&6
+-else
+-  ac_save_c_werror_flag=$ac_c_werror_flag
+-   ac_c_werror_flag=yes
+-   ac_cv_prog_cc_g=no
+-   CFLAGS="-g"
+-   cat confdefs.h - <<_ACEOF >conftest.$ac_ext
+-/* end confdefs.h.  */
+-
+-int
+-main ()
+-{
+-
+-  ;
+-  return 0;
+-}
+-_ACEOF
+-if ac_fn_c_try_compile "$LINENO"; then :
+-  ac_cv_prog_cc_g=yes
+-else
+-  CFLAGS=""
+-      cat confdefs.h - <<_ACEOF >conftest.$ac_ext
+-/* end confdefs.h.  */
+-
+-int
+-main ()
+-{
+-
+-  ;
+-  return 0;
+-}
+-_ACEOF
+-if ac_fn_c_try_compile "$LINENO"; then :
+-
+-else
+-  ac_c_werror_flag=$ac_save_c_werror_flag
+-	 CFLAGS="-g"
+-	 cat confdefs.h - <<_ACEOF >conftest.$ac_ext
+-/* end confdefs.h.  */
+-
+-int
+-main ()
+-{
+-
+-  ;
+-  return 0;
+-}
+-_ACEOF
+-if ac_fn_c_try_compile "$LINENO"; then :
+-  ac_cv_prog_cc_g=yes
+-fi
+-rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
+-fi
+-rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
+-fi
+-rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
+-   ac_c_werror_flag=$ac_save_c_werror_flag
+-fi
+-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_prog_cc_g" >&5
+-$as_echo "$ac_cv_prog_cc_g" >&6; }
+-if test "$ac_test_CFLAGS" = set; then
+-  CFLAGS=$ac_save_CFLAGS
+-elif test $ac_cv_prog_cc_g = yes; then
+-  if test "$GCC" = yes; then
+-    CFLAGS="-g -O2"
+-  else
+-    CFLAGS="-g"
+-  fi
+-else
+-  if test "$GCC" = yes; then
+-    CFLAGS="-O2"
+-  else
+-    CFLAGS=
+-  fi
+-fi
+-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for $CC option to accept ISO C89" >&5
+-$as_echo_n "checking for $CC option to accept ISO C89... " >&6; }
+-if test "${ac_cv_prog_cc_c89+set}" = set; then :
+-  $as_echo_n "(cached) " >&6
+-else
+-  ac_cv_prog_cc_c89=no
+-ac_save_CC=$CC
+-cat confdefs.h - <<_ACEOF >conftest.$ac_ext
+-/* end confdefs.h.  */
+-#include <stdarg.h>
+-#include <stdio.h>
+-#include <sys/types.h>
+-#include <sys/stat.h>
+-/* Most of the following tests are stolen from RCS 5.7's src/conf.sh.  */
+-struct buf { int x; };
+-FILE * (*rcsopen) (struct buf *, struct stat *, int);
+-static char *e (p, i)
+-     char **p;
+-     int i;
+-{
+-  return p[i];
+-}
+-static char *f (char * (*g) (char **, int), char **p, ...)
+-{
+-  char *s;
+-  va_list v;
+-  va_start (v,p);
+-  s = g (p, va_arg (v,int));
+-  va_end (v);
+-  return s;
+-}
+-
+-/* OSF 4.0 Compaq cc is some sort of almost-ANSI by default.  It has
+-   function prototypes and stuff, but not '\xHH' hex character constants.
+-   These don't provoke an error unfortunately, instead are silently treated
+-   as 'x'.  The following induces an error, until -std is added to get
+-   proper ANSI mode.  Curiously '\x00'!='x' always comes out true, for an
+-   array size at least.  It's necessary to write '\x00'==0 to get something
+-   that's true only with -std.  */
+-int osf4_cc_array ['\x00' == 0 ? 1 : -1];
+-
+-/* IBM C 6 for AIX is almost-ANSI by default, but it replaces macro parameters
+-   inside strings and character constants.  */
+-#define FOO(x) 'x'
+-int xlc6_cc_array[FOO(a) == 'x' ? 1 : -1];
+-
+-int test (int i, double x);
+-struct s1 {int (*f) (int a);};
+-struct s2 {int (*f) (double a);};
+-int pairnames (int, char **, FILE *(*)(struct buf *, struct stat *, int), int, int);
+-int argc;
+-char **argv;
+-int
+-main ()
+-{
+-return f (e, argv, 0) != argv[0]  ||  f (e, argv, 1) != argv[1];
+-  ;
+-  return 0;
+-}
+-_ACEOF
+-for ac_arg in '' -qlanglvl=extc89 -qlanglvl=ansi -std \
+-	-Ae "-Aa -D_HPUX_SOURCE" "-Xc -D__EXTENSIONS__"
+-do
+-  CC="$ac_save_CC $ac_arg"
+-  if ac_fn_c_try_compile "$LINENO"; then :
+-  ac_cv_prog_cc_c89=$ac_arg
+-fi
+-rm -f core conftest.err conftest.$ac_objext
+-  test "x$ac_cv_prog_cc_c89" != "xno" && break
+-done
+-rm -f conftest.$ac_ext
+-CC=$ac_save_CC
+-
+-fi
+-# AC_CACHE_VAL
+-case "x$ac_cv_prog_cc_c89" in
+-  x)
+-    { $as_echo "$as_me:${as_lineno-$LINENO}: result: none needed" >&5
+-$as_echo "none needed" >&6; } ;;
+-  xno)
+-    { $as_echo "$as_me:${as_lineno-$LINENO}: result: unsupported" >&5
+-$as_echo "unsupported" >&6; } ;;
+-  *)
+-    CC="$CC $ac_cv_prog_cc_c89"
+-    { $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_prog_cc_c89" >&5
+-$as_echo "$ac_cv_prog_cc_c89" >&6; } ;;
+-esac
+-if test "x$ac_cv_prog_cc_c89" != xno; then :
+-
+-fi
+-
+-ac_ext=c
+-ac_cpp='$CPP $CPPFLAGS'
+-ac_compile='$CC -c $CFLAGS $CPPFLAGS conftest.$ac_ext >&5'
+-ac_link='$CC -o conftest$ac_exeext $CFLAGS $CPPFLAGS $LDFLAGS conftest.$ac_ext $LIBS >&5'
+-ac_compiler_gnu=$ac_cv_c_compiler_gnu
+-DEPDIR="${am__leading_dot}deps"
+-
+-ac_config_commands="$ac_config_commands depfiles"
+-
+-
+-am_make=${MAKE-make}
+-cat > confinc << 'END'
+-am__doit:
+-	@echo this is the am__doit target
+-.PHONY: am__doit
+-END
+-# If we don't find an include directive, just comment out the code.
+-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for style of include used by $am_make" >&5
+-$as_echo_n "checking for style of include used by $am_make... " >&6; }
+-am__include="#"
+-am__quote=
+-_am_result=none
+-# First try GNU make style include.
+-echo "include confinc" > confmf
+-# Ignore all kinds of additional output from `make'.
+-case `$am_make -s -f confmf 2> /dev/null` in #(
+-*the\ am__doit\ target*)
+-  am__include=include
+-  am__quote=
+-  _am_result=GNU
+-  ;;
+-esac
+-# Now try BSD make style include.
+-if test "$am__include" = "#"; then
+-   echo '.include "confinc"' > confmf
+-   case `$am_make -s -f confmf 2> /dev/null` in #(
+-   *the\ am__doit\ target*)
+-     am__include=.include
+-     am__quote="\""
+-     _am_result=BSD
+-     ;;
+-   esac
+-fi
+-
+-
+-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $_am_result" >&5
+-$as_echo "$_am_result" >&6; }
+-rm -f confinc confmf
+-
+-# Check whether --enable-dependency-tracking was given.
+-if test "${enable_dependency_tracking+set}" = set; then :
+-  enableval=$enable_dependency_tracking;
+-fi
+-
+-if test "x$enable_dependency_tracking" != xno; then
+-  am_depcomp="$ac_aux_dir/depcomp"
+-  AMDEPBACKSLASH='\'
+-fi
+- if test "x$enable_dependency_tracking" != xno; then
+-  AMDEP_TRUE=
+-  AMDEP_FALSE='#'
+-else
+-  AMDEP_TRUE='#'
+-  AMDEP_FALSE=
+-fi
+-
+-
+-
+-depcc="$CC"   am_compiler_list=
+-
+-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking dependency style of $depcc" >&5
+-$as_echo_n "checking dependency style of $depcc... " >&6; }
+-if test "${am_cv_CC_dependencies_compiler_type+set}" = set; then :
+-  $as_echo_n "(cached) " >&6
+-else
+-  if test -z "$AMDEP_TRUE" && test -f "$am_depcomp"; then
+-  # We make a subdir and do the tests there.  Otherwise we can end up
+-  # making bogus files that we don't know about and never remove.  For
+-  # instance it was reported that on HP-UX the gcc test will end up
+-  # making a dummy file named `D' -- because `-MD' means `put the output
+-  # in D'.
+-  mkdir conftest.dir
+-  # Copy depcomp to subdir because otherwise we won't find it if we're
+-  # using a relative directory.
+-  cp "$am_depcomp" conftest.dir
+-  cd conftest.dir
+-  # We will build objects and dependencies in a subdirectory because
+-  # it helps to detect inapplicable dependency modes.  For instance
+-  # both Tru64's cc and ICC support -MD to output dependencies as a
+-  # side effect of compilation, but ICC will put the dependencies in
+-  # the current directory while Tru64 will put them in the object
+-  # directory.
+-  mkdir sub
+-
+-  am_cv_CC_dependencies_compiler_type=none
+-  if test "$am_compiler_list" = ""; then
+-     am_compiler_list=`sed -n 's/^#*\([a-zA-Z0-9]*\))$/\1/p' < ./depcomp`
+-  fi
+-  am__universal=false
+-  case " $depcc " in #(
+-     *\ -arch\ *\ -arch\ *) am__universal=true ;;
+-     esac
+-
+-  for depmode in $am_compiler_list; do
+-    # Setup a source with many dependencies, because some compilers
+-    # like to wrap large dependency lists on column 80 (with \), and
+-    # we should not choose a depcomp mode which is confused by this.
+-    #
+-    # We need to recreate these files for each test, as the compiler may
+-    # overwrite some of them when testing with obscure command lines.
+-    # This happens at least with the AIX C compiler.
+-    : > sub/conftest.c
+-    for i in 1 2 3 4 5 6; do
+-      echo '#include "conftst'$i'.h"' >> sub/conftest.c
+-      # Using `: > sub/conftst$i.h' creates only sub/conftst1.h with
+-      # Solaris 8's {/usr,}/bin/sh.
+-      touch sub/conftst$i.h
+-    done
+-    echo "${am__include} ${am__quote}sub/conftest.Po${am__quote}" > confmf
+-
+-    # We check with `-c' and `-o' for the sake of the "dashmstdout"
+-    # mode.  It turns out that the SunPro C++ compiler does not properly
+-    # handle `-M -o', and we need to detect this.  Also, some Intel
+-    # versions had trouble with output in subdirs
+-    am__obj=sub/conftest.${OBJEXT-o}
+-    am__minus_obj="-o $am__obj"
+-    case $depmode in
+-    gcc)
+-      # This depmode causes a compiler race in universal mode.
+-      test "$am__universal" = false || continue
+-      ;;
+-    nosideeffect)
+-      # after this tag, mechanisms are not by side-effect, so they'll
+-      # only be used when explicitly requested
+-      if test "x$enable_dependency_tracking" = xyes; then
+-	continue
+-      else
+-	break
+-      fi
+-      ;;
+-    msvisualcpp | msvcmsys)
+-      # This compiler won't grok `-c -o', but also, the minuso test has
+-      # not run yet.  These depmodes are late enough in the game, and
+-      # so weak that their functioning should not be impacted.
+-      am__obj=conftest.${OBJEXT-o}
+-      am__minus_obj=
+-      ;;
+-    none) break ;;
+-    esac
+-    if depmode=$depmode \
+-       source=sub/conftest.c object=$am__obj \
+-       depfile=sub/conftest.Po tmpdepfile=sub/conftest.TPo \
+-       $SHELL ./depcomp $depcc -c $am__minus_obj sub/conftest.c \
+-         >/dev/null 2>conftest.err &&
+-       grep sub/conftst1.h sub/conftest.Po > /dev/null 2>&1 &&
+-       grep sub/conftst6.h sub/conftest.Po > /dev/null 2>&1 &&
+-       grep $am__obj sub/conftest.Po > /dev/null 2>&1 &&
+-       ${MAKE-make} -s -f confmf > /dev/null 2>&1; then
+-      # icc doesn't choke on unknown options, it will just issue warnings
+-      # or remarks (even with -Werror).  So we grep stderr for any message
+-      # that says an option was ignored or not supported.
+-      # When given -MP, icc 7.0 and 7.1 complain thusly:
+-      #   icc: Command line warning: ignoring option '-M'; no argument required
+-      # The diagnosis changed in icc 8.0:
+-      #   icc: Command line remark: option '-MP' not supported
+-      if (grep 'ignoring option' conftest.err ||
+-          grep 'not supported' conftest.err) >/dev/null 2>&1; then :; else
+-        am_cv_CC_dependencies_compiler_type=$depmode
+-        break
+-      fi
+-    fi
+-  done
+-
+-  cd ..
+-  rm -rf conftest.dir
+-else
+-  am_cv_CC_dependencies_compiler_type=none
+-fi
+-
+-fi
+-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $am_cv_CC_dependencies_compiler_type" >&5
+-$as_echo "$am_cv_CC_dependencies_compiler_type" >&6; }
+-CCDEPMODE=depmode=$am_cv_CC_dependencies_compiler_type
+-
+- if
+-  test "x$enable_dependency_tracking" != xno \
+-  && test "$am_cv_CC_dependencies_compiler_type" = gcc3; then
+-  am__fastdepCC_TRUE=
+-  am__fastdepCC_FALSE='#'
+-else
+-  am__fastdepCC_TRUE='#'
+-  am__fastdepCC_FALSE=
+-fi
+-
+-
+-ac_ext=c
+-ac_cpp='$CPP $CPPFLAGS'
+-ac_compile='$CC -c $CFLAGS $CPPFLAGS conftest.$ac_ext >&5'
+-ac_link='$CC -o conftest$ac_exeext $CFLAGS $CPPFLAGS $LDFLAGS conftest.$ac_ext $LIBS >&5'
+-ac_compiler_gnu=$ac_cv_c_compiler_gnu
+-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking how to run the C preprocessor" >&5
+-$as_echo_n "checking how to run the C preprocessor... " >&6; }
+-# On Suns, sometimes $CPP names a directory.
+-if test -n "$CPP" && test -d "$CPP"; then
+-  CPP=
+-fi
+-if test -z "$CPP"; then
+-  if test "${ac_cv_prog_CPP+set}" = set; then :
+-  $as_echo_n "(cached) " >&6
+-else
+-      # Double quotes because CPP needs to be expanded
+-    for CPP in "$CC -E" "$CC -E -traditional-cpp" "/lib/cpp"
+-    do
+-      ac_preproc_ok=false
+-for ac_c_preproc_warn_flag in '' yes
+-do
+-  # Use a header file that comes with gcc, so configuring glibc
+-  # with a fresh cross-compiler works.
+-  # Prefer <limits.h> to <assert.h> if __STDC__ is defined, since
+-  # <limits.h> exists even on freestanding compilers.
+-  # On the NeXT, cc -E runs the code through the compiler's parser,
+-  # not just through cpp. "Syntax error" is here to catch this case.
+-  cat confdefs.h - <<_ACEOF >conftest.$ac_ext
+-/* end confdefs.h.  */
+-#ifdef __STDC__
+-# include <limits.h>
+-#else
+-# include <assert.h>
+-#endif
+-		     Syntax error
+-_ACEOF
+-if ac_fn_c_try_cpp "$LINENO"; then :
+-
+-else
+-  # Broken: fails on valid input.
+-continue
+-fi
+-rm -f conftest.err conftest.$ac_ext
+-
+-  # OK, works on sane cases.  Now check whether nonexistent headers
+-  # can be detected and how.
+-  cat confdefs.h - <<_ACEOF >conftest.$ac_ext
+-/* end confdefs.h.  */
+-#include <ac_nonexistent.h>
+-_ACEOF
+-if ac_fn_c_try_cpp "$LINENO"; then :
+-  # Broken: success on invalid input.
+-continue
+-else
+-  # Passes both tests.
+-ac_preproc_ok=:
+-break
+-fi
+-rm -f conftest.err conftest.$ac_ext
+-
+-done
+-# Because of `break', _AC_PREPROC_IFELSE's cleaning code was skipped.
+-rm -f conftest.err conftest.$ac_ext
+-if $ac_preproc_ok; then :
+-  break
+-fi
+-
+-    done
+-    ac_cv_prog_CPP=$CPP
+-
+-fi
+-  CPP=$ac_cv_prog_CPP
+-else
+-  ac_cv_prog_CPP=$CPP
+-fi
+-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $CPP" >&5
+-$as_echo "$CPP" >&6; }
+-ac_preproc_ok=false
+-for ac_c_preproc_warn_flag in '' yes
+-do
+-  # Use a header file that comes with gcc, so configuring glibc
+-  # with a fresh cross-compiler works.
+-  # Prefer <limits.h> to <assert.h> if __STDC__ is defined, since
+-  # <limits.h> exists even on freestanding compilers.
+-  # On the NeXT, cc -E runs the code through the compiler's parser,
+-  # not just through cpp. "Syntax error" is here to catch this case.
+-  cat confdefs.h - <<_ACEOF >conftest.$ac_ext
+-/* end confdefs.h.  */
+-#ifdef __STDC__
+-# include <limits.h>
+-#else
+-# include <assert.h>
+-#endif
+-		     Syntax error
+-_ACEOF
+-if ac_fn_c_try_cpp "$LINENO"; then :
+-
+-else
+-  # Broken: fails on valid input.
+-continue
+-fi
+-rm -f conftest.err conftest.$ac_ext
+-
+-  # OK, works on sane cases.  Now check whether nonexistent headers
+-  # can be detected and how.
+-  cat confdefs.h - <<_ACEOF >conftest.$ac_ext
+-/* end confdefs.h.  */
+-#include <ac_nonexistent.h>
+-_ACEOF
+-if ac_fn_c_try_cpp "$LINENO"; then :
+-  # Broken: success on invalid input.
+-continue
+-else
+-  # Passes both tests.
+-ac_preproc_ok=:
+-break
+-fi
+-rm -f conftest.err conftest.$ac_ext
+-
+-done
+-# Because of `break', _AC_PREPROC_IFELSE's cleaning code was skipped.
+-rm -f conftest.err conftest.$ac_ext
+-if $ac_preproc_ok; then :
+-
+-else
+-  { { $as_echo "$as_me:${as_lineno-$LINENO}: error: in \`$ac_pwd':" >&5
+-$as_echo "$as_me: error: in \`$ac_pwd':" >&2;}
+-as_fn_error "C preprocessor \"$CPP\" fails sanity check
+-See \`config.log' for more details." "$LINENO" 5; }
+-fi
+-
+-ac_ext=c
+-ac_cpp='$CPP $CPPFLAGS'
+-ac_compile='$CC -c $CFLAGS $CPPFLAGS conftest.$ac_ext >&5'
+-ac_link='$CC -o conftest$ac_exeext $CFLAGS $CPPFLAGS $LDFLAGS conftest.$ac_ext $LIBS >&5'
+-ac_compiler_gnu=$ac_cv_c_compiler_gnu
+-
+-ac_ext=cpp
+-ac_cpp='$CXXCPP $CPPFLAGS'
+-ac_compile='$CXX -c $CXXFLAGS $CPPFLAGS conftest.$ac_ext >&5'
+-ac_link='$CXX -o conftest$ac_exeext $CXXFLAGS $CPPFLAGS $LDFLAGS conftest.$ac_ext $LIBS >&5'
+-ac_compiler_gnu=$ac_cv_cxx_compiler_gnu
+-if test -z "$CXX"; then
+-  if test -n "$CCC"; then
+-    CXX=$CCC
+-  else
+-    if test -n "$ac_tool_prefix"; then
+-  for ac_prog in g++ c++ gpp aCC CC cxx cc++ cl.exe FCC KCC RCC xlC_r xlC
+-  do
+-    # Extract the first word of "$ac_tool_prefix$ac_prog", so it can be a program name with args.
+-set dummy $ac_tool_prefix$ac_prog; ac_word=$2
+-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for $ac_word" >&5
+-$as_echo_n "checking for $ac_word... " >&6; }
+-if test "${ac_cv_prog_CXX+set}" = set; then :
+-  $as_echo_n "(cached) " >&6
+-else
+-  if test -n "$CXX"; then
+-  ac_cv_prog_CXX="$CXX" # Let the user override the test.
+-else
+-as_save_IFS=$IFS; IFS=$PATH_SEPARATOR
+-for as_dir in $PATH
+-do
+-  IFS=$as_save_IFS
+-  test -z "$as_dir" && as_dir=.
+-    for ac_exec_ext in '' $ac_executable_extensions; do
+-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
+-    ac_cv_prog_CXX="$ac_tool_prefix$ac_prog"
+-    $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
+-    break 2
+-  fi
+-done
+-  done
+-IFS=$as_save_IFS
+-
+-fi
+-fi
+-CXX=$ac_cv_prog_CXX
+-if test -n "$CXX"; then
+-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: $CXX" >&5
+-$as_echo "$CXX" >&6; }
+-else
+-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
+-$as_echo "no" >&6; }
+-fi
+-
+-
+-    test -n "$CXX" && break
+-  done
+-fi
+-if test -z "$CXX"; then
+-  ac_ct_CXX=$CXX
+-  for ac_prog in g++ c++ gpp aCC CC cxx cc++ cl.exe FCC KCC RCC xlC_r xlC
+-do
+-  # Extract the first word of "$ac_prog", so it can be a program name with args.
+-set dummy $ac_prog; ac_word=$2
+-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for $ac_word" >&5
+-$as_echo_n "checking for $ac_word... " >&6; }
+-if test "${ac_cv_prog_ac_ct_CXX+set}" = set; then :
+-  $as_echo_n "(cached) " >&6
+-else
+-  if test -n "$ac_ct_CXX"; then
+-  ac_cv_prog_ac_ct_CXX="$ac_ct_CXX" # Let the user override the test.
+-else
+-as_save_IFS=$IFS; IFS=$PATH_SEPARATOR
+-for as_dir in $PATH
+-do
+-  IFS=$as_save_IFS
+-  test -z "$as_dir" && as_dir=.
+-    for ac_exec_ext in '' $ac_executable_extensions; do
+-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
+-    ac_cv_prog_ac_ct_CXX="$ac_prog"
+-    $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
+-    break 2
+-  fi
+-done
+-  done
+-IFS=$as_save_IFS
+-
+-fi
+-fi
+-ac_ct_CXX=$ac_cv_prog_ac_ct_CXX
+-if test -n "$ac_ct_CXX"; then
+-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_ct_CXX" >&5
+-$as_echo "$ac_ct_CXX" >&6; }
+-else
+-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
+-$as_echo "no" >&6; }
+-fi
+-
+-
+-  test -n "$ac_ct_CXX" && break
+-done
+-
+-  if test "x$ac_ct_CXX" = x; then
+-    CXX="g++"
+-  else
+-    case $cross_compiling:$ac_tool_warned in
+-yes:)
+-{ $as_echo "$as_me:${as_lineno-$LINENO}: WARNING: using cross tools not prefixed with host triplet" >&5
+-$as_echo "$as_me: WARNING: using cross tools not prefixed with host triplet" >&2;}
+-ac_tool_warned=yes ;;
+-esac
+-    CXX=$ac_ct_CXX
+-  fi
+-fi
+-
+-  fi
+-fi
+-# Provide some information about the compiler.
+-$as_echo "$as_me:${as_lineno-$LINENO}: checking for C++ compiler version" >&5
+-set X $ac_compile
+-ac_compiler=$2
+-for ac_option in --version -v -V -qversion; do
+-  { { ac_try="$ac_compiler $ac_option >&5"
+-case "(($ac_try" in
+-  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+-  *) ac_try_echo=$ac_try;;
+-esac
+-eval ac_try_echo="\"\$as_me:${as_lineno-$LINENO}: $ac_try_echo\""
+-$as_echo "$ac_try_echo"; } >&5
+-  (eval "$ac_compiler $ac_option >&5") 2>conftest.err
+-  ac_status=$?
+-  if test -s conftest.err; then
+-    sed '10a\
+-... rest of stderr output deleted ...
+-         10q' conftest.err >conftest.er1
+-    cat conftest.er1 >&5
+-  fi
+-  rm -f conftest.er1 conftest.err
+-  $as_echo "$as_me:${as_lineno-$LINENO}: \$? = $ac_status" >&5
+-  test $ac_status = 0; }
+-done
+-
+-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking whether we are using the GNU C++ compiler" >&5
+-$as_echo_n "checking whether we are using the GNU C++ compiler... " >&6; }
+-if test "${ac_cv_cxx_compiler_gnu+set}" = set; then :
+-  $as_echo_n "(cached) " >&6
+-else
+-  cat confdefs.h - <<_ACEOF >conftest.$ac_ext
+-/* end confdefs.h.  */
+-
+-int
+-main ()
+-{
+-#ifndef __GNUC__
+-       choke me
+-#endif
+-
+-  ;
+-  return 0;
+-}
+-_ACEOF
+-if ac_fn_cxx_try_compile "$LINENO"; then :
+-  ac_compiler_gnu=yes
+-else
+-  ac_compiler_gnu=no
+-fi
+-rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
+-ac_cv_cxx_compiler_gnu=$ac_compiler_gnu
+-
+-fi
+-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_cxx_compiler_gnu" >&5
+-$as_echo "$ac_cv_cxx_compiler_gnu" >&6; }
+-if test $ac_compiler_gnu = yes; then
+-  GXX=yes
+-else
+-  GXX=
+-fi
+-ac_test_CXXFLAGS=${CXXFLAGS+set}
+-ac_save_CXXFLAGS=$CXXFLAGS
+-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking whether $CXX accepts -g" >&5
+-$as_echo_n "checking whether $CXX accepts -g... " >&6; }
+-if test "${ac_cv_prog_cxx_g+set}" = set; then :
+-  $as_echo_n "(cached) " >&6
+-else
+-  ac_save_cxx_werror_flag=$ac_cxx_werror_flag
+-   ac_cxx_werror_flag=yes
+-   ac_cv_prog_cxx_g=no
+-   CXXFLAGS="-g"
+-   cat confdefs.h - <<_ACEOF >conftest.$ac_ext
+-/* end confdefs.h.  */
+-
+-int
+-main ()
+-{
+-
+-  ;
+-  return 0;
+-}
+-_ACEOF
+-if ac_fn_cxx_try_compile "$LINENO"; then :
+-  ac_cv_prog_cxx_g=yes
+-else
+-  CXXFLAGS=""
+-      cat confdefs.h - <<_ACEOF >conftest.$ac_ext
+-/* end confdefs.h.  */
+-
+-int
+-main ()
+-{
+-
+-  ;
+-  return 0;
+-}
+-_ACEOF
+-if ac_fn_cxx_try_compile "$LINENO"; then :
+-
+-else
+-  ac_cxx_werror_flag=$ac_save_cxx_werror_flag
+-	 CXXFLAGS="-g"
+-	 cat confdefs.h - <<_ACEOF >conftest.$ac_ext
+-/* end confdefs.h.  */
+-
+-int
+-main ()
+-{
+-
+-  ;
+-  return 0;
+-}
+-_ACEOF
+-if ac_fn_cxx_try_compile "$LINENO"; then :
+-  ac_cv_prog_cxx_g=yes
+-fi
+-rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
+-fi
+-rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
+-fi
+-rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
+-   ac_cxx_werror_flag=$ac_save_cxx_werror_flag
+-fi
+-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_prog_cxx_g" >&5
+-$as_echo "$ac_cv_prog_cxx_g" >&6; }
+-if test "$ac_test_CXXFLAGS" = set; then
+-  CXXFLAGS=$ac_save_CXXFLAGS
+-elif test $ac_cv_prog_cxx_g = yes; then
+-  if test "$GXX" = yes; then
+-    CXXFLAGS="-g -O2"
+-  else
+-    CXXFLAGS="-g"
+-  fi
+-else
+-  if test "$GXX" = yes; then
+-    CXXFLAGS="-O2"
+-  else
+-    CXXFLAGS=
+-  fi
+-fi
+-ac_ext=c
+-ac_cpp='$CPP $CPPFLAGS'
+-ac_compile='$CC -c $CFLAGS $CPPFLAGS conftest.$ac_ext >&5'
+-ac_link='$CC -o conftest$ac_exeext $CFLAGS $CPPFLAGS $LDFLAGS conftest.$ac_ext $LIBS >&5'
+-ac_compiler_gnu=$ac_cv_c_compiler_gnu
+-
+-depcc="$CXX"  am_compiler_list=
+-
+-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking dependency style of $depcc" >&5
+-$as_echo_n "checking dependency style of $depcc... " >&6; }
+-if test "${am_cv_CXX_dependencies_compiler_type+set}" = set; then :
+-  $as_echo_n "(cached) " >&6
+-else
+-  if test -z "$AMDEP_TRUE" && test -f "$am_depcomp"; then
+-  # We make a subdir and do the tests there.  Otherwise we can end up
+-  # making bogus files that we don't know about and never remove.  For
+-  # instance it was reported that on HP-UX the gcc test will end up
+-  # making a dummy file named `D' -- because `-MD' means `put the output
+-  # in D'.
+-  mkdir conftest.dir
+-  # Copy depcomp to subdir because otherwise we won't find it if we're
+-  # using a relative directory.
+-  cp "$am_depcomp" conftest.dir
+-  cd conftest.dir
+-  # We will build objects and dependencies in a subdirectory because
+-  # it helps to detect inapplicable dependency modes.  For instance
+-  # both Tru64's cc and ICC support -MD to output dependencies as a
+-  # side effect of compilation, but ICC will put the dependencies in
+-  # the current directory while Tru64 will put them in the object
+-  # directory.
+-  mkdir sub
+-
+-  am_cv_CXX_dependencies_compiler_type=none
+-  if test "$am_compiler_list" = ""; then
+-     am_compiler_list=`sed -n 's/^#*\([a-zA-Z0-9]*\))$/\1/p' < ./depcomp`
+-  fi
+-  am__universal=false
+-  case " $depcc " in #(
+-     *\ -arch\ *\ -arch\ *) am__universal=true ;;
+-     esac
+-
+-  for depmode in $am_compiler_list; do
+-    # Setup a source with many dependencies, because some compilers
+-    # like to wrap large dependency lists on column 80 (with \), and
+-    # we should not choose a depcomp mode which is confused by this.
+-    #
+-    # We need to recreate these files for each test, as the compiler may
+-    # overwrite some of them when testing with obscure command lines.
+-    # This happens at least with the AIX C compiler.
+-    : > sub/conftest.c
+-    for i in 1 2 3 4 5 6; do
+-      echo '#include "conftst'$i'.h"' >> sub/conftest.c
+-      # Using `: > sub/conftst$i.h' creates only sub/conftst1.h with
+-      # Solaris 8's {/usr,}/bin/sh.
+-      touch sub/conftst$i.h
+-    done
+-    echo "${am__include} ${am__quote}sub/conftest.Po${am__quote}" > confmf
+-
+-    # We check with `-c' and `-o' for the sake of the "dashmstdout"
+-    # mode.  It turns out that the SunPro C++ compiler does not properly
+-    # handle `-M -o', and we need to detect this.  Also, some Intel
+-    # versions had trouble with output in subdirs
+-    am__obj=sub/conftest.${OBJEXT-o}
+-    am__minus_obj="-o $am__obj"
+-    case $depmode in
+-    gcc)
+-      # This depmode causes a compiler race in universal mode.
+-      test "$am__universal" = false || continue
+-      ;;
+-    nosideeffect)
+-      # after this tag, mechanisms are not by side-effect, so they'll
+-      # only be used when explicitly requested
+-      if test "x$enable_dependency_tracking" = xyes; then
+-	continue
+-      else
+-	break
+-      fi
+-      ;;
+-    msvisualcpp | msvcmsys)
+-      # This compiler won't grok `-c -o', but also, the minuso test has
+-      # not run yet.  These depmodes are late enough in the game, and
+-      # so weak that their functioning should not be impacted.
+-      am__obj=conftest.${OBJEXT-o}
+-      am__minus_obj=
+-      ;;
+-    none) break ;;
+-    esac
+-    if depmode=$depmode \
+-       source=sub/conftest.c object=$am__obj \
+-       depfile=sub/conftest.Po tmpdepfile=sub/conftest.TPo \
+-       $SHELL ./depcomp $depcc -c $am__minus_obj sub/conftest.c \
+-         >/dev/null 2>conftest.err &&
+-       grep sub/conftst1.h sub/conftest.Po > /dev/null 2>&1 &&
+-       grep sub/conftst6.h sub/conftest.Po > /dev/null 2>&1 &&
+-       grep $am__obj sub/conftest.Po > /dev/null 2>&1 &&
+-       ${MAKE-make} -s -f confmf > /dev/null 2>&1; then
+-      # icc doesn't choke on unknown options, it will just issue warnings
+-      # or remarks (even with -Werror).  So we grep stderr for any message
+-      # that says an option was ignored or not supported.
+-      # When given -MP, icc 7.0 and 7.1 complain thusly:
+-      #   icc: Command line warning: ignoring option '-M'; no argument required
+-      # The diagnosis changed in icc 8.0:
+-      #   icc: Command line remark: option '-MP' not supported
+-      if (grep 'ignoring option' conftest.err ||
+-          grep 'not supported' conftest.err) >/dev/null 2>&1; then :; else
+-        am_cv_CXX_dependencies_compiler_type=$depmode
+-        break
+-      fi
+-    fi
+-  done
+-
+-  cd ..
+-  rm -rf conftest.dir
+-else
+-  am_cv_CXX_dependencies_compiler_type=none
+-fi
+-
+-fi
+-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $am_cv_CXX_dependencies_compiler_type" >&5
+-$as_echo "$am_cv_CXX_dependencies_compiler_type" >&6; }
+-CXXDEPMODE=depmode=$am_cv_CXX_dependencies_compiler_type
+-
+- if
+-  test "x$enable_dependency_tracking" != xno \
+-  && test "$am_cv_CXX_dependencies_compiler_type" = gcc3; then
+-  am__fastdepCXX_TRUE=
+-  am__fastdepCXX_FALSE='#'
+-else
+-  am__fastdepCXX_TRUE='#'
+-  am__fastdepCXX_FALSE=
+-fi
+-
+-
+-
+-if test -n "$ac_tool_prefix"; then
+-  # Extract the first word of "${ac_tool_prefix}ranlib", so it can be a program name with args.
+-set dummy ${ac_tool_prefix}ranlib; ac_word=$2
+-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for $ac_word" >&5
+-$as_echo_n "checking for $ac_word... " >&6; }
+-if test "${ac_cv_prog_RANLIB+set}" = set; then :
+-  $as_echo_n "(cached) " >&6
+-else
+-  if test -n "$RANLIB"; then
+-  ac_cv_prog_RANLIB="$RANLIB" # Let the user override the test.
+-else
+-as_save_IFS=$IFS; IFS=$PATH_SEPARATOR
+-for as_dir in $PATH
+-do
+-  IFS=$as_save_IFS
+-  test -z "$as_dir" && as_dir=.
+-    for ac_exec_ext in '' $ac_executable_extensions; do
+-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
+-    ac_cv_prog_RANLIB="${ac_tool_prefix}ranlib"
+-    $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
+-    break 2
+-  fi
+-done
+-  done
+-IFS=$as_save_IFS
+-
+-fi
+-fi
+-RANLIB=$ac_cv_prog_RANLIB
+-if test -n "$RANLIB"; then
+-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: $RANLIB" >&5
+-$as_echo "$RANLIB" >&6; }
+-else
+-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
+-$as_echo "no" >&6; }
+-fi
+-
+-
+-fi
+-if test -z "$ac_cv_prog_RANLIB"; then
+-  ac_ct_RANLIB=$RANLIB
+-  # Extract the first word of "ranlib", so it can be a program name with args.
+-set dummy ranlib; ac_word=$2
+-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for $ac_word" >&5
+-$as_echo_n "checking for $ac_word... " >&6; }
+-if test "${ac_cv_prog_ac_ct_RANLIB+set}" = set; then :
+-  $as_echo_n "(cached) " >&6
+-else
+-  if test -n "$ac_ct_RANLIB"; then
+-  ac_cv_prog_ac_ct_RANLIB="$ac_ct_RANLIB" # Let the user override the test.
+-else
+-as_save_IFS=$IFS; IFS=$PATH_SEPARATOR
+-for as_dir in $PATH
+-do
+-  IFS=$as_save_IFS
+-  test -z "$as_dir" && as_dir=.
+-    for ac_exec_ext in '' $ac_executable_extensions; do
+-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
+-    ac_cv_prog_ac_ct_RANLIB="ranlib"
+-    $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
+-    break 2
+-  fi
+-done
+-  done
+-IFS=$as_save_IFS
+-
+-fi
+-fi
+-ac_ct_RANLIB=$ac_cv_prog_ac_ct_RANLIB
+-if test -n "$ac_ct_RANLIB"; then
+-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_ct_RANLIB" >&5
+-$as_echo "$ac_ct_RANLIB" >&6; }
+-else
+-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
+-$as_echo "no" >&6; }
+-fi
+-
+-  if test "x$ac_ct_RANLIB" = x; then
+-    RANLIB=":"
+-  else
+-    case $cross_compiling:$ac_tool_warned in
+-yes:)
+-{ $as_echo "$as_me:${as_lineno-$LINENO}: WARNING: using cross tools not prefixed with host triplet" >&5
+-$as_echo "$as_me: WARNING: using cross tools not prefixed with host triplet" >&2;}
+-ac_tool_warned=yes ;;
+-esac
+-    RANLIB=$ac_ct_RANLIB
+-  fi
+-else
+-  RANLIB="$ac_cv_prog_RANLIB"
+-fi
+-
+-
+-if test x$host = xi386-pc-os2-emx ; then
+-    CXXFLAGS="$CXXFLAGS -Zmt"
+-    LDFLAGS="$LDFLAGS -Zomf -Zmt"
+-    LIBS="$LIBS -los2me"
+-fi
+-
+-SDL_VERSION=1.2.0
+-
+-
+-# Check whether --with-sdl-prefix was given.
+-if test "${with_sdl_prefix+set}" = set; then :
+-  withval=$with_sdl_prefix; sdl_prefix="$withval"
+-else
+-  sdl_prefix=""
+-fi
+-
+-
+-# Check whether --with-sdl-exec-prefix was given.
+-if test "${with_sdl_exec_prefix+set}" = set; then :
+-  withval=$with_sdl_exec_prefix; sdl_exec_prefix="$withval"
+-else
+-  sdl_exec_prefix=""
+-fi
+-
+-# Check whether --enable-sdltest was given.
+-if test "${enable_sdltest+set}" = set; then :
+-  enableval=$enable_sdltest;
+-else
+-  enable_sdltest=yes
+-fi
+-
+-
+-  if test x$sdl_exec_prefix != x ; then
+-     sdl_args="$sdl_args --exec-prefix=$sdl_exec_prefix"
+-     if test x${SDL_CONFIG+set} != xset ; then
+-        SDL_CONFIG=$"pkg-config sdl"
+-     fi
+-  fi
+-  if test x$sdl_prefix != x ; then
+-     sdl_args="$sdl_args --prefix=$sdl_prefix"
+-     if test x${SDL_CONFIG+set} != xset ; then
+-        SDL_CONFIG=$"pkg-config sdl"
+-     fi
+-  fi
+-
+-  # Extract the first word of "sdl-config", so it can be a program name with args.
+-set dummy "pkg-conf sdl"; ac_word=$2
+-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for $ac_word" >&5
+-$as_echo_n "checking for $ac_word... " >&6; }
+-if test "${ac_cv_path_SDL_CONFIG+set}" = set; then :
+-  $as_echo_n "(cached) " >&6
+-else
+-  case $SDL_CONFIG in
+-  [\\/]* | ?:[\\/]*)
+-  ac_cv_path_SDL_CONFIG="$SDL_CONFIG" # Let the user override the test with a path.
+-  ;;
+-  *)
+-  as_save_IFS=$IFS; IFS=$PATH_SEPARATOR
+-for as_dir in $PATH
+-do
+-  IFS=$as_save_IFS
+-  test -z "$as_dir" && as_dir=.
+-    for ac_exec_ext in '' $ac_executable_extensions; do
+-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
+-    ac_cv_path_SDL_CONFIG="$as_dir/$ac_word$ac_exec_ext"
+-    $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
+-    break 2
+-  fi
+-done
+-  done
+-IFS=$as_save_IFS
+-
+-  test -z "$ac_cv_path_SDL_CONFIG" && ac_cv_path_SDL_CONFIG="no"
+-  ;;
+-esac
+-fi
+-SDL_CONFIG=$ac_cv_path_SDL_CONFIG
+-if test -n "$SDL_CONFIG"; then
+-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: $SDL_CONFIG" >&5
+-$as_echo "$SDL_CONFIG" >&6; }
+-else
+-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
+-$as_echo "no" >&6; }
+-fi
+-
+-
+-  min_sdl_version=$SDL_VERSION
+-  { $as_echo "$as_me:${as_lineno-$LINENO}: checking for SDL - version >= $min_sdl_version" >&5
+-$as_echo_n "checking for SDL - version >= $min_sdl_version... " >&6; }
+-  no_sdl=""
+-  if test "$SDL_CONFIG" = "no" ; then
+-    no_sdl=yes
+-  else
+-    SDL_CFLAGS=`pkg-config sdl --cflags`
+-    SDL_LIBS=`pkg-config sdl --libs`
+-
+-    sdl_major_version=`$SDL_CONFIG $sdl_args --version | \
+-           sed 's/\([0-9]*\).\([0-9]*\).\([0-9]*\)/\1/'`
+-    sdl_minor_version=`$SDL_CONFIG $sdl_args --version | \
+-           sed 's/\([0-9]*\).\([0-9]*\).\([0-9]*\)/\2/'`
+-    sdl_micro_version=`$SDL_CONFIG $sdl_config_args --version | \
+-           sed 's/\([0-9]*\).\([0-9]*\).\([0-9]*\)/\3/'`
+-    if test "x$enable_sdltest" = "xyes" ; then
+-      ac_save_CFLAGS="$CFLAGS"
+-      ac_save_LIBS="$LIBS"
+-      CFLAGS="$CFLAGS $SDL_CFLAGS"
+-      LIBS="$LIBS $SDL_LIBS"
+-      rm -f conf.sdltest
+-      if test "$cross_compiling" = yes; then :
+-  echo $ac_n "cross compiling; assumed OK... $ac_c"
+-else
+-  cat confdefs.h - <<_ACEOF >conftest.$ac_ext
+-/* end confdefs.h.  */
+-
+-#include <stdio.h>
+-#include <stdlib.h>
+-#include <string.h>
+-#include "SDL.h"
+-
+-char*
+-my_strdup (char *str)
+-{
+-  char *new_str;
+-
+-  if (str)
+-    {
+-      new_str = (char *)malloc ((strlen (str) + 1) * sizeof(char));
+-      strcpy (new_str, str);
+-    }
+-  else
+-    new_str = NULL;
+-
+-  return new_str;
+-}
+-
+-int main (int argc, char *argv[])
+-{
+-  int major, minor, micro;
+-  char *tmp_version;
+-
+-  /* This hangs on some systems (?)
+-  system ("touch conf.sdltest");
+-  */
+-  { FILE *fp = fopen("conf.sdltest", "a"); if ( fp ) fclose(fp); }
+-
+-  /* HP/UX 9 (%@#!) writes to sscanf strings */
+-  tmp_version = my_strdup("$min_sdl_version");
+-  if (sscanf(tmp_version, "%d.%d.%d", &major, &minor, &micro) != 3) {
+-     printf("%s, bad version string\n", "$min_sdl_version");
+-     exit(1);
+-   }
+-
+-   if (($sdl_major_version > major) ||
+-      (($sdl_major_version == major) && ($sdl_minor_version > minor)) ||
+-      (($sdl_major_version == major) && ($sdl_minor_version == minor) && ($sdl_micro_version >= micro)))
+-    {
+-      return 0;
+-    }
+-  else
+-    {
+-      printf("\n*** 'sdl-config --version' returned %d.%d.%d, but the minimum version\n", $sdl_major_version, $sdl_minor_version, $sdl_micro_version);
+-      printf("*** of SDL required is %d.%d.%d. If sdl-config is correct, then it is\n", major, minor, micro);
+-      printf("*** best to upgrade to the required version.\n");
+-      printf("*** If sdl-config was wrong, set the environment variable SDL_CONFIG\n");
+-      printf("*** to point to the correct copy of sdl-config, and remove the file\n");
+-      printf("*** config.cache before re-running configure\n");
+-      return 1;
+-    }
+-}
+-
+-
+-_ACEOF
+-if ac_fn_c_try_run "$LINENO"; then :
+-
+-else
+-  no_sdl=yes
+-fi
+-rm -f core *.core core.conftest.* gmon.out bb.out conftest$ac_exeext \
+-  conftest.$ac_objext conftest.beam conftest.$ac_ext
+-fi
+-
+-       CFLAGS="$ac_save_CFLAGS"
+-       LIBS="$ac_save_LIBS"
+-     fi
+-  fi
+-  if test "x$no_sdl" = x ; then
+-     { $as_echo "$as_me:${as_lineno-$LINENO}: result: yes" >&5
+-$as_echo "yes" >&6; }
+-     :
+-  else
+-     { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
+-$as_echo "no" >&6; }
+-     if test "$SDL_CONFIG" = "no" ; then
+-       echo "*** The sdl-config script installed by SDL could not be found"
+-       echo "*** If SDL was installed in PREFIX, make sure PREFIX/bin is in"
+-       echo "*** your path, or set the SDL_CONFIG environment variable to the"
+-       echo "*** full path to sdl-config."
+-     else
+-       if test -f conf.sdltest ; then
+-        :
+-       else
+-          echo "*** Could not run SDL test program, checking why..."
+-          CFLAGS="$CFLAGS $SDL_CFLAGS"
+-          LIBS="$LIBS $SDL_LIBS"
+-          cat confdefs.h - <<_ACEOF >conftest.$ac_ext
+-/* end confdefs.h.  */
+-
+-#include <stdio.h>
+-#include "SDL.h"
+-
+-int
+-main ()
+-{
+- return 0;
+-  ;
+-  return 0;
+-}
+-_ACEOF
+-if ac_fn_c_try_link "$LINENO"; then :
+-   echo "*** The test program compiled, but did not run. This usually means"
+-          echo "*** that the run-time linker is not finding SDL or finding the wrong"
+-          echo "*** version of SDL. If it is not finding SDL, you'll need to set your"
+-          echo "*** LD_LIBRARY_PATH environment variable, or edit /etc/ld.so.conf to point"
+-          echo "*** to the installed location  Also, make sure you have run ldconfig if that"
+-          echo "*** is required on your system"
+-	  echo "***"
+-          echo "*** If you have an old version installed, it is best to remove it, although"
+-          echo "*** you may also be able to get things to work by modifying LD_LIBRARY_PATH"
+-else
+-   echo "*** The test program failed to compile or link. See the file config.log for the"
+-          echo "*** exact error that occured. This usually means SDL was incorrectly installed"
+-          echo "*** or that you have moved SDL since it was installed. In the latter case, you"
+-          echo "*** may want to edit the sdl-config script: $SDL_CONFIG"
+-fi
+-rm -f core conftest.err conftest.$ac_objext \
+-    conftest$ac_exeext conftest.$ac_ext
+-          CFLAGS="$ac_save_CFLAGS"
+-          LIBS="$ac_save_LIBS"
+-       fi
+-     fi
+-     SDL_CFLAGS=""
+-     SDL_LIBS=""
+-     as_fn_error "*** SDL version $SDL_VERSION not found!" "$LINENO" 5
+-
+-  fi
+-
+-
+-  rm -f conf.sdltest
+-
+-LIBS="$LIBS $SDL_LIBS"
+-CPPFLAGS="$CPPFLAGS $SDL_CFLAGS"
+-
+-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking SDL version only being 1.2.X" >&5
+-$as_echo_n "checking SDL version only being 1.2.X... " >&6; }
+-cat confdefs.h - <<_ACEOF >conftest.$ac_ext
+-/* end confdefs.h.  */
+-
+-#include "SDL.h"
+-void blah(){
+-#if SDL_MINOR_VERSION != 2
+-#error "Only SDL 1.2 supported"
+-#endif
+-;
+-}
+-
+-_ACEOF
+-if ac_fn_c_try_compile "$LINENO"; then :
+-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: yes" >&5
+-$as_echo "yes" >&6; }
+-else
+-
+- { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
+-$as_echo "no" >&6; }
+- as_fn_error "Only libSDL 1.2.X supported" "$LINENO" 5
+-fi
+-rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
+-
+-
+-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for an ANSI C-conforming const" >&5
+-$as_echo_n "checking for an ANSI C-conforming const... " >&6; }
+-if test "${ac_cv_c_const+set}" = set; then :
+-  $as_echo_n "(cached) " >&6
+-else
+-  cat confdefs.h - <<_ACEOF >conftest.$ac_ext
+-/* end confdefs.h.  */
+-
+-int
+-main ()
+-{
+-/* FIXME: Include the comments suggested by Paul. */
+-#ifndef __cplusplus
+-  /* Ultrix mips cc rejects this.  */
+-  typedef int charset[2];
+-  const charset cs;
+-  /* SunOS 4.1.1 cc rejects this.  */
+-  char const *const *pcpcc;
+-  char **ppc;
+-  /* NEC SVR4.0.2 mips cc rejects this.  */
+-  struct point {int x, y;};
+-  static struct point const zero = {0,0};
+-  /* AIX XL C 1.02.0.0 rejects this.
+-     It does not let you subtract one const X* pointer from another in
+-     an arm of an if-expression whose if-part is not a constant
+-     expression */
+-  const char *g = "string";
+-  pcpcc = &g + (g ? g-g : 0);
+-  /* HPUX 7.0 cc rejects these. */
+-  ++pcpcc;
+-  ppc = (char**) pcpcc;
+-  pcpcc = (char const *const *) ppc;
+-  { /* SCO 3.2v4 cc rejects this.  */
+-    char *t;
+-    char const *s = 0 ? (char *) 0 : (char const *) 0;
+-
+-    *t++ = 0;
+-    if (s) return 0;
+-  }
+-  { /* Someone thinks the Sun supposedly-ANSI compiler will reject this.  */
+-    int x[] = {25, 17};
+-    const int *foo = &x[0];
+-    ++foo;
+-  }
+-  { /* Sun SC1.0 ANSI compiler rejects this -- but not the above. */
+-    typedef const int *iptr;
+-    iptr p = 0;
+-    ++p;
+-  }
+-  { /* AIX XL C 1.02.0.0 rejects this saying
+-       "k.c", line 2.27: 1506-025 (S) Operand must be a modifiable lvalue. */
+-    struct s { int j; const int *ap[3]; };
+-    struct s *b; b->j = 5;
+-  }
+-  { /* ULTRIX-32 V3.1 (Rev 9) vcc rejects this */
+-    const int foo = 10;
+-    if (!foo) return 0;
+-  }
+-  return !cs[0] && !zero.x;
+-#endif
+-
+-  ;
+-  return 0;
+-}
+-_ACEOF
+-if ac_fn_c_try_compile "$LINENO"; then :
+-  ac_cv_c_const=yes
+-else
+-  ac_cv_c_const=no
+-fi
+-rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
+-fi
+-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_c_const" >&5
+-$as_echo "$ac_cv_c_const" >&6; }
+-if test $ac_cv_c_const = no; then
+-
+-$as_echo "#define const /**/" >>confdefs.h
+-
+-fi
+-
+-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for inline" >&5
+-$as_echo_n "checking for inline... " >&6; }
+-if test "${ac_cv_c_inline+set}" = set; then :
+-  $as_echo_n "(cached) " >&6
+-else
+-  ac_cv_c_inline=no
+-for ac_kw in inline __inline__ __inline; do
+-  cat confdefs.h - <<_ACEOF >conftest.$ac_ext
+-/* end confdefs.h.  */
+-#ifndef __cplusplus
+-typedef int foo_t;
+-static $ac_kw foo_t static_foo () {return 0; }
+-$ac_kw foo_t foo () {return 0; }
+-#endif
+-
+-_ACEOF
+-if ac_fn_c_try_compile "$LINENO"; then :
+-  ac_cv_c_inline=$ac_kw
+-fi
+-rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
+-  test "$ac_cv_c_inline" != no && break
+-done
+-
+-fi
+-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_c_inline" >&5
+-$as_echo "$ac_cv_c_inline" >&6; }
+-
+-case $ac_cv_c_inline in
+-  inline | yes) ;;
+-  *)
+-    case $ac_cv_c_inline in
+-      no) ac_val=;;
+-      *) ac_val=$ac_cv_c_inline;;
+-    esac
+-    cat >>confdefs.h <<_ACEOF
+-#ifndef __cplusplus
+-#define inline $ac_val
+-#endif
+-_ACEOF
+-    ;;
+-esac
+-
+-
+-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for grep that handles long lines and -e" >&5
+-$as_echo_n "checking for grep that handles long lines and -e... " >&6; }
+-if test "${ac_cv_path_GREP+set}" = set; then :
+-  $as_echo_n "(cached) " >&6
+-else
+-  if test -z "$GREP"; then
+-  ac_path_GREP_found=false
+-  # Loop through the user's path and test for each of PROGNAME-LIST
+-  as_save_IFS=$IFS; IFS=$PATH_SEPARATOR
+-for as_dir in $PATH$PATH_SEPARATOR/usr/xpg4/bin
+-do
+-  IFS=$as_save_IFS
+-  test -z "$as_dir" && as_dir=.
+-    for ac_prog in grep ggrep; do
+-    for ac_exec_ext in '' $ac_executable_extensions; do
+-      ac_path_GREP="$as_dir/$ac_prog$ac_exec_ext"
+-      { test -f "$ac_path_GREP" && $as_test_x "$ac_path_GREP"; } || continue
+-# Check for GNU ac_path_GREP and select it if it is found.
+-  # Check for GNU $ac_path_GREP
+-case `"$ac_path_GREP" --version 2>&1` in
+-*GNU*)
+-  ac_cv_path_GREP="$ac_path_GREP" ac_path_GREP_found=:;;
+-*)
+-  ac_count=0
+-  $as_echo_n 0123456789 >"conftest.in"
+-  while :
+-  do
+-    cat "conftest.in" "conftest.in" >"conftest.tmp"
+-    mv "conftest.tmp" "conftest.in"
+-    cp "conftest.in" "conftest.nl"
+-    $as_echo 'GREP' >> "conftest.nl"
+-    "$ac_path_GREP" -e 'GREP$' -e '-(cannot match)-' < "conftest.nl" >"conftest.out" 2>/dev/null || break
+-    diff "conftest.out" "conftest.nl" >/dev/null 2>&1 || break
+-    as_fn_arith $ac_count + 1 && ac_count=$as_val
+-    if test $ac_count -gt ${ac_path_GREP_max-0}; then
+-      # Best one so far, save it but keep looking for a better one
+-      ac_cv_path_GREP="$ac_path_GREP"
+-      ac_path_GREP_max=$ac_count
+-    fi
+-    # 10*(2^10) chars as input seems more than enough
+-    test $ac_count -gt 10 && break
+-  done
+-  rm -f conftest.in conftest.tmp conftest.nl conftest.out;;
+-esac
+-
+-      $ac_path_GREP_found && break 3
+-    done
+-  done
+-  done
+-IFS=$as_save_IFS
+-  if test -z "$ac_cv_path_GREP"; then
+-    as_fn_error "no acceptable grep could be found in $PATH$PATH_SEPARATOR/usr/xpg4/bin" "$LINENO" 5
+-  fi
+-else
+-  ac_cv_path_GREP=$GREP
+-fi
+-
+-fi
+-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_path_GREP" >&5
+-$as_echo "$ac_cv_path_GREP" >&6; }
+- GREP="$ac_cv_path_GREP"
+-
+-
+-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for egrep" >&5
+-$as_echo_n "checking for egrep... " >&6; }
+-if test "${ac_cv_path_EGREP+set}" = set; then :
+-  $as_echo_n "(cached) " >&6
+-else
+-  if echo a | $GREP -E '(a|b)' >/dev/null 2>&1
+-   then ac_cv_path_EGREP="$GREP -E"
+-   else
+-     if test -z "$EGREP"; then
+-  ac_path_EGREP_found=false
+-  # Loop through the user's path and test for each of PROGNAME-LIST
+-  as_save_IFS=$IFS; IFS=$PATH_SEPARATOR
+-for as_dir in $PATH$PATH_SEPARATOR/usr/xpg4/bin
+-do
+-  IFS=$as_save_IFS
+-  test -z "$as_dir" && as_dir=.
+-    for ac_prog in egrep; do
+-    for ac_exec_ext in '' $ac_executable_extensions; do
+-      ac_path_EGREP="$as_dir/$ac_prog$ac_exec_ext"
+-      { test -f "$ac_path_EGREP" && $as_test_x "$ac_path_EGREP"; } || continue
+-# Check for GNU ac_path_EGREP and select it if it is found.
+-  # Check for GNU $ac_path_EGREP
+-case `"$ac_path_EGREP" --version 2>&1` in
+-*GNU*)
+-  ac_cv_path_EGREP="$ac_path_EGREP" ac_path_EGREP_found=:;;
+-*)
+-  ac_count=0
+-  $as_echo_n 0123456789 >"conftest.in"
+-  while :
+-  do
+-    cat "conftest.in" "conftest.in" >"conftest.tmp"
+-    mv "conftest.tmp" "conftest.in"
+-    cp "conftest.in" "conftest.nl"
+-    $as_echo 'EGREP' >> "conftest.nl"
+-    "$ac_path_EGREP" 'EGREP$' < "conftest.nl" >"conftest.out" 2>/dev/null || break
+-    diff "conftest.out" "conftest.nl" >/dev/null 2>&1 || break
+-    as_fn_arith $ac_count + 1 && ac_count=$as_val
+-    if test $ac_count -gt ${ac_path_EGREP_max-0}; then
+-      # Best one so far, save it but keep looking for a better one
+-      ac_cv_path_EGREP="$ac_path_EGREP"
+-      ac_path_EGREP_max=$ac_count
+-    fi
+-    # 10*(2^10) chars as input seems more than enough
+-    test $ac_count -gt 10 && break
+-  done
+-  rm -f conftest.in conftest.tmp conftest.nl conftest.out;;
+-esac
+-
+-      $ac_path_EGREP_found && break 3
+-    done
+-  done
+-  done
+-IFS=$as_save_IFS
+-  if test -z "$ac_cv_path_EGREP"; then
+-    as_fn_error "no acceptable egrep could be found in $PATH$PATH_SEPARATOR/usr/xpg4/bin" "$LINENO" 5
+-  fi
+-else
+-  ac_cv_path_EGREP=$EGREP
+-fi
+-
+-   fi
+-fi
+-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_path_EGREP" >&5
+-$as_echo "$ac_cv_path_EGREP" >&6; }
+- EGREP="$ac_cv_path_EGREP"
+-
+-
+-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for ANSI C header files" >&5
+-$as_echo_n "checking for ANSI C header files... " >&6; }
+-if test "${ac_cv_header_stdc+set}" = set; then :
+-  $as_echo_n "(cached) " >&6
+-else
+-  cat confdefs.h - <<_ACEOF >conftest.$ac_ext
+-/* end confdefs.h.  */
+-#include <stdlib.h>
+-#include <stdarg.h>
+-#include <string.h>
+-#include <float.h>
+-
+-int
+-main ()
+-{
+-
+-  ;
+-  return 0;
+-}
+-_ACEOF
+-if ac_fn_c_try_compile "$LINENO"; then :
+-  ac_cv_header_stdc=yes
+-else
+-  ac_cv_header_stdc=no
+-fi
+-rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
+-
+-if test $ac_cv_header_stdc = yes; then
+-  # SunOS 4.x string.h does not declare mem*, contrary to ANSI.
+-  cat confdefs.h - <<_ACEOF >conftest.$ac_ext
+-/* end confdefs.h.  */
+-#include <string.h>
+-
+-_ACEOF
+-if (eval "$ac_cpp conftest.$ac_ext") 2>&5 |
+-  $EGREP "memchr" >/dev/null 2>&1; then :
+-
+-else
+-  ac_cv_header_stdc=no
+-fi
+-rm -f conftest*
+-
+-fi
+-
+-if test $ac_cv_header_stdc = yes; then
+-  # ISC 2.0.2 stdlib.h does not declare free, contrary to ANSI.
+-  cat confdefs.h - <<_ACEOF >conftest.$ac_ext
+-/* end confdefs.h.  */
+-#include <stdlib.h>
+-
+-_ACEOF
+-if (eval "$ac_cpp conftest.$ac_ext") 2>&5 |
+-  $EGREP "free" >/dev/null 2>&1; then :
+-
+-else
+-  ac_cv_header_stdc=no
+-fi
+-rm -f conftest*
+-
+-fi
+-
+-if test $ac_cv_header_stdc = yes; then
+-  # /bin/cc in Irix-4.0.5 gets non-ANSI ctype macros unless using -ansi.
+-  if test "$cross_compiling" = yes; then :
+-  :
+-else
+-  cat confdefs.h - <<_ACEOF >conftest.$ac_ext
+-/* end confdefs.h.  */
+-#include <ctype.h>
+-#include <stdlib.h>
+-#if ((' ' & 0x0FF) == 0x020)
+-# define ISLOWER(c) ('a' <= (c) && (c) <= 'z')
+-# define TOUPPER(c) (ISLOWER(c) ? 'A' + ((c) - 'a') : (c))
+-#else
+-# define ISLOWER(c) \
+-		   (('a' <= (c) && (c) <= 'i') \
+-		     || ('j' <= (c) && (c) <= 'r') \
+-		     || ('s' <= (c) && (c) <= 'z'))
+-# define TOUPPER(c) (ISLOWER(c) ? ((c) | 0x40) : (c))
+-#endif
+-
+-#define XOR(e, f) (((e) && !(f)) || (!(e) && (f)))
+-int
+-main ()
+-{
+-  int i;
+-  for (i = 0; i < 256; i++)
+-    if (XOR (islower (i), ISLOWER (i))
+-	|| toupper (i) != TOUPPER (i))
+-      return 2;
+-  return 0;
+-}
+-_ACEOF
+-if ac_fn_c_try_run "$LINENO"; then :
+-
+-else
+-  ac_cv_header_stdc=no
+-fi
+-rm -f core *.core core.conftest.* gmon.out bb.out conftest$ac_exeext \
+-  conftest.$ac_objext conftest.beam conftest.$ac_ext
+-fi
+-
+-fi
+-fi
+-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_header_stdc" >&5
+-$as_echo "$ac_cv_header_stdc" >&6; }
+-if test $ac_cv_header_stdc = yes; then
+-
+-$as_echo "#define STDC_HEADERS 1" >>confdefs.h
+-
+-fi
+-
+-# On IRIX 5.3, sys/types and inttypes.h are conflicting.
+-for ac_header in sys/types.h sys/stat.h stdlib.h string.h memory.h strings.h \
+-		  inttypes.h stdint.h unistd.h
+-do :
+-  as_ac_Header=`$as_echo "ac_cv_header_$ac_header" | $as_tr_sh`
+-ac_fn_c_check_header_compile "$LINENO" "$ac_header" "$as_ac_Header" "$ac_includes_default
+-"
+-eval as_val=\$$as_ac_Header
+-   if test "x$as_val" = x""yes; then :
+-  cat >>confdefs.h <<_ACEOF
+-#define `$as_echo "HAVE_$ac_header" | $as_tr_cpp` 1
+-_ACEOF
+-
+-fi
+-
+-done
+-
+-
+-ac_fn_c_check_type "$LINENO" "size_t" "ac_cv_type_size_t" "$ac_includes_default"
+-if test "x$ac_cv_type_size_t" = x""yes; then :
+-
+-else
+-
+-cat >>confdefs.h <<_ACEOF
+-#define size_t unsigned int
+-_ACEOF
+-
+-fi
+-
+-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking whether struct tm is in sys/time.h or time.h" >&5
+-$as_echo_n "checking whether struct tm is in sys/time.h or time.h... " >&6; }
+-if test "${ac_cv_struct_tm+set}" = set; then :
+-  $as_echo_n "(cached) " >&6
+-else
+-  cat confdefs.h - <<_ACEOF >conftest.$ac_ext
+-/* end confdefs.h.  */
+-#include <sys/types.h>
+-#include <time.h>
+-
+-int
+-main ()
+-{
+-struct tm tm;
+-				     int *p = &tm.tm_sec;
+-				     return !p;
+-  ;
+-  return 0;
+-}
+-_ACEOF
+-if ac_fn_c_try_compile "$LINENO"; then :
+-  ac_cv_struct_tm=time.h
+-else
+-  ac_cv_struct_tm=sys/time.h
+-fi
+-rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
+-fi
+-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_struct_tm" >&5
+-$as_echo "$ac_cv_struct_tm" >&6; }
+-if test $ac_cv_struct_tm = sys/time.h; then
+-
+-$as_echo "#define TM_IN_SYS_TIME 1" >>confdefs.h
+-
+-fi
+-
+-# The cast to long int works around a bug in the HP C Compiler
+-# version HP92453-01 B.11.11.23709.GP, which incorrectly rejects
+-# declarations like `int a3[[(sizeof (unsigned char)) >= 0]];'.
+-# This bug is HP SR number 8606223364.
+-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking size of unsigned char" >&5
+-$as_echo_n "checking size of unsigned char... " >&6; }
+-if test "${ac_cv_sizeof_unsigned_char+set}" = set; then :
+-  $as_echo_n "(cached) " >&6
+-else
+-  if ac_fn_c_compute_int "$LINENO" "(long int) (sizeof (unsigned char))" "ac_cv_sizeof_unsigned_char"        "$ac_includes_default"; then :
+-
+-else
+-  if test "$ac_cv_type_unsigned_char" = yes; then
+-     { { $as_echo "$as_me:${as_lineno-$LINENO}: error: in \`$ac_pwd':" >&5
+-$as_echo "$as_me: error: in \`$ac_pwd':" >&2;}
+-{ as_fn_set_status 77
+-as_fn_error "cannot compute sizeof (unsigned char)
+-See \`config.log' for more details." "$LINENO" 5; }; }
+-   else
+-     ac_cv_sizeof_unsigned_char=0
+-   fi
+-fi
+-
+-fi
+-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_sizeof_unsigned_char" >&5
+-$as_echo "$ac_cv_sizeof_unsigned_char" >&6; }
+-
+-
+-
+-cat >>confdefs.h <<_ACEOF
+-#define SIZEOF_UNSIGNED_CHAR $ac_cv_sizeof_unsigned_char
+-_ACEOF
+-
+-
+-# The cast to long int works around a bug in the HP C Compiler
+-# version HP92453-01 B.11.11.23709.GP, which incorrectly rejects
+-# declarations like `int a3[[(sizeof (unsigned char)) >= 0]];'.
+-# This bug is HP SR number 8606223364.
+-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking size of unsigned short" >&5
+-$as_echo_n "checking size of unsigned short... " >&6; }
+-if test "${ac_cv_sizeof_unsigned_short+set}" = set; then :
+-  $as_echo_n "(cached) " >&6
+-else
+-  if ac_fn_c_compute_int "$LINENO" "(long int) (sizeof (unsigned short))" "ac_cv_sizeof_unsigned_short"        "$ac_includes_default"; then :
+-
+-else
+-  if test "$ac_cv_type_unsigned_short" = yes; then
+-     { { $as_echo "$as_me:${as_lineno-$LINENO}: error: in \`$ac_pwd':" >&5
+-$as_echo "$as_me: error: in \`$ac_pwd':" >&2;}
+-{ as_fn_set_status 77
+-as_fn_error "cannot compute sizeof (unsigned short)
+-See \`config.log' for more details." "$LINENO" 5; }; }
+-   else
+-     ac_cv_sizeof_unsigned_short=0
+-   fi
+-fi
+-
+-fi
+-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_sizeof_unsigned_short" >&5
+-$as_echo "$ac_cv_sizeof_unsigned_short" >&6; }
+-
+-
+-
+-cat >>confdefs.h <<_ACEOF
+-#define SIZEOF_UNSIGNED_SHORT $ac_cv_sizeof_unsigned_short
+-_ACEOF
+-
+-
+-# The cast to long int works around a bug in the HP C Compiler
+-# version HP92453-01 B.11.11.23709.GP, which incorrectly rejects
+-# declarations like `int a3[[(sizeof (unsigned char)) >= 0]];'.
+-# This bug is HP SR number 8606223364.
+-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking size of unsigned int" >&5
+-$as_echo_n "checking size of unsigned int... " >&6; }
+-if test "${ac_cv_sizeof_unsigned_int+set}" = set; then :
+-  $as_echo_n "(cached) " >&6
+-else
+-  if ac_fn_c_compute_int "$LINENO" "(long int) (sizeof (unsigned int))" "ac_cv_sizeof_unsigned_int"        "$ac_includes_default"; then :
+-
+-else
+-  if test "$ac_cv_type_unsigned_int" = yes; then
+-     { { $as_echo "$as_me:${as_lineno-$LINENO}: error: in \`$ac_pwd':" >&5
+-$as_echo "$as_me: error: in \`$ac_pwd':" >&2;}
+-{ as_fn_set_status 77
+-as_fn_error "cannot compute sizeof (unsigned int)
+-See \`config.log' for more details." "$LINENO" 5; }; }
+-   else
+-     ac_cv_sizeof_unsigned_int=0
+-   fi
+-fi
+-
+-fi
+-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_sizeof_unsigned_int" >&5
+-$as_echo "$ac_cv_sizeof_unsigned_int" >&6; }
+-
+-
+-
+-cat >>confdefs.h <<_ACEOF
+-#define SIZEOF_UNSIGNED_INT $ac_cv_sizeof_unsigned_int
+-_ACEOF
+-
+-
+-# The cast to long int works around a bug in the HP C Compiler
+-# version HP92453-01 B.11.11.23709.GP, which incorrectly rejects
+-# declarations like `int a3[[(sizeof (unsigned char)) >= 0]];'.
+-# This bug is HP SR number 8606223364.
+-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking size of unsigned long" >&5
+-$as_echo_n "checking size of unsigned long... " >&6; }
+-if test "${ac_cv_sizeof_unsigned_long+set}" = set; then :
+-  $as_echo_n "(cached) " >&6
+-else
+-  if ac_fn_c_compute_int "$LINENO" "(long int) (sizeof (unsigned long))" "ac_cv_sizeof_unsigned_long"        "$ac_includes_default"; then :
+-
+-else
+-  if test "$ac_cv_type_unsigned_long" = yes; then
+-     { { $as_echo "$as_me:${as_lineno-$LINENO}: error: in \`$ac_pwd':" >&5
+-$as_echo "$as_me: error: in \`$ac_pwd':" >&2;}
+-{ as_fn_set_status 77
+-as_fn_error "cannot compute sizeof (unsigned long)
+-See \`config.log' for more details." "$LINENO" 5; }; }
+-   else
+-     ac_cv_sizeof_unsigned_long=0
+-   fi
+-fi
+-
+-fi
+-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_sizeof_unsigned_long" >&5
+-$as_echo "$ac_cv_sizeof_unsigned_long" >&6; }
+-
+-
+-
+-cat >>confdefs.h <<_ACEOF
+-#define SIZEOF_UNSIGNED_LONG $ac_cv_sizeof_unsigned_long
+-_ACEOF
+-
+-
+-# The cast to long int works around a bug in the HP C Compiler
+-# version HP92453-01 B.11.11.23709.GP, which incorrectly rejects
+-# declarations like `int a3[[(sizeof (unsigned char)) >= 0]];'.
+-# This bug is HP SR number 8606223364.
+-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking size of unsigned long long" >&5
+-$as_echo_n "checking size of unsigned long long... " >&6; }
+-if test "${ac_cv_sizeof_unsigned_long_long+set}" = set; then :
+-  $as_echo_n "(cached) " >&6
+-else
+-  if ac_fn_c_compute_int "$LINENO" "(long int) (sizeof (unsigned long long))" "ac_cv_sizeof_unsigned_long_long"        "$ac_includes_default"; then :
+-
+-else
+-  if test "$ac_cv_type_unsigned_long_long" = yes; then
+-     { { $as_echo "$as_me:${as_lineno-$LINENO}: error: in \`$ac_pwd':" >&5
+-$as_echo "$as_me: error: in \`$ac_pwd':" >&2;}
+-{ as_fn_set_status 77
+-as_fn_error "cannot compute sizeof (unsigned long long)
+-See \`config.log' for more details." "$LINENO" 5; }; }
+-   else
+-     ac_cv_sizeof_unsigned_long_long=0
+-   fi
+-fi
+-
+-fi
+-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_sizeof_unsigned_long_long" >&5
+-$as_echo "$ac_cv_sizeof_unsigned_long_long" >&6; }
+-
+-
+-
+-cat >>confdefs.h <<_ACEOF
+-#define SIZEOF_UNSIGNED_LONG_LONG $ac_cv_sizeof_unsigned_long_long
+-_ACEOF
+-
+-
+-# The cast to long int works around a bug in the HP C Compiler
+-# version HP92453-01 B.11.11.23709.GP, which incorrectly rejects
+-# declarations like `int a3[[(sizeof (unsigned char)) >= 0]];'.
+-# This bug is HP SR number 8606223364.
+-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking size of int *" >&5
+-$as_echo_n "checking size of int *... " >&6; }
+-if test "${ac_cv_sizeof_int_p+set}" = set; then :
+-  $as_echo_n "(cached) " >&6
+-else
+-  if ac_fn_c_compute_int "$LINENO" "(long int) (sizeof (int *))" "ac_cv_sizeof_int_p"        "$ac_includes_default"; then :
+-
+-else
+-  if test "$ac_cv_type_int_p" = yes; then
+-     { { $as_echo "$as_me:${as_lineno-$LINENO}: error: in \`$ac_pwd':" >&5
+-$as_echo "$as_me: error: in \`$ac_pwd':" >&2;}
+-{ as_fn_set_status 77
+-as_fn_error "cannot compute sizeof (int *)
+-See \`config.log' for more details." "$LINENO" 5; }; }
+-   else
+-     ac_cv_sizeof_int_p=0
+-   fi
+-fi
+-
+-fi
+-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_sizeof_int_p" >&5
+-$as_echo "$ac_cv_sizeof_int_p" >&6; }
+-
+-
+-
+-cat >>confdefs.h <<_ACEOF
+-#define SIZEOF_INT_P $ac_cv_sizeof_int_p
+-_ACEOF
+-
+-
+-
+-for ac_header in stdlib.h sys/types.h
+-do :
+-  as_ac_Header=`$as_echo "ac_cv_header_$ac_header" | $as_tr_sh`
+-ac_fn_c_check_header_mongrel "$LINENO" "$ac_header" "$as_ac_Header" "$ac_includes_default"
+-eval as_val=\$$as_ac_Header
+-   if test "x$as_val" = x""yes; then :
+-  cat >>confdefs.h <<_ACEOF
+-#define `$as_echo "HAVE_$ac_header" | $as_tr_cpp` 1
+-_ACEOF
+-
+-fi
+-
+-done
+-
+-for ac_header in sys/socket.h  netinet/in.h pwd.h
+-do :
+-  as_ac_Header=`$as_echo "ac_cv_header_$ac_header" | $as_tr_sh`
+-ac_fn_c_check_header_compile "$LINENO" "$ac_header" "$as_ac_Header" "#include <stdio.h>
+-#ifdef STDC_HEADERS
+-# include <stdlib.h>
+-# include <stddef.h>
+-#else
+-# ifdef HAVE_STDLIB_H
+-#  include <stdlib.h>
+-# endif
+-#endif
+-#ifdef HAVE_SYS_TYPES_H
+-# include <sys/types.h>
+-#endif
+-
+-"
+-eval as_val=\$$as_ac_Header
+-   if test "x$as_val" = x""yes; then :
+-  cat >>confdefs.h <<_ACEOF
+-#define `$as_echo "HAVE_$ac_header" | $as_tr_cpp` 1
+-_ACEOF
+-
+-fi
+-
+-done
+-
+-
+-cat confdefs.h - <<_ACEOF >conftest.$ac_ext
+-/* end confdefs.h.  */
+-
+-#include <stdio.h>
+-#ifdef STDC_HEADERS
+-# include <stdlib.h>
+-# include <stddef.h>
+-#else
+-# ifdef HAVE_STDLIB_H
+-#  include <stdlib.h>
+-# endif
+-#endif
+-#ifdef HAVE_SYS_TYPES_H
+-# include <sys/types.h>
+-#endif
+-#ifdef HAVE_SYS_SOCKET_H
+-#include <sys/socket.h>
+-#endif
+-
+-_ACEOF
+-if ac_fn_c_try_compile "$LINENO"; then :
+-
+-else
+-
+-$as_echo "#define socklen_t int" >>confdefs.h
+-
+-fi
+-rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
+-
+-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking if environ can be included" >&5
+-$as_echo_n "checking if environ can be included... " >&6; }
+-cat confdefs.h - <<_ACEOF >conftest.$ac_ext
+-/* end confdefs.h.  */
+-
+-#include <unistd.h>
+-#include <stdlib.h>
+-int
+-main ()
+-{
+-*environ;
+-  ;
+-  return 0;
+-}
+-_ACEOF
+-if ac_fn_c_try_link "$LINENO"; then :
+-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: yes" >&5
+-$as_echo "yes" >&6; };
+-$as_echo "#define ENVIRON_INCLUDED 1" >>confdefs.h
+-
+-else
+-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
+-$as_echo "no" >&6; }
+-fi
+-rm -f core conftest.err conftest.$ac_objext \
+-    conftest$ac_exeext conftest.$ac_ext
+-
+-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking if environ can be linked" >&5
+-$as_echo_n "checking if environ can be linked... " >&6; }
+-cat confdefs.h - <<_ACEOF >conftest.$ac_ext
+-/* end confdefs.h.  */
+-extern char ** environ;
+-int
+-main ()
+-{
+-*environ;
+-  ;
+-  return 0;
+-}
+-_ACEOF
+-if ac_fn_c_try_link "$LINENO"; then :
+-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: yes" >&5
+-$as_echo "yes" >&6; };
+-$as_echo "#define ENVIRON_LINKED 1" >>confdefs.h
+-
+-else
+-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
+-$as_echo "no" >&6; }
+-fi
+-rm -f core conftest.err conftest.$ac_objext \
+-    conftest$ac_exeext conftest.$ac_ext
+-
+-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking if dirent includes d_type" >&5
+-$as_echo_n "checking if dirent includes d_type... " >&6; }
+-cat confdefs.h - <<_ACEOF >conftest.$ac_ext
+-/* end confdefs.h.  */
+-
+-#include <sys/types.h>
+-#include <dirent.h>
+-void blah(){
+-struct dirent d_test;
+-d_test.d_type = 0;
+-}
+-_ACEOF
+-if ac_fn_c_try_compile "$LINENO"; then :
+-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: yes" >&5
+-$as_echo "yes" >&6; };
+-$as_echo "#define DIRENT_HAS_D_TYPE 1" >>confdefs.h
+-
+-else
+-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
+-$as_echo "no" >&6; }
+-fi
+-rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
+-
+-
+-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for powf in libm" >&5
+-$as_echo_n "checking for powf in libm... " >&6; };
+-LIBS_BACKUP=$LIBS;
+-LIBS="$LIBS -lm";
+-cat confdefs.h - <<_ACEOF >conftest.$ac_ext
+-/* end confdefs.h.  */
+-#include <math.h>
+-int
+-main ()
+-{
+-
+-        powf(1.0f, 1.0f);
+-
+-  ;
+-  return 0;
+-}
+-_ACEOF
+-if ac_fn_c_try_link "$LINENO"; then :
+-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: yes" >&5
+-$as_echo "yes" >&6; }
+-else
+-
+-$as_echo "#define DB_HAVE_NO_POWF 1" >>confdefs.h
+-
+-fi
+-rm -f core conftest.err conftest.$ac_objext \
+-    conftest$ac_exeext conftest.$ac_ext
+-LIBS=$LIBS_BACKUP
+-
+-
+-
+-#Check if the compiler support attributes
+-
+-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking if compiler allows __attribute__" >&5
+-$as_echo_n "checking if compiler allows __attribute__... " >&6; }
+-cat confdefs.h - <<_ACEOF >conftest.$ac_ext
+-/* end confdefs.h.  */
+-
+-typedef struct { } __attribute__((packed)) junk;
+-int
+-main ()
+-{
+-
+-  ;
+-  return 0;
+-}
+-_ACEOF
+-if ac_fn_c_try_compile "$LINENO"; then :
+-   { $as_echo "$as_me:${as_lineno-$LINENO}: result: yes" >&5
+-$as_echo "yes" >&6; };$as_echo "#define C_HAS_ATTRIBUTE 1" >>confdefs.h
+-
+-else
+-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
+-$as_echo "no" >&6; }
+-fi
+-rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
+-
+-
+-#Check if the compiler supports certain attributes
+-OLDCFLAGS="$CFLAGS"
+-CFLAGS="-Werror"
+-
+-
+-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking if compiler allows __attribute__((always_inline)) " >&5
+-$as_echo_n "checking if compiler allows __attribute__((always_inline)) ... " >&6; }
+-cat confdefs.h - <<_ACEOF >conftest.$ac_ext
+-/* end confdefs.h.  */
+- void __attribute__((always_inline)) test(){}
+-
+-_ACEOF
+-if ac_fn_c_try_compile "$LINENO"; then :
+-   { $as_echo "$as_me:${as_lineno-$LINENO}: result: yes" >&5
+-$as_echo "yes" >&6; };$as_echo "#define C_ATTRIBUTE_ALWAYS_INLINE 1" >>confdefs.h
+-
+-else
+-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
+-$as_echo "no" >&6; }
+-fi
+-rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
+-
+-
+-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking if compiler allows __attribute__((fastcall)) " >&5
+-$as_echo_n "checking if compiler allows __attribute__((fastcall)) ... " >&6; }
+-cat confdefs.h - <<_ACEOF >conftest.$ac_ext
+-/* end confdefs.h.  */
+- void __attribute__((fastcall)) test(){}
+-
+-_ACEOF
+-if ac_fn_c_try_compile "$LINENO"; then :
+-   { $as_echo "$as_me:${as_lineno-$LINENO}: result: yes" >&5
+-$as_echo "yes" >&6; };$as_echo "#define C_ATTRIBUTE_FASTCALL 1" >>confdefs.h
+-
+-else
+-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
+-$as_echo "no" >&6; }
+-fi
+-rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
+-
+-
+-CFLAGS="$OLDCFLAGS"
+-
+-
+-#Check if the compiler supports __builtin_expect
+-#Switch language to c++
+-ac_ext=cpp
+-ac_cpp='$CXXCPP $CPPFLAGS'
+-ac_compile='$CXX -c $CXXFLAGS $CPPFLAGS conftest.$ac_ext >&5'
+-ac_link='$CXX -o conftest$ac_exeext $CXXFLAGS $CPPFLAGS $LDFLAGS conftest.$ac_ext $LIBS >&5'
+-ac_compiler_gnu=$ac_cv_cxx_compiler_gnu
+-
+-
+-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking if compiler allows __builtin_expect" >&5
+-$as_echo_n "checking if compiler allows __builtin_expect... " >&6; }
+-
+-cat confdefs.h - <<_ACEOF >conftest.$ac_ext
+-/* end confdefs.h.  */
+-
+-int
+-main ()
+-{
+-
+-int x=10;if( __builtin_expect ((x==1),0) ) ;
+-
+-  ;
+-  return 0;
+-}
+-_ACEOF
+-if ac_fn_cxx_try_compile "$LINENO"; then :
+-   { $as_echo "$as_me:${as_lineno-$LINENO}: result: yes" >&5
+-$as_echo "yes" >&6; };$as_echo "#define C_HAS_BUILTIN_EXPECT 1" >>confdefs.h
+-
+-else
+-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
+-$as_echo "no" >&6; }
+-fi
+-rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
+-#switch language back
+-ac_ext=c
+-ac_cpp='$CPP $CPPFLAGS'
+-ac_compile='$CC -c $CFLAGS $CPPFLAGS conftest.$ac_ext >&5'
+-ac_link='$CC -o conftest$ac_exeext $CFLAGS $CPPFLAGS $LDFLAGS conftest.$ac_ext $LIBS >&5'
+-ac_compiler_gnu=$ac_cv_c_compiler_gnu
+-
+-
+-# Check whether --enable-alsa-midi was given.
+-if test "${enable_alsa_midi+set}" = set; then :
+-  enableval=$enable_alsa_midi;  case "${enableval}" in
+- yes) alsa_midi=true;;
+- no)  alsa_midi=false;;
+-esac
+-else
+-  alsa_midi=true
+-fi
+-
+-if test x$alsa_midi = xtrue ; then
+-  alsa_save_CFLAGS="$CFLAGS"
+-alsa_save_LDFLAGS="$LDFLAGS"
+-alsa_save_LIBS="$LIBS"
+-alsa_found=yes
+-
+-
+-# Check whether --with-alsa-prefix was given.
+-if test "${with_alsa_prefix+set}" = set; then :
+-  withval=$with_alsa_prefix; alsa_prefix="$withval"
+-else
+-  alsa_prefix=""
+-fi
+-
+-
+-
+-# Check whether --with-alsa-inc-prefix was given.
+-if test "${with_alsa_inc_prefix+set}" = set; then :
+-  withval=$with_alsa_inc_prefix; alsa_inc_prefix="$withval"
+-else
+-  alsa_inc_prefix=""
+-fi
+-
+-
+-# Check whether --enable-alsatest was given.
+-if test "${enable_alsatest+set}" = set; then :
+-  enableval=$enable_alsatest; enable_alsatest=no
+-else
+-  enable_alsatest=yes
+-fi
+-
+-
+-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for ALSA CFLAGS" >&5
+-$as_echo_n "checking for ALSA CFLAGS... " >&6; }
+-if test "$alsa_inc_prefix" != "" ; then
+-	ALSA_CFLAGS="$ALSA_CFLAGS -I$alsa_inc_prefix"
+-	CFLAGS="$CFLAGS -I$alsa_inc_prefix"
+-fi
+-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ALSA_CFLAGS" >&5
+-$as_echo "$ALSA_CFLAGS" >&6; }
+-
+-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for ALSA LDFLAGS" >&5
+-$as_echo_n "checking for ALSA LDFLAGS... " >&6; }
+-if test "$alsa_prefix" != "" ; then
+-	ALSA_LIBS="$ALSA_LIBS -L$alsa_prefix"
+-	LDFLAGS="$LDFLAGS $ALSA_LIBS"
+-fi
+-
+-ALSA_LIBS="$ALSA_LIBS -lasound -lm -ldl -lpthread"
+-LIBS=`echo $LIBS | sed 's/-lm//'`
+-LIBS=`echo $LIBS | sed 's/-ldl//'`
+-LIBS=`echo $LIBS | sed 's/-lpthread//'`
+-LIBS=`echo $LIBS | sed 's/  //'`
+-LIBS="$ALSA_LIBS $LIBS"
+-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ALSA_LIBS" >&5
+-$as_echo "$ALSA_LIBS" >&6; }
+-
+-min_alsa_version=0.9.0
+-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for libasound headers version >= $min_alsa_version" >&5
+-$as_echo_n "checking for libasound headers version >= $min_alsa_version... " >&6; }
+-no_alsa=""
+-    alsa_min_major_version=`echo $min_alsa_version | \
+-           sed 's/\([0-9]*\).\([0-9]*\).\([0-9]*\)/\1/'`
+-    alsa_min_minor_version=`echo $min_alsa_version | \
+-           sed 's/\([0-9]*\).\([0-9]*\).\([0-9]*\)/\2/'`
+-    alsa_min_micro_version=`echo $min_alsa_version | \
+-           sed 's/\([0-9]*\).\([0-9]*\).\([0-9]*\)/\3/'`
+-
+-
+-ac_ext=c
+-ac_cpp='$CPP $CPPFLAGS'
+-ac_compile='$CC -c $CFLAGS $CPPFLAGS conftest.$ac_ext >&5'
+-ac_link='$CC -o conftest$ac_exeext $CFLAGS $CPPFLAGS $LDFLAGS conftest.$ac_ext $LIBS >&5'
+-ac_compiler_gnu=$ac_cv_c_compiler_gnu
+-
+-cat confdefs.h - <<_ACEOF >conftest.$ac_ext
+-/* end confdefs.h.  */
+-
+-#include <alsa/asoundlib.h>
+-
+-int
+-main ()
+-{
+-
+-/* ensure backward compatibility */
+-#if !defined(SND_LIB_MAJOR) && defined(SOUNDLIB_VERSION_MAJOR)
+-#define SND_LIB_MAJOR SOUNDLIB_VERSION_MAJOR
+-#endif
+-#if !defined(SND_LIB_MINOR) && defined(SOUNDLIB_VERSION_MINOR)
+-#define SND_LIB_MINOR SOUNDLIB_VERSION_MINOR
+-#endif
+-#if !defined(SND_LIB_SUBMINOR) && defined(SOUNDLIB_VERSION_SUBMINOR)
+-#define SND_LIB_SUBMINOR SOUNDLIB_VERSION_SUBMINOR
+-#endif
+-
+-#  if(SND_LIB_MAJOR > $alsa_min_major_version)
+-  exit(0);
+-#  else
+-#    if(SND_LIB_MAJOR < $alsa_min_major_version)
+-#       error not present
+-#    endif
+-
+-#   if(SND_LIB_MINOR > $alsa_min_minor_version)
+-  exit(0);
+-#   else
+-#     if(SND_LIB_MINOR < $alsa_min_minor_version)
+-#          error not present
+-#      endif
+-
+-#      if(SND_LIB_SUBMINOR < $alsa_min_micro_version)
+-#        error not present
+-#      endif
+-#    endif
+-#  endif
+-exit(0);
+-
+-  ;
+-  return 0;
+-}
+-_ACEOF
+-if ac_fn_c_try_compile "$LINENO"; then :
+-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: found." >&5
+-$as_echo "found." >&6; }
+-else
+-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: not present." >&5
+-$as_echo "not present." >&6; }
+-
+-   alsa_found=no
+-
+-fi
+-rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
+-ac_ext=c
+-ac_cpp='$CPP $CPPFLAGS'
+-ac_compile='$CC -c $CFLAGS $CPPFLAGS conftest.$ac_ext >&5'
+-ac_link='$CC -o conftest$ac_exeext $CFLAGS $CPPFLAGS $LDFLAGS conftest.$ac_ext $LIBS >&5'
+-ac_compiler_gnu=$ac_cv_c_compiler_gnu
+-
+-
+-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for snd_ctl_open in -lasound" >&5
+-$as_echo_n "checking for snd_ctl_open in -lasound... " >&6; }
+-if test "${ac_cv_lib_asound_snd_ctl_open+set}" = set; then :
+-  $as_echo_n "(cached) " >&6
+-else
+-  ac_check_lib_save_LIBS=$LIBS
+-LIBS="-lasound  $LIBS"
+-cat confdefs.h - <<_ACEOF >conftest.$ac_ext
+-/* end confdefs.h.  */
+-
+-/* Override any GCC internal prototype to avoid an error.
+-   Use char because int might match the return type of a GCC
+-   builtin and then its argument prototype would still apply.  */
+-#ifdef __cplusplus
+-extern "C"
+-#endif
+-char snd_ctl_open ();
+-int
+-main ()
+-{
+-return snd_ctl_open ();
+-  ;
+-  return 0;
+-}
+-_ACEOF
+-if ac_fn_c_try_link "$LINENO"; then :
+-  ac_cv_lib_asound_snd_ctl_open=yes
+-else
+-  ac_cv_lib_asound_snd_ctl_open=no
+-fi
+-rm -f core conftest.err conftest.$ac_objext \
+-    conftest$ac_exeext conftest.$ac_ext
+-LIBS=$ac_check_lib_save_LIBS
+-fi
+-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_lib_asound_snd_ctl_open" >&5
+-$as_echo "$ac_cv_lib_asound_snd_ctl_open" >&6; }
+-if test "x$ac_cv_lib_asound_snd_ctl_open" = x""yes; then :
+-  cat >>confdefs.h <<_ACEOF
+-#define HAVE_LIBASOUND 1
+-_ACEOF
+-
+-  LIBS="-lasound $LIBS"
+-
+-else
+-
+-	 alsa_found=no
+-
+-fi
+-
+-
+-if test "x$alsa_found" = "xyes" ; then
+-
+-$as_echo "#define HAVE_ALSA 1" >>confdefs.h
+-
+-   LIBS=`echo $LIBS | sed 's/-lasound//g'`
+-   LIBS=`echo $LIBS | sed 's/  //'`
+-   LIBS="-lasound $LIBS"
+-fi
+-if test "x$alsa_found" = "xno" ; then
+-   :
+-   CFLAGS="$alsa_save_CFLAGS"
+-   LDFLAGS="$alsa_save_LDFLAGS"
+-   LIBS="$alsa_save_LIBS"
+-   ALSA_CFLAGS=""
+-   ALSA_LIBS=""
+-fi
+-
+-
+-
+-
+-  CXXFLAGS="$CXXFLAGS $ALSA_CFLAGS"
+-fi
+-
+-#Check for big endian machine, should #define WORDS_BIGENDIAN if so
+- { $as_echo "$as_me:${as_lineno-$LINENO}: checking whether byte ordering is bigendian" >&5
+-$as_echo_n "checking whether byte ordering is bigendian... " >&6; }
+-if test "${ac_cv_c_bigendian+set}" = set; then :
+-  $as_echo_n "(cached) " >&6
+-else
+-  ac_cv_c_bigendian=unknown
+-    # See if we're dealing with a universal compiler.
+-    cat confdefs.h - <<_ACEOF >conftest.$ac_ext
+-/* end confdefs.h.  */
+-#ifndef __APPLE_CC__
+-	       not a universal capable compiler
+-	     #endif
+-	     typedef int dummy;
+-
+-_ACEOF
+-if ac_fn_c_try_compile "$LINENO"; then :
+-
+-	# Check for potential -arch flags.  It is not universal unless
+-	# there are at least two -arch flags with different values.
+-	ac_arch=
+-	ac_prev=
+-	for ac_word in $CC $CFLAGS $CPPFLAGS $LDFLAGS; do
+-	 if test -n "$ac_prev"; then
+-	   case $ac_word in
+-	     i?86 | x86_64 | ppc | ppc64)
+-	       if test -z "$ac_arch" || test "$ac_arch" = "$ac_word"; then
+-		 ac_arch=$ac_word
+-	       else
+-		 ac_cv_c_bigendian=universal
+-		 break
+-	       fi
+-	       ;;
+-	   esac
+-	   ac_prev=
+-	 elif test "x$ac_word" = "x-arch"; then
+-	   ac_prev=arch
+-	 fi
+-       done
+-fi
+-rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
+-    if test $ac_cv_c_bigendian = unknown; then
+-      # See if sys/param.h defines the BYTE_ORDER macro.
+-      cat confdefs.h - <<_ACEOF >conftest.$ac_ext
+-/* end confdefs.h.  */
+-#include <sys/types.h>
+-	     #include <sys/param.h>
+-
+-int
+-main ()
+-{
+-#if ! (defined BYTE_ORDER && defined BIG_ENDIAN \
+-		     && defined LITTLE_ENDIAN && BYTE_ORDER && BIG_ENDIAN \
+-		     && LITTLE_ENDIAN)
+-	      bogus endian macros
+-	     #endif
+-
+-  ;
+-  return 0;
+-}
+-_ACEOF
+-if ac_fn_c_try_compile "$LINENO"; then :
+-  # It does; now see whether it defined to BIG_ENDIAN or not.
+-	 cat confdefs.h - <<_ACEOF >conftest.$ac_ext
+-/* end confdefs.h.  */
+-#include <sys/types.h>
+-		#include <sys/param.h>
+-
+-int
+-main ()
+-{
+-#if BYTE_ORDER != BIG_ENDIAN
+-		 not big endian
+-		#endif
+-
+-  ;
+-  return 0;
+-}
+-_ACEOF
+-if ac_fn_c_try_compile "$LINENO"; then :
+-  ac_cv_c_bigendian=yes
+-else
+-  ac_cv_c_bigendian=no
+-fi
+-rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
+-fi
+-rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
+-    fi
+-    if test $ac_cv_c_bigendian = unknown; then
+-      # See if <limits.h> defines _LITTLE_ENDIAN or _BIG_ENDIAN (e.g., Solaris).
+-      cat confdefs.h - <<_ACEOF >conftest.$ac_ext
+-/* end confdefs.h.  */
+-#include <limits.h>
+-
+-int
+-main ()
+-{
+-#if ! (defined _LITTLE_ENDIAN || defined _BIG_ENDIAN)
+-	      bogus endian macros
+-	     #endif
+-
+-  ;
+-  return 0;
+-}
+-_ACEOF
+-if ac_fn_c_try_compile "$LINENO"; then :
+-  # It does; now see whether it defined to _BIG_ENDIAN or not.
+-	 cat confdefs.h - <<_ACEOF >conftest.$ac_ext
+-/* end confdefs.h.  */
+-#include <limits.h>
+-
+-int
+-main ()
+-{
+-#ifndef _BIG_ENDIAN
+-		 not big endian
+-		#endif
+-
+-  ;
+-  return 0;
+-}
+-_ACEOF
+-if ac_fn_c_try_compile "$LINENO"; then :
+-  ac_cv_c_bigendian=yes
+-else
+-  ac_cv_c_bigendian=no
+-fi
+-rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
+-fi
+-rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
+-    fi
+-    if test $ac_cv_c_bigendian = unknown; then
+-      # Compile a test program.
+-      if test "$cross_compiling" = yes; then :
+-  # Try to guess by grepping values from an object file.
+-	 cat confdefs.h - <<_ACEOF >conftest.$ac_ext
+-/* end confdefs.h.  */
+-short int ascii_mm[] =
+-		  { 0x4249, 0x4765, 0x6E44, 0x6961, 0x6E53, 0x7953, 0 };
+-		short int ascii_ii[] =
+-		  { 0x694C, 0x5454, 0x656C, 0x6E45, 0x6944, 0x6E61, 0 };
+-		int use_ascii (int i) {
+-		  return ascii_mm[i] + ascii_ii[i];
+-		}
+-		short int ebcdic_ii[] =
+-		  { 0x89D3, 0xE3E3, 0x8593, 0x95C5, 0x89C4, 0x9581, 0 };
+-		short int ebcdic_mm[] =
+-		  { 0xC2C9, 0xC785, 0x95C4, 0x8981, 0x95E2, 0xA8E2, 0 };
+-		int use_ebcdic (int i) {
+-		  return ebcdic_mm[i] + ebcdic_ii[i];
+-		}
+-		extern int foo;
+-
+-int
+-main ()
+-{
+-return use_ascii (foo) == use_ebcdic (foo);
+-  ;
+-  return 0;
+-}
+-_ACEOF
+-if ac_fn_c_try_compile "$LINENO"; then :
+-  if grep BIGenDianSyS conftest.$ac_objext >/dev/null; then
+-	      ac_cv_c_bigendian=yes
+-	    fi
+-	    if grep LiTTleEnDian conftest.$ac_objext >/dev/null ; then
+-	      if test "$ac_cv_c_bigendian" = unknown; then
+-		ac_cv_c_bigendian=no
+-	      else
+-		# finding both strings is unlikely to happen, but who knows?
+-		ac_cv_c_bigendian=unknown
+-	      fi
+-	    fi
+-fi
+-rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
+-else
+-  cat confdefs.h - <<_ACEOF >conftest.$ac_ext
+-/* end confdefs.h.  */
+-$ac_includes_default
+-int
+-main ()
+-{
+-
+-	     /* Are we little or big endian?  From Harbison&Steele.  */
+-	     union
+-	     {
+-	       long int l;
+-	       char c[sizeof (long int)];
+-	     } u;
+-	     u.l = 1;
+-	     return u.c[sizeof (long int) - 1] == 1;
+-
+-  ;
+-  return 0;
+-}
+-_ACEOF
+-if ac_fn_c_try_run "$LINENO"; then :
+-  ac_cv_c_bigendian=no
+-else
+-  ac_cv_c_bigendian=yes
+-fi
+-rm -f core *.core core.conftest.* gmon.out bb.out conftest$ac_exeext \
+-  conftest.$ac_objext conftest.beam conftest.$ac_ext
+-fi
+-
+-    fi
+-fi
+-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_c_bigendian" >&5
+-$as_echo "$ac_cv_c_bigendian" >&6; }
+- case $ac_cv_c_bigendian in #(
+-   yes)
+-     $as_echo "#define WORDS_BIGENDIAN 1" >>confdefs.h
+-;; #(
+-   no)
+-      ;; #(
+-   universal)
+-
+-$as_echo "#define AC_APPLE_UNIVERSAL_BUILD 1" >>confdefs.h
+-
+-     ;; #(
+-   *)
+-     as_fn_error "unknown endianness
+- presetting ac_cv_c_bigendian=no (or yes) will help" "$LINENO" 5 ;;
+- esac
+-
+-
+-#Features to enable/disable
+-
+-
+-# Check whether --enable-debug was given.
+-if test "${enable_debug+set}" = set; then :
+-  enableval=$enable_debug;
+-   ac_fn_c_check_header_mongrel "$LINENO" "curses.h" "ac_cv_header_curses_h" "$ac_includes_default"
+-if test "x$ac_cv_header_curses_h" = x""yes; then :
+-  have_curses_h=yes
+-fi
+-
+-
+-   { $as_echo "$as_me:${as_lineno-$LINENO}: checking for initscr in -lcurses" >&5
+-$as_echo_n "checking for initscr in -lcurses... " >&6; }
+-if test "${ac_cv_lib_curses_initscr+set}" = set; then :
+-  $as_echo_n "(cached) " >&6
+-else
+-  ac_check_lib_save_LIBS=$LIBS
+-LIBS="-lcurses  $LIBS"
+-cat confdefs.h - <<_ACEOF >conftest.$ac_ext
+-/* end confdefs.h.  */
+-
+-/* Override any GCC internal prototype to avoid an error.
+-   Use char because int might match the return type of a GCC
+-   builtin and then its argument prototype would still apply.  */
+-#ifdef __cplusplus
+-extern "C"
+-#endif
+-char initscr ();
+-int
+-main ()
+-{
+-return initscr ();
+-  ;
+-  return 0;
+-}
+-_ACEOF
+-if ac_fn_c_try_link "$LINENO"; then :
+-  ac_cv_lib_curses_initscr=yes
+-else
+-  ac_cv_lib_curses_initscr=no
+-fi
+-rm -f core conftest.err conftest.$ac_objext \
+-    conftest$ac_exeext conftest.$ac_ext
+-LIBS=$ac_check_lib_save_LIBS
+-fi
+-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_lib_curses_initscr" >&5
+-$as_echo "$ac_cv_lib_curses_initscr" >&6; }
+-if test "x$ac_cv_lib_curses_initscr" = x""yes; then :
+-  have_curses_lib=yes
+-fi
+-
+-   { $as_echo "$as_me:${as_lineno-$LINENO}: checking for initscr in -lncurses" >&5
+-$as_echo_n "checking for initscr in -lncurses... " >&6; }
+-if test "${ac_cv_lib_ncurses_initscr+set}" = set; then :
+-  $as_echo_n "(cached) " >&6
+-else
+-  ac_check_lib_save_LIBS=$LIBS
+-LIBS="-lncurses  $LIBS"
+-cat confdefs.h - <<_ACEOF >conftest.$ac_ext
+-/* end confdefs.h.  */
+-
+-/* Override any GCC internal prototype to avoid an error.
+-   Use char because int might match the return type of a GCC
+-   builtin and then its argument prototype would still apply.  */
+-#ifdef __cplusplus
+-extern "C"
+-#endif
+-char initscr ();
+-int
+-main ()
+-{
+-return initscr ();
+-  ;
+-  return 0;
+-}
+-_ACEOF
+-if ac_fn_c_try_link "$LINENO"; then :
+-  ac_cv_lib_ncurses_initscr=yes
+-else
+-  ac_cv_lib_ncurses_initscr=no
+-fi
+-rm -f core conftest.err conftest.$ac_objext \
+-    conftest$ac_exeext conftest.$ac_ext
+-LIBS=$ac_check_lib_save_LIBS
+-fi
+-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_lib_ncurses_initscr" >&5
+-$as_echo "$ac_cv_lib_ncurses_initscr" >&6; }
+-if test "x$ac_cv_lib_ncurses_initscr" = x""yes; then :
+-  have_ncurses_lib=yes
+-fi
+-
+-   { $as_echo "$as_me:${as_lineno-$LINENO}: checking for initscr in -lpdcurses" >&5
+-$as_echo_n "checking for initscr in -lpdcurses... " >&6; }
+-if test "${ac_cv_lib_pdcurses_initscr+set}" = set; then :
+-  $as_echo_n "(cached) " >&6
+-else
+-  ac_check_lib_save_LIBS=$LIBS
+-LIBS="-lpdcurses  $LIBS"
+-cat confdefs.h - <<_ACEOF >conftest.$ac_ext
+-/* end confdefs.h.  */
+-
+-/* Override any GCC internal prototype to avoid an error.
+-   Use char because int might match the return type of a GCC
+-   builtin and then its argument prototype would still apply.  */
+-#ifdef __cplusplus
+-extern "C"
+-#endif
+-char initscr ();
+-int
+-main ()
+-{
+-return initscr ();
+-  ;
+-  return 0;
+-}
+-_ACEOF
+-if ac_fn_c_try_link "$LINENO"; then :
+-  ac_cv_lib_pdcurses_initscr=yes
+-else
+-  ac_cv_lib_pdcurses_initscr=no
+-fi
+-rm -f core conftest.err conftest.$ac_objext \
+-    conftest$ac_exeext conftest.$ac_ext
+-LIBS=$ac_check_lib_save_LIBS
+-fi
+-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_lib_pdcurses_initscr" >&5
+-$as_echo "$ac_cv_lib_pdcurses_initscr" >&6; }
+-if test "x$ac_cv_lib_pdcurses_initscr" = x""yes; then :
+-  have_pdcurses_lib=yes
+-fi
+-
+-
+-   if test x$enable_debug = xno; then
+-     { $as_echo "$as_me:${as_lineno-$LINENO}: result: Debugger not enabled" >&5
+-$as_echo "Debugger not enabled" >&6; }
+-   elif test x$have_curses_lib = xyes -a x$have_curses_h = xyes ; then
+-     LIBS="$LIBS -lcurses"
+-     $as_echo "#define C_DEBUG 1" >>confdefs.h
+-
+-     if test x$enable_debug = xheavy ; then
+-       $as_echo "#define C_HEAVY_DEBUG 1" >>confdefs.h
+-
+-     fi
+-   elif test x$have_ncurses_lib = xyes -a x$have_curses_h = xyes ; then
+-     LIBS="$LIBS -lncurses"
+-     $as_echo "#define C_DEBUG 1" >>confdefs.h
+-
+-     if test x$enable_debug = xheavy ; then
+-       $as_echo "#define C_HEAVY_DEBUG 1" >>confdefs.h
+-
+-     fi
+-   elif test x$have_pdcurses_lib = xyes -a x$have_curses_h = xyes ; then
+-     LIBS="$LIBS -lpdcurses"
+-     $as_echo "#define C_DEBUG 1" >>confdefs.h
+-
+-     if test x$enable_debug = xheavy ; then
+-       $as_echo "#define C_HEAVY_DEBUG 1" >>confdefs.h
+-
+-     fi
+-   else
+-     as_fn_error "Can't find curses, which is required for debug mode" "$LINENO" 5
+-   fi
+-
+-fi
+-
+-
+-
+-# Check whether --enable-core-inline was given.
+-if test "${enable_core_inline+set}" = set; then :
+-  enableval=$enable_core_inline;
+-  if test x$enable_core_inline = xyes ; then
+-    { $as_echo "$as_me:${as_lineno-$LINENO}: result: enabling inlined memory handling in CPU Core" >&5
+-$as_echo "enabling inlined memory handling in CPU Core" >&6; }
+-    $as_echo "#define C_CORE_INLINE 1" >>confdefs.h
+-
+-  fi
+-
+-fi
+-
+-
+-
+-
+-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for target cpu type" >&5
+-$as_echo_n "checking for target cpu type... " >&6; }
+-case "$host_cpu" in
+-  x86_64 | amd64)
+-    $as_echo "#define C_TARGETCPU X86_64" >>confdefs.h
+-
+-    { $as_echo "$as_me:${as_lineno-$LINENO}: result: x86-64 bit compatible" >&5
+-$as_echo "x86-64 bit compatible" >&6; }
+-    c_targetcpu="x86_64"
+-    c_unalignedmemory=yes
+-    ;;
+-  i?86)
+-    $as_echo "#define C_TARGETCPU X86" >>confdefs.h
+-
+-    { $as_echo "$as_me:${as_lineno-$LINENO}: result: x86 compatible" >&5
+-$as_echo "x86 compatible" >&6; }
+-    c_targetcpu="x86"
+-    c_unalignedmemory=yes
+-    ;;
+-   powerpc*)
+-    $as_echo "#define C_TARGETCPU POWERPC" >>confdefs.h
+-
+-    { $as_echo "$as_me:${as_lineno-$LINENO}: result: Power PC" >&5
+-$as_echo "Power PC" >&6; }
+-    c_targetcpu="powerpc"
+-    c_unalignedmemory=yes
+-    ;;
+-   m68k*)
+-    $as_echo "#define C_TARGETCPU M68K" >>confdefs.h
+-
+-    { $as_echo "$as_me:${as_lineno-$LINENO}: result: Motorola 68000" >&5
+-$as_echo "Motorola 68000" >&6; }
+-    c_targetcpu="m68k"
+-    c_unalignedmemory=yes
+-    ;;
+-   *)
+-    $as_echo "#define C_TARGETCPU UNKNOWN" >>confdefs.h
+-
+-    { $as_echo "$as_me:${as_lineno-$LINENO}: result: unknown" >&5
+-$as_echo "unknown" >&6; }
+-    c_unalignedmemory=no
+-    ;;
+-esac
+-
+-# Check whether --enable-dynamic-core was given.
+-if test "${enable_dynamic_core+set}" = set; then :
+-  enableval=$enable_dynamic_core;
+-else
+-  enable_dynamic_core=yes
+-fi
+-
+-
+-
+-# Check whether --enable-dynamic-x86 was given.
+-if test "${enable_dynamic_x86+set}" = set; then :
+-  enableval=$enable_dynamic_x86;
+-else
+-  enable_dynamic_x86=yes
+-fi
+-
+-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking whether x86 dynamic cpu core will be enabled" >&5
+-$as_echo_n "checking whether x86 dynamic cpu core will be enabled... " >&6; }
+-if test x$enable_dynamic_x86 = xno -o x$enable_dynamic_core = xno; then
+-   { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
+-$as_echo "no" >&6; }
+-else
+-  if test x$c_targetcpu = xx86 ; then
+-      $as_echo "#define C_DYNAMIC_X86 1" >>confdefs.h
+-
+-      { $as_echo "$as_me:${as_lineno-$LINENO}: result: yes" >&5
+-$as_echo "yes" >&6; }
+-  else
+-      { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
+-$as_echo "no" >&6; }
+-  fi
+-fi
+-
+-
+-# Check whether --enable-dynrec was given.
+-if test "${enable_dynrec+set}" = set; then :
+-  enableval=$enable_dynrec;
+-else
+-  enable_dynrec=yes
+-fi
+-
+-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking whether recompiling cpu core will be enabled" >&5
+-$as_echo_n "checking whether recompiling cpu core will be enabled... " >&6; }
+-if test x$enable_dynrec = xno -o x$enable_dynamic_core = xno; then
+-   { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
+-$as_echo "no" >&6; }
+-else
+-  if test x$c_targetcpu = xx86 ; then
+-    if test x$enable_dynamic_x86 = xno ; then
+-        $as_echo "#define C_DYNREC 1" >>confdefs.h
+-
+-        { $as_echo "$as_me:${as_lineno-$LINENO}: result: yes" >&5
+-$as_echo "yes" >&6; }
+-    else
+-        { $as_echo "$as_me:${as_lineno-$LINENO}: result: no, using dynamic-x86" >&5
+-$as_echo "no, using dynamic-x86" >&6; }
+-    fi
+-  else
+-    if test x$c_targetcpu = xx86_64 ; then
+-        $as_echo "#define C_DYNREC 1" >>confdefs.h
+-
+-        { $as_echo "$as_me:${as_lineno-$LINENO}: result: yes" >&5
+-$as_echo "yes" >&6; }
+-    else
+-      { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
+-$as_echo "no" >&6; }
+-    fi
+-  fi
+-fi
+-
+-
+-# Check whether --enable-fpu was given.
+-if test "${enable_fpu+set}" = set; then :
+-  enableval=$enable_fpu;
+-else
+-  enable_fpu=yes
+-fi
+-
+-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking whether fpu emulation will be enabled" >&5
+-$as_echo_n "checking whether fpu emulation will be enabled... " >&6; }
+-if test x$enable_fpu = xyes ; then
+-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: yes" >&5
+-$as_echo "yes" >&6; }
+-  $as_echo "#define C_FPU 1" >>confdefs.h
+-
+-else
+-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
+-$as_echo "no" >&6; }
+-fi
+-
+-
+-# Check whether --enable-fpu-x86 was given.
+-if test "${enable_fpu_x86+set}" = set; then :
+-  enableval=$enable_fpu_x86;
+-else
+-  enable_fpu_x86=yes
+-fi
+-
+-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking whether x86 assembly fpu core will be enabled" >&5
+-$as_echo_n "checking whether x86 assembly fpu core will be enabled... " >&6; }
+-if test x$enable_fpu_x86 = xno ; then
+-   { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
+-$as_echo "no" >&6; }
+-else
+-  if test x$enable_fpu = xyes; then
+-    if test x$c_targetcpu = xx86 ; then
+-        $as_echo "#define C_FPU_X86 1" >>confdefs.h
+-
+-        { $as_echo "$as_me:${as_lineno-$LINENO}: result: yes" >&5
+-$as_echo "yes" >&6; }
+-    else
+-        { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
+-$as_echo "no" >&6; }
+-    fi
+-  else
+-      { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
+-$as_echo "no" >&6; }
+-  fi
+-fi
+-
+-
+-# Check whether --enable-unaligned_memory was given.
+-if test "${enable_unaligned_memory+set}" = set; then :
+-  enableval=$enable_unaligned_memory;
+-else
+-  enable_unaligned_memory=yes
+-fi
+-
+-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking whether to enable unaligned memory access" >&5
+-$as_echo_n "checking whether to enable unaligned memory access... " >&6; }
+-if test x$enable_unaligned_memory = xyes -a x$c_unalignedmemory = xyes; then
+-  $as_echo "#define C_UNALIGNED_MEMORY 1" >>confdefs.h
+-
+-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: yes" >&5
+-$as_echo "yes" >&6; }
+-else
+-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
+-$as_echo "no" >&6; }
+-fi
+-
+-
+-ac_fn_c_check_header_mongrel "$LINENO" "png.h" "ac_cv_header_png_h" "$ac_includes_default"
+-if test "x$ac_cv_header_png_h" = x""yes; then :
+-  have_png_h=yes
+-fi
+-
+-
+-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for png_get_io_ptr in -lpng" >&5
+-$as_echo_n "checking for png_get_io_ptr in -lpng... " >&6; }
+-if test "${ac_cv_lib_png_png_get_io_ptr+set}" = set; then :
+-  $as_echo_n "(cached) " >&6
+-else
+-  ac_check_lib_save_LIBS=$LIBS
+-LIBS="-lpng -lz $LIBS"
+-cat confdefs.h - <<_ACEOF >conftest.$ac_ext
+-/* end confdefs.h.  */
+-
+-/* Override any GCC internal prototype to avoid an error.
+-   Use char because int might match the return type of a GCC
+-   builtin and then its argument prototype would still apply.  */
+-#ifdef __cplusplus
+-extern "C"
+-#endif
+-char png_get_io_ptr ();
+-int
+-main ()
+-{
+-return png_get_io_ptr ();
+-  ;
+-  return 0;
+-}
+-_ACEOF
+-if ac_fn_c_try_link "$LINENO"; then :
+-  ac_cv_lib_png_png_get_io_ptr=yes
+-else
+-  ac_cv_lib_png_png_get_io_ptr=no
+-fi
+-rm -f core conftest.err conftest.$ac_objext \
+-    conftest$ac_exeext conftest.$ac_ext
+-LIBS=$ac_check_lib_save_LIBS
+-fi
+-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_lib_png_png_get_io_ptr" >&5
+-$as_echo "$ac_cv_lib_png_png_get_io_ptr" >&6; }
+-if test "x$ac_cv_lib_png_png_get_io_ptr" = x""yes; then :
+-  have_png_lib=yes
+-fi
+-
+-if test x$have_png_lib = xyes -a x$have_png_h = xyes ; then
+-  LIBS="$LIBS -lpng -lz"
+-  $as_echo "#define C_SSHOT 1" >>confdefs.h
+-
+-else
+-  { $as_echo "$as_me:${as_lineno-$LINENO}: WARNING: Can't find libpng, screenshot support disabled" >&5
+-$as_echo "$as_me: WARNING: Can't find libpng, screenshot support disabled" >&2;}
+-fi
+-
+-
+-
+-ac_fn_c_check_header_mongrel "$LINENO" "SDL_net.h" "ac_cv_header_SDL_net_h" "$ac_includes_default"
+-if test "x$ac_cv_header_SDL_net_h" = x""yes; then :
+-  have_sdl_net_h=yes
+-fi
+-
+-
+-
+-if test x$host = xi386-pc-os2-emx ; then
+-  { $as_echo "$as_me:${as_lineno-$LINENO}: checking for SDLNet_Init in SDL_net" >&5
+-$as_echo_n "checking for SDLNet_Init in SDL_net... " >&6; };
+-  LIBS_BACKUP=$LIBS;
+-  LIBS="$LIBS -lSDL_Net";
+-  cat confdefs.h - <<_ACEOF >conftest.$ac_ext
+-/* end confdefs.h.  */
+-#include <SDL_Net.h>
+-int
+-main ()
+-{
+-
+-	SDLNet_Init ();
+-
+-  ;
+-  return 0;
+-}
+-_ACEOF
+-if ac_fn_c_try_link "$LINENO"; then :
+-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: yes" >&5
+-$as_echo "yes" >&6; }; have_sdl_net_lib=yes
+-else
+-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
+-$as_echo "no" >&6; }
+-fi
+-rm -f core conftest.err conftest.$ac_objext \
+-    conftest$ac_exeext conftest.$ac_ext
+-  LIBS=$LIBS_BACKUP
+-else
+-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for SDLNet_Init in -lSDL_net" >&5
+-$as_echo_n "checking for SDLNet_Init in -lSDL_net... " >&6; }
+-if test "${ac_cv_lib_SDL_net_SDLNet_Init+set}" = set; then :
+-  $as_echo_n "(cached) " >&6
+-else
+-  ac_check_lib_save_LIBS=$LIBS
+-LIBS="-lSDL_net  $LIBS"
+-cat confdefs.h - <<_ACEOF >conftest.$ac_ext
+-/* end confdefs.h.  */
+-
+-/* Override any GCC internal prototype to avoid an error.
+-   Use char because int might match the return type of a GCC
+-   builtin and then its argument prototype would still apply.  */
+-#ifdef __cplusplus
+-extern "C"
+-#endif
+-char SDLNet_Init ();
+-int
+-main ()
+-{
+-return SDLNet_Init ();
+-  ;
+-  return 0;
+-}
+-_ACEOF
+-if ac_fn_c_try_link "$LINENO"; then :
+-  ac_cv_lib_SDL_net_SDLNet_Init=yes
+-else
+-  ac_cv_lib_SDL_net_SDLNet_Init=no
+-fi
+-rm -f core conftest.err conftest.$ac_objext \
+-    conftest$ac_exeext conftest.$ac_ext
+-LIBS=$ac_check_lib_save_LIBS
+-fi
+-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_lib_SDL_net_SDLNet_Init" >&5
+-$as_echo "$ac_cv_lib_SDL_net_SDLNet_Init" >&6; }
+-if test "x$ac_cv_lib_SDL_net_SDLNet_Init" = x""yes; then :
+-  have_sdl_net_lib=yes
+-fi
+-
+-fi
+-if test x$have_sdl_net_lib = xyes -a x$have_sdl_net_h = xyes ; then
+-   LIBS="$LIBS -lSDL_net"
+-   $as_echo "#define C_MODEM 1" >>confdefs.h
+-
+-   $as_echo "#define C_IPX 1" >>confdefs.h
+-
+-else
+-   { $as_echo "$as_me:${as_lineno-$LINENO}: WARNING: Can't find SDL_net, internal modem and ipx disabled" >&5
+-$as_echo "$as_me: WARNING: Can't find SDL_net, internal modem and ipx disabled" >&2;}
+-fi
+-
+-
+-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for main in -lX11" >&5
+-$as_echo_n "checking for main in -lX11... " >&6; }
+-if test "${ac_cv_lib_X11_main+set}" = set; then :
+-  $as_echo_n "(cached) " >&6
+-else
+-  ac_check_lib_save_LIBS=$LIBS
+-LIBS="-lX11  $LIBS"
+-cat confdefs.h - <<_ACEOF >conftest.$ac_ext
+-/* end confdefs.h.  */
+-
+-
+-int
+-main ()
+-{
+-return main ();
+-  ;
+-  return 0;
+-}
+-_ACEOF
+-if ac_fn_c_try_link "$LINENO"; then :
+-  ac_cv_lib_X11_main=yes
+-else
+-  ac_cv_lib_X11_main=no
+-fi
+-rm -f core conftest.err conftest.$ac_objext \
+-    conftest$ac_exeext conftest.$ac_ext
+-LIBS=$ac_check_lib_save_LIBS
+-fi
+-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_lib_X11_main" >&5
+-$as_echo "$ac_cv_lib_X11_main" >&6; }
+-if test "x$ac_cv_lib_X11_main" = x""yes; then :
+-  have_x11_lib=yes
+-else
+-  have_x11_lib=no
+-fi
+-
+-ac_fn_c_check_header_mongrel "$LINENO" "X11/XKBlib.h" "ac_cv_header_X11_XKBlib_h" "$ac_includes_default"
+-if test "x$ac_cv_header_X11_XKBlib_h" = x""yes; then :
+-  have_x11_h=yes
+-else
+-  have_x11_h=no
+-fi
+-
+-
+-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for XKBlib support" >&5
+-$as_echo_n "checking for XKBlib support... " >&6; }
+-if test x$have_x11_lib = xyes -a x$have_x11_h = xyes ; then
+-   LIBS="$LIBS -lX11"
+-   $as_echo "#define C_X11_XKB 1" >>confdefs.h
+-
+-   { $as_echo "$as_me:${as_lineno-$LINENO}: result: yes" >&5
+-$as_echo "yes" >&6; }
+-else
+-   { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
+-$as_echo "no" >&6; }
+-fi
+-
+-
+-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for main in -lGL" >&5
+-$as_echo_n "checking for main in -lGL... " >&6; }
+-if test "${ac_cv_lib_GL_main+set}" = set; then :
+-  $as_echo_n "(cached) " >&6
+-else
+-  ac_check_lib_save_LIBS=$LIBS
+-LIBS="-lGL  $LIBS"
+-cat confdefs.h - <<_ACEOF >conftest.$ac_ext
+-/* end confdefs.h.  */
+-
+-
+-int
+-main ()
+-{
+-return main ();
+-  ;
+-  return 0;
+-}
+-_ACEOF
+-if ac_fn_c_try_link "$LINENO"; then :
+-  ac_cv_lib_GL_main=yes
+-else
+-  ac_cv_lib_GL_main=no
+-fi
+-rm -f core conftest.err conftest.$ac_objext \
+-    conftest$ac_exeext conftest.$ac_ext
+-LIBS=$ac_check_lib_save_LIBS
+-fi
+-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_lib_GL_main" >&5
+-$as_echo "$ac_cv_lib_GL_main" >&6; }
+-if test "x$ac_cv_lib_GL_main" = x""yes; then :
+-  have_gl_lib=yes
+-else
+-  have_gl_lib=no
+-fi
+-
+-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for main in -lopengl32" >&5
+-$as_echo_n "checking for main in -lopengl32... " >&6; }
+-if test "${ac_cv_lib_opengl32_main+set}" = set; then :
+-  $as_echo_n "(cached) " >&6
+-else
+-  ac_check_lib_save_LIBS=$LIBS
+-LIBS="-lopengl32  $LIBS"
+-cat confdefs.h - <<_ACEOF >conftest.$ac_ext
+-/* end confdefs.h.  */
+-
+-
+-int
+-main ()
+-{
+-return main ();
+-  ;
+-  return 0;
+-}
+-_ACEOF
+-if ac_fn_c_try_link "$LINENO"; then :
+-  ac_cv_lib_opengl32_main=yes
+-else
+-  ac_cv_lib_opengl32_main=no
+-fi
+-rm -f core conftest.err conftest.$ac_objext \
+-    conftest$ac_exeext conftest.$ac_ext
+-LIBS=$ac_check_lib_save_LIBS
+-fi
+-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_lib_opengl32_main" >&5
+-$as_echo "$ac_cv_lib_opengl32_main" >&6; }
+-if test "x$ac_cv_lib_opengl32_main" = x""yes; then :
+-  have_opengl32_lib=yes
+-else
+-  have_opengl32_lib=no
+-fi
+-
+-ac_fn_c_check_header_mongrel "$LINENO" "GL/gl.h" "ac_cv_header_GL_gl_h" "$ac_includes_default"
+-if test "x$ac_cv_header_GL_gl_h" = x""yes; then :
+-  have_gl_h=yes
+-else
+-  have_gl_h=no
+-fi
+-
+-
+-# Check whether --enable-opengl was given.
+-if test "${enable_opengl+set}" = set; then :
+-  enableval=$enable_opengl;
+-else
+-  enable_opengl=yes
+-fi
+-
+-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking whether opengl display output will be enabled" >&5
+-$as_echo_n "checking whether opengl display output will be enabled... " >&6; }
+-if test x$enable_opengl = xyes; then
+-case "$host" in
+-    *-*-darwin*)
+-       { $as_echo "$as_me:${as_lineno-$LINENO}: result: yes" >&5
+-$as_echo "yes" >&6; }
+-       LIBS="$LIBS -framework OpenGL"
+-       $as_echo "#define C_OPENGL 1" >>confdefs.h
+-
+-       ;;
+-    *)
+-       if test x$have_gl_h = xyes -a x$have_gl_lib = xyes ; then
+-         { $as_echo "$as_me:${as_lineno-$LINENO}: result: yes" >&5
+-$as_echo "yes" >&6; }
+-         LIBS="$LIBS -lGL"
+-         $as_echo "#define C_OPENGL 1" >>confdefs.h
+-
+-       elif test x$have_gl_h = xyes -a x$have_opengl32_lib = xyes ; then
+-         { $as_echo "$as_me:${as_lineno-$LINENO}: result: yes" >&5
+-$as_echo "yes" >&6; }
+-         LIBS="$LIBS -lopengl32"
+-         $as_echo "#define C_OPENGL 1" >>confdefs.h
+-
+-       else
+-         { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
+-$as_echo "no" >&6; }
+-       fi
+-       ;;
+-esac
+-fi
+-
+-
+-ac_fn_c_check_header_mongrel "$LINENO" "SDL_sound.h" "ac_cv_header_SDL_sound_h" "$ac_includes_default"
+-if test "x$ac_cv_header_SDL_sound_h" = x""yes; then :
+-  have_SDL_sound_h=yes
+-fi
+-
+-
+-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for Sound_Init in -lSDL_sound" >&5
+-$as_echo_n "checking for Sound_Init in -lSDL_sound... " >&6; }
+-if test "${ac_cv_lib_SDL_sound_Sound_Init+set}" = set; then :
+-  $as_echo_n "(cached) " >&6
+-else
+-  ac_check_lib_save_LIBS=$LIBS
+-LIBS="-lSDL_sound  $LIBS"
+-cat confdefs.h - <<_ACEOF >conftest.$ac_ext
+-/* end confdefs.h.  */
+-
+-/* Override any GCC internal prototype to avoid an error.
+-   Use char because int might match the return type of a GCC
+-   builtin and then its argument prototype would still apply.  */
+-#ifdef __cplusplus
+-extern "C"
+-#endif
+-char Sound_Init ();
+-int
+-main ()
+-{
+-return Sound_Init ();
+-  ;
+-  return 0;
+-}
+-_ACEOF
+-if ac_fn_c_try_link "$LINENO"; then :
+-  ac_cv_lib_SDL_sound_Sound_Init=yes
+-else
+-  ac_cv_lib_SDL_sound_Sound_Init=no
+-fi
+-rm -f core conftest.err conftest.$ac_objext \
+-    conftest$ac_exeext conftest.$ac_ext
+-LIBS=$ac_check_lib_save_LIBS
+-fi
+-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_lib_SDL_sound_Sound_Init" >&5
+-$as_echo "$ac_cv_lib_SDL_sound_Sound_Init" >&6; }
+-if test "x$ac_cv_lib_SDL_sound_Sound_Init" = x""yes; then :
+-  have_SDL_sound_init=yes
+-fi
+-
+-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for Sound_Seek in -lSDL_sound" >&5
+-$as_echo_n "checking for Sound_Seek in -lSDL_sound... " >&6; }
+-if test "${ac_cv_lib_SDL_sound_Sound_Seek+set}" = set; then :
+-  $as_echo_n "(cached) " >&6
+-else
+-  ac_check_lib_save_LIBS=$LIBS
+-LIBS="-lSDL_sound  $LIBS"
+-cat confdefs.h - <<_ACEOF >conftest.$ac_ext
+-/* end confdefs.h.  */
+-
+-/* Override any GCC internal prototype to avoid an error.
+-   Use char because int might match the return type of a GCC
+-   builtin and then its argument prototype would still apply.  */
+-#ifdef __cplusplus
+-extern "C"
+-#endif
+-char Sound_Seek ();
+-int
+-main ()
+-{
+-return Sound_Seek ();
+-  ;
+-  return 0;
+-}
+-_ACEOF
+-if ac_fn_c_try_link "$LINENO"; then :
+-  ac_cv_lib_SDL_sound_Sound_Seek=yes
+-else
+-  ac_cv_lib_SDL_sound_Sound_Seek=no
+-fi
+-rm -f core conftest.err conftest.$ac_objext \
+-    conftest$ac_exeext conftest.$ac_ext
+-LIBS=$ac_check_lib_save_LIBS
+-fi
+-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_lib_SDL_sound_Sound_Seek" >&5
+-$as_echo "$ac_cv_lib_SDL_sound_Sound_Seek" >&6; }
+-if test "x$ac_cv_lib_SDL_sound_Sound_Seek" = x""yes; then :
+-  have_SDL_sound_seek=yes
+-fi
+-
+-if test x$have_SDL_sound_h = xyes -a x$have_SDL_sound_init = xyes ; then
+-  if test x$have_SDL_sound_seek = xyes ; then
+-    LIBS="-lSDL_sound $LIBS"
+-    $as_echo "#define C_SDL_SOUND 1" >>confdefs.h
+-
+-   else
+-     { $as_echo "$as_me:${as_lineno-$LINENO}: WARNING: Can't find SoundSeek in libSDL_Sound, libSDL_sound support disabled" >&5
+-$as_echo "$as_me: WARNING: Can't find SoundSeek in libSDL_Sound, libSDL_sound support disabled" >&2;}
+-   fi
+-else
+-  { $as_echo "$as_me:${as_lineno-$LINENO}: WARNING: Can't find libSDL_sound, libSDL_sound support disabled" >&5
+-$as_echo "$as_me: WARNING: Can't find libSDL_sound, libSDL_sound support disabled" >&2;}
+-fi
+-
+-
+-ac_fn_c_check_header_mongrel "$LINENO" "sys/mman.h" "ac_cv_header_sys_mman_h" "$ac_includes_default"
+-if test "x$ac_cv_header_sys_mman_h" = x""yes; then :
+-
+-ac_fn_c_check_func "$LINENO" "mprotect" "ac_cv_func_mprotect"
+-if test "x$ac_cv_func_mprotect" = x""yes; then :
+-  $as_echo "#define C_HAVE_MPROTECT 1" >>confdefs.h
+-
+-fi
+-
+-
+-fi
+-
+-
+-
+-
+-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for setpriority support" >&5
+-$as_echo_n "checking for setpriority support... " >&6; }
+-cat confdefs.h - <<_ACEOF >conftest.$ac_ext
+-/* end confdefs.h.  */
+-
+-#include <sys/resource.h>
+-int main(int argc,char * argv) {
+-	return setpriority (PRIO_PROCESS, 0,PRIO_MIN+PRIO_MAX);
+-};
+-
+-_ACEOF
+-if ac_fn_c_try_link "$LINENO"; then :
+-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: yes" >&5
+-$as_echo "yes" >&6; };$as_echo "#define C_SET_PRIORITY 1" >>confdefs.h
+-
+-else
+-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
+-$as_echo "no" >&6; }
+-fi
+-rm -f core conftest.err conftest.$ac_objext \
+-    conftest$ac_exeext conftest.$ac_ext
+-
+-
+-case "$host" in
+-    *-*-cygwin* | *-*-mingw32*)
+-       LIBS="$LIBS -lwinmm"
+-       for ac_header in ddraw.h
+-do :
+-  ac_fn_c_check_header_mongrel "$LINENO" "ddraw.h" "ac_cv_header_ddraw_h" "$ac_includes_default"
+-if test "x$ac_cv_header_ddraw_h" = x""yes; then :
+-  cat >>confdefs.h <<_ACEOF
+-#define HAVE_DDRAW_H 1
+-_ACEOF
+-
+-fi
+-
+-done
+-
+-
+-$as_echo "#define C_DIRECTSERIAL 1" >>confdefs.h
+-
+-       if test x$have_sdl_net_lib = xyes -a x$have_sdl_net_h = xyes ; then
+-         LIBS="$LIBS -lws2_32"
+-       fi
+-       ;;
+-    *-*-darwin*)
+-
+-$as_echo "#define MACOSX 1" >>confdefs.h
+-
+-       LIBS="$LIBS -framework CoreMIDI -framework AudioUnit -framework AudioToolbox"
+-
+-$as_echo "#define C_DIRECTSERIAL 1" >>confdefs.h
+-
+-       ;;
+-    *-*-linux*)
+-
+-$as_echo "#define LINUX 1" >>confdefs.h
+-
+-
+-$as_echo "#define C_DIRECTSERIAL 1" >>confdefs.h
+-
+-       ;;
+-    *-*-freebsd* | *-*-dragonfly* | *-*-netbsd* | *-*-openbsd*)
+-
+-$as_echo "#define BSD 1" >>confdefs.h
+-
+-
+-$as_echo "#define C_DIRECTSERIAL 1" >>confdefs.h
+-
+-       ;;
+-    *-*-os2-emx*)
+-
+-$as_echo "#define OS2 1" >>confdefs.h
+-
+-
+-$as_echo "#define C_DIRECTSERIAL 1" >>confdefs.h
+-
+-       ;;
+-esac
+-
+-case "$host" in
+-    *-*-cygwin* | *-*-mingw32*)
+-              if test -n "$ac_tool_prefix"; then
+-  # Extract the first word of "${ac_tool_prefix}windres", so it can be a program name with args.
+-set dummy ${ac_tool_prefix}windres; ac_word=$2
+-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for $ac_word" >&5
+-$as_echo_n "checking for $ac_word... " >&6; }
+-if test "${ac_cv_prog_WINDRES+set}" = set; then :
+-  $as_echo_n "(cached) " >&6
+-else
+-  if test -n "$WINDRES"; then
+-  ac_cv_prog_WINDRES="$WINDRES" # Let the user override the test.
+-else
+-as_save_IFS=$IFS; IFS=$PATH_SEPARATOR
+-for as_dir in $PATH
+-do
+-  IFS=$as_save_IFS
+-  test -z "$as_dir" && as_dir=.
+-    for ac_exec_ext in '' $ac_executable_extensions; do
+-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
+-    ac_cv_prog_WINDRES="${ac_tool_prefix}windres"
+-    $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
+-    break 2
+-  fi
+-done
+-  done
+-IFS=$as_save_IFS
+-
+-fi
+-fi
+-WINDRES=$ac_cv_prog_WINDRES
+-if test -n "$WINDRES"; then
+-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: $WINDRES" >&5
+-$as_echo "$WINDRES" >&6; }
+-else
+-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
+-$as_echo "no" >&6; }
+-fi
+-
+-
+-fi
+-if test -z "$ac_cv_prog_WINDRES"; then
+-  ac_ct_WINDRES=$WINDRES
+-  # Extract the first word of "windres", so it can be a program name with args.
+-set dummy windres; ac_word=$2
+-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking for $ac_word" >&5
+-$as_echo_n "checking for $ac_word... " >&6; }
+-if test "${ac_cv_prog_ac_ct_WINDRES+set}" = set; then :
+-  $as_echo_n "(cached) " >&6
+-else
+-  if test -n "$ac_ct_WINDRES"; then
+-  ac_cv_prog_ac_ct_WINDRES="$ac_ct_WINDRES" # Let the user override the test.
+-else
+-as_save_IFS=$IFS; IFS=$PATH_SEPARATOR
+-for as_dir in $PATH
+-do
+-  IFS=$as_save_IFS
+-  test -z "$as_dir" && as_dir=.
+-    for ac_exec_ext in '' $ac_executable_extensions; do
+-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
+-    ac_cv_prog_ac_ct_WINDRES="windres"
+-    $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
+-    break 2
+-  fi
+-done
+-  done
+-IFS=$as_save_IFS
+-
+-fi
+-fi
+-ac_ct_WINDRES=$ac_cv_prog_ac_ct_WINDRES
+-if test -n "$ac_ct_WINDRES"; then
+-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_ct_WINDRES" >&5
+-$as_echo "$ac_ct_WINDRES" >&6; }
+-else
+-  { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
+-$as_echo "no" >&6; }
+-fi
+-
+-  if test "x$ac_ct_WINDRES" = x; then
+-    WINDRES=":"
+-  else
+-    case $cross_compiling:$ac_tool_warned in
+-yes:)
+-{ $as_echo "$as_me:${as_lineno-$LINENO}: WARNING: using cross tools not prefixed with host triplet" >&5
+-$as_echo "$as_me: WARNING: using cross tools not prefixed with host triplet" >&2;}
+-ac_tool_warned=yes ;;
+-esac
+-    WINDRES=$ac_ct_WINDRES
+-  fi
+-else
+-  WINDRES="$ac_cv_prog_WINDRES"
+-fi
+-
+-    ;;
+-    *)
+-       WINDRES=":"
+-    ;;
+-esac
+-        if test "x$WINDRES" != "x:"; then
+-  HAVE_WINDRES_TRUE=
+-  HAVE_WINDRES_FALSE='#'
+-else
+-  HAVE_WINDRES_TRUE='#'
+-  HAVE_WINDRES_FALSE=
+-fi
+-
+-
+-
+-
+-ac_config_files="$ac_config_files Makefile src/Makefile src/cpu/Makefile src/cpu/core_full/Makefile src/cpu/core_normal/Makefile src/cpu/core_dyn_x86/Makefile src/cpu/core_dynrec/Makefile src/debug/Makefile src/dos/Makefile src/fpu/Makefile src/gui/Makefile src/hardware/Makefile src/hardware/serialport/Makefile src/ints/Makefile src/libs/Makefile src/libs/zmbv/Makefile src/libs/gui_tk/Makefile src/misc/Makefile src/shell/Makefile src/platform/Makefile src/platform/visualc/Makefile visualc_net/Makefile include/Makefile docs/Makefile"
+-
+-cat >confcache <<\_ACEOF
+-# This file is a shell script that caches the results of configure
+-# tests run on this system so they can be shared between configure
+-# scripts and configure runs, see configure's option --config-cache.
+-# It is not useful on other systems.  If it contains results you don't
+-# want to keep, you may remove or edit it.
+-#
+-# config.status only pays attention to the cache file if you give it
+-# the --recheck option to rerun configure.
+-#
+-# `ac_cv_env_foo' variables (set or unset) will be overridden when
+-# loading this file, other *unset* `ac_cv_foo' will be assigned the
+-# following values.
+-
+-_ACEOF
+-
+-# The following way of writing the cache mishandles newlines in values,
+-# but we know of no workaround that is simple, portable, and efficient.
+-# So, we kill variables containing newlines.
+-# Ultrix sh set writes to stderr and can't be redirected directly,
+-# and sets the high bit in the cache file unless we assign to the vars.
+-(
+-  for ac_var in `(set) 2>&1 | sed -n 's/^\([a-zA-Z_][a-zA-Z0-9_]*\)=.*/\1/p'`; do
+-    eval ac_val=\$$ac_var
+-    case $ac_val in #(
+-    *${as_nl}*)
+-      case $ac_var in #(
+-      *_cv_*) { $as_echo "$as_me:${as_lineno-$LINENO}: WARNING: cache variable $ac_var contains a newline" >&5
+-$as_echo "$as_me: WARNING: cache variable $ac_var contains a newline" >&2;} ;;
+-      esac
+-      case $ac_var in #(
+-      _ | IFS | as_nl) ;; #(
+-      BASH_ARGV | BASH_SOURCE) eval $ac_var= ;; #(
+-      *) { eval $ac_var=; unset $ac_var;} ;;
+-      esac ;;
+-    esac
+-  done
+-
+-  (set) 2>&1 |
+-    case $as_nl`(ac_space=' '; set) 2>&1` in #(
+-    *${as_nl}ac_space=\ *)
+-      # `set' does not quote correctly, so add quotes: double-quote
+-      # substitution turns \\\\ into \\, and sed turns \\ into \.
+-      sed -n \
+-	"s/'/'\\\\''/g;
+-	  s/^\\([_$as_cr_alnum]*_cv_[_$as_cr_alnum]*\\)=\\(.*\\)/\\1='\\2'/p"
+-      ;; #(
+-    *)
+-      # `set' quotes correctly as required by POSIX, so do not add quotes.
+-      sed -n "/^[_$as_cr_alnum]*_cv_[_$as_cr_alnum]*=/p"
+-      ;;
+-    esac |
+-    sort
+-) |
+-  sed '
+-     /^ac_cv_env_/b end
+-     t clear
+-     :clear
+-     s/^\([^=]*\)=\(.*[{}].*\)$/test "${\1+set}" = set || &/
+-     t end
+-     s/^\([^=]*\)=\(.*\)$/\1=${\1=\2}/
+-     :end' >>confcache
+-if diff "$cache_file" confcache >/dev/null 2>&1; then :; else
+-  if test -w "$cache_file"; then
+-    test "x$cache_file" != "x/dev/null" &&
+-      { $as_echo "$as_me:${as_lineno-$LINENO}: updating cache $cache_file" >&5
+-$as_echo "$as_me: updating cache $cache_file" >&6;}
+-    cat confcache >$cache_file
+-  else
+-    { $as_echo "$as_me:${as_lineno-$LINENO}: not updating unwritable cache $cache_file" >&5
+-$as_echo "$as_me: not updating unwritable cache $cache_file" >&6;}
+-  fi
+-fi
+-rm -f confcache
+-
+-test "x$prefix" = xNONE && prefix=$ac_default_prefix
+-# Let make expand exec_prefix.
+-test "x$exec_prefix" = xNONE && exec_prefix='${prefix}'
+-
+-DEFS=-DHAVE_CONFIG_H
+-
+-ac_libobjs=
+-ac_ltlibobjs=
+-for ac_i in : $LIBOBJS; do test "x$ac_i" = x: && continue
+-  # 1. Remove the extension, and $U if already installed.
+-  ac_script='s/\$U\././;s/\.o$//;s/\.obj$//'
+-  ac_i=`$as_echo "$ac_i" | sed "$ac_script"`
+-  # 2. Prepend LIBOBJDIR.  When used with automake>=1.10 LIBOBJDIR
+-  #    will be set to the directory where LIBOBJS objects are built.
+-  as_fn_append ac_libobjs " \${LIBOBJDIR}$ac_i\$U.$ac_objext"
+-  as_fn_append ac_ltlibobjs " \${LIBOBJDIR}$ac_i"'$U.lo'
+-done
+-LIBOBJS=$ac_libobjs
+-
+-LTLIBOBJS=$ac_ltlibobjs
+-
+-
+- if test -n "$EXEEXT"; then
+-  am__EXEEXT_TRUE=
+-  am__EXEEXT_FALSE='#'
+-else
+-  am__EXEEXT_TRUE='#'
+-  am__EXEEXT_FALSE=
+-fi
+-
+-if test -z "${AMDEP_TRUE}" && test -z "${AMDEP_FALSE}"; then
+-  as_fn_error "conditional \"AMDEP\" was never defined.
+-Usually this means the macro was only invoked conditionally." "$LINENO" 5
+-fi
+-if test -z "${am__fastdepCC_TRUE}" && test -z "${am__fastdepCC_FALSE}"; then
+-  as_fn_error "conditional \"am__fastdepCC\" was never defined.
+-Usually this means the macro was only invoked conditionally." "$LINENO" 5
+-fi
+-if test -z "${am__fastdepCXX_TRUE}" && test -z "${am__fastdepCXX_FALSE}"; then
+-  as_fn_error "conditional \"am__fastdepCXX\" was never defined.
+-Usually this means the macro was only invoked conditionally." "$LINENO" 5
+-fi
+-
+-if test -z "${HAVE_WINDRES_TRUE}" && test -z "${HAVE_WINDRES_FALSE}"; then
+-  as_fn_error "conditional \"HAVE_WINDRES\" was never defined.
+-Usually this means the macro was only invoked conditionally." "$LINENO" 5
+-fi
+-
+-: ${CONFIG_STATUS=./config.status}
+-ac_write_fail=0
+-ac_clean_files_save=$ac_clean_files
+-ac_clean_files="$ac_clean_files $CONFIG_STATUS"
+-{ $as_echo "$as_me:${as_lineno-$LINENO}: creating $CONFIG_STATUS" >&5
+-$as_echo "$as_me: creating $CONFIG_STATUS" >&6;}
+-as_write_fail=0
+-cat >$CONFIG_STATUS <<_ASEOF || as_write_fail=1
+-#! $SHELL
+-# Generated by $as_me.
+-# Run this file to recreate the current configuration.
+-# Compiler output produced by configure, useful for debugging
+-# configure, is in config.log if it exists.
+-
+-debug=false
+-ac_cs_recheck=false
+-ac_cs_silent=false
+-
+-SHELL=\${CONFIG_SHELL-$SHELL}
+-export SHELL
+-_ASEOF
+-cat >>$CONFIG_STATUS <<\_ASEOF || as_write_fail=1
+-## -------------------- ##
+-## M4sh Initialization. ##
+-## -------------------- ##
+-
+-# Be more Bourne compatible
+-DUALCASE=1; export DUALCASE # for MKS sh
+-if test -n "${ZSH_VERSION+set}" && (emulate sh) >/dev/null 2>&1; then :
+-  emulate sh
+-  NULLCMD=:
+-  # Pre-4.2 versions of Zsh do word splitting on ${1+"$@"}, which
+-  # is contrary to our usage.  Disable this feature.
+-  alias -g '${1+"$@"}'='"$@"'
+-  setopt NO_GLOB_SUBST
+-else
+-  case `(set -o) 2>/dev/null` in #(
+-  *posix*) :
+-    set -o posix ;; #(
+-  *) :
+-     ;;
+-esac
+-fi
+-
+-
+-as_nl='
+-'
+-export as_nl
+-# Printing a long string crashes Solaris 7 /usr/bin/printf.
+-as_echo='\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\'
+-as_echo=$as_echo$as_echo$as_echo$as_echo$as_echo
+-as_echo=$as_echo$as_echo$as_echo$as_echo$as_echo$as_echo
+-# Prefer a ksh shell builtin over an external printf program on Solaris,
+-# but without wasting forks for bash or zsh.
+-if test -z "$BASH_VERSION$ZSH_VERSION" \
+-    && (test "X`print -r -- $as_echo`" = "X$as_echo") 2>/dev/null; then
+-  as_echo='print -r --'
+-  as_echo_n='print -rn --'
+-elif (test "X`printf %s $as_echo`" = "X$as_echo") 2>/dev/null; then
+-  as_echo='printf %s\n'
+-  as_echo_n='printf %s'
+-else
+-  if test "X`(/usr/ucb/echo -n -n $as_echo) 2>/dev/null`" = "X-n $as_echo"; then
+-    as_echo_body='eval /usr/ucb/echo -n "$1$as_nl"'
+-    as_echo_n='/usr/ucb/echo -n'
+-  else
+-    as_echo_body='eval expr "X$1" : "X\\(.*\\)"'
+-    as_echo_n_body='eval
+-      arg=$1;
+-      case $arg in #(
+-      *"$as_nl"*)
+-	expr "X$arg" : "X\\(.*\\)$as_nl";
+-	arg=`expr "X$arg" : ".*$as_nl\\(.*\\)"`;;
+-      esac;
+-      expr "X$arg" : "X\\(.*\\)" | tr -d "$as_nl"
+-    '
+-    export as_echo_n_body
+-    as_echo_n='sh -c $as_echo_n_body as_echo'
+-  fi
+-  export as_echo_body
+-  as_echo='sh -c $as_echo_body as_echo'
+-fi
+-
+-# The user is always right.
+-if test "${PATH_SEPARATOR+set}" != set; then
+-  PATH_SEPARATOR=:
+-  (PATH='/bin;/bin'; FPATH=$PATH; sh -c :) >/dev/null 2>&1 && {
+-    (PATH='/bin:/bin'; FPATH=$PATH; sh -c :) >/dev/null 2>&1 ||
+-      PATH_SEPARATOR=';'
+-  }
+-fi
+-
+-
+-# IFS
+-# We need space, tab and new line, in precisely that order.  Quoting is
+-# there to prevent editors from complaining about space-tab.
+-# (If _AS_PATH_WALK were called with IFS unset, it would disable word
+-# splitting by setting IFS to empty value.)
+-IFS=" ""	$as_nl"
+-
+-# Find who we are.  Look in the path if we contain no directory separator.
+-case $0 in #((
+-  *[\\/]* ) as_myself=$0 ;;
+-  *) as_save_IFS=$IFS; IFS=$PATH_SEPARATOR
+-for as_dir in $PATH
+-do
+-  IFS=$as_save_IFS
+-  test -z "$as_dir" && as_dir=.
+-    test -r "$as_dir/$0" && as_myself=$as_dir/$0 && break
+-  done
+-IFS=$as_save_IFS
+-
+-     ;;
+-esac
+-# We did not find ourselves, most probably we were run as `sh COMMAND'
+-# in which case we are not to be found in the path.
+-if test "x$as_myself" = x; then
+-  as_myself=$0
+-fi
+-if test ! -f "$as_myself"; then
+-  $as_echo "$as_myself: error: cannot find myself; rerun with an absolute file name" >&2
+-  exit 1
+-fi
+-
+-# Unset variables that we do not need and which cause bugs (e.g. in
+-# pre-3.0 UWIN ksh).  But do not cause bugs in bash 2.01; the "|| exit 1"
+-# suppresses any "Segmentation fault" message there.  '((' could
+-# trigger a bug in pdksh 5.2.14.
+-for as_var in BASH_ENV ENV MAIL MAILPATH
+-do eval test x\${$as_var+set} = xset \
+-  && ( (unset $as_var) || exit 1) >/dev/null 2>&1 && unset $as_var || :
+-done
+-PS1='$ '
+-PS2='> '
+-PS4='+ '
+-
+-# NLS nuisances.
+-LC_ALL=C
+-export LC_ALL
+-LANGUAGE=C
+-export LANGUAGE
+-
+-# CDPATH.
+-(unset CDPATH) >/dev/null 2>&1 && unset CDPATH
+-
+-
+-# as_fn_error ERROR [LINENO LOG_FD]
+-# ---------------------------------
+-# Output "`basename $0`: error: ERROR" to stderr. If LINENO and LOG_FD are
+-# provided, also output the error to LOG_FD, referencing LINENO. Then exit the
+-# script with status $?, using 1 if that was 0.
+-as_fn_error ()
+-{
+-  as_status=$?; test $as_status -eq 0 && as_status=1
+-  if test "$3"; then
+-    as_lineno=${as_lineno-"$2"} as_lineno_stack=as_lineno_stack=$as_lineno_stack
+-    $as_echo "$as_me:${as_lineno-$LINENO}: error: $1" >&$3
+-  fi
+-  $as_echo "$as_me: error: $1" >&2
+-  as_fn_exit $as_status
+-} # as_fn_error
+-
+-
+-# as_fn_set_status STATUS
+-# -----------------------
+-# Set $? to STATUS, without forking.
+-as_fn_set_status ()
+-{
+-  return $1
+-} # as_fn_set_status
+-
+-# as_fn_exit STATUS
+-# -----------------
+-# Exit the shell with STATUS, even in a "trap 0" or "set -e" context.
+-as_fn_exit ()
+-{
+-  set +e
+-  as_fn_set_status $1
+-  exit $1
+-} # as_fn_exit
+-
+-# as_fn_unset VAR
+-# ---------------
+-# Portably unset VAR.
+-as_fn_unset ()
+-{
+-  { eval $1=; unset $1;}
+-}
+-as_unset=as_fn_unset
+-# as_fn_append VAR VALUE
+-# ----------------------
+-# Append the text in VALUE to the end of the definition contained in VAR. Take
+-# advantage of any shell optimizations that allow amortized linear growth over
+-# repeated appends, instead of the typical quadratic growth present in naive
+-# implementations.
+-if (eval "as_var=1; as_var+=2; test x\$as_var = x12") 2>/dev/null; then :
+-  eval 'as_fn_append ()
+-  {
+-    eval $1+=\$2
+-  }'
+-else
+-  as_fn_append ()
+-  {
+-    eval $1=\$$1\$2
+-  }
+-fi # as_fn_append
+-
+-# as_fn_arith ARG...
+-# ------------------
+-# Perform arithmetic evaluation on the ARGs, and store the result in the
+-# global $as_val. Take advantage of shells that can avoid forks. The arguments
+-# must be portable across $(()) and expr.
+-if (eval "test \$(( 1 + 1 )) = 2") 2>/dev/null; then :
+-  eval 'as_fn_arith ()
+-  {
+-    as_val=$(( $* ))
+-  }'
+-else
+-  as_fn_arith ()
+-  {
+-    as_val=`expr "$@" || test $? -eq 1`
+-  }
+-fi # as_fn_arith
+-
+-
+-if expr a : '\(a\)' >/dev/null 2>&1 &&
+-   test "X`expr 00001 : '.*\(...\)'`" = X001; then
+-  as_expr=expr
+-else
+-  as_expr=false
+-fi
+-
+-if (basename -- /) >/dev/null 2>&1 && test "X`basename -- / 2>&1`" = "X/"; then
+-  as_basename=basename
+-else
+-  as_basename=false
+-fi
+-
+-if (as_dir=`dirname -- /` && test "X$as_dir" = X/) >/dev/null 2>&1; then
+-  as_dirname=dirname
+-else
+-  as_dirname=false
+-fi
+-
+-as_me=`$as_basename -- "$0" ||
+-$as_expr X/"$0" : '.*/\([^/][^/]*\)/*$' \| \
+-	 X"$0" : 'X\(//\)$' \| \
+-	 X"$0" : 'X\(/\)' \| . 2>/dev/null ||
+-$as_echo X/"$0" |
+-    sed '/^.*\/\([^/][^/]*\)\/*$/{
+-	    s//\1/
+-	    q
+-	  }
+-	  /^X\/\(\/\/\)$/{
+-	    s//\1/
+-	    q
+-	  }
+-	  /^X\/\(\/\).*/{
+-	    s//\1/
+-	    q
+-	  }
+-	  s/.*/./; q'`
+-
+-# Avoid depending upon Character Ranges.
+-as_cr_letters='abcdefghijklmnopqrstuvwxyz'
+-as_cr_LETTERS='ABCDEFGHIJKLMNOPQRSTUVWXYZ'
+-as_cr_Letters=$as_cr_letters$as_cr_LETTERS
+-as_cr_digits='0123456789'
+-as_cr_alnum=$as_cr_Letters$as_cr_digits
+-
+-ECHO_C= ECHO_N= ECHO_T=
+-case `echo -n x` in #(((((
+--n*)
+-  case `echo 'xy\c'` in
+-  *c*) ECHO_T='	';;	# ECHO_T is single tab character.
+-  xy)  ECHO_C='\c';;
+-  *)   echo `echo ksh88 bug on AIX 6.1` > /dev/null
+-       ECHO_T='	';;
+-  esac;;
+-*)
+-  ECHO_N='-n';;
+-esac
+-
+-rm -f conf$$ conf$$.exe conf$$.file
+-if test -d conf$$.dir; then
+-  rm -f conf$$.dir/conf$$.file
+-else
+-  rm -f conf$$.dir
+-  mkdir conf$$.dir 2>/dev/null
+-fi
+-if (echo >conf$$.file) 2>/dev/null; then
+-  if ln -s conf$$.file conf$$ 2>/dev/null; then
+-    as_ln_s='ln -s'
+-    # ... but there are two gotchas:
+-    # 1) On MSYS, both `ln -s file dir' and `ln file dir' fail.
+-    # 2) DJGPP < 2.04 has no symlinks; `ln -s' creates a wrapper executable.
+-    # In both cases, we have to default to `cp -p'.
+-    ln -s conf$$.file conf$$.dir 2>/dev/null && test ! -f conf$$.exe ||
+-      as_ln_s='cp -p'
+-  elif ln conf$$.file conf$$ 2>/dev/null; then
+-    as_ln_s=ln
+-  else
+-    as_ln_s='cp -p'
+-  fi
+-else
+-  as_ln_s='cp -p'
+-fi
+-rm -f conf$$ conf$$.exe conf$$.dir/conf$$.file conf$$.file
+-rmdir conf$$.dir 2>/dev/null
+-
+-
+-# as_fn_mkdir_p
+-# -------------
+-# Create "$as_dir" as a directory, including parents if necessary.
+-as_fn_mkdir_p ()
+-{
+-
+-  case $as_dir in #(
+-  -*) as_dir=./$as_dir;;
+-  esac
+-  test -d "$as_dir" || eval $as_mkdir_p || {
+-    as_dirs=
+-    while :; do
+-      case $as_dir in #(
+-      *\'*) as_qdir=`$as_echo "$as_dir" | sed "s/'/'\\\\\\\\''/g"`;; #'(
+-      *) as_qdir=$as_dir;;
+-      esac
+-      as_dirs="'$as_qdir' $as_dirs"
+-      as_dir=`$as_dirname -- "$as_dir" ||
+-$as_expr X"$as_dir" : 'X\(.*[^/]\)//*[^/][^/]*/*$' \| \
+-	 X"$as_dir" : 'X\(//\)[^/]' \| \
+-	 X"$as_dir" : 'X\(//\)$' \| \
+-	 X"$as_dir" : 'X\(/\)' \| . 2>/dev/null ||
+-$as_echo X"$as_dir" |
+-    sed '/^X\(.*[^/]\)\/\/*[^/][^/]*\/*$/{
+-	    s//\1/
+-	    q
+-	  }
+-	  /^X\(\/\/\)[^/].*/{
+-	    s//\1/
+-	    q
+-	  }
+-	  /^X\(\/\/\)$/{
+-	    s//\1/
+-	    q
+-	  }
+-	  /^X\(\/\).*/{
+-	    s//\1/
+-	    q
+-	  }
+-	  s/.*/./; q'`
+-      test -d "$as_dir" && break
+-    done
+-    test -z "$as_dirs" || eval "mkdir $as_dirs"
+-  } || test -d "$as_dir" || as_fn_error "cannot create directory $as_dir"
+-
+-
+-} # as_fn_mkdir_p
+-if mkdir -p . 2>/dev/null; then
+-  as_mkdir_p='mkdir -p "$as_dir"'
+-else
+-  test -d ./-p && rmdir ./-p
+-  as_mkdir_p=false
+-fi
+-
+-if test -x / >/dev/null 2>&1; then
+-  as_test_x='test -x'
+-else
+-  if ls -dL / >/dev/null 2>&1; then
+-    as_ls_L_option=L
+-  else
+-    as_ls_L_option=
+-  fi
+-  as_test_x='
+-    eval sh -c '\''
+-      if test -d "$1"; then
+-	test -d "$1/.";
+-      else
+-	case $1 in #(
+-	-*)set "./$1";;
+-	esac;
+-	case `ls -ld'$as_ls_L_option' "$1" 2>/dev/null` in #((
+-	???[sx]*):;;*)false;;esac;fi
+-    '\'' sh
+-  '
+-fi
+-as_executable_p=$as_test_x
+-
+-# Sed expression to map a string onto a valid CPP name.
+-as_tr_cpp="eval sed 'y%*$as_cr_letters%P$as_cr_LETTERS%;s%[^_$as_cr_alnum]%_%g'"
+-
+-# Sed expression to map a string onto a valid variable name.
+-as_tr_sh="eval sed 'y%*+%pp%;s%[^_$as_cr_alnum]%_%g'"
+-
+-
+-exec 6>&1
+-## ----------------------------------- ##
+-## Main body of $CONFIG_STATUS script. ##
+-## ----------------------------------- ##
+-_ASEOF
+-test $as_write_fail = 0 && chmod +x $CONFIG_STATUS || ac_write_fail=1
+-
+-cat >>$CONFIG_STATUS <<\_ACEOF || ac_write_fail=1
+-# Save the log message, to keep $0 and so on meaningful, and to
+-# report actual input values of CONFIG_FILES etc. instead of their
+-# values after options handling.
+-ac_log="
+-This file was extended by dosbox $as_me 0.74, which was
+-generated by GNU Autoconf 2.65.  Invocation command line was
+-
+-  CONFIG_FILES    = $CONFIG_FILES
+-  CONFIG_HEADERS  = $CONFIG_HEADERS
+-  CONFIG_LINKS    = $CONFIG_LINKS
+-  CONFIG_COMMANDS = $CONFIG_COMMANDS
+-  $ $0 $@
+-
+-on `(hostname || uname -n) 2>/dev/null | sed 1q`
+-"
+-
+-_ACEOF
+-
+-case $ac_config_files in *"
+-"*) set x $ac_config_files; shift; ac_config_files=$*;;
+-esac
+-
+-case $ac_config_headers in *"
+-"*) set x $ac_config_headers; shift; ac_config_headers=$*;;
+-esac
+-
+-
+-cat >>$CONFIG_STATUS <<_ACEOF || ac_write_fail=1
+-# Files that config.status was made for.
+-config_files="$ac_config_files"
+-config_headers="$ac_config_headers"
+-config_commands="$ac_config_commands"
+-
+-_ACEOF
+-
+-cat >>$CONFIG_STATUS <<\_ACEOF || ac_write_fail=1
+-ac_cs_usage="\
+-\`$as_me' instantiates files and other configuration actions
+-from templates according to the current configuration.  Unless the files
+-and actions are specified as TAGs, all are instantiated by default.
+-
+-Usage: $0 [OPTION]... [TAG]...
+-
+-  -h, --help       print this help, then exit
+-  -V, --version    print version number and configuration settings, then exit
+-      --config     print configuration, then exit
+-  -q, --quiet, --silent
+-                   do not print progress messages
+-  -d, --debug      don't remove temporary files
+-      --recheck    update $as_me by reconfiguring in the same conditions
+-      --file=FILE[:TEMPLATE]
+-                   instantiate the configuration file FILE
+-      --header=FILE[:TEMPLATE]
+-                   instantiate the configuration header FILE
+-
+-Configuration files:
+-$config_files
+-
+-Configuration headers:
+-$config_headers
+-
+-Configuration commands:
+-$config_commands
+-
+-Report bugs to the package provider."
+-
+-_ACEOF
+-cat >>$CONFIG_STATUS <<_ACEOF || ac_write_fail=1
+-ac_cs_config="`$as_echo "$ac_configure_args" | sed 's/^ //; s/[\\""\`\$]/\\\\&/g'`"
+-ac_cs_version="\\
+-dosbox config.status 0.74
+-configured by $0, generated by GNU Autoconf 2.65,
+-  with options \\"\$ac_cs_config\\"
+-
+-Copyright (C) 2009 Free Software Foundation, Inc.
+-This config.status script is free software; the Free Software Foundation
+-gives unlimited permission to copy, distribute and modify it."
+-
+-ac_pwd='$ac_pwd'
+-srcdir='$srcdir'
+-INSTALL='$INSTALL'
+-MKDIR_P='$MKDIR_P'
+-AWK='$AWK'
+-test -n "\$AWK" || AWK=awk
+-_ACEOF
+-
+-cat >>$CONFIG_STATUS <<\_ACEOF || ac_write_fail=1
+-# The default lists apply if the user does not specify any file.
+-ac_need_defaults=:
+-while test $# != 0
+-do
+-  case $1 in
+-  --*=*)
+-    ac_option=`expr "X$1" : 'X\([^=]*\)='`
+-    ac_optarg=`expr "X$1" : 'X[^=]*=\(.*\)'`
+-    ac_shift=:
+-    ;;
+-  *)
+-    ac_option=$1
+-    ac_optarg=$2
+-    ac_shift=shift
+-    ;;
+-  esac
+-
+-  case $ac_option in
+-  # Handling of the options.
+-  -recheck | --recheck | --rechec | --reche | --rech | --rec | --re | --r)
+-    ac_cs_recheck=: ;;
+-  --version | --versio | --versi | --vers | --ver | --ve | --v | -V )
+-    $as_echo "$ac_cs_version"; exit ;;
+-  --config | --confi | --conf | --con | --co | --c )
+-    $as_echo "$ac_cs_config"; exit ;;
+-  --debug | --debu | --deb | --de | --d | -d )
+-    debug=: ;;
+-  --file | --fil | --fi | --f )
+-    $ac_shift
+-    case $ac_optarg in
+-    *\'*) ac_optarg=`$as_echo "$ac_optarg" | sed "s/'/'\\\\\\\\''/g"` ;;
+-    esac
+-    as_fn_append CONFIG_FILES " '$ac_optarg'"
+-    ac_need_defaults=false;;
+-  --header | --heade | --head | --hea )
+-    $ac_shift
+-    case $ac_optarg in
+-    *\'*) ac_optarg=`$as_echo "$ac_optarg" | sed "s/'/'\\\\\\\\''/g"` ;;
+-    esac
+-    as_fn_append CONFIG_HEADERS " '$ac_optarg'"
+-    ac_need_defaults=false;;
+-  --he | --h)
+-    # Conflict between --help and --header
+-    as_fn_error "ambiguous option: \`$1'
+-Try \`$0 --help' for more information.";;
+-  --help | --hel | -h )
+-    $as_echo "$ac_cs_usage"; exit ;;
+-  -q | -quiet | --quiet | --quie | --qui | --qu | --q \
+-  | -silent | --silent | --silen | --sile | --sil | --si | --s)
+-    ac_cs_silent=: ;;
+-
+-  # This is an error.
+-  -*) as_fn_error "unrecognized option: \`$1'
+-Try \`$0 --help' for more information." ;;
+-
+-  *) as_fn_append ac_config_targets " $1"
+-     ac_need_defaults=false ;;
+-
+-  esac
+-  shift
+-done
+-
+-ac_configure_extra_args=
+-
+-if $ac_cs_silent; then
+-  exec 6>/dev/null
+-  ac_configure_extra_args="$ac_configure_extra_args --silent"
+-fi
+-
+-_ACEOF
+-cat >>$CONFIG_STATUS <<_ACEOF || ac_write_fail=1
+-if \$ac_cs_recheck; then
+-  set X '$SHELL' '$0' $ac_configure_args \$ac_configure_extra_args --no-create --no-recursion
+-  shift
+-  \$as_echo "running CONFIG_SHELL=$SHELL \$*" >&6
+-  CONFIG_SHELL='$SHELL'
+-  export CONFIG_SHELL
+-  exec "\$@"
+-fi
+-
+-_ACEOF
+-cat >>$CONFIG_STATUS <<\_ACEOF || ac_write_fail=1
+-exec 5>>config.log
+-{
+-  echo
+-  sed 'h;s/./-/g;s/^.../## /;s/...$/ ##/;p;x;p;x' <<_ASBOX
+-## Running $as_me. ##
+-_ASBOX
+-  $as_echo "$ac_log"
+-} >&5
+-
+-_ACEOF
+-cat >>$CONFIG_STATUS <<_ACEOF || ac_write_fail=1
+-#
+-# INIT-COMMANDS
+-#
+-AMDEP_TRUE="$AMDEP_TRUE" ac_aux_dir="$ac_aux_dir"
+-
+-_ACEOF
+-
+-cat >>$CONFIG_STATUS <<\_ACEOF || ac_write_fail=1
+-
+-# Handling of arguments.
+-for ac_config_target in $ac_config_targets
+-do
+-  case $ac_config_target in
+-    "config.h") CONFIG_HEADERS="$CONFIG_HEADERS config.h" ;;
+-    "depfiles") CONFIG_COMMANDS="$CONFIG_COMMANDS depfiles" ;;
+-    "Makefile") CONFIG_FILES="$CONFIG_FILES Makefile" ;;
+-    "src/Makefile") CONFIG_FILES="$CONFIG_FILES src/Makefile" ;;
+-    "src/cpu/Makefile") CONFIG_FILES="$CONFIG_FILES src/cpu/Makefile" ;;
+-    "src/cpu/core_full/Makefile") CONFIG_FILES="$CONFIG_FILES src/cpu/core_full/Makefile" ;;
+-    "src/cpu/core_normal/Makefile") CONFIG_FILES="$CONFIG_FILES src/cpu/core_normal/Makefile" ;;
+-    "src/cpu/core_dyn_x86/Makefile") CONFIG_FILES="$CONFIG_FILES src/cpu/core_dyn_x86/Makefile" ;;
+-    "src/cpu/core_dynrec/Makefile") CONFIG_FILES="$CONFIG_FILES src/cpu/core_dynrec/Makefile" ;;
+-    "src/debug/Makefile") CONFIG_FILES="$CONFIG_FILES src/debug/Makefile" ;;
+-    "src/dos/Makefile") CONFIG_FILES="$CONFIG_FILES src/dos/Makefile" ;;
+-    "src/fpu/Makefile") CONFIG_FILES="$CONFIG_FILES src/fpu/Makefile" ;;
+-    "src/gui/Makefile") CONFIG_FILES="$CONFIG_FILES src/gui/Makefile" ;;
+-    "src/hardware/Makefile") CONFIG_FILES="$CONFIG_FILES src/hardware/Makefile" ;;
+-    "src/hardware/serialport/Makefile") CONFIG_FILES="$CONFIG_FILES src/hardware/serialport/Makefile" ;;
+-    "src/ints/Makefile") CONFIG_FILES="$CONFIG_FILES src/ints/Makefile" ;;
+-    "src/libs/Makefile") CONFIG_FILES="$CONFIG_FILES src/libs/Makefile" ;;
+-    "src/libs/zmbv/Makefile") CONFIG_FILES="$CONFIG_FILES src/libs/zmbv/Makefile" ;;
+-    "src/libs/gui_tk/Makefile") CONFIG_FILES="$CONFIG_FILES src/libs/gui_tk/Makefile" ;;
+-    "src/misc/Makefile") CONFIG_FILES="$CONFIG_FILES src/misc/Makefile" ;;
+-    "src/shell/Makefile") CONFIG_FILES="$CONFIG_FILES src/shell/Makefile" ;;
+-    "src/platform/Makefile") CONFIG_FILES="$CONFIG_FILES src/platform/Makefile" ;;
+-    "src/platform/visualc/Makefile") CONFIG_FILES="$CONFIG_FILES src/platform/visualc/Makefile" ;;
+-    "visualc_net/Makefile") CONFIG_FILES="$CONFIG_FILES visualc_net/Makefile" ;;
+-    "include/Makefile") CONFIG_FILES="$CONFIG_FILES include/Makefile" ;;
+-    "docs/Makefile") CONFIG_FILES="$CONFIG_FILES docs/Makefile" ;;
+-
+-  *) as_fn_error "invalid argument: \`$ac_config_target'" "$LINENO" 5;;
+-  esac
+-done
+-
+-
+-# If the user did not use the arguments to specify the items to instantiate,
+-# then the envvar interface is used.  Set only those that are not.
+-# We use the long form for the default assignment because of an extremely
+-# bizarre bug on SunOS 4.1.3.
+-if $ac_need_defaults; then
+-  test "${CONFIG_FILES+set}" = set || CONFIG_FILES=$config_files
+-  test "${CONFIG_HEADERS+set}" = set || CONFIG_HEADERS=$config_headers
+-  test "${CONFIG_COMMANDS+set}" = set || CONFIG_COMMANDS=$config_commands
+-fi
+-
+-# Have a temporary directory for convenience.  Make it in the build tree
+-# simply because there is no reason against having it here, and in addition,
+-# creating and moving files from /tmp can sometimes cause problems.
+-# Hook for its removal unless debugging.
+-# Note that there is a small window in which the directory will not be cleaned:
+-# after its creation but before its name has been assigned to `$tmp'.
+-$debug ||
+-{
+-  tmp=
+-  trap 'exit_status=$?
+-  { test -z "$tmp" || test ! -d "$tmp" || rm -fr "$tmp"; } && exit $exit_status
+-' 0
+-  trap 'as_fn_exit 1' 1 2 13 15
+-}
+-# Create a (secure) tmp directory for tmp files.
+-
+-{
+-  tmp=`(umask 077 && mktemp -d "./confXXXXXX") 2>/dev/null` &&
+-  test -n "$tmp" && test -d "$tmp"
+-}  ||
+-{
+-  tmp=./conf$$-$RANDOM
+-  (umask 077 && mkdir "$tmp")
+-} || as_fn_error "cannot create a temporary directory in ." "$LINENO" 5
+-
+-# Set up the scripts for CONFIG_FILES section.
+-# No need to generate them if there are no CONFIG_FILES.
+-# This happens for instance with `./config.status config.h'.
+-if test -n "$CONFIG_FILES"; then
+-
+-
+-ac_cr=`echo X | tr X '\015'`
+-# On cygwin, bash can eat \r inside `` if the user requested igncr.
+-# But we know of no other shell where ac_cr would be empty at this
+-# point, so we can use a bashism as a fallback.
+-if test "x$ac_cr" = x; then
+-  eval ac_cr=\$\'\\r\'
+-fi
+-ac_cs_awk_cr=`$AWK 'BEGIN { print "a\rb" }' </dev/null 2>/dev/null`
+-if test "$ac_cs_awk_cr" = "a${ac_cr}b"; then
+-  ac_cs_awk_cr='\r'
+-else
+-  ac_cs_awk_cr=$ac_cr
+-fi
+-
+-echo 'BEGIN {' >"$tmp/subs1.awk" &&
+-_ACEOF
+-
+-
+-{
+-  echo "cat >conf$$subs.awk <<_ACEOF" &&
+-  echo "$ac_subst_vars" | sed 's/.*/&!$&$ac_delim/' &&
+-  echo "_ACEOF"
+-} >conf$$subs.sh ||
+-  as_fn_error "could not make $CONFIG_STATUS" "$LINENO" 5
+-ac_delim_num=`echo "$ac_subst_vars" | grep -c '$'`
+-ac_delim='%!_!# '
+-for ac_last_try in false false false false false :; do
+-  . ./conf$$subs.sh ||
+-    as_fn_error "could not make $CONFIG_STATUS" "$LINENO" 5
+-
+-  ac_delim_n=`sed -n "s/.*$ac_delim\$/X/p" conf$$subs.awk | grep -c X`
+-  if test $ac_delim_n = $ac_delim_num; then
+-    break
+-  elif $ac_last_try; then
+-    as_fn_error "could not make $CONFIG_STATUS" "$LINENO" 5
+-  else
+-    ac_delim="$ac_delim!$ac_delim _$ac_delim!! "
+-  fi
+-done
+-rm -f conf$$subs.sh
+-
+-cat >>$CONFIG_STATUS <<_ACEOF || ac_write_fail=1
+-cat >>"\$tmp/subs1.awk" <<\\_ACAWK &&
+-_ACEOF
+-sed -n '
+-h
+-s/^/S["/; s/!.*/"]=/
+-p
+-g
+-s/^[^!]*!//
+-:repl
+-t repl
+-s/'"$ac_delim"'$//
+-t delim
+-:nl
+-h
+-s/\(.\{148\}\)..*/\1/
+-t more1
+-s/["\\]/\\&/g; s/^/"/; s/$/\\n"\\/
+-p
+-n
+-b repl
+-:more1
+-s/["\\]/\\&/g; s/^/"/; s/$/"\\/
+-p
+-g
+-s/.\{148\}//
+-t nl
+-:delim
+-h
+-s/\(.\{148\}\)..*/\1/
+-t more2
+-s/["\\]/\\&/g; s/^/"/; s/$/"/
+-p
+-b
+-:more2
+-s/["\\]/\\&/g; s/^/"/; s/$/"\\/
+-p
+-g
+-s/.\{148\}//
+-t delim
+-' <conf$$subs.awk | sed '
+-/^[^""]/{
+-  N
+-  s/\n//
+-}
+-' >>$CONFIG_STATUS || ac_write_fail=1
+-rm -f conf$$subs.awk
+-cat >>$CONFIG_STATUS <<_ACEOF || ac_write_fail=1
+-_ACAWK
+-cat >>"\$tmp/subs1.awk" <<_ACAWK &&
+-  for (key in S) S_is_set[key] = 1
+-  FS = ""
+-
+-}
+-{
+-  line = $ 0
+-  nfields = split(line, field, "@")
+-  substed = 0
+-  len = length(field[1])
+-  for (i = 2; i < nfields; i++) {
+-    key = field[i]
+-    keylen = length(key)
+-    if (S_is_set[key]) {
+-      value = S[key]
+-      line = substr(line, 1, len) "" value "" substr(line, len + keylen + 3)
+-      len += length(value) + length(field[++i])
+-      substed = 1
+-    } else
+-      len += 1 + keylen
+-  }
+-
+-  print line
+-}
+-
+-_ACAWK
+-_ACEOF
+-cat >>$CONFIG_STATUS <<\_ACEOF || ac_write_fail=1
+-if sed "s/$ac_cr//" < /dev/null > /dev/null 2>&1; then
+-  sed "s/$ac_cr\$//; s/$ac_cr/$ac_cs_awk_cr/g"
+-else
+-  cat
+-fi < "$tmp/subs1.awk" > "$tmp/subs.awk" \
+-  || as_fn_error "could not setup config files machinery" "$LINENO" 5
+-_ACEOF
+-
+-# VPATH may cause trouble with some makes, so we remove $(srcdir),
+-# ${srcdir} and @srcdir@ from VPATH if srcdir is ".", strip leading and
+-# trailing colons and then remove the whole line if VPATH becomes empty
+-# (actually we leave an empty line to preserve line numbers).
+-if test "x$srcdir" = x.; then
+-  ac_vpsub='/^[	 ]*VPATH[	 ]*=/{
+-s/:*\$(srcdir):*/:/
+-s/:*\${srcdir}:*/:/
+-s/:*@srcdir@:*/:/
+-s/^\([^=]*=[	 ]*\):*/\1/
+-s/:*$//
+-s/^[^=]*=[	 ]*$//
+-}'
+-fi
+-
+-cat >>$CONFIG_STATUS <<\_ACEOF || ac_write_fail=1
+-fi # test -n "$CONFIG_FILES"
+-
+-# Set up the scripts for CONFIG_HEADERS section.
+-# No need to generate them if there are no CONFIG_HEADERS.
+-# This happens for instance with `./config.status Makefile'.
+-if test -n "$CONFIG_HEADERS"; then
+-cat >"$tmp/defines.awk" <<\_ACAWK ||
+-BEGIN {
+-_ACEOF
+-
+-# Transform confdefs.h into an awk script `defines.awk', embedded as
+-# here-document in config.status, that substitutes the proper values into
+-# config.h.in to produce config.h.
+-
+-# Create a delimiter string that does not exist in confdefs.h, to ease
+-# handling of long lines.
+-ac_delim='%!_!# '
+-for ac_last_try in false false :; do
+-  ac_t=`sed -n "/$ac_delim/p" confdefs.h`
+-  if test -z "$ac_t"; then
+-    break
+-  elif $ac_last_try; then
+-    as_fn_error "could not make $CONFIG_HEADERS" "$LINENO" 5
+-  else
+-    ac_delim="$ac_delim!$ac_delim _$ac_delim!! "
+-  fi
+-done
+-
+-# For the awk script, D is an array of macro values keyed by name,
+-# likewise P contains macro parameters if any.  Preserve backslash
+-# newline sequences.
+-
+-ac_word_re=[_$as_cr_Letters][_$as_cr_alnum]*
+-sed -n '
+-s/.\{148\}/&'"$ac_delim"'/g
+-t rset
+-:rset
+-s/^[	 ]*#[	 ]*define[	 ][	 ]*/ /
+-t def
+-d
+-:def
+-s/\\$//
+-t bsnl
+-s/["\\]/\\&/g
+-s/^ \('"$ac_word_re"'\)\(([^()]*)\)[	 ]*\(.*\)/P["\1"]="\2"\
+-D["\1"]=" \3"/p
+-s/^ \('"$ac_word_re"'\)[	 ]*\(.*\)/D["\1"]=" \2"/p
+-d
+-:bsnl
+-s/["\\]/\\&/g
+-s/^ \('"$ac_word_re"'\)\(([^()]*)\)[	 ]*\(.*\)/P["\1"]="\2"\
+-D["\1"]=" \3\\\\\\n"\\/p
+-t cont
+-s/^ \('"$ac_word_re"'\)[	 ]*\(.*\)/D["\1"]=" \2\\\\\\n"\\/p
+-t cont
+-d
+-:cont
+-n
+-s/.\{148\}/&'"$ac_delim"'/g
+-t clear
+-:clear
+-s/\\$//
+-t bsnlc
+-s/["\\]/\\&/g; s/^/"/; s/$/"/p
+-d
+-:bsnlc
+-s/["\\]/\\&/g; s/^/"/; s/$/\\\\\\n"\\/p
+-b cont
+-' <confdefs.h | sed '
+-s/'"$ac_delim"'/"\\\
+-"/g' >>$CONFIG_STATUS || ac_write_fail=1
+-
+-cat >>$CONFIG_STATUS <<_ACEOF || ac_write_fail=1
+-  for (key in D) D_is_set[key] = 1
+-  FS = ""
+-}
+-/^[\t ]*#[\t ]*(define|undef)[\t ]+$ac_word_re([\t (]|\$)/ {
+-  line = \$ 0
+-  split(line, arg, " ")
+-  if (arg[1] == "#") {
+-    defundef = arg[2]
+-    mac1 = arg[3]
+-  } else {
+-    defundef = substr(arg[1], 2)
+-    mac1 = arg[2]
+-  }
+-  split(mac1, mac2, "(") #)
+-  macro = mac2[1]
+-  prefix = substr(line, 1, index(line, defundef) - 1)
+-  if (D_is_set[macro]) {
+-    # Preserve the white space surrounding the "#".
+-    print prefix "define", macro P[macro] D[macro]
+-    next
+-  } else {
+-    # Replace #undef with comments.  This is necessary, for example,
+-    # in the case of _POSIX_SOURCE, which is predefined and required
+-    # on some systems where configure will not decide to define it.
+-    if (defundef == "undef") {
+-      print "/*", prefix defundef, macro, "*/"
+-      next
+-    }
+-  }
+-}
+-{ print }
+-_ACAWK
+-_ACEOF
+-cat >>$CONFIG_STATUS <<\_ACEOF || ac_write_fail=1
+-  as_fn_error "could not setup config headers machinery" "$LINENO" 5
+-fi # test -n "$CONFIG_HEADERS"
+-
+-
+-eval set X "  :F $CONFIG_FILES  :H $CONFIG_HEADERS    :C $CONFIG_COMMANDS"
+-shift
+-for ac_tag
+-do
+-  case $ac_tag in
+-  :[FHLC]) ac_mode=$ac_tag; continue;;
+-  esac
+-  case $ac_mode$ac_tag in
+-  :[FHL]*:*);;
+-  :L* | :C*:*) as_fn_error "invalid tag \`$ac_tag'" "$LINENO" 5;;
+-  :[FH]-) ac_tag=-:-;;
+-  :[FH]*) ac_tag=$ac_tag:$ac_tag.in;;
+-  esac
+-  ac_save_IFS=$IFS
+-  IFS=:
+-  set x $ac_tag
+-  IFS=$ac_save_IFS
+-  shift
+-  ac_file=$1
+-  shift
+-
+-  case $ac_mode in
+-  :L) ac_source=$1;;
+-  :[FH])
+-    ac_file_inputs=
+-    for ac_f
+-    do
+-      case $ac_f in
+-      -) ac_f="$tmp/stdin";;
+-      *) # Look for the file first in the build tree, then in the source tree
+-	 # (if the path is not absolute).  The absolute path cannot be DOS-style,
+-	 # because $ac_f cannot contain `:'.
+-	 test -f "$ac_f" ||
+-	   case $ac_f in
+-	   [\\/$]*) false;;
+-	   *) test -f "$srcdir/$ac_f" && ac_f="$srcdir/$ac_f";;
+-	   esac ||
+-	   as_fn_error "cannot find input file: \`$ac_f'" "$LINENO" 5;;
+-      esac
+-      case $ac_f in *\'*) ac_f=`$as_echo "$ac_f" | sed "s/'/'\\\\\\\\''/g"`;; esac
+-      as_fn_append ac_file_inputs " '$ac_f'"
+-    done
+-
+-    # Let's still pretend it is `configure' which instantiates (i.e., don't
+-    # use $as_me), people would be surprised to read:
+-    #    /* config.h.  Generated by config.status.  */
+-    configure_input='Generated from '`
+-	  $as_echo "$*" | sed 's|^[^:]*/||;s|:[^:]*/|, |g'
+-	`' by configure.'
+-    if test x"$ac_file" != x-; then
+-      configure_input="$ac_file.  $configure_input"
+-      { $as_echo "$as_me:${as_lineno-$LINENO}: creating $ac_file" >&5
+-$as_echo "$as_me: creating $ac_file" >&6;}
+-    fi
+-    # Neutralize special characters interpreted by sed in replacement strings.
+-    case $configure_input in #(
+-    *\&* | *\|* | *\\* )
+-       ac_sed_conf_input=`$as_echo "$configure_input" |
+-       sed 's/[\\\\&|]/\\\\&/g'`;; #(
+-    *) ac_sed_conf_input=$configure_input;;
+-    esac
+-
+-    case $ac_tag in
+-    *:-:* | *:-) cat >"$tmp/stdin" \
+-      || as_fn_error "could not create $ac_file" "$LINENO" 5 ;;
+-    esac
+-    ;;
+-  esac
+-
+-  ac_dir=`$as_dirname -- "$ac_file" ||
+-$as_expr X"$ac_file" : 'X\(.*[^/]\)//*[^/][^/]*/*$' \| \
+-	 X"$ac_file" : 'X\(//\)[^/]' \| \
+-	 X"$ac_file" : 'X\(//\)$' \| \
+-	 X"$ac_file" : 'X\(/\)' \| . 2>/dev/null ||
+-$as_echo X"$ac_file" |
+-    sed '/^X\(.*[^/]\)\/\/*[^/][^/]*\/*$/{
+-	    s//\1/
+-	    q
+-	  }
+-	  /^X\(\/\/\)[^/].*/{
+-	    s//\1/
+-	    q
+-	  }
+-	  /^X\(\/\/\)$/{
+-	    s//\1/
+-	    q
+-	  }
+-	  /^X\(\/\).*/{
+-	    s//\1/
+-	    q
+-	  }
+-	  s/.*/./; q'`
+-  as_dir="$ac_dir"; as_fn_mkdir_p
+-  ac_builddir=.
+-
+-case "$ac_dir" in
+-.) ac_dir_suffix= ac_top_builddir_sub=. ac_top_build_prefix= ;;
+-*)
+-  ac_dir_suffix=/`$as_echo "$ac_dir" | sed 's|^\.[\\/]||'`
+-  # A ".." for each directory in $ac_dir_suffix.
+-  ac_top_builddir_sub=`$as_echo "$ac_dir_suffix" | sed 's|/[^\\/]*|/..|g;s|/||'`
+-  case $ac_top_builddir_sub in
+-  "") ac_top_builddir_sub=. ac_top_build_prefix= ;;
+-  *)  ac_top_build_prefix=$ac_top_builddir_sub/ ;;
+-  esac ;;
+-esac
+-ac_abs_top_builddir=$ac_pwd
+-ac_abs_builddir=$ac_pwd$ac_dir_suffix
+-# for backward compatibility:
+-ac_top_builddir=$ac_top_build_prefix
+-
+-case $srcdir in
+-  .)  # We are building in place.
+-    ac_srcdir=.
+-    ac_top_srcdir=$ac_top_builddir_sub
+-    ac_abs_top_srcdir=$ac_pwd ;;
+-  [\\/]* | ?:[\\/]* )  # Absolute name.
+-    ac_srcdir=$srcdir$ac_dir_suffix;
+-    ac_top_srcdir=$srcdir
+-    ac_abs_top_srcdir=$srcdir ;;
+-  *) # Relative name.
+-    ac_srcdir=$ac_top_build_prefix$srcdir$ac_dir_suffix
+-    ac_top_srcdir=$ac_top_build_prefix$srcdir
+-    ac_abs_top_srcdir=$ac_pwd/$srcdir ;;
+-esac
+-ac_abs_srcdir=$ac_abs_top_srcdir$ac_dir_suffix
+-
+-
+-  case $ac_mode in
+-  :F)
+-  #
+-  # CONFIG_FILE
+-  #
+-
+-  case $INSTALL in
+-  [\\/$]* | ?:[\\/]* ) ac_INSTALL=$INSTALL ;;
+-  *) ac_INSTALL=$ac_top_build_prefix$INSTALL ;;
+-  esac
+-  ac_MKDIR_P=$MKDIR_P
+-  case $MKDIR_P in
+-  [\\/$]* | ?:[\\/]* ) ;;
+-  */*) ac_MKDIR_P=$ac_top_build_prefix$MKDIR_P ;;
+-  esac
+-_ACEOF
+-
+-cat >>$CONFIG_STATUS <<\_ACEOF || ac_write_fail=1
+-# If the template does not know about datarootdir, expand it.
+-# FIXME: This hack should be removed a few years after 2.60.
+-ac_datarootdir_hack=; ac_datarootdir_seen=
+-ac_sed_dataroot='
+-/datarootdir/ {
+-  p
+-  q
+-}
+-/@datadir@/p
+-/@docdir@/p
+-/@infodir@/p
+-/@localedir@/p
+-/@mandir@/p'
+-case `eval "sed -n \"\$ac_sed_dataroot\" $ac_file_inputs"` in
+-*datarootdir*) ac_datarootdir_seen=yes;;
+-*@datadir@*|*@docdir@*|*@infodir@*|*@localedir@*|*@mandir@*)
+-  { $as_echo "$as_me:${as_lineno-$LINENO}: WARNING: $ac_file_inputs seems to ignore the --datarootdir setting" >&5
+-$as_echo "$as_me: WARNING: $ac_file_inputs seems to ignore the --datarootdir setting" >&2;}
+-_ACEOF
+-cat >>$CONFIG_STATUS <<_ACEOF || ac_write_fail=1
+-  ac_datarootdir_hack='
+-  s&@datadir@&$datadir&g
+-  s&@docdir@&$docdir&g
+-  s&@infodir@&$infodir&g
+-  s&@localedir@&$localedir&g
+-  s&@mandir@&$mandir&g
+-  s&\\\${datarootdir}&$datarootdir&g' ;;
+-esac
+-_ACEOF
+-
+-# Neutralize VPATH when `$srcdir' = `.'.
+-# Shell code in configure.ac might set extrasub.
+-# FIXME: do we really want to maintain this feature?
+-cat >>$CONFIG_STATUS <<_ACEOF || ac_write_fail=1
+-ac_sed_extra="$ac_vpsub
+-$extrasub
+-_ACEOF
+-cat >>$CONFIG_STATUS <<\_ACEOF || ac_write_fail=1
+-:t
+-/@[a-zA-Z_][a-zA-Z_0-9]*@/!b
+-s|@configure_input@|$ac_sed_conf_input|;t t
+-s&@top_builddir@&$ac_top_builddir_sub&;t t
+-s&@top_build_prefix@&$ac_top_build_prefix&;t t
+-s&@srcdir@&$ac_srcdir&;t t
+-s&@abs_srcdir@&$ac_abs_srcdir&;t t
+-s&@top_srcdir@&$ac_top_srcdir&;t t
+-s&@abs_top_srcdir@&$ac_abs_top_srcdir&;t t
+-s&@builddir@&$ac_builddir&;t t
+-s&@abs_builddir@&$ac_abs_builddir&;t t
+-s&@abs_top_builddir@&$ac_abs_top_builddir&;t t
+-s&@INSTALL@&$ac_INSTALL&;t t
+-s&@MKDIR_P@&$ac_MKDIR_P&;t t
+-$ac_datarootdir_hack
+-"
+-eval sed \"\$ac_sed_extra\" "$ac_file_inputs" | $AWK -f "$tmp/subs.awk" >$tmp/out \
+-  || as_fn_error "could not create $ac_file" "$LINENO" 5
+-
+-test -z "$ac_datarootdir_hack$ac_datarootdir_seen" &&
+-  { ac_out=`sed -n '/\${datarootdir}/p' "$tmp/out"`; test -n "$ac_out"; } &&
+-  { ac_out=`sed -n '/^[	 ]*datarootdir[	 ]*:*=/p' "$tmp/out"`; test -z "$ac_out"; } &&
+-  { $as_echo "$as_me:${as_lineno-$LINENO}: WARNING: $ac_file contains a reference to the variable \`datarootdir'
+-which seems to be undefined.  Please make sure it is defined." >&5
+-$as_echo "$as_me: WARNING: $ac_file contains a reference to the variable \`datarootdir'
+-which seems to be undefined.  Please make sure it is defined." >&2;}
+-
+-  rm -f "$tmp/stdin"
+-  case $ac_file in
+-  -) cat "$tmp/out" && rm -f "$tmp/out";;
+-  *) rm -f "$ac_file" && mv "$tmp/out" "$ac_file";;
+-  esac \
+-  || as_fn_error "could not create $ac_file" "$LINENO" 5
+- ;;
+-  :H)
+-  #
+-  # CONFIG_HEADER
+-  #
+-  if test x"$ac_file" != x-; then
+-    {
+-      $as_echo "/* $configure_input  */" \
+-      && eval '$AWK -f "$tmp/defines.awk"' "$ac_file_inputs"
+-    } >"$tmp/config.h" \
+-      || as_fn_error "could not create $ac_file" "$LINENO" 5
+-    if diff "$ac_file" "$tmp/config.h" >/dev/null 2>&1; then
+-      { $as_echo "$as_me:${as_lineno-$LINENO}: $ac_file is unchanged" >&5
+-$as_echo "$as_me: $ac_file is unchanged" >&6;}
+-    else
+-      rm -f "$ac_file"
+-      mv "$tmp/config.h" "$ac_file" \
+-	|| as_fn_error "could not create $ac_file" "$LINENO" 5
+-    fi
+-  else
+-    $as_echo "/* $configure_input  */" \
+-      && eval '$AWK -f "$tmp/defines.awk"' "$ac_file_inputs" \
+-      || as_fn_error "could not create -" "$LINENO" 5
+-  fi
+-# Compute "$ac_file"'s index in $config_headers.
+-_am_arg="$ac_file"
+-_am_stamp_count=1
+-for _am_header in $config_headers :; do
+-  case $_am_header in
+-    $_am_arg | $_am_arg:* )
+-      break ;;
+-    * )
+-      _am_stamp_count=`expr $_am_stamp_count + 1` ;;
+-  esac
+-done
+-echo "timestamp for $_am_arg" >`$as_dirname -- "$_am_arg" ||
+-$as_expr X"$_am_arg" : 'X\(.*[^/]\)//*[^/][^/]*/*$' \| \
+-	 X"$_am_arg" : 'X\(//\)[^/]' \| \
+-	 X"$_am_arg" : 'X\(//\)$' \| \
+-	 X"$_am_arg" : 'X\(/\)' \| . 2>/dev/null ||
+-$as_echo X"$_am_arg" |
+-    sed '/^X\(.*[^/]\)\/\/*[^/][^/]*\/*$/{
+-	    s//\1/
+-	    q
+-	  }
+-	  /^X\(\/\/\)[^/].*/{
+-	    s//\1/
+-	    q
+-	  }
+-	  /^X\(\/\/\)$/{
+-	    s//\1/
+-	    q
+-	  }
+-	  /^X\(\/\).*/{
+-	    s//\1/
+-	    q
+-	  }
+-	  s/.*/./; q'`/stamp-h$_am_stamp_count
+- ;;
+-
+-  :C)  { $as_echo "$as_me:${as_lineno-$LINENO}: executing $ac_file commands" >&5
+-$as_echo "$as_me: executing $ac_file commands" >&6;}
+- ;;
+-  esac
+-
+-
+-  case $ac_file$ac_mode in
+-    "depfiles":C) test x"$AMDEP_TRUE" != x"" || {
+-  # Autoconf 2.62 quotes --file arguments for eval, but not when files
+-  # are listed without --file.  Let's play safe and only enable the eval
+-  # if we detect the quoting.
+-  case $CONFIG_FILES in
+-  *\'*) eval set x "$CONFIG_FILES" ;;
+-  *)   set x $CONFIG_FILES ;;
+-  esac
+-  shift
+-  for mf
+-  do
+-    # Strip MF so we end up with the name of the file.
+-    mf=`echo "$mf" | sed -e 's/:.*$//'`
+-    # Check whether this is an Automake generated Makefile or not.
+-    # We used to match only the files named `Makefile.in', but
+-    # some people rename them; so instead we look at the file content.
+-    # Grep'ing the first line is not enough: some people post-process
+-    # each Makefile.in and add a new line on top of each file to say so.
+-    # Grep'ing the whole file is not good either: AIX grep has a line
+-    # limit of 2048, but all sed's we know have understand at least 4000.
+-    if sed -n 's,^#.*generated by automake.*,X,p' "$mf" | grep X >/dev/null 2>&1; then
+-      dirpart=`$as_dirname -- "$mf" ||
+-$as_expr X"$mf" : 'X\(.*[^/]\)//*[^/][^/]*/*$' \| \
+-	 X"$mf" : 'X\(//\)[^/]' \| \
+-	 X"$mf" : 'X\(//\)$' \| \
+-	 X"$mf" : 'X\(/\)' \| . 2>/dev/null ||
+-$as_echo X"$mf" |
+-    sed '/^X\(.*[^/]\)\/\/*[^/][^/]*\/*$/{
+-	    s//\1/
+-	    q
+-	  }
+-	  /^X\(\/\/\)[^/].*/{
+-	    s//\1/
+-	    q
+-	  }
+-	  /^X\(\/\/\)$/{
+-	    s//\1/
+-	    q
+-	  }
+-	  /^X\(\/\).*/{
+-	    s//\1/
+-	    q
+-	  }
+-	  s/.*/./; q'`
+-    else
+-      continue
+-    fi
+-    # Extract the definition of DEPDIR, am__include, and am__quote
+-    # from the Makefile without running `make'.
+-    DEPDIR=`sed -n 's/^DEPDIR = //p' < "$mf"`
+-    test -z "$DEPDIR" && continue
+-    am__include=`sed -n 's/^am__include = //p' < "$mf"`
+-    test -z "am__include" && continue
+-    am__quote=`sed -n 's/^am__quote = //p' < "$mf"`
+-    # When using ansi2knr, U may be empty or an underscore; expand it
+-    U=`sed -n 's/^U = //p' < "$mf"`
+-    # Find all dependency output files, they are included files with
+-    # $(DEPDIR) in their names.  We invoke sed twice because it is the
+-    # simplest approach to changing $(DEPDIR) to its actual value in the
+-    # expansion.
+-    for file in `sed -n "
+-      s/^$am__include $am__quote\(.*(DEPDIR).*\)$am__quote"'$/\1/p' <"$mf" | \
+-	 sed -e 's/\$(DEPDIR)/'"$DEPDIR"'/g' -e 's/\$U/'"$U"'/g'`; do
+-      # Make sure the directory exists.
+-      test -f "$dirpart/$file" && continue
+-      fdir=`$as_dirname -- "$file" ||
+-$as_expr X"$file" : 'X\(.*[^/]\)//*[^/][^/]*/*$' \| \
+-	 X"$file" : 'X\(//\)[^/]' \| \
+-	 X"$file" : 'X\(//\)$' \| \
+-	 X"$file" : 'X\(/\)' \| . 2>/dev/null ||
+-$as_echo X"$file" |
+-    sed '/^X\(.*[^/]\)\/\/*[^/][^/]*\/*$/{
+-	    s//\1/
+-	    q
+-	  }
+-	  /^X\(\/\/\)[^/].*/{
+-	    s//\1/
+-	    q
+-	  }
+-	  /^X\(\/\/\)$/{
+-	    s//\1/
+-	    q
+-	  }
+-	  /^X\(\/\).*/{
+-	    s//\1/
+-	    q
+-	  }
+-	  s/.*/./; q'`
+-      as_dir=$dirpart/$fdir; as_fn_mkdir_p
+-      # echo "creating $dirpart/$file"
+-      echo '# dummy' > "$dirpart/$file"
+-    done
+-  done
+-}
+- ;;
+-
+-  esac
+-done # for ac_tag
+-
+-
+-as_fn_exit 0
+-_ACEOF
+-ac_clean_files=$ac_clean_files_save
+-
+-test $ac_write_fail = 0 ||
+-  as_fn_error "write failure creating $CONFIG_STATUS" "$LINENO" 5
+-
+-
+-# configure is writing to config.log, and then calls config.status.
+-# config.status does its own redirection, appending to config.log.
+-# Unfortunately, on DOS this fails, as config.log is still kept open
+-# by configure, so config.status won't be able to write to it; its
+-# output is simply discarded.  So we exec the FD to /dev/null,
+-# effectively closing config.log, so it can be properly (re)opened and
+-# appended to by config.status.  When coming back to configure, we
+-# need to make the FD available again.
+-if test "$no_create" != yes; then
+-  ac_cs_success=:
+-  ac_config_status_args=
+-  test "$silent" = yes &&
+-    ac_config_status_args="$ac_config_status_args --quiet"
+-  exec 5>/dev/null
+-  $SHELL $CONFIG_STATUS $ac_config_status_args || ac_cs_success=false
+-  exec 5>>config.log
+-  # Use ||, not &&, to avoid exiting from the if with $? = 1, which
+-  # would make configure fail if this is the last instruction.
+-  $ac_cs_success || as_fn_exit $?
+-fi
+-if test -n "$ac_unrecognized_opts" && test "$enable_option_checking" != no; then
+-  { $as_echo "$as_me:${as_lineno-$LINENO}: WARNING: unrecognized options: $ac_unrecognized_opts" >&5
+-$as_echo "$as_me: WARNING: unrecognized options: $ac_unrecognized_opts" >&2;}
+-fi
+-
+diff -Nur dosbox-0.74/configure.ac dosbox/configure.ac
+--- dosbox-0.74/configure.ac	1970-01-01 01:00:00.000000000 +0100
++++ dosbox/configure.ac	2014-01-12 14:43:47.000000000 +0100
+@@ -0,0 +1,528 @@
++dnl Init.
++AC_INIT(dosbox,SVN)
++AC_PREREQ(2.50)
++AC_CONFIG_SRCDIR(README)
++
++dnl Detect the canonical host and target build environment
++AC_CANONICAL_HOST
++AC_CANONICAL_BUILD
++
++dnl Setup for automake
++AM_INIT_AUTOMAKE
++AC_CONFIG_HEADER(config.h)
++
++dnl Checks for programs.
++AC_PROG_MAKE_SET
++AC_PROG_CC
++AC_PROG_CPP
++AC_PROG_CXX
++AC_PROG_INSTALL
++AC_PROG_RANLIB
++
++dnl Some needed libaries for OS2
++dnl perharps join this with the other target depended checks. move them upwards
++if test x$host = xi386-pc-os2-emx ; then
++    CXXFLAGS="$CXXFLAGS -Zmt"
++    LDFLAGS="$LDFLAGS -Zomf -Zmt"
++    LIBS="$LIBS -los2me"
++fi
++
++dnl Check for SDL
++SDL_VERSION=1.2.0
++AM_PATH_SDL($SDL_VERSION,
++            :,
++	    AC_MSG_ERROR([*** SDL version $SDL_VERSION not found!])
++)
++LIBS="$LIBS $SDL_LIBS"
++CPPFLAGS="$CPPFLAGS $SDL_CFLAGS"
++
++dnl Check if SDL is 1.2.x (1.3 not supported)
++AC_MSG_CHECKING([SDL version only being 1.2.X])
++AC_COMPILE_IFELSE([AC_LANG_SOURCE([
++#include "SDL.h"
++void blah(){
++#if SDL_MINOR_VERSION != 2
++#error "Only SDL 1.2 supported"
++#endif
++;
++}
++])],AC_MSG_RESULT([yes]),[
++ AC_MSG_RESULT([no]) 
++ AC_MSG_ERROR([Only libSDL 1.2.X supported])])
++
++dnl Checks for header files.
++
++dnl Checks for typedefs, structures, and compiler characteristics.
++AC_C_CONST
++AC_C_INLINE
++AC_TYPE_SIZE_T
++AC_STRUCT_TM
++AC_CHECK_SIZEOF(unsigned char)
++AC_CHECK_SIZEOF(unsigned short)
++AC_CHECK_SIZEOF(unsigned int)
++AC_CHECK_SIZEOF(unsigned long)
++AC_CHECK_SIZEOF(unsigned long long)
++AC_CHECK_SIZEOF(int *)
++
++dnl some semi complex check for sys/socket so it works on darwin as well
++AC_CHECK_HEADERS([stdlib.h sys/types.h])
++AC_CHECK_HEADERS([sys/socket.h  netinet/in.h pwd.h], [], [],
++[#include <stdio.h>
++#ifdef STDC_HEADERS
++# include <stdlib.h>
++# include <stddef.h>
++#else
++# ifdef HAVE_STDLIB_H
++#  include <stdlib.h>
++# endif
++#endif
++#ifdef HAVE_SYS_TYPES_H
++# include <sys/types.h>
++#endif
++])
++
++dnl check for the socklen_t (darwin doesn't always have it)
++AC_COMPILE_IFELSE([AC_LANG_SOURCE([
++#include <stdio.h>
++#ifdef STDC_HEADERS
++# include <stdlib.h>
++# include <stddef.h>
++#else
++# ifdef HAVE_STDLIB_H
++#  include <stdlib.h>
++# endif
++#endif
++#ifdef HAVE_SYS_TYPES_H
++# include <sys/types.h>
++#endif
++#ifdef HAVE_SYS_SOCKET_H
++#include <sys/socket.h>
++#endif
++])],[],[AC_DEFINE([socklen_t],[int],[Define to `int` if you don't have socklen_t])])
++
++AC_MSG_CHECKING(if environ can be included)
++AC_LINK_IFELSE([AC_LANG_PROGRAM([[
++#include <unistd.h>
++#include <stdlib.h>]],[[*environ;]])],
++[AC_MSG_RESULT(yes);AC_DEFINE(ENVIRON_INCLUDED,1,[environ can be included])],AC_MSG_RESULT(no))
++
++AC_MSG_CHECKING(if environ can be linked)
++AC_LINK_IFELSE([AC_LANG_PROGRAM([[extern char ** environ;]],[[*environ;]])],
++[AC_MSG_RESULT(yes);AC_DEFINE(ENVIRON_LINKED,1,[environ can be linked])],AC_MSG_RESULT(no))
++
++AC_MSG_CHECKING([if dirent includes d_type])
++AC_COMPILE_IFELSE([AC_LANG_SOURCE([
++#include <sys/types.h>
++#include <dirent.h>
++void blah(){
++struct dirent d_test;
++d_test.d_type = 0;
++}])],[AC_MSG_RESULT(yes);AC_DEFINE(DIRENT_HAS_D_TYPE,1,[struct dirent has d_type])],AC_MSG_RESULT(no))
++
++
++dnl Check for powf
++AC_MSG_CHECKING(for powf in libm);
++LIBS_BACKUP=$LIBS;
++LIBS="$LIBS -lm";
++AC_LINK_IFELSE([AC_LANG_PROGRAM([[#include <math.h>]],[[
++        powf(1.0f, 1.0f);
++]])], [AC_MSG_RESULT(yes)], [AC_DEFINE([DB_HAVE_NO_POWF],[1],[libm doesn't include powf])])
++LIBS=$LIBS_BACKUP
++
++
++dnl Checks for libraries.
++
++#Check if the compiler support attributes
++AH_TEMPLATE([C_HAS_ATTRIBUTE],[Determines if the compilers supports attributes for structures.])
++AC_MSG_CHECKING(if compiler allows __attribute__)
++AC_COMPILE_IFELSE([AC_LANG_PROGRAM([[
++typedef struct { } __attribute__((packed)) junk;]],
++[[ ]])],[ AC_MSG_RESULT(yes);AC_DEFINE(C_HAS_ATTRIBUTE)],AC_MSG_RESULT(no))
++
++
++#Check if the compiler supports certain attributes
++OLDCFLAGS="$CFLAGS"
++CFLAGS="-Werror"
++
++AH_TEMPLATE([C_ATTRIBUTE_ALWAYS_INLINE],[Determines if the compilers supports always_inline attribute.])
++AC_MSG_CHECKING(if compiler allows __attribute__((always_inline)) )
++AC_COMPILE_IFELSE([AC_LANG_SOURCE([ void __attribute__((always_inline)) test(){}
++])],[ AC_MSG_RESULT(yes);AC_DEFINE(C_ATTRIBUTE_ALWAYS_INLINE)],AC_MSG_RESULT(no))
++
++AH_TEMPLATE([C_ATTRIBUTE_FASTCALL],[Determines if the compilers supports fastcall attribute.])
++AC_MSG_CHECKING(if compiler allows __attribute__((fastcall)) )
++AC_COMPILE_IFELSE([AC_LANG_SOURCE([ void __attribute__((fastcall)) test(){}
++])],[ AC_MSG_RESULT(yes);AC_DEFINE(C_ATTRIBUTE_FASTCALL)],AC_MSG_RESULT(no))
++
++
++CFLAGS="$OLDCFLAGS"
++
++
++#Check if the compiler supports __builtin_expect
++#Switch language to c++
++AC_LANG_PUSH(C++)
++AH_TEMPLATE([C_HAS_BUILTIN_EXPECT],[Determines if the compilers supports __builtin_expect for branch prediction.])
++AC_MSG_CHECKING(if compiler allows __builtin_expect)
++AC_COMPILE_IFELSE([AC_LANG_PROGRAM([[]],[[
++int x=10;if( __builtin_expect ((x==1),0) ) ;
++]])], [ AC_MSG_RESULT(yes);AC_DEFINE(C_HAS_BUILTIN_EXPECT)],AC_MSG_RESULT(no))
++#switch language back
++AC_LANG_POP(C++)
++
++dnl enable disable alsa and pass it's cflags to CXXFLAGS
++AC_ARG_ENABLE(alsa-midi,
++AC_HELP_STRING([--enable-alsa-midi],[compile with alsa midi support (default yes)]),
++[ case "${enableval}" in
++ yes) alsa_midi=true;;
++ no)  alsa_midi=false;;
++esac],
++[alsa_midi=true])
++if test x$alsa_midi = xtrue ; then 
++  AM_PATH_ALSA(0.9.0, AC_DEFINE(HAVE_ALSA,1,[Define to 1 to use ALSA for MIDI]) , : )
++  CXXFLAGS="$CXXFLAGS $ALSA_CFLAGS"
++fi
++
++#Check for big endian machine, should #define WORDS_BIGENDIAN if so
++AC_C_BIGENDIAN
++
++#Features to enable/disable
++AH_TEMPLATE(C_DEBUG,[Define to 1 to enable internal debugger, requires libcurses])
++AH_TEMPLATE(C_HEAVY_DEBUG,[Define to 1 to enable heavy debugging, also have to enable C_DEBUG])
++AC_ARG_ENABLE(debug,AC_HELP_STRING([--enable-debug],[Enable debug mode]),[
++   AC_CHECK_HEADER(curses.h,have_curses_h=yes,)
++   AC_CHECK_LIB(curses, initscr, have_curses_lib=yes, , )
++   AC_CHECK_LIB(ncurses, initscr, have_ncurses_lib=yes, , )
++   AC_CHECK_LIB(pdcurses, initscr, have_pdcurses_lib=yes, , )
++
++   if test x$enable_debug = xno; then
++     AC_MSG_RESULT([Debugger not enabled])
++   elif test x$have_curses_lib = xyes -a x$have_curses_h = xyes ; then
++     LIBS="$LIBS -lcurses"
++     AC_DEFINE(C_DEBUG,1)
++     if test x$enable_debug = xheavy ; then 
++       AC_DEFINE(C_HEAVY_DEBUG,1)
++     fi
++   elif test x$have_ncurses_lib = xyes -a x$have_curses_h = xyes ; then
++     LIBS="$LIBS -lncurses"
++     AC_DEFINE(C_DEBUG,1)
++     if test x$enable_debug = xheavy ; then 
++       AC_DEFINE(C_HEAVY_DEBUG,1)
++     fi
++   elif test x$have_pdcurses_lib = xyes -a x$have_curses_h = xyes ; then
++     LIBS="$LIBS -lpdcurses"
++     AC_DEFINE(C_DEBUG,1)
++     if test x$enable_debug = xheavy ; then 
++       AC_DEFINE(C_HEAVY_DEBUG,1)
++     fi
++   else 
++     AC_MSG_ERROR([Can't find curses, which is required for debug mode])
++   fi
++],)
++
++AH_TEMPLATE(C_CORE_INLINE,[Define to 1 to use inlined memory functions in cpu core])
++AC_ARG_ENABLE(core-inline,AC_HELP_STRING([--enable-core-inline],[Enable inlined memory handling in CPU Core]),[
++  if test x$enable_core_inline = xyes ; then 
++    AC_MSG_RESULT([enabling inlined memory handling in CPU Core])
++    AC_DEFINE(C_CORE_INLINE,1)
++  fi
++],)
++
++
++dnl The target cpu checks for dynamic cores
++AH_TEMPLATE(C_TARGETCPU,[The type of cpu this target has])
++AC_MSG_CHECKING(for target cpu type) 
++case "$host_cpu" in
++  x86_64 | amd64)
++    AC_DEFINE(C_TARGETCPU,X86_64)
++    AC_MSG_RESULT(x86-64 bit compatible)
++    c_targetcpu="x86_64"
++    c_unalignedmemory=yes
++    ;;
++  i?86)
++    AC_DEFINE(C_TARGETCPU,X86)
++    AC_MSG_RESULT(x86 compatible)
++    c_targetcpu="x86"
++    c_unalignedmemory=yes
++    ;;
++   powerpc*)
++    AC_DEFINE(C_TARGETCPU,POWERPC)
++    AC_MSG_RESULT(Power PC)
++    c_targetcpu="powerpc"
++    c_unalignedmemory=yes
++    ;;
++   m68k*)
++    AC_DEFINE(C_TARGETCPU,M68K)
++    AC_MSG_RESULT(Motorola 68000)
++    c_targetcpu="m68k"
++    c_unalignedmemory=yes
++    ;;
++   *)
++    AC_DEFINE(C_TARGETCPU,UNKNOWN)
++    AC_MSG_RESULT(unknown)
++    c_unalignedmemory=no
++    ;;
++esac
++
++AC_ARG_ENABLE(dynamic-core,AC_HELP_STRING([--disable-dynamic-core],[Disable all dynamic cores]),,enable_dynamic_core=yes)
++
++AH_TEMPLATE(C_DYNAMIC_X86,[Define to 1 to use x86 dynamic cpu core])
++AC_ARG_ENABLE(dynamic-x86,AC_HELP_STRING([--disable-dynamic-x86],[Disable x86 dynamic cpu core]),,enable_dynamic_x86=yes)
++AC_MSG_CHECKING(whether x86 dynamic cpu core will be enabled) 
++if test x$enable_dynamic_x86 = xno -o x$enable_dynamic_core = xno; then 
++   AC_MSG_RESULT(no)
++else
++  if test x$c_targetcpu = xx86 ; then
++      AC_DEFINE(C_DYNAMIC_X86,1)
++      AC_MSG_RESULT(yes)
++  else
++      AC_MSG_RESULT(no)
++  fi
++fi
++
++AH_TEMPLATE(C_DYNREC,[Define to 1 to use recompiling cpu core. Can not be used together with the dynamic-x86 core])
++AC_ARG_ENABLE(dynrec,AC_HELP_STRING([--disable-dynrec],[Disable recompiling cpu core]),,enable_dynrec=yes)
++AC_MSG_CHECKING(whether recompiling cpu core will be enabled) 
++if test x$enable_dynrec = xno -o x$enable_dynamic_core = xno; then 
++   AC_MSG_RESULT(no)
++else
++dnl x86 only enable it if dynamic-x86 is disabled.
++  if test x$c_targetcpu = xx86 ; then
++    if test x$enable_dynamic_x86 = xno ; then
++        AC_DEFINE(C_DYNREC,1)
++        AC_MSG_RESULT(yes)
++    else
++        AC_MSG_RESULT([no, using dynamic-x86])
++    fi
++  else 
++    if test x$c_targetcpu = xx86_64 ; then
++        AC_DEFINE(C_DYNREC,1)
++        AC_MSG_RESULT(yes)
++    else      
++      AC_MSG_RESULT(no)
++    fi
++  fi
++fi
++
++AH_TEMPLATE(C_FPU,[Define to 1 to enable floating point emulation])
++AC_ARG_ENABLE(fpu,AC_HELP_STRING([--disable-fpu],[Disable fpu support]),,enable_fpu=yes)
++AC_MSG_CHECKING(whether fpu emulation will be enabled) 
++if test x$enable_fpu = xyes ; then 
++  AC_MSG_RESULT(yes)
++  AC_DEFINE(C_FPU,1)
++else 
++  AC_MSG_RESULT(no)
++fi 
++
++AH_TEMPLATE(C_FPU_X86,[Define to 1 to use a x86 assembly fpu core])
++AC_ARG_ENABLE(fpu-x86,AC_HELP_STRING([--disable-fpu-x86],[Disable x86 assembly fpu core]),,enable_fpu_x86=yes)
++AC_MSG_CHECKING(whether x86 assembly fpu core will be enabled) 
++if test x$enable_fpu_x86 = xno ; then 
++   AC_MSG_RESULT(no)
++else
++  if test x$enable_fpu = xyes; then
++    if test x$c_targetcpu = xx86 -o x$c_targetcpu = xx86_64; then
++        AC_DEFINE(C_FPU_X86,1)
++        AC_MSG_RESULT(yes)
++    else
++        AC_MSG_RESULT(no)
++    fi
++  else
++      AC_MSG_RESULT(no)
++  fi
++fi
++
++AH_TEMPLATE(C_UNALIGNED_MEMORY,[Define to 1 to use a unaligned memory access])
++AC_ARG_ENABLE(unaligned_memory,AC_HELP_STRING([--disable-unaligned-memory],[Disable unaligned memory access]),,enable_unaligned_memory=yes)
++AC_MSG_CHECKING(whether to enable unaligned memory access) 
++if test x$enable_unaligned_memory = xyes -a x$c_unalignedmemory = xyes; then 
++  AC_DEFINE(C_UNALIGNED_MEMORY,1)
++  AC_MSG_RESULT(yes)
++else
++  AC_MSG_RESULT(no)
++fi
++
++AH_TEMPLATE(C_SSHOT,[Define to 1 to enable screenshots, requires libpng])
++AC_CHECK_HEADER(png.h,have_png_h=yes,)
++AC_CHECK_LIB(png, png_get_io_ptr, have_png_lib=yes, ,-lz)
++if test x$have_png_lib = xyes -a x$have_png_h = xyes ; then
++  LIBS="$LIBS -lpng -lz"
++  AC_DEFINE(C_SSHOT,1)
++else
++  AC_MSG_WARN([Can't find libpng, screenshot support disabled])
++fi
++
++AH_TEMPLATE(C_MODEM,[Define to 1 to enable internal modem support, requires SDL_net])
++AH_TEMPLATE(C_IPX,[Define to 1 to enable IPX over Internet networking, requires SDL_net])
++AC_CHECK_HEADER(SDL_net.h,have_sdl_net_h=yes,)
++
++if test x$host = xi386-pc-os2-emx ; then
++  AC_MSG_CHECKING(for SDLNet_Init in SDL_net);
++  LIBS_BACKUP=$LIBS;
++  LIBS="$LIBS -lSDL_Net";
++  AC_LINK_IFELSE([AC_LANG_PROGRAM([[#include <SDL_Net.h>]],[[
++	SDLNet_Init ();
++  ]])], [AC_MSG_RESULT(yes); have_sdl_net_lib=yes], AC_MSG_RESULT(no))
++  LIBS=$LIBS_BACKUP
++else
++AC_CHECK_LIB(SDL_net, SDLNet_Init, have_sdl_net_lib=yes, , )
++fi
++if test x$have_sdl_net_lib = xyes -a x$have_sdl_net_h = xyes ; then
++   LIBS="$LIBS -lSDL_net"
++   AC_DEFINE(C_MODEM,1)
++   AC_DEFINE(C_IPX,1)
++else 
++   AC_MSG_WARN([Can't find SDL_net, internal modem and ipx disabled])
++fi
++
++AH_TEMPLATE(C_X11_XKB,[define to 1 if you have XKBlib.h and X11 lib])
++AC_CHECK_LIB(X11, main, have_x11_lib=yes, have_x11_lib=no, )
++AC_CHECK_HEADER(X11/XKBlib.h, have_x11_h=yes, have_x11_h=no, )
++AC_MSG_CHECKING(for XKBlib support)
++if test x$have_x11_lib = xyes -a x$have_x11_h = xyes ; then
++   LIBS="$LIBS -lX11"
++   AC_DEFINE(C_X11_XKB,1)
++   AC_MSG_RESULT(yes)
++else
++   AC_MSG_RESULT(no)
++fi
++
++AH_TEMPLATE(C_OPENGL,[Define to 1 to use opengl display output support])
++AC_CHECK_LIB(GL, main, have_gl_lib=yes, have_gl_lib=no , )
++AC_CHECK_LIB(opengl32, main, have_opengl32_lib=yes,have_opengl32_lib=no , )
++AC_CHECK_HEADER(GL/gl.h, have_gl_h=yes , have_gl_h=no , )
++AC_ARG_ENABLE(opengl,AC_HELP_STRING([--disable-opengl],[Disable opengl support]),,enable_opengl=yes)
++AC_MSG_CHECKING(whether opengl display output will be enabled) 
++if test x$enable_opengl = xyes; then
++case "$host" in
++    *-*-darwin*)
++       AC_MSG_RESULT(yes)
++       LIBS="$LIBS -framework OpenGL"
++       AC_DEFINE(C_OPENGL,1)
++       ;;
++    *)
++       if test x$have_gl_h = xyes -a x$have_gl_lib = xyes ; then 
++         AC_MSG_RESULT(yes)
++         LIBS="$LIBS -lGL"
++         AC_DEFINE(C_OPENGL,1)
++       elif test x$have_gl_h = xyes -a x$have_opengl32_lib = xyes ; then 
++         AC_MSG_RESULT(yes)
++         LIBS="$LIBS -lopengl32"
++         AC_DEFINE(C_OPENGL,1)
++       else
++         AC_MSG_RESULT(no)
++       fi
++       ;;
++esac
++fi
++
++AH_TEMPLATE(C_SDL_SOUND,[Define to 1 to enable SDL_sound support])
++AC_CHECK_HEADER(SDL_sound.h,have_SDL_sound_h=yes,)
++AC_CHECK_LIB(SDL_sound, Sound_Init, have_SDL_sound_init=yes,,)
++AC_CHECK_LIB(SDL_sound, Sound_Seek, have_SDL_sound_seek=yes,,)
++if test x$have_SDL_sound_h = xyes -a x$have_SDL_sound_init = xyes ; then
++  if test x$have_SDL_sound_seek = xyes ; then
++    LIBS="-lSDL_sound $LIBS"
++    AC_DEFINE(C_SDL_SOUND,1)
++   else 
++     AC_MSG_WARN([Can't find SoundSeek in libSDL_Sound, libSDL_sound support disabled])
++   fi
++else
++  AC_MSG_WARN([Can't find libSDL_sound, libSDL_sound support disabled])
++fi
++
++dnl Check for mprotect. Needed for 64 bits linux 
++AH_TEMPLATE(C_HAVE_MPROTECT,[Define to 1 if you have the mprotect function])
++AC_CHECK_HEADER([sys/mman.h], [
++AC_CHECK_FUNC([mprotect],[AC_DEFINE(C_HAVE_MPROTECT,1)])
++])
++
++dnl Setpriority
++AH_TEMPLATE(C_SET_PRIORITY,[Define to 1 if you have setpriority support])
++AC_MSG_CHECKING(for setpriority support)
++AC_LINK_IFELSE([AC_LANG_SOURCE([
++#include <sys/resource.h>
++int main(int argc,char * argv[]) {
++	return setpriority (PRIO_PROCESS, 0,PRIO_MIN+PRIO_MAX);
++};
++])],AC_MSG_RESULT(yes);AC_DEFINE(C_SET_PRIORITY,1),AC_MSG_RESULT(no))
++
++
++dnl Some target detection and actions for them
++case "$host" in
++    *-*-cygwin* | *-*-mingw32*)
++       LIBS="$LIBS -lwinmm"
++       AC_CHECK_HEADERS(ddraw.h)
++       AC_DEFINE(C_DIRECTSERIAL, 1, [ Define to 1 if you want serial passthrough support (Win32, Posix and OS/2 only).])
++       if test x$have_sdl_net_lib = xyes -a x$have_sdl_net_h = xyes ; then
++         LIBS="$LIBS -lws2_32"
++       fi
++       ;;
++    *-*-darwin*)
++       dnl We have a problem here: both Mac OS X and Darwin report 
++       dnl the same signature "powerpc-apple-darwin*" - so we have
++       dnl to do more to distinguish them.
++       dnl For now I am lazy and do not add proper detection code.
++       AC_DEFINE(MACOSX, 1, [Compiling on Mac OS X])
++       LIBS="$LIBS -framework CoreMIDI -framework AudioUnit -framework AudioToolbox"
++       AC_DEFINE(C_DIRECTSERIAL, 1, [ Define to 1 if you want serial passthrough support (Win32, Posix and OS/2).])
++       ;;
++    *-*-linux*)
++       AC_DEFINE(LINUX, 1, [Compiling on GNU/Linux])
++       AC_DEFINE(C_DIRECTSERIAL, 1, [ Define to 1 if you want serial passthrough support (Win32, Posix and OS/2).])
++       ;;
++    *-*-freebsd* | *-*-dragonfly* | *-*-netbsd* | *-*-openbsd*)
++       dnl Disabled directserial for now. It doesn't do anything without
++       dnl specifying an extra ifdef in directserial_posix.*
++       dnl directserial detection should be rewritten to test for the needed
++       dnl functions and headers. I currently do not know 
++       dnl which ones are needed for BSD
++       AC_DEFINE(BSD, 1, [Compiling on BSD])
++       AC_DEFINE(C_DIRECTSERIAL, 1, [ Define to 1 if you want serial passthrough support (Win32, Posix and OS/2).])
++       ;;
++    *-*-os2-emx*)
++       AC_DEFINE(OS2, 1, [Compiling on OS/2 EMX])
++       AC_DEFINE(C_DIRECTSERIAL, 1, [ Define to 1 if you want serial passthrough support (Win32, Posix and OS/2).])
++       ;;
++esac
++
++dnl Some stuff for the icon.
++case "$host" in
++    *-*-cygwin* | *-*-mingw32*)
++       dnl Some stuff for the ico
++       AC_CHECK_TOOL(WINDRES, windres, :)
++    ;;
++    *)
++       WINDRES=":"
++    ;;
++esac
++       AM_CONDITIONAL(HAVE_WINDRES, test "x$WINDRES" != "x:")
++       AC_SUBST(WINDRES)
++
++
++AC_CONFIG_FILES([ 
++Makefile
++src/Makefile
++src/cpu/Makefile
++src/cpu/core_full/Makefile
++src/cpu/core_normal/Makefile
++src/cpu/core_dyn_x86/Makefile
++src/cpu/core_dynrec/Makefile
++src/debug/Makefile
++src/dos/Makefile
++src/fpu/Makefile
++src/gui/Makefile
++src/hardware/Makefile
++src/hardware/serialport/Makefile
++src/ints/Makefile
++src/libs/Makefile
++src/libs/zmbv/Makefile
++src/libs/gui_tk/Makefile
++src/misc/Makefile
++src/shell/Makefile
++src/platform/Makefile
++src/platform/visualc/Makefile
++visualc_net/Makefile
++include/Makefile
++docs/Makefile
++])
++AC_OUTPUT
+diff -Nur dosbox-0.74/configure.in dosbox/configure.in
+--- dosbox-0.74/configure.in	2010-05-10 20:58:57.000000000 +0200
++++ dosbox/configure.in	1970-01-01 01:00:00.000000000 +0100
+@@ -1,528 +0,0 @@
+-dnl Init.
+-AC_INIT(dosbox,0.74)
+-AC_PREREQ(2.50)
+-AC_CONFIG_SRCDIR(README)
+-
+-dnl Detect the canonical host and target build environment
+-AC_CANONICAL_HOST
+-AC_CANONICAL_BUILD
+-
+-dnl Setup for automake
+-AM_INIT_AUTOMAKE
+-AM_CONFIG_HEADER(config.h)
+-
+-dnl Checks for programs.
+-AC_PROG_MAKE_SET
+-AC_PROG_CC
+-AC_PROG_CPP
+-AC_PROG_CXX
+-AC_PROG_INSTALL
+-AC_PROG_RANLIB
+-
+-dnl Some needed libaries for OS2
+-dnl perharps join this with the other target depended checks. move them upwards
+-if test x$host = xi386-pc-os2-emx ; then
+-    CXXFLAGS="$CXXFLAGS -Zmt"
+-    LDFLAGS="$LDFLAGS -Zomf -Zmt"
+-    LIBS="$LIBS -los2me"
+-fi
+-
+-dnl Check for SDL
+-SDL_VERSION=1.2.0
+-AM_PATH_SDL($SDL_VERSION,
+-            :,
+-	    AC_MSG_ERROR([*** SDL version $SDL_VERSION not found!])
+-)
+-LIBS="$LIBS $SDL_LIBS"
+-CPPFLAGS="$CPPFLAGS $SDL_CFLAGS"
+-
+-dnl Check if SDL is 1.2.x (1.3 not supported)
+-AC_MSG_CHECKING([SDL version only being 1.2.X])
+-AC_COMPILE_IFELSE([
+-#include "SDL.h"
+-void blah(){
+-#if SDL_MINOR_VERSION != 2
+-#error "Only SDL 1.2 supported"
+-#endif
+-;
+-}
+-],AC_MSG_RESULT([yes]),[
+- AC_MSG_RESULT([no]) 
+- AC_MSG_ERROR([Only libSDL 1.2.X supported])])
+-
+-dnl Checks for header files.
+-
+-dnl Checks for typedefs, structures, and compiler characteristics.
+-AC_C_CONST
+-AC_C_INLINE
+-AC_TYPE_SIZE_T
+-AC_STRUCT_TM
+-AC_CHECK_SIZEOF(unsigned char)
+-AC_CHECK_SIZEOF(unsigned short)
+-AC_CHECK_SIZEOF(unsigned int)
+-AC_CHECK_SIZEOF(unsigned long)
+-AC_CHECK_SIZEOF(unsigned long long)
+-AC_CHECK_SIZEOF(int *)
+-
+-dnl some semi complex check for sys/socket so it works on darwin as well
+-AC_CHECK_HEADERS([stdlib.h sys/types.h])
+-AC_CHECK_HEADERS([sys/socket.h  netinet/in.h pwd.h], [], [],
+-[#include <stdio.h>
+-#ifdef STDC_HEADERS
+-# include <stdlib.h>
+-# include <stddef.h>
+-#else
+-# ifdef HAVE_STDLIB_H
+-#  include <stdlib.h>
+-# endif
+-#endif
+-#ifdef HAVE_SYS_TYPES_H
+-# include <sys/types.h>
+-#endif
+-])
+-
+-dnl check for the socklen_t (darwin doesn't always have it)
+-AC_COMPILE_IFELSE([
+-#include <stdio.h>
+-#ifdef STDC_HEADERS
+-# include <stdlib.h>
+-# include <stddef.h>
+-#else
+-# ifdef HAVE_STDLIB_H
+-#  include <stdlib.h>
+-# endif
+-#endif
+-#ifdef HAVE_SYS_TYPES_H
+-# include <sys/types.h>
+-#endif
+-#ifdef HAVE_SYS_SOCKET_H
+-#include <sys/socket.h>
+-#endif
+-],[],[AC_DEFINE([socklen_t],[int],[Define to `int` if you don't have socklen_t])])
+-
+-AC_MSG_CHECKING(if environ can be included)
+-AC_LINK_IFELSE([AC_LANG_PROGRAM([[
+-#include <unistd.h>
+-#include <stdlib.h>]],[[*environ;]])],
+-[AC_MSG_RESULT(yes);AC_DEFINE(ENVIRON_INCLUDED,1,[environ can be included])],AC_MSG_RESULT(no))
+-
+-AC_MSG_CHECKING(if environ can be linked)
+-AC_LINK_IFELSE([AC_LANG_PROGRAM([[extern char ** environ;]],[[*environ;]])],
+-[AC_MSG_RESULT(yes);AC_DEFINE(ENVIRON_LINKED,1,[environ can be linked])],AC_MSG_RESULT(no))
+-
+-AC_MSG_CHECKING([if dirent includes d_type])
+-AC_COMPILE_IFELSE([
+-#include <sys/types.h>
+-#include <dirent.h>
+-void blah(){
+-struct dirent d_test;
+-d_test.d_type = 0;
+-}],[AC_MSG_RESULT(yes);AC_DEFINE(DIRENT_HAS_D_TYPE,1,[struct dirent has d_type])],AC_MSG_RESULT(no))
+-
+-
+-dnl Check for powf
+-AC_MSG_CHECKING(for powf in libm);
+-LIBS_BACKUP=$LIBS;
+-LIBS="$LIBS -lm";
+-AC_LINK_IFELSE([AC_LANG_PROGRAM([[#include <math.h>]],[[
+-        powf(1.0f, 1.0f);
+-]])], [AC_MSG_RESULT(yes)], [AC_DEFINE([DB_HAVE_NO_POWF],[1],[libm doesn't include powf])])
+-LIBS=$LIBS_BACKUP
+-
+-
+-dnl Checks for libraries.
+-
+-#Check if the compiler support attributes
+-AH_TEMPLATE([C_HAS_ATTRIBUTE],[Determines if the compilers supports attributes for structures.])
+-AC_MSG_CHECKING(if compiler allows __attribute__)
+-AC_COMPILE_IFELSE([AC_LANG_PROGRAM([[
+-typedef struct { } __attribute__((packed)) junk;]],
+-[[ ]])],[ AC_MSG_RESULT(yes);AC_DEFINE(C_HAS_ATTRIBUTE)],AC_MSG_RESULT(no))
+-
+-
+-#Check if the compiler supports certain attributes
+-OLDCFLAGS="$CFLAGS"
+-CFLAGS="-Werror"
+-
+-AH_TEMPLATE([C_ATTRIBUTE_ALWAYS_INLINE],[Determines if the compilers supports always_inline attribute.])
+-AC_MSG_CHECKING(if compiler allows __attribute__((always_inline)) )
+-AC_COMPILE_IFELSE([ void __attribute__((always_inline)) test(){}
+-],[ AC_MSG_RESULT(yes);AC_DEFINE(C_ATTRIBUTE_ALWAYS_INLINE)],AC_MSG_RESULT(no))
+-
+-AH_TEMPLATE([C_ATTRIBUTE_FASTCALL],[Determines if the compilers supports fastcall attribute.])
+-AC_MSG_CHECKING(if compiler allows __attribute__((fastcall)) )
+-AC_COMPILE_IFELSE([ void __attribute__((fastcall)) test(){}
+-],[ AC_MSG_RESULT(yes);AC_DEFINE(C_ATTRIBUTE_FASTCALL)],AC_MSG_RESULT(no))
+-
+-
+-CFLAGS="$OLDCFLAGS"
+-
+-
+-#Check if the compiler supports __builtin_expect
+-#Switch language to c++
+-AC_LANG_PUSH(C++)
+-AH_TEMPLATE([C_HAS_BUILTIN_EXPECT],[Determines if the compilers supports __builtin_expect for branch prediction.])
+-AC_MSG_CHECKING(if compiler allows __builtin_expect)
+-AC_COMPILE_IFELSE([AC_LANG_PROGRAM([[]],[[
+-int x=10;if( __builtin_expect ((x==1),0) ) ;
+-]])], [ AC_MSG_RESULT(yes);AC_DEFINE(C_HAS_BUILTIN_EXPECT)],AC_MSG_RESULT(no))
+-#switch language back
+-AC_LANG_POP(C++)
+-
+-dnl enable disable alsa and pass it's cflags to CXXFLAGS
+-AC_ARG_ENABLE(alsa-midi,
+-AC_HELP_STRING([--enable-alsa-midi],[compile with alsa midi support (default yes)]),
+-[ case "${enableval}" in
+- yes) alsa_midi=true;;
+- no)  alsa_midi=false;;
+-esac],
+-[alsa_midi=true])
+-if test x$alsa_midi = xtrue ; then 
+-  AM_PATH_ALSA(0.9.0, AC_DEFINE(HAVE_ALSA,1,[Define to 1 to use ALSA for MIDI]) , : )
+-  CXXFLAGS="$CXXFLAGS $ALSA_CFLAGS"
+-fi
+-
+-#Check for big endian machine, should #define WORDS_BIGENDIAN if so
+-AC_C_BIGENDIAN
+-
+-#Features to enable/disable
+-AH_TEMPLATE(C_DEBUG,[Define to 1 to enable internal debugger, requires libcurses])
+-AH_TEMPLATE(C_HEAVY_DEBUG,[Define to 1 to enable heavy debugging, also have to enable C_DEBUG])
+-AC_ARG_ENABLE(debug,AC_HELP_STRING([--enable-debug],[Enable debug mode]),[
+-   AC_CHECK_HEADER(curses.h,have_curses_h=yes,)
+-   AC_CHECK_LIB(curses, initscr, have_curses_lib=yes, , )
+-   AC_CHECK_LIB(ncurses, initscr, have_ncurses_lib=yes, , )
+-   AC_CHECK_LIB(pdcurses, initscr, have_pdcurses_lib=yes, , )
+-
+-   if test x$enable_debug = xno; then
+-     AC_MSG_RESULT([Debugger not enabled])
+-   elif test x$have_curses_lib = xyes -a x$have_curses_h = xyes ; then
+-     LIBS="$LIBS -lcurses"
+-     AC_DEFINE(C_DEBUG,1)
+-     if test x$enable_debug = xheavy ; then 
+-       AC_DEFINE(C_HEAVY_DEBUG,1)
+-     fi
+-   elif test x$have_ncurses_lib = xyes -a x$have_curses_h = xyes ; then
+-     LIBS="$LIBS -lncurses"
+-     AC_DEFINE(C_DEBUG,1)
+-     if test x$enable_debug = xheavy ; then 
+-       AC_DEFINE(C_HEAVY_DEBUG,1)
+-     fi
+-   elif test x$have_pdcurses_lib = xyes -a x$have_curses_h = xyes ; then
+-     LIBS="$LIBS -lpdcurses"
+-     AC_DEFINE(C_DEBUG,1)
+-     if test x$enable_debug = xheavy ; then 
+-       AC_DEFINE(C_HEAVY_DEBUG,1)
+-     fi
+-   else 
+-     AC_MSG_ERROR([Can't find curses, which is required for debug mode])
+-   fi
+-],)
+-
+-AH_TEMPLATE(C_CORE_INLINE,[Define to 1 to use inlined memory functions in cpu core])
+-AC_ARG_ENABLE(core-inline,AC_HELP_STRING([--enable-core-inline],[Enable inlined memory handling in CPU Core]),[
+-  if test x$enable_core_inline = xyes ; then 
+-    AC_MSG_RESULT([enabling inlined memory handling in CPU Core])
+-    AC_DEFINE(C_CORE_INLINE,1)
+-  fi
+-],)
+-
+-
+-dnl The target cpu checks for dynamic cores
+-AH_TEMPLATE(C_TARGETCPU,[The type of cpu this target has])
+-AC_MSG_CHECKING(for target cpu type) 
+-case "$host_cpu" in
+-  x86_64 | amd64)
+-    AC_DEFINE(C_TARGETCPU,X86_64)
+-    AC_MSG_RESULT(x86-64 bit compatible)
+-    c_targetcpu="x86_64"
+-    c_unalignedmemory=yes
+-    ;;
+-  i?86)
+-    AC_DEFINE(C_TARGETCPU,X86)
+-    AC_MSG_RESULT(x86 compatible)
+-    c_targetcpu="x86"
+-    c_unalignedmemory=yes
+-    ;;
+-   powerpc*)
+-    AC_DEFINE(C_TARGETCPU,POWERPC)
+-    AC_MSG_RESULT(Power PC)
+-    c_targetcpu="powerpc"
+-    c_unalignedmemory=yes
+-    ;;
+-   m68k*)
+-    AC_DEFINE(C_TARGETCPU,M68K)
+-    AC_MSG_RESULT(Motorola 68000)
+-    c_targetcpu="m68k"
+-    c_unalignedmemory=yes
+-    ;;
+-   *)
+-    AC_DEFINE(C_TARGETCPU,UNKNOWN)
+-    AC_MSG_RESULT(unknown)
+-    c_unalignedmemory=no
+-    ;;
+-esac
+-
+-AC_ARG_ENABLE(dynamic-core,AC_HELP_STRING([--disable-dynamic-core],[Disable all dynamic cores]),,enable_dynamic_core=yes)
+-
+-AH_TEMPLATE(C_DYNAMIC_X86,[Define to 1 to use x86 dynamic cpu core])
+-AC_ARG_ENABLE(dynamic-x86,AC_HELP_STRING([--disable-dynamic-x86],[Disable x86 dynamic cpu core]),,enable_dynamic_x86=yes)
+-AC_MSG_CHECKING(whether x86 dynamic cpu core will be enabled) 
+-if test x$enable_dynamic_x86 = xno -o x$enable_dynamic_core = xno; then 
+-   AC_MSG_RESULT(no)
+-else
+-  if test x$c_targetcpu = xx86 ; then
+-      AC_DEFINE(C_DYNAMIC_X86,1)
+-      AC_MSG_RESULT(yes)
+-  else
+-      AC_MSG_RESULT(no)
+-  fi
+-fi
+-
+-AH_TEMPLATE(C_DYNREC,[Define to 1 to use recompiling cpu core. Can not be used together with the dynamic-x86 core])
+-AC_ARG_ENABLE(dynrec,AC_HELP_STRING([--disable-dynrec],[Disable recompiling cpu core]),,enable_dynrec=yes)
+-AC_MSG_CHECKING(whether recompiling cpu core will be enabled) 
+-if test x$enable_dynrec = xno -o x$enable_dynamic_core = xno; then 
+-   AC_MSG_RESULT(no)
+-else
+-dnl x86 only enable it if dynamic-x86 is disabled.
+-  if test x$c_targetcpu = xx86 ; then
+-    if test x$enable_dynamic_x86 = xno ; then
+-        AC_DEFINE(C_DYNREC,1)
+-        AC_MSG_RESULT(yes)
+-    else
+-        AC_MSG_RESULT([no, using dynamic-x86])
+-    fi
+-  else 
+-    if test x$c_targetcpu = xx86_64 ; then
+-        AC_DEFINE(C_DYNREC,1)
+-        AC_MSG_RESULT(yes)
+-    else      
+-      AC_MSG_RESULT(no)
+-    fi
+-  fi
+-fi
+-
+-AH_TEMPLATE(C_FPU,[Define to 1 to enable floating point emulation])
+-AC_ARG_ENABLE(fpu,AC_HELP_STRING([--disable-fpu],[Disable fpu support]),,enable_fpu=yes)
+-AC_MSG_CHECKING(whether fpu emulation will be enabled) 
+-if test x$enable_fpu = xyes ; then 
+-  AC_MSG_RESULT(yes)
+-  AC_DEFINE(C_FPU,1)
+-else 
+-  AC_MSG_RESULT(no)
+-fi 
+-
+-AH_TEMPLATE(C_FPU_X86,[Define to 1 to use a x86 assembly fpu core])
+-AC_ARG_ENABLE(fpu-x86,AC_HELP_STRING([--disable-fpu-x86],[Disable x86 assembly fpu core]),,enable_fpu_x86=yes)
+-AC_MSG_CHECKING(whether x86 assembly fpu core will be enabled) 
+-if test x$enable_fpu_x86 = xno ; then 
+-   AC_MSG_RESULT(no)
+-else
+-  if test x$enable_fpu = xyes; then
+-    if test x$c_targetcpu = xx86 ; then
+-        AC_DEFINE(C_FPU_X86,1)
+-        AC_MSG_RESULT(yes)
+-    else
+-        AC_MSG_RESULT(no)
+-    fi
+-  else
+-      AC_MSG_RESULT(no)
+-  fi
+-fi
+-
+-AH_TEMPLATE(C_UNALIGNED_MEMORY,[Define to 1 to use a unaligned memory access])
+-AC_ARG_ENABLE(unaligned_memory,AC_HELP_STRING([--disable-unaligned-memory],[Disable unaligned memory access]),,enable_unaligned_memory=yes)
+-AC_MSG_CHECKING(whether to enable unaligned memory access) 
+-if test x$enable_unaligned_memory = xyes -a x$c_unalignedmemory = xyes; then 
+-  AC_DEFINE(C_UNALIGNED_MEMORY,1)
+-  AC_MSG_RESULT(yes)
+-else
+-  AC_MSG_RESULT(no)
+-fi
+-
+-AH_TEMPLATE(C_SSHOT,[Define to 1 to enable screenshots, requires libpng])
+-AC_CHECK_HEADER(png.h,have_png_h=yes,)
+-AC_CHECK_LIB(png, png_get_io_ptr, have_png_lib=yes, ,-lz)
+-if test x$have_png_lib = xyes -a x$have_png_h = xyes ; then
+-  LIBS="$LIBS -lpng -lz"
+-  AC_DEFINE(C_SSHOT,1)
+-else
+-  AC_MSG_WARN([Can't find libpng, screenshot support disabled])
+-fi
+-
+-AH_TEMPLATE(C_MODEM,[Define to 1 to enable internal modem support, requires SDL_net])
+-AH_TEMPLATE(C_IPX,[Define to 1 to enable IPX over Internet networking, requires SDL_net])
+-AC_CHECK_HEADER(SDL_net.h,have_sdl_net_h=yes,)
+-
+-if test x$host = xi386-pc-os2-emx ; then
+-  AC_MSG_CHECKING(for SDLNet_Init in SDL_net);
+-  LIBS_BACKUP=$LIBS;
+-  LIBS="$LIBS -lSDL_Net";
+-  AC_LINK_IFELSE([AC_LANG_PROGRAM([[#include <SDL_Net.h>]],[[
+-	SDLNet_Init ();
+-  ]])], [AC_MSG_RESULT(yes); have_sdl_net_lib=yes], AC_MSG_RESULT(no))
+-  LIBS=$LIBS_BACKUP
+-else
+-AC_CHECK_LIB(SDL_net, SDLNet_Init, have_sdl_net_lib=yes, , )
+-fi
+-if test x$have_sdl_net_lib = xyes -a x$have_sdl_net_h = xyes ; then
+-   LIBS="$LIBS -lSDL_net"
+-   AC_DEFINE(C_MODEM,1)
+-   AC_DEFINE(C_IPX,1)
+-else 
+-   AC_MSG_WARN([Can't find SDL_net, internal modem and ipx disabled])
+-fi
+-
+-AH_TEMPLATE(C_X11_XKB,[define to 1 if you have XKBlib.h and X11 lib])
+-AC_CHECK_LIB(X11, main, have_x11_lib=yes, have_x11_lib=no, )
+-AC_CHECK_HEADER(X11/XKBlib.h, have_x11_h=yes, have_x11_h=no, )
+-AC_MSG_CHECKING(for XKBlib support)
+-if test x$have_x11_lib = xyes -a x$have_x11_h = xyes ; then
+-   LIBS="$LIBS -lX11"
+-   AC_DEFINE(C_X11_XKB,1)
+-   AC_MSG_RESULT(yes)
+-else
+-   AC_MSG_RESULT(no)
+-fi
+-
+-AH_TEMPLATE(C_OPENGL,[Define to 1 to use opengl display output support])
+-AC_CHECK_LIB(GL, main, have_gl_lib=yes, have_gl_lib=no , )
+-AC_CHECK_LIB(opengl32, main, have_opengl32_lib=yes,have_opengl32_lib=no , )
+-AC_CHECK_HEADER(GL/gl.h, have_gl_h=yes , have_gl_h=no , )
+-AC_ARG_ENABLE(opengl,AC_HELP_STRING([--disable-opengl],[Disable opengl support]),,enable_opengl=yes)
+-AC_MSG_CHECKING(whether opengl display output will be enabled) 
+-if test x$enable_opengl = xyes; then
+-case "$host" in
+-    *-*-darwin*)
+-       AC_MSG_RESULT(yes)
+-       LIBS="$LIBS -framework OpenGL"
+-       AC_DEFINE(C_OPENGL,1)
+-       ;;
+-    *)
+-       if test x$have_gl_h = xyes -a x$have_gl_lib = xyes ; then 
+-         AC_MSG_RESULT(yes)
+-         LIBS="$LIBS -lGL"
+-         AC_DEFINE(C_OPENGL,1)
+-       elif test x$have_gl_h = xyes -a x$have_opengl32_lib = xyes ; then 
+-         AC_MSG_RESULT(yes)
+-         LIBS="$LIBS -lopengl32"
+-         AC_DEFINE(C_OPENGL,1)
+-       else
+-         AC_MSG_RESULT(no)
+-       fi
+-       ;;
+-esac
+-fi
+-
+-AH_TEMPLATE(C_SDL_SOUND,[Define to 1 to enable SDL_sound support])
+-AC_CHECK_HEADER(SDL_sound.h,have_SDL_sound_h=yes,)
+-AC_CHECK_LIB(SDL_sound, Sound_Init, have_SDL_sound_init=yes,,)
+-AC_CHECK_LIB(SDL_sound, Sound_Seek, have_SDL_sound_seek=yes,,)
+-if test x$have_SDL_sound_h = xyes -a x$have_SDL_sound_init = xyes ; then
+-  if test x$have_SDL_sound_seek = xyes ; then
+-    LIBS="-lSDL_sound $LIBS"
+-    AC_DEFINE(C_SDL_SOUND,1)
+-   else 
+-     AC_MSG_WARN([Can't find SoundSeek in libSDL_Sound, libSDL_sound support disabled])
+-   fi
+-else
+-  AC_MSG_WARN([Can't find libSDL_sound, libSDL_sound support disabled])
+-fi
+-
+-dnl Check for mprotect. Needed for 64 bits linux 
+-AH_TEMPLATE(C_HAVE_MPROTECT,[Define to 1 if you have the mprotect function])
+-AC_CHECK_HEADER([sys/mman.h], [
+-AC_CHECK_FUNC([mprotect],[AC_DEFINE(C_HAVE_MPROTECT,1)])
+-])
+-
+-dnl Setpriority
+-AH_TEMPLATE(C_SET_PRIORITY,[Define to 1 if you have setpriority support])
+-AC_MSG_CHECKING(for setpriority support)
+-AC_LINK_IFELSE([
+-#include <sys/resource.h>
+-int main(int argc,char * argv[]) {
+-	return setpriority (PRIO_PROCESS, 0,PRIO_MIN+PRIO_MAX);
+-};
+-],AC_MSG_RESULT(yes);AC_DEFINE(C_SET_PRIORITY,1),AC_MSG_RESULT(no))
+-
+-
+-dnl Some target detection and actions for them
+-case "$host" in
+-    *-*-cygwin* | *-*-mingw32*)
+-       LIBS="$LIBS -lwinmm"
+-       AC_CHECK_HEADERS(ddraw.h)
+-       AC_DEFINE(C_DIRECTSERIAL, 1, [ Define to 1 if you want serial passthrough support (Win32, Posix and OS/2 only).])
+-       if test x$have_sdl_net_lib = xyes -a x$have_sdl_net_h = xyes ; then
+-         LIBS="$LIBS -lws2_32"
+-       fi
+-       ;;
+-    *-*-darwin*)
+-       dnl We have a problem here: both Mac OS X and Darwin report 
+-       dnl the same signature "powerpc-apple-darwin*" - so we have
+-       dnl to do more to distinguish them.
+-       dnl For now I am lazy and do not add proper detection code.
+-       AC_DEFINE(MACOSX, 1, [Compiling on Mac OS X])
+-       LIBS="$LIBS -framework CoreMIDI -framework AudioUnit -framework AudioToolbox"
+-       AC_DEFINE(C_DIRECTSERIAL, 1, [ Define to 1 if you want serial passthrough support (Win32, Posix and OS/2).])
+-       ;;
+-    *-*-linux*)
+-       AC_DEFINE(LINUX, 1, [Compiling on GNU/Linux])
+-       AC_DEFINE(C_DIRECTSERIAL, 1, [ Define to 1 if you want serial passthrough support (Win32, Posix and OS/2).])
+-       ;;
+-    *-*-freebsd* | *-*-dragonfly* | *-*-netbsd* | *-*-openbsd*)
+-       dnl Disabled directserial for now. It doesn't do anything without
+-       dnl specifying an extra ifdef in directserial_posix.*
+-       dnl directserial detection should be rewritten to test for the needed
+-       dnl functions and headers. I currently do not know 
+-       dnl which ones are needed for BSD
+-       AC_DEFINE(BSD, 1, [Compiling on BSD])
+-       AC_DEFINE(C_DIRECTSERIAL, 1, [ Define to 1 if you want serial passthrough support (Win32, Posix and OS/2).])
+-       ;;
+-    *-*-os2-emx*)
+-       AC_DEFINE(OS2, 1, [Compiling on OS/2 EMX])
+-       AC_DEFINE(C_DIRECTSERIAL, 1, [ Define to 1 if you want serial passthrough support (Win32, Posix and OS/2).])
+-       ;;
+-esac
+-
+-dnl Some stuff for the icon.
+-case "$host" in
+-    *-*-cygwin* | *-*-mingw32*)
+-       dnl Some stuff for the ico
+-       AC_CHECK_TOOL(WINDRES, windres, :)
+-    ;;
+-    *)
+-       WINDRES=":"
+-    ;;
+-esac
+-       AM_CONDITIONAL(HAVE_WINDRES, test "x$WINDRES" != "x:")
+-       AC_SUBST(WINDRES)
+-
+-
+-AC_CONFIG_FILES([ 
+-Makefile
+-src/Makefile
+-src/cpu/Makefile
+-src/cpu/core_full/Makefile
+-src/cpu/core_normal/Makefile
+-src/cpu/core_dyn_x86/Makefile
+-src/cpu/core_dynrec/Makefile
+-src/debug/Makefile
+-src/dos/Makefile
+-src/fpu/Makefile
+-src/gui/Makefile
+-src/hardware/Makefile
+-src/hardware/serialport/Makefile
+-src/ints/Makefile
+-src/libs/Makefile
+-src/libs/zmbv/Makefile
+-src/libs/gui_tk/Makefile
+-src/misc/Makefile
+-src/shell/Makefile
+-src/platform/Makefile
+-src/platform/visualc/Makefile
+-visualc_net/Makefile
+-include/Makefile
+-docs/Makefile
+-])
+-AC_OUTPUT
+diff -Nur dosbox-0.74/depcomp dosbox/depcomp
+--- dosbox-0.74/depcomp	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/depcomp	1970-01-01 01:00:00.000000000 +0100
+@@ -1,630 +0,0 @@
+-#! /bin/sh
+-# depcomp - compile a program generating dependencies as side-effects
+-
+-scriptversion=2009-04-28.21; # UTC
+-
+-# Copyright (C) 1999, 2000, 2003, 2004, 2005, 2006, 2007, 2009 Free
+-# Software Foundation, Inc.
+-
+-# This program is free software; you can redistribute it and/or modify
+-# it under the terms of the GNU General Public License as published by
+-# the Free Software Foundation; either version 2, or (at your option)
+-# any later version.
+-
+-# This program is distributed in the hope that it will be useful,
+-# but WITHOUT ANY WARRANTY; without even the implied warranty of
+-# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+-# GNU General Public License for more details.
+-
+-# You should have received a copy of the GNU General Public License
+-# along with this program.  If not, see <http://www.gnu.org/licenses/>.
+-
+-# As a special exception to the GNU General Public License, if you
+-# distribute this file as part of a program that contains a
+-# configuration script generated by Autoconf, you may include it under
+-# the same distribution terms that you use for the rest of that program.
+-
+-# Originally written by Alexandre Oliva <oliva@dcc.unicamp.br>.
+-
+-case $1 in
+-  '')
+-     echo "$0: No command.  Try \`$0 --help' for more information." 1>&2
+-     exit 1;
+-     ;;
+-  -h | --h*)
+-    cat <<\EOF
+-Usage: depcomp [--help] [--version] PROGRAM [ARGS]
+-
+-Run PROGRAMS ARGS to compile a file, generating dependencies
+-as side-effects.
+-
+-Environment variables:
+-  depmode     Dependency tracking mode.
+-  source      Source file read by `PROGRAMS ARGS'.
+-  object      Object file output by `PROGRAMS ARGS'.
+-  DEPDIR      directory where to store dependencies.
+-  depfile     Dependency file to output.
+-  tmpdepfile  Temporary file to use when outputing dependencies.
+-  libtool     Whether libtool is used (yes/no).
+-
+-Report bugs to <bug-automake@gnu.org>.
+-EOF
+-    exit $?
+-    ;;
+-  -v | --v*)
+-    echo "depcomp $scriptversion"
+-    exit $?
+-    ;;
+-esac
+-
+-if test -z "$depmode" || test -z "$source" || test -z "$object"; then
+-  echo "depcomp: Variables source, object and depmode must be set" 1>&2
+-  exit 1
+-fi
+-
+-# Dependencies for sub/bar.o or sub/bar.obj go into sub/.deps/bar.Po.
+-depfile=${depfile-`echo "$object" |
+-  sed 's|[^\\/]*$|'${DEPDIR-.deps}'/&|;s|\.\([^.]*\)$|.P\1|;s|Pobj$|Po|'`}
+-tmpdepfile=${tmpdepfile-`echo "$depfile" | sed 's/\.\([^.]*\)$/.T\1/'`}
+-
+-rm -f "$tmpdepfile"
+-
+-# Some modes work just like other modes, but use different flags.  We
+-# parameterize here, but still list the modes in the big case below,
+-# to make depend.m4 easier to write.  Note that we *cannot* use a case
+-# here, because this file can only contain one case statement.
+-if test "$depmode" = hp; then
+-  # HP compiler uses -M and no extra arg.
+-  gccflag=-M
+-  depmode=gcc
+-fi
+-
+-if test "$depmode" = dashXmstdout; then
+-   # This is just like dashmstdout with a different argument.
+-   dashmflag=-xM
+-   depmode=dashmstdout
+-fi
+-
+-cygpath_u="cygpath -u -f -"
+-if test "$depmode" = msvcmsys; then
+-   # This is just like msvisualcpp but w/o cygpath translation.
+-   # Just convert the backslash-escaped backslashes to single forward
+-   # slashes to satisfy depend.m4
+-   cygpath_u="sed s,\\\\\\\\,/,g"
+-   depmode=msvisualcpp
+-fi
+-
+-case "$depmode" in
+-gcc3)
+-## gcc 3 implements dependency tracking that does exactly what
+-## we want.  Yay!  Note: for some reason libtool 1.4 doesn't like
+-## it if -MD -MP comes after the -MF stuff.  Hmm.
+-## Unfortunately, FreeBSD c89 acceptance of flags depends upon
+-## the command line argument order; so add the flags where they
+-## appear in depend2.am.  Note that the slowdown incurred here
+-## affects only configure: in makefiles, %FASTDEP% shortcuts this.
+-  for arg
+-  do
+-    case $arg in
+-    -c) set fnord "$@" -MT "$object" -MD -MP -MF "$tmpdepfile" "$arg" ;;
+-    *)  set fnord "$@" "$arg" ;;
+-    esac
+-    shift # fnord
+-    shift # $arg
+-  done
+-  "$@"
+-  stat=$?
+-  if test $stat -eq 0; then :
+-  else
+-    rm -f "$tmpdepfile"
+-    exit $stat
+-  fi
+-  mv "$tmpdepfile" "$depfile"
+-  ;;
+-
+-gcc)
+-## There are various ways to get dependency output from gcc.  Here's
+-## why we pick this rather obscure method:
+-## - Don't want to use -MD because we'd like the dependencies to end
+-##   up in a subdir.  Having to rename by hand is ugly.
+-##   (We might end up doing this anyway to support other compilers.)
+-## - The DEPENDENCIES_OUTPUT environment variable makes gcc act like
+-##   -MM, not -M (despite what the docs say).
+-## - Using -M directly means running the compiler twice (even worse
+-##   than renaming).
+-  if test -z "$gccflag"; then
+-    gccflag=-MD,
+-  fi
+-  "$@" -Wp,"$gccflag$tmpdepfile"
+-  stat=$?
+-  if test $stat -eq 0; then :
+-  else
+-    rm -f "$tmpdepfile"
+-    exit $stat
+-  fi
+-  rm -f "$depfile"
+-  echo "$object : \\" > "$depfile"
+-  alpha=ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz
+-## The second -e expression handles DOS-style file names with drive letters.
+-  sed -e 's/^[^:]*: / /' \
+-      -e 's/^['$alpha']:\/[^:]*: / /' < "$tmpdepfile" >> "$depfile"
+-## This next piece of magic avoids the `deleted header file' problem.
+-## The problem is that when a header file which appears in a .P file
+-## is deleted, the dependency causes make to die (because there is
+-## typically no way to rebuild the header).  We avoid this by adding
+-## dummy dependencies for each header file.  Too bad gcc doesn't do
+-## this for us directly.
+-  tr ' ' '
+-' < "$tmpdepfile" |
+-## Some versions of gcc put a space before the `:'.  On the theory
+-## that the space means something, we add a space to the output as
+-## well.
+-## Some versions of the HPUX 10.20 sed can't process this invocation
+-## correctly.  Breaking it into two sed invocations is a workaround.
+-    sed -e 's/^\\$//' -e '/^$/d' -e '/:$/d' | sed -e 's/$/ :/' >> "$depfile"
+-  rm -f "$tmpdepfile"
+-  ;;
+-
+-hp)
+-  # This case exists only to let depend.m4 do its work.  It works by
+-  # looking at the text of this script.  This case will never be run,
+-  # since it is checked for above.
+-  exit 1
+-  ;;
+-
+-sgi)
+-  if test "$libtool" = yes; then
+-    "$@" "-Wp,-MDupdate,$tmpdepfile"
+-  else
+-    "$@" -MDupdate "$tmpdepfile"
+-  fi
+-  stat=$?
+-  if test $stat -eq 0; then :
+-  else
+-    rm -f "$tmpdepfile"
+-    exit $stat
+-  fi
+-  rm -f "$depfile"
+-
+-  if test -f "$tmpdepfile"; then  # yes, the sourcefile depend on other files
+-    echo "$object : \\" > "$depfile"
+-
+-    # Clip off the initial element (the dependent).  Don't try to be
+-    # clever and replace this with sed code, as IRIX sed won't handle
+-    # lines with more than a fixed number of characters (4096 in
+-    # IRIX 6.2 sed, 8192 in IRIX 6.5).  We also remove comment lines;
+-    # the IRIX cc adds comments like `#:fec' to the end of the
+-    # dependency line.
+-    tr ' ' '
+-' < "$tmpdepfile" \
+-    | sed -e 's/^.*\.o://' -e 's/#.*$//' -e '/^$/ d' | \
+-    tr '
+-' ' ' >> "$depfile"
+-    echo >> "$depfile"
+-
+-    # The second pass generates a dummy entry for each header file.
+-    tr ' ' '
+-' < "$tmpdepfile" \
+-   | sed -e 's/^.*\.o://' -e 's/#.*$//' -e '/^$/ d' -e 's/$/:/' \
+-   >> "$depfile"
+-  else
+-    # The sourcefile does not contain any dependencies, so just
+-    # store a dummy comment line, to avoid errors with the Makefile
+-    # "include basename.Plo" scheme.
+-    echo "#dummy" > "$depfile"
+-  fi
+-  rm -f "$tmpdepfile"
+-  ;;
+-
+-aix)
+-  # The C for AIX Compiler uses -M and outputs the dependencies
+-  # in a .u file.  In older versions, this file always lives in the
+-  # current directory.  Also, the AIX compiler puts `$object:' at the
+-  # start of each line; $object doesn't have directory information.
+-  # Version 6 uses the directory in both cases.
+-  dir=`echo "$object" | sed -e 's|/[^/]*$|/|'`
+-  test "x$dir" = "x$object" && dir=
+-  base=`echo "$object" | sed -e 's|^.*/||' -e 's/\.o$//' -e 's/\.lo$//'`
+-  if test "$libtool" = yes; then
+-    tmpdepfile1=$dir$base.u
+-    tmpdepfile2=$base.u
+-    tmpdepfile3=$dir.libs/$base.u
+-    "$@" -Wc,-M
+-  else
+-    tmpdepfile1=$dir$base.u
+-    tmpdepfile2=$dir$base.u
+-    tmpdepfile3=$dir$base.u
+-    "$@" -M
+-  fi
+-  stat=$?
+-
+-  if test $stat -eq 0; then :
+-  else
+-    rm -f "$tmpdepfile1" "$tmpdepfile2" "$tmpdepfile3"
+-    exit $stat
+-  fi
+-
+-  for tmpdepfile in "$tmpdepfile1" "$tmpdepfile2" "$tmpdepfile3"
+-  do
+-    test -f "$tmpdepfile" && break
+-  done
+-  if test -f "$tmpdepfile"; then
+-    # Each line is of the form `foo.o: dependent.h'.
+-    # Do two passes, one to just change these to
+-    # `$object: dependent.h' and one to simply `dependent.h:'.
+-    sed -e "s,^.*\.[a-z]*:,$object:," < "$tmpdepfile" > "$depfile"
+-    # That's a tab and a space in the [].
+-    sed -e 's,^.*\.[a-z]*:[	 ]*,,' -e 's,$,:,' < "$tmpdepfile" >> "$depfile"
+-  else
+-    # The sourcefile does not contain any dependencies, so just
+-    # store a dummy comment line, to avoid errors with the Makefile
+-    # "include basename.Plo" scheme.
+-    echo "#dummy" > "$depfile"
+-  fi
+-  rm -f "$tmpdepfile"
+-  ;;
+-
+-icc)
+-  # Intel's C compiler understands `-MD -MF file'.  However on
+-  #    icc -MD -MF foo.d -c -o sub/foo.o sub/foo.c
+-  # ICC 7.0 will fill foo.d with something like
+-  #    foo.o: sub/foo.c
+-  #    foo.o: sub/foo.h
+-  # which is wrong.  We want:
+-  #    sub/foo.o: sub/foo.c
+-  #    sub/foo.o: sub/foo.h
+-  #    sub/foo.c:
+-  #    sub/foo.h:
+-  # ICC 7.1 will output
+-  #    foo.o: sub/foo.c sub/foo.h
+-  # and will wrap long lines using \ :
+-  #    foo.o: sub/foo.c ... \
+-  #     sub/foo.h ... \
+-  #     ...
+-
+-  "$@" -MD -MF "$tmpdepfile"
+-  stat=$?
+-  if test $stat -eq 0; then :
+-  else
+-    rm -f "$tmpdepfile"
+-    exit $stat
+-  fi
+-  rm -f "$depfile"
+-  # Each line is of the form `foo.o: dependent.h',
+-  # or `foo.o: dep1.h dep2.h \', or ` dep3.h dep4.h \'.
+-  # Do two passes, one to just change these to
+-  # `$object: dependent.h' and one to simply `dependent.h:'.
+-  sed "s,^[^:]*:,$object :," < "$tmpdepfile" > "$depfile"
+-  # Some versions of the HPUX 10.20 sed can't process this invocation
+-  # correctly.  Breaking it into two sed invocations is a workaround.
+-  sed 's,^[^:]*: \(.*\)$,\1,;s/^\\$//;/^$/d;/:$/d' < "$tmpdepfile" |
+-    sed -e 's/$/ :/' >> "$depfile"
+-  rm -f "$tmpdepfile"
+-  ;;
+-
+-hp2)
+-  # The "hp" stanza above does not work with aCC (C++) and HP's ia64
+-  # compilers, which have integrated preprocessors.  The correct option
+-  # to use with these is +Maked; it writes dependencies to a file named
+-  # 'foo.d', which lands next to the object file, wherever that
+-  # happens to be.
+-  # Much of this is similar to the tru64 case; see comments there.
+-  dir=`echo "$object" | sed -e 's|/[^/]*$|/|'`
+-  test "x$dir" = "x$object" && dir=
+-  base=`echo "$object" | sed -e 's|^.*/||' -e 's/\.o$//' -e 's/\.lo$//'`
+-  if test "$libtool" = yes; then
+-    tmpdepfile1=$dir$base.d
+-    tmpdepfile2=$dir.libs/$base.d
+-    "$@" -Wc,+Maked
+-  else
+-    tmpdepfile1=$dir$base.d
+-    tmpdepfile2=$dir$base.d
+-    "$@" +Maked
+-  fi
+-  stat=$?
+-  if test $stat -eq 0; then :
+-  else
+-     rm -f "$tmpdepfile1" "$tmpdepfile2"
+-     exit $stat
+-  fi
+-
+-  for tmpdepfile in "$tmpdepfile1" "$tmpdepfile2"
+-  do
+-    test -f "$tmpdepfile" && break
+-  done
+-  if test -f "$tmpdepfile"; then
+-    sed -e "s,^.*\.[a-z]*:,$object:," "$tmpdepfile" > "$depfile"
+-    # Add `dependent.h:' lines.
+-    sed -ne '2,${
+-	       s/^ *//
+-	       s/ \\*$//
+-	       s/$/:/
+-	       p
+-	     }' "$tmpdepfile" >> "$depfile"
+-  else
+-    echo "#dummy" > "$depfile"
+-  fi
+-  rm -f "$tmpdepfile" "$tmpdepfile2"
+-  ;;
+-
+-tru64)
+-   # The Tru64 compiler uses -MD to generate dependencies as a side
+-   # effect.  `cc -MD -o foo.o ...' puts the dependencies into `foo.o.d'.
+-   # At least on Alpha/Redhat 6.1, Compaq CCC V6.2-504 seems to put
+-   # dependencies in `foo.d' instead, so we check for that too.
+-   # Subdirectories are respected.
+-   dir=`echo "$object" | sed -e 's|/[^/]*$|/|'`
+-   test "x$dir" = "x$object" && dir=
+-   base=`echo "$object" | sed -e 's|^.*/||' -e 's/\.o$//' -e 's/\.lo$//'`
+-
+-   if test "$libtool" = yes; then
+-      # With Tru64 cc, shared objects can also be used to make a
+-      # static library.  This mechanism is used in libtool 1.4 series to
+-      # handle both shared and static libraries in a single compilation.
+-      # With libtool 1.4, dependencies were output in $dir.libs/$base.lo.d.
+-      #
+-      # With libtool 1.5 this exception was removed, and libtool now
+-      # generates 2 separate objects for the 2 libraries.  These two
+-      # compilations output dependencies in $dir.libs/$base.o.d and
+-      # in $dir$base.o.d.  We have to check for both files, because
+-      # one of the two compilations can be disabled.  We should prefer
+-      # $dir$base.o.d over $dir.libs/$base.o.d because the latter is
+-      # automatically cleaned when .libs/ is deleted, while ignoring
+-      # the former would cause a distcleancheck panic.
+-      tmpdepfile1=$dir.libs/$base.lo.d   # libtool 1.4
+-      tmpdepfile2=$dir$base.o.d          # libtool 1.5
+-      tmpdepfile3=$dir.libs/$base.o.d    # libtool 1.5
+-      tmpdepfile4=$dir.libs/$base.d      # Compaq CCC V6.2-504
+-      "$@" -Wc,-MD
+-   else
+-      tmpdepfile1=$dir$base.o.d
+-      tmpdepfile2=$dir$base.d
+-      tmpdepfile3=$dir$base.d
+-      tmpdepfile4=$dir$base.d
+-      "$@" -MD
+-   fi
+-
+-   stat=$?
+-   if test $stat -eq 0; then :
+-   else
+-      rm -f "$tmpdepfile1" "$tmpdepfile2" "$tmpdepfile3" "$tmpdepfile4"
+-      exit $stat
+-   fi
+-
+-   for tmpdepfile in "$tmpdepfile1" "$tmpdepfile2" "$tmpdepfile3" "$tmpdepfile4"
+-   do
+-     test -f "$tmpdepfile" && break
+-   done
+-   if test -f "$tmpdepfile"; then
+-      sed -e "s,^.*\.[a-z]*:,$object:," < "$tmpdepfile" > "$depfile"
+-      # That's a tab and a space in the [].
+-      sed -e 's,^.*\.[a-z]*:[	 ]*,,' -e 's,$,:,' < "$tmpdepfile" >> "$depfile"
+-   else
+-      echo "#dummy" > "$depfile"
+-   fi
+-   rm -f "$tmpdepfile"
+-   ;;
+-
+-#nosideeffect)
+-  # This comment above is used by automake to tell side-effect
+-  # dependency tracking mechanisms from slower ones.
+-
+-dashmstdout)
+-  # Important note: in order to support this mode, a compiler *must*
+-  # always write the preprocessed file to stdout, regardless of -o.
+-  "$@" || exit $?
+-
+-  # Remove the call to Libtool.
+-  if test "$libtool" = yes; then
+-    while test "X$1" != 'X--mode=compile'; do
+-      shift
+-    done
+-    shift
+-  fi
+-
+-  # Remove `-o $object'.
+-  IFS=" "
+-  for arg
+-  do
+-    case $arg in
+-    -o)
+-      shift
+-      ;;
+-    $object)
+-      shift
+-      ;;
+-    *)
+-      set fnord "$@" "$arg"
+-      shift # fnord
+-      shift # $arg
+-      ;;
+-    esac
+-  done
+-
+-  test -z "$dashmflag" && dashmflag=-M
+-  # Require at least two characters before searching for `:'
+-  # in the target name.  This is to cope with DOS-style filenames:
+-  # a dependency such as `c:/foo/bar' could be seen as target `c' otherwise.
+-  "$@" $dashmflag |
+-    sed 's:^[  ]*[^: ][^:][^:]*\:[    ]*:'"$object"'\: :' > "$tmpdepfile"
+-  rm -f "$depfile"
+-  cat < "$tmpdepfile" > "$depfile"
+-  tr ' ' '
+-' < "$tmpdepfile" | \
+-## Some versions of the HPUX 10.20 sed can't process this invocation
+-## correctly.  Breaking it into two sed invocations is a workaround.
+-    sed -e 's/^\\$//' -e '/^$/d' -e '/:$/d' | sed -e 's/$/ :/' >> "$depfile"
+-  rm -f "$tmpdepfile"
+-  ;;
+-
+-dashXmstdout)
+-  # This case only exists to satisfy depend.m4.  It is never actually
+-  # run, as this mode is specially recognized in the preamble.
+-  exit 1
+-  ;;
+-
+-makedepend)
+-  "$@" || exit $?
+-  # Remove any Libtool call
+-  if test "$libtool" = yes; then
+-    while test "X$1" != 'X--mode=compile'; do
+-      shift
+-    done
+-    shift
+-  fi
+-  # X makedepend
+-  shift
+-  cleared=no eat=no
+-  for arg
+-  do
+-    case $cleared in
+-    no)
+-      set ""; shift
+-      cleared=yes ;;
+-    esac
+-    if test $eat = yes; then
+-      eat=no
+-      continue
+-    fi
+-    case "$arg" in
+-    -D*|-I*)
+-      set fnord "$@" "$arg"; shift ;;
+-    # Strip any option that makedepend may not understand.  Remove
+-    # the object too, otherwise makedepend will parse it as a source file.
+-    -arch)
+-      eat=yes ;;
+-    -*|$object)
+-      ;;
+-    *)
+-      set fnord "$@" "$arg"; shift ;;
+-    esac
+-  done
+-  obj_suffix=`echo "$object" | sed 's/^.*\././'`
+-  touch "$tmpdepfile"
+-  ${MAKEDEPEND-makedepend} -o"$obj_suffix" -f"$tmpdepfile" "$@"
+-  rm -f "$depfile"
+-  cat < "$tmpdepfile" > "$depfile"
+-  sed '1,2d' "$tmpdepfile" | tr ' ' '
+-' | \
+-## Some versions of the HPUX 10.20 sed can't process this invocation
+-## correctly.  Breaking it into two sed invocations is a workaround.
+-    sed -e 's/^\\$//' -e '/^$/d' -e '/:$/d' | sed -e 's/$/ :/' >> "$depfile"
+-  rm -f "$tmpdepfile" "$tmpdepfile".bak
+-  ;;
+-
+-cpp)
+-  # Important note: in order to support this mode, a compiler *must*
+-  # always write the preprocessed file to stdout.
+-  "$@" || exit $?
+-
+-  # Remove the call to Libtool.
+-  if test "$libtool" = yes; then
+-    while test "X$1" != 'X--mode=compile'; do
+-      shift
+-    done
+-    shift
+-  fi
+-
+-  # Remove `-o $object'.
+-  IFS=" "
+-  for arg
+-  do
+-    case $arg in
+-    -o)
+-      shift
+-      ;;
+-    $object)
+-      shift
+-      ;;
+-    *)
+-      set fnord "$@" "$arg"
+-      shift # fnord
+-      shift # $arg
+-      ;;
+-    esac
+-  done
+-
+-  "$@" -E |
+-    sed -n -e '/^# [0-9][0-9]* "\([^"]*\)".*/ s:: \1 \\:p' \
+-       -e '/^#line [0-9][0-9]* "\([^"]*\)".*/ s:: \1 \\:p' |
+-    sed '$ s: \\$::' > "$tmpdepfile"
+-  rm -f "$depfile"
+-  echo "$object : \\" > "$depfile"
+-  cat < "$tmpdepfile" >> "$depfile"
+-  sed < "$tmpdepfile" '/^$/d;s/^ //;s/ \\$//;s/$/ :/' >> "$depfile"
+-  rm -f "$tmpdepfile"
+-  ;;
+-
+-msvisualcpp)
+-  # Important note: in order to support this mode, a compiler *must*
+-  # always write the preprocessed file to stdout.
+-  "$@" || exit $?
+-
+-  # Remove the call to Libtool.
+-  if test "$libtool" = yes; then
+-    while test "X$1" != 'X--mode=compile'; do
+-      shift
+-    done
+-    shift
+-  fi
+-
+-  IFS=" "
+-  for arg
+-  do
+-    case "$arg" in
+-    -o)
+-      shift
+-      ;;
+-    $object)
+-      shift
+-      ;;
+-    "-Gm"|"/Gm"|"-Gi"|"/Gi"|"-ZI"|"/ZI")
+-	set fnord "$@"
+-	shift
+-	shift
+-	;;
+-    *)
+-	set fnord "$@" "$arg"
+-	shift
+-	shift
+-	;;
+-    esac
+-  done
+-  "$@" -E 2>/dev/null |
+-  sed -n '/^#line [0-9][0-9]* "\([^"]*\)"/ s::\1:p' | $cygpath_u | sort -u > "$tmpdepfile"
+-  rm -f "$depfile"
+-  echo "$object : \\" > "$depfile"
+-  sed < "$tmpdepfile" -n -e 's% %\\ %g' -e '/^\(.*\)$/ s::	\1 \\:p' >> "$depfile"
+-  echo "	" >> "$depfile"
+-  sed < "$tmpdepfile" -n -e 's% %\\ %g' -e '/^\(.*\)$/ s::\1\::p' >> "$depfile"
+-  rm -f "$tmpdepfile"
+-  ;;
+-
+-msvcmsys)
+-  # This case exists only to let depend.m4 do its work.  It works by
+-  # looking at the text of this script.  This case will never be run,
+-  # since it is checked for above.
+-  exit 1
+-  ;;
+-
+-none)
+-  exec "$@"
+-  ;;
+-
+-*)
+-  echo "Unknown depmode $depmode" 1>&2
+-  exit 1
+-  ;;
+-esac
+-
+-exit 0
+-
+-# Local Variables:
+-# mode: shell-script
+-# sh-indentation: 2
+-# eval: (add-hook 'write-file-hooks 'time-stamp)
+-# time-stamp-start: "scriptversion="
+-# time-stamp-format: "%:y-%02m-%02d.%02H"
+-# time-stamp-time-zone: "UTC"
+-# time-stamp-end: "; # UTC"
+-# End:
+diff -Nur dosbox-0.74/docs/dosbox.1 dosbox/docs/dosbox.1
+--- dosbox-0.74/docs/dosbox.1	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/docs/dosbox.1	2014-01-12 14:43:47.000000000 +0100
+@@ -111,7 +111,7 @@
+ .RI " move to second " program " if the first one fails to start."
+ .TP
+ .BI \-opencaptures " program"
+-.RI "calls " program " with as  first paramater the location of the captures folder."
++.RI "calls " program " with as  first parameter the location of the captures folder."
+ .TP
+ .B \-printconf
+ prints the location of the default configuration file.
+@@ -205,7 +205,7 @@
+ .RS
+ .TP
+ .B \-securemode
+-.RB Switches dosbox " to a more secure mode. In this mode the"
++.RB "Switches " dosbox " to a more secure mode. In this mode the"
+ .RI "internal commands " MOUNT ", " IMGMOUNT " and " BOOT " won\'t work."
+ It\'s not possible
+ either to create a new configfile or languagefile in this mode.
+@@ -216,9 +216,9 @@
+ The configuration file controls various settings of 
+ .BR dosbox ": The amount of emulated memory,"
+ the emulated soundcards and many
+-.RI "more things. It futher allows acces to " AUTOEXEC.BAT .
++.RI "more things. It further allows access to " AUTOEXEC.BAT .
+ .LP
+-The language file controls all visible ouput of the internal commands and
++The language file controls all visible output of the internal commands and
+ the internal dos. 
+ .RB "See the section " FILES " for more information."
+ .TP 
+@@ -242,11 +242,21 @@
+ Frees all memory eaten up by loadfix.
+ .RE
+ .TP
+-.B RESCAN
++.B RESCAN [\-All] [Drive:]
+ .LP
+ .RB "Make " dosbox " reread the directory structure. Useful if you changed
+ .RB "something on a mounted drive outside " dosbox ".(CTRL\-F4 does"
+ this as well!)
++.RS
++.TP
++.B \-All
++.R Reread directory structure for all drives.
++.TP
++.B Drive:
++.RB "Reread directory structure for drive " Drive:
++.RE
++.LP
++.RB "If both " \-All " and " Drive: " are missing, then the current drive is used.
+ .TP
+ .B IMGMOUNT
+ .LP
+@@ -335,7 +345,7 @@
+ capacity, it will produce the same effect as slowing down the emulation.
+ This maximum will vary from computer to computer, there is no standard.
+ .SH "SYSTEM REQUIREMENTS"
+-Fast machine. My guess would be pentium\-2 400+ to get decent emulation
++Fast machine. My guess would be Pentium\-2 400+ to get decent emulation
+ of games written for an 286 machine.
+ For protected mode games a 1 Ghz machine is recommended and don't expect
+ them to run fast though!! Be sure to read the next section on how to speed
+diff -Nur dosbox-0.74/docs/Makefile.in dosbox/docs/Makefile.in
+--- dosbox-0.74/docs/Makefile.in	2010-05-12 11:57:43.000000000 +0200
++++ dosbox/docs/Makefile.in	1970-01-01 01:00:00.000000000 +0100
+@@ -1,421 +0,0 @@
+-# Makefile.in generated by automake 1.11.1 from Makefile.am.
+-# @configure_input@
+-
+-# Copyright (C) 1994, 1995, 1996, 1997, 1998, 1999, 2000, 2001, 2002,
+-# 2003, 2004, 2005, 2006, 2007, 2008, 2009  Free Software Foundation,
+-# Inc.
+-# This Makefile.in is free software; the Free Software Foundation
+-# gives unlimited permission to copy and/or distribute it,
+-# with or without modifications, as long as this notice is preserved.
+-
+-# This program is distributed in the hope that it will be useful,
+-# but WITHOUT ANY WARRANTY, to the extent permitted by law; without
+-# even the implied warranty of MERCHANTABILITY or FITNESS FOR A
+-# PARTICULAR PURPOSE.
+-
+-@SET_MAKE@
+-
+-# Main Makefile for DOSBox
+-VPATH = @srcdir@
+-pkgdatadir = $(datadir)/@PACKAGE@
+-pkgincludedir = $(includedir)/@PACKAGE@
+-pkglibdir = $(libdir)/@PACKAGE@
+-pkglibexecdir = $(libexecdir)/@PACKAGE@
+-am__cd = CDPATH="$${ZSH_VERSION+.}$(PATH_SEPARATOR)" && cd
+-install_sh_DATA = $(install_sh) -c -m 644
+-install_sh_PROGRAM = $(install_sh) -c
+-install_sh_SCRIPT = $(install_sh) -c
+-INSTALL_HEADER = $(INSTALL_DATA)
+-transform = $(program_transform_name)
+-NORMAL_INSTALL = :
+-PRE_INSTALL = :
+-POST_INSTALL = :
+-NORMAL_UNINSTALL = :
+-PRE_UNINSTALL = :
+-POST_UNINSTALL = :
+-build_triplet = @build@
+-host_triplet = @host@
+-subdir = docs
+-DIST_COMMON = $(srcdir)/Makefile.am $(srcdir)/Makefile.in
+-ACLOCAL_M4 = $(top_srcdir)/aclocal.m4
+-am__aclocal_m4_deps = $(top_srcdir)/acinclude.m4 \
+-	$(top_srcdir)/configure.in
+-am__configure_deps = $(am__aclocal_m4_deps) $(CONFIGURE_DEPENDENCIES) \
+-	$(ACLOCAL_M4)
+-mkinstalldirs = $(install_sh) -d
+-CONFIG_HEADER = $(top_builddir)/config.h
+-CONFIG_CLEAN_FILES =
+-CONFIG_CLEAN_VPATH_FILES =
+-SOURCES =
+-DIST_SOURCES =
+-am__vpath_adj_setup = srcdirstrip=`echo "$(srcdir)" | sed 's|.|.|g'`;
+-am__vpath_adj = case $$p in \
+-    $(srcdir)/*) f=`echo "$$p" | sed "s|^$$srcdirstrip/||"`;; \
+-    *) f=$$p;; \
+-  esac;
+-am__strip_dir = f=`echo $$p | sed -e 's|^.*/||'`;
+-am__install_max = 40
+-am__nobase_strip_setup = \
+-  srcdirstrip=`echo "$(srcdir)" | sed 's/[].[^$$\\*|]/\\\\&/g'`
+-am__nobase_strip = \
+-  for p in $$list; do echo "$$p"; done | sed -e "s|$$srcdirstrip/||"
+-am__nobase_list = $(am__nobase_strip_setup); \
+-  for p in $$list; do echo "$$p $$p"; done | \
+-  sed "s| $$srcdirstrip/| |;"' / .*\//!s/ .*/ ./; s,\( .*\)/[^/]*$$,\1,' | \
+-  $(AWK) 'BEGIN { files["."] = "" } { files[$$2] = files[$$2] " " $$1; \
+-    if (++n[$$2] == $(am__install_max)) \
+-      { print $$2, files[$$2]; n[$$2] = 0; files[$$2] = "" } } \
+-    END { for (dir in files) print dir, files[dir] }'
+-am__base_list = \
+-  sed '$$!N;$$!N;$$!N;$$!N;$$!N;$$!N;$$!N;s/\n/ /g' | \
+-  sed '$$!N;$$!N;$$!N;$$!N;s/\n/ /g'
+-man1dir = $(mandir)/man1
+-am__installdirs = "$(DESTDIR)$(man1dir)"
+-NROFF = nroff
+-MANS = $(man_MANS)
+-DISTFILES = $(DIST_COMMON) $(DIST_SOURCES) $(TEXINFOS) $(EXTRA_DIST)
+-ACLOCAL = @ACLOCAL@
+-ALSA_CFLAGS = @ALSA_CFLAGS@
+-ALSA_LIBS = @ALSA_LIBS@
+-AMTAR = @AMTAR@
+-AUTOCONF = @AUTOCONF@
+-AUTOHEADER = @AUTOHEADER@
+-AUTOMAKE = @AUTOMAKE@
+-AWK = @AWK@
+-CC = @CC@
+-CCDEPMODE = @CCDEPMODE@
+-CFLAGS = @CFLAGS@
+-CPP = @CPP@
+-CPPFLAGS = @CPPFLAGS@
+-CXX = @CXX@
+-CXXDEPMODE = @CXXDEPMODE@
+-CXXFLAGS = @CXXFLAGS@
+-CYGPATH_W = @CYGPATH_W@
+-DEFS = @DEFS@
+-DEPDIR = @DEPDIR@
+-ECHO_C = @ECHO_C@
+-ECHO_N = @ECHO_N@
+-ECHO_T = @ECHO_T@
+-EGREP = @EGREP@
+-EXEEXT = @EXEEXT@
+-GREP = @GREP@
+-INSTALL = @INSTALL@
+-INSTALL_DATA = @INSTALL_DATA@
+-INSTALL_PROGRAM = @INSTALL_PROGRAM@
+-INSTALL_SCRIPT = @INSTALL_SCRIPT@
+-INSTALL_STRIP_PROGRAM = @INSTALL_STRIP_PROGRAM@
+-LDFLAGS = @LDFLAGS@
+-LIBOBJS = @LIBOBJS@
+-LIBS = @LIBS@
+-LTLIBOBJS = @LTLIBOBJS@
+-MAKEINFO = @MAKEINFO@
+-MKDIR_P = @MKDIR_P@
+-OBJEXT = @OBJEXT@
+-PACKAGE = @PACKAGE@
+-PACKAGE_BUGREPORT = @PACKAGE_BUGREPORT@
+-PACKAGE_NAME = @PACKAGE_NAME@
+-PACKAGE_STRING = @PACKAGE_STRING@
+-PACKAGE_TARNAME = @PACKAGE_TARNAME@
+-PACKAGE_URL = @PACKAGE_URL@
+-PACKAGE_VERSION = @PACKAGE_VERSION@
+-PATH_SEPARATOR = @PATH_SEPARATOR@
+-RANLIB = @RANLIB@
+-SDL_CFLAGS = @SDL_CFLAGS@
+-SDL_CONFIG = @SDL_CONFIG@
+-SDL_LIBS = @SDL_LIBS@
+-SET_MAKE = @SET_MAKE@
+-SHELL = @SHELL@
+-STRIP = @STRIP@
+-VERSION = @VERSION@
+-WINDRES = @WINDRES@
+-abs_builddir = @abs_builddir@
+-abs_srcdir = @abs_srcdir@
+-abs_top_builddir = @abs_top_builddir@
+-abs_top_srcdir = @abs_top_srcdir@
+-ac_ct_CC = @ac_ct_CC@
+-ac_ct_CXX = @ac_ct_CXX@
+-am__include = @am__include@
+-am__leading_dot = @am__leading_dot@
+-am__quote = @am__quote@
+-am__tar = @am__tar@
+-am__untar = @am__untar@
+-bindir = @bindir@
+-build = @build@
+-build_alias = @build_alias@
+-build_cpu = @build_cpu@
+-build_os = @build_os@
+-build_vendor = @build_vendor@
+-builddir = @builddir@
+-datadir = @datadir@
+-datarootdir = @datarootdir@
+-docdir = @docdir@
+-dvidir = @dvidir@
+-exec_prefix = @exec_prefix@
+-host = @host@
+-host_alias = @host_alias@
+-host_cpu = @host_cpu@
+-host_os = @host_os@
+-host_vendor = @host_vendor@
+-htmldir = @htmldir@
+-includedir = @includedir@
+-infodir = @infodir@
+-install_sh = @install_sh@
+-libdir = @libdir@
+-libexecdir = @libexecdir@
+-localedir = @localedir@
+-localstatedir = @localstatedir@
+-mandir = @mandir@
+-mkdir_p = @mkdir_p@
+-oldincludedir = @oldincludedir@
+-pdfdir = @pdfdir@
+-prefix = @prefix@
+-program_transform_name = @program_transform_name@
+-psdir = @psdir@
+-sbindir = @sbindir@
+-sharedstatedir = @sharedstatedir@
+-srcdir = @srcdir@
+-sysconfdir = @sysconfdir@
+-target_alias = @target_alias@
+-top_build_prefix = @top_build_prefix@
+-top_builddir = @top_builddir@
+-top_srcdir = @top_srcdir@
+-man_MANS = dosbox.1 
+-EXTRA_DIST = $(man_MANS) README.video PORTING
+-all: all-am
+-
+-.SUFFIXES:
+-$(srcdir)/Makefile.in:  $(srcdir)/Makefile.am  $(am__configure_deps)
+-	@for dep in $?; do \
+-	  case '$(am__configure_deps)' in \
+-	    *$$dep*) \
+-	      ( cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh ) \
+-	        && { if test -f $@; then exit 0; else break; fi; }; \
+-	      exit 1;; \
+-	  esac; \
+-	done; \
+-	echo ' cd $(top_srcdir) && $(AUTOMAKE) --gnu docs/Makefile'; \
+-	$(am__cd) $(top_srcdir) && \
+-	  $(AUTOMAKE) --gnu docs/Makefile
+-.PRECIOUS: Makefile
+-Makefile: $(srcdir)/Makefile.in $(top_builddir)/config.status
+-	@case '$?' in \
+-	  *config.status*) \
+-	    cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh;; \
+-	  *) \
+-	    echo ' cd $(top_builddir) && $(SHELL) ./config.status $(subdir)/$@ $(am__depfiles_maybe)'; \
+-	    cd $(top_builddir) && $(SHELL) ./config.status $(subdir)/$@ $(am__depfiles_maybe);; \
+-	esac;
+-
+-$(top_builddir)/config.status: $(top_srcdir)/configure $(CONFIG_STATUS_DEPENDENCIES)
+-	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
+-
+-$(top_srcdir)/configure:  $(am__configure_deps)
+-	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
+-$(ACLOCAL_M4):  $(am__aclocal_m4_deps)
+-	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
+-$(am__aclocal_m4_deps):
+-install-man1: $(man_MANS)
+-	@$(NORMAL_INSTALL)
+-	test -z "$(man1dir)" || $(MKDIR_P) "$(DESTDIR)$(man1dir)"
+-	@list=''; test -n "$(man1dir)" || exit 0; \
+-	{ for i in $$list; do echo "$$i"; done; \
+-	l2='$(man_MANS)'; for i in $$l2; do echo "$$i"; done | \
+-	  sed -n '/\.1[a-z]*$$/p'; \
+-	} | while read p; do \
+-	  if test -f $$p; then d=; else d="$(srcdir)/"; fi; \
+-	  echo "$$d$$p"; echo "$$p"; \
+-	done | \
+-	sed -e 'n;s,.*/,,;p;h;s,.*\.,,;s,^[^1][0-9a-z]*$$,1,;x' \
+-	      -e 's,\.[0-9a-z]*$$,,;$(transform);G;s,\n,.,' | \
+-	sed 'N;N;s,\n, ,g' | { \
+-	list=; while read file base inst; do \
+-	  if test "$$base" = "$$inst"; then list="$$list $$file"; else \
+-	    echo " $(INSTALL_DATA) '$$file' '$(DESTDIR)$(man1dir)/$$inst'"; \
+-	    $(INSTALL_DATA) "$$file" "$(DESTDIR)$(man1dir)/$$inst" || exit $$?; \
+-	  fi; \
+-	done; \
+-	for i in $$list; do echo "$$i"; done | $(am__base_list) | \
+-	while read files; do \
+-	  test -z "$$files" || { \
+-	    echo " $(INSTALL_DATA) $$files '$(DESTDIR)$(man1dir)'"; \
+-	    $(INSTALL_DATA) $$files "$(DESTDIR)$(man1dir)" || exit $$?; }; \
+-	done; }
+-
+-uninstall-man1:
+-	@$(NORMAL_UNINSTALL)
+-	@list=''; test -n "$(man1dir)" || exit 0; \
+-	files=`{ for i in $$list; do echo "$$i"; done; \
+-	l2='$(man_MANS)'; for i in $$l2; do echo "$$i"; done | \
+-	  sed -n '/\.1[a-z]*$$/p'; \
+-	} | sed -e 's,.*/,,;h;s,.*\.,,;s,^[^1][0-9a-z]*$$,1,;x' \
+-	      -e 's,\.[0-9a-z]*$$,,;$(transform);G;s,\n,.,'`; \
+-	test -z "$$files" || { \
+-	  echo " ( cd '$(DESTDIR)$(man1dir)' && rm -f" $$files ")"; \
+-	  cd "$(DESTDIR)$(man1dir)" && rm -f $$files; }
+-tags: TAGS
+-TAGS:
+-
+-ctags: CTAGS
+-CTAGS:
+-
+-
+-distdir: $(DISTFILES)
+-	@list='$(MANS)'; if test -n "$$list"; then \
+-	  list=`for p in $$list; do \
+-	    if test -f $$p; then d=; else d="$(srcdir)/"; fi; \
+-	    if test -f "$$d$$p"; then echo "$$d$$p"; else :; fi; done`; \
+-	  if test -n "$$list" && \
+-	    grep 'ab help2man is required to generate this page' $$list >/dev/null; then \
+-	    echo "error: found man pages containing the \`missing help2man' replacement text:" >&2; \
+-	    grep -l 'ab help2man is required to generate this page' $$list | sed 's/^/         /' >&2; \
+-	    echo "       to fix them, install help2man, remove and regenerate the man pages;" >&2; \
+-	    echo "       typically \`make maintainer-clean' will remove them" >&2; \
+-	    exit 1; \
+-	  else :; fi; \
+-	else :; fi
+-	@srcdirstrip=`echo "$(srcdir)" | sed 's/[].[^$$\\*]/\\\\&/g'`; \
+-	topsrcdirstrip=`echo "$(top_srcdir)" | sed 's/[].[^$$\\*]/\\\\&/g'`; \
+-	list='$(DISTFILES)'; \
+-	  dist_files=`for file in $$list; do echo $$file; done | \
+-	  sed -e "s|^$$srcdirstrip/||;t" \
+-	      -e "s|^$$topsrcdirstrip/|$(top_builddir)/|;t"`; \
+-	case $$dist_files in \
+-	  */*) $(MKDIR_P) `echo "$$dist_files" | \
+-			   sed '/\//!d;s|^|$(distdir)/|;s,/[^/]*$$,,' | \
+-			   sort -u` ;; \
+-	esac; \
+-	for file in $$dist_files; do \
+-	  if test -f $$file || test -d $$file; then d=.; else d=$(srcdir); fi; \
+-	  if test -d $$d/$$file; then \
+-	    dir=`echo "/$$file" | sed -e 's,/[^/]*$$,,'`; \
+-	    if test -d "$(distdir)/$$file"; then \
+-	      find "$(distdir)/$$file" -type d ! -perm -700 -exec chmod u+rwx {} \;; \
+-	    fi; \
+-	    if test -d $(srcdir)/$$file && test $$d != $(srcdir); then \
+-	      cp -fpR $(srcdir)/$$file "$(distdir)$$dir" || exit 1; \
+-	      find "$(distdir)/$$file" -type d ! -perm -700 -exec chmod u+rwx {} \;; \
+-	    fi; \
+-	    cp -fpR $$d/$$file "$(distdir)$$dir" || exit 1; \
+-	  else \
+-	    test -f "$(distdir)/$$file" \
+-	    || cp -p $$d/$$file "$(distdir)/$$file" \
+-	    || exit 1; \
+-	  fi; \
+-	done
+-check-am: all-am
+-check: check-am
+-all-am: Makefile $(MANS)
+-installdirs:
+-	for dir in "$(DESTDIR)$(man1dir)"; do \
+-	  test -z "$$dir" || $(MKDIR_P) "$$dir"; \
+-	done
+-install: install-am
+-install-exec: install-exec-am
+-install-data: install-data-am
+-uninstall: uninstall-am
+-
+-install-am: all-am
+-	@$(MAKE) $(AM_MAKEFLAGS) install-exec-am install-data-am
+-
+-installcheck: installcheck-am
+-install-strip:
+-	$(MAKE) $(AM_MAKEFLAGS) INSTALL_PROGRAM="$(INSTALL_STRIP_PROGRAM)" \
+-	  install_sh_PROGRAM="$(INSTALL_STRIP_PROGRAM)" INSTALL_STRIP_FLAG=-s \
+-	  `test -z '$(STRIP)' || \
+-	    echo "INSTALL_PROGRAM_ENV=STRIPPROG='$(STRIP)'"` install
+-mostlyclean-generic:
+-
+-clean-generic:
+-
+-distclean-generic:
+-	-test -z "$(CONFIG_CLEAN_FILES)" || rm -f $(CONFIG_CLEAN_FILES)
+-	-test . = "$(srcdir)" || test -z "$(CONFIG_CLEAN_VPATH_FILES)" || rm -f $(CONFIG_CLEAN_VPATH_FILES)
+-
+-maintainer-clean-generic:
+-	@echo "This command is intended for maintainers to use"
+-	@echo "it deletes files that may require special tools to rebuild."
+-clean: clean-am
+-
+-clean-am: clean-generic mostlyclean-am
+-
+-distclean: distclean-am
+-	-rm -f Makefile
+-distclean-am: clean-am distclean-generic
+-
+-dvi: dvi-am
+-
+-dvi-am:
+-
+-html: html-am
+-
+-html-am:
+-
+-info: info-am
+-
+-info-am:
+-
+-install-data-am: install-man
+-
+-install-dvi: install-dvi-am
+-
+-install-dvi-am:
+-
+-install-exec-am:
+-
+-install-html: install-html-am
+-
+-install-html-am:
+-
+-install-info: install-info-am
+-
+-install-info-am:
+-
+-install-man: install-man1
+-
+-install-pdf: install-pdf-am
+-
+-install-pdf-am:
+-
+-install-ps: install-ps-am
+-
+-install-ps-am:
+-
+-installcheck-am:
+-
+-maintainer-clean: maintainer-clean-am
+-	-rm -f Makefile
+-maintainer-clean-am: distclean-am maintainer-clean-generic
+-
+-mostlyclean: mostlyclean-am
+-
+-mostlyclean-am: mostlyclean-generic
+-
+-pdf: pdf-am
+-
+-pdf-am:
+-
+-ps: ps-am
+-
+-ps-am:
+-
+-uninstall-am: uninstall-man
+-
+-uninstall-man: uninstall-man1
+-
+-.MAKE: install-am install-strip
+-
+-.PHONY: all all-am check check-am clean clean-generic distclean \
+-	distclean-generic distdir dvi dvi-am html html-am info info-am \
+-	install install-am install-data install-data-am install-dvi \
+-	install-dvi-am install-exec install-exec-am install-html \
+-	install-html-am install-info install-info-am install-man \
+-	install-man1 install-pdf install-pdf-am install-ps \
+-	install-ps-am install-strip installcheck installcheck-am \
+-	installdirs maintainer-clean maintainer-clean-generic \
+-	mostlyclean mostlyclean-generic pdf pdf-am ps ps-am uninstall \
+-	uninstall-am uninstall-man uninstall-man1
+-
+-
+-# Tell versions [3.59,3.63) of GNU make to not export all variables.
+-# Otherwise a system limit (for SysV at least) may be exceeded.
+-.NOEXPORT:
+diff -Nur dosbox-0.74/include/bios_disk.h dosbox/include/bios_disk.h
+--- dosbox-0.74/include/bios_disk.h	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/include/bios_disk.h	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -65,9 +65,11 @@
+ 
+ 	Bit32u sector_size;
+ 	Bit32u heads,cylinders,sectors;
++	Bit32u current_fpos;
+ };
+ 
+ void updateDPT(void);
++void incrementFDD(void);
+ 
+ #define MAX_HDD_IMAGES 2
+ 
+diff -Nur dosbox-0.74/include/bios.h dosbox/include/bios.h
+--- dosbox-0.74/include/bios.h	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/include/bios.h	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -106,6 +106,7 @@
+ #define BIOS_DEFAULT_IRQ0_LOCATION		(RealMake(0xf000,0xfea5))
+ #define BIOS_DEFAULT_IRQ1_LOCATION		(RealMake(0xf000,0xe987))
+ #define BIOS_DEFAULT_IRQ2_LOCATION		(RealMake(0xf000,0xff55))
++#define BIOS_DEFAULT_RESET_LOCATION		(RealMake(0xf000,0xe05b))
+ 
+ /* maximum of scancodes handled by keyboard bios routines */
+ #define MAX_SCAN_CODE 0x58
+diff -Nur dosbox-0.74/include/callback.h dosbox/include/callback.h
+--- dosbox-0.74/include/callback.h	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/include/callback.h	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,7 +16,6 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: callback.h,v 1.26 2009-08-23 17:24:54 c2woody Exp $ */
+ 
+ #ifndef DOSBOX_CALLBACK_H
+ #define DOSBOX_CALLBACK_H
+@@ -31,7 +30,7 @@
+ enum { CB_RETN,CB_RETF,CB_RETF8,CB_IRET,CB_IRETD,CB_IRET_STI,CB_IRET_EOI_PIC1,
+ 		CB_IRQ0,CB_IRQ1,CB_IRQ9,CB_IRQ12,CB_IRQ12_RET,CB_IRQ6_PCJR,CB_MOUSE,
+ 		CB_INT29,CB_INT16,CB_HOOKABLE,CB_TDE_IRET,CB_IPXESR,CB_IPXESR_RET,
+-		CB_INT21 };
++		CB_INT21,CB_INT13 };
+ 
+ #define CB_MAX		128
+ #define CB_SIZE		32
+@@ -96,6 +95,8 @@
+ 	void Install(CallBack_Handler handler,Bitu type,const char* description);
+ 	void Install(CallBack_Handler handler,Bitu type,PhysPt addr,const char* description);
+ 
++	void Uninstall();
++
+ 	//Only allocate a callback number
+ 	void Allocate(CallBack_Handler handler,const char* description=0);
+ 	Bit16u Get_callback() {
+diff -Nur dosbox-0.74/include/control.h dosbox/include/control.h
+--- dosbox-0.74/include/control.h	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/include/control.h	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,7 +16,6 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: control.h,v 1.2 2009-05-27 09:15:40 qbix79 Exp $ */
+ 
+ #ifndef DOSBOX_CONTROL_H
+ #define DOSBOX_CONTROL_H
+@@ -63,7 +62,14 @@
+ 	void (* _start_function)(void);
+ 	bool secure_mode; //Sandbox mode
+ public:
+-	Config(CommandLine * cmd):cmdline(cmd),secure_mode(false){}
++	bool initialised;
++	std::vector<std::string> startup_params;
++	std::vector<std::string> configfiles;
++	Config(CommandLine * cmd):cmdline(cmd),secure_mode(false) {
++		startup_params.push_back(cmdline->GetFileName());
++		cmdline->FillVector(startup_params);
++		initialised=false;
++	}
+ 	~Config();
+ 
+ 	Section_line * AddSection_line(char const * const _name,void (*_initfunction)(Section*));
+diff -Nur dosbox-0.74/include/cpu.h dosbox/include/cpu.h
+--- dosbox-0.74/include/cpu.h	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/include/cpu.h	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,7 +16,6 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: cpu.h,v 1.57 2009-05-27 09:15:40 qbix79 Exp $ */
+ 
+ #ifndef DOSBOX_CPU_H
+ #define DOSBOX_CPU_H
+diff -Nur dosbox-0.74/include/cross.h dosbox/include/cross.h
+--- dosbox-0.74/include/cross.h	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/include/cross.h	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,7 +16,6 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: cross.h,v 1.21 2009-03-14 18:02:34 qbix79 Exp $ */
+ 
+ #ifndef DOSBOX_CROSS_H
+ #define DOSBOX_CROSS_H
+@@ -74,6 +73,7 @@
+ 	static void CreatePlatformConfigDir(std::string& in);
+ 	static void ResolveHomedir(std::string & temp_line);
+ 	static void CreateDir(std::string const& temp);
++	static bool IsPathAbsolute(std::string const& in);
+ };
+ 
+ 
+diff -Nur dosbox-0.74/include/debug.h dosbox/include/debug.h
+--- dosbox-0.74/include/debug.h	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/include/debug.h	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+diff -Nur dosbox-0.74/include/dma.h dosbox/include/dma.h
+--- dosbox-0.74/include/dma.h	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/include/dma.h	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,7 +16,6 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: dma.h,v 1.20 2009-07-24 09:56:14 c2woody Exp $ */
+ 
+ #ifndef DOSBOX_DMA_H
+ #define DOSBOX_DMA_H
+@@ -114,6 +113,6 @@
+ void CloseSecondDMAController(void);
+ bool SecondDMAControllerAvailable(void);
+ 
+-static Bit32u dma_wrapping = 0xffff;
++void DMA_SetWrapping(Bitu wrap);
+ 
+ #endif
+diff -Nur dosbox-0.74/include/dosbox.h dosbox/include/dosbox.h
+--- dosbox-0.74/include/dosbox.h	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/include/dosbox.h	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,17 +16,16 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: dosbox.h,v 1.32 2009-05-27 09:15:41 qbix79 Exp $ */
+ 
+ #ifndef DOSBOX_DOSBOX_H
+ #define DOSBOX_DOSBOX_H
+ 
+ #include "config.h"
+ 
+-void E_Exit(const char * message,...) GCC_ATTRIBUTE( __format__(__printf__, 1, 2));
++GCC_ATTRIBUTE(noreturn) void E_Exit(const char * message,...) GCC_ATTRIBUTE( __format__(__printf__, 1, 2));
+ 
+-void MSG_Add(const char*,const char*); //add messages to the internal langaugefile
+-const char* MSG_Get(char const *);     //get messages from the internal langaugafile
++void MSG_Add(const char*,const char*); //add messages to the internal languagefile
++const char* MSG_Get(char const *);     //get messages from the internal languagefile
+ 
+ class Section;
+ 
+diff -Nur dosbox-0.74/include/dos_inc.h dosbox/include/dos_inc.h
+--- dosbox-0.74/include/dos_inc.h	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/include/dos_inc.h	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,7 +16,6 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: dos_inc.h,v 1.83 2009-10-28 21:45:12 qbix79 Exp $ */
+ 
+ #ifndef DOSBOX_DOS_INC_H
+ #define DOSBOX_DOS_INC_H
+@@ -28,6 +27,8 @@
+ #include "mem.h"
+ #endif
+ 
++#include <stddef.h> //for offsetof
++
+ #ifdef _MSC_VER
+ #pragma pack (1)
+ #endif
+@@ -176,8 +177,8 @@
+ bool DOS_FCBFindNext(Bit16u seg,Bit16u offset);
+ Bit8u DOS_FCBRead(Bit16u seg,Bit16u offset, Bit16u numBlocks);
+ Bit8u DOS_FCBWrite(Bit16u seg,Bit16u offset,Bit16u numBlocks);
+-Bit8u DOS_FCBRandomRead(Bit16u seg,Bit16u offset,Bit16u numRec,bool restore);
+-Bit8u DOS_FCBRandomWrite(Bit16u seg,Bit16u offset,Bit16u numRec,bool restore);
++Bit8u DOS_FCBRandomRead(Bit16u seg,Bit16u offset,Bit16u * numRec,bool restore);
++Bit8u DOS_FCBRandomWrite(Bit16u seg,Bit16u offset,Bit16u * numRec,bool restore);
+ bool DOS_FCBGetFileSize(Bit16u seg,Bit16u offset);
+ bool DOS_FCBDeleteFile(Bit16u seg,Bit16u offset);
+ bool DOS_FCBRenameFile(Bit16u seg, Bit16u offset);
+@@ -506,6 +507,7 @@
+ 	bool Extended(void);
+ 	void GetAttr(Bit8u & attr);
+ 	void SetAttr(Bit8u attr);
++	void SetResultAttr(Bit8u attr);
+ 	bool Valid(void);
+ private:
+ 	bool extended;
+@@ -636,7 +638,7 @@
+ 
+ extern DOS_Block dos;
+ 
+-static Bit8u RealHandle(Bit16u handle) {
++static INLINE Bit8u RealHandle(Bit16u handle) {
+ 	DOS_PSP psp(dos.psp());	
+ 	return psp.GetFileHandle(handle);
+ }
+diff -Nur dosbox-0.74/include/dos_system.h dosbox/include/dos_system.h
+--- dosbox-0.74/include/dos_system.h	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/include/dos_system.h	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,7 +16,6 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: dos_system.h,v 1.47 2009-03-04 21:08:22 c2woody Exp $ */
+ 
+ #ifndef DOSBOX_DOS_SYSTEM_H
+ #define DOSBOX_DOS_SYSTEM_H
+@@ -156,8 +155,9 @@
+ 	public:
+ 		CFileInfo(void) {
+ 			orgname[0] = shortname[0] = 0;
+-			nextEntry = shortNr = 0;
+ 			isDir = false;
++			id = MAX_OPENDIRS;
++			nextEntry = shortNr = 0;
+ 		}
+ 		~CFileInfo(void) {
+ 			for (Bit32u i=0; i<fileList.size(); i++) delete fileList[i];
+@@ -167,6 +167,7 @@
+ 		char		orgname		[CROSS_LEN];
+ 		char		shortname	[DOS_NAMELENGTH_ASCII];
+ 		bool		isDir;
++		Bit16u		id;
+ 		Bitu		nextEntry;
+ 		Bitu		shortNr;
+ 		// contents
+@@ -175,6 +176,8 @@
+ 	};
+ 
+ private:
++	void ClearFileInfo(CFileInfo *dir);
++	void DeleteFileInfo(CFileInfo *dir);
+ 
+ 	bool		RemoveTrailingDot	(char* shortname);
+ 	Bits		GetLongName		(CFileInfo* info, char* shortname);
+@@ -203,7 +206,6 @@
+ 	Bit16u		srchNr;
+ 	CFileInfo*	dirSearch			[MAX_OPENDIRS];
+ 	char		dirSearchName		[MAX_OPENDIRS];
+-	bool		free				[MAX_OPENDIRS];
+ 	CFileInfo*	dirFindFirst		[MAX_OPENDIRS];
+ 	Bit16u		nextFreeFindFirst;
+ 
+@@ -247,7 +249,7 @@
+ 	virtual void Activate(void) {};
+ };
+ 
+-enum { OPEN_READ=0,OPEN_WRITE=1,OPEN_READWRITE=2, DOS_NOT_INHERIT=128};
++enum { OPEN_READ=0, OPEN_WRITE=1, OPEN_READWRITE=2, OPEN_READ_NO_MOD=4, DOS_NOT_INHERIT=128};
+ enum { DOS_SEEK_SET=0,DOS_SEEK_CUR=1,DOS_SEEK_END=2};
+ 
+ 
+diff -Nur dosbox-0.74/include/fpu.h dosbox/include/fpu.h
+--- dosbox-0.74/include/fpu.h	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/include/fpu.h	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -86,7 +86,7 @@
+ 	FPU_Tag		tags[9];
+ 	Bit16u		cw,cw_mask_all;
+ 	Bit16u		sw;
+-	Bitu		top;
++	Bit32u		top;
+ 	FPU_Round	round;
+ } FPU_rec;
+ 
+diff -Nur dosbox-0.74/include/hardware.h dosbox/include/hardware.h
+--- dosbox-0.74/include/hardware.h	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/include/hardware.h	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,7 +16,6 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: hardware.h,v 1.17 2009-06-23 17:46:05 c2woody Exp $ */
+ 
+ #ifndef DOSBOX_HARDWARE_H
+ #define DOSBOX_HARDWARE_H
+diff -Nur dosbox-0.74/include/inout.h dosbox/include/inout.h
+--- dosbox-0.74/include/inout.h	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/include/inout.h	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,7 +16,6 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: inout.h,v 1.13 2009-05-27 09:15:41 qbix79 Exp $ */
+ 
+ #ifndef DOSBOX_INOUT_H
+ #define DOSBOX_INOUT_H
+@@ -60,11 +59,13 @@
+ class IO_ReadHandleObject: private IO_Base{
+ public:
+ 	void Install(Bitu port,IO_ReadHandler * handler,Bitu mask,Bitu range=1);
++	void Uninstall();
+ 	~IO_ReadHandleObject();
+ };
+ class IO_WriteHandleObject: private IO_Base{
+ public:
+ 	void Install(Bitu port,IO_WriteHandler * handler,Bitu mask,Bitu range=1);
++	void Uninstall();
+ 	~IO_WriteHandleObject();
+ };
+ 
+diff -Nur dosbox-0.74/include/ipx.h dosbox/include/ipx.h
+--- dosbox-0.74/include/ipx.h	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/include/ipx.h	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,7 +16,6 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: ipx.h,v 1.13 2009-05-27 09:15:41 qbix79 Exp $ */
+ 
+ #ifndef DOSBOX_IPX_H
+ #define DOSBOX_IPX_H
+diff -Nur dosbox-0.74/include/ipxserver.h dosbox/include/ipxserver.h
+--- dosbox-0.74/include/ipxserver.h	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/include/ipxserver.h	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+diff -Nur dosbox-0.74/include/joystick.h dosbox/include/joystick.h
+--- dosbox-0.74/include/joystick.h	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/include/joystick.h	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,7 +16,6 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: joystick.h,v 1.13 2009-05-27 09:15:41 qbix79 Exp $ */
+ #ifndef DOSBOX_JOYSTICK_H
+ #define DOSBOX_JOYSTICK_H
+ void JOYSTICK_Enable(Bitu which,bool enabled);
+diff -Nur dosbox-0.74/include/keyboard.h dosbox/include/keyboard.h
+--- dosbox-0.74/include/keyboard.h	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/include/keyboard.h	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+diff -Nur dosbox-0.74/include/logging.h dosbox/include/logging.h
+--- dosbox-0.74/include/logging.h	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/include/logging.h	2014-01-12 14:43:47.000000000 +0100
+@@ -1,3 +1,21 @@
++/*
++ *  Copyright (C) 2002-2013  The DOSBox Team
++ *
++ *  This program is free software; you can redistribute it and/or modify
++ *  it under the terms of the GNU General Public License as published by
++ *  the Free Software Foundation; either version 2 of the License, or
++ *  (at your option) any later version.
++ *
++ *  This program is distributed in the hope that it will be useful,
++ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
++ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
++ *  GNU General Public License for more details.
++ *
++ *  You should have received a copy of the GNU General Public License
++ *  along with this program; if not, write to the Free Software
++ *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
++ */
++
+ #ifndef DOSBOX_LOGGING_H
+ #define DOSBOX_LOGGING_H
+ enum LOG_TYPES {
+@@ -9,6 +27,7 @@
+ 	LOG_PIT,LOG_KEYBOARD,LOG_PIC,
+ 	LOG_MOUSE,LOG_BIOS,LOG_GUI,LOG_MISC,
+ 	LOG_IO,
++	LOG_PCI,
+ 	LOG_MAX
+ };
+ 
+@@ -47,6 +66,10 @@
+ 	void operator()(char const* , double , double , double )					{ }
+ 	void operator()(char const* , double , double , double , double )					{ }
+ 	void operator()(char const* , double , double , double , double , double )					{ }
++	void operator()(char const* , double , double , double , double , double , double )					{ }
++	void operator()(char const* , double , double , double , double , double , double , double)					{ }
++
++
+ 
+ 	void operator()(char const* , char const* )									{ }
+ 	void operator()(char const* , char const* , double )							{ }
+@@ -55,7 +78,7 @@
+ 	void operator()(char const* , double , double, char const* )						{ }
+ 	void operator()(char const* , char const*, char const*)				{ }
+ 
+-
++	void operator()(char const* , double , double , double , char const* )					{ }
+ }; //add missing operators to here
+ 	//try to avoid anything smaller than bit32...
+ void GFX_ShowMsg(char const* format,...) GCC_ATTRIBUTE(__format__(__printf__, 1, 2));
+diff -Nur dosbox-0.74/include/Makefile.am dosbox/include/Makefile.am
+--- dosbox-0.74/include/Makefile.am	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/include/Makefile.am	2014-01-12 14:43:47.000000000 +0100
+@@ -20,10 +20,12 @@
+ logging.h \
+ mapper.h \
+ mem.h \
++midi.h \
+ mixer.h \
+ modules.h \
+ mouse.h \
+ paging.h \
++pci_bus.h \
+ pic.h \
+ programs.h \
+ render.h \
+diff -Nur dosbox-0.74/include/Makefile.in dosbox/include/Makefile.in
+--- dosbox-0.74/include/Makefile.in	2010-05-12 11:57:43.000000000 +0200
++++ dosbox/include/Makefile.in	1970-01-01 01:00:00.000000000 +0100
+@@ -1,426 +0,0 @@
+-# Makefile.in generated by automake 1.11.1 from Makefile.am.
+-# @configure_input@
+-
+-# Copyright (C) 1994, 1995, 1996, 1997, 1998, 1999, 2000, 2001, 2002,
+-# 2003, 2004, 2005, 2006, 2007, 2008, 2009  Free Software Foundation,
+-# Inc.
+-# This Makefile.in is free software; the Free Software Foundation
+-# gives unlimited permission to copy and/or distribute it,
+-# with or without modifications, as long as this notice is preserved.
+-
+-# This program is distributed in the hope that it will be useful,
+-# but WITHOUT ANY WARRANTY, to the extent permitted by law; without
+-# even the implied warranty of MERCHANTABILITY or FITNESS FOR A
+-# PARTICULAR PURPOSE.
+-
+-@SET_MAKE@
+-
+-VPATH = @srcdir@
+-pkgdatadir = $(datadir)/@PACKAGE@
+-pkgincludedir = $(includedir)/@PACKAGE@
+-pkglibdir = $(libdir)/@PACKAGE@
+-pkglibexecdir = $(libexecdir)/@PACKAGE@
+-am__cd = CDPATH="$${ZSH_VERSION+.}$(PATH_SEPARATOR)" && cd
+-install_sh_DATA = $(install_sh) -c -m 644
+-install_sh_PROGRAM = $(install_sh) -c
+-install_sh_SCRIPT = $(install_sh) -c
+-INSTALL_HEADER = $(INSTALL_DATA)
+-transform = $(program_transform_name)
+-NORMAL_INSTALL = :
+-PRE_INSTALL = :
+-POST_INSTALL = :
+-NORMAL_UNINSTALL = :
+-PRE_UNINSTALL = :
+-POST_UNINSTALL = :
+-build_triplet = @build@
+-host_triplet = @host@
+-subdir = include
+-DIST_COMMON = $(noinst_HEADERS) $(srcdir)/Makefile.am \
+-	$(srcdir)/Makefile.in
+-ACLOCAL_M4 = $(top_srcdir)/aclocal.m4
+-am__aclocal_m4_deps = $(top_srcdir)/acinclude.m4 \
+-	$(top_srcdir)/configure.in
+-am__configure_deps = $(am__aclocal_m4_deps) $(CONFIGURE_DEPENDENCIES) \
+-	$(ACLOCAL_M4)
+-mkinstalldirs = $(install_sh) -d
+-CONFIG_HEADER = $(top_builddir)/config.h
+-CONFIG_CLEAN_FILES =
+-CONFIG_CLEAN_VPATH_FILES =
+-SOURCES =
+-DIST_SOURCES =
+-HEADERS = $(noinst_HEADERS)
+-ETAGS = etags
+-CTAGS = ctags
+-DISTFILES = $(DIST_COMMON) $(DIST_SOURCES) $(TEXINFOS) $(EXTRA_DIST)
+-ACLOCAL = @ACLOCAL@
+-ALSA_CFLAGS = @ALSA_CFLAGS@
+-ALSA_LIBS = @ALSA_LIBS@
+-AMTAR = @AMTAR@
+-AUTOCONF = @AUTOCONF@
+-AUTOHEADER = @AUTOHEADER@
+-AUTOMAKE = @AUTOMAKE@
+-AWK = @AWK@
+-CC = @CC@
+-CCDEPMODE = @CCDEPMODE@
+-CFLAGS = @CFLAGS@
+-CPP = @CPP@
+-CPPFLAGS = @CPPFLAGS@
+-CXX = @CXX@
+-CXXDEPMODE = @CXXDEPMODE@
+-CXXFLAGS = @CXXFLAGS@
+-CYGPATH_W = @CYGPATH_W@
+-DEFS = @DEFS@
+-DEPDIR = @DEPDIR@
+-ECHO_C = @ECHO_C@
+-ECHO_N = @ECHO_N@
+-ECHO_T = @ECHO_T@
+-EGREP = @EGREP@
+-EXEEXT = @EXEEXT@
+-GREP = @GREP@
+-INSTALL = @INSTALL@
+-INSTALL_DATA = @INSTALL_DATA@
+-INSTALL_PROGRAM = @INSTALL_PROGRAM@
+-INSTALL_SCRIPT = @INSTALL_SCRIPT@
+-INSTALL_STRIP_PROGRAM = @INSTALL_STRIP_PROGRAM@
+-LDFLAGS = @LDFLAGS@
+-LIBOBJS = @LIBOBJS@
+-LIBS = @LIBS@
+-LTLIBOBJS = @LTLIBOBJS@
+-MAKEINFO = @MAKEINFO@
+-MKDIR_P = @MKDIR_P@
+-OBJEXT = @OBJEXT@
+-PACKAGE = @PACKAGE@
+-PACKAGE_BUGREPORT = @PACKAGE_BUGREPORT@
+-PACKAGE_NAME = @PACKAGE_NAME@
+-PACKAGE_STRING = @PACKAGE_STRING@
+-PACKAGE_TARNAME = @PACKAGE_TARNAME@
+-PACKAGE_URL = @PACKAGE_URL@
+-PACKAGE_VERSION = @PACKAGE_VERSION@
+-PATH_SEPARATOR = @PATH_SEPARATOR@
+-RANLIB = @RANLIB@
+-SDL_CFLAGS = @SDL_CFLAGS@
+-SDL_CONFIG = @SDL_CONFIG@
+-SDL_LIBS = @SDL_LIBS@
+-SET_MAKE = @SET_MAKE@
+-SHELL = @SHELL@
+-STRIP = @STRIP@
+-VERSION = @VERSION@
+-WINDRES = @WINDRES@
+-abs_builddir = @abs_builddir@
+-abs_srcdir = @abs_srcdir@
+-abs_top_builddir = @abs_top_builddir@
+-abs_top_srcdir = @abs_top_srcdir@
+-ac_ct_CC = @ac_ct_CC@
+-ac_ct_CXX = @ac_ct_CXX@
+-am__include = @am__include@
+-am__leading_dot = @am__leading_dot@
+-am__quote = @am__quote@
+-am__tar = @am__tar@
+-am__untar = @am__untar@
+-bindir = @bindir@
+-build = @build@
+-build_alias = @build_alias@
+-build_cpu = @build_cpu@
+-build_os = @build_os@
+-build_vendor = @build_vendor@
+-builddir = @builddir@
+-datadir = @datadir@
+-datarootdir = @datarootdir@
+-docdir = @docdir@
+-dvidir = @dvidir@
+-exec_prefix = @exec_prefix@
+-host = @host@
+-host_alias = @host_alias@
+-host_cpu = @host_cpu@
+-host_os = @host_os@
+-host_vendor = @host_vendor@
+-htmldir = @htmldir@
+-includedir = @includedir@
+-infodir = @infodir@
+-install_sh = @install_sh@
+-libdir = @libdir@
+-libexecdir = @libexecdir@
+-localedir = @localedir@
+-localstatedir = @localstatedir@
+-mandir = @mandir@
+-mkdir_p = @mkdir_p@
+-oldincludedir = @oldincludedir@
+-pdfdir = @pdfdir@
+-prefix = @prefix@
+-program_transform_name = @program_transform_name@
+-psdir = @psdir@
+-sbindir = @sbindir@
+-sharedstatedir = @sharedstatedir@
+-srcdir = @srcdir@
+-sysconfdir = @sysconfdir@
+-target_alias = @target_alias@
+-top_build_prefix = @top_build_prefix@
+-top_builddir = @top_builddir@
+-top_srcdir = @top_srcdir@
+-noinst_HEADERS = \
+-bios.h \
+-bios_disk.h \
+-callback.h \
+-cpu.h \
+-cross.h \
+-control.h \
+-debug.h \
+-dma.h \
+-dos_inc.h \
+-dos_system.h \
+-dosbox.h \
+-fpu.h \
+-hardware.h \
+-inout.h \
+-joystick.h \
+-ipx.h \
+-ipxserver.h \
+-keyboard.h \
+-logging.h \
+-mapper.h \
+-mem.h \
+-mixer.h \
+-modules.h \
+-mouse.h \
+-paging.h \
+-pic.h \
+-programs.h \
+-render.h \
+-regs.h \
+-render.h \
+-serialport.h \
+-setup.h \
+-shell.h \
+-support.h \
+-timer.h \
+-vga.h \
+-video.h
+-
+-all: all-am
+-
+-.SUFFIXES:
+-$(srcdir)/Makefile.in:  $(srcdir)/Makefile.am  $(am__configure_deps)
+-	@for dep in $?; do \
+-	  case '$(am__configure_deps)' in \
+-	    *$$dep*) \
+-	      ( cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh ) \
+-	        && { if test -f $@; then exit 0; else break; fi; }; \
+-	      exit 1;; \
+-	  esac; \
+-	done; \
+-	echo ' cd $(top_srcdir) && $(AUTOMAKE) --gnu include/Makefile'; \
+-	$(am__cd) $(top_srcdir) && \
+-	  $(AUTOMAKE) --gnu include/Makefile
+-.PRECIOUS: Makefile
+-Makefile: $(srcdir)/Makefile.in $(top_builddir)/config.status
+-	@case '$?' in \
+-	  *config.status*) \
+-	    cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh;; \
+-	  *) \
+-	    echo ' cd $(top_builddir) && $(SHELL) ./config.status $(subdir)/$@ $(am__depfiles_maybe)'; \
+-	    cd $(top_builddir) && $(SHELL) ./config.status $(subdir)/$@ $(am__depfiles_maybe);; \
+-	esac;
+-
+-$(top_builddir)/config.status: $(top_srcdir)/configure $(CONFIG_STATUS_DEPENDENCIES)
+-	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
+-
+-$(top_srcdir)/configure:  $(am__configure_deps)
+-	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
+-$(ACLOCAL_M4):  $(am__aclocal_m4_deps)
+-	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
+-$(am__aclocal_m4_deps):
+-
+-ID: $(HEADERS) $(SOURCES) $(LISP) $(TAGS_FILES)
+-	list='$(SOURCES) $(HEADERS) $(LISP) $(TAGS_FILES)'; \
+-	unique=`for i in $$list; do \
+-	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
+-	  done | \
+-	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
+-	      END { if (nonempty) { for (i in files) print i; }; }'`; \
+-	mkid -fID $$unique
+-tags: TAGS
+-
+-TAGS:  $(HEADERS) $(SOURCES)  $(TAGS_DEPENDENCIES) \
+-		$(TAGS_FILES) $(LISP)
+-	set x; \
+-	here=`pwd`; \
+-	list='$(SOURCES) $(HEADERS)  $(LISP) $(TAGS_FILES)'; \
+-	unique=`for i in $$list; do \
+-	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
+-	  done | \
+-	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
+-	      END { if (nonempty) { for (i in files) print i; }; }'`; \
+-	shift; \
+-	if test -z "$(ETAGS_ARGS)$$*$$unique"; then :; else \
+-	  test -n "$$unique" || unique=$$empty_fix; \
+-	  if test $$# -gt 0; then \
+-	    $(ETAGS) $(ETAGSFLAGS) $(AM_ETAGSFLAGS) $(ETAGS_ARGS) \
+-	      "$$@" $$unique; \
+-	  else \
+-	    $(ETAGS) $(ETAGSFLAGS) $(AM_ETAGSFLAGS) $(ETAGS_ARGS) \
+-	      $$unique; \
+-	  fi; \
+-	fi
+-ctags: CTAGS
+-CTAGS:  $(HEADERS) $(SOURCES)  $(TAGS_DEPENDENCIES) \
+-		$(TAGS_FILES) $(LISP)
+-	list='$(SOURCES) $(HEADERS)  $(LISP) $(TAGS_FILES)'; \
+-	unique=`for i in $$list; do \
+-	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
+-	  done | \
+-	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
+-	      END { if (nonempty) { for (i in files) print i; }; }'`; \
+-	test -z "$(CTAGS_ARGS)$$unique" \
+-	  || $(CTAGS) $(CTAGSFLAGS) $(AM_CTAGSFLAGS) $(CTAGS_ARGS) \
+-	     $$unique
+-
+-GTAGS:
+-	here=`$(am__cd) $(top_builddir) && pwd` \
+-	  && $(am__cd) $(top_srcdir) \
+-	  && gtags -i $(GTAGS_ARGS) "$$here"
+-
+-distclean-tags:
+-	-rm -f TAGS ID GTAGS GRTAGS GSYMS GPATH tags
+-
+-distdir: $(DISTFILES)
+-	@srcdirstrip=`echo "$(srcdir)" | sed 's/[].[^$$\\*]/\\\\&/g'`; \
+-	topsrcdirstrip=`echo "$(top_srcdir)" | sed 's/[].[^$$\\*]/\\\\&/g'`; \
+-	list='$(DISTFILES)'; \
+-	  dist_files=`for file in $$list; do echo $$file; done | \
+-	  sed -e "s|^$$srcdirstrip/||;t" \
+-	      -e "s|^$$topsrcdirstrip/|$(top_builddir)/|;t"`; \
+-	case $$dist_files in \
+-	  */*) $(MKDIR_P) `echo "$$dist_files" | \
+-			   sed '/\//!d;s|^|$(distdir)/|;s,/[^/]*$$,,' | \
+-			   sort -u` ;; \
+-	esac; \
+-	for file in $$dist_files; do \
+-	  if test -f $$file || test -d $$file; then d=.; else d=$(srcdir); fi; \
+-	  if test -d $$d/$$file; then \
+-	    dir=`echo "/$$file" | sed -e 's,/[^/]*$$,,'`; \
+-	    if test -d "$(distdir)/$$file"; then \
+-	      find "$(distdir)/$$file" -type d ! -perm -700 -exec chmod u+rwx {} \;; \
+-	    fi; \
+-	    if test -d $(srcdir)/$$file && test $$d != $(srcdir); then \
+-	      cp -fpR $(srcdir)/$$file "$(distdir)$$dir" || exit 1; \
+-	      find "$(distdir)/$$file" -type d ! -perm -700 -exec chmod u+rwx {} \;; \
+-	    fi; \
+-	    cp -fpR $$d/$$file "$(distdir)$$dir" || exit 1; \
+-	  else \
+-	    test -f "$(distdir)/$$file" \
+-	    || cp -p $$d/$$file "$(distdir)/$$file" \
+-	    || exit 1; \
+-	  fi; \
+-	done
+-check-am: all-am
+-check: check-am
+-all-am: Makefile $(HEADERS)
+-installdirs:
+-install: install-am
+-install-exec: install-exec-am
+-install-data: install-data-am
+-uninstall: uninstall-am
+-
+-install-am: all-am
+-	@$(MAKE) $(AM_MAKEFLAGS) install-exec-am install-data-am
+-
+-installcheck: installcheck-am
+-install-strip:
+-	$(MAKE) $(AM_MAKEFLAGS) INSTALL_PROGRAM="$(INSTALL_STRIP_PROGRAM)" \
+-	  install_sh_PROGRAM="$(INSTALL_STRIP_PROGRAM)" INSTALL_STRIP_FLAG=-s \
+-	  `test -z '$(STRIP)' || \
+-	    echo "INSTALL_PROGRAM_ENV=STRIPPROG='$(STRIP)'"` install
+-mostlyclean-generic:
+-
+-clean-generic:
+-
+-distclean-generic:
+-	-test -z "$(CONFIG_CLEAN_FILES)" || rm -f $(CONFIG_CLEAN_FILES)
+-	-test . = "$(srcdir)" || test -z "$(CONFIG_CLEAN_VPATH_FILES)" || rm -f $(CONFIG_CLEAN_VPATH_FILES)
+-
+-maintainer-clean-generic:
+-	@echo "This command is intended for maintainers to use"
+-	@echo "it deletes files that may require special tools to rebuild."
+-clean: clean-am
+-
+-clean-am: clean-generic mostlyclean-am
+-
+-distclean: distclean-am
+-	-rm -f Makefile
+-distclean-am: clean-am distclean-generic distclean-tags
+-
+-dvi: dvi-am
+-
+-dvi-am:
+-
+-html: html-am
+-
+-html-am:
+-
+-info: info-am
+-
+-info-am:
+-
+-install-data-am:
+-
+-install-dvi: install-dvi-am
+-
+-install-dvi-am:
+-
+-install-exec-am:
+-
+-install-html: install-html-am
+-
+-install-html-am:
+-
+-install-info: install-info-am
+-
+-install-info-am:
+-
+-install-man:
+-
+-install-pdf: install-pdf-am
+-
+-install-pdf-am:
+-
+-install-ps: install-ps-am
+-
+-install-ps-am:
+-
+-installcheck-am:
+-
+-maintainer-clean: maintainer-clean-am
+-	-rm -f Makefile
+-maintainer-clean-am: distclean-am maintainer-clean-generic
+-
+-mostlyclean: mostlyclean-am
+-
+-mostlyclean-am: mostlyclean-generic
+-
+-pdf: pdf-am
+-
+-pdf-am:
+-
+-ps: ps-am
+-
+-ps-am:
+-
+-uninstall-am:
+-
+-.MAKE: install-am install-strip
+-
+-.PHONY: CTAGS GTAGS all all-am check check-am clean clean-generic \
+-	ctags distclean distclean-generic distclean-tags distdir dvi \
+-	dvi-am html html-am info info-am install install-am \
+-	install-data install-data-am install-dvi install-dvi-am \
+-	install-exec install-exec-am install-html install-html-am \
+-	install-info install-info-am install-man install-pdf \
+-	install-pdf-am install-ps install-ps-am install-strip \
+-	installcheck installcheck-am installdirs maintainer-clean \
+-	maintainer-clean-generic mostlyclean mostlyclean-generic pdf \
+-	pdf-am ps ps-am tags uninstall uninstall-am
+-
+-
+-# Tell versions [3.59,3.63) of GNU make to not export all variables.
+-# Otherwise a system limit (for SysV at least) may be exceeded.
+-.NOEXPORT:
+diff -Nur dosbox-0.74/include/mapper.h dosbox/include/mapper.h
+--- dosbox-0.74/include/mapper.h	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/include/mapper.h	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+  /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -21,7 +21,7 @@
+ 
+ enum MapKeys {
+ 	MK_f1,MK_f2,MK_f3,MK_f4,MK_f5,MK_f6,MK_f7,MK_f8,MK_f9,MK_f10,MK_f11,MK_f12,
+-	MK_return,MK_kpminus,MK_scrolllock,MK_printscreen,MK_pause
++	MK_return,MK_kpminus,MK_scrolllock,MK_printscreen,MK_pause,MK_home
+ 
+ };
+ 
+diff -Nur dosbox-0.74/include/mem.h dosbox/include/mem.h
+--- dosbox-0.74/include/mem.h	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/include/mem.h	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+diff -Nur dosbox-0.74/include/midi.h dosbox/include/midi.h
+--- dosbox-0.74/include/midi.h	1970-01-01 01:00:00.000000000 +0100
++++ dosbox/include/midi.h	2014-01-12 14:43:47.000000000 +0100
+@@ -0,0 +1,60 @@
++/*
++ *  Copyright (C) 2002-2013  The DOSBox Team
++ *
++ *  This program is free software; you can redistribute it and/or modify
++ *  it under the terms of the GNU General Public License as published by
++ *  the Free Software Foundation; either version 2 of the License, or
++ *  (at your option) any later version.
++ *
++ *  This program is distributed in the hope that it will be useful,
++ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
++ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
++ *  GNU General Public License for more details.
++ *
++ *  You should have received a copy of the GNU General Public License
++ *  along with this program; if not, write to the Free Software
++ *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
++ */
++
++
++#ifndef DOSBOX_MIDI_H
++#define DOSBOX_MIDI_H
++
++#ifndef DOSBOX_PROGRAMS_H
++#include "programs.h"
++#endif
++
++class MidiHandler {
++public:
++	MidiHandler();
++	virtual bool Open(const char * /*conf*/) { return true; };
++	virtual void Close(void) {};
++	virtual void PlayMsg(Bit8u * /*msg*/) {};
++	virtual void PlaySysex(Bit8u * /*sysex*/,Bitu /*len*/) {};
++	virtual const char * GetName(void) { return "none"; };
++	virtual void ListAll(Program * base) {};
++	virtual ~MidiHandler() { };
++	MidiHandler * next;
++};
++
++
++#define SYSEX_SIZE 1024
++struct DB_Midi {
++	Bitu status;
++	Bitu cmd_len;
++	Bitu cmd_pos;
++	Bit8u cmd_buf[8];
++	Bit8u rt_buf[8];
++	struct {
++		Bit8u buf[SYSEX_SIZE];
++		Bitu used;
++		Bitu delay;
++		Bit32u start;
++	} sysex;
++	bool available;
++	MidiHandler * handler;
++};
++
++extern DB_Midi midi;
++
++#endif
+diff -Nur dosbox-0.74/include/mixer.h dosbox/include/mixer.h
+--- dosbox-0.74/include/mixer.h	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/include/mixer.h	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,7 +16,6 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: mixer.h,v 1.19 2009-04-28 21:48:24 harekiet Exp $ */
+ 
+ #ifndef DOSBOX_MIXER_H
+ #define DOSBOX_MIXER_H
+diff -Nur dosbox-0.74/include/mouse.h dosbox/include/mouse.h
+--- dosbox-0.74/include/mouse.h	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/include/mouse.h	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,7 +16,6 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: mouse.h,v 1.15 2009-05-27 09:15:41 qbix79 Exp $ */
+ 
+ 
+ #ifndef DOSBOX_MOUSE_H
+diff -Nur dosbox-0.74/include/paging.h dosbox/include/paging.h
+--- dosbox-0.74/include/paging.h	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/include/paging.h	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,7 +16,6 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: paging.h,v 1.33 2009-05-27 09:15:41 qbix79 Exp $ */
+ 
+ #ifndef DOSBOX_PAGING_H
+ #define DOSBOX_PAGING_H
+diff -Nur dosbox-0.74/include/pci_bus.h dosbox/include/pci_bus.h
+--- dosbox-0.74/include/pci_bus.h	1970-01-01 01:00:00.000000000 +0100
++++ dosbox/include/pci_bus.h	2014-01-12 14:43:47.000000000 +0100
+@@ -0,0 +1,86 @@
++/*
++ *  Copyright (C) 2002-2013  The DOSBox Team
++ *
++ *  This program is free software; you can redistribute it and/or modify
++ *  it under the terms of the GNU General Public License as published by
++ *  the Free Software Foundation; either version 2 of the License, or
++ *  (at your option) any later version.
++ *
++ *  This program is distributed in the hope that it will be useful,
++ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
++ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
++ *  GNU General Public License for more details.
++ *
++ *  You should have received a copy of the GNU General Public License
++ *  along with this program; if not, write to the Free Software
++ *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
++ */
++
++#ifndef DOSBOX_PCI_H
++#define DOSBOX_PCI_H
++
++//#define PCI_FUNCTIONALITY_ENABLED 0
++
++#if defined PCI_FUNCTIONALITY_ENABLED
++
++#define PCI_MAX_PCIDEVICES		10
++#define PCI_MAX_PCIFUNCTIONS	8
++
++
++class PCI_Device {
++private:
++	Bits pci_id, pci_subfunction;
++	Bit16u vendor_id, device_id;
++
++	// subdevices declarations, they will respond to pci functions 1 to 7
++	// (main device is attached to function 0)
++	Bitu num_subdevices;
++	PCI_Device* subdevices[PCI_MAX_PCIFUNCTIONS-1];
++
++public:
++	PCI_Device(Bit16u vendor, Bit16u device);
++
++	Bits PCIId(void) {
++		return pci_id;
++	}
++	Bits PCISubfunction(void) {
++		return pci_subfunction;
++	}
++	Bit16u VendorID(void) {
++		return vendor_id;
++	}
++	Bit16u DeviceID(void) {
++		return device_id;
++	}
++
++	void SetPCIId(Bitu number, Bits subfct);
++
++	bool AddSubdevice(PCI_Device* dev);
++	void RemoveSubdevice(Bits subfct);
++
++	PCI_Device* GetSubdevice(Bits subfct);
++
++	Bit16u NumSubdevices(void) {
++		if (num_subdevices>PCI_MAX_PCIFUNCTIONS-1) return (Bit16u)(PCI_MAX_PCIFUNCTIONS-1);
++		return (Bit16u)num_subdevices;
++	}
++
++	Bits GetNextSubdeviceNumber(void) {
++		if (num_subdevices>=PCI_MAX_PCIFUNCTIONS-1) return -1;
++		return (Bits)num_subdevices+1;
++	}
++
++	virtual Bits ParseReadRegister(Bit8u regnum)=0;
++	virtual bool OverrideReadRegister(Bit8u regnum, Bit8u* rval, Bit8u* rval_mask)=0;
++	virtual Bits ParseWriteRegister(Bit8u regnum,Bit8u value)=0;
++	virtual bool InitializeRegisters(Bit8u registers[256])=0;
++
++};
++
++bool PCI_IsInitialized();
++
++RealPt PCI_GetPModeInterface(void);
++
++#endif
++
++#endif
+diff -Nur dosbox-0.74/include/pic.h dosbox/include/pic.h
+--- dosbox-0.74/include/pic.h	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/include/pic.h	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -29,11 +29,7 @@
+ typedef void (* PIC_EventHandler)(Bitu val);
+ 
+ 
+-#define PIC_MAXIRQ 15
+-#define PIC_NOIRQ 0xFF
+-
+ extern Bitu PIC_IRQCheck;
+-extern Bitu PIC_IRQActive;
+ extern Bitu PIC_Ticks;
+ 
+ static INLINE float PIC_TickIndex(void) {
+diff -Nur dosbox-0.74/include/programs.h dosbox/include/programs.h
+--- dosbox-0.74/include/programs.h	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/include/programs.h	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,7 +16,6 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: programs.h,v 1.19 2009-05-27 09:15:41 qbix79 Exp $ */
+ 
+ #ifndef DOSBOX_PROGRAMS_H
+ #define DOSBOX_PROGRAMS_H
+@@ -51,7 +50,10 @@
+ 	bool FindCommand(unsigned int which,std::string & value);
+ 	bool FindStringBegin(char const * const begin,std::string & value, bool remove=false);
+ 	bool FindStringRemain(char const * const name,std::string & value);
++	bool FindStringRemainBegin(char const * const name,std::string & value);
+ 	bool GetStringRemain(std::string & value);
++	int GetParameterFromList(const char* const params[], std::vector<std::string> & output);
++	void FillVector(std::vector<std::string> & vector);
+ 	unsigned int GetCount(void);
+ 	void Shift(unsigned int amount=1);
+ 	Bit16u Get_arglength();
+diff -Nur dosbox-0.74/include/regs.h dosbox/include/regs.h
+--- dosbox-0.74/include/regs.h	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/include/regs.h	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -41,7 +41,7 @@
+ #define FLAG_ID		0x00200000
+ 
+ #define FMASK_TEST		(FLAG_CF | FLAG_PF | FLAG_AF | FLAG_ZF | FLAG_SF | FLAG_OF)
+-#define FMASK_NORMAL	(FMASK_TEST | FLAG_DF | FLAG_TF | FLAG_IF | FLAG_AC )	
++#define FMASK_NORMAL	(FMASK_TEST | FLAG_DF | FLAG_TF | FLAG_IF )	
+ #define FMASK_ALL		(FMASK_NORMAL | FLAG_IOPL | FLAG_NT)
+ 
+ #define SETFLAGBIT(TYPE,TEST) if (TEST) reg_flags|=FLAG_ ## TYPE; else reg_flags&=~FLAG_ ## TYPE
+diff -Nur dosbox-0.74/include/render.h dosbox/include/render.h
+--- dosbox-0.74/include/render.h	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/include/render.h	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+diff -Nur dosbox-0.74/include/serialport.h dosbox/include/serialport.h
+--- dosbox-0.74/include/serialport.h	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/include/serialport.h	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,7 +16,6 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: serialport.h,v 1.18 2009-09-25 23:40:48 h-a-l-9000 Exp $ */
+ 
+ #ifndef DOSBOX_SERIALPORT_H
+ #define DOSBOX_SERIALPORT_H
+diff -Nur dosbox-0.74/include/setup.h dosbox/include/setup.h
+--- dosbox-0.74/include/setup.h	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/include/setup.h	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,7 +16,6 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: setup.h,v 1.41 2009-05-27 09:15:41 qbix79 Exp $ */
+ 
+ #ifndef DOSBOX_SETUP_H
+ #define DOSBOX_SETUP_H
+@@ -42,6 +41,11 @@
+ #include <string>
+ #endif
+ 
++#ifndef CH_CSTDIO
++#define CH_CSTDIO
++#include <cstdio>
++#endif
++
+ 
+ class Hex {
+ private:
+@@ -99,18 +103,18 @@
+ 	operator int () const throw(WrongType);
+ 	operator double () const throw(WrongType);
+ 	operator char const* () const throw(WrongType);
+-	void SetValue(std::string const& in,Etype _type = V_CURRENT) throw(WrongType);
++	bool SetValue(std::string const& in,Etype _type = V_CURRENT) throw(WrongType);
+ 	std::string ToString() const;
+ 
+ private:
+ 	void destroy() throw();
+ 	Value& copy(Value const& in) throw(WrongType);
+ 	void plaincopy(Value const& in) throw();
+-	void set_hex(std::string const& in);
+-	void set_int(std::string const&in);
+-	void set_bool(std::string const& in);
++	bool set_hex(std::string const& in);
++	bool set_int(std::string const&in);
++	bool set_bool(std::string const& in);
+ 	void set_string(std::string const& in);
+-	void set_double(std::string const& in);
++	bool set_double(std::string const& in);
+ };
+ 
+ class Property {
+@@ -122,7 +126,7 @@
+ 	void Set_values(const char * const * in);
+ 	void Set_help(std::string const& str);
+ 	char const* Get_help();
+-	virtual	void SetValue(std::string const& str)=0;
++	virtual	bool SetValue(std::string const& str)=0;
+ 	Value const& GetValue() const { return value;}
+ 	Value const& Get_Default_Value() const { return default_value; }
+ 	//CheckValue returns true  if value is in suggested_values;
+@@ -130,10 +134,12 @@
+ 	//specific features.
+ 	virtual bool CheckValue(Value const& in, bool warn);
+ 	//Set interval value to in or default if in is invalid. force always sets the value.
+-	void SetVal(Value const& in, bool forced,bool warn=true) {if(forced || CheckValue(in,warn)) value = in; else value = default_value;}
++	bool SetVal(Value const& in, bool forced,bool warn=true) {
++		if(forced || CheckValue(in,warn)) {value = in; return true;} else { value = default_value; return false;}}
+ 	virtual ~Property(){ } 
+ 	virtual const std::vector<Value>& GetValues() const;
+ 	Value::Etype Get_type(){return default_value.type;}
++	Changeable::Value getChange() {return change;}
+ 
+ protected:
+ 	Value value;
+@@ -156,8 +162,10 @@
+ 		min = _min;
+ 		max = _max;
+ 	}
++	int getMin() { return min;}
++	int getMax() { return max;}
+ 	void SetMinMax(Value const& min,Value const& max) {this->min = min; this->max=max;}
+-	void SetValue(std::string const& in);
++	bool SetValue(std::string const& in);
+ 	~Prop_int(){ }
+ 	virtual bool CheckValue(Value const& in, bool warn);
+ private:
+@@ -170,7 +178,7 @@
+ 		:Property(_propname,when){
+ 		default_value = value = _value;
+ 	}
+-	void SetValue(std::string const& input);
++	bool SetValue(std::string const& input);
+ 	~Prop_double(){ }
+ };
+ 
+@@ -180,7 +188,7 @@
+ 		:Property(_propname,when) { 
+ 		default_value = value = _value;
+ 	}
+-	void SetValue(std::string const& in);
++	bool SetValue(std::string const& in);
+ 	~Prop_bool(){ }
+ };
+ 
+@@ -190,7 +198,7 @@
+ 		:Property(_propname,when) { 
+ 		default_value = value = _value;
+ 	}
+-	void SetValue(std::string const& in);
++	bool SetValue(std::string const& in);
+ 	virtual bool CheckValue(Value const& in, bool warn);
+ 	~Prop_string(){ }
+ };
+@@ -202,7 +210,7 @@
+ 		default_value = value = _value;
+ 		realpath = _value;
+ 	}
+-	void SetValue(std::string const& in);
++	bool SetValue(std::string const& in);
+ 	~Prop_path(){ }
+ };
+ 
+@@ -212,7 +220,7 @@
+ 		:Property(_propname,when) { 
+ 		default_value = value = _value;
+ 	}
+-	void SetValue(std::string const& in);
++	bool SetValue(std::string const& in);
+ 	~Prop_hex(){ }
+ };
+ 
+@@ -243,7 +251,7 @@
+ 	const char* GetName() const {return sectionname.c_str();}
+ 
+ 	virtual std::string GetPropValue(std::string const& _property) const =0;
+-	virtual void HandleInputline(std::string const& _line)=0;
++	virtual bool HandleInputline(std::string const& _line)=0;
+ 	virtual void PrintData(FILE* outfile) const =0;
+ 	virtual ~Section() { /*Children must call executedestroy ! */}
+ };
+@@ -276,7 +284,7 @@
+ 	Prop_path* Get_path(std::string const& _propname) const;
+ 	Prop_multival* Get_multival(std::string const& _propname) const;
+ 	Prop_multival_remain* Get_multivalremain(std::string const& _propname) const;
+-	void HandleInputline(std::string const& gegevens);
++	bool HandleInputline(std::string const& gegevens);
+ 	void PrintData(FILE* outfile) const;
+ 	virtual std::string GetPropValue(std::string const& _property) const;
+ 	//ExecuteDestroy should be here else the destroy functions use destroyed properties
+@@ -294,7 +302,7 @@
+ 	}
+ 	Section_prop *GetSection() { return section; }
+ 	const Section_prop *GetSection() const { return section; }
+-	virtual void SetValue(std::string const& input);
++	virtual bool SetValue(std::string const& input);
+ 	virtual const std::vector<Value>& GetValues() const;
+ 	~Prop_multival() { delete section; }
+ }; //value bevat totale string. setvalue zet elk van de sub properties en checked die.
+@@ -303,7 +311,7 @@
+ public:
+ 	Prop_multival_remain(std::string const& _propname, Changeable::Value when,std::string const& sep):Prop_multival(_propname,when,sep){ }
+ 
+-	virtual void SetValue(std::string const& input);
++	virtual bool SetValue(std::string const& input);
+ };
+ 
+    
+@@ -311,7 +319,7 @@
+ public:
+ 	Section_line(std::string const& _sectionname):Section(_sectionname){}
+ 	~Section_line(){ExecuteDestroy(true);}
+-	void HandleInputline(std::string const& gegevens);
++	bool HandleInputline(std::string const& gegevens);
+ 	void PrintData(FILE* outfile) const;
+ 	virtual std::string GetPropValue(std::string const& _property) const;
+ 	std::string data;
+diff -Nur dosbox-0.74/include/shell.h dosbox/include/shell.h
+--- dosbox-0.74/include/shell.h	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/include/shell.h	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,7 +16,6 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: shell.h,v 1.28 2009-07-03 19:36:57 qbix79 Exp $ */
+ 
+ #ifndef DOSBOX_SHELL_H
+ #define DOSBOX_SHELL_H
+@@ -88,6 +87,8 @@
+ 	void CMD_HELP(char * args);
+ 	void CMD_CLS(char * args);
+ 	void CMD_COPY(char * args);
++	void CMD_DATE(char * args);
++	void CMD_TIME(char * args);
+ 	void CMD_DIR(char * args);
+ 	void CMD_DELETE(char * args);
+ 	void CMD_ECHO(char * args);
+diff -Nur dosbox-0.74/include/support.h dosbox/include/support.h
+--- dosbox-0.74/include/support.h	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/include/support.h	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,7 +16,6 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: support.h,v 1.18 2009-05-27 09:15:41 qbix79 Exp $ */
+ 
+ #ifndef DOSBOX_SUPPORT_H
+ #define DOSBOX_SUPPORT_H
+diff -Nur dosbox-0.74/include/timer.h dosbox/include/timer.h
+--- dosbox-0.74/include/timer.h	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/include/timer.h	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+diff -Nur dosbox-0.74/include/vga.h dosbox/include/vga.h
+--- dosbox-0.74/include/vga.h	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/include/vga.h	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+  /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,7 +16,6 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: vga.h,v 1.48 2009-11-03 21:06:59 h-a-l-9000 Exp $ */
+ 
+ #ifndef DOSBOX_VGA_H
+ #define DOSBOX_VGA_H
+@@ -114,7 +113,7 @@
+ typedef enum {
+ 	PART,
+ 	LINE,
+-	//EGALINE
++	EGALINE
+ } Drawmode;
+ 
+ typedef struct {
+@@ -157,6 +156,8 @@
+ 	Bit8u font[64*1024];
+ 	Bit8u * font_tables[2];
+ 	Bitu blinking;
++	bool blink;
++	bool char9dot;
+ 	struct {
+ 		Bitu address;
+ 		Bit8u sline,eline;
+@@ -165,14 +166,15 @@
+ 	} cursor;
+ 	Drawmode mode;
+ 	bool vret_triggered;
++	bool vga_override;
+ } VGA_Draw;
+ 
+ typedef struct {
+ 	Bit8u curmode;
+ 	Bit16u originx, originy;
+ 	Bit8u fstackpos, bstackpos;
+-	Bit8u forestack[3];
+-	Bit8u backstack[3];
++	Bit8u forestack[4];
++	Bit8u backstack[4];
+ 	Bit16u startaddr;
+ 	Bit8u posx, posy;
+ 	Bit8u mc[64][64];
+@@ -425,6 +427,10 @@
+ void VGA_DAC_SetEntry(Bitu entry,Bit8u red,Bit8u green,Bit8u blue);
+ void VGA_ATTR_SetPalette(Bit8u index,Bit8u val);
+ 
++typedef enum {CGA, EGA, MONO} EGAMonitorMode;
++
++void VGA_ATTR_SetEGAMonitorPalette(EGAMonitorMode m);
++
+ /* The VGA Subfunction startups */
+ void VGA_SetupAttr(void);
+ void VGA_SetupMemory(Section* sec);
+@@ -447,6 +453,8 @@
+ void VGA_ActivateHardwareCursor(void);
+ void VGA_KillDrawing(void);
+ 
++void VGA_SetOverride(bool vga_override);
++
+ extern VGA_Type vga;
+ 
+ /* Support for modular SVGA implementation */
+diff -Nur dosbox-0.74/include/video.h dosbox/include/video.h
+--- dosbox-0.74/include/video.h	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/include/video.h	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,7 +16,6 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: video.h,v 1.26 2009-05-27 09:15:41 qbix79 Exp $ */
+ 
+ #ifndef DOSBOX_VIDEO_H
+ #define DOSBOX_VIDEO_H
+diff -Nur dosbox-0.74/INSTALL dosbox/INSTALL
+--- dosbox-0.74/INSTALL	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/INSTALL	2014-01-12 14:43:47.000000000 +0100
+@@ -43,11 +43,11 @@
+     for Alsa support under linux. Part of the linux kernel sources
+     Licensed under LGPL
+ 
+-If you want compile from the CVS under a unix system, you'll also need 
++If you want compile from developer sources (SVN) under a unix system, you'll also need 
+ automake (>=1.6), autoconf(>=2.50). Should be available at http://www.gnu.org
+ 
+ For building on unix systems.
+-If you are building from the cvs run ./autogen.sh first before doing the following.
++If you are building from developer sources run ./autogen.sh first before doing the following.
+ 
+ 1. ./configure
+ 2. make
+@@ -101,4 +101,4 @@
+ 
+ Build instructions for VC++6 
+ Don't use VC++ 6: it creates faulty code in core_normal.cpp
+-Later Visual Studio versions work fine (vs2003/.net, vs2005, vs2008)
++Later Visual Studio versions work fine (vs2003/.net up to vs2010)
+diff -Nur dosbox-0.74/install-sh dosbox/install-sh
+--- dosbox-0.74/install-sh	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/install-sh	1970-01-01 01:00:00.000000000 +0100
+@@ -1,520 +0,0 @@
+-#!/bin/sh
+-# install - install a program, script, or datafile
+-
+-scriptversion=2009-04-28.21; # UTC
+-
+-# This originates from X11R5 (mit/util/scripts/install.sh), which was
+-# later released in X11R6 (xc/config/util/install.sh) with the
+-# following copyright and license.
+-#
+-# Copyright (C) 1994 X Consortium
+-#
+-# Permission is hereby granted, free of charge, to any person obtaining a copy
+-# of this software and associated documentation files (the "Software"), to
+-# deal in the Software without restriction, including without limitation the
+-# rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
+-# sell copies of the Software, and to permit persons to whom the Software is
+-# furnished to do so, subject to the following conditions:
+-#
+-# The above copyright notice and this permission notice shall be included in
+-# all copies or substantial portions of the Software.
+-#
+-# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
+-# IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
+-# FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL THE
+-# X CONSORTIUM BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN
+-# AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNEC-
+-# TION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
+-#
+-# Except as contained in this notice, the name of the X Consortium shall not
+-# be used in advertising or otherwise to promote the sale, use or other deal-
+-# ings in this Software without prior written authorization from the X Consor-
+-# tium.
+-#
+-#
+-# FSF changes to this file are in the public domain.
+-#
+-# Calling this script install-sh is preferred over install.sh, to prevent
+-# `make' implicit rules from creating a file called install from it
+-# when there is no Makefile.
+-#
+-# This script is compatible with the BSD install script, but was written
+-# from scratch.
+-
+-nl='
+-'
+-IFS=" ""	$nl"
+-
+-# set DOITPROG to echo to test this script
+-
+-# Don't use :- since 4.3BSD and earlier shells don't like it.
+-doit=${DOITPROG-}
+-if test -z "$doit"; then
+-  doit_exec=exec
+-else
+-  doit_exec=$doit
+-fi
+-
+-# Put in absolute file names if you don't have them in your path;
+-# or use environment vars.
+-
+-chgrpprog=${CHGRPPROG-chgrp}
+-chmodprog=${CHMODPROG-chmod}
+-chownprog=${CHOWNPROG-chown}
+-cmpprog=${CMPPROG-cmp}
+-cpprog=${CPPROG-cp}
+-mkdirprog=${MKDIRPROG-mkdir}
+-mvprog=${MVPROG-mv}
+-rmprog=${RMPROG-rm}
+-stripprog=${STRIPPROG-strip}
+-
+-posix_glob='?'
+-initialize_posix_glob='
+-  test "$posix_glob" != "?" || {
+-    if (set -f) 2>/dev/null; then
+-      posix_glob=
+-    else
+-      posix_glob=:
+-    fi
+-  }
+-'
+-
+-posix_mkdir=
+-
+-# Desired mode of installed file.
+-mode=0755
+-
+-chgrpcmd=
+-chmodcmd=$chmodprog
+-chowncmd=
+-mvcmd=$mvprog
+-rmcmd="$rmprog -f"
+-stripcmd=
+-
+-src=
+-dst=
+-dir_arg=
+-dst_arg=
+-
+-copy_on_change=false
+-no_target_directory=
+-
+-usage="\
+-Usage: $0 [OPTION]... [-T] SRCFILE DSTFILE
+-   or: $0 [OPTION]... SRCFILES... DIRECTORY
+-   or: $0 [OPTION]... -t DIRECTORY SRCFILES...
+-   or: $0 [OPTION]... -d DIRECTORIES...
+-
+-In the 1st form, copy SRCFILE to DSTFILE.
+-In the 2nd and 3rd, copy all SRCFILES to DIRECTORY.
+-In the 4th, create DIRECTORIES.
+-
+-Options:
+-     --help     display this help and exit.
+-     --version  display version info and exit.
+-
+-  -c            (ignored)
+-  -C            install only if different (preserve the last data modification time)
+-  -d            create directories instead of installing files.
+-  -g GROUP      $chgrpprog installed files to GROUP.
+-  -m MODE       $chmodprog installed files to MODE.
+-  -o USER       $chownprog installed files to USER.
+-  -s            $stripprog installed files.
+-  -t DIRECTORY  install into DIRECTORY.
+-  -T            report an error if DSTFILE is a directory.
+-
+-Environment variables override the default commands:
+-  CHGRPPROG CHMODPROG CHOWNPROG CMPPROG CPPROG MKDIRPROG MVPROG
+-  RMPROG STRIPPROG
+-"
+-
+-while test $# -ne 0; do
+-  case $1 in
+-    -c) ;;
+-
+-    -C) copy_on_change=true;;
+-
+-    -d) dir_arg=true;;
+-
+-    -g) chgrpcmd="$chgrpprog $2"
+-	shift;;
+-
+-    --help) echo "$usage"; exit $?;;
+-
+-    -m) mode=$2
+-	case $mode in
+-	  *' '* | *'	'* | *'
+-'*	  | *'*'* | *'?'* | *'['*)
+-	    echo "$0: invalid mode: $mode" >&2
+-	    exit 1;;
+-	esac
+-	shift;;
+-
+-    -o) chowncmd="$chownprog $2"
+-	shift;;
+-
+-    -s) stripcmd=$stripprog;;
+-
+-    -t) dst_arg=$2
+-	shift;;
+-
+-    -T) no_target_directory=true;;
+-
+-    --version) echo "$0 $scriptversion"; exit $?;;
+-
+-    --)	shift
+-	break;;
+-
+-    -*)	echo "$0: invalid option: $1" >&2
+-	exit 1;;
+-
+-    *)  break;;
+-  esac
+-  shift
+-done
+-
+-if test $# -ne 0 && test -z "$dir_arg$dst_arg"; then
+-  # When -d is used, all remaining arguments are directories to create.
+-  # When -t is used, the destination is already specified.
+-  # Otherwise, the last argument is the destination.  Remove it from $@.
+-  for arg
+-  do
+-    if test -n "$dst_arg"; then
+-      # $@ is not empty: it contains at least $arg.
+-      set fnord "$@" "$dst_arg"
+-      shift # fnord
+-    fi
+-    shift # arg
+-    dst_arg=$arg
+-  done
+-fi
+-
+-if test $# -eq 0; then
+-  if test -z "$dir_arg"; then
+-    echo "$0: no input file specified." >&2
+-    exit 1
+-  fi
+-  # It's OK to call `install-sh -d' without argument.
+-  # This can happen when creating conditional directories.
+-  exit 0
+-fi
+-
+-if test -z "$dir_arg"; then
+-  trap '(exit $?); exit' 1 2 13 15
+-
+-  # Set umask so as not to create temps with too-generous modes.
+-  # However, 'strip' requires both read and write access to temps.
+-  case $mode in
+-    # Optimize common cases.
+-    *644) cp_umask=133;;
+-    *755) cp_umask=22;;
+-
+-    *[0-7])
+-      if test -z "$stripcmd"; then
+-	u_plus_rw=
+-      else
+-	u_plus_rw='% 200'
+-      fi
+-      cp_umask=`expr '(' 777 - $mode % 1000 ')' $u_plus_rw`;;
+-    *)
+-      if test -z "$stripcmd"; then
+-	u_plus_rw=
+-      else
+-	u_plus_rw=,u+rw
+-      fi
+-      cp_umask=$mode$u_plus_rw;;
+-  esac
+-fi
+-
+-for src
+-do
+-  # Protect names starting with `-'.
+-  case $src in
+-    -*) src=./$src;;
+-  esac
+-
+-  if test -n "$dir_arg"; then
+-    dst=$src
+-    dstdir=$dst
+-    test -d "$dstdir"
+-    dstdir_status=$?
+-  else
+-
+-    # Waiting for this to be detected by the "$cpprog $src $dsttmp" command
+-    # might cause directories to be created, which would be especially bad
+-    # if $src (and thus $dsttmp) contains '*'.
+-    if test ! -f "$src" && test ! -d "$src"; then
+-      echo "$0: $src does not exist." >&2
+-      exit 1
+-    fi
+-
+-    if test -z "$dst_arg"; then
+-      echo "$0: no destination specified." >&2
+-      exit 1
+-    fi
+-
+-    dst=$dst_arg
+-    # Protect names starting with `-'.
+-    case $dst in
+-      -*) dst=./$dst;;
+-    esac
+-
+-    # If destination is a directory, append the input filename; won't work
+-    # if double slashes aren't ignored.
+-    if test -d "$dst"; then
+-      if test -n "$no_target_directory"; then
+-	echo "$0: $dst_arg: Is a directory" >&2
+-	exit 1
+-      fi
+-      dstdir=$dst
+-      dst=$dstdir/`basename "$src"`
+-      dstdir_status=0
+-    else
+-      # Prefer dirname, but fall back on a substitute if dirname fails.
+-      dstdir=`
+-	(dirname "$dst") 2>/dev/null ||
+-	expr X"$dst" : 'X\(.*[^/]\)//*[^/][^/]*/*$' \| \
+-	     X"$dst" : 'X\(//\)[^/]' \| \
+-	     X"$dst" : 'X\(//\)$' \| \
+-	     X"$dst" : 'X\(/\)' \| . 2>/dev/null ||
+-	echo X"$dst" |
+-	    sed '/^X\(.*[^/]\)\/\/*[^/][^/]*\/*$/{
+-		   s//\1/
+-		   q
+-		 }
+-		 /^X\(\/\/\)[^/].*/{
+-		   s//\1/
+-		   q
+-		 }
+-		 /^X\(\/\/\)$/{
+-		   s//\1/
+-		   q
+-		 }
+-		 /^X\(\/\).*/{
+-		   s//\1/
+-		   q
+-		 }
+-		 s/.*/./; q'
+-      `
+-
+-      test -d "$dstdir"
+-      dstdir_status=$?
+-    fi
+-  fi
+-
+-  obsolete_mkdir_used=false
+-
+-  if test $dstdir_status != 0; then
+-    case $posix_mkdir in
+-      '')
+-	# Create intermediate dirs using mode 755 as modified by the umask.
+-	# This is like FreeBSD 'install' as of 1997-10-28.
+-	umask=`umask`
+-	case $stripcmd.$umask in
+-	  # Optimize common cases.
+-	  *[2367][2367]) mkdir_umask=$umask;;
+-	  .*0[02][02] | .[02][02] | .[02]) mkdir_umask=22;;
+-
+-	  *[0-7])
+-	    mkdir_umask=`expr $umask + 22 \
+-	      - $umask % 100 % 40 + $umask % 20 \
+-	      - $umask % 10 % 4 + $umask % 2
+-	    `;;
+-	  *) mkdir_umask=$umask,go-w;;
+-	esac
+-
+-	# With -d, create the new directory with the user-specified mode.
+-	# Otherwise, rely on $mkdir_umask.
+-	if test -n "$dir_arg"; then
+-	  mkdir_mode=-m$mode
+-	else
+-	  mkdir_mode=
+-	fi
+-
+-	posix_mkdir=false
+-	case $umask in
+-	  *[123567][0-7][0-7])
+-	    # POSIX mkdir -p sets u+wx bits regardless of umask, which
+-	    # is incompatible with FreeBSD 'install' when (umask & 300) != 0.
+-	    ;;
+-	  *)
+-	    tmpdir=${TMPDIR-/tmp}/ins$RANDOM-$$
+-	    trap 'ret=$?; rmdir "$tmpdir/d" "$tmpdir" 2>/dev/null; exit $ret' 0
+-
+-	    if (umask $mkdir_umask &&
+-		exec $mkdirprog $mkdir_mode -p -- "$tmpdir/d") >/dev/null 2>&1
+-	    then
+-	      if test -z "$dir_arg" || {
+-		   # Check for POSIX incompatibilities with -m.
+-		   # HP-UX 11.23 and IRIX 6.5 mkdir -m -p sets group- or
+-		   # other-writeable bit of parent directory when it shouldn't.
+-		   # FreeBSD 6.1 mkdir -m -p sets mode of existing directory.
+-		   ls_ld_tmpdir=`ls -ld "$tmpdir"`
+-		   case $ls_ld_tmpdir in
+-		     d????-?r-*) different_mode=700;;
+-		     d????-?--*) different_mode=755;;
+-		     *) false;;
+-		   esac &&
+-		   $mkdirprog -m$different_mode -p -- "$tmpdir" && {
+-		     ls_ld_tmpdir_1=`ls -ld "$tmpdir"`
+-		     test "$ls_ld_tmpdir" = "$ls_ld_tmpdir_1"
+-		   }
+-		 }
+-	      then posix_mkdir=:
+-	      fi
+-	      rmdir "$tmpdir/d" "$tmpdir"
+-	    else
+-	      # Remove any dirs left behind by ancient mkdir implementations.
+-	      rmdir ./$mkdir_mode ./-p ./-- 2>/dev/null
+-	    fi
+-	    trap '' 0;;
+-	esac;;
+-    esac
+-
+-    if
+-      $posix_mkdir && (
+-	umask $mkdir_umask &&
+-	$doit_exec $mkdirprog $mkdir_mode -p -- "$dstdir"
+-      )
+-    then :
+-    else
+-
+-      # The umask is ridiculous, or mkdir does not conform to POSIX,
+-      # or it failed possibly due to a race condition.  Create the
+-      # directory the slow way, step by step, checking for races as we go.
+-
+-      case $dstdir in
+-	/*) prefix='/';;
+-	-*) prefix='./';;
+-	*)  prefix='';;
+-      esac
+-
+-      eval "$initialize_posix_glob"
+-
+-      oIFS=$IFS
+-      IFS=/
+-      $posix_glob set -f
+-      set fnord $dstdir
+-      shift
+-      $posix_glob set +f
+-      IFS=$oIFS
+-
+-      prefixes=
+-
+-      for d
+-      do
+-	test -z "$d" && continue
+-
+-	prefix=$prefix$d
+-	if test -d "$prefix"; then
+-	  prefixes=
+-	else
+-	  if $posix_mkdir; then
+-	    (umask=$mkdir_umask &&
+-	     $doit_exec $mkdirprog $mkdir_mode -p -- "$dstdir") && break
+-	    # Don't fail if two instances are running concurrently.
+-	    test -d "$prefix" || exit 1
+-	  else
+-	    case $prefix in
+-	      *\'*) qprefix=`echo "$prefix" | sed "s/'/'\\\\\\\\''/g"`;;
+-	      *) qprefix=$prefix;;
+-	    esac
+-	    prefixes="$prefixes '$qprefix'"
+-	  fi
+-	fi
+-	prefix=$prefix/
+-      done
+-
+-      if test -n "$prefixes"; then
+-	# Don't fail if two instances are running concurrently.
+-	(umask $mkdir_umask &&
+-	 eval "\$doit_exec \$mkdirprog $prefixes") ||
+-	  test -d "$dstdir" || exit 1
+-	obsolete_mkdir_used=true
+-      fi
+-    fi
+-  fi
+-
+-  if test -n "$dir_arg"; then
+-    { test -z "$chowncmd" || $doit $chowncmd "$dst"; } &&
+-    { test -z "$chgrpcmd" || $doit $chgrpcmd "$dst"; } &&
+-    { test "$obsolete_mkdir_used$chowncmd$chgrpcmd" = false ||
+-      test -z "$chmodcmd" || $doit $chmodcmd $mode "$dst"; } || exit 1
+-  else
+-
+-    # Make a couple of temp file names in the proper directory.
+-    dsttmp=$dstdir/_inst.$$_
+-    rmtmp=$dstdir/_rm.$$_
+-
+-    # Trap to clean up those temp files at exit.
+-    trap 'ret=$?; rm -f "$dsttmp" "$rmtmp" && exit $ret' 0
+-
+-    # Copy the file name to the temp name.
+-    (umask $cp_umask && $doit_exec $cpprog "$src" "$dsttmp") &&
+-
+-    # and set any options; do chmod last to preserve setuid bits.
+-    #
+-    # If any of these fail, we abort the whole thing.  If we want to
+-    # ignore errors from any of these, just make sure not to ignore
+-    # errors from the above "$doit $cpprog $src $dsttmp" command.
+-    #
+-    { test -z "$chowncmd" || $doit $chowncmd "$dsttmp"; } &&
+-    { test -z "$chgrpcmd" || $doit $chgrpcmd "$dsttmp"; } &&
+-    { test -z "$stripcmd" || $doit $stripcmd "$dsttmp"; } &&
+-    { test -z "$chmodcmd" || $doit $chmodcmd $mode "$dsttmp"; } &&
+-
+-    # If -C, don't bother to copy if it wouldn't change the file.
+-    if $copy_on_change &&
+-       old=`LC_ALL=C ls -dlL "$dst"	2>/dev/null` &&
+-       new=`LC_ALL=C ls -dlL "$dsttmp"	2>/dev/null` &&
+-
+-       eval "$initialize_posix_glob" &&
+-       $posix_glob set -f &&
+-       set X $old && old=:$2:$4:$5:$6 &&
+-       set X $new && new=:$2:$4:$5:$6 &&
+-       $posix_glob set +f &&
+-
+-       test "$old" = "$new" &&
+-       $cmpprog "$dst" "$dsttmp" >/dev/null 2>&1
+-    then
+-      rm -f "$dsttmp"
+-    else
+-      # Rename the file to the real destination.
+-      $doit $mvcmd -f "$dsttmp" "$dst" 2>/dev/null ||
+-
+-      # The rename failed, perhaps because mv can't rename something else
+-      # to itself, or perhaps because mv is so ancient that it does not
+-      # support -f.
+-      {
+-	# Now remove or move aside any old file at destination location.
+-	# We try this two ways since rm can't unlink itself on some
+-	# systems and the destination file might be busy for other
+-	# reasons.  In this case, the final cleanup might fail but the new
+-	# file should still install successfully.
+-	{
+-	  test ! -f "$dst" ||
+-	  $doit $rmcmd -f "$dst" 2>/dev/null ||
+-	  { $doit $mvcmd -f "$dst" "$rmtmp" 2>/dev/null &&
+-	    { $doit $rmcmd -f "$rmtmp" 2>/dev/null; :; }
+-	  } ||
+-	  { echo "$0: cannot unlink or rename $dst" >&2
+-	    (exit 1); exit 1
+-	  }
+-	} &&
+-
+-	# Now rename the file to the real destination.
+-	$doit $mvcmd "$dsttmp" "$dst"
+-      }
+-    fi || exit 1
+-
+-    trap '' 0
+-  fi
+-done
+-
+-# Local variables:
+-# eval: (add-hook 'write-file-hooks 'time-stamp)
+-# time-stamp-start: "scriptversion="
+-# time-stamp-format: "%:y-%02m-%02d.%02H"
+-# time-stamp-time-zone: "UTC"
+-# time-stamp-end: "; # UTC"
+-# End:
+diff -Nur dosbox-0.74/Makefile.in dosbox/Makefile.in
+--- dosbox-0.74/Makefile.in	2010-05-12 11:57:44.000000000 +0200
++++ dosbox/Makefile.in	1970-01-01 01:00:00.000000000 +0100
+@@ -1,700 +0,0 @@
+-# Makefile.in generated by automake 1.11.1 from Makefile.am.
+-# @configure_input@
+-
+-# Copyright (C) 1994, 1995, 1996, 1997, 1998, 1999, 2000, 2001, 2002,
+-# 2003, 2004, 2005, 2006, 2007, 2008, 2009  Free Software Foundation,
+-# Inc.
+-# This Makefile.in is free software; the Free Software Foundation
+-# gives unlimited permission to copy and/or distribute it,
+-# with or without modifications, as long as this notice is preserved.
+-
+-# This program is distributed in the hope that it will be useful,
+-# but WITHOUT ANY WARRANTY, to the extent permitted by law; without
+-# even the implied warranty of MERCHANTABILITY or FITNESS FOR A
+-# PARTICULAR PURPOSE.
+-
+-@SET_MAKE@
+-
+-# Main Makefile for DOSBox
+-VPATH = @srcdir@
+-pkgdatadir = $(datadir)/@PACKAGE@
+-pkgincludedir = $(includedir)/@PACKAGE@
+-pkglibdir = $(libdir)/@PACKAGE@
+-pkglibexecdir = $(libexecdir)/@PACKAGE@
+-am__cd = CDPATH="$${ZSH_VERSION+.}$(PATH_SEPARATOR)" && cd
+-install_sh_DATA = $(install_sh) -c -m 644
+-install_sh_PROGRAM = $(install_sh) -c
+-install_sh_SCRIPT = $(install_sh) -c
+-INSTALL_HEADER = $(INSTALL_DATA)
+-transform = $(program_transform_name)
+-NORMAL_INSTALL = :
+-PRE_INSTALL = :
+-POST_INSTALL = :
+-NORMAL_UNINSTALL = :
+-PRE_UNINSTALL = :
+-POST_UNINSTALL = :
+-build_triplet = @build@
+-host_triplet = @host@
+-subdir = .
+-DIST_COMMON = README $(am__configure_deps) $(srcdir)/Makefile.am \
+-	$(srcdir)/Makefile.in $(srcdir)/config.h.in \
+-	$(top_srcdir)/configure AUTHORS COPYING ChangeLog INSTALL NEWS \
+-	THANKS config.guess config.sub depcomp install-sh missing
+-ACLOCAL_M4 = $(top_srcdir)/aclocal.m4
+-am__aclocal_m4_deps = $(top_srcdir)/acinclude.m4 \
+-	$(top_srcdir)/configure.in
+-am__configure_deps = $(am__aclocal_m4_deps) $(CONFIGURE_DEPENDENCIES) \
+-	$(ACLOCAL_M4)
+-am__CONFIG_DISTCLEAN_FILES = config.status config.cache config.log \
+- configure.lineno config.status.lineno
+-mkinstalldirs = $(install_sh) -d
+-CONFIG_HEADER = config.h
+-CONFIG_CLEAN_FILES =
+-CONFIG_CLEAN_VPATH_FILES =
+-SOURCES =
+-DIST_SOURCES =
+-RECURSIVE_TARGETS = all-recursive check-recursive dvi-recursive \
+-	html-recursive info-recursive install-data-recursive \
+-	install-dvi-recursive install-exec-recursive \
+-	install-html-recursive install-info-recursive \
+-	install-pdf-recursive install-ps-recursive install-recursive \
+-	installcheck-recursive installdirs-recursive pdf-recursive \
+-	ps-recursive uninstall-recursive
+-RECURSIVE_CLEAN_TARGETS = mostlyclean-recursive clean-recursive	\
+-  distclean-recursive maintainer-clean-recursive
+-AM_RECURSIVE_TARGETS = $(RECURSIVE_TARGETS:-recursive=) \
+-	$(RECURSIVE_CLEAN_TARGETS:-recursive=) tags TAGS ctags CTAGS \
+-	distdir dist dist-all distcheck
+-ETAGS = etags
+-CTAGS = ctags
+-DIST_SUBDIRS = $(SUBDIRS)
+-DISTFILES = $(DIST_COMMON) $(DIST_SOURCES) $(TEXINFOS) $(EXTRA_DIST)
+-distdir = $(PACKAGE)-$(VERSION)
+-top_distdir = $(distdir)
+-am__remove_distdir = \
+-  { test ! -d "$(distdir)" \
+-    || { find "$(distdir)" -type d ! -perm -200 -exec chmod u+w {} ';' \
+-         && rm -fr "$(distdir)"; }; }
+-am__relativize = \
+-  dir0=`pwd`; \
+-  sed_first='s,^\([^/]*\)/.*$$,\1,'; \
+-  sed_rest='s,^[^/]*/*,,'; \
+-  sed_last='s,^.*/\([^/]*\)$$,\1,'; \
+-  sed_butlast='s,/*[^/]*$$,,'; \
+-  while test -n "$$dir1"; do \
+-    first=`echo "$$dir1" | sed -e "$$sed_first"`; \
+-    if test "$$first" != "."; then \
+-      if test "$$first" = ".."; then \
+-        dir2=`echo "$$dir0" | sed -e "$$sed_last"`/"$$dir2"; \
+-        dir0=`echo "$$dir0" | sed -e "$$sed_butlast"`; \
+-      else \
+-        first2=`echo "$$dir2" | sed -e "$$sed_first"`; \
+-        if test "$$first2" = "$$first"; then \
+-          dir2=`echo "$$dir2" | sed -e "$$sed_rest"`; \
+-        else \
+-          dir2="../$$dir2"; \
+-        fi; \
+-        dir0="$$dir0"/"$$first"; \
+-      fi; \
+-    fi; \
+-    dir1=`echo "$$dir1" | sed -e "$$sed_rest"`; \
+-  done; \
+-  reldir="$$dir2"
+-DIST_ARCHIVES = $(distdir).tar.gz
+-GZIP_ENV = --best
+-distuninstallcheck_listfiles = find . -type f -print
+-distcleancheck_listfiles = find . -type f -print
+-ACLOCAL = @ACLOCAL@
+-ALSA_CFLAGS = @ALSA_CFLAGS@
+-ALSA_LIBS = @ALSA_LIBS@
+-AMTAR = @AMTAR@
+-AUTOCONF = @AUTOCONF@
+-AUTOHEADER = @AUTOHEADER@
+-AUTOMAKE = @AUTOMAKE@
+-AWK = @AWK@
+-CC = @CC@
+-CCDEPMODE = @CCDEPMODE@
+-CFLAGS = @CFLAGS@
+-CPP = @CPP@
+-CPPFLAGS = @CPPFLAGS@
+-CXX = @CXX@
+-CXXDEPMODE = @CXXDEPMODE@
+-CXXFLAGS = @CXXFLAGS@
+-CYGPATH_W = @CYGPATH_W@
+-DEFS = @DEFS@
+-DEPDIR = @DEPDIR@
+-ECHO_C = @ECHO_C@
+-ECHO_N = @ECHO_N@
+-ECHO_T = @ECHO_T@
+-EGREP = @EGREP@
+-EXEEXT = @EXEEXT@
+-GREP = @GREP@
+-INSTALL = @INSTALL@
+-INSTALL_DATA = @INSTALL_DATA@
+-INSTALL_PROGRAM = @INSTALL_PROGRAM@
+-INSTALL_SCRIPT = @INSTALL_SCRIPT@
+-INSTALL_STRIP_PROGRAM = @INSTALL_STRIP_PROGRAM@
+-LDFLAGS = @LDFLAGS@
+-LIBOBJS = @LIBOBJS@
+-LIBS = @LIBS@
+-LTLIBOBJS = @LTLIBOBJS@
+-MAKEINFO = @MAKEINFO@
+-MKDIR_P = @MKDIR_P@
+-OBJEXT = @OBJEXT@
+-PACKAGE = @PACKAGE@
+-PACKAGE_BUGREPORT = @PACKAGE_BUGREPORT@
+-PACKAGE_NAME = @PACKAGE_NAME@
+-PACKAGE_STRING = @PACKAGE_STRING@
+-PACKAGE_TARNAME = @PACKAGE_TARNAME@
+-PACKAGE_URL = @PACKAGE_URL@
+-PACKAGE_VERSION = @PACKAGE_VERSION@
+-PATH_SEPARATOR = @PATH_SEPARATOR@
+-RANLIB = @RANLIB@
+-SDL_CFLAGS = @SDL_CFLAGS@
+-SDL_CONFIG = @SDL_CONFIG@
+-SDL_LIBS = @SDL_LIBS@
+-SET_MAKE = @SET_MAKE@
+-SHELL = @SHELL@
+-STRIP = @STRIP@
+-VERSION = @VERSION@
+-WINDRES = @WINDRES@
+-abs_builddir = @abs_builddir@
+-abs_srcdir = @abs_srcdir@
+-abs_top_builddir = @abs_top_builddir@
+-abs_top_srcdir = @abs_top_srcdir@
+-ac_ct_CC = @ac_ct_CC@
+-ac_ct_CXX = @ac_ct_CXX@
+-am__include = @am__include@
+-am__leading_dot = @am__leading_dot@
+-am__quote = @am__quote@
+-am__tar = @am__tar@
+-am__untar = @am__untar@
+-bindir = @bindir@
+-build = @build@
+-build_alias = @build_alias@
+-build_cpu = @build_cpu@
+-build_os = @build_os@
+-build_vendor = @build_vendor@
+-builddir = @builddir@
+-datadir = @datadir@
+-datarootdir = @datarootdir@
+-docdir = @docdir@
+-dvidir = @dvidir@
+-exec_prefix = @exec_prefix@
+-host = @host@
+-host_alias = @host_alias@
+-host_cpu = @host_cpu@
+-host_os = @host_os@
+-host_vendor = @host_vendor@
+-htmldir = @htmldir@
+-includedir = @includedir@
+-infodir = @infodir@
+-install_sh = @install_sh@
+-libdir = @libdir@
+-libexecdir = @libexecdir@
+-localedir = @localedir@
+-localstatedir = @localstatedir@
+-mandir = @mandir@
+-mkdir_p = @mkdir_p@
+-oldincludedir = @oldincludedir@
+-pdfdir = @pdfdir@
+-prefix = @prefix@
+-program_transform_name = @program_transform_name@
+-psdir = @psdir@
+-sbindir = @sbindir@
+-sharedstatedir = @sharedstatedir@
+-srcdir = @srcdir@
+-sysconfdir = @sysconfdir@
+-target_alias = @target_alias@
+-top_build_prefix = @top_build_prefix@
+-top_builddir = @top_builddir@
+-top_srcdir = @top_srcdir@
+-EXTRA_DIST = autogen.sh
+-SUBDIRS = src include docs visualc_net
+-all: config.h
+-	$(MAKE) $(AM_MAKEFLAGS) all-recursive
+-
+-.SUFFIXES:
+-am--refresh:
+-	@:
+-$(srcdir)/Makefile.in:  $(srcdir)/Makefile.am  $(am__configure_deps)
+-	@for dep in $?; do \
+-	  case '$(am__configure_deps)' in \
+-	    *$$dep*) \
+-	      echo ' cd $(srcdir) && $(AUTOMAKE) --gnu'; \
+-	      $(am__cd) $(srcdir) && $(AUTOMAKE) --gnu \
+-		&& exit 0; \
+-	      exit 1;; \
+-	  esac; \
+-	done; \
+-	echo ' cd $(top_srcdir) && $(AUTOMAKE) --gnu Makefile'; \
+-	$(am__cd) $(top_srcdir) && \
+-	  $(AUTOMAKE) --gnu Makefile
+-.PRECIOUS: Makefile
+-Makefile: $(srcdir)/Makefile.in $(top_builddir)/config.status
+-	@case '$?' in \
+-	  *config.status*) \
+-	    echo ' $(SHELL) ./config.status'; \
+-	    $(SHELL) ./config.status;; \
+-	  *) \
+-	    echo ' cd $(top_builddir) && $(SHELL) ./config.status $@ $(am__depfiles_maybe)'; \
+-	    cd $(top_builddir) && $(SHELL) ./config.status $@ $(am__depfiles_maybe);; \
+-	esac;
+-
+-$(top_builddir)/config.status: $(top_srcdir)/configure $(CONFIG_STATUS_DEPENDENCIES)
+-	$(SHELL) ./config.status --recheck
+-
+-$(top_srcdir)/configure:  $(am__configure_deps)
+-	$(am__cd) $(srcdir) && $(AUTOCONF)
+-$(ACLOCAL_M4):  $(am__aclocal_m4_deps)
+-	$(am__cd) $(srcdir) && $(ACLOCAL) $(ACLOCAL_AMFLAGS)
+-$(am__aclocal_m4_deps):
+-
+-config.h: stamp-h1
+-	@if test ! -f $@; then \
+-	  rm -f stamp-h1; \
+-	  $(MAKE) $(AM_MAKEFLAGS) stamp-h1; \
+-	else :; fi
+-
+-stamp-h1: $(srcdir)/config.h.in $(top_builddir)/config.status
+-	@rm -f stamp-h1
+-	cd $(top_builddir) && $(SHELL) ./config.status config.h
+-$(srcdir)/config.h.in:  $(am__configure_deps) 
+-	($(am__cd) $(top_srcdir) && $(AUTOHEADER))
+-	rm -f stamp-h1
+-	touch $@
+-
+-distclean-hdr:
+-	-rm -f config.h stamp-h1
+-
+-# This directory's subdirectories are mostly independent; you can cd
+-# into them and run `make' without going through this Makefile.
+-# To change the values of `make' variables: instead of editing Makefiles,
+-# (1) if the variable is set in `config.status', edit `config.status'
+-#     (which will cause the Makefiles to be regenerated when you run `make');
+-# (2) otherwise, pass the desired values on the `make' command line.
+-$(RECURSIVE_TARGETS):
+-	@fail= failcom='exit 1'; \
+-	for f in x $$MAKEFLAGS; do \
+-	  case $$f in \
+-	    *=* | --[!k]*);; \
+-	    *k*) failcom='fail=yes';; \
+-	  esac; \
+-	done; \
+-	dot_seen=no; \
+-	target=`echo $@ | sed s/-recursive//`; \
+-	list='$(SUBDIRS)'; for subdir in $$list; do \
+-	  echo "Making $$target in $$subdir"; \
+-	  if test "$$subdir" = "."; then \
+-	    dot_seen=yes; \
+-	    local_target="$$target-am"; \
+-	  else \
+-	    local_target="$$target"; \
+-	  fi; \
+-	  ($(am__cd) $$subdir && $(MAKE) $(AM_MAKEFLAGS) $$local_target) \
+-	  || eval $$failcom; \
+-	done; \
+-	if test "$$dot_seen" = "no"; then \
+-	  $(MAKE) $(AM_MAKEFLAGS) "$$target-am" || exit 1; \
+-	fi; test -z "$$fail"
+-
+-$(RECURSIVE_CLEAN_TARGETS):
+-	@fail= failcom='exit 1'; \
+-	for f in x $$MAKEFLAGS; do \
+-	  case $$f in \
+-	    *=* | --[!k]*);; \
+-	    *k*) failcom='fail=yes';; \
+-	  esac; \
+-	done; \
+-	dot_seen=no; \
+-	case "$@" in \
+-	  distclean-* | maintainer-clean-*) list='$(DIST_SUBDIRS)' ;; \
+-	  *) list='$(SUBDIRS)' ;; \
+-	esac; \
+-	rev=''; for subdir in $$list; do \
+-	  if test "$$subdir" = "."; then :; else \
+-	    rev="$$subdir $$rev"; \
+-	  fi; \
+-	done; \
+-	rev="$$rev ."; \
+-	target=`echo $@ | sed s/-recursive//`; \
+-	for subdir in $$rev; do \
+-	  echo "Making $$target in $$subdir"; \
+-	  if test "$$subdir" = "."; then \
+-	    local_target="$$target-am"; \
+-	  else \
+-	    local_target="$$target"; \
+-	  fi; \
+-	  ($(am__cd) $$subdir && $(MAKE) $(AM_MAKEFLAGS) $$local_target) \
+-	  || eval $$failcom; \
+-	done && test -z "$$fail"
+-tags-recursive:
+-	list='$(SUBDIRS)'; for subdir in $$list; do \
+-	  test "$$subdir" = . || ($(am__cd) $$subdir && $(MAKE) $(AM_MAKEFLAGS) tags); \
+-	done
+-ctags-recursive:
+-	list='$(SUBDIRS)'; for subdir in $$list; do \
+-	  test "$$subdir" = . || ($(am__cd) $$subdir && $(MAKE) $(AM_MAKEFLAGS) ctags); \
+-	done
+-
+-ID: $(HEADERS) $(SOURCES) $(LISP) $(TAGS_FILES)
+-	list='$(SOURCES) $(HEADERS) $(LISP) $(TAGS_FILES)'; \
+-	unique=`for i in $$list; do \
+-	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
+-	  done | \
+-	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
+-	      END { if (nonempty) { for (i in files) print i; }; }'`; \
+-	mkid -fID $$unique
+-tags: TAGS
+-
+-TAGS: tags-recursive $(HEADERS) $(SOURCES) config.h.in $(TAGS_DEPENDENCIES) \
+-		$(TAGS_FILES) $(LISP)
+-	set x; \
+-	here=`pwd`; \
+-	if ($(ETAGS) --etags-include --version) >/dev/null 2>&1; then \
+-	  include_option=--etags-include; \
+-	  empty_fix=.; \
+-	else \
+-	  include_option=--include; \
+-	  empty_fix=; \
+-	fi; \
+-	list='$(SUBDIRS)'; for subdir in $$list; do \
+-	  if test "$$subdir" = .; then :; else \
+-	    test ! -f $$subdir/TAGS || \
+-	      set "$$@" "$$include_option=$$here/$$subdir/TAGS"; \
+-	  fi; \
+-	done; \
+-	list='$(SOURCES) $(HEADERS) config.h.in $(LISP) $(TAGS_FILES)'; \
+-	unique=`for i in $$list; do \
+-	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
+-	  done | \
+-	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
+-	      END { if (nonempty) { for (i in files) print i; }; }'`; \
+-	shift; \
+-	if test -z "$(ETAGS_ARGS)$$*$$unique"; then :; else \
+-	  test -n "$$unique" || unique=$$empty_fix; \
+-	  if test $$# -gt 0; then \
+-	    $(ETAGS) $(ETAGSFLAGS) $(AM_ETAGSFLAGS) $(ETAGS_ARGS) \
+-	      "$$@" $$unique; \
+-	  else \
+-	    $(ETAGS) $(ETAGSFLAGS) $(AM_ETAGSFLAGS) $(ETAGS_ARGS) \
+-	      $$unique; \
+-	  fi; \
+-	fi
+-ctags: CTAGS
+-CTAGS: ctags-recursive $(HEADERS) $(SOURCES) config.h.in $(TAGS_DEPENDENCIES) \
+-		$(TAGS_FILES) $(LISP)
+-	list='$(SOURCES) $(HEADERS) config.h.in $(LISP) $(TAGS_FILES)'; \
+-	unique=`for i in $$list; do \
+-	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
+-	  done | \
+-	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
+-	      END { if (nonempty) { for (i in files) print i; }; }'`; \
+-	test -z "$(CTAGS_ARGS)$$unique" \
+-	  || $(CTAGS) $(CTAGSFLAGS) $(AM_CTAGSFLAGS) $(CTAGS_ARGS) \
+-	     $$unique
+-
+-GTAGS:
+-	here=`$(am__cd) $(top_builddir) && pwd` \
+-	  && $(am__cd) $(top_srcdir) \
+-	  && gtags -i $(GTAGS_ARGS) "$$here"
+-
+-distclean-tags:
+-	-rm -f TAGS ID GTAGS GRTAGS GSYMS GPATH tags
+-
+-distdir: $(DISTFILES)
+-	$(am__remove_distdir)
+-	test -d "$(distdir)" || mkdir "$(distdir)"
+-	@srcdirstrip=`echo "$(srcdir)" | sed 's/[].[^$$\\*]/\\\\&/g'`; \
+-	topsrcdirstrip=`echo "$(top_srcdir)" | sed 's/[].[^$$\\*]/\\\\&/g'`; \
+-	list='$(DISTFILES)'; \
+-	  dist_files=`for file in $$list; do echo $$file; done | \
+-	  sed -e "s|^$$srcdirstrip/||;t" \
+-	      -e "s|^$$topsrcdirstrip/|$(top_builddir)/|;t"`; \
+-	case $$dist_files in \
+-	  */*) $(MKDIR_P) `echo "$$dist_files" | \
+-			   sed '/\//!d;s|^|$(distdir)/|;s,/[^/]*$$,,' | \
+-			   sort -u` ;; \
+-	esac; \
+-	for file in $$dist_files; do \
+-	  if test -f $$file || test -d $$file; then d=.; else d=$(srcdir); fi; \
+-	  if test -d $$d/$$file; then \
+-	    dir=`echo "/$$file" | sed -e 's,/[^/]*$$,,'`; \
+-	    if test -d "$(distdir)/$$file"; then \
+-	      find "$(distdir)/$$file" -type d ! -perm -700 -exec chmod u+rwx {} \;; \
+-	    fi; \
+-	    if test -d $(srcdir)/$$file && test $$d != $(srcdir); then \
+-	      cp -fpR $(srcdir)/$$file "$(distdir)$$dir" || exit 1; \
+-	      find "$(distdir)/$$file" -type d ! -perm -700 -exec chmod u+rwx {} \;; \
+-	    fi; \
+-	    cp -fpR $$d/$$file "$(distdir)$$dir" || exit 1; \
+-	  else \
+-	    test -f "$(distdir)/$$file" \
+-	    || cp -p $$d/$$file "$(distdir)/$$file" \
+-	    || exit 1; \
+-	  fi; \
+-	done
+-	@list='$(DIST_SUBDIRS)'; for subdir in $$list; do \
+-	  if test "$$subdir" = .; then :; else \
+-	    test -d "$(distdir)/$$subdir" \
+-	    || $(MKDIR_P) "$(distdir)/$$subdir" \
+-	    || exit 1; \
+-	  fi; \
+-	done
+-	@list='$(DIST_SUBDIRS)'; for subdir in $$list; do \
+-	  if test "$$subdir" = .; then :; else \
+-	    dir1=$$subdir; dir2="$(distdir)/$$subdir"; \
+-	    $(am__relativize); \
+-	    new_distdir=$$reldir; \
+-	    dir1=$$subdir; dir2="$(top_distdir)"; \
+-	    $(am__relativize); \
+-	    new_top_distdir=$$reldir; \
+-	    echo " (cd $$subdir && $(MAKE) $(AM_MAKEFLAGS) top_distdir="$$new_top_distdir" distdir="$$new_distdir" \\"; \
+-	    echo "     am__remove_distdir=: am__skip_length_check=: am__skip_mode_fix=: distdir)"; \
+-	    ($(am__cd) $$subdir && \
+-	      $(MAKE) $(AM_MAKEFLAGS) \
+-	        top_distdir="$$new_top_distdir" \
+-	        distdir="$$new_distdir" \
+-		am__remove_distdir=: \
+-		am__skip_length_check=: \
+-		am__skip_mode_fix=: \
+-	        distdir) \
+-	      || exit 1; \
+-	  fi; \
+-	done
+-	-test -n "$(am__skip_mode_fix)" \
+-	|| find "$(distdir)" -type d ! -perm -755 \
+-		-exec chmod u+rwx,go+rx {} \; -o \
+-	  ! -type d ! -perm -444 -links 1 -exec chmod a+r {} \; -o \
+-	  ! -type d ! -perm -400 -exec chmod a+r {} \; -o \
+-	  ! -type d ! -perm -444 -exec $(install_sh) -c -m a+r {} {} \; \
+-	|| chmod -R a+r "$(distdir)"
+-dist-gzip: distdir
+-	tardir=$(distdir) && $(am__tar) | GZIP=$(GZIP_ENV) gzip -c >$(distdir).tar.gz
+-	$(am__remove_distdir)
+-
+-dist-bzip2: distdir
+-	tardir=$(distdir) && $(am__tar) | bzip2 -9 -c >$(distdir).tar.bz2
+-	$(am__remove_distdir)
+-
+-dist-lzma: distdir
+-	tardir=$(distdir) && $(am__tar) | lzma -9 -c >$(distdir).tar.lzma
+-	$(am__remove_distdir)
+-
+-dist-xz: distdir
+-	tardir=$(distdir) && $(am__tar) | xz -c >$(distdir).tar.xz
+-	$(am__remove_distdir)
+-
+-dist-tarZ: distdir
+-	tardir=$(distdir) && $(am__tar) | compress -c >$(distdir).tar.Z
+-	$(am__remove_distdir)
+-
+-dist-shar: distdir
+-	shar $(distdir) | GZIP=$(GZIP_ENV) gzip -c >$(distdir).shar.gz
+-	$(am__remove_distdir)
+-
+-dist-zip: distdir
+-	-rm -f $(distdir).zip
+-	zip -rq $(distdir).zip $(distdir)
+-	$(am__remove_distdir)
+-
+-dist dist-all: distdir
+-	tardir=$(distdir) && $(am__tar) | GZIP=$(GZIP_ENV) gzip -c >$(distdir).tar.gz
+-	$(am__remove_distdir)
+-
+-# This target untars the dist file and tries a VPATH configuration.  Then
+-# it guarantees that the distribution is self-contained by making another
+-# tarfile.
+-distcheck: dist
+-	case '$(DIST_ARCHIVES)' in \
+-	*.tar.gz*) \
+-	  GZIP=$(GZIP_ENV) gzip -dc $(distdir).tar.gz | $(am__untar) ;;\
+-	*.tar.bz2*) \
+-	  bzip2 -dc $(distdir).tar.bz2 | $(am__untar) ;;\
+-	*.tar.lzma*) \
+-	  lzma -dc $(distdir).tar.lzma | $(am__untar) ;;\
+-	*.tar.xz*) \
+-	  xz -dc $(distdir).tar.xz | $(am__untar) ;;\
+-	*.tar.Z*) \
+-	  uncompress -c $(distdir).tar.Z | $(am__untar) ;;\
+-	*.shar.gz*) \
+-	  GZIP=$(GZIP_ENV) gzip -dc $(distdir).shar.gz | unshar ;;\
+-	*.zip*) \
+-	  unzip $(distdir).zip ;;\
+-	esac
+-	chmod -R a-w $(distdir); chmod a+w $(distdir)
+-	mkdir $(distdir)/_build
+-	mkdir $(distdir)/_inst
+-	chmod a-w $(distdir)
+-	test -d $(distdir)/_build || exit 0; \
+-	dc_install_base=`$(am__cd) $(distdir)/_inst && pwd | sed -e 's,^[^:\\/]:[\\/],/,'` \
+-	  && dc_destdir="$${TMPDIR-/tmp}/am-dc-$$$$/" \
+-	  && am__cwd=`pwd` \
+-	  && $(am__cd) $(distdir)/_build \
+-	  && ../configure --srcdir=.. --prefix="$$dc_install_base" \
+-	    $(DISTCHECK_CONFIGURE_FLAGS) \
+-	  && $(MAKE) $(AM_MAKEFLAGS) \
+-	  && $(MAKE) $(AM_MAKEFLAGS) dvi \
+-	  && $(MAKE) $(AM_MAKEFLAGS) check \
+-	  && $(MAKE) $(AM_MAKEFLAGS) install \
+-	  && $(MAKE) $(AM_MAKEFLAGS) installcheck \
+-	  && $(MAKE) $(AM_MAKEFLAGS) uninstall \
+-	  && $(MAKE) $(AM_MAKEFLAGS) distuninstallcheck_dir="$$dc_install_base" \
+-	        distuninstallcheck \
+-	  && chmod -R a-w "$$dc_install_base" \
+-	  && ({ \
+-	       (cd ../.. && umask 077 && mkdir "$$dc_destdir") \
+-	       && $(MAKE) $(AM_MAKEFLAGS) DESTDIR="$$dc_destdir" install \
+-	       && $(MAKE) $(AM_MAKEFLAGS) DESTDIR="$$dc_destdir" uninstall \
+-	       && $(MAKE) $(AM_MAKEFLAGS) DESTDIR="$$dc_destdir" \
+-	            distuninstallcheck_dir="$$dc_destdir" distuninstallcheck; \
+-	      } || { rm -rf "$$dc_destdir"; exit 1; }) \
+-	  && rm -rf "$$dc_destdir" \
+-	  && $(MAKE) $(AM_MAKEFLAGS) dist \
+-	  && rm -rf $(DIST_ARCHIVES) \
+-	  && $(MAKE) $(AM_MAKEFLAGS) distcleancheck \
+-	  && cd "$$am__cwd" \
+-	  || exit 1
+-	$(am__remove_distdir)
+-	@(echo "$(distdir) archives ready for distribution: "; \
+-	  list='$(DIST_ARCHIVES)'; for i in $$list; do echo $$i; done) | \
+-	  sed -e 1h -e 1s/./=/g -e 1p -e 1x -e '$$p' -e '$$x'
+-distuninstallcheck:
+-	@$(am__cd) '$(distuninstallcheck_dir)' \
+-	&& test `$(distuninstallcheck_listfiles) | wc -l` -le 1 \
+-	   || { echo "ERROR: files left after uninstall:" ; \
+-	        if test -n "$(DESTDIR)"; then \
+-	          echo "  (check DESTDIR support)"; \
+-	        fi ; \
+-	        $(distuninstallcheck_listfiles) ; \
+-	        exit 1; } >&2
+-distcleancheck: distclean
+-	@if test '$(srcdir)' = . ; then \
+-	  echo "ERROR: distcleancheck can only run from a VPATH build" ; \
+-	  exit 1 ; \
+-	fi
+-	@test `$(distcleancheck_listfiles) | wc -l` -eq 0 \
+-	  || { echo "ERROR: files left in build directory after distclean:" ; \
+-	       $(distcleancheck_listfiles) ; \
+-	       exit 1; } >&2
+-check-am: all-am
+-check: check-recursive
+-all-am: Makefile config.h
+-installdirs: installdirs-recursive
+-installdirs-am:
+-install: install-recursive
+-install-exec: install-exec-recursive
+-install-data: install-data-recursive
+-uninstall: uninstall-recursive
+-
+-install-am: all-am
+-	@$(MAKE) $(AM_MAKEFLAGS) install-exec-am install-data-am
+-
+-installcheck: installcheck-recursive
+-install-strip:
+-	$(MAKE) $(AM_MAKEFLAGS) INSTALL_PROGRAM="$(INSTALL_STRIP_PROGRAM)" \
+-	  install_sh_PROGRAM="$(INSTALL_STRIP_PROGRAM)" INSTALL_STRIP_FLAG=-s \
+-	  `test -z '$(STRIP)' || \
+-	    echo "INSTALL_PROGRAM_ENV=STRIPPROG='$(STRIP)'"` install
+-mostlyclean-generic:
+-
+-clean-generic:
+-
+-distclean-generic:
+-	-test -z "$(CONFIG_CLEAN_FILES)" || rm -f $(CONFIG_CLEAN_FILES)
+-	-test . = "$(srcdir)" || test -z "$(CONFIG_CLEAN_VPATH_FILES)" || rm -f $(CONFIG_CLEAN_VPATH_FILES)
+-
+-maintainer-clean-generic:
+-	@echo "This command is intended for maintainers to use"
+-	@echo "it deletes files that may require special tools to rebuild."
+-clean: clean-recursive
+-
+-clean-am: clean-generic mostlyclean-am
+-
+-distclean: distclean-recursive
+-	-rm -f $(am__CONFIG_DISTCLEAN_FILES)
+-	-rm -f Makefile
+-distclean-am: clean-am distclean-generic distclean-hdr distclean-tags
+-
+-dvi: dvi-recursive
+-
+-dvi-am:
+-
+-html: html-recursive
+-
+-html-am:
+-
+-info: info-recursive
+-
+-info-am:
+-
+-install-data-am:
+-
+-install-dvi: install-dvi-recursive
+-
+-install-dvi-am:
+-
+-install-exec-am:
+-
+-install-html: install-html-recursive
+-
+-install-html-am:
+-
+-install-info: install-info-recursive
+-
+-install-info-am:
+-
+-install-man:
+-
+-install-pdf: install-pdf-recursive
+-
+-install-pdf-am:
+-
+-install-ps: install-ps-recursive
+-
+-install-ps-am:
+-
+-installcheck-am:
+-
+-maintainer-clean: maintainer-clean-recursive
+-	-rm -f $(am__CONFIG_DISTCLEAN_FILES)
+-	-rm -rf $(top_srcdir)/autom4te.cache
+-	-rm -f Makefile
+-maintainer-clean-am: distclean-am maintainer-clean-generic
+-
+-mostlyclean: mostlyclean-recursive
+-
+-mostlyclean-am: mostlyclean-generic
+-
+-pdf: pdf-recursive
+-
+-pdf-am:
+-
+-ps: ps-recursive
+-
+-ps-am:
+-
+-uninstall-am:
+-
+-.MAKE: $(RECURSIVE_CLEAN_TARGETS) $(RECURSIVE_TARGETS) all \
+-	ctags-recursive install-am install-strip tags-recursive
+-
+-.PHONY: $(RECURSIVE_CLEAN_TARGETS) $(RECURSIVE_TARGETS) CTAGS GTAGS \
+-	all all-am am--refresh check check-am clean clean-generic \
+-	ctags ctags-recursive dist dist-all dist-bzip2 dist-gzip \
+-	dist-lzma dist-shar dist-tarZ dist-xz dist-zip distcheck \
+-	distclean distclean-generic distclean-hdr distclean-tags \
+-	distcleancheck distdir distuninstallcheck dvi dvi-am html \
+-	html-am info info-am install install-am install-data \
+-	install-data-am install-dvi install-dvi-am install-exec \
+-	install-exec-am install-html install-html-am install-info \
+-	install-info-am install-man install-pdf install-pdf-am \
+-	install-ps install-ps-am install-strip installcheck \
+-	installcheck-am installdirs installdirs-am maintainer-clean \
+-	maintainer-clean-generic mostlyclean mostlyclean-generic pdf \
+-	pdf-am ps ps-am tags tags-recursive uninstall uninstall-am
+-
+-
+-# Tell versions [3.59,3.63) of GNU make to not export all variables.
+-# Otherwise a system limit (for SysV at least) may be exceeded.
+-.NOEXPORT:
+diff -Nur dosbox-0.74/missing dosbox/missing
+--- dosbox-0.74/missing	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/missing	1970-01-01 01:00:00.000000000 +0100
+@@ -1,376 +0,0 @@
+-#! /bin/sh
+-# Common stub for a few missing GNU programs while installing.
+-
+-scriptversion=2009-04-28.21; # UTC
+-
+-# Copyright (C) 1996, 1997, 1999, 2000, 2002, 2003, 2004, 2005, 2006,
+-# 2008, 2009 Free Software Foundation, Inc.
+-# Originally by Fran,cois Pinard <pinard@iro.umontreal.ca>, 1996.
+-
+-# This program is free software; you can redistribute it and/or modify
+-# it under the terms of the GNU General Public License as published by
+-# the Free Software Foundation; either version 2, or (at your option)
+-# any later version.
+-
+-# This program is distributed in the hope that it will be useful,
+-# but WITHOUT ANY WARRANTY; without even the implied warranty of
+-# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+-# GNU General Public License for more details.
+-
+-# You should have received a copy of the GNU General Public License
+-# along with this program.  If not, see <http://www.gnu.org/licenses/>.
+-
+-# As a special exception to the GNU General Public License, if you
+-# distribute this file as part of a program that contains a
+-# configuration script generated by Autoconf, you may include it under
+-# the same distribution terms that you use for the rest of that program.
+-
+-if test $# -eq 0; then
+-  echo 1>&2 "Try \`$0 --help' for more information"
+-  exit 1
+-fi
+-
+-run=:
+-sed_output='s/.* --output[ =]\([^ ]*\).*/\1/p'
+-sed_minuso='s/.* -o \([^ ]*\).*/\1/p'
+-
+-# In the cases where this matters, `missing' is being run in the
+-# srcdir already.
+-if test -f configure.ac; then
+-  configure_ac=configure.ac
+-else
+-  configure_ac=configure.in
+-fi
+-
+-msg="missing on your system"
+-
+-case $1 in
+---run)
+-  # Try to run requested program, and just exit if it succeeds.
+-  run=
+-  shift
+-  "$@" && exit 0
+-  # Exit code 63 means version mismatch.  This often happens
+-  # when the user try to use an ancient version of a tool on
+-  # a file that requires a minimum version.  In this case we
+-  # we should proceed has if the program had been absent, or
+-  # if --run hadn't been passed.
+-  if test $? = 63; then
+-    run=:
+-    msg="probably too old"
+-  fi
+-  ;;
+-
+-  -h|--h|--he|--hel|--help)
+-    echo "\
+-$0 [OPTION]... PROGRAM [ARGUMENT]...
+-
+-Handle \`PROGRAM [ARGUMENT]...' for when PROGRAM is missing, or return an
+-error status if there is no known handling for PROGRAM.
+-
+-Options:
+-  -h, --help      display this help and exit
+-  -v, --version   output version information and exit
+-  --run           try to run the given command, and emulate it if it fails
+-
+-Supported PROGRAM values:
+-  aclocal      touch file \`aclocal.m4'
+-  autoconf     touch file \`configure'
+-  autoheader   touch file \`config.h.in'
+-  autom4te     touch the output file, or create a stub one
+-  automake     touch all \`Makefile.in' files
+-  bison        create \`y.tab.[ch]', if possible, from existing .[ch]
+-  flex         create \`lex.yy.c', if possible, from existing .c
+-  help2man     touch the output file
+-  lex          create \`lex.yy.c', if possible, from existing .c
+-  makeinfo     touch the output file
+-  tar          try tar, gnutar, gtar, then tar without non-portable flags
+-  yacc         create \`y.tab.[ch]', if possible, from existing .[ch]
+-
+-Version suffixes to PROGRAM as well as the prefixes \`gnu-', \`gnu', and
+-\`g' are ignored when checking the name.
+-
+-Send bug reports to <bug-automake@gnu.org>."
+-    exit $?
+-    ;;
+-
+-  -v|--v|--ve|--ver|--vers|--versi|--versio|--version)
+-    echo "missing $scriptversion (GNU Automake)"
+-    exit $?
+-    ;;
+-
+-  -*)
+-    echo 1>&2 "$0: Unknown \`$1' option"
+-    echo 1>&2 "Try \`$0 --help' for more information"
+-    exit 1
+-    ;;
+-
+-esac
+-
+-# normalize program name to check for.
+-program=`echo "$1" | sed '
+-  s/^gnu-//; t
+-  s/^gnu//; t
+-  s/^g//; t'`
+-
+-# Now exit if we have it, but it failed.  Also exit now if we
+-# don't have it and --version was passed (most likely to detect
+-# the program).  This is about non-GNU programs, so use $1 not
+-# $program.
+-case $1 in
+-  lex*|yacc*)
+-    # Not GNU programs, they don't have --version.
+-    ;;
+-
+-  tar*)
+-    if test -n "$run"; then
+-       echo 1>&2 "ERROR: \`tar' requires --run"
+-       exit 1
+-    elif test "x$2" = "x--version" || test "x$2" = "x--help"; then
+-       exit 1
+-    fi
+-    ;;
+-
+-  *)
+-    if test -z "$run" && ($1 --version) > /dev/null 2>&1; then
+-       # We have it, but it failed.
+-       exit 1
+-    elif test "x$2" = "x--version" || test "x$2" = "x--help"; then
+-       # Could not run --version or --help.  This is probably someone
+-       # running `$TOOL --version' or `$TOOL --help' to check whether
+-       # $TOOL exists and not knowing $TOOL uses missing.
+-       exit 1
+-    fi
+-    ;;
+-esac
+-
+-# If it does not exist, or fails to run (possibly an outdated version),
+-# try to emulate it.
+-case $program in
+-  aclocal*)
+-    echo 1>&2 "\
+-WARNING: \`$1' is $msg.  You should only need it if
+-         you modified \`acinclude.m4' or \`${configure_ac}'.  You might want
+-         to install the \`Automake' and \`Perl' packages.  Grab them from
+-         any GNU archive site."
+-    touch aclocal.m4
+-    ;;
+-
+-  autoconf*)
+-    echo 1>&2 "\
+-WARNING: \`$1' is $msg.  You should only need it if
+-         you modified \`${configure_ac}'.  You might want to install the
+-         \`Autoconf' and \`GNU m4' packages.  Grab them from any GNU
+-         archive site."
+-    touch configure
+-    ;;
+-
+-  autoheader*)
+-    echo 1>&2 "\
+-WARNING: \`$1' is $msg.  You should only need it if
+-         you modified \`acconfig.h' or \`${configure_ac}'.  You might want
+-         to install the \`Autoconf' and \`GNU m4' packages.  Grab them
+-         from any GNU archive site."
+-    files=`sed -n 's/^[ ]*A[CM]_CONFIG_HEADER(\([^)]*\)).*/\1/p' ${configure_ac}`
+-    test -z "$files" && files="config.h"
+-    touch_files=
+-    for f in $files; do
+-      case $f in
+-      *:*) touch_files="$touch_files "`echo "$f" |
+-				       sed -e 's/^[^:]*://' -e 's/:.*//'`;;
+-      *) touch_files="$touch_files $f.in";;
+-      esac
+-    done
+-    touch $touch_files
+-    ;;
+-
+-  automake*)
+-    echo 1>&2 "\
+-WARNING: \`$1' is $msg.  You should only need it if
+-         you modified \`Makefile.am', \`acinclude.m4' or \`${configure_ac}'.
+-         You might want to install the \`Automake' and \`Perl' packages.
+-         Grab them from any GNU archive site."
+-    find . -type f -name Makefile.am -print |
+-	   sed 's/\.am$/.in/' |
+-	   while read f; do touch "$f"; done
+-    ;;
+-
+-  autom4te*)
+-    echo 1>&2 "\
+-WARNING: \`$1' is needed, but is $msg.
+-         You might have modified some files without having the
+-         proper tools for further handling them.
+-         You can get \`$1' as part of \`Autoconf' from any GNU
+-         archive site."
+-
+-    file=`echo "$*" | sed -n "$sed_output"`
+-    test -z "$file" && file=`echo "$*" | sed -n "$sed_minuso"`
+-    if test -f "$file"; then
+-	touch $file
+-    else
+-	test -z "$file" || exec >$file
+-	echo "#! /bin/sh"
+-	echo "# Created by GNU Automake missing as a replacement of"
+-	echo "#  $ $@"
+-	echo "exit 0"
+-	chmod +x $file
+-	exit 1
+-    fi
+-    ;;
+-
+-  bison*|yacc*)
+-    echo 1>&2 "\
+-WARNING: \`$1' $msg.  You should only need it if
+-         you modified a \`.y' file.  You may need the \`Bison' package
+-         in order for those modifications to take effect.  You can get
+-         \`Bison' from any GNU archive site."
+-    rm -f y.tab.c y.tab.h
+-    if test $# -ne 1; then
+-        eval LASTARG="\${$#}"
+-	case $LASTARG in
+-	*.y)
+-	    SRCFILE=`echo "$LASTARG" | sed 's/y$/c/'`
+-	    if test -f "$SRCFILE"; then
+-	         cp "$SRCFILE" y.tab.c
+-	    fi
+-	    SRCFILE=`echo "$LASTARG" | sed 's/y$/h/'`
+-	    if test -f "$SRCFILE"; then
+-	         cp "$SRCFILE" y.tab.h
+-	    fi
+-	  ;;
+-	esac
+-    fi
+-    if test ! -f y.tab.h; then
+-	echo >y.tab.h
+-    fi
+-    if test ! -f y.tab.c; then
+-	echo 'main() { return 0; }' >y.tab.c
+-    fi
+-    ;;
+-
+-  lex*|flex*)
+-    echo 1>&2 "\
+-WARNING: \`$1' is $msg.  You should only need it if
+-         you modified a \`.l' file.  You may need the \`Flex' package
+-         in order for those modifications to take effect.  You can get
+-         \`Flex' from any GNU archive site."
+-    rm -f lex.yy.c
+-    if test $# -ne 1; then
+-        eval LASTARG="\${$#}"
+-	case $LASTARG in
+-	*.l)
+-	    SRCFILE=`echo "$LASTARG" | sed 's/l$/c/'`
+-	    if test -f "$SRCFILE"; then
+-	         cp "$SRCFILE" lex.yy.c
+-	    fi
+-	  ;;
+-	esac
+-    fi
+-    if test ! -f lex.yy.c; then
+-	echo 'main() { return 0; }' >lex.yy.c
+-    fi
+-    ;;
+-
+-  help2man*)
+-    echo 1>&2 "\
+-WARNING: \`$1' is $msg.  You should only need it if
+-	 you modified a dependency of a manual page.  You may need the
+-	 \`Help2man' package in order for those modifications to take
+-	 effect.  You can get \`Help2man' from any GNU archive site."
+-
+-    file=`echo "$*" | sed -n "$sed_output"`
+-    test -z "$file" && file=`echo "$*" | sed -n "$sed_minuso"`
+-    if test -f "$file"; then
+-	touch $file
+-    else
+-	test -z "$file" || exec >$file
+-	echo ".ab help2man is required to generate this page"
+-	exit $?
+-    fi
+-    ;;
+-
+-  makeinfo*)
+-    echo 1>&2 "\
+-WARNING: \`$1' is $msg.  You should only need it if
+-         you modified a \`.texi' or \`.texinfo' file, or any other file
+-         indirectly affecting the aspect of the manual.  The spurious
+-         call might also be the consequence of using a buggy \`make' (AIX,
+-         DU, IRIX).  You might want to install the \`Texinfo' package or
+-         the \`GNU make' package.  Grab either from any GNU archive site."
+-    # The file to touch is that specified with -o ...
+-    file=`echo "$*" | sed -n "$sed_output"`
+-    test -z "$file" && file=`echo "$*" | sed -n "$sed_minuso"`
+-    if test -z "$file"; then
+-      # ... or it is the one specified with @setfilename ...
+-      infile=`echo "$*" | sed 's/.* \([^ ]*\) *$/\1/'`
+-      file=`sed -n '
+-	/^@setfilename/{
+-	  s/.* \([^ ]*\) *$/\1/
+-	  p
+-	  q
+-	}' $infile`
+-      # ... or it is derived from the source name (dir/f.texi becomes f.info)
+-      test -z "$file" && file=`echo "$infile" | sed 's,.*/,,;s,.[^.]*$,,'`.info
+-    fi
+-    # If the file does not exist, the user really needs makeinfo;
+-    # let's fail without touching anything.
+-    test -f $file || exit 1
+-    touch $file
+-    ;;
+-
+-  tar*)
+-    shift
+-
+-    # We have already tried tar in the generic part.
+-    # Look for gnutar/gtar before invocation to avoid ugly error
+-    # messages.
+-    if (gnutar --version > /dev/null 2>&1); then
+-       gnutar "$@" && exit 0
+-    fi
+-    if (gtar --version > /dev/null 2>&1); then
+-       gtar "$@" && exit 0
+-    fi
+-    firstarg="$1"
+-    if shift; then
+-	case $firstarg in
+-	*o*)
+-	    firstarg=`echo "$firstarg" | sed s/o//`
+-	    tar "$firstarg" "$@" && exit 0
+-	    ;;
+-	esac
+-	case $firstarg in
+-	*h*)
+-	    firstarg=`echo "$firstarg" | sed s/h//`
+-	    tar "$firstarg" "$@" && exit 0
+-	    ;;
+-	esac
+-    fi
+-
+-    echo 1>&2 "\
+-WARNING: I can't seem to be able to run \`tar' with the given arguments.
+-         You may want to install GNU tar or Free paxutils, or check the
+-         command line arguments."
+-    exit 1
+-    ;;
+-
+-  *)
+-    echo 1>&2 "\
+-WARNING: \`$1' is needed, and is $msg.
+-         You might have modified some files without having the
+-         proper tools for further handling them.  Check the \`README' file,
+-         it often tells you about the needed prerequisites for installing
+-         this package.  You may also peek at any GNU archive site, in case
+-         some other package would contain this missing \`$1' program."
+-    exit 1
+-    ;;
+-esac
+-
+-exit 0
+-
+-# Local variables:
+-# eval: (add-hook 'write-file-hooks 'time-stamp)
+-# time-stamp-start: "scriptversion="
+-# time-stamp-format: "%:y-%02m-%02d.%02H"
+-# time-stamp-time-zone: "UTC"
+-# time-stamp-end: "; # UTC"
+-# End:
+diff -Nur dosbox-0.74/README dosbox/README
+--- dosbox-0.74/README	2010-05-10 20:58:07.000000000 +0200
++++ dosbox/README	2014-01-12 14:43:47.000000000 +0100
+@@ -46,7 +46,7 @@
+ It is essential that you get familiar with the idea of mounting, DOSBox does not
+ automatically make any drive (or a part of it) accessible to the emulation. See
+ the FAQ entry "How to start?" as well as the description of the MOUNT command
+-(section 4: "Internal Programs"). If you have your game on a cdrom you may try
++(Section 4: "Internal Programs"). If you have your game on a cdrom you may try
+ this guide: http://vogons.zetafleet.com/viewtopic.php?t=8933
+ 
+ 
+@@ -92,7 +92,7 @@
+ AUTOMATION: Do I always have to type these commands?
+     In the DOSBox configuration file is an [autoexec] section. The commands
+     present there are run when DOSBox starts, so you can use this section
+-    for the mounting. Look at Section 13: The configuration (options) file
++    for the mounting. Look at Section 13: "The configuration (options) file".
+ 
+ 
+ FULLSCREEN: How do I change to fullscreen?
+@@ -116,11 +116,11 @@
+       To enable SDL-support (does not include low-level CD access!):
+         - mount d f:\ -t cdrom -usecd 0 -noioctl
+       To enable ioctl access using digital audio extraction for CD audio
+-      (windows-only, useful for Vista):
++      (Windows-only, useful for Vista):
+         - mount d f:\ -t cdrom -ioctl_dx
+-      To enable ioctl access using MCI for CD audio (windows-only):
++      To enable ioctl access using MCI for CD audio (Windows-only):
+         - mount d f:\ -t cdrom -ioctl_mci
+-      To force ioctl-only access (windows-only):
++      To force ioctl-only access (Windows-only):
+         - mount d f:\ -t cdrom -ioctl_dio
+       To enable low-level aspi-support (win98 with aspi-layer installed):
+         - mount d f:\ -t cdrom -aspi
+@@ -143,7 +143,7 @@
+     Under Windows you can specify -ioctl, -aspi or -noioctl. Look at the
+     description of the mount command in Section 4: "Internal programs"
+     for their meaning and the
+-    additional audio-CD related options -ioctl_dx, ioctl_mci, ioctl_dio.
++    additional audio-CD related options -ioctl_dx, -ioctl_mci, -ioctl_dio.
+ 
+     Try creating a CD-ROM image (preferably CUE/BIN pair) and use the
+     DOSBox's internal IMGMOUNT tool to mount the image (the CUE sheet).
+@@ -161,7 +161,7 @@
+     Be sure that the sound is correctly configured in the game. This might be
+     done during the installation or with a setup/setsound utility that
+     accompanies the game. First see if an autodetection option is provided. If
+-    there is none try selecting Soundblaster or Soundblaster 16 with the default
++    there is none try selecting SoundBlaster or SoundBlaster 16 with the default
+     settings being "address=220 irq=7 dma=1" (sometimes highdma=5). You might
+     also want to select Sound Canvas/SCC/MPU-401/General MIDI/Wave Blaster
+     at "address=330 IRQ=2" as music device.
+@@ -171,8 +171,8 @@
+     configuration and use some lower fixed cycles value (like cycles=2000). Also
+     assure that your host operating sound does provide sound.
+     In certain cases it might be useful to use a different emulated sound device
+-    like a soundblaster pro (sbtype=sbpro1 in the DOSBox configuration file) or
+-    the gravis ultrasound (gus=true).
++    like a SoundBlaster Pro (sbtype=sbpro1 in the DOSBox configuration file) or
++    the Gravis Ultrasound (gus=true).
+ 
+ 
+ SOUND: What sound hardware does DOSBox presently emulate?
+@@ -182,21 +182,21 @@
+       digital sound output through the internal speaker.
+     - Creative CMS/Gameblaster
+       The is the first card released by Creative Labs(R).  The default
+-      configuration places it on address 220. It is disabled as default.
++      configuration places it on address 220. It is disabled by default.
+     - Tandy 3 voice
+       The emulation of this sound hardware is complete with the exception of
+       the noise channel. The noise channel is not very well documented and as
+       such is only a best guess as to the sound's accuracy. It is disabled as
+       default.
+     - Tandy DAC
+-      Some games may require turning off sound blaster emulation (sbtype=none)
+-      for better tandy DAC sound support. Don't forget to set the sbtype back to
+-      sb16 if you don't use tandy sound.
++      Some games may require turning off SoundBlaster emulation (sbtype=none)
++      for better Tandy DAC sound support. Don't forget to set the sbtype back to
++      sb16 if you don't use Tandy sound.
+     - Adlib
+       This emulation is almost perfect and includes the Adlib's ability to
+       almost play digitized sound. Placed at address 220 (also on 388).
+     - SoundBlaster 16 / SoundBlaster Pro I & II / SoundBlaster I & II
+-      By default DOSBox provides Soundblaster 16 level 16-bit stereo sound.
++      By default DOSBox provides SoundBlaster 16 level 16-bit stereo sound.
+       You can select a different SoundBlaster version in the configuration of
+       DOSBox. AWE32 music is not emulated as you can use MPU-401 instead
+       (see below).
+@@ -207,24 +207,25 @@
+       The emulation of this hardware is nearly complete, though the MIDI
+       capabilities have been left out, since an MPU-401 has been emulated
+       in other code. For Gravis music you also have to install Gravis drivers
+-      inside DOSBox. It is disabled as default.
++      inside DOSBox. It is disabled by default.
+     - MPU-401
+       A MIDI passthrough interface is also emulated. This method of sound
+       output will only work when used with external device/emulator.
+-      Every Windows XP/Vista/7 and MAC OS has got a default emulator compatible
+-      with: Sound Canvas/SCC/General Standard/General MIDI/Wave Blaster.
+-      A different device/emulator is needed for Roland LAPC/CM-32L/MT-32
+-      compatibility.
++      Every Windows XP/Vista/7 and Mac OS X has got a default emulator 
++      compatible with: Sound Canvas/SCC/General Standard/General MIDI/Wave 
++      Blaster. A different device/emulator is needed for 
++      Roland LAPC/CM-32L/MT-32 compatibility.
+ 
+ 
+ SOUND: The sound stutters or sounds stretched/weird.
+     You may be using too much CPU power to keep DOSBox running at the current
+     speed. You can lower the cycles, skip frames, reduce the sampling rate of
+-    the respective sound device, increase the prebuffer. See section 13: "The
+-    configuration (options) file"
+-    If you are using cycles=max or =auto, then make sure that there is no
+-    background processes interfering! (especially if they access the harddisk)
+-    Also look at Section 10. "How to speed up/slow down DOSBox"
++    the respective sound device, increase the prebuffer. See Section 13: "The
++    configuration (options) file".
++    If you are using 'cycles=max' or 'cycles=auto', then make sure that there is
++    no background processes interfering! (especially if they access the harddisk)
++    Also look at Section 10: "How to speed up/slow down DOSBox" as well as
++    Section 11: "Troubleshooting".
+ 
+ 
+ KEYBOARD: I can't type \ or : in DOSBox.
+@@ -233,7 +234,7 @@
+     detected), or the key mapping is wrong.
+     Some possible fixes:
+       1. Use / instead, or ALT-58 for : and ALT-92 for \.
+-      2. Change the DOS keyboard layout (see Section 8: Keyboard Layout).
++      2. Change the DOS keyboard layout (see Section 8: "Keyboard Layout").
+       3. Add the commands you want to execute to the [autoexec] section
+          of the DOSBox configuration file.
+       4. Open the DOSBox configuration file and change the usescancodes entry.
+@@ -274,16 +275,16 @@
+ 
+ 
+ SPEED: The game/application runs much too slow/too fast!
+-    Look at the section 10: "How to speed up/slow down DOSBox" for more
++    Look at Section 10: "How to speed up/slow down DOSBox" for more
+     information.
+ 
+ 
+ CRASH: The game/application does not run at all/crashes!
+-    Look at Section 11: Troubleshooting
++    Look at Section 11: "Troubleshooting".
+ 
+ 
+-CRASH: DOSBox crashes on startup!.
+-    Look at Section 11: Troubleshooting
++CRASH: DOSBox crashes on startup!
++    Look at Section 11: "Troubleshooting".
+ 
+ 
+ GAME: My Build game(Duke3D/Blood/Shadow Warrior) has problems.
+@@ -302,7 +303,7 @@
+ 
+ 
+ OPTIONS: I would like to change DOSBox's options.
+-    Look at Section 13. "The configuration (options) file"
++    Look at Section 13: "The configuration (options) file".
+ 
+ 
+ HELP: Great Manual, but I still don't get it.
+@@ -319,12 +320,12 @@
+ 
+ An overview of the command line options you can give to DOSBox. Although
+ in most cases it is easier to use DOSBox's configuration file instead.
+-See: Section 13. "The configuration (options) file"
++See Section 13: "The configuration (options) file".
+ 
+ To be able to use Command Line Parameters:
+ (Windows)  open cmd.exe or command.com or edit the shortcut to dosbox.exe
+ (Linux)    use console
+-(MAC OS X) start terminal.app and navigate to:
++(Mac OS X) start terminal.app and navigate to:
+            /applications/dosbox.app/contents/macos/dosbox
+ 
+ The options are valid for all operating systems unless noted in the option
+@@ -368,24 +369,24 @@
+   -conf configfilelocation
+         Start DOSBox with the options specified in "configfilelocation".
+         Multiple -conf options may be present.
+-        See Section 13 for more details.
++        See Section 13: "The configuration (options) file" for more details.
+ 
+   -lang languagefilelocation
+         Start DOSBox using the language specified in "languagefilelocation".
+-        See Section 14 for more details.
++        See Section 14: "The Language File" for more details.
+ 
+   -machine machinetype
+         Setup DOSBox to emulate a specific type of machine. Valid choices are:
+         hercules, cga, ega, pcjr, tandy, svga_s3 (default) as well as
+-        the additional svga chipsets listed in the DOSBox configuration file.
+-        svga_s3 enables vesa emulation as well.
+-        For some special vga effects the machinetype vgaonly can be used,
+-        note that this disables svga capabilities and might be slower due to the
++        the additional SVGA chipsets listed in the DOSBox configuration file.
++        svga_s3 enables VESA emulation as well.
++        For some special VGA effects the machinetype vgaonly can be used,
++        note that this disables SVGA capabilities and might be slower due to the
+         higher emulation precision.
+         The machinetype affects the video card and the available sound cards.
+ 
+   -noconsole (Windows Only)
+-        Start DOSBox without showing DOSBox Status Window (console).
++        Start DOSBox without showing the DOSBox status window (console).
+         Output will be redirected to stdout.txt and stderr.txt
+ 
+   -startmapper
+@@ -525,7 +526,7 @@
+         Forces use of the SDL CD-ROM layer. Valid on all systems.
+ 
+   -usecd number
+-        Valid on all systems, under windows the -noioctl switch has to be
++        Valid on all systems, under Windows the -noioctl switch has to be
+         present to make use of the -usecd switch.
+         Enables to select the drive that should be used by SDL. Use this if
+         the wrong or no CD-ROM drive is mounted while using the SDL CD-ROM
+@@ -621,7 +622,19 @@
+ 
+ 
+ CONFIG -writeconf filelocation
++CONFIG -writeconf
++CONFIG -wcp filelocation
++CONFIG -wcd
+ CONFIG -writelang filelocation
++CONFIG -axadd
++CONFIG -axclear
++CONFIG -axtype
++CONFIG -r [parameters]
++CONFIG -l
++CONFIG -help
++CONFIG -help sections
++CONFIG -help section
++CONFIG -help section property
+ CONFIG -securemode
+ CONFIG -set "section property=value"
+ CONFIG -get "section property"
+@@ -632,20 +645,74 @@
+   be found in Section 13: "The configuration (options) file".
+ 
+   -writeconf filelocation
+-     Write the current configuration settings to a file in a specified location.
+-    "filelocation" is located on the local drive, not a mounted drive in DOSBox.
++     (or -wc filelocation)
++     Write the current configuration settings to a file in a specified location
++     relative to the DOSBox config directory. Relative and absolute paths are 
++     possible. "filelocation" is located on the local drive, not a mounted 
++     drive in DOSBox.
++     
+      The configuration file controls various settings of DOSBox:
+      the amount of emulated memory, the emulated sound cards and many more
+      things. It allows access to AUTOEXEC.BAT as well.
+      See Section 13: "The configuration (options) file" for more information.
+ 
++  -writeconf
++     (or -wc)
++     Write the configuration to the primary loaded config file.
++
++  -wcp filelocation
++     Write the current configuration settings to the specified file in or 
++     relative to the DOSBox program start directory. Realtive and absolute 
++     paths are possible. This is located on a drive on the host, not a mounted
++     drive in DOSBox. It is useful if you keep DOSBox on a removable media.
++     If file is omitted, the configuration will be written to dosbox.conf.
++     
++  -wcd
++     Write the current configuration to the default config file.
++        
++     
+   -writelang filelocation
++     (or -wl filelocation)
+      Write the current language settings to a file in a specified location.
+      "filelocation" is located on the local drive, not a mounted drive
+      in DOSBox. The language file controls all visible output of the internal
+      commands and the internal DOS.
+      See Section 14: "The Language File" for more information.
+ 
++  -axadd "line1" "line2" ...
++     Adds a command line to the autoexec section.
++
++  -axclear
++     Clears the autoexec section.
++     
++  -axtype
++     Prints the content of the autoexec section.
++
++  -r [parameters]
++     Restart DOSBox, either with the parameters that were used to start the
++     current instance or any that are appended.
++
++  -l 
++     lists DOSBox parameters:
++     - the configuration directory
++     - the config files that were used when starting this session
++     - the command line parameters DOSBox was started with
++
++  -h, -help, -?
++     Displays an overvie of the config commands.
++
++  -h, -help, -? sections
++     Displays the list of sections in the config file.
++  
++  -h, -help, -? section
++     Displays the list of properties contained in the specified section.
++     
++  -h, -help, -? section property
++     Shows information about the specified property in the specified section:
++     - purpose of the property
++     - possible values, current value, default value
++     - wether it can definitely not be changed at runtime
++       
+   -securemode
+      Switches DOSBox to a more secure mode. In this mode the internal
+      commands MOUNT, IMGMOUNT and BOOT won't work. It's not possible either
+@@ -654,7 +721,6 @@
+ 
+   -set "section property=value"
+      CONFIG will attempt to set the property to new value.
+-     Currently CONFIG can not report whether the command succeeded or not.
+ 
+   -get "section property"
+      The current value of the property is reported and stored in the
+@@ -670,11 +736,26 @@
+         config -writeconf c:\dosgames\dosbox.conf
+     2. To set the cpu cycles to 10000:
+         config -set "cpu cycles=10000"
+-    3. To turn ems memory emulation off:
+-        config -set "dos ems=off"
++    3. To turn EMS memory emulation off:
++        config -set "dos ems=false"
+     4. To check which cpu core is being used.
+         config -get "cpu core"
+-
++    5. To view the list of possible cpu cores:
++        config -help cpu core
++    6. To change the machine type and restart:
++        config -set "machine cga"
++        config -wc -r
++    7. To configure the autoexec section to auto-mount a directory at start:
++        config -axadd "mount c c:\dosgames" "c:"
++        config -wc
++    8. To create a specific config file in the config directory:
++        config -set "dos ems=false"
++        config -set "cpu cycles=10000"
++        config -set "core dynamic"
++        config -axadd "mount c c:\dosgames" "c:" "cd my_game" "my_game"
++        config -wc my_config.conf
++    9. To restart DOSBox from a specific config file in the config directory:
++        config -r -conf my_config.conf
+ 
+ LOADFIX [-size] [program] [program-parameters]
+ LOADFIX -f
+@@ -697,10 +778,19 @@
+        loadfix -f
+ 
+ 
+-RESCAN
++RESCAN [Drive:] [-All]
+   Make DOSBox reread the directory structure. Useful if you changed something
+   on a mounted drive outside of DOSBox. (CTRL - F4 does this as well!)
+-
++  
++  Drive: 
++        Drive to refresh.
++
++  -All
++        Refresh all drives.
++
++  if both a Drive: and -All are missing, then the current drive will be 
++  refreshed.
++  
+ 
+ MIXER
+   Makes DOSBox display its current volume settings.
+@@ -922,7 +1012,7 @@
+ KEYB [keyboardlayoutcode [codepage [codepagefile]]]
+ 
+   Change the keyboard layout. For detailed information about keyboard layouts
+-  please see Section 8: "Keyboard Layout"
++  please see Section 8: "Keyboard Layout".
+ 
+   [keyboardlayoutcode] is a string consisting of five or less characters,
+      examples are PL214 (Polish typists) or PL457 (Polish programmers).
+@@ -984,8 +1074,9 @@
+ CTRL-F11      Slow down emulation (Decrease DOSBox Cycles).
+ CTRL-F12      Speed up emulation (Increase DOSBox Cycles)*.
+ ALT-F12       Unlock speed (turbo button/fast forward)**.
+-F11, ALT-F11  (machine=cga) change tint in NTSC output modes***
+-F11           (machine=hercules) cycle through amber, green, white colouring***
++CTRL-ALT-HOME Restart DOSBox.
++F11, ALT-F11  (machine=cga) change tint in NTSC output modes***.
++F11           (machine=hercules) cycle through amber, green, white colouring***.
+ 
+ *NOTE: Once you increase your DOSBox cycles beyond your computer CPU resources,
+        it will produce the same effect as slowing down the emulation.
+@@ -999,15 +1090,16 @@
+          a different machine type. So either reassign them or reset the mapper.
+ 
+ These are the default keybindings. They can be changed in the keymapper
+-(see Section 7: KeyMapper). 
++(see Section 7: "KeyMapper"). 
+ 
+-In MAC OS you can try using cmd(applekey) together with Ctrl if the key doesn't
+-work eg. cmd-ctrl-F1, but some keys may still need remapping (in Linux too).
++In Mac OS X you can try using cmd(applekey) together with Ctrl (and/or ) Fn, 
++if the key doesn't work i.e. fn-cmd-ctrl-F1, but some keys may still need 
++remapping (in Linux too).
+ 
+ Saved/recorded files can be found in:
+    (Windows)    "Start/WinLogo Menu"->"All Programs"->DOSBox-0.74->Extras
+    (Linux)      ~/.dosbox/capture
+-   (MAC OS X)   "~/Library/Preferences/capture"
++   (Mac OS X)   "~/Library/Preferences/capture"
+ This can be changed in the DOSBox configuration file.
+ 
+ 
+@@ -1040,17 +1132,12 @@
+         than one button at the same time.
+ 
+ You also have to configure controller properly inside the game.
+-
+ It is important to remember that if you saved the mapperfile without joystick
+-
+-connected, or with a different joystick setting, your new setting will 
+-not work
+-properly, 
+-or not work at all, until you reset DOSBox's mapperfile.
+-
++connected, or with a different joystick setting, your new setting will not work
++properly, or not work at all, until you reset DOSBox's mapperfile.
+ 
+ If controller is working properly outside DOSBox, but doesn't calibrate properly
+-inside DOSBox, try different 'timed' setting in DOSBox's configuration file.
++inside DOSBox, try a different 'timed' setting in DOSBox's configuration file.
+ 
+ 
+ 
+@@ -1058,8 +1145,8 @@
+ 7. KeyMapper:
+ =============
+ 
+-You start the DOSBox mapper either with CTRL-F1 (see section 5. Special Keys)
+-or -startmapper (see Section 3. Command Line Parameters). 
++Start the DOSBox mapper either with CTRL-F1 (see Section 5: "Special Keys") or
++-startmapper (see Section 3: "Command Line Parameters"). 
+ You are presented with a virtual keyboard and a virtual joystick.
+ 
+ These virtual devices correspond to the keys and events DOSBox will
+@@ -1115,7 +1202,7 @@
+         mapped key X. Click "Del".
+ 
+ 
+-Examples about remapping the joystick:
++Examples of remapping the joystick:
+   You have a joystick attached, it is working fine under DOSBox and you
+   want to play some keyboard-only game with the joystick (it is assumed
+   that the game is controlled by the arrows on the keyboard):
+@@ -1137,7 +1224,7 @@
+ 
+   If you want to remap anything to your d-pad/hat you will have to change
+   'joysticktype=auto' to 'joysticktype=fcs' in configuration file. Maybe this
+-  will be improved in the next dosbox version.
++  will be improved in the next DOSBox version.
+ 
+ 
+ If you change the default mapping, you can save your changes by clicking on
+@@ -1152,12 +1239,12 @@
+ ===================
+ 
+ To switch to a different keyboard layout, either the entry "keyboardlayout"
+-in the [dos] section of the DOSBox configuration file can be used, or the
+-internal DOSBox program keyb.com (Section 4: Internal Programs)
+-Both accept DOS conforming language codes (see below),
+-but only by using keyb.com a custom codepage can be specified.
++in the [dos] section of the DOSBox configuration file or the internal DOSBox
++program keyb.com (Section 4: "Internal Programs") can be used. Both accept
++DOS conforming language codes (see below), but only by using keyb.com a
++custom codepage can be specified.
+ 
+-The default keyboardlayout=auto currently works under windows only. The language
++The default keyboardlayout=auto currently works under Windows only. The language
+ is chosen according to the OS language, but the keyboard layout is not detected.
+ 
+ Layout switching
+@@ -1230,7 +1317,7 @@
+  * port:         - TCP port number. Default: 23
+  * rxdelay:      - how long (milliseconds) to delay received data if the
+                    interface is not ready. Increase this value if you encounter
+-                   overrun errors in the DOSBox Status Window. Default: 100
++                   overrun errors in the DOSBox status window. Default: 100
+  * txdelay:      - how long to gather data before sending a packet. Default: 12
+                    (reduces Network overhead)
+  * server:       - This nullmodem will be a client connecting to the specified
+@@ -1269,8 +1356,8 @@
+   a different setting in the DOSBox's configuration file.
+ 
+   You can force the slow or fast behavior by setting a fixed amount of cycles
+-  in the DOSBox's configuration file. If you for example set cycles=10000, then
+-  DOSBox window will display a line "Cpu Speed: fixed 10000 cycles" at the top.
++  in the DOSBox's configuration file. If you set for example cycles=10000, the
++  DOSBox window will display a line "CPU speed: fixed 10000 cycles" at the top.
+   In this mode you can reduce the amount of cycles even more by hitting CTRL-F11
+   (you can go as low as you want) or raise it by hitting CTRL-F12 as much as you
+   want, but you will be limited by the power of one core of your computer's CPU.
+@@ -1285,8 +1372,8 @@
+ 
+   You can also force the fast behavior by setting cycles=max in the DOSBox
+   configuration file. The DOSBox window will display a line
+-  "Cpu Speed: max 100% cycles" at the top then. This time you won't have to care
+-  how much free time your real CPU's cores have, because DOSBox will always use
++  "CPU speed: max 100% cycles" at the top then. This time you won't have to care
++  how much free time your real CPU cores have, because DOSBox will always use
+   100% of your real CPU's one core. In this mode you can reduce the amount
+   of your real CPU's core usage by CTRL-F11 or raise it with CTRL-F12.
+ 
+@@ -1336,7 +1423,7 @@
+ ====================
+ 
+ General tip:
+-  Check messages in DOSBox Status Window. See section 12. "DOSBox Status Window"
++  Check messages in the DOSBox status window. See Section 12: "DOSBox Status Window".
+ 
+ DOSBox crashes right after starting it:
+   - use different values for the output= entry in your DOSBox
+@@ -1382,14 +1469,14 @@
+ 12. DOSBox Status Window:
+ =========================
+ 
+-DOSBox's Staus window contains many useful information about your currant
+-configuration, your actions in DOSBox, errors that happened and more.
+-Whenever you have any problem with DOSBox check these messages.
+-
+-To start DOSBox Status Window:
+-  (Windows)  Status Window is being started together with main DOSBox window.
+-  (Linux)    You may have to start DOSBox from a console to see Status Window.
+-  (MAC OS X) Right click on DOSBox.app, choose "Show Package Contents"->
++DOSBox's status window contains useful information about your current
++configuration, your actions in DOSBox, errors which occurred and more.
++Check these messages in case you encounter any problems with DOSBox.
++
++To display the DOSBox status window:
++  (Windows)  The status window is being started together with main DOSBox window.
++  (Linux)    You may have to start DOSBox from a console to see the status window.
++  (Mac OS X) Right click on DOSBox.app, choose "Show Package Contents"->
+              ->enter "Contents"->enter "MacOS"->run "DOSBox"
+ 
+ 
+@@ -1402,7 +1489,7 @@
+ The file can be found in:
+    (Windows)  "Start/WinLogo Menu"->"All Programs"->DOSBox-0.74->Options
+    (Linux)    ~/.dosbox/dosbox-0.74.conf
+-   (MAC OS X) "~/Library/Preferences/DOSBox 0.74 Preferences"
++   (Mac OS X) "~/Library/Preferences/DOSBox 0.74 Preferences"
+ The file is divided into several sections. Each section starts with a
+ [section name] line. The settings are the property=value lines where value can
+ be altered to customize DOSBox.
+diff -Nur dosbox-0.74/scripts/captures.bat dosbox/scripts/captures.bat
+--- dosbox-0.74/scripts/captures.bat	1970-01-01 01:00:00.000000000 +0100
++++ dosbox/scripts/captures.bat	2014-01-12 14:43:47.000000000 +0100
+@@ -0,0 +1 @@
++DOSBox.exe -opencaptures explorer.exe
+\ Kein Zeilenumbruch am Dateiende.
+diff -Nur dosbox-0.74/scripts/dosbox-installer.nsi dosbox/scripts/dosbox-installer.nsi
+--- dosbox-0.74/scripts/dosbox-installer.nsi	1970-01-01 01:00:00.000000000 +0100
++++ dosbox/scripts/dosbox-installer.nsi	2014-01-12 14:43:47.000000000 +0100
+@@ -0,0 +1,184 @@
++!define VER_MAYOR 0
++!define VER_MINOR 74
++!define APP_NAME "DOSBox ${VER_MAYOR}.${VER_MINOR} Installer"
++!define COMP_NAME "DOSBox Team"
++!define COPYRIGHT "Copyright  2002-2013 DOSBox Team"
++!define DESCRIPTION "DOSBox Installer"
++
++VIProductVersion "${VER_MAYOR}.${VER_MINOR}.0.0"
++VIAddVersionKey  "ProductName"  "${APP_NAME}"
++VIAddVersionKey  "CompanyName"  "${COMP_NAME}"
++VIAddVersionKey  "FileDescription"  "${DESCRIPTION}"
++VIAddVersionKey  "FileVersion"  "${VER_MAYOR}.${VER_MINOR}.0.0"
++VIAddVersionKey  "ProductVersion"  "${VER_MAYOR}, ${VER_MINOR}, 0, 0"
++VIAddVersionKey  "LegalCopyright"  "${COPYRIGHT}"
++
++; The name of the installer
++Name "${APP_NAME}"
++
++; The file to write
++OutFile "DOSBox${VER_MAYOR}.${VER_MINOR}-win32-installer.exe"
++
++; The default installation directory
++InstallDir "$PROGRAMFILES\DOSBox-${VER_MAYOR}.${VER_MINOR}"
++
++; The text to prompt the user to enter a directory
++DirText "This will install DOSBox v${VER_MAYOR}.${VER_MINOR} on your computer. Choose a directory"
++SetCompressor /solid lzma
++
++
++LicenseData COPYING
++LicenseText "DOSBox v${VER_MAYOR}.${VER_MINOR} License" "Next >"
++
++; Else vista enables compatibility mode
++RequestExecutionLevel admin
++; Shortcuts in all users
++
++ComponentText "Select components for DOSBox"
++; The stuff to install
++Section "!Core files" Core
++SetShellVarContext all
++
++  ; Set output path to the installation directory.
++  ClearErrors
++  SetOutPath $INSTDIR
++  IfErrors error_createdir
++  SectionIn RO
++
++  ; Put file there
++  
++  CreateDirectory "$INSTDIR\Video Codec"
++  CreateDirectory "$INSTDIR\Documentation"
++  SetOutPath "$INSTDIR\Documentation"
++  File /oname=README.txt README
++  File /oname=COPYING.txt COPYING
++  File /oname=THANKS.txt THANKS
++  File /oname=NEWS.txt NEWS
++  File /oname=AUTHORS.txt AUTHORS
++  File /oname=INSTALL.txt INSTALL
++  SetOutPath "$INSTDIR"
++
++  File "/oname=DOSBox ${VER_MAYOR}.${VER_MINOR} Manual.txt" README
++  File "/oname=DOSBox.exe" DOSBox.exe
++  File SDL.dll
++  File SDL_net.dll
++  File "/oname=Video Codec\zmbv.dll" zmbv.dll
++  File "/oname=Video Codec\zmbv.inf" zmbv.inf
++  File "/oname=Video Codec\Video Instructions.txt" README.video
++  File "/oname=DOSBox ${VER_MAYOR}.${VER_MINOR} Options.bat" editconf.bat
++  File "/oname=Reset KeyMapper.bat" resetmapper.bat
++  File "/oname=Reset Options.bat" resetconf.bat
++  File "/oname=Screenshots & Recordings.bat" captures.bat
++  
++  CreateDirectory "$SMPROGRAMS\DOSBox-${VER_MAYOR}.${VER_MINOR}"
++  CreateDirectory "$SMPROGRAMS\DOSBox-${VER_MAYOR}.${VER_MINOR}\Extras"
++  CreateDirectory "$SMPROGRAMS\DOSBox-${VER_MAYOR}.${VER_MINOR}\Extras\Video"
++  CreateDirectory "$SMPROGRAMS\DOSBox-${VER_MAYOR}.${VER_MINOR}\Options"
++  CreateShortCut "$SMPROGRAMS\DOSBox-${VER_MAYOR}.${VER_MINOR}\DOSBox ${VER_MAYOR}.${VER_MINOR}.lnk" "$INSTDIR\DOSBox.exe" "-userconf" "$INSTDIR\DOSBox.exe" 0
++  CreateShortCut "$SMPROGRAMS\DOSBox-${VER_MAYOR}.${VER_MINOR}\DOSBox ${VER_MAYOR}.${VER_MINOR} Manual.lnk" "$INSTDIR\Documentation\README.txt"
++  CreateShortCut "$SMPROGRAMS\DOSBox-${VER_MAYOR}.${VER_MINOR}\Extras\DOSBox ${VER_MAYOR}.${VER_MINOR} (noconsole).lnk" "$INSTDIR\DOSBox.exe" "-noconsole -userconf" "$INSTDIR\DOSBox.exe" 0
++  CreateShortCut "$SMPROGRAMS\DOSBox-${VER_MAYOR}.${VER_MINOR}\Extras\Uninstall.lnk" "$INSTDIR\uninstall.exe" "" "$INSTDIR\uninstall.exe" 0
++  CreateShortCut "$SMPROGRAMS\DOSBox-${VER_MAYOR}.${VER_MINOR}\Extras\Screenshots & Recordings.lnk" "$INSTDIR\DOSBox.exe" "-opencaptures explorer.exe"
++
++  CreateShortCut "$SMPROGRAMS\DOSBox-${VER_MAYOR}.${VER_MINOR}\Options\DOSBox ${VER_MAYOR}.${VER_MINOR} Options.lnk" "$INSTDIR\DOSBox.exe" "-editconf notepad.exe -editconf $\"%SystemRoot%\system32\notepad.exe$\" -editconf $\"%WINDIR%\notepad.exe$\""
++  CreateShortCut "$SMPROGRAMS\DOSBox-${VER_MAYOR}.${VER_MINOR}\Options\Reset Options.lnk" "$INSTDIR\DOSBox.exe" "-eraseconf"
++  CreateShortCut "$SMPROGRAMS\DOSBox-${VER_MAYOR}.${VER_MINOR}\Options\Reset KeyMapper.lnk" "$INSTDIR\DOSBox.exe" "-erasemapper"
++
++  CreateShortCut "$SMPROGRAMS\DOSBox-${VER_MAYOR}.${VER_MINOR}\Extras\Video\Video instructions.lnk" "$INSTDIR\Video Codec\Video Instructions.txt"
++;change outpath so the working directory gets set to zmbv
++SetOutPath "$INSTDIR\Video Codec"
++  ; Shortcut creation depends on wether we are 9x of NT
++  ClearErrors
++  ReadRegStr $R0 HKLM "SOFTWARE\Microsoft\Windows NT\CurrentVersion" CurrentVersion
++  IfErrors we_9x we_nt
++we_nt:
++  ;shortcut for win NT
++  CreateShortCut "$SMPROGRAMS\DOSBox-${VER_MAYOR}.${VER_MINOR}\Extras\Video\Install movie codec.lnk" "rundll32" "setupapi,InstallHinfSection DefaultInstall 128 $INSTDIR\Video Codec\zmbv.inf"
++  goto end
++we_9x:
++  ;shortcut for we_9x
++  CreateShortCut "$SMPROGRAMS\DOSBox-${VER_MAYOR}.${VER_MINOR}\Extras\Video\Install movie codec.lnk" "rundll" "setupx.dll,InstallHinfSection DefaultInstall 128 $INSTDIR\Video Codec\zmbv.inf"
++end:
++SetOutPath $INSTDIR
++WriteUninstaller "uninstall.exe"
++
++  goto end_section
++
++error_createdir:
++  MessageBox MB_OK "Can't create DOSBox program directory, aborting."
++  Abort
++  goto end_section
++
++end_section:
++SectionEnd ; end the section
++
++Section "Desktop Shortcut" SecDesktop
++SetShellVarContext all
++
++CreateShortCut "$DESKTOP\DOSBox ${VER_MAYOR}.${VER_MINOR}.lnk" "$INSTDIR\DOSBox.exe" "-userconf" "$INSTDIR\DOSBox.exe" 0
++
++SectionEnd ; end the section 
++
++
++UninstallText "This will uninstall DOSBox  v${VER_MAYOR}.${VER_MINOR}. Hit next to continue."
++
++Section "Uninstall"
++
++; Shortcuts in all users
++SetShellVarContext all
++
++  Delete "$DESKTOP\DOSBox ${VER_MAYOR}.${VER_MINOR}.lnk"
++  ; remove registry keys
++  ; remove files
++  Delete $INSTDIR\Documentation\README.txt
++  Delete $INSTDIR\Documentation\COPYING.txt
++  Delete $INSTDIR\Documentation\THANKS.txt
++  Delete $INSTDIR\Documentation\NEWS.txt
++  Delete $INSTDIR\Documentation\AUTHORS.txt
++  Delete $INSTDIR\Documentation\INSTALL.txt
++  Delete "$INSTDIR\DOSBox ${VER_MAYOR}.${VER_MINOR} Manual.txt"
++  Delete "$INSTDIR\DOSBox.exe"
++  Delete $INSTDIR\SDL.dll
++  Delete $INSTDIR\SDL_net.dll
++  Delete "$INSTDIR\Video Codec\zmbv.dll"
++  Delete "$INSTDIR\Video Codec\zmbv.inf"
++  Delete "$INSTDIR\Video Codec\Video Instructions.txt"
++  ;Files left by sdl taking over the console
++  Delete $INSTDIR\stdout.txt
++  Delete $INSTDIR\stderr.txt
++  Delete "$INSTDIR\DOSBox ${VER_MAYOR}.${VER_MINOR} Options.bat"
++  Delete "$INSTDIR\Reset KeyMapper.bat"
++  Delete "$INSTDIR\Reset Options.bat"
++  Delete "$INSTDIR\Screenshots & Recordings.bat"
++
++  ; MUST REMOVE UNINSTALLER, too
++  Delete $INSTDIR\uninstall.exe
++
++
++  Delete "$SMPROGRAMS\DOSBox-${VER_MAYOR}.${VER_MINOR}\DOSBox ${VER_MAYOR}.${VER_MINOR}.lnk"
++  Delete "$SMPROGRAMS\DOSBox-${VER_MAYOR}.${VER_MINOR}\DOSBox ${VER_MAYOR}.${VER_MINOR} Manual.lnk"
++  Delete "$SMPROGRAMS\DOSBox-${VER_MAYOR}.${VER_MINOR}\Extras\DOSBox ${VER_MAYOR}.${VER_MINOR} (noconsole).lnk"
++  Delete "$SMPROGRAMS\DOSBox-${VER_MAYOR}.${VER_MINOR}\Extras\Uninstall.lnk"
++  Delete "$SMPROGRAMS\DOSBox-${VER_MAYOR}.${VER_MINOR}\Extras\Screenshots & Recordings.lnk"
++
++  Delete "$SMPROGRAMS\DOSBox-${VER_MAYOR}.${VER_MINOR}\Options\DOSBox ${VER_MAYOR}.${VER_MINOR} Options.lnk"
++  Delete "$SMPROGRAMS\DOSBox-${VER_MAYOR}.${VER_MINOR}\Options\Reset Options.lnk"
++  Delete "$SMPROGRAMS\DOSBox-${VER_MAYOR}.${VER_MINOR}\Options\Reset KeyMapper.lnk"
++
++  Delete "$SMPROGRAMS\DOSBox-${VER_MAYOR}.${VER_MINOR}\Extras\Video\Video instructions.lnk"
++  Delete "$SMPROGRAMS\DOSBox-${VER_MAYOR}.${VER_MINOR}\Extras\Video\Install movie codec.lnk"
++
++
++
++; remove shortcuts, if any.
++; remove directories used.
++  RMDir "$INSTDIR\Documentation"
++  RMDir "$INSTDIR\Video Codec"
++  RMDir "$INSTDIR"
++  RMDir "$SMPROGRAMS\DOSBox-${VER_MAYOR}.${VER_MINOR}\Options"
++  RMDir "$SMPROGRAMS\DOSBox-${VER_MAYOR}.${VER_MINOR}\Extras\Video"
++  RMDir "$SMPROGRAMS\DOSBox-${VER_MAYOR}.${VER_MINOR}\Extras"
++  RMDir "$SMPROGRAMS\DOSBox-${VER_MAYOR}.${VER_MINOR}"
++SectionEnd
++
++; eof
+diff -Nur dosbox-0.74/scripts/editconf.bat dosbox/scripts/editconf.bat
+--- dosbox-0.74/scripts/editconf.bat	1970-01-01 01:00:00.000000000 +0100
++++ dosbox/scripts/editconf.bat	2014-01-12 14:43:47.000000000 +0100
+@@ -0,0 +1 @@
++DOSBox.exe -editconf notepad.exe -editconf %SystemRoot%\system32\notepad.exe -editconf %WINDIR%\notepad.exe
+\ Kein Zeilenumbruch am Dateiende.
+diff -Nur dosbox-0.74/scripts/ega-switch.pl dosbox/scripts/ega-switch.pl
+--- dosbox-0.74/scripts/ega-switch.pl	1970-01-01 01:00:00.000000000 +0100
++++ dosbox/scripts/ega-switch.pl	2014-01-12 14:43:47.000000000 +0100
+@@ -0,0 +1,32 @@
++#!/usr/bin/perl
++use integer;
++open (THEFILE,'>','../src/hardware/ega-switch.h')
++	or die "Can't open my file $!";
++
++print THEFILE "switch (bit_mask) {\n";
++for ($i = 0; $i < 256; $i++) {
++	print THEFILE "\tcase $i:\n";
++	$b=128;
++	$add=0;
++	do  {
++		if ($i & $b) {
++			print THEFILE "\t{\n";
++			print THEFILE "\t\tBit8u color=0;\n";
++			print THEFILE "\t\tif (pixels.b[0] & $b) color|=1;\n";
++			print THEFILE "\t\tif (pixels.b[1] & $b) color|=2;\n";
++			print THEFILE "\t\tif (pixels.b[2] & $b) color|=4;\n";
++			print THEFILE "\t\tif (pixels.b[3] & $b) color|=8;\n";
++			print THEFILE "\t\t*(write_pixels+$add)=color;\n";
++			print THEFILE "\t\t*(write_pixels+$add+512*1024)=color;\n";
++			print THEFILE "\t}\n";
++		}
++
++		$b=$b >> 1;
++		$add=$add+1;
++	} until ($b == 0);
++	print THEFILE "\tbreak;\n";
++} 
++print THEFILE "}\n";
++
++
++close (THEFILE);
+diff -Nur dosbox-0.74/scripts/font-switch.pl dosbox/scripts/font-switch.pl
+--- dosbox-0.74/scripts/font-switch.pl	1970-01-01 01:00:00.000000000 +0100
++++ dosbox/scripts/font-switch.pl	2014-01-12 14:43:47.000000000 +0100
+@@ -0,0 +1,25 @@
++#!/usr/bin/perl
++use integer;
++open (THEFILE,'>','../src/hardware/font-switch.h')
++	or die "Can't open my file $!";
++
++print THEFILE "switch (bit_mask) {\n";
++for ($i = 0; $i < 256; $i++) {
++	print THEFILE "\tcase $i:\n";
++	$b=128;
++	$add=0;
++	do  {
++		if ($i & $b) {
++			print THEFILE "\t\t*(draw+$add)=fg;\n";
++		} else {
++			print THEFILE "\t\t*(draw+$add)=bg;\n";
++		}
++		$b=$b >> 1;
++		$add=$add+1;
++	} until ($b == 0);
++	print THEFILE "\tbreak;\n";
++} 
++print THEFILE "}\n";
++
++
++close (THEFILE);
+diff -Nur dosbox-0.74/scripts/resetconf.bat dosbox/scripts/resetconf.bat
+--- dosbox-0.74/scripts/resetconf.bat	1970-01-01 01:00:00.000000000 +0100
++++ dosbox/scripts/resetconf.bat	2014-01-12 14:43:47.000000000 +0100
+@@ -0,0 +1 @@
++DOSBox.exe -resetconf
+\ Kein Zeilenumbruch am Dateiende.
+diff -Nur dosbox-0.74/scripts/resetmapper.bat dosbox/scripts/resetmapper.bat
+--- dosbox-0.74/scripts/resetmapper.bat	1970-01-01 01:00:00.000000000 +0100
++++ dosbox/scripts/resetmapper.bat	2014-01-12 14:43:47.000000000 +0100
+@@ -0,0 +1 @@
++DOSBox.exe -resetmapper
+\ Kein Zeilenumbruch am Dateiende.
+diff -Nur dosbox-0.74/src/cpu/callback.cpp dosbox/src/cpu/callback.cpp
+--- dosbox-0.74/src/cpu/callback.cpp	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/cpu/callback.cpp	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,7 +16,6 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: callback.cpp,v 1.42 2009-08-23 17:24:54 c2woody Exp $ */
+ 
+ #include <stdlib.h>
+ #include <string.h>
+@@ -46,7 +45,7 @@
+ 	for (Bitu i=1;(i<CB_MAX);i++) {
+ 		if (CallBack_Handlers[i]==&illegal_handler) {
+ 			CallBack_Handlers[i]=0;
+-			return i;	
++			return i;
+ 		}
+ 	}
+ 	E_Exit("CALLBACK:Can't allocate handler.");
+@@ -57,7 +56,7 @@
+ 	CallBack_Handlers[in]=&illegal_handler;
+ }
+ 
+-	
++
+ void CALLBACK_Idle(void) {
+ /* this makes the cpu execute instructions to handle irq's and then come back */
+ 	Bitu oldIF=GETFLAG(IF);
+@@ -65,12 +64,12 @@
+ 	Bit16u oldcs=SegValue(cs);
+ 	Bit32u oldeip=reg_eip;
+ 	SegSet16(cs,CB_SEG);
+-	reg_eip=call_idle*CB_SIZE;
++	reg_eip=CB_SOFFSET+call_idle*CB_SIZE;
+ 	DOSBOX_RunMachine();
+ 	reg_eip=oldeip;
+ 	SegSet16(cs,oldcs);
+ 	SETFLAGBIT(IF,oldIF);
+-	if (!CPU_CycleAutoAdjust && CPU_Cycles>0) 
++	if (!CPU_CycleAutoAdjust && CPU_Cycles>0)
+ 		CPU_Cycles=0;
+ }
+ 
+@@ -109,24 +108,24 @@
+ }
+ 
+ void CALLBACK_SZF(bool val) {
+-	Bit16u tempf = mem_readw(SegPhys(ss)+reg_sp+4); 
+-	if (val) tempf |= FLAG_ZF; 
+-	else tempf &= ~FLAG_ZF; 
+-	mem_writew(SegPhys(ss)+reg_sp+4,tempf); 
++	Bit16u tempf = mem_readw(SegPhys(ss)+reg_sp+4);
++	if (val) tempf |= FLAG_ZF;
++	else tempf &= ~FLAG_ZF;
++	mem_writew(SegPhys(ss)+reg_sp+4,tempf);
+ }
+ 
+ void CALLBACK_SCF(bool val) {
+-	Bit16u tempf = mem_readw(SegPhys(ss)+reg_sp+4); 
+-	if (val) tempf |= FLAG_CF; 
+-	else tempf &= ~FLAG_CF; 
+-	mem_writew(SegPhys(ss)+reg_sp+4,tempf); 
++	Bit16u tempf = mem_readw(SegPhys(ss)+reg_sp+4);
++	if (val) tempf |= FLAG_CF;
++	else tempf &= ~FLAG_CF;
++	mem_writew(SegPhys(ss)+reg_sp+4,tempf);
+ }
+ 
+ void CALLBACK_SIF(bool val) {
+-	Bit16u tempf = mem_readw(SegPhys(ss)+reg_sp+4); 
+-	if (val) tempf |= FLAG_IF; 
+-	else tempf &= ~FLAG_IF; 
+-	mem_writew(SegPhys(ss)+reg_sp+4,tempf); 
++	Bit16u tempf = mem_readw(SegPhys(ss)+reg_sp+4);
++	if (val) tempf |= FLAG_IF;
++	else tempf &= ~FLAG_IF;
++	mem_writew(SegPhys(ss)+reg_sp+4,tempf);
+ }
+ 
+ void CALLBACK_SetDescription(Bitu nr, const char* descr) {
+@@ -143,7 +142,7 @@
+ }
+ 
+ Bitu CALLBACK_SetupExtra(Bitu callback, Bitu type, PhysPt physAddress, bool use_cb=true) {
+-	if (callback>=CB_MAX) 
++	if (callback>=CB_MAX)
+ 		return 0;
+ 	switch (type) {
+ 	case CB_RETN:
+@@ -219,24 +218,25 @@
+ 		phys_writeb(physAddress+0x06,(Bit8u)0xcf);		//An IRET Instruction
+ 		return (use_cb?0x0b:0x07);
+ 	case CB_IRQ0:	// timer int8
++		phys_writeb(physAddress+0x00,(Bit8u)0xFB);		//STI
+ 		if (use_cb) {
+-			phys_writeb(physAddress+0x00,(Bit8u)0xFE);	//GRP 4
+-			phys_writeb(physAddress+0x01,(Bit8u)0x38);	//Extra Callback instruction
+-			phys_writew(physAddress+0x02,(Bit16u)callback);		//The immediate word
++			phys_writeb(physAddress+0x01,(Bit8u)0xFE);	//GRP 4
++			phys_writeb(physAddress+0x02,(Bit8u)0x38);	//Extra Callback instruction
++			phys_writew(physAddress+0x03,(Bit16u)callback);		//The immediate word
+ 			physAddress+=4;
+ 		}
+-		phys_writeb(physAddress+0x00,(Bit8u)0x50);		// push ax
+-		phys_writeb(physAddress+0x01,(Bit8u)0x52);		// push dx
+-		phys_writeb(physAddress+0x02,(Bit8u)0x1e);		// push ds
+-		phys_writew(physAddress+0x03,(Bit16u)0x1ccd);	// int 1c
+-		phys_writeb(physAddress+0x05,(Bit8u)0xfa);		// cli
+-		phys_writeb(physAddress+0x06,(Bit8u)0x1f);		// pop ds
+-		phys_writeb(physAddress+0x07,(Bit8u)0x5a);		// pop dx
+-		phys_writew(physAddress+0x08,(Bit16u)0x20b0);	// mov al, 0x20
+-		phys_writew(physAddress+0x0a,(Bit16u)0x20e6);	// out 0x20, al
++		phys_writeb(physAddress+0x01,(Bit8u)0x1e);		// push ds
++		phys_writeb(physAddress+0x02,(Bit8u)0x50);		// push ax
++		phys_writeb(physAddress+0x03,(Bit8u)0x52);		// push dx
++		phys_writew(physAddress+0x04,(Bit16u)0x1ccd);	// int 1c
++		phys_writeb(physAddress+0x06,(Bit8u)0xfa);		// cli
++		phys_writew(physAddress+0x07,(Bit16u)0x20b0);	// mov al, 0x20
++		phys_writew(physAddress+0x09,(Bit16u)0x20e6);	// out 0x20, al
++		phys_writeb(physAddress+0x0b,(Bit8u)0x5a);		// pop dx
+ 		phys_writeb(physAddress+0x0c,(Bit8u)0x58);		// pop ax
+-		phys_writeb(physAddress+0x0d,(Bit8u)0xcf);		//An IRET Instruction
+-		return (use_cb?0x12:0x0e);
++		phys_writeb(physAddress+0x0d,(Bit8u)0x1f);		// pop ds
++		phys_writeb(physAddress+0x0e,(Bit8u)0xcf);		//An IRET Instruction
++		return (use_cb?0x13:0x0f);
+ 	case CB_IRQ1:	// keyboard int9
+ 		phys_writeb(physAddress+0x00,(Bit8u)0x50);			// push ax
+ 		phys_writew(physAddress+0x01,(Bit16u)0x60e4);		// in al, 0x60
+@@ -351,12 +351,16 @@
+ 			phys_writew(physAddress+0x02,(Bit16u)callback);		//The immediate word
+ 			physAddress+=4;
+ 		}
+-		phys_writeb(physAddress+0x00,(Bit8u)0x50);		// push ax
+-		phys_writew(physAddress+0x01,(Bit16u)0x0eb4);	// mov ah, 0x0e
+-		phys_writew(physAddress+0x03,(Bit16u)0x10cd);	// int 10
+-		phys_writeb(physAddress+0x05,(Bit8u)0x58);		// pop ax
+-		phys_writeb(physAddress+0x06,(Bit8u)0xcf);		//An IRET Instruction
+-		return (use_cb?0x0b:0x07);
++		phys_writeb(physAddress+0x00,(Bit8u)0x50);	// push ax
++		phys_writeb(physAddress+0x01,(Bit8u)0x53);	// push bx
++		phys_writew(physAddress+0x02,(Bit16u)0x0eb4);	// mov ah, 0x0e
++		phys_writeb(physAddress+0x04,(Bit8u)0xbb);	// mov bx,
++		phys_writew(physAddress+0x05,(Bit16u)0x0007);	// 0x0007
++		phys_writew(physAddress+0x07,(Bit16u)0x10cd);	// int 10
++		phys_writeb(physAddress+0x09,(Bit8u)0x5b);	// pop bx
++		phys_writeb(physAddress+0x0a,(Bit8u)0x58);	// pop ax
++		phys_writeb(physAddress+0x0b,(Bit8u)0xcf);	//An IRET Instruction
++		return (use_cb?0x10:0x0c);
+ 	case CB_HOOKABLE:
+ 		phys_writeb(physAddress+0x00,(Bit8u)0xEB);		//jump near
+ 		phys_writeb(physAddress+0x01,(Bit8u)0x03);		//offset
+@@ -430,7 +434,18 @@
+ 		phys_writeb(physAddress+0x09,(Bit8u)0x59);		// pop cx
+ 		phys_writeb(physAddress+0x0A,(Bit8u)0xCF);		//An IRET Instruction
+ 		return (use_cb?15:11);
+-
++	case CB_INT13:
++		phys_writeb(physAddress+0x00,(Bit8u)0xFB);		//STI
++		if (use_cb) {
++			phys_writeb(physAddress+0x01,(Bit8u)0xFE);	//GRP 4
++			phys_writeb(physAddress+0x02,(Bit8u)0x38);	//Extra Callback instruction
++			phys_writew(physAddress+0x03,(Bit16u)callback);	//The immediate word
++			physAddress+=4;
++		}
++		phys_writeb(physAddress+0x01,(Bit8u)0xCF);		//An IRET Instruction
++		phys_writew(physAddress+0x02,(Bit16u)0x0ECD);		// int 0e
++		phys_writeb(physAddress+0x04,(Bit8u)0xCF);		//An IRET Instruction
++		return (use_cb?9:5);
+ 	default:
+ 		E_Exit("CALLBACK:Setup:Illegal type %d",type);
+ 	}
+@@ -456,19 +471,19 @@
+ }
+ 
+ void CALLBACK_RemoveSetup(Bitu callback) {
+-	for (Bitu i = 0;i < 16;i++) {
++	for (Bitu i = 0;i < CB_SIZE;i++) {
+ 		phys_writeb(CALLBACK_PhysPointer(callback)+i ,(Bit8u) 0x00);
+ 	}
+ }
+ 
+-CALLBACK_HandlerObject::~CALLBACK_HandlerObject(){
++void CALLBACK_HandlerObject::Uninstall(){
+ 	if(!installed) return;
+ 	if(m_type == CALLBACK_HandlerObject::SETUP) {
+ 		if(vectorhandler.installed){
+ 			//See if we are the current handler. if so restore the old one
+ 			if(RealGetVec(vectorhandler.interrupt) == Get_RealPointer()) {
+ 				RealSetVec(vectorhandler.interrupt,vectorhandler.old_vector);
+-			} else 
++			} else
+ 				LOG(LOG_MISC,LOG_WARN)("Interrupt vector changed on %X %s",vectorhandler.interrupt,CALLBACK_GetDescription(m_callback));
+ 		}
+ 		CALLBACK_RemoveSetup(m_callback);
+@@ -480,6 +495,11 @@
+ 	if(CallBack_Description[m_callback]) delete [] CallBack_Description[m_callback];
+ 	CallBack_Description[m_callback] = 0;
+ 	CALLBACK_DeAllocate(m_callback);
++	installed=false;
++}
++
++CALLBACK_HandlerObject::~CALLBACK_HandlerObject(){
++	Uninstall();
+ }
+ 
+ void CALLBACK_HandlerObject::Install(CallBack_Handler handler,Bitu type,const char* description){
+@@ -488,7 +508,7 @@
+ 		m_type=SETUP;
+ 		m_callback=CALLBACK_Allocate();
+ 		CALLBACK_Setup(m_callback,handler,type,description);
+-	} else E_Exit("Allready installed");
++	} else E_Exit("Callback handler object already installed");
+ }
+ void CALLBACK_HandlerObject::Install(CallBack_Handler handler,Bitu type,PhysPt addr,const char* description){
+ 	if(!installed) {
+@@ -496,7 +516,7 @@
+ 		m_type=SETUP;
+ 		m_callback=CALLBACK_Allocate();
+ 		CALLBACK_Setup(m_callback,handler,type,addr,description);
+-	} else E_Exit("Allready installed");
++	} else E_Exit("Callback handler object already installed");
+ }
+ 
+ void CALLBACK_HandlerObject::Allocate(CallBack_Handler handler,const char* description) {
+@@ -506,7 +526,7 @@
+ 		m_callback=CALLBACK_Allocate();
+ 		CALLBACK_SetDescription(m_callback,description);
+ 		CallBack_Handlers[m_callback]=handler;
+-	} else E_Exit("Allready installed");
++	} else E_Exit("Callback handler object already installed");
+ }
+ 
+ void CALLBACK_HandlerObject::Set_RealVec(Bit8u vec){
+@@ -545,7 +565,7 @@
+ 	CALLBACK_Setup(call_default,&default_handler,CB_IRET,"default");
+ 	call_default2=CALLBACK_Allocate();
+ 	CALLBACK_Setup(call_default2,&default_handler,CB_IRET,"default");
+-   
++
+ 	/* Only setup default handler for first part of interrupt table */
+ 	for (Bit16u ct=0;ct<0x60;ct++) {
+ 		real_writed(0,ct*4,CALLBACK_RealPointer(call_default));
+diff -Nur dosbox-0.74/src/cpu/core_dynrec/cache.h dosbox/src/cpu/core_dynrec/cache.h
+--- dosbox-0.74/src/cpu/core_dynrec/cache.h	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/cpu/core_dynrec/cache.h	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -53,7 +53,7 @@
+ 		CacheBlockDynRec * to;		// this block can transfer control to the to-block
+ 		CacheBlockDynRec * next;
+ 		CacheBlockDynRec * from;	// the from-block can transfer control to this block
+-	} link[2];	// maximal two links (conditional jumps)
++	} link[2];	// maximum two links (conditional jumps)
+ 	CacheBlockDynRec * crossblock;
+ };
+ 
+@@ -596,7 +596,7 @@
+ 			if(!cache_code_start_ptr) E_Exit("Allocating dynamic cache failed");
+ 
+ 			// align the cache at a page boundary
+-			cache_code=(Bit8u*)(((long)cache_code_start_ptr + PAGESIZE_TEMP-1) & ~(PAGESIZE_TEMP-1)); //MEM LEAK. store old pointer if you want to free it.
++			cache_code=(Bit8u*)(((Bitu)cache_code_start_ptr + PAGESIZE_TEMP-1) & ~(PAGESIZE_TEMP-1));//Bitu is same size as a pointer.
+ 
+ 			cache_code_link_blocks=cache_code;
+ 			cache_code=cache_code+PAGESIZE_TEMP;
+diff -Nur dosbox-0.74/src/cpu/core_dynrec/decoder_basic.h dosbox/src/cpu/core_dynrec/decoder_basic.h
+--- dosbox-0.74/src/cpu/core_dynrec/decoder_basic.h	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/cpu/core_dynrec/decoder_basic.h	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,7 +16,6 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: decoder_basic.h,v 1.16 2009-10-08 20:01:31 c2woody Exp $ */
+ 
+ 
+ /*
+@@ -491,7 +490,8 @@
+ 
+ // set reg_eip to the start of the next instruction plus an offset (imm)
+ static INLINE void dyn_set_eip_end(HostReg reg,Bit32u imm=0) {
+-	gen_mov_word_to_reg(reg,&reg_eip,decode.big_op);
++	gen_mov_word_to_reg(reg,&reg_eip,true); //get_extend_word will mask off the upper bits
++	//gen_mov_word_to_reg(reg,&reg_eip,decode.big_op);
+ 	gen_add_imm(reg,(Bit32u)(decode.code-decode.code_start+imm));
+ 	if (!decode.big_op) gen_extend_word(false,reg);
+ }
+diff -Nur dosbox-0.74/src/cpu/core_dynrec/decoder.h dosbox/src/cpu/core_dynrec/decoder.h
+--- dosbox-0.74/src/cpu/core_dynrec/decoder.h	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/cpu/core_dynrec/decoder.h	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,7 +16,6 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: decoder.h,v 1.8 2009-10-18 17:52:10 c2woody Exp $ */
+ 
+ 
+ #include "decoder_basic.h"
+@@ -27,7 +26,7 @@
+ 
+ /*
+ 	The function CreateCacheBlock translates the instruction stream
+-	until either an unhandled instruction is found, the maximal
++	until either an unhandled instruction is found, the maximum
+ 	number of translated instructions is reached or some critical
+ 	instruction is encountered.
+ */
+@@ -242,7 +241,9 @@
+ 				case 0xbf:dyn_movx_ev_gw(true);break;
+ 
+ 				default:
+-//					DYN_LOG("Unhandled dual opcode 0F%02X",dual_code);
++#if DYN_LOG
++//					LOG_MSG("Unhandled dual opcode 0F%02X",dual_code);
++#endif
+ 					goto illegalopcode;
+ 			}
+ 			break;
+@@ -579,11 +580,13 @@
+ 			break;
+ 
+ 		default:
+-//			DYN_LOG("Dynrec unhandled opcode %X",opcode);
++#if DYN_LOG
++//			LOG_MSG("Dynrec unhandled opcode %X",opcode);
++#endif
+ 			goto illegalopcode;
+ 		}
+ 	}
+-	// link to next block because the maximal number of opcodes has been reached
++	// link to next block because the maximum number of opcodes has been reached
+ 	dyn_set_eip_end();
+ 	dyn_reduce_cycles();
+ 	gen_jmp_ptr(&decode.block->link[0].to,offsetof(CacheBlockDynRec,cache.start));
+diff -Nur dosbox-0.74/src/cpu/core_dynrec/decoder_opcodes.h dosbox/src/cpu/core_dynrec/decoder_opcodes.h
+--- dosbox-0.74/src/cpu/core_dynrec/decoder_opcodes.h	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/cpu/core_dynrec/decoder_opcodes.h	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,7 +16,6 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: decoder_opcodes.h,v 1.10 2009-10-18 17:52:10 c2woody Exp $ */
+ 
+ 
+ /*
+diff -Nur dosbox-0.74/src/cpu/core_dynrec/dyn_fpu.h dosbox/src/cpu/core_dynrec/dyn_fpu.h
+--- dosbox-0.74/src/cpu/core_dynrec/dyn_fpu.h	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/cpu/core_dynrec/dyn_fpu.h	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,7 +16,6 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: dyn_fpu.h,v 1.8 2009-09-23 20:55:19 c2woody Exp $ */
+ 
+ 
+ #include "dosbox.h"
+@@ -535,7 +534,7 @@
+ 			gen_mov_word_to_reg(FC_OP1,(void*)(&TOP),true);
+ 			gen_call_function_R((void*)&FPU_SET_TOP,FC_OP1);
+ 			dyn_fill_ea(FC_OP1); 
+-			gen_mov_word_to_reg(FC_OP2,(void*)(&fpu.sw),true);
++			gen_mov_word_to_reg(FC_OP2,(void*)(&fpu.sw),false);
+ 			gen_call_function_RR((void*)&mem_writew,FC_OP1,FC_OP2);
+ 			break;
+ 		default:
+diff -Nur dosbox-0.74/src/cpu/core_dynrec/Makefile.am dosbox/src/cpu/core_dynrec/Makefile.am
+--- dosbox-0.74/src/cpu/core_dynrec/Makefile.am	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/cpu/core_dynrec/Makefile.am	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ noinst_HEADERS = cache.h decoder.h decoder_basic.h decoder_opcodes.h \
+                  dyn_fpu.h operators.h risc_x64.h risc_x86.h risc_mipsel32.h \
+                  risc_armv4le.h risc_armv4le-common.h \
+-                 risc_armv4le-s3.h risc_armv4le-o3.h risc_armv4le-thumb.h \
++                 risc_armv4le-o3.h risc_armv4le-thumb.h \
+                  risc_armv4le-thumb-iw.h risc_armv4le-thumb-niw.h
+diff -Nur dosbox-0.74/src/cpu/core_dynrec/Makefile.in dosbox/src/cpu/core_dynrec/Makefile.in
+--- dosbox-0.74/src/cpu/core_dynrec/Makefile.in	2010-05-12 11:57:43.000000000 +0200
++++ dosbox/src/cpu/core_dynrec/Makefile.in	1970-01-01 01:00:00.000000000 +0100
+@@ -1,393 +0,0 @@
+-# Makefile.in generated by automake 1.11.1 from Makefile.am.
+-# @configure_input@
+-
+-# Copyright (C) 1994, 1995, 1996, 1997, 1998, 1999, 2000, 2001, 2002,
+-# 2003, 2004, 2005, 2006, 2007, 2008, 2009  Free Software Foundation,
+-# Inc.
+-# This Makefile.in is free software; the Free Software Foundation
+-# gives unlimited permission to copy and/or distribute it,
+-# with or without modifications, as long as this notice is preserved.
+-
+-# This program is distributed in the hope that it will be useful,
+-# but WITHOUT ANY WARRANTY, to the extent permitted by law; without
+-# even the implied warranty of MERCHANTABILITY or FITNESS FOR A
+-# PARTICULAR PURPOSE.
+-
+-@SET_MAKE@
+-
+-VPATH = @srcdir@
+-pkgdatadir = $(datadir)/@PACKAGE@
+-pkgincludedir = $(includedir)/@PACKAGE@
+-pkglibdir = $(libdir)/@PACKAGE@
+-pkglibexecdir = $(libexecdir)/@PACKAGE@
+-am__cd = CDPATH="$${ZSH_VERSION+.}$(PATH_SEPARATOR)" && cd
+-install_sh_DATA = $(install_sh) -c -m 644
+-install_sh_PROGRAM = $(install_sh) -c
+-install_sh_SCRIPT = $(install_sh) -c
+-INSTALL_HEADER = $(INSTALL_DATA)
+-transform = $(program_transform_name)
+-NORMAL_INSTALL = :
+-PRE_INSTALL = :
+-POST_INSTALL = :
+-NORMAL_UNINSTALL = :
+-PRE_UNINSTALL = :
+-POST_UNINSTALL = :
+-build_triplet = @build@
+-host_triplet = @host@
+-subdir = src/cpu/core_dynrec
+-DIST_COMMON = $(noinst_HEADERS) $(srcdir)/Makefile.am \
+-	$(srcdir)/Makefile.in
+-ACLOCAL_M4 = $(top_srcdir)/aclocal.m4
+-am__aclocal_m4_deps = $(top_srcdir)/acinclude.m4 \
+-	$(top_srcdir)/configure.in
+-am__configure_deps = $(am__aclocal_m4_deps) $(CONFIGURE_DEPENDENCIES) \
+-	$(ACLOCAL_M4)
+-mkinstalldirs = $(install_sh) -d
+-CONFIG_HEADER = $(top_builddir)/config.h
+-CONFIG_CLEAN_FILES =
+-CONFIG_CLEAN_VPATH_FILES =
+-SOURCES =
+-DIST_SOURCES =
+-HEADERS = $(noinst_HEADERS)
+-ETAGS = etags
+-CTAGS = ctags
+-DISTFILES = $(DIST_COMMON) $(DIST_SOURCES) $(TEXINFOS) $(EXTRA_DIST)
+-ACLOCAL = @ACLOCAL@
+-ALSA_CFLAGS = @ALSA_CFLAGS@
+-ALSA_LIBS = @ALSA_LIBS@
+-AMTAR = @AMTAR@
+-AUTOCONF = @AUTOCONF@
+-AUTOHEADER = @AUTOHEADER@
+-AUTOMAKE = @AUTOMAKE@
+-AWK = @AWK@
+-CC = @CC@
+-CCDEPMODE = @CCDEPMODE@
+-CFLAGS = @CFLAGS@
+-CPP = @CPP@
+-CPPFLAGS = @CPPFLAGS@
+-CXX = @CXX@
+-CXXDEPMODE = @CXXDEPMODE@
+-CXXFLAGS = @CXXFLAGS@
+-CYGPATH_W = @CYGPATH_W@
+-DEFS = @DEFS@
+-DEPDIR = @DEPDIR@
+-ECHO_C = @ECHO_C@
+-ECHO_N = @ECHO_N@
+-ECHO_T = @ECHO_T@
+-EGREP = @EGREP@
+-EXEEXT = @EXEEXT@
+-GREP = @GREP@
+-INSTALL = @INSTALL@
+-INSTALL_DATA = @INSTALL_DATA@
+-INSTALL_PROGRAM = @INSTALL_PROGRAM@
+-INSTALL_SCRIPT = @INSTALL_SCRIPT@
+-INSTALL_STRIP_PROGRAM = @INSTALL_STRIP_PROGRAM@
+-LDFLAGS = @LDFLAGS@
+-LIBOBJS = @LIBOBJS@
+-LIBS = @LIBS@
+-LTLIBOBJS = @LTLIBOBJS@
+-MAKEINFO = @MAKEINFO@
+-MKDIR_P = @MKDIR_P@
+-OBJEXT = @OBJEXT@
+-PACKAGE = @PACKAGE@
+-PACKAGE_BUGREPORT = @PACKAGE_BUGREPORT@
+-PACKAGE_NAME = @PACKAGE_NAME@
+-PACKAGE_STRING = @PACKAGE_STRING@
+-PACKAGE_TARNAME = @PACKAGE_TARNAME@
+-PACKAGE_URL = @PACKAGE_URL@
+-PACKAGE_VERSION = @PACKAGE_VERSION@
+-PATH_SEPARATOR = @PATH_SEPARATOR@
+-RANLIB = @RANLIB@
+-SDL_CFLAGS = @SDL_CFLAGS@
+-SDL_CONFIG = @SDL_CONFIG@
+-SDL_LIBS = @SDL_LIBS@
+-SET_MAKE = @SET_MAKE@
+-SHELL = @SHELL@
+-STRIP = @STRIP@
+-VERSION = @VERSION@
+-WINDRES = @WINDRES@
+-abs_builddir = @abs_builddir@
+-abs_srcdir = @abs_srcdir@
+-abs_top_builddir = @abs_top_builddir@
+-abs_top_srcdir = @abs_top_srcdir@
+-ac_ct_CC = @ac_ct_CC@
+-ac_ct_CXX = @ac_ct_CXX@
+-am__include = @am__include@
+-am__leading_dot = @am__leading_dot@
+-am__quote = @am__quote@
+-am__tar = @am__tar@
+-am__untar = @am__untar@
+-bindir = @bindir@
+-build = @build@
+-build_alias = @build_alias@
+-build_cpu = @build_cpu@
+-build_os = @build_os@
+-build_vendor = @build_vendor@
+-builddir = @builddir@
+-datadir = @datadir@
+-datarootdir = @datarootdir@
+-docdir = @docdir@
+-dvidir = @dvidir@
+-exec_prefix = @exec_prefix@
+-host = @host@
+-host_alias = @host_alias@
+-host_cpu = @host_cpu@
+-host_os = @host_os@
+-host_vendor = @host_vendor@
+-htmldir = @htmldir@
+-includedir = @includedir@
+-infodir = @infodir@
+-install_sh = @install_sh@
+-libdir = @libdir@
+-libexecdir = @libexecdir@
+-localedir = @localedir@
+-localstatedir = @localstatedir@
+-mandir = @mandir@
+-mkdir_p = @mkdir_p@
+-oldincludedir = @oldincludedir@
+-pdfdir = @pdfdir@
+-prefix = @prefix@
+-program_transform_name = @program_transform_name@
+-psdir = @psdir@
+-sbindir = @sbindir@
+-sharedstatedir = @sharedstatedir@
+-srcdir = @srcdir@
+-sysconfdir = @sysconfdir@
+-target_alias = @target_alias@
+-top_build_prefix = @top_build_prefix@
+-top_builddir = @top_builddir@
+-top_srcdir = @top_srcdir@
+-noinst_HEADERS = cache.h decoder.h decoder_basic.h decoder_opcodes.h \
+-                 dyn_fpu.h operators.h risc_x64.h risc_x86.h risc_mipsel32.h \
+-                 risc_armv4le.h risc_armv4le-common.h \
+-                 risc_armv4le-s3.h risc_armv4le-o3.h risc_armv4le-thumb.h \
+-                 risc_armv4le-thumb-iw.h risc_armv4le-thumb-niw.h
+-
+-all: all-am
+-
+-.SUFFIXES:
+-$(srcdir)/Makefile.in:  $(srcdir)/Makefile.am  $(am__configure_deps)
+-	@for dep in $?; do \
+-	  case '$(am__configure_deps)' in \
+-	    *$$dep*) \
+-	      ( cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh ) \
+-	        && { if test -f $@; then exit 0; else break; fi; }; \
+-	      exit 1;; \
+-	  esac; \
+-	done; \
+-	echo ' cd $(top_srcdir) && $(AUTOMAKE) --gnu src/cpu/core_dynrec/Makefile'; \
+-	$(am__cd) $(top_srcdir) && \
+-	  $(AUTOMAKE) --gnu src/cpu/core_dynrec/Makefile
+-.PRECIOUS: Makefile
+-Makefile: $(srcdir)/Makefile.in $(top_builddir)/config.status
+-	@case '$?' in \
+-	  *config.status*) \
+-	    cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh;; \
+-	  *) \
+-	    echo ' cd $(top_builddir) && $(SHELL) ./config.status $(subdir)/$@ $(am__depfiles_maybe)'; \
+-	    cd $(top_builddir) && $(SHELL) ./config.status $(subdir)/$@ $(am__depfiles_maybe);; \
+-	esac;
+-
+-$(top_builddir)/config.status: $(top_srcdir)/configure $(CONFIG_STATUS_DEPENDENCIES)
+-	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
+-
+-$(top_srcdir)/configure:  $(am__configure_deps)
+-	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
+-$(ACLOCAL_M4):  $(am__aclocal_m4_deps)
+-	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
+-$(am__aclocal_m4_deps):
+-
+-ID: $(HEADERS) $(SOURCES) $(LISP) $(TAGS_FILES)
+-	list='$(SOURCES) $(HEADERS) $(LISP) $(TAGS_FILES)'; \
+-	unique=`for i in $$list; do \
+-	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
+-	  done | \
+-	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
+-	      END { if (nonempty) { for (i in files) print i; }; }'`; \
+-	mkid -fID $$unique
+-tags: TAGS
+-
+-TAGS:  $(HEADERS) $(SOURCES)  $(TAGS_DEPENDENCIES) \
+-		$(TAGS_FILES) $(LISP)
+-	set x; \
+-	here=`pwd`; \
+-	list='$(SOURCES) $(HEADERS)  $(LISP) $(TAGS_FILES)'; \
+-	unique=`for i in $$list; do \
+-	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
+-	  done | \
+-	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
+-	      END { if (nonempty) { for (i in files) print i; }; }'`; \
+-	shift; \
+-	if test -z "$(ETAGS_ARGS)$$*$$unique"; then :; else \
+-	  test -n "$$unique" || unique=$$empty_fix; \
+-	  if test $$# -gt 0; then \
+-	    $(ETAGS) $(ETAGSFLAGS) $(AM_ETAGSFLAGS) $(ETAGS_ARGS) \
+-	      "$$@" $$unique; \
+-	  else \
+-	    $(ETAGS) $(ETAGSFLAGS) $(AM_ETAGSFLAGS) $(ETAGS_ARGS) \
+-	      $$unique; \
+-	  fi; \
+-	fi
+-ctags: CTAGS
+-CTAGS:  $(HEADERS) $(SOURCES)  $(TAGS_DEPENDENCIES) \
+-		$(TAGS_FILES) $(LISP)
+-	list='$(SOURCES) $(HEADERS)  $(LISP) $(TAGS_FILES)'; \
+-	unique=`for i in $$list; do \
+-	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
+-	  done | \
+-	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
+-	      END { if (nonempty) { for (i in files) print i; }; }'`; \
+-	test -z "$(CTAGS_ARGS)$$unique" \
+-	  || $(CTAGS) $(CTAGSFLAGS) $(AM_CTAGSFLAGS) $(CTAGS_ARGS) \
+-	     $$unique
+-
+-GTAGS:
+-	here=`$(am__cd) $(top_builddir) && pwd` \
+-	  && $(am__cd) $(top_srcdir) \
+-	  && gtags -i $(GTAGS_ARGS) "$$here"
+-
+-distclean-tags:
+-	-rm -f TAGS ID GTAGS GRTAGS GSYMS GPATH tags
+-
+-distdir: $(DISTFILES)
+-	@srcdirstrip=`echo "$(srcdir)" | sed 's/[].[^$$\\*]/\\\\&/g'`; \
+-	topsrcdirstrip=`echo "$(top_srcdir)" | sed 's/[].[^$$\\*]/\\\\&/g'`; \
+-	list='$(DISTFILES)'; \
+-	  dist_files=`for file in $$list; do echo $$file; done | \
+-	  sed -e "s|^$$srcdirstrip/||;t" \
+-	      -e "s|^$$topsrcdirstrip/|$(top_builddir)/|;t"`; \
+-	case $$dist_files in \
+-	  */*) $(MKDIR_P) `echo "$$dist_files" | \
+-			   sed '/\//!d;s|^|$(distdir)/|;s,/[^/]*$$,,' | \
+-			   sort -u` ;; \
+-	esac; \
+-	for file in $$dist_files; do \
+-	  if test -f $$file || test -d $$file; then d=.; else d=$(srcdir); fi; \
+-	  if test -d $$d/$$file; then \
+-	    dir=`echo "/$$file" | sed -e 's,/[^/]*$$,,'`; \
+-	    if test -d "$(distdir)/$$file"; then \
+-	      find "$(distdir)/$$file" -type d ! -perm -700 -exec chmod u+rwx {} \;; \
+-	    fi; \
+-	    if test -d $(srcdir)/$$file && test $$d != $(srcdir); then \
+-	      cp -fpR $(srcdir)/$$file "$(distdir)$$dir" || exit 1; \
+-	      find "$(distdir)/$$file" -type d ! -perm -700 -exec chmod u+rwx {} \;; \
+-	    fi; \
+-	    cp -fpR $$d/$$file "$(distdir)$$dir" || exit 1; \
+-	  else \
+-	    test -f "$(distdir)/$$file" \
+-	    || cp -p $$d/$$file "$(distdir)/$$file" \
+-	    || exit 1; \
+-	  fi; \
+-	done
+-check-am: all-am
+-check: check-am
+-all-am: Makefile $(HEADERS)
+-installdirs:
+-install: install-am
+-install-exec: install-exec-am
+-install-data: install-data-am
+-uninstall: uninstall-am
+-
+-install-am: all-am
+-	@$(MAKE) $(AM_MAKEFLAGS) install-exec-am install-data-am
+-
+-installcheck: installcheck-am
+-install-strip:
+-	$(MAKE) $(AM_MAKEFLAGS) INSTALL_PROGRAM="$(INSTALL_STRIP_PROGRAM)" \
+-	  install_sh_PROGRAM="$(INSTALL_STRIP_PROGRAM)" INSTALL_STRIP_FLAG=-s \
+-	  `test -z '$(STRIP)' || \
+-	    echo "INSTALL_PROGRAM_ENV=STRIPPROG='$(STRIP)'"` install
+-mostlyclean-generic:
+-
+-clean-generic:
+-
+-distclean-generic:
+-	-test -z "$(CONFIG_CLEAN_FILES)" || rm -f $(CONFIG_CLEAN_FILES)
+-	-test . = "$(srcdir)" || test -z "$(CONFIG_CLEAN_VPATH_FILES)" || rm -f $(CONFIG_CLEAN_VPATH_FILES)
+-
+-maintainer-clean-generic:
+-	@echo "This command is intended for maintainers to use"
+-	@echo "it deletes files that may require special tools to rebuild."
+-clean: clean-am
+-
+-clean-am: clean-generic mostlyclean-am
+-
+-distclean: distclean-am
+-	-rm -f Makefile
+-distclean-am: clean-am distclean-generic distclean-tags
+-
+-dvi: dvi-am
+-
+-dvi-am:
+-
+-html: html-am
+-
+-html-am:
+-
+-info: info-am
+-
+-info-am:
+-
+-install-data-am:
+-
+-install-dvi: install-dvi-am
+-
+-install-dvi-am:
+-
+-install-exec-am:
+-
+-install-html: install-html-am
+-
+-install-html-am:
+-
+-install-info: install-info-am
+-
+-install-info-am:
+-
+-install-man:
+-
+-install-pdf: install-pdf-am
+-
+-install-pdf-am:
+-
+-install-ps: install-ps-am
+-
+-install-ps-am:
+-
+-installcheck-am:
+-
+-maintainer-clean: maintainer-clean-am
+-	-rm -f Makefile
+-maintainer-clean-am: distclean-am maintainer-clean-generic
+-
+-mostlyclean: mostlyclean-am
+-
+-mostlyclean-am: mostlyclean-generic
+-
+-pdf: pdf-am
+-
+-pdf-am:
+-
+-ps: ps-am
+-
+-ps-am:
+-
+-uninstall-am:
+-
+-.MAKE: install-am install-strip
+-
+-.PHONY: CTAGS GTAGS all all-am check check-am clean clean-generic \
+-	ctags distclean distclean-generic distclean-tags distdir dvi \
+-	dvi-am html html-am info info-am install install-am \
+-	install-data install-data-am install-dvi install-dvi-am \
+-	install-exec install-exec-am install-html install-html-am \
+-	install-info install-info-am install-man install-pdf \
+-	install-pdf-am install-ps install-ps-am install-strip \
+-	installcheck installcheck-am installdirs maintainer-clean \
+-	maintainer-clean-generic mostlyclean mostlyclean-generic pdf \
+-	pdf-am ps ps-am tags uninstall uninstall-am
+-
+-
+-# Tell versions [3.59,3.63) of GNU make to not export all variables.
+-# Otherwise a system limit (for SysV at least) may be exceeded.
+-.NOEXPORT:
+diff -Nur dosbox-0.74/src/cpu/core_dynrec/operators.h dosbox/src/cpu/core_dynrec/operators.h
+--- dosbox-0.74/src/cpu/core_dynrec/operators.h	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/cpu/core_dynrec/operators.h	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,7 +16,6 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: operators.h,v 1.8 2009-06-25 19:31:43 c2woody Exp $ */
+ 
+ 
+ static Bit8u DRC_CALL_CONV dynrec_add_byte(Bit8u op1,Bit8u op2) DRC_FC;
+diff -Nur dosbox-0.74/src/cpu/core_dynrec/risc_armv4le-common.h dosbox/src/cpu/core_dynrec/risc_armv4le-common.h
+--- dosbox-0.74/src/cpu/core_dynrec/risc_armv4le-common.h	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/cpu/core_dynrec/risc_armv4le-common.h	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,7 +16,6 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: risc_armv4le-common.h,v 1.3 2009-05-16 21:52:47 c2woody Exp $ */
+ 
+ 
+ /* ARMv4 (little endian) backend by M-HT (common data/functions) */
+diff -Nur dosbox-0.74/src/cpu/core_dynrec/risc_armv4le.h dosbox/src/cpu/core_dynrec/risc_armv4le.h
+--- dosbox-0.74/src/cpu/core_dynrec/risc_armv4le.h	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/cpu/core_dynrec/risc_armv4le.h	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,16 +16,21 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: risc_armv4le.h,v 1.3 2009-05-27 09:15:41 qbix79 Exp $ */
+ 
+ 
+-/* ARMv4 (little endian) backend (switcher) by M-HT */
++/* ARMv4/ARMv7 (little endian) backend (switcher) by M-HT */
+ 
+ #include "risc_armv4le-common.h"
+ 
+ // choose your destiny:
+-#include "risc_armv4le-thumb-niw.h"
+-//#include "risc_armv4le-thumb-iw.h"
+-//#include "risc_armv4le-thumb.h"
+-//#include "risc_armv4le-s3.h"
+-//#include "risc_armv4le-o3.h"
++#if C_TARGETCPU == ARMV7LE
++	#include "risc_armv4le-o3.h"
++#else
++	#if defined(__THUMB_INTERWORK__)
++		#include "risc_armv4le-thumb-iw.h"
++	#else
++		#include "risc_armv4le-o3.h"
++//		#include "risc_armv4le-thumb-niw.h"
++//		#include "risc_armv4le-thumb.h"
++	#endif
++#endif
+diff -Nur dosbox-0.74/src/cpu/core_dynrec/risc_armv4le-o3.h dosbox/src/cpu/core_dynrec/risc_armv4le-o3.h
+--- dosbox-0.74/src/cpu/core_dynrec/risc_armv4le-o3.h	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/cpu/core_dynrec/risc_armv4le-o3.h	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,10 +16,9 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: risc_armv4le-o3.h,v 1.6 2009-06-27 12:51:10 c2woody Exp $ */
+ 
+ 
+-/* ARMv4 (little endian) backend by M-HT (size-tweaked arm version) */
++/* ARMv4/ARMv7 (little endian) backend by M-HT (arm version) */
+ 
+ 
+ // temporary registers
+@@ -51,15 +50,14 @@
+ // temporary register for LEA
+ #define TEMP_REG_DRC HOST_v2
+ 
+-#ifdef DRC_USE_REGS_ADDR
+ // used to hold the address of "cpu_regs" - preferably filled in function gen_run_code
+ #define FC_REGS_ADDR HOST_v7
+-#endif
+ 
+-#ifdef DRC_USE_SEGS_ADDR
+ // used to hold the address of "Segs" - preferably filled in function gen_run_code
+ #define FC_SEGS_ADDR HOST_v8
+-#endif
++
++// used to hold the address of "core_dynrec.readdata" - filled in function gen_run_code
++#define readdata_addr HOST_v5
+ 
+ 
+ // helper macro
+@@ -89,6 +87,12 @@
+ #define MOV_REG_ROR_REG(dst, src, rreg) (0xe1a00070 + ((dst) << 12) + (src) + ((rreg) << 8) )
+ // mvn dst, #(imm ror rimm)		@	0 <= imm <= 255	&	rimm mod 2 = 0
+ #define MVN_IMM(dst, imm, rimm) (0xe3e00000 + ((dst) << 12) + (imm) + ((rimm) << 7) )
++#if C_TARGETCPU == ARMV7LE
++// movw dst, #imm		@	0 <= imm <= 65535
++#define MOVW(dst, imm) (0xe3000000 + ((dst) << 12) + (((imm) & 0xf000) << 4) + ((imm) & 0x0fff) )
++// movt dst, #imm		@	0 <= imm <= 65535
++#define MOVT(dst, imm) (0xe3400000 + ((dst) << 12) + (((imm) & 0xf000) << 4) + ((imm) & 0x0fff) )
++#endif
+ 
+ // arithmetic
+ // add dst, src, #(imm ror rimm)		@	0 <= imm <= 255	&	rimm mod 2 = 0
+@@ -104,7 +108,11 @@
+ // cmp src, #(imm ror rimm)		@	0 <= imm <= 255	&	rimm mod 2 = 0
+ #define CMP_IMM(src, imm, rimm) (0xe3500000 + ((src) << 16) + (imm) + ((rimm) << 7) )
+ // nop
++#if C_TARGETCPU == ARMV7LE
++#define NOP (0xe320f000)
++#else
+ #define NOP MOV_REG_LSL_IMM(HOST_r0, HOST_r0, 0)
++#endif
+ 
+ // logical
+ // tst src, #(imm ror rimm)		@	0 <= imm <= 255	&	rimm mod 2 = 0
+@@ -123,34 +131,70 @@
+ #define EOR_REG_LSL_IMM(dst, src1, src2, imm) (0xe0200000 + ((dst) << 12) + ((src1) << 16) + (src2) + ((imm) << 7) )
+ // bic dst, src, #(imm ror rimm)		@	0 <= imm <= 255	&	rimm mod 2 = 0
+ #define BIC_IMM(dst, src, imm, rimm) (0xe3c00000 + ((dst) << 12) + ((src) << 16) + (imm) + ((rimm) << 7) )
++// bic dst, src1, src2, lsl #imm		@	0 <= imm <= 31
++#define BIC_REG_LSL_IMM(dst, src1, src2, imm) (0xe1c00000 + ((dst) << 12) + ((src1) << 16) + (src2) + ((imm) << 7) )
+ 
+ // load
+ // ldr reg, [addr, #imm]		@	0 <= imm < 4096
+ #define LDR_IMM(reg, addr, imm) (0xe5900000 + ((reg) << 12) + ((addr) << 16) + (imm) )
++// ldr reg, [addr, #-(imm)]		@	0 <= imm < 4096
++#define LDR_IMM_M(reg, addr, imm) (0xe5100000 + ((reg) << 12) + ((addr) << 16) + (imm) )
+ // ldrh reg, [addr, #imm]		@	0 <= imm < 256
+ #define LDRH_IMM(reg, addr, imm) (0xe1d000b0 + ((reg) << 12) + ((addr) << 16) + (((imm) & 0xf0) << 4) + ((imm) & 0x0f) )
++// ldrh reg, [addr, #-(imm)]		@	0 <= imm < 256
++#define LDRH_IMM_M(reg, addr, imm) (0xe15000b0 + ((reg) << 12) + ((addr) << 16) + (((imm) & 0xf0) << 4) + ((imm) & 0x0f) )
+ // ldrb reg, [addr, #imm]		@	0 <= imm < 4096
+ #define LDRB_IMM(reg, addr, imm) (0xe5d00000 + ((reg) << 12) + ((addr) << 16) + (imm) )
++// ldrb reg, [addr, #-(imm)]		@	0 <= imm < 4096
++#define LDRB_IMM_M(reg, addr, imm) (0xe5500000 + ((reg) << 12) + ((addr) << 16) + (imm) )
++// ldr reg, [addr1, addr2, lsl #imm]		@	0 <= imm < 31
++#define LDR_REG_LSL_IMM(reg, addr1, addr2, imm) (0xe7900000 + ((reg) << 12) + ((addr1) << 16) + (addr2) + ((imm) << 7) )
+ 
+ // store
+ // str reg, [addr, #imm]		@	0 <= imm < 4096
+ #define STR_IMM(reg, addr, imm) (0xe5800000 + ((reg) << 12) + ((addr) << 16) + (imm) )
++// str reg, [addr, #-(imm)]		@	0 <= imm < 4096
++#define STR_IMM_M(reg, addr, imm) (0xe5000000 + ((reg) << 12) + ((addr) << 16) + (imm) )
+ // strh reg, [addr, #imm]		@	0 <= imm < 256
+ #define STRH_IMM(reg, addr, imm) (0xe1c000b0 + ((reg) << 12) + ((addr) << 16) + (((imm) & 0xf0) << 4) + ((imm) & 0x0f) )
++// strh reg, [addr, #-(imm)]		@	0 <= imm < 256
++#define STRH_IMM_M(reg, addr, imm) (0xe14000b0 + ((reg) << 12) + ((addr) << 16) + (((imm) & 0xf0) << 4) + ((imm) & 0x0f) )
+ // strb reg, [addr, #imm]		@	0 <= imm < 4096
+ #define STRB_IMM(reg, addr, imm) (0xe5c00000 + ((reg) << 12) + ((addr) << 16) + (imm) )
++// strb reg, [addr, #-(imm)]		@	0 <= imm < 4096
++#define STRB_IMM_M(reg, addr, imm) (0xe5400000 + ((reg) << 12) + ((addr) << 16) + (imm) )
+ 
+ // branch
+ // beq pc+imm		@	0 <= imm < 32M	&	imm mod 4 = 0
+ #define BEQ_FWD(imm) (0x0a000000 + ((imm) >> 2) )
+ // bne pc+imm		@	0 <= imm < 32M	&	imm mod 4 = 0
+ #define BNE_FWD(imm) (0x1a000000 + ((imm) >> 2) )
+-// bgt pc+imm		@	0 <= imm < 32M	&	imm mod 4 = 0
+-#define BGT_FWD(imm) (0xca000000 + ((imm) >> 2) )
++// ble pc+imm		@	0 <= imm < 32M	&	imm mod 4 = 0
++#define BLE_FWD(imm) (0xda000000 + ((imm) >> 2) )
+ // b pc+imm		@	0 <= imm < 32M	&	imm mod 4 = 0
+ #define B_FWD(imm) (0xea000000 + ((imm) >> 2) )
+ // bx reg
+ #define BX(reg) (0xe12fff10 + (reg) )
++#if C_TARGETCPU == ARMV7LE
++// blx reg
++#define BLX_REG(reg) (0xe12fff30 + (reg) )
++
++// extend
++// sxth dst, src, ror #rimm		@	rimm = 0 | 8 | 16 | 24
++#define SXTH(dst, src, rimm) (0xe6bf0070 + ((dst) << 12) + (src) + (((rimm) & 24) << 7) )
++// sxtb dst, src, ror #rimm		@	rimm = 0 | 8 | 16 | 24
++#define SXTB(dst, src, rimm) (0xe6af0070 + ((dst) << 12) + (src) + (((rimm) & 24) << 7) )
++// uxth dst, src, ror #rimm		@	rimm = 0 | 8 | 16 | 24
++#define UXTH(dst, src, rimm) (0xe6ff0070 + ((dst) << 12) + (src) + (((rimm) & 24) << 7) )
++// uxtb dst, src, ror #rimm		@	rimm = 0 | 8 | 16 | 24
++#define UXTB(dst, src, rimm) (0xe6ef0070 + ((dst) << 12) + (src) + (((rimm) & 24) << 7) )
++
++// bit field
++// bfi dst, src, #lsb, #width		@	lsb >= 0, width >= 1, lsb+width <= 32
++#define BFI(dst, src, lsb, width) (0xe7c00010 + ((dst) << 12) + (src) + ((lsb) << 7) + (((lsb) + (width) - 1) << 16) )
++// bfc dst, #lsb, #width		@	lsb >= 0, width >= 1, lsb+width <= 32
++#define BFC(dst, lsb, width) (0xe7c0001f + ((dst) << 12) + ((lsb) << 7) + (((lsb) + (width) - 1) << 16) )
++#endif
+ 
+ 
+ // move a full register from reg_src to reg_dst
+@@ -160,6 +204,28 @@
+ }
+ 
+ // helper function
++static bool val_is_operand2(Bit32u value, Bit32u *val_shift) {
++	Bit32u shift;
++
++	if (GCC_UNLIKELY(value == 0)) {
++		*val_shift = 0;
++		return true;
++	}
++
++	shift = 0;
++	while ((value & 3) == 0) {
++		value>>=2;
++		shift+=2;
++	}
++
++	if ((value >> 8) != 0) return false;
++
++	*val_shift = shift;
++	return true;
++}
++
++#if C_TARGETCPU != ARMV7LE
++// helper function
+ static Bits get_imm_gen_len(Bit32u imm) {
+ 	Bits ret;
+ 	if (imm == 0) {
+@@ -178,79 +244,44 @@
+ }
+ 
+ // helper function
+-static Bits get_method_imm_gen_len(Bit32u imm, Bits preffer00, Bits *num) {
+-	Bits num00, num15, numadd, numsub, numret, ret;
+-	num00 = get_imm_gen_len(imm);
+-	num15 = get_imm_gen_len(~imm);
+-	numadd = get_imm_gen_len(imm - ((Bit32u)cache.pos+8));
+-	numsub = get_imm_gen_len(((Bit32u)cache.pos+8) - imm);
+-	if (numsub < numadd && numsub < num00 && numsub < num15) {
+-		ret = 0;
+-		numret = numsub;
+-	} else if (numadd < num00 && numadd < num15) {
+-		ret = 1;
+-		numret = numadd;
+-	} else if (num00 < num15 || (num00 == num15 && preffer00)) {
+-		ret = 2;
+-		numret = num00;
+-	} else {
+-		ret = 3;
+-		numret = num15;
+-	}
+-	if (num != NULL) *num = numret;
+-	return ret;
++static Bits get_min_imm_gen_len(Bit32u imm) {
++	Bits num1, num2;
++
++	num1 = get_imm_gen_len(imm);
++	num2 = get_imm_gen_len(~imm);
++
++	return (num1 <= num2)?num1:num2;
+ }
++#endif
+ 
+ // move a 32bit constant value into dest_reg
+ static void gen_mov_dword_to_reg_imm(HostReg dest_reg,Bit32u imm) {
+-	Bits first, method, scale;
+-	Bit32u imm2, dist;
+-	if (imm == 0) {
+-		cache_addd( MOV_IMM(dest_reg, 0, 0) );      // mov dest_reg, #0
+-	} else if (imm == 0xffffffff) {
+-		cache_addd( MVN_IMM(dest_reg, 0, 0) );      // mvn dest_reg, #0
++#if C_TARGETCPU == ARMV7LE
++	Bit32u scale;
++
++	if ( val_is_operand2(imm, &scale) ) {
++		cache_addd( MOV_IMM(dest_reg, imm >> scale, ROTATE_SCALE(scale)) );      // mov dest_reg, #imm
++	} else if ( val_is_operand2(~imm, &scale) ) {
++		cache_addd( MVN_IMM(dest_reg, (~imm) >> scale, ROTATE_SCALE(scale)) );      // mvn dest_reg, #~imm
+ 	} else {
+-		method = get_method_imm_gen_len(imm, 1, NULL);
++		cache_addd( MOVW(dest_reg, imm & 0xffff) );      // movw dest_reg, #(imm & 0xffff)
+ 
+-		scale = 0;
+-		first = 1;
+-		if (method == 0) {
+-			dist = ((Bit32u)cache.pos+8) - imm;
+-			while (dist) {
+-				while ((dist & 3) == 0) {
+-					dist>>=2;
+-					scale+=2;
+-				}
+-				if (first) {
+-					cache_addd( SUB_IMM(dest_reg, HOST_pc, dist & 0xff, ROTATE_SCALE(scale)) );      // sub dest_reg, pc, #((dist & 0xff) << scale)
+-					first = 0;
+-				} else {
+-					cache_addd( SUB_IMM(dest_reg, dest_reg, dist & 0xff, ROTATE_SCALE(scale)) );      // sub dest_reg, dest_reg, #((dist & 0xff) << scale)
+-				}
+-				dist>>=8;
+-				scale+=8;
+-			}
+-		} else if (method == 1) {
+-			dist = imm - ((Bit32u)cache.pos+8);
+-			if (dist == 0) {
+-				cache_addd( MOV_REG_LSL_IMM(dest_reg, HOST_pc, 0) );      // mov dest_reg, pc
+-			} else {
+-				while (dist) {
+-					while ((dist & 3) == 0) {
+-						dist>>=2;
+-						scale+=2;
+-					}
+-					if (first) {
+-						cache_addd( ADD_IMM(dest_reg, HOST_pc, dist & 0xff, ROTATE_SCALE(scale)) );      // add dest_reg, pc, #((dist & 0xff) << scale)
+-						first = 0;
+-					} else {
+-						cache_addd( ADD_IMM(dest_reg, dest_reg, dist & 0xff, ROTATE_SCALE(scale)) );      // add dest_reg, dest_reg, #((dist & 0xff) << scale)
+-					}
+-					dist>>=8;
+-					scale+=8;
+-				}
+-			}
+-		} else if (method == 2) {
++		if (imm >= 0x10000)
++		{
++			cache_addd( MOVT(dest_reg, imm >> 16) );      // movt dest_reg, #(imm >> 16)
++		}
++	}
++#else
++	Bit32u imm2, first, scale;
++
++	scale = 0;
++	first = 1;
++	imm2 = ~imm;
++
++	if (get_imm_gen_len(imm) <= get_imm_gen_len(imm2)) {
++		if (imm == 0) {
++			cache_addd( MOV_IMM(dest_reg, 0, 0) );      // mov dest_reg, #0
++		} else {
+ 			while (imm) {
+ 				while ((imm & 3) == 0) {
+ 					imm>>=2;
+@@ -265,8 +296,11 @@
+ 				imm>>=8;
+ 				scale+=8;
+ 			}
++		}
++	} else {
++		if (imm2 == 0) {
++			cache_addd( MVN_IMM(dest_reg, 0, 0) );      // mvn dest_reg, #0
+ 		} else {
+-			imm2 = ~imm;
+ 			while (imm2) {
+ 				while ((imm2 & 3) == 0) {
+ 					imm2>>=2;
+@@ -283,12 +317,67 @@
+ 			}
+ 		}
+ 	}
++#endif
++}
++
++// helper function
++static bool gen_mov_memval_to_reg_helper(HostReg dest_reg, Bit32u data, Bitu size, HostReg addr_reg, Bit32u addr_data) {
++	switch (size) {
++		case 4:
++#if !(defined(C_UNALIGNED_MEMORY) || (C_TARGETCPU == ARMV7LE))
++			if ((data & 3) == 0)
++#endif
++			{
++				if ((data >= addr_data) && (data < addr_data + 4096)) {
++					cache_addd( LDR_IMM(dest_reg, addr_reg, data - addr_data) );      // ldr dest_reg, [addr_reg, #(data - addr_data)]
++					return true;
++				} else if ((data < addr_data) && (data > addr_data - 4096)) {
++					cache_addd( LDR_IMM_M(dest_reg, addr_reg, addr_data - data) );      // ldr dest_reg, [addr_reg, #-(addr_data - data)]
++					return true;
++				}
++			}
++			break;
++		case 2:
++#if !(defined(C_UNALIGNED_MEMORY) || (C_TARGETCPU == ARMV7LE))
++			if ((data & 1) == 0)
++#endif
++			{
++				if ((data >= addr_data) && (data < addr_data + 256)) {
++					cache_addd( LDRH_IMM(dest_reg, addr_reg, data - addr_data) );      // ldrh dest_reg, [addr_reg, #(data - addr_data)]
++					return true;
++				} else if ((data < addr_data) && (data > addr_data - 256)) {
++					cache_addd( LDRH_IMM_M(dest_reg, addr_reg, addr_data - data) );      // ldrh dest_reg, [addr_reg, #-(addr_data - data)]
++					return true;
++				}
++			}
++			break;
++		case 1:
++			if ((data >= addr_data) && (data < addr_data + 4096)) {
++				cache_addd( LDRB_IMM(dest_reg, addr_reg, data - addr_data) );      // ldrb dest_reg, [addr_reg, #(data - addr_data)]
++				return true;
++			} else if ((data < addr_data) && (data > addr_data - 4096)) {
++				cache_addd( LDRB_IMM_M(dest_reg, addr_reg, addr_data - data) );      // ldrb dest_reg, [addr_reg, #-(addr_data - data)]
++				return true;
++			}
++		default:
++			break;
++	}
++	return false;
++}
++
++// helper function
++static bool gen_mov_memval_to_reg(HostReg dest_reg, void *data, Bitu size) {
++	if (gen_mov_memval_to_reg_helper(dest_reg, (Bit32u)data, size, FC_REGS_ADDR, (Bit32u)&cpu_regs)) return true;
++	if (gen_mov_memval_to_reg_helper(dest_reg, (Bit32u)data, size, readdata_addr, (Bit32u)&core_dynrec.readdata)) return true;
++	if (gen_mov_memval_to_reg_helper(dest_reg, (Bit32u)data, size, FC_SEGS_ADDR, (Bit32u)&Segs)) return true;
++	return false;
+ }
+ 
+ // helper function for gen_mov_word_to_reg
+ static void gen_mov_word_to_reg_helper(HostReg dest_reg,void* data,bool dword,HostReg data_reg) {
+ 	// alignment....
+ 	if (dword) {
++#if !(defined(C_UNALIGNED_MEMORY) || (C_TARGETCPU == ARMV7LE))
+ 		if ((Bit32u)data & 3) {
+ 			if ( ((Bit32u)data & 3) == 2 ) {
+ 				cache_addd( LDRH_IMM(dest_reg, data_reg, 0) );      // ldrh dest_reg, [data_reg]
+@@ -301,15 +390,20 @@
+ 				cache_addd( LDRB_IMM(temp2, data_reg, 3) );      // ldrb temp2, [data_reg, #3]
+ 				cache_addd( ORR_REG_LSL_IMM(dest_reg, dest_reg, temp2, 24) );      // orr dest_reg, dest_reg, temp2, lsl #24
+ 			}
+-		} else {
++		} else
++#endif
++		{
+ 			cache_addd( LDR_IMM(dest_reg, data_reg, 0) );      // ldr dest_reg, [data_reg]
+ 		}
+ 	} else {
++#if !(defined(C_UNALIGNED_MEMORY) || (C_TARGETCPU == ARMV7LE))
+ 		if ((Bit32u)data & 1) {
+ 			cache_addd( LDRB_IMM(dest_reg, data_reg, 0) );      // ldrb dest_reg, [data_reg]
+ 			cache_addd( LDRB_IMM(temp2, data_reg, 1) );      // ldrb temp2, [data_reg, #1]
+ 			cache_addd( ORR_REG_LSL_IMM(dest_reg, dest_reg, temp2, 8) );      // orr dest_reg, dest_reg, temp2, lsl #8
+-		} else {
++		} else
++#endif
++		{
+ 			cache_addd( LDRH_IMM(dest_reg, data_reg, 0) );      // ldrh dest_reg, [data_reg]
+ 		}
+ 	}
+@@ -318,42 +412,76 @@
+ // move a 32bit (dword==true) or 16bit (dword==false) value from memory into dest_reg
+ // 16bit moves may destroy the upper 16bit of the destination register
+ static void gen_mov_word_to_reg(HostReg dest_reg,void* data,bool dword) {
+-	gen_mov_dword_to_reg_imm(temp1, (Bit32u)data);
+-	gen_mov_word_to_reg_helper(dest_reg, data, dword, temp1);
++	if (!gen_mov_memval_to_reg(dest_reg, data, (dword)?4:2)) {
++		gen_mov_dword_to_reg_imm(temp1, (Bit32u)data);
++		gen_mov_word_to_reg_helper(dest_reg, data, dword, temp1);
++	}
+ }
+ 
+ // move a 16bit constant value into dest_reg
+ // the upper 16bit of the destination register may be destroyed
+-static void gen_mov_word_to_reg_imm(HostReg dest_reg,Bit16u imm) {
+-	Bits first, scale;
+-	Bit32u imm2;
+-	if (imm == 0) {
+-		cache_addd( MOV_IMM(dest_reg, 0, 0) );      // mov dest_reg, #0
+-	} else {
+-		scale = 0;
+-		first = 1;
+-		imm2 = (Bit32u)imm;
+-		while (imm2) {
+-			while ((imm2 & 3) == 0) {
+-				imm2>>=2;
+-				scale+=2;
++static void INLINE gen_mov_word_to_reg_imm(HostReg dest_reg,Bit16u imm) {
++	gen_mov_dword_to_reg_imm(dest_reg, (Bit32u)imm);
++}
++
++// helper function
++static bool gen_mov_memval_from_reg_helper(HostReg src_reg, Bit32u data, Bitu size, HostReg addr_reg, Bit32u addr_data) {
++	switch (size) {
++		case 4:
++#if !(defined(C_UNALIGNED_MEMORY) || (C_TARGETCPU == ARMV7LE))
++			if ((data & 3) == 0)
++#endif
++			{
++				if ((data >= addr_data) && (data < addr_data + 4096)) {
++					cache_addd( STR_IMM(src_reg, addr_reg, data - addr_data) );      // str src_reg, [addr_reg, #(data - addr_data)]
++					return true;
++				} else if ((data < addr_data) && (data > addr_data - 4096)) {
++					cache_addd( STR_IMM_M(src_reg, addr_reg, addr_data - data) );      // str src_reg, [addr_reg, #-(addr_data - data)]
++					return true;
++				}
+ 			}
+-			if (first) {
+-				cache_addd( MOV_IMM(dest_reg, imm2 & 0xff, ROTATE_SCALE(scale)) );      // mov dest_reg, #((imm2 & 0xff) << scale)
+-				first = 0;
+-			} else {
+-				cache_addd( ORR_IMM(dest_reg, dest_reg, imm2 & 0xff, ROTATE_SCALE(scale)) );      // orr dest_reg, dest_reg, #((imm2 & 0xff) << scale)
++			break;
++		case 2:
++#if !(defined(C_UNALIGNED_MEMORY) || (C_TARGETCPU == ARMV7LE))
++			if ((data & 1) == 0)
++#endif
++			{
++				if ((data >= addr_data) && (data < addr_data + 256)) {
++					cache_addd( STRH_IMM(src_reg, addr_reg, data - addr_data) );      // strh src_reg, [addr_reg, #(data - addr_data)]
++					return true;
++				} else if ((data < addr_data) && (data > addr_data - 256)) {
++					cache_addd( STRH_IMM_M(src_reg, addr_reg, addr_data - data) );      // strh src_reg, [addr_reg, #-(addr_data - data)]
++					return true;
++				}
+ 			}
+-			imm2>>=8;
+-			scale+=8;
+-		}
++			break;
++		case 1:
++			if ((data >= addr_data) && (data < addr_data + 4096)) {
++				cache_addd( STRB_IMM(src_reg, addr_reg, data - addr_data) );      // strb src_reg, [addr_reg, #(data - addr_data)]
++				return true;
++			} else if ((data < addr_data) && (data > addr_data - 4096)) {
++				cache_addd( STRB_IMM_M(src_reg, addr_reg, addr_data - data) );      // strb src_reg, [addr_reg, #-(addr_data - data)]
++				return true;
++			}
++		default:
++			break;
+ 	}
++	return false;
++}
++
++// helper function
++static bool gen_mov_memval_from_reg(HostReg src_reg, void *dest, Bitu size) {
++	if (gen_mov_memval_from_reg_helper(src_reg, (Bit32u)dest, size, FC_REGS_ADDR, (Bit32u)&cpu_regs)) return true;
++	if (gen_mov_memval_from_reg_helper(src_reg, (Bit32u)dest, size, readdata_addr, (Bit32u)&core_dynrec.readdata)) return true;
++	if (gen_mov_memval_from_reg_helper(src_reg, (Bit32u)dest, size, FC_SEGS_ADDR, (Bit32u)&Segs)) return true;
++	return false;
+ }
+ 
+ // helper function for gen_mov_word_from_reg
+ static void gen_mov_word_from_reg_helper(HostReg src_reg,void* dest,bool dword, HostReg data_reg) {
+ 	// alignment....
+ 	if (dword) {
++#if !(defined(C_UNALIGNED_MEMORY) || (C_TARGETCPU == ARMV7LE))
+ 		if ((Bit32u)dest & 3) {
+ 			if ( ((Bit32u)dest & 3) == 2 ) {
+ 				cache_addd( STRH_IMM(src_reg, data_reg, 0) );      // strh src_reg, [data_reg]
+@@ -366,15 +494,20 @@
+ 				cache_addd( MOV_REG_LSR_IMM(temp2, temp2, 16) );      // mov temp2, temp2, lsr #16
+ 				cache_addd( STRB_IMM(temp2, data_reg, 3) );      // strb temp2, [data_reg, #3]
+ 			}
+-		} else {
++		} else
++#endif
++		{
+ 			cache_addd( STR_IMM(src_reg, data_reg, 0) );      // str src_reg, [data_reg]
+ 		}
+ 	} else {
++#if !(defined(C_UNALIGNED_MEMORY) || (C_TARGETCPU == ARMV7LE))
+ 		if ((Bit32u)dest & 1) {
+ 			cache_addd( STRB_IMM(src_reg, data_reg, 0) );      // strb src_reg, [data_reg]
+ 			cache_addd( MOV_REG_LSR_IMM(temp2, src_reg, 8) );      // mov temp2, src_reg, lsr #8
+ 			cache_addd( STRB_IMM(temp2, data_reg, 1) );      // strb temp2, [data_reg, #1]
+-		} else {
++		} else
++#endif
++		{
+ 			cache_addd( STRH_IMM(src_reg, data_reg, 0) );      // strh src_reg, [data_reg]
+ 		}
+ 	}
+@@ -382,8 +515,10 @@
+ 
+ // move 32bit (dword==true) or 16bit (dword==false) of a register into memory
+ static void gen_mov_word_from_reg(HostReg src_reg,void* dest,bool dword) {
+-	gen_mov_dword_to_reg_imm(temp1, (Bit32u)dest);
+-	gen_mov_word_from_reg_helper(src_reg, dest, dword, temp1);
++	if (!gen_mov_memval_from_reg(src_reg, dest, (dword)?4:2)) {
++		gen_mov_dword_to_reg_imm(temp1, (Bit32u)dest);
++		gen_mov_word_from_reg_helper(src_reg, dest, dword, temp1);
++	}
+ }
+ 
+ // move an 8bit value from memory into dest_reg
+@@ -391,8 +526,10 @@
+ // this function does not use FC_OP1/FC_OP2 as dest_reg as these
+ // registers might not be directly byte-accessible on some architectures
+ static void gen_mov_byte_to_reg_low(HostReg dest_reg,void* data) {
+-	gen_mov_dword_to_reg_imm(temp1, (Bit32u)data);
+-	cache_addd( LDRB_IMM(dest_reg, temp1, 0) );      // ldrb dest_reg, [temp1]
++	if (!gen_mov_memval_to_reg(dest_reg, data, 1)) {
++		gen_mov_dword_to_reg_imm(temp1, (Bit32u)data);
++		cache_addd( LDRB_IMM(dest_reg, temp1, 0) );      // ldrb dest_reg, [temp1]
++	}
+ }
+ 
+ // move an 8bit value from memory into dest_reg
+@@ -421,8 +558,10 @@
+ 
+ // move the lowest 8bit of a register into memory
+ static void gen_mov_byte_from_reg_low(HostReg src_reg,void* dest) {
+-	gen_mov_dword_to_reg_imm(temp1, (Bit32u)dest);
+-	cache_addd( STRB_IMM(src_reg, temp1, 0) );      // strb src_reg, [temp1]
++	if (!gen_mov_memval_from_reg(src_reg, dest, 1)) {
++		gen_mov_dword_to_reg_imm(temp1, (Bit32u)dest);
++		cache_addd( STRB_IMM(src_reg, temp1, 0) );      // strb src_reg, [temp1]
++	}
+ }
+ 
+ 
+@@ -431,10 +570,18 @@
+ // the register is zero-extended (sign==false) or sign-extended (sign==true)
+ static void gen_extend_byte(bool sign,HostReg reg) {
+ 	if (sign) {
++#if C_TARGETCPU == ARMV7LE
++		cache_addd( SXTB(reg, reg, 0) );      // sxtb reg, reg
++#else
+ 		cache_addd( MOV_REG_LSL_IMM(reg, reg, 24) );      // mov reg, reg, lsl #24
+ 		cache_addd( MOV_REG_ASR_IMM(reg, reg, 24) );      // mov reg, reg, asr #24
++#endif
+ 	} else {
++#if C_TARGETCPU == ARMV7LE
++		cache_addd( UXTB(reg, reg, 0) );      // uxtb reg, reg
++#else
+ 		cache_addd( AND_IMM(reg, reg, 0xff, 0) );      // and reg, reg, #0xff
++#endif
+ 	}
+ }
+ 
+@@ -442,11 +589,19 @@
+ // the register is zero-extended (sign==false) or sign-extended (sign==true)
+ static void gen_extend_word(bool sign,HostReg reg) {
+ 	if (sign) {
++#if C_TARGETCPU == ARMV7LE
++		cache_addd( SXTH(reg, reg, 0) );      // sxth reg, reg
++#else
+ 		cache_addd( MOV_REG_LSL_IMM(reg, reg, 16) );      // mov reg, reg, lsl #16
+ 		cache_addd( MOV_REG_ASR_IMM(reg, reg, 16) );      // mov reg, reg, asr #16
++#endif
+ 	} else {
++#if C_TARGETCPU == ARMV7LE
++		cache_addd( UXTH(reg, reg, 0) );      // uxth reg, reg
++#else
+ 		cache_addd( MOV_REG_LSL_IMM(reg, reg, 16) );      // mov reg, reg, lsl #16
+ 		cache_addd( MOV_REG_LSR_IMM(reg, reg, 16) );      // mov reg, reg, lsr #16
++#endif
+ 	}
+ }
+ 
+@@ -458,72 +613,57 @@
+ 
+ // add a 32bit constant value to a full register
+ static void gen_add_imm(HostReg reg,Bit32u imm) {
+-	Bits method1, method2, num1, num2, scale, sub;
++	Bit32u imm2, scale;
++
+ 	if(!imm) return;
+-	if (imm == 1) {
+-		cache_addd( ADD_IMM(reg, reg, 1, 0) );      // add reg, reg, #1
+-	} else if (imm == 0xffffffff) {
+-		cache_addd( SUB_IMM(reg, reg, 1, 0) );      // sub reg, reg, #1
++
++	imm2 = (Bit32u) (-((Bit32s)imm));
++
++	if ( val_is_operand2(imm, &scale) ) {
++		cache_addd( ADD_IMM(reg, reg, imm >> scale, ROTATE_SCALE(scale)) );      // add reg, reg, #imm
++	} else if ( val_is_operand2(imm2, &scale) ) {
++		cache_addd( SUB_IMM(reg, reg, imm2 >> scale, ROTATE_SCALE(scale)) );      // sub reg, reg, #(-imm)
++#if C_TARGETCPU == ARMV7LE
++	} else if (imm2 < 0x10000) {
++		cache_addd( MOVW(temp2, imm2) );      // movw temp2, #(-imm)
++		cache_addd( SUB_REG_LSL_IMM(reg, reg, temp2, 0) );      // sub reg, reg, temp2
++#endif
+ 	} else {
+-		method1 = get_method_imm_gen_len(imm, 1, &num1);
+-		method2 = get_method_imm_gen_len(-((Bit32s)imm), 1, &num2);
+-		if (num2 < num1) {
+-			method1 = method2;
+-			imm = (Bit32u)(-((Bit32s)imm));
+-			sub = 1;
+-		} else sub = 0;
+-
+-		if (method1 != 2) {
+-			gen_mov_dword_to_reg_imm(temp3, imm);
+-			if (sub) {
+-				cache_addd( SUB_REG_LSL_IMM(reg, reg, temp3, 0) );      // sub reg, reg, temp3
+-			} else {
+-				cache_addd( ADD_REG_LSL_IMM(reg, reg, temp3, 0) );      // add reg, reg, temp3
+-			}
++#if C_TARGETCPU != ARMV7LE
++		if (get_min_imm_gen_len(imm) <= get_min_imm_gen_len(imm2)) {
++#endif
++			gen_mov_dword_to_reg_imm(temp2, imm);
++			cache_addd( ADD_REG_LSL_IMM(reg, reg, temp2, 0) );      // add reg, reg, temp2
++#if C_TARGETCPU != ARMV7LE
+ 		} else {
+-			scale = 0;
+-			while (imm) {
+-				while ((imm & 3) == 0) {
+-					imm>>=2;
+-					scale+=2;
+-				}
+-				if (sub) {
+-					cache_addd( SUB_IMM(reg, reg, imm & 0xff, ROTATE_SCALE(scale)) );      // sub reg, reg, #((imm & 0xff) << scale)
+-				} else {
+-					cache_addd( ADD_IMM(reg, reg, imm & 0xff, ROTATE_SCALE(scale)) );      // add reg, reg, #((imm & 0xff) << scale)
+-				}
+-				imm>>=8;
+-				scale+=8;
+-			}
++			gen_mov_dword_to_reg_imm(temp2, imm2);
++			cache_addd( SUB_REG_LSL_IMM(reg, reg, temp2, 0) );      // sub reg, reg, temp2
+ 		}
++#endif
+ 	}
+ }
+ 
+ // and a 32bit constant value with a full register
+ static void gen_and_imm(HostReg reg,Bit32u imm) {
+-	Bits method, scale;
+-	Bit32u imm2;
++	Bit32u imm2, scale;
++
+ 	imm2 = ~imm;
+ 	if(!imm2) return;
++
+ 	if (!imm) {
+ 		cache_addd( MOV_IMM(reg, 0, 0) );      // mov reg, #0
++	} else if ( val_is_operand2(imm, &scale) ) {
++		cache_addd( AND_IMM(reg, reg, imm >> scale, ROTATE_SCALE(scale)) );      // and reg, reg, #imm
++	} else if ( val_is_operand2(imm2, &scale) ) {
++		cache_addd( BIC_IMM(reg, reg, imm2 >> scale, ROTATE_SCALE(scale)) );      // bic reg, reg, #(~imm)
++#if C_TARGETCPU == ARMV7LE
++	} else if (imm2 < 0x10000) {
++		cache_addd( MOVW(temp2, imm2) );      // movw temp2, #(~imm)
++		cache_addd( BIC_REG_LSL_IMM(reg, reg, temp2, 0) );      // bic reg, reg, temp2
++#endif
+ 	} else {
+-		method = get_method_imm_gen_len(imm, 0, NULL);
+-		if (method != 3) {
+-			gen_mov_dword_to_reg_imm(temp3, imm);
+-			cache_addd( AND_REG_LSL_IMM(reg, reg, temp3, 0) );      // and reg, reg, temp3
+-		} else {
+-			scale = 0;
+-			while (imm2) {
+-				while ((imm2 & 3) == 0) {
+-					imm2>>=2;
+-					scale+=2;
+-				}
+-				cache_addd( BIC_IMM(reg, reg, imm2 & 0xff, ROTATE_SCALE(scale)) );      // bic reg, reg, #((imm2 & 0xff) << scale)
+-				imm2>>=8;
+-				scale+=8;
+-			}
+-		}
++		gen_mov_dword_to_reg_imm(temp2, imm);
++		cache_addd( AND_REG_LSL_IMM(reg, reg, temp2, 0) );      // and reg, reg, temp2
+ 	}
+ }
+ 
+@@ -539,68 +679,71 @@
+ 	gen_mov_direct_dword(dest,(Bit32u)imm);
+ }
+ 
+-// add an 8bit constant value to a dword memory value
+-static void gen_add_direct_byte(void* dest,Bit8s imm) {
+-	if(!imm) return;
+-	gen_mov_dword_to_reg_imm(temp1, (Bit32u)dest);
+-	gen_mov_word_to_reg_helper(temp3, dest, 1, temp1);
+-	if (imm >= 0) {
+-		cache_addd( ADD_IMM(temp3, temp3, (Bit32s)imm, 0) );      // add temp3, temp3, #(imm)
+-	} else {
+-		cache_addd( SUB_IMM(temp3, temp3, -((Bit32s)imm), 0) );      // sub temp3, temp3, #(-imm)
+-	}
+-	gen_mov_word_from_reg_helper(temp3, dest, 1, temp1);
+-}
+-
+ // add a 32bit (dword==true) or 16bit (dword==false) constant value to a memory value
+ static void gen_add_direct_word(void* dest,Bit32u imm,bool dword) {
++	if (!dword) imm &= 0xffff;
+ 	if(!imm) return;
+-	if (dword && ( (imm<128) || (imm>=0xffffff80) ) ) {
+-		gen_add_direct_byte(dest,(Bit8s)imm);
+-		return;
+-	}
+-	gen_mov_dword_to_reg_imm(temp1, (Bit32u)dest);
+-	gen_mov_word_to_reg_helper(temp3, dest, dword, temp1);
+-	// maybe use function gen_add_imm
+-	if (dword) {
+-		gen_mov_dword_to_reg_imm(temp2, imm);
+-	} else {
+-		gen_mov_word_to_reg_imm(temp2, (Bit16u)imm);
++
++	if (!gen_mov_memval_to_reg(temp3, dest, (dword)?4:2)) {
++		gen_mov_dword_to_reg_imm(temp1, (Bit32u)dest);
++		gen_mov_word_to_reg_helper(temp3, dest, dword, temp1);
++	}
++	gen_add_imm(temp3, imm);
++	if (!gen_mov_memval_from_reg(temp3, dest, (dword)?4:2)) {
++		gen_mov_word_from_reg_helper(temp3, dest, dword, temp1);
+ 	}
+-	cache_addd( ADD_REG_LSL_IMM(temp3, temp3, temp2, 0) );      // add temp3, temp3, temp2
+-	gen_mov_word_from_reg_helper(temp3, dest, dword, temp1);
+ }
+ 
+-// subtract an 8bit constant value from a dword memory value
+-static void gen_sub_direct_byte(void* dest,Bit8s imm) {
+-	if(!imm) return;
+-	gen_mov_dword_to_reg_imm(temp1, (Bit32u)dest);
+-	gen_mov_word_to_reg_helper(temp3, dest, 1, temp1);
+-	if (imm >= 0) {
+-		cache_addd( SUB_IMM(temp3, temp3, (Bit32s)imm, 0) );      // sub temp3, temp3, #(imm)
+-	} else {
+-		cache_addd( ADD_IMM(temp3, temp3, -((Bit32s)imm), 0) );      // add temp3, temp3, #(-imm)
+-	}
+-	gen_mov_word_from_reg_helper(temp3, dest, 1, temp1);
++// add an 8bit constant value to a dword memory value
++static void gen_add_direct_byte(void* dest,Bit8s imm) {
++	gen_add_direct_word(dest, (Bit32s)imm, 1);
+ }
+ 
+ // subtract a 32bit (dword==true) or 16bit (dword==false) constant value from a memory value
+ static void gen_sub_direct_word(void* dest,Bit32u imm,bool dword) {
++	Bit32u imm2, scale;
++
++	if (!dword) imm &= 0xffff;
+ 	if(!imm) return;
+-	if (dword && ( (imm<128) || (imm>=0xffffff80) ) ) {
+-		gen_sub_direct_byte(dest,(Bit8s)imm);
+-		return;
+-	}
+-	gen_mov_dword_to_reg_imm(temp1, (Bit32u)dest);
+-	gen_mov_word_to_reg_helper(temp3, dest, dword, temp1);
+-	// maybe use function gen_add_imm/gen_sub_imm
+-	if (dword) {
+-		gen_mov_dword_to_reg_imm(temp2, imm);
++
++	if (!gen_mov_memval_to_reg(temp3, dest, (dword)?4:2)) {
++		gen_mov_dword_to_reg_imm(temp1, (Bit32u)dest);
++		gen_mov_word_to_reg_helper(temp3, dest, dword, temp1);
++	}
++
++	imm2 = (Bit32u) (-((Bit32s)imm));
++
++	if ( val_is_operand2(imm, &scale) ) {
++		cache_addd( SUB_IMM(temp3, temp3, imm >> scale, ROTATE_SCALE(scale)) );      // sub temp3, temp3, #imm
++	} else if ( val_is_operand2(imm2, &scale) ) {
++		cache_addd( ADD_IMM(temp3, temp3, imm2 >> scale, ROTATE_SCALE(scale)) );      // add temp3, temp3, #(-imm)
++#if C_TARGETCPU == ARMV7LE
++	} else if (imm2 < 0x10000) {
++		cache_addd( MOVW(temp2, imm2) );      // movw temp2, #(-imm)
++		cache_addd( ADD_REG_LSL_IMM(temp3, temp3, temp2, 0) );      // add temp3, temp3, temp2
++#endif
+ 	} else {
+-		gen_mov_word_to_reg_imm(temp2, (Bit16u)imm);
++#if C_TARGETCPU != ARMV7LE
++		if (get_min_imm_gen_len(imm) <= get_min_imm_gen_len(imm2)) {
++#endif
++			gen_mov_dword_to_reg_imm(temp2, imm);
++			cache_addd( SUB_REG_LSL_IMM(temp3, temp3, temp2, 0) );      // sub temp3, temp3, temp2
++#if C_TARGETCPU != ARMV7LE
++		} else {
++			gen_mov_dword_to_reg_imm(temp2, imm2);
++			cache_addd( ADD_REG_LSL_IMM(temp3, temp3, temp2, 0) );      // add temp3, temp3, temp2
++		}
++#endif
++	}
++
++	if (!gen_mov_memval_from_reg(temp3, dest, (dword)?4:2)) {
++		gen_mov_word_from_reg_helper(temp3, dest, dword, temp1);
+ 	}
+-	cache_addd( SUB_REG_LSL_IMM(temp3, temp3, temp2, 0) );      // sub temp3, temp3, temp2
+-	gen_mov_word_from_reg_helper(temp3, dest, dword, temp1);
++}
++
++// subtract an 8bit constant value from a dword memory value
++static void gen_sub_direct_byte(void* dest,Bit8s imm) {
++	gen_sub_direct_word(dest, (Bit32s)imm, 1);
+ }
+ 
+ // effective address calculation, destination is dest_reg
+@@ -623,10 +766,16 @@
+ 
+ // generate a call to a parameterless function
+ static void INLINE gen_call_function_raw(void * func) {
++#if C_TARGETCPU == ARMV7LE
++	cache_addd( MOVW(temp1, ((Bit32u)func) & 0xffff) );      // movw temp1, #(func & 0xffff)
++	cache_addd( MOVT(temp1, ((Bit32u)func) >> 16) );      // movt temp1, #(func >> 16)
++	cache_addd( BLX_REG(temp1) );      // blx temp1
++#else
+ 	cache_addd( LDR_IMM(temp1, HOST_pc, 4) );      // ldr temp1, [pc, #4]
+ 	cache_addd( ADD_IMM(HOST_lr, HOST_pc, 4, 0) );      // add lr, pc, #4
+ 	cache_addd( BX(temp1) );      // bx temp1
+ 	cache_addd((Bit32u)func);      // .int func
++#endif
+ }
+ 
+ // generate a call to a function with paramcount parameters
+@@ -666,43 +815,24 @@
+ 
+ // jump to an address pointed at by ptr, offset is in imm
+ static void gen_jmp_ptr(void * ptr,Bits imm=0) {
+-	Bits num1, num2, scale, sub;
+-	Bitu imm2;
+-	gen_mov_word_to_reg(temp3, ptr, 1);
++	Bit32u scale;
+ 
+-	if (imm) {
+-		num1 = get_imm_gen_len(imm);
+-		num2 = get_imm_gen_len(-imm);
+-
+-		if (num2 < num1) {
+-			imm = -imm;
+-			sub = 1;
+-		} else sub = 0;
+-
+-		scale = 0;
+-		imm2 = (Bitu)imm;
+-		while (imm2) {
+-			while ((imm2 & 3) == 0) {
+-				imm2>>=2;
+-				scale+=2;
+-			}
+-			if (sub) {
+-				cache_addd( SUB_IMM(temp3, temp3, imm2 & 0xff, ROTATE_SCALE(scale)) );      // sub temp3, temp3, #((imm2 & 0xff) << scale)
+-			} else {
+-				cache_addd( ADD_IMM(temp3, temp3, imm2 & 0xff, ROTATE_SCALE(scale)) );      // add temp3, temp3, #((imm2 & 0xff) << scale)
+-			}
+-			imm2>>=8;
+-			scale+=8;
+-		}
+-	}
++	gen_mov_word_to_reg(temp3, ptr, 1);
+ 
+-#if (1)
+-// (*ptr) should be word aligned 
++#if !(defined(C_UNALIGNED_MEMORY) || (C_TARGETCPU == ARMV7LE))
++// (*ptr) should be word aligned
+ 	if ((imm & 0x03) == 0) {
+-		cache_addd( LDR_IMM(temp1, temp3, 0) );      // ldr temp1, [temp3]
+-	} else
+ #endif
+-	{
++		if ((imm >= 0) && (imm < 4096)) {
++			cache_addd( LDR_IMM(temp1, temp3, imm) );      // ldr temp1, [temp3, #imm]
++		} else {
++			gen_mov_dword_to_reg_imm(temp2, imm);
++			cache_addd( LDR_REG_LSL_IMM(temp1, temp3, temp2, 0) );      // ldr temp1, [temp3, temp2]
++		}
++#if !(defined(C_UNALIGNED_MEMORY) || (C_TARGETCPU == ARMV7LE))
++	} else {
++		gen_add_imm(temp3, imm);
++
+ 		cache_addd( LDRB_IMM(temp1, temp3, 0) );      // ldrb temp1, [temp3]
+ 		cache_addd( LDRB_IMM(temp2, temp3, 1) );      // ldrb temp2, [temp3, #1]
+ 		cache_addd( ORR_REG_LSL_IMM(temp1, temp1, temp2, 8) );      // orr temp1, temp1, temp2, lsl #8
+@@ -711,6 +841,7 @@
+ 		cache_addd( LDRB_IMM(temp2, temp3, 3) );      // ldrb temp2, [temp3, #3]
+ 		cache_addd( ORR_REG_LSL_IMM(temp1, temp1, temp2, 24) );      // orr temp1, temp1, temp2, lsl #24
+ 	}
++#endif
+ 
+ 	cache_addd( BX(temp1) );      // bx temp1
+ }
+@@ -758,67 +889,74 @@
+ 	} else {
+ 		cache_addd( TST_IMM(reg, 0xff, 0) );      // tst reg, #0xff
+ 	}
+-	cache_addd( BEQ_FWD(8) );      // beq nobranch (pc +8)
+-	cache_addd( LDR_IMM(temp1, HOST_pc, 0) );      // ldr temp1, [pc, #0]
+-	cache_addd( BX(temp1) );      // bx temp1
+-	cache_addd(0);      // fill j
+-	// nobranch:
++	cache_addd( BNE_FWD(0) );      // bne j
+ 	return ((Bit32u)cache.pos-4);
+ }
+ 
+ // compare 32bit-register against zero and jump if value less/equal than zero
+ static Bit32u gen_create_branch_long_leqzero(HostReg reg) {
+ 	cache_addd( CMP_IMM(reg, 0, 0) );      // cmp reg, #0
+-	cache_addd( BGT_FWD(8) );      // bgt nobranch (pc+8)
+-	cache_addd( LDR_IMM(temp1, HOST_pc, 0) );      // ldr temp1, [pc, #0]
+-	cache_addd( BX(temp1) );      // bx temp1
+-	cache_addd(0);      // fill j
+-	// nobranch:
++	cache_addd( BLE_FWD(0) );      // ble j
+ 	return ((Bit32u)cache.pos-4);
+ }
+ 
+ // calculate long relative offset and fill it into the location pointed to by data
+ static void INLINE gen_fill_branch_long(Bit32u data) {
+-	// this is an absolute branch
+-	*(Bit32u*)data=(Bit32u)cache.pos;
++	*(Bit32u*)data=( (*(Bit32u*)data) & 0xff000000 ) | ( ( ((Bit32u)cache.pos - (data+8)) >> 2 ) & 0x00ffffff );
+ }
+ 
+ static void gen_run_code(void) {
+-	cache_addd(0xe92d4000);			// stmfd sp!, {lr}
+-	cache_addd(0xe92d0cf0);			// stmfd sp!, {v1-v4,v7,v8}
++#if C_TARGETCPU == ARMV7LE
++	cache_addd(0xe92d4df0);			// stmfd sp!, {v1-v5,v7,v8,lr}
++
++	cache_addd( MOVW(FC_SEGS_ADDR, ((Bit32u)&Segs) & 0xffff) );      // movw FC_SEGS_ADDR, #(&Segs & 0xffff)
++	cache_addd( MOVT(FC_SEGS_ADDR, ((Bit32u)&Segs) >> 16) );      // movt FC_SEGS_ADDR, #(&Segs >> 16)
+ 
+-	// adr: 8
+-	cache_addd( LDR_IMM(FC_SEGS_ADDR, HOST_pc, 64 - (8 + 8)) );      // ldr FC_SEGS_ADDR, [pc, #(&Segs)]
+-	// adr: 12
+-	cache_addd( LDR_IMM(FC_REGS_ADDR, HOST_pc, 68 - (12 + 8)) );      // ldr FC_REGS_ADDR, [pc, #(&cpu_regs)]
+-
+-	cache_addd( ADD_IMM(HOST_lr, HOST_pc, 4, 0) );			// add lr, pc, #4
+-	cache_addd(0xe92d4000);			// stmfd sp!, {lr}
+-	cache_addd( BX(HOST_r0) );			// bx r0	
+-
+-	cache_addd(0xe8bd0cf0);			// ldmfd sp!, {v1-v4,v7,v8}
+-
+-	cache_addd(0xe8bd4000);			// ldmfd sp!, {lr}
+-	cache_addd( BX(HOST_lr) );			// bx lr
+-
+-	// fill up to 64 bytes
+-	cache_addd( NOP );			// nop
+-	cache_addd( NOP );			// nop
+-	cache_addd( NOP );			// nop
+-	cache_addd( NOP );			// nop
+-	cache_addd( NOP );			// nop
+-	cache_addd( NOP );			// nop
++	cache_addd( MOVW(FC_REGS_ADDR, ((Bit32u)&cpu_regs) & 0xffff) );      // movw FC_REGS_ADDR, #(&cpu_regs & 0xffff)
++	cache_addd( MOVT(FC_REGS_ADDR, ((Bit32u)&cpu_regs) >> 16) );      // movt FC_REGS_ADDR, #(&cpu_regs >> 16)
++
++	cache_addd( MOVW(readdata_addr, ((Bitu)&core_dynrec.readdata) & 0xffff) );      // movw readdata_addr, #(&core_dynrec.readdata & 0xffff)
++	cache_addd( MOVT(readdata_addr, ((Bitu)&core_dynrec.readdata) >> 16) );      // movt readdata_addr, #(&core_dynrec.readdata >> 16)
++
++	cache_addd( BX(HOST_r0) );			// bx r0
++#else
++	Bit8u *pos1, *pos2, *pos3;
++
++	cache_addd(0xe92d4df0);			// stmfd sp!, {v1-v5,v7,v8,lr}
++
++	pos1 = cache.pos;
++	cache_addd( 0 );
++	pos2 = cache.pos;
++	cache_addd( 0 );
++	pos3 = cache.pos;
++	cache_addd( 0 );
++
++	cache_addd( BX(HOST_r0) );			// bx r0
++
++	// align cache.pos to 32 bytes
++	if ((((Bitu)cache.pos) & 0x1f) != 0) {
++		cache.pos = cache.pos + (32 - (((Bitu)cache.pos) & 0x1f));
++	}
+ 
+-	// adr: 64
++	*(Bit32u*)pos1 = LDR_IMM(FC_SEGS_ADDR, HOST_pc, cache.pos - (pos1 + 8));      // ldr FC_SEGS_ADDR, [pc, #(&Segs)]
+ 	cache_addd((Bit32u)&Segs);      // address of "Segs"
+-	// adr: 68
++
++	*(Bit32u*)pos2 = LDR_IMM(FC_REGS_ADDR, HOST_pc, cache.pos - (pos2 + 8));      // ldr FC_REGS_ADDR, [pc, #(&cpu_regs)]
+ 	cache_addd((Bit32u)&cpu_regs);  // address of "cpu_regs"
++
++	*(Bit32u*)pos3 = LDR_IMM(readdata_addr, HOST_pc, cache.pos - (pos3 + 8));      // ldr readdata_addr, [pc, #(&core_dynrec.readdata)]
++	cache_addd((Bit32u)&core_dynrec.readdata);  // address of "core_dynrec.readdata"
++
++	// align cache.pos to 32 bytes
++	if ((((Bitu)cache.pos) & 0x1f) != 0) {
++		cache.pos = cache.pos + (32 - (((Bitu)cache.pos) & 0x1f));
++	}
++#endif
+ }
+ 
+ // return from a function
+ static void gen_return_function(void) {
+-	cache_addd(0xe8bd4000);			// ldmfd sp!, {lr}
+-	cache_addd( BX(HOST_lr) );			// bx lr
++	cache_addd(0xe8bd8df0);			// ldmfd sp!, {v1-v5,v7,v8,pc}
+ }
+ 
+ #ifdef DRC_FLAGS_INVALIDATION
+@@ -832,42 +970,52 @@
+ 		case t_ADDb:
+ 		case t_ADDw:
+ 		case t_ADDd:
+-			*(Bit32u*)pos=ADD_REG_LSL_IMM(FC_RETOP, HOST_a1, HOST_a2, 0);	// add FC_RETOP, a1, a2
++			*(Bit32u*)pos=NOP;					// nop
+ 			*(Bit32u*)(pos+4)=NOP;				// nop
+-			*(Bit32u*)(pos+8)=NOP;				// nop
++			*(Bit32u*)(pos+8)=ADD_REG_LSL_IMM(FC_RETOP, HOST_a1, HOST_a2, 0);	// add FC_RETOP, a1, a2
++#if C_TARGETCPU != ARMV7LE
+ 			*(Bit32u*)(pos+12)=NOP;				// nop
++#endif
+ 			break;
+ 		case t_ORb:
+ 		case t_ORw:
+ 		case t_ORd:
+-			*(Bit32u*)pos=ORR_REG_LSL_IMM(FC_RETOP, HOST_a1, HOST_a2, 0);	// orr FC_RETOP, a1, a2
++			*(Bit32u*)pos=NOP;					// nop
+ 			*(Bit32u*)(pos+4)=NOP;				// nop
+-			*(Bit32u*)(pos+8)=NOP;				// nop
++			*(Bit32u*)(pos+8)=ORR_REG_LSL_IMM(FC_RETOP, HOST_a1, HOST_a2, 0);	// orr FC_RETOP, a1, a2
++#if C_TARGETCPU != ARMV7LE
+ 			*(Bit32u*)(pos+12)=NOP;				// nop
++#endif
+ 			break;
+ 		case t_ANDb:
+ 		case t_ANDw:
+ 		case t_ANDd:
+-			*(Bit32u*)pos=AND_REG_LSL_IMM(FC_RETOP, HOST_a1, HOST_a2, 0);	// and FC_RETOP, a1, a2
++			*(Bit32u*)pos=NOP;					// nop
+ 			*(Bit32u*)(pos+4)=NOP;				// nop
+-			*(Bit32u*)(pos+8)=NOP;				// nop
++			*(Bit32u*)(pos+8)=AND_REG_LSL_IMM(FC_RETOP, HOST_a1, HOST_a2, 0);	// and FC_RETOP, a1, a2
++#if C_TARGETCPU != ARMV7LE
+ 			*(Bit32u*)(pos+12)=NOP;				// nop
++#endif
+ 			break;
+ 		case t_SUBb:
+ 		case t_SUBw:
+ 		case t_SUBd:
+-			*(Bit32u*)pos=SUB_REG_LSL_IMM(FC_RETOP, HOST_a1, HOST_a2, 0);	// sub FC_RETOP, a1, a2
++			*(Bit32u*)pos=NOP;					// nop
+ 			*(Bit32u*)(pos+4)=NOP;				// nop
+-			*(Bit32u*)(pos+8)=NOP;				// nop
++			*(Bit32u*)(pos+8)=SUB_REG_LSL_IMM(FC_RETOP, HOST_a1, HOST_a2, 0);	// sub FC_RETOP, a1, a2
++#if C_TARGETCPU != ARMV7LE
+ 			*(Bit32u*)(pos+12)=NOP;				// nop
++#endif
+ 			break;
+ 		case t_XORb:
+ 		case t_XORw:
+ 		case t_XORd:
+-			*(Bit32u*)pos=EOR_REG_LSL_IMM(FC_RETOP, HOST_a1, HOST_a2, 0);	// eor FC_RETOP, a1, a2
++			*(Bit32u*)pos=NOP;					// nop
+ 			*(Bit32u*)(pos+4)=NOP;				// nop
+-			*(Bit32u*)(pos+8)=NOP;				// nop
++			*(Bit32u*)(pos+8)=EOR_REG_LSL_IMM(FC_RETOP, HOST_a1, HOST_a2, 0);	// eor FC_RETOP, a1, a2
++#if C_TARGETCPU != ARMV7LE
+ 			*(Bit32u*)(pos+12)=NOP;				// nop
++#endif
+ 			break;
+ 		case t_CMPb:
+ 		case t_CMPw:
+@@ -875,114 +1023,185 @@
+ 		case t_TESTb:
+ 		case t_TESTw:
+ 		case t_TESTd:
+-			*(Bit32u*)pos=B_FWD(8);				// b (pc+2*4)
++			*(Bit32u*)pos=NOP;					// nop
++			*(Bit32u*)(pos+4)=NOP;				// nop
++			*(Bit32u*)(pos+8)=NOP;				// nop
++#if C_TARGETCPU != ARMV7LE
++			*(Bit32u*)(pos+12)=NOP;				// nop
++#endif
+ 			break;
+ 		case t_INCb:
+ 		case t_INCw:
+ 		case t_INCd:
+-			*(Bit32u*)pos=ADD_IMM(FC_RETOP, HOST_a1, 1, 0);	// add FC_RETOP, a1, #1
++			*(Bit32u*)pos=NOP;					// nop
+ 			*(Bit32u*)(pos+4)=NOP;				// nop
+-			*(Bit32u*)(pos+8)=NOP;				// nop
++			*(Bit32u*)(pos+8)=ADD_IMM(FC_RETOP, HOST_a1, 1, 0);	// add FC_RETOP, a1, #1
++#if C_TARGETCPU != ARMV7LE
+ 			*(Bit32u*)(pos+12)=NOP;				// nop
++#endif
+ 			break;
+ 		case t_DECb:
+ 		case t_DECw:
+ 		case t_DECd:
+-			*(Bit32u*)pos=SUB_IMM(FC_RETOP, HOST_a1, 1, 0);	// sub FC_RETOP, a1, #1
++			*(Bit32u*)pos=NOP;					// nop
+ 			*(Bit32u*)(pos+4)=NOP;				// nop
+-			*(Bit32u*)(pos+8)=NOP;				// nop
++			*(Bit32u*)(pos+8)=SUB_IMM(FC_RETOP, HOST_a1, 1, 0);	// sub FC_RETOP, a1, #1
++#if C_TARGETCPU != ARMV7LE
+ 			*(Bit32u*)(pos+12)=NOP;				// nop
++#endif
+ 			break;
+ 		case t_SHLb:
+ 		case t_SHLw:
+ 		case t_SHLd:
+-			*(Bit32u*)pos=MOV_REG_LSL_REG(FC_RETOP, HOST_a1, HOST_a2);	// mov FC_RETOP, a1, lsl a2
++			*(Bit32u*)pos=NOP;					// nop
+ 			*(Bit32u*)(pos+4)=NOP;				// nop
+-			*(Bit32u*)(pos+8)=NOP;				// nop
++			*(Bit32u*)(pos+8)=MOV_REG_LSL_REG(FC_RETOP, HOST_a1, HOST_a2);	// mov FC_RETOP, a1, lsl a2
++#if C_TARGETCPU != ARMV7LE
+ 			*(Bit32u*)(pos+12)=NOP;				// nop
++#endif
+ 			break;
+ 		case t_SHRb:
+-			*(Bit32u*)pos=AND_IMM(FC_RETOP, HOST_a1, 0xff, 0);				// and FC_RETOP, a1, #0xff
+-			*(Bit32u*)(pos+4)=MOV_REG_LSR_REG(FC_RETOP, FC_RETOP, HOST_a2);	// mov FC_RETOP, FC_RETOP, lsr a2
+-			*(Bit32u*)(pos+8)=NOP;				// nop
+-			*(Bit32u*)(pos+12)=NOP;				// nop
++			*(Bit32u*)pos=NOP;					// nop
++#if C_TARGETCPU == ARMV7LE
++			*(Bit32u*)(pos+4)=BFC(HOST_a1, 8, 24);	// bfc a1, 8, 24
++			*(Bit32u*)(pos+8)=MOV_REG_LSR_REG(FC_RETOP, HOST_a1, HOST_a2);	// mov FC_RETOP, a1, lsr a2
++#else
++			*(Bit32u*)(pos+4)=NOP;				// nop
++			*(Bit32u*)(pos+8)=AND_IMM(FC_RETOP, HOST_a1, 0xff, 0);				// and FC_RETOP, a1, #0xff
++			*(Bit32u*)(pos+12)=MOV_REG_LSR_REG(FC_RETOP, FC_RETOP, HOST_a2);	// mov FC_RETOP, FC_RETOP, lsr a2
++#endif
+ 			break;
+ 		case t_SHRw:
+-			*(Bit32u*)pos=MOV_REG_LSL_IMM(FC_RETOP, HOST_a1, 16);			// mov FC_RETOP, a1, lsl #16
+-			*(Bit32u*)(pos+4)=MOV_REG_LSR_IMM(FC_RETOP, FC_RETOP, 16);		// mov FC_RETOP, FC_RETOP, lsr #16
+-			*(Bit32u*)(pos+8)=MOV_REG_LSR_REG(FC_RETOP, FC_RETOP, HOST_a2);	// mov FC_RETOP, FC_RETOP, lsr a2
+-			*(Bit32u*)(pos+12)=NOP;				// nop
++			*(Bit32u*)pos=NOP;					// nop
++#if C_TARGETCPU == ARMV7LE
++			*(Bit32u*)(pos+4)=BFC(HOST_a1, 16, 16);	// bfc a1, 16, 16
++			*(Bit32u*)(pos+8)=MOV_REG_LSR_REG(FC_RETOP, HOST_a1, HOST_a2);	// mov FC_RETOP, a1, lsr a2
++#else
++			*(Bit32u*)(pos+4)=MOV_REG_LSL_IMM(FC_RETOP, HOST_a1, 16);			// mov FC_RETOP, a1, lsl #16
++			*(Bit32u*)(pos+8)=MOV_REG_LSR_IMM(FC_RETOP, FC_RETOP, 16);			// mov FC_RETOP, FC_RETOP, lsr #16
++			*(Bit32u*)(pos+12)=MOV_REG_LSR_REG(FC_RETOP, FC_RETOP, HOST_a2);	// mov FC_RETOP, FC_RETOP, lsr a2
++#endif
+ 			break;
+ 		case t_SHRd:
+-			*(Bit32u*)pos=MOV_REG_LSR_REG(FC_RETOP, HOST_a1, HOST_a2);	// mov FC_RETOP, a1, lsr a2
++			*(Bit32u*)pos=NOP;					// nop
+ 			*(Bit32u*)(pos+4)=NOP;				// nop
+-			*(Bit32u*)(pos+8)=NOP;				// nop
++			*(Bit32u*)(pos+8)=MOV_REG_LSR_REG(FC_RETOP, HOST_a1, HOST_a2);	// mov FC_RETOP, a1, lsr a2
++#if C_TARGETCPU != ARMV7LE
+ 			*(Bit32u*)(pos+12)=NOP;				// nop
++#endif
+ 			break;
+ 		case t_SARb:
+-			*(Bit32u*)pos=MOV_REG_LSL_IMM(FC_RETOP, HOST_a1, 24);			// mov FC_RETOP, a1, lsl #24
+-			*(Bit32u*)(pos+4)=MOV_REG_ASR_IMM(FC_RETOP, FC_RETOP, 24);		// mov FC_RETOP, FC_RETOP, asr #24
++			*(Bit32u*)pos=NOP;					// nop
++#if C_TARGETCPU == ARMV7LE
++			*(Bit32u*)(pos+4)=SXTB(FC_RETOP, HOST_a1, 0);					// sxtb FC_RETOP, a1
+ 			*(Bit32u*)(pos+8)=MOV_REG_ASR_REG(FC_RETOP, FC_RETOP, HOST_a2);	// mov FC_RETOP, FC_RETOP, asr a2
+-			*(Bit32u*)(pos+12)=NOP;				// nop
++#else
++			*(Bit32u*)(pos+4)=MOV_REG_LSL_IMM(FC_RETOP, HOST_a1, 24);			// mov FC_RETOP, a1, lsl #24
++			*(Bit32u*)(pos+8)=MOV_REG_ASR_IMM(FC_RETOP, FC_RETOP, 24);			// mov FC_RETOP, FC_RETOP, asr #24
++			*(Bit32u*)(pos+12)=MOV_REG_ASR_REG(FC_RETOP, FC_RETOP, HOST_a2);	// mov FC_RETOP, FC_RETOP, asr a2
++#endif
+ 			break;
+ 		case t_SARw:
+-			*(Bit32u*)pos=MOV_REG_LSL_IMM(FC_RETOP, HOST_a1, 16);			// mov FC_RETOP, a1, lsl #16
+-			*(Bit32u*)(pos+4)=MOV_REG_ASR_IMM(FC_RETOP, FC_RETOP, 16);		// mov FC_RETOP, FC_RETOP, asr #16
++			*(Bit32u*)pos=NOP;					// nop
++#if C_TARGETCPU == ARMV7LE
++			*(Bit32u*)(pos+4)=SXTH(FC_RETOP, HOST_a1, 0);					// sxth FC_RETOP, a1
+ 			*(Bit32u*)(pos+8)=MOV_REG_ASR_REG(FC_RETOP, FC_RETOP, HOST_a2);	// mov FC_RETOP, FC_RETOP, asr a2
+-			*(Bit32u*)(pos+12)=NOP;				// nop
++#else
++			*(Bit32u*)(pos+4)=MOV_REG_LSL_IMM(FC_RETOP, HOST_a1, 16);			// mov FC_RETOP, a1, lsl #16
++			*(Bit32u*)(pos+8)=MOV_REG_ASR_IMM(FC_RETOP, FC_RETOP, 16);			// mov FC_RETOP, FC_RETOP, asr #16
++			*(Bit32u*)(pos+12)=MOV_REG_ASR_REG(FC_RETOP, FC_RETOP, HOST_a2);	// mov FC_RETOP, FC_RETOP, asr a2
++#endif
+ 			break;
+ 		case t_SARd:
+-			*(Bit32u*)pos=MOV_REG_ASR_REG(FC_RETOP, HOST_a1, HOST_a2);	// mov FC_RETOP, a1, asr a2
++			*(Bit32u*)pos=NOP;					// nop
+ 			*(Bit32u*)(pos+4)=NOP;				// nop
+-			*(Bit32u*)(pos+8)=NOP;				// nop
++			*(Bit32u*)(pos+8)=MOV_REG_ASR_REG(FC_RETOP, HOST_a1, HOST_a2);	// mov FC_RETOP, a1, asr a2
++#if C_TARGETCPU != ARMV7LE
+ 			*(Bit32u*)(pos+12)=NOP;				// nop
++#endif
+ 			break;
+ 		case t_RORb:
++#if C_TARGETCPU == ARMV7LE
++			*(Bit32u*)pos=BFI(HOST_a1, HOST_a1, 8, 8);						// bfi a1, a1, 8, 8
++			*(Bit32u*)(pos+4)=BFI(HOST_a1, HOST_a1, 16, 16);				// bfi a1, a1, 16, 16
++			*(Bit32u*)(pos+8)=MOV_REG_ROR_REG(FC_RETOP, HOST_a1, HOST_a2);	// mov FC_RETOP, a1, ror a2
++#else
+ 			*(Bit32u*)pos=MOV_REG_LSL_IMM(FC_RETOP, HOST_a1, 24);					// mov FC_RETOP, a1, lsl #24
+ 			*(Bit32u*)(pos+4)=ORR_REG_LSR_IMM(FC_RETOP, FC_RETOP, FC_RETOP, 8);		// orr FC_RETOP, FC_RETOP, FC_RETOP, lsr #8
+ 			*(Bit32u*)(pos+8)=ORR_REG_LSR_IMM(FC_RETOP, FC_RETOP, FC_RETOP, 16);	// orr FC_RETOP, FC_RETOP, FC_RETOP, lsr #16
+ 			*(Bit32u*)(pos+12)=MOV_REG_ROR_REG(FC_RETOP, FC_RETOP, HOST_a2);		// mov FC_RETOP, FC_RETOP, ror a2
++#endif
+ 			break;
+ 		case t_RORw:
+-			*(Bit32u*)pos=MOV_REG_LSL_IMM(FC_RETOP, HOST_a1, 16);					// mov FC_RETOP, a1, lsl #16
+-			*(Bit32u*)(pos+4)=ORR_REG_LSR_IMM(FC_RETOP, FC_RETOP, FC_RETOP, 16);	// orr FC_RETOP, FC_RETOP, FC_RETOP, lsr #16
+-			*(Bit32u*)(pos+8)=MOV_REG_ROR_REG(FC_RETOP, FC_RETOP, HOST_a2);			// mov FC_RETOP, FC_RETOP, ror a2
+-			*(Bit32u*)(pos+12)=NOP;				// nop
++			*(Bit32u*)pos=NOP;					// nop
++#if C_TARGETCPU == ARMV7LE
++			*(Bit32u*)(pos+4)=BFI(HOST_a1, HOST_a1, 16, 16);				// bfi a1, a1, 16, 16
++			*(Bit32u*)(pos+8)=MOV_REG_ROR_REG(FC_RETOP, HOST_a1, HOST_a2);	// mov FC_RETOP, a1, ror a2
++#else
++			*(Bit32u*)(pos+4)=MOV_REG_LSL_IMM(FC_RETOP, HOST_a1, 16);				// mov FC_RETOP, a1, lsl #16
++			*(Bit32u*)(pos+8)=ORR_REG_LSR_IMM(FC_RETOP, FC_RETOP, FC_RETOP, 16);	// orr FC_RETOP, FC_RETOP, FC_RETOP, lsr #16
++			*(Bit32u*)(pos+12)=MOV_REG_ROR_REG(FC_RETOP, FC_RETOP, HOST_a2);		// mov FC_RETOP, FC_RETOP, ror a2
++#endif
+ 			break;
+ 		case t_RORd:
+-			*(Bit32u*)pos=MOV_REG_ROR_REG(FC_RETOP, HOST_a1, HOST_a2);	// mov FC_RETOP, a1, ror a2
++			*(Bit32u*)pos=NOP;					// nop
+ 			*(Bit32u*)(pos+4)=NOP;				// nop
+-			*(Bit32u*)(pos+8)=NOP;				// nop
++			*(Bit32u*)(pos+8)=MOV_REG_ROR_REG(FC_RETOP, HOST_a1, HOST_a2);	// mov FC_RETOP, a1, ror a2
++#if C_TARGETCPU != ARMV7LE
+ 			*(Bit32u*)(pos+12)=NOP;				// nop
++#endif
+ 			break;
+ 		case t_ROLw:
++#if C_TARGETCPU == ARMV7LE
++			*(Bit32u*)pos=BFI(HOST_a1, HOST_a1, 16, 16);					// bfi a1, a1, 16, 16
++			*(Bit32u*)(pos+4)=RSB_IMM(HOST_a2, HOST_a2, 32, 0);				// rsb a2, a2, #32
++			*(Bit32u*)(pos+8)=MOV_REG_ROR_REG(FC_RETOP, HOST_a1, HOST_a2);	// mov FC_RETOP, a1, ror a2
++#else
+ 			*(Bit32u*)pos=MOV_REG_LSL_IMM(FC_RETOP, HOST_a1, 16);					// mov FC_RETOP, a1, lsl #16
+ 			*(Bit32u*)(pos+4)=RSB_IMM(HOST_a2, HOST_a2, 32, 0);						// rsb a2, a2, #32
+ 			*(Bit32u*)(pos+8)=ORR_REG_LSR_IMM(FC_RETOP, FC_RETOP, FC_RETOP, 16);	// orr FC_RETOP, FC_RETOP, FC_RETOP, lsr #16
+ 			*(Bit32u*)(pos+12)=MOV_REG_ROR_REG(FC_RETOP, FC_RETOP, HOST_a2);		// mov FC_RETOP, FC_RETOP, ror a2
++#endif
+ 			break;
+ 		case t_ROLd:
+-			*(Bit32u*)pos=RSB_IMM(HOST_a2, HOST_a2, 32, 0);					// rsb a2, a2, #32
+-			*(Bit32u*)(pos+4)=MOV_REG_ROR_REG(FC_RETOP, HOST_a1, HOST_a2);	// mov FC_RETOP, a1, ror a2
+-			*(Bit32u*)(pos+8)=NOP;				// nop
+-			*(Bit32u*)(pos+12)=NOP;				// nop
++			*(Bit32u*)pos=NOP;					// nop
++#if C_TARGETCPU == ARMV7LE
++			*(Bit32u*)(pos+4)=RSB_IMM(HOST_a2, HOST_a2, 32, 0);				// rsb a2, a2, #32
++			*(Bit32u*)(pos+8)=MOV_REG_ROR_REG(FC_RETOP, HOST_a1, HOST_a2);	// mov FC_RETOP, a1, ror a2
++#else
++			*(Bit32u*)(pos+4)=NOP;				// nop
++			*(Bit32u*)(pos+8)=RSB_IMM(HOST_a2, HOST_a2, 32, 0);				// rsb a2, a2, #32
++			*(Bit32u*)(pos+12)=MOV_REG_ROR_REG(FC_RETOP, HOST_a1, HOST_a2);	// mov FC_RETOP, a1, ror a2
++#endif
+ 			break;
+ 		case t_NEGb:
+ 		case t_NEGw:
+ 		case t_NEGd:
+-			*(Bit32u*)pos=RSB_IMM(FC_RETOP, HOST_a1, 0, 0);	// rsb FC_RETOP, a1, #0
++			*(Bit32u*)pos=NOP;					// nop
+ 			*(Bit32u*)(pos+4)=NOP;				// nop
+-			*(Bit32u*)(pos+8)=NOP;				// nop
++			*(Bit32u*)(pos+8)=RSB_IMM(FC_RETOP, HOST_a1, 0, 0);	// rsb FC_RETOP, a1, #0
++#if C_TARGETCPU != ARMV7LE
+ 			*(Bit32u*)(pos+12)=NOP;				// nop
++#endif
+ 			break;
+ 		default:
++#if C_TARGETCPU == ARMV7LE
++			*(Bit32u*)pos=MOVW(temp1, ((Bit32u)fct_ptr) & 0xffff);      // movw temp1, #(fct_ptr & 0xffff)
++			*(Bit32u*)(pos+4)=MOVT(temp1, ((Bit32u)fct_ptr) >> 16);      // movt temp1, #(fct_ptr >> 16)
++#else
+ 			*(Bit32u*)(pos+12)=(Bit32u)fct_ptr;		// simple_func
++#endif
+ 			break;
+ 
+ 	}
+ #else
++#if C_TARGETCPU == ARMV7LE
++	*(Bit32u*)pos=MOVW(temp1, ((Bit32u)fct_ptr) & 0xffff);      // movw temp1, #(fct_ptr & 0xffff)
++	*(Bit32u*)(pos+4)=MOVT(temp1, ((Bit32u)fct_ptr) >> 16);      // movt temp1, #(fct_ptr >> 16)
++#else
+ 	*(Bit32u*)(pos+12)=(Bit32u)fct_ptr;		// simple_func
+ #endif
++#endif
+ }
+ #endif
+ 
+@@ -1044,7 +1263,7 @@
+ // the upper 24bit of the destination register can be destroyed
+ // this function can use FC_OP1/FC_OP2 as dest_reg which are
+ // not directly byte-accessible on some architectures
+-static void INLINE gen_mov_regbyte_to_reg_low_canuseword(HostReg dest_reg,Bitu index) {
++static void gen_mov_regbyte_to_reg_low_canuseword(HostReg dest_reg,Bitu index) {
+ 	cache_addd( LDRB_IMM(dest_reg, FC_REGS_ADDR, index) );      // ldrb dest_reg, [FC_REGS_ADDR, #index]
+ }
+ 
+diff -Nur dosbox-0.74/src/cpu/core_dynrec/risc_armv4le-s3.h dosbox/src/cpu/core_dynrec/risc_armv4le-s3.h
+--- dosbox-0.74/src/cpu/core_dynrec/risc_armv4le-s3.h	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/cpu/core_dynrec/risc_armv4le-s3.h	1970-01-01 01:00:00.000000000 +0100
+@@ -1,919 +0,0 @@
+-/*
+- *  Copyright (C) 2002-2010  The DOSBox Team
+- *
+- *  This program is free software; you can redistribute it and/or modify
+- *  it under the terms of the GNU General Public License as published by
+- *  the Free Software Foundation; either version 2 of the License, or
+- *  (at your option) any later version.
+- *
+- *  This program is distributed in the hope that it will be useful,
+- *  but WITHOUT ANY WARRANTY; without even the implied warranty of
+- *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+- *  GNU General Public License for more details.
+- *
+- *  You should have received a copy of the GNU General Public License
+- *  along with this program; if not, write to the Free Software
+- *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+- */
+-
+-/* $Id: risc_armv4le-s3.h,v 1.6 2009-06-27 12:51:10 c2woody Exp $ */
+-
+-
+-/* ARMv4 (little endian) backend by M-HT (speed-tweaked arm version) */
+-
+-
+-// temporary registers
+-#define temp1 HOST_ip
+-#define temp2 HOST_v3
+-#define temp3 HOST_v4
+-
+-// register that holds function return values
+-#define FC_RETOP HOST_a1
+-
+-// register used for address calculations,
+-#define FC_ADDR HOST_v1			// has to be saved across calls, see DRC_PROTECT_ADDR_REG
+-
+-// register that holds the first parameter
+-#define FC_OP1 HOST_a1
+-
+-// register that holds the second parameter
+-#define FC_OP2 HOST_a2
+-
+-// special register that holds the third parameter for _R3 calls (byte accessible)
+-#define FC_OP3 HOST_v2
+-
+-// register that holds byte-accessible temporary values
+-#define FC_TMP_BA1 HOST_a1
+-
+-// register that holds byte-accessible temporary values
+-#define FC_TMP_BA2 HOST_a2
+-
+-// temporary register for LEA
+-#define TEMP_REG_DRC HOST_v2
+-
+-#ifdef DRC_USE_REGS_ADDR
+-// used to hold the address of "cpu_regs" - preferably filled in function gen_run_code
+-#define FC_REGS_ADDR HOST_v7
+-#endif
+-
+-#ifdef DRC_USE_SEGS_ADDR
+-// used to hold the address of "Segs" - preferably filled in function gen_run_code
+-#define FC_SEGS_ADDR HOST_v8
+-#endif
+-
+-
+-// helper macro
+-#define ROTATE_SCALE(x) ( (x)?(32 - x):(0) )
+-
+-
+-// instruction encodings
+-
+-// move
+-// mov dst, #(imm ror rimm)		@	0 <= imm <= 255	&	rimm mod 2 = 0
+-#define MOV_IMM(dst, imm, rimm) (0xe3a00000 + ((dst) << 12) + (imm) + ((rimm) << 7) )
+-// mov dst, src, lsl #imm
+-#define MOV_REG_LSL_IMM(dst, src, imm) (0xe1a00000 + ((dst) << 12) + (src) + ((imm) << 7) )
+-// movs dst, src, lsl #imm
+-#define MOVS_REG_LSL_IMM(dst, src, imm) (0xe1b00000 + ((dst) << 12) + (src) + ((imm) << 7) )
+-// mov dst, src, lsr #imm
+-#define MOV_REG_LSR_IMM(dst, src, imm) (0xe1a00020 + ((dst) << 12) + (src) + ((imm) << 7) )
+-// mov dst, src, asr #imm
+-#define MOV_REG_ASR_IMM(dst, src, imm) (0xe1a00040 + ((dst) << 12) + (src) + ((imm) << 7) )
+-// mov dst, src, lsl rreg
+-#define MOV_REG_LSL_REG(dst, src, rreg) (0xe1a00010 + ((dst) << 12) + (src) + ((rreg) << 8) )
+-// mov dst, src, lsr rreg
+-#define MOV_REG_LSR_REG(dst, src, rreg) (0xe1a00030 + ((dst) << 12) + (src) + ((rreg) << 8) )
+-// mov dst, src, asr rreg
+-#define MOV_REG_ASR_REG(dst, src, rreg) (0xe1a00050 + ((dst) << 12) + (src) + ((rreg) << 8) )
+-// mov dst, src, ror rreg
+-#define MOV_REG_ROR_REG(dst, src, rreg) (0xe1a00070 + ((dst) << 12) + (src) + ((rreg) << 8) )
+-// mvn dst, #(imm ror rimm)		@	0 <= imm <= 255	&	rimm mod 2 = 0
+-#define MVN_IMM(dst, imm, rimm) (0xe3e00000 + ((dst) << 12) + (imm) + ((rimm) << 7) )
+-
+-// arithmetic
+-// add dst, src, #(imm ror rimm)		@	0 <= imm <= 255	&	rimm mod 2 = 0
+-#define ADD_IMM(dst, src, imm, rimm) (0xe2800000 + ((dst) << 12) + ((src) << 16) + (imm) + ((rimm) << 7) )
+-// add dst, src1, src2, lsl #imm
+-#define ADD_REG_LSL_IMM(dst, src1, src2, imm) (0xe0800000 + ((dst) << 12) + ((src1) << 16) + (src2) + ((imm) << 7) )
+-// sub dst, src, #(imm ror rimm)		@	0 <= imm <= 255	&	rimm mod 2 = 0
+-#define SUB_IMM(dst, src, imm, rimm) (0xe2400000 + ((dst) << 12) + ((src) << 16) + (imm) + ((rimm) << 7) )
+-// sub dst, src1, src2, lsl #imm
+-#define SUB_REG_LSL_IMM(dst, src1, src2, imm) (0xe0400000 + ((dst) << 12) + ((src1) << 16) + (src2) + ((imm) << 7) )
+-// rsb dst, src, #(imm ror rimm)		@	0 <= imm <= 255	&	rimm mod 2 = 0
+-#define RSB_IMM(dst, src, imm, rimm) (0xe2600000 + ((dst) << 12) + ((src) << 16) + (imm) + ((rimm) << 7) )
+-// cmp src, #(imm ror rimm)		@	0 <= imm <= 255	&	rimm mod 2 = 0
+-#define CMP_IMM(src, imm, rimm) (0xe3500000 + ((src) << 16) + (imm) + ((rimm) << 7) )
+-// nop
+-#define NOP MOV_REG_LSL_IMM(HOST_r0, HOST_r0, 0)
+-
+-// logical
+-// tst src, #(imm ror rimm)		@	0 <= imm <= 255	&	rimm mod 2 = 0
+-#define TST_IMM(src, imm, rimm) (0xe3100000 + ((src) << 16) + (imm) + ((rimm) << 7) )
+-// and dst, src, #(imm ror rimm)		@	0 <= imm <= 255	&	rimm mod 2 = 0
+-#define AND_IMM(dst, src, imm, rimm) (0xe2000000 + ((dst) << 12) + ((src) << 16) + (imm) + ((rimm) << 7) )
+-// and dst, src1, src2, lsl #imm
+-#define AND_REG_LSL_IMM(dst, src1, src2, imm) (0xe0000000 + ((dst) << 12) + ((src1) << 16) + (src2) + ((imm) << 7) )
+-// orr dst, src, #(imm ror rimm)		@	0 <= imm <= 255	&	rimm mod 2 = 0
+-#define ORR_IMM(dst, src, imm, rimm) (0xe3800000 + ((dst) << 12) + ((src) << 16) + (imm) + ((rimm) << 7) )
+-// orr dst, src1, src2, lsl #imm
+-#define ORR_REG_LSL_IMM(dst, src1, src2, imm) (0xe1800000 + ((dst) << 12) + ((src1) << 16) + (src2) + ((imm) << 7) )
+-// orr dst, src1, src2, lsr #imm
+-#define ORR_REG_LSR_IMM(dst, src1, src2, imm) (0xe1800020 + ((dst) << 12) + ((src1) << 16) + (src2) + ((imm) << 7) )
+-// eor dst, src1, src2, lsl #imm
+-#define EOR_REG_LSL_IMM(dst, src1, src2, imm) (0xe0200000 + ((dst) << 12) + ((src1) << 16) + (src2) + ((imm) << 7) )
+-// bic dst, src, #(imm ror rimm)		@	0 <= imm <= 255	&	rimm mod 2 = 0
+-#define BIC_IMM(dst, src, imm, rimm) (0xe3c00000 + ((dst) << 12) + ((src) << 16) + (imm) + ((rimm) << 7) )
+-
+-// load
+-// ldr reg, [addr, #imm]		@	0 <= imm < 4096
+-#define LDR_IMM(reg, addr, imm) (0xe5900000 + ((reg) << 12) + ((addr) << 16) + (imm) )
+-// ldrh reg, [addr, #imm]		@	0 <= imm < 256
+-#define LDRH_IMM(reg, addr, imm) (0xe1d000b0 + ((reg) << 12) + ((addr) << 16) + (((imm) & 0xf0) << 4) + ((imm) & 0x0f) )
+-// ldrb reg, [addr, #imm]		@	0 <= imm < 4096
+-#define LDRB_IMM(reg, addr, imm) (0xe5d00000 + ((reg) << 12) + ((addr) << 16) + (imm) )
+-
+-// store
+-// str reg, [addr, #imm]		@	0 <= imm < 4096
+-#define STR_IMM(reg, addr, imm) (0xe5800000 + ((reg) << 12) + ((addr) << 16) + (imm) )
+-// strh reg, [addr, #imm]		@	0 <= imm < 256
+-#define STRH_IMM(reg, addr, imm) (0xe1c000b0 + ((reg) << 12) + ((addr) << 16) + (((imm) & 0xf0) << 4) + ((imm) & 0x0f) )
+-// strb reg, [addr, #imm]		@	0 <= imm < 4096
+-#define STRB_IMM(reg, addr, imm) (0xe5c00000 + ((reg) << 12) + ((addr) << 16) + (imm) )
+-
+-// branch
+-// beq pc+imm		@	0 <= imm < 32M	&	imm mod 4 = 0
+-#define BEQ_FWD(imm) (0x0a000000 + ((imm) >> 2) )
+-// bne pc+imm		@	0 <= imm < 32M	&	imm mod 4 = 0
+-#define BNE_FWD(imm) (0x1a000000 + ((imm) >> 2) )
+-// bgt pc+imm		@	0 <= imm < 32M	&	imm mod 4 = 0
+-#define BGT_FWD(imm) (0xca000000 + ((imm) >> 2) )
+-// b pc+imm		@	0 <= imm < 32M	&	imm mod 4 = 0
+-#define B_FWD(imm) (0xea000000 + ((imm) >> 2) )
+-// bx reg
+-#define BX(reg) (0xe12fff10 + (reg) )
+-
+-
+-// move a full register from reg_src to reg_dst
+-static void gen_mov_regs(HostReg reg_dst,HostReg reg_src) {
+-	if(reg_src == reg_dst) return;
+-	cache_addd( MOV_REG_LSL_IMM(reg_dst, reg_src, 0) );      // mov reg_dst, reg_src
+-}
+-
+-// move a 32bit constant value into dest_reg
+-static void gen_mov_dword_to_reg_imm(HostReg dest_reg,Bit32u imm) {
+-	Bits first, scale;
+-	if (imm == 0) {
+-		cache_addd( MOV_IMM(dest_reg, 0, 0) );      // mov dest_reg, #0
+-	} else {
+-		scale = 0;
+-		first = 1;
+-		while (imm) {
+-			while ((imm & 3) == 0) {
+-				imm>>=2;
+-				scale+=2;
+-			}
+-			if (first) {
+-				cache_addd( MOV_IMM(dest_reg, imm & 0xff, ROTATE_SCALE(scale)) );      // mov dest_reg, #((imm & 0xff) << scale)
+-				first = 0;
+-			} else {
+-				cache_addd( ORR_IMM(dest_reg, dest_reg, imm & 0xff, ROTATE_SCALE(scale)) );      // orr dest_reg, dest_reg, #((imm & 0xff) << scale)
+-			}
+-			imm>>=8;
+-			scale+=8;
+-		}
+-	}
+-}
+-
+-// helper function for gen_mov_word_to_reg
+-static void gen_mov_word_to_reg_helper(HostReg dest_reg,void* data,bool dword,HostReg data_reg) {
+-	// alignment....
+-	if (dword) {
+-		if ((Bit32u)data & 3) {
+-			if ( ((Bit32u)data & 3) == 2 ) {
+-				cache_addd( LDRH_IMM(dest_reg, data_reg, 0) );      // ldrh dest_reg, [data_reg]
+-				cache_addd( LDRH_IMM(temp2, data_reg, 2) );      // ldrh temp2, [data_reg, #2]
+-				cache_addd( ORR_REG_LSL_IMM(dest_reg, dest_reg, temp2, 16) );      // orr dest_reg, dest_reg, temp2, lsl #16
+-			} else {
+-				cache_addd( LDRB_IMM(dest_reg, data_reg, 0) );      // ldrb dest_reg, [data_reg]
+-				cache_addd( LDRH_IMM(temp2, data_reg, 1) );      // ldrh temp2, [data_reg, #1]
+-				cache_addd( ORR_REG_LSL_IMM(dest_reg, dest_reg, temp2, 8) );      // orr dest_reg, dest_reg, temp2, lsl #8
+-				cache_addd( LDRB_IMM(temp2, data_reg, 3) );      // ldrb temp2, [data_reg, #3]
+-				cache_addd( ORR_REG_LSL_IMM(dest_reg, dest_reg, temp2, 24) );      // orr dest_reg, dest_reg, temp2, lsl #24
+-			}
+-		} else {
+-			cache_addd( LDR_IMM(dest_reg, data_reg, 0) );      // ldr dest_reg, [data_reg]
+-		}
+-	} else {
+-		if ((Bit32u)data & 1) {
+-			cache_addd( LDRB_IMM(dest_reg, data_reg, 0) );      // ldrb dest_reg, [data_reg]
+-			cache_addd( LDRB_IMM(temp2, data_reg, 1) );      // ldrb temp2, [data_reg, #1]
+-			cache_addd( ORR_REG_LSL_IMM(dest_reg, dest_reg, temp2, 8) );      // orr dest_reg, dest_reg, temp2, lsl #8
+-		} else {
+-			cache_addd( LDRH_IMM(dest_reg, data_reg, 0) );      // ldrh dest_reg, [data_reg]
+-		}
+-	}
+-}
+-
+-// move a 32bit (dword==true) or 16bit (dword==false) value from memory into dest_reg
+-// 16bit moves may destroy the upper 16bit of the destination register
+-static void gen_mov_word_to_reg(HostReg dest_reg,void* data,bool dword) {
+-	gen_mov_dword_to_reg_imm(temp1, (Bit32u)data);
+-	gen_mov_word_to_reg_helper(dest_reg, data, dword, temp1);
+-}
+-
+-// move a 16bit constant value into dest_reg
+-// the upper 16bit of the destination register may be destroyed
+-static void INLINE gen_mov_word_to_reg_imm(HostReg dest_reg,Bit16u imm) {
+-	gen_mov_dword_to_reg_imm(dest_reg, (Bit32u)imm);
+-}
+-
+-// helper function for gen_mov_word_from_reg
+-static void gen_mov_word_from_reg_helper(HostReg src_reg,void* dest,bool dword, HostReg data_reg) {
+-	// alignment....
+-	if (dword) {
+-		if ((Bit32u)dest & 3) {
+-			if ( ((Bit32u)dest & 3) == 2 ) {
+-				cache_addd( STRH_IMM(src_reg, data_reg, 0) );      // strh src_reg, [data_reg]
+-				cache_addd( MOV_REG_LSR_IMM(temp2, src_reg, 16) );      // mov temp2, src_reg, lsr #16
+-				cache_addd( STRH_IMM(temp2, data_reg, 2) );      // strh temp2, [data_reg, #2]
+-			} else {
+-				cache_addd( STRB_IMM(src_reg, data_reg, 0) );      // strb src_reg, [data_reg]
+-				cache_addd( MOV_REG_LSR_IMM(temp2, src_reg, 8) );      // mov temp2, src_reg, lsr #8
+-				cache_addd( STRH_IMM(temp2, data_reg, 1) );      // strh temp2, [data_reg, #1]
+-				cache_addd( MOV_REG_LSR_IMM(temp2, temp2, 16) );      // mov temp2, temp2, lsr #16
+-				cache_addd( STRB_IMM(temp2, data_reg, 3) );      // strb temp2, [data_reg, #3]
+-			}
+-		} else {
+-			cache_addd( STR_IMM(src_reg, data_reg, 0) );      // str src_reg, [data_reg]
+-		}
+-	} else {
+-		if ((Bit32u)dest & 1) {
+-			cache_addd( STRB_IMM(src_reg, data_reg, 0) );      // strb src_reg, [data_reg]
+-			cache_addd( MOV_REG_LSR_IMM(temp2, src_reg, 8) );      // mov temp2, src_reg, lsr #8
+-			cache_addd( STRB_IMM(temp2, data_reg, 1) );      // strb temp2, [data_reg, #1]
+-		} else {
+-			cache_addd( STRH_IMM(src_reg, data_reg, 0) );      // strh src_reg, [data_reg]
+-		}
+-	}
+-}
+-
+-// move 32bit (dword==true) or 16bit (dword==false) of a register into memory
+-static void gen_mov_word_from_reg(HostReg src_reg,void* dest,bool dword) {
+-	gen_mov_dword_to_reg_imm(temp1, (Bit32u)dest);
+-	gen_mov_word_from_reg_helper(src_reg, dest, dword, temp1);
+-}
+-
+-// move an 8bit value from memory into dest_reg
+-// the upper 24bit of the destination register can be destroyed
+-// this function does not use FC_OP1/FC_OP2 as dest_reg as these
+-// registers might not be directly byte-accessible on some architectures
+-static void gen_mov_byte_to_reg_low(HostReg dest_reg,void* data) {
+-	gen_mov_dword_to_reg_imm(temp1, (Bit32u)data);
+-	cache_addd( LDRB_IMM(dest_reg, temp1, 0) );      // ldrb dest_reg, [temp1]
+-}
+-
+-// move an 8bit value from memory into dest_reg
+-// the upper 24bit of the destination register can be destroyed
+-// this function can use FC_OP1/FC_OP2 as dest_reg which are
+-// not directly byte-accessible on some architectures
+-static void INLINE gen_mov_byte_to_reg_low_canuseword(HostReg dest_reg,void* data) {
+-	gen_mov_byte_to_reg_low(dest_reg, data);
+-}
+-
+-// move an 8bit constant value into dest_reg
+-// the upper 24bit of the destination register can be destroyed
+-// this function does not use FC_OP1/FC_OP2 as dest_reg as these
+-// registers might not be directly byte-accessible on some architectures
+-static void gen_mov_byte_to_reg_low_imm(HostReg dest_reg,Bit8u imm) {
+-	cache_addd( MOV_IMM(dest_reg, imm, 0) );      // mov dest_reg, #(imm)
+-}
+-
+-// move an 8bit constant value into dest_reg
+-// the upper 24bit of the destination register can be destroyed
+-// this function can use FC_OP1/FC_OP2 as dest_reg which are
+-// not directly byte-accessible on some architectures
+-static void INLINE gen_mov_byte_to_reg_low_imm_canuseword(HostReg dest_reg,Bit8u imm) {
+-	gen_mov_byte_to_reg_low_imm(dest_reg, imm);
+-}
+-
+-// move the lowest 8bit of a register into memory
+-static void gen_mov_byte_from_reg_low(HostReg src_reg,void* dest) {
+-	gen_mov_dword_to_reg_imm(temp1, (Bit32u)dest);
+-	cache_addd( STRB_IMM(src_reg, temp1, 0) );      // strb src_reg, [temp1]
+-}
+-
+-
+-
+-// convert an 8bit word to a 32bit dword
+-// the register is zero-extended (sign==false) or sign-extended (sign==true)
+-static void gen_extend_byte(bool sign,HostReg reg) {
+-	if (sign) {
+-		cache_addd( MOV_REG_LSL_IMM(reg, reg, 24) );      // mov reg, reg, lsl #24
+-		cache_addd( MOV_REG_ASR_IMM(reg, reg, 24) );      // mov reg, reg, asr #24
+-	} else {
+-		cache_addd( AND_IMM(reg, reg, 0xff, 0) );      // and reg, reg, #0xff
+-	}
+-}
+-
+-// convert a 16bit word to a 32bit dword
+-// the register is zero-extended (sign==false) or sign-extended (sign==true)
+-static void gen_extend_word(bool sign,HostReg reg) {
+-	if (sign) {
+-		cache_addd( MOV_REG_LSL_IMM(reg, reg, 16) );      // mov reg, reg, lsl #16
+-		cache_addd( MOV_REG_ASR_IMM(reg, reg, 16) );      // mov reg, reg, asr #16
+-	} else {
+-		cache_addd( MOV_REG_LSL_IMM(reg, reg, 16) );      // mov reg, reg, lsl #16
+-		cache_addd( MOV_REG_LSR_IMM(reg, reg, 16) );      // mov reg, reg, lsr #16
+-	}
+-}
+-
+-// add a 32bit value from memory to a full register
+-static void gen_add(HostReg reg,void* op) {
+-	gen_mov_word_to_reg(temp3, op, 1);
+-	cache_addd( ADD_REG_LSL_IMM(reg, reg, temp3, 0) );      // add reg, reg, temp3
+-}
+-
+-// add a 32bit constant value to a full register
+-static void gen_add_imm(HostReg reg,Bit32u imm) {
+-	Bits scale;
+-	if(!imm) return;
+-	if (imm == 0xffffffff) {
+-		cache_addd( SUB_IMM(reg, reg, 1, 0) );      // sub reg, reg, #1
+-	} else {
+-		scale = 0;
+-		while (imm) {
+-			while ((imm & 3) == 0) {
+-				imm>>=2;
+-				scale+=2;
+-			}
+-			cache_addd( ADD_IMM(reg, reg, imm & 0xff, ROTATE_SCALE(scale)) );      // add reg, reg, #((imm & 0xff) << scale)
+-			imm>>=8;
+-			scale+=8;
+-		}
+-	}
+-}
+-
+-// and a 32bit constant value with a full register
+-static void gen_and_imm(HostReg reg,Bit32u imm) {
+-	Bits scale;
+-	Bit32u imm2;
+-	imm2 = ~imm;
+-	if(!imm2) return;
+-	if (!imm) {
+-		cache_addd( MOV_IMM(reg, 0, 0) );      // mov reg, #0
+-	} else {
+-		scale = 0;
+-		while (imm2) {
+-			while ((imm2 & 3) == 0) {
+-				imm2>>=2;
+-				scale+=2;
+-			}
+-			cache_addd( BIC_IMM(reg, reg, imm2 & 0xff, ROTATE_SCALE(scale)) );      // bic reg, reg, #((imm2 & 0xff) << scale)
+-			imm2>>=8;
+-			scale+=8;
+-		}
+-	}
+-}
+-
+-
+-// move a 32bit constant value into memory
+-static void gen_mov_direct_dword(void* dest,Bit32u imm) {
+-	gen_mov_dword_to_reg_imm(temp3, imm);
+-	gen_mov_word_from_reg(temp3, dest, 1);
+-}
+-
+-// move an address into memory
+-static void INLINE gen_mov_direct_ptr(void* dest,DRC_PTR_SIZE_IM imm) {
+-	gen_mov_direct_dword(dest,(Bit32u)imm);
+-}
+-
+-// add an 8bit constant value to a dword memory value
+-static void gen_add_direct_byte(void* dest,Bit8s imm) {
+-	if(!imm) return;
+-	gen_mov_dword_to_reg_imm(temp1, (Bit32u)dest);
+-	gen_mov_word_to_reg_helper(temp3, dest, 1, temp1);
+-	if (imm >= 0) {
+-		cache_addd( ADD_IMM(temp3, temp3, (Bit32s)imm, 0) );      // add temp3, temp3, #(imm)
+-	} else {
+-		cache_addd( SUB_IMM(temp3, temp3, -((Bit32s)imm), 0) );      // sub temp3, temp3, #(-imm)
+-	}
+-	gen_mov_word_from_reg_helper(temp3, dest, 1, temp1);
+-}
+-
+-// add a 32bit (dword==true) or 16bit (dword==false) constant value to a memory value
+-static void gen_add_direct_word(void* dest,Bit32u imm,bool dword) {
+-	if(!imm) return;
+-	if (dword && ( (imm<128) || (imm>=0xffffff80) ) ) {
+-		gen_add_direct_byte(dest,(Bit8s)imm);
+-		return;
+-	}
+-	gen_mov_dword_to_reg_imm(temp1, (Bit32u)dest);
+-	gen_mov_word_to_reg_helper(temp3, dest, dword, temp1);
+-	// maybe use function gen_add_imm
+-	if (dword) {
+-		gen_mov_dword_to_reg_imm(temp2, imm);
+-	} else {
+-		gen_mov_word_to_reg_imm(temp2, (Bit16u)imm);
+-	}
+-	cache_addd( ADD_REG_LSL_IMM(temp3, temp3, temp2, 0) );      // add temp3, temp3, temp2
+-	gen_mov_word_from_reg_helper(temp3, dest, dword, temp1);
+-}
+-
+-// subtract an 8bit constant value from a dword memory value
+-static void gen_sub_direct_byte(void* dest,Bit8s imm) {
+-	if(!imm) return;
+-	gen_mov_dword_to_reg_imm(temp1, (Bit32u)dest);
+-	gen_mov_word_to_reg_helper(temp3, dest, 1, temp1);
+-	if (imm >= 0) {
+-		cache_addd( SUB_IMM(temp3, temp3, (Bit32s)imm, 0) );      // sub temp3, temp3, #(imm)
+-	} else {
+-		cache_addd( ADD_IMM(temp3, temp3, -((Bit32s)imm), 0) );      // add temp3, temp3, #(-imm)
+-	}
+-	gen_mov_word_from_reg_helper(temp3, dest, 1, temp1);
+-}
+-
+-// subtract a 32bit (dword==true) or 16bit (dword==false) constant value from a memory value
+-static void gen_sub_direct_word(void* dest,Bit32u imm,bool dword) {
+-	if(!imm) return;
+-	if (dword && ( (imm<128) || (imm>=0xffffff80) ) ) {
+-		gen_sub_direct_byte(dest,(Bit8s)imm);
+-		return;
+-	}
+-	gen_mov_dword_to_reg_imm(temp1, (Bit32u)dest);
+-	gen_mov_word_to_reg_helper(temp3, dest, dword, temp1);
+-	// maybe use function gen_add_imm/gen_sub_imm
+-	if (dword) {
+-		gen_mov_dword_to_reg_imm(temp2, imm);
+-	} else {
+-		gen_mov_word_to_reg_imm(temp2, (Bit16u)imm);
+-	}
+-	cache_addd( SUB_REG_LSL_IMM(temp3, temp3, temp2, 0) );      // sub temp3, temp3, temp2
+-	gen_mov_word_from_reg_helper(temp3, dest, dword, temp1);
+-}
+-
+-// effective address calculation, destination is dest_reg
+-// scale_reg is scaled by scale (scale_reg*(2^scale)) and
+-// added to dest_reg, then the immediate value is added
+-static INLINE void gen_lea(HostReg dest_reg,HostReg scale_reg,Bitu scale,Bits imm) {
+-	cache_addd( ADD_REG_LSL_IMM(dest_reg, dest_reg, scale_reg, scale) );      // add dest_reg, dest_reg, scale_reg, lsl #(scale)
+-	gen_add_imm(dest_reg, imm);
+-}
+-
+-// effective address calculation, destination is dest_reg
+-// dest_reg is scaled by scale (dest_reg*(2^scale)),
+-// then the immediate value is added
+-static INLINE void gen_lea(HostReg dest_reg,Bitu scale,Bits imm) {
+-	if (scale) {
+-		cache_addd( MOV_REG_LSL_IMM(dest_reg, dest_reg, scale) );      // mov dest_reg, dest_reg, lsl #(scale)
+-	}
+-	gen_add_imm(dest_reg, imm);
+-}
+-
+-// generate a call to a parameterless function
+-static void INLINE gen_call_function_raw(void * func) {
+-	cache_addd( LDR_IMM(temp1, HOST_pc, 4) );      // ldr temp1, [pc, #4]
+-	cache_addd( ADD_IMM(HOST_lr, HOST_pc, 4, 0) );      // add lr, pc, #4
+-	cache_addd( BX(temp1) );      // bx temp1
+-	cache_addd((Bit32u)func);      // .int func
+-}
+-
+-// generate a call to a function with paramcount parameters
+-// note: the parameters are loaded in the architecture specific way
+-// using the gen_load_param_ functions below
+-static Bit32u INLINE gen_call_function_setup(void * func,Bitu paramcount,bool fastcall=false) {
+-	Bit32u proc_addr = (Bit32u)cache.pos;
+-	gen_call_function_raw(func);
+-	return proc_addr;
+-}
+-
+-#if (1)
+-// max of 4 parameters in a1-a4
+-
+-// load an immediate value as param'th function parameter
+-static void INLINE gen_load_param_imm(Bitu imm,Bitu param) {
+-	gen_mov_dword_to_reg_imm(param, imm);
+-}
+-
+-// load an address as param'th function parameter
+-static void INLINE gen_load_param_addr(Bitu addr,Bitu param) {
+-	gen_mov_dword_to_reg_imm(param, addr);
+-}
+-
+-// load a host-register as param'th function parameter
+-static void INLINE gen_load_param_reg(Bitu reg,Bitu param) {
+-	gen_mov_regs(param, reg);
+-}
+-
+-// load a value from memory as param'th function parameter
+-static void INLINE gen_load_param_mem(Bitu mem,Bitu param) {
+-	gen_mov_word_to_reg(param, (void *)mem, 1);
+-}
+-#else
+-	other arm abis
+-#endif
+-
+-// jump to an address pointed at by ptr, offset is in imm
+-static void gen_jmp_ptr(void * ptr,Bits imm=0) {
+-	Bits scale;
+-	Bitu imm2;
+-	gen_mov_word_to_reg(temp3, ptr, 1);
+-
+-	if (imm) {
+-		scale = 0;
+-		imm2 = (Bitu)imm;
+-		while (imm2) {
+-			while ((imm2 & 3) == 0) {
+-				imm2>>=2;
+-				scale+=2;
+-			}
+-			cache_addd( ADD_IMM(temp3, temp3, imm2 & 0xff, ROTATE_SCALE(scale)) );      // add temp3, temp3, #((imm2 & 0xff) << scale)
+-			imm2>>=8;
+-			scale+=8;
+-		}
+-	}
+-
+-#if (1)
+-// (*ptr) should be word aligned 
+-	if ((imm & 0x03) == 0) {
+-		cache_addd( LDR_IMM(temp1, temp3, 0) );      // ldr temp1, [temp3]
+-	} else
+-#endif
+-	{
+-		cache_addd( LDRB_IMM(temp1, temp3, 0) );      // ldrb temp1, [temp3]
+-		cache_addd( LDRB_IMM(temp2, temp3, 1) );      // ldrb temp2, [temp3, #1]
+-		cache_addd( ORR_REG_LSL_IMM(temp1, temp1, temp2, 8) );      // orr temp1, temp1, temp2, lsl #8
+-		cache_addd( LDRB_IMM(temp2, temp3, 2) );      // ldrb temp2, [temp3, #2]
+-		cache_addd( ORR_REG_LSL_IMM(temp1, temp1, temp2, 16) );      // orr temp1, temp1, temp2, lsl #16
+-		cache_addd( LDRB_IMM(temp2, temp3, 3) );      // ldrb temp2, [temp3, #3]
+-		cache_addd( ORR_REG_LSL_IMM(temp1, temp1, temp2, 24) );      // orr temp1, temp1, temp2, lsl #24
+-	}
+-
+-	cache_addd( BX(temp1) );      // bx temp1
+-}
+-
+-// short conditional jump (+-127 bytes) if register is zero
+-// the destination is set by gen_fill_branch() later
+-static Bit32u gen_create_branch_on_zero(HostReg reg,bool dword) {
+-	if (dword) {
+-		cache_addd( CMP_IMM(reg, 0, 0) );      // cmp reg, #0
+-	} else {
+-		cache_addd( MOVS_REG_LSL_IMM(temp1, reg, 16) );      // movs temp1, reg, lsl #16
+-	}
+-	cache_addd( BEQ_FWD(0) );      // beq j
+-	return ((Bit32u)cache.pos-4);
+-}
+-
+-// short conditional jump (+-127 bytes) if register is nonzero
+-// the destination is set by gen_fill_branch() later
+-static Bit32u gen_create_branch_on_nonzero(HostReg reg,bool dword) {
+-	if (dword) {
+-		cache_addd( CMP_IMM(reg, 0, 0) );      // cmp reg, #0
+-	} else {
+-		cache_addd( MOVS_REG_LSL_IMM(temp1, reg, 16) );      // movs temp1, reg, lsl #16
+-	}
+-	cache_addd( BNE_FWD(0) );      // bne j
+-	return ((Bit32u)cache.pos-4);
+-}
+-
+-// calculate relative offset and fill it into the location pointed to by data
+-static void INLINE gen_fill_branch(DRC_PTR_SIZE_IM data) {
+-#if C_DEBUG
+-	Bits len=(Bit32u)cache.pos-(data+8);
+-	if (len<0) len=-len;
+-	if (len>0x02000000) LOG_MSG("Big jump %d",len);
+-#endif
+-	*(Bit32u*)data=( (*(Bit32u*)data) & 0xff000000 ) | ( ( ((Bit32u)cache.pos - (data+8)) >> 2 ) & 0x00ffffff );
+-}
+-
+-// conditional jump if register is nonzero
+-// for isdword==true the 32bit of the register are tested
+-// for isdword==false the lowest 8bit of the register are tested
+-static Bit32u gen_create_branch_long_nonzero(HostReg reg,bool isdword) {
+-	if (isdword) {
+-		cache_addd( CMP_IMM(reg, 0, 0) );      // cmp reg, #0
+-	} else {
+-		cache_addd( TST_IMM(reg, 0xff, 0) );      // tst reg, #0xff
+-	}
+-	cache_addd( BEQ_FWD(8) );      // beq nobranch (pc +8)
+-	cache_addd( LDR_IMM(temp1, HOST_pc, 0) );      // ldr temp1, [pc, #0]
+-	cache_addd( BX(temp1) );      // bx temp1
+-	cache_addd(0);      // fill j
+-	// nobranch:
+-	return ((Bit32u)cache.pos-4);
+-}
+-
+-// compare 32bit-register against zero and jump if value less/equal than zero
+-static Bit32u gen_create_branch_long_leqzero(HostReg reg) {
+-	cache_addd( CMP_IMM(reg, 0, 0) );      // cmp reg, #0
+-	cache_addd( BGT_FWD(8) );      // bgt nobranch (pc+8)
+-	cache_addd( LDR_IMM(temp1, HOST_pc, 0) );      // ldr temp1, [pc, #0]
+-	cache_addd( BX(temp1) );      // bx temp1
+-	cache_addd(0);      // fill j
+-	// nobranch:
+-	return ((Bit32u)cache.pos-4);
+-}
+-
+-// calculate long relative offset and fill it into the location pointed to by data
+-static void INLINE gen_fill_branch_long(Bit32u data) {
+-	// this is an absolute branch
+-	*(Bit32u*)data=(Bit32u)cache.pos;
+-}
+-
+-static void gen_run_code(void) {
+-	cache_addd(0xe92d4000);			// stmfd sp!, {lr}
+-	cache_addd(0xe92d0cf0);			// stmfd sp!, {v1-v4,v7,v8}
+-
+-	// adr: 8
+-	cache_addd( LDR_IMM(FC_SEGS_ADDR, HOST_pc, 64 - (8 + 8)) );      // ldr FC_SEGS_ADDR, [pc, #(&Segs)]
+-	// adr: 12
+-	cache_addd( LDR_IMM(FC_REGS_ADDR, HOST_pc, 68 - (12 + 8)) );      // ldr FC_REGS_ADDR, [pc, #(&cpu_regs)]
+-
+-	cache_addd( ADD_IMM(HOST_lr, HOST_pc, 4, 0) );			// add lr, pc, #4
+-	cache_addd(0xe92d4000);			// stmfd sp!, {lr}
+-	cache_addd( BX(HOST_r0) );			// bx r0	
+-
+-	cache_addd(0xe8bd0cf0);			// ldmfd sp!, {v1-v4,v7,v8}
+-
+-	cache_addd(0xe8bd4000);			// ldmfd sp!, {lr}
+-	cache_addd( BX(HOST_lr) );			// bx lr
+-
+-	// fill up to 64 bytes
+-	cache_addd( NOP );			// nop
+-	cache_addd( NOP );			// nop
+-	cache_addd( NOP );			// nop
+-	cache_addd( NOP );			// nop
+-	cache_addd( NOP );			// nop
+-	cache_addd( NOP );			// nop
+-
+-	// adr: 64
+-	cache_addd((Bit32u)&Segs);      // address of "Segs"
+-	// adr: 68
+-	cache_addd((Bit32u)&cpu_regs);  // address of "cpu_regs"
+-}
+-
+-// return from a function
+-static void gen_return_function(void) {
+-	cache_addd(0xe8bd4000);			// ldmfd sp!, {lr}
+-	cache_addd( BX(HOST_lr) );			// bx lr
+-}
+-
+-#ifdef DRC_FLAGS_INVALIDATION
+-
+-// called when a call to a function can be replaced by a
+-// call to a simpler function
+-static void gen_fill_function_ptr(Bit8u * pos,void* fct_ptr,Bitu flags_type) {
+-#ifdef DRC_FLAGS_INVALIDATION_DCODE
+-	// try to avoid function calls but rather directly fill in code
+-	switch (flags_type) {
+-		case t_ADDb:
+-		case t_ADDw:
+-		case t_ADDd:
+-			*(Bit32u*)pos=ADD_REG_LSL_IMM(FC_RETOP, HOST_a1, HOST_a2, 0);	// add FC_RETOP, a1, a2
+-			*(Bit32u*)(pos+4)=NOP;				// nop
+-			*(Bit32u*)(pos+8)=NOP;				// nop
+-			*(Bit32u*)(pos+12)=NOP;				// nop
+-			break;
+-		case t_ORb:
+-		case t_ORw:
+-		case t_ORd:
+-			*(Bit32u*)pos=ORR_REG_LSL_IMM(FC_RETOP, HOST_a1, HOST_a2, 0);	// orr FC_RETOP, a1, a2
+-			*(Bit32u*)(pos+4)=NOP;				// nop
+-			*(Bit32u*)(pos+8)=NOP;				// nop
+-			*(Bit32u*)(pos+12)=NOP;				// nop
+-			break;
+-		case t_ANDb:
+-		case t_ANDw:
+-		case t_ANDd:
+-			*(Bit32u*)pos=AND_REG_LSL_IMM(FC_RETOP, HOST_a1, HOST_a2, 0);	// and FC_RETOP, a1, a2
+-			*(Bit32u*)(pos+4)=NOP;				// nop
+-			*(Bit32u*)(pos+8)=NOP;				// nop
+-			*(Bit32u*)(pos+12)=NOP;				// nop
+-			break;
+-		case t_SUBb:
+-		case t_SUBw:
+-		case t_SUBd:
+-			*(Bit32u*)pos=SUB_REG_LSL_IMM(FC_RETOP, HOST_a1, HOST_a2, 0);	// sub FC_RETOP, a1, a2
+-			*(Bit32u*)(pos+4)=NOP;				// nop
+-			*(Bit32u*)(pos+8)=NOP;				// nop
+-			*(Bit32u*)(pos+12)=NOP;				// nop
+-			break;
+-		case t_XORb:
+-		case t_XORw:
+-		case t_XORd:
+-			*(Bit32u*)pos=EOR_REG_LSL_IMM(FC_RETOP, HOST_a1, HOST_a2, 0);	// eor FC_RETOP, a1, a2
+-			*(Bit32u*)(pos+4)=NOP;				// nop
+-			*(Bit32u*)(pos+8)=NOP;				// nop
+-			*(Bit32u*)(pos+12)=NOP;				// nop
+-			break;
+-		case t_CMPb:
+-		case t_CMPw:
+-		case t_CMPd:
+-		case t_TESTb:
+-		case t_TESTw:
+-		case t_TESTd:
+-			*(Bit32u*)pos=B_FWD(8);				// b (pc+2*4)
+-			break;
+-		case t_INCb:
+-		case t_INCw:
+-		case t_INCd:
+-			*(Bit32u*)pos=ADD_IMM(FC_RETOP, HOST_a1, 1, 0);	// add FC_RETOP, a1, #1
+-			*(Bit32u*)(pos+4)=NOP;				// nop
+-			*(Bit32u*)(pos+8)=NOP;				// nop
+-			*(Bit32u*)(pos+12)=NOP;				// nop
+-			break;
+-		case t_DECb:
+-		case t_DECw:
+-		case t_DECd:
+-			*(Bit32u*)pos=SUB_IMM(FC_RETOP, HOST_a1, 1, 0);	// sub FC_RETOP, a1, #1
+-			*(Bit32u*)(pos+4)=NOP;				// nop
+-			*(Bit32u*)(pos+8)=NOP;				// nop
+-			*(Bit32u*)(pos+12)=NOP;				// nop
+-			break;
+-		case t_SHLb:
+-		case t_SHLw:
+-		case t_SHLd:
+-			*(Bit32u*)pos=MOV_REG_LSL_REG(FC_RETOP, HOST_a1, HOST_a2);	// mov FC_RETOP, a1, lsl a2
+-			*(Bit32u*)(pos+4)=NOP;				// nop
+-			*(Bit32u*)(pos+8)=NOP;				// nop
+-			*(Bit32u*)(pos+12)=NOP;				// nop
+-			break;
+-		case t_SHRb:
+-			*(Bit32u*)pos=AND_IMM(FC_RETOP, HOST_a1, 0xff, 0);				// and FC_RETOP, a1, #0xff
+-			*(Bit32u*)(pos+4)=MOV_REG_LSR_REG(FC_RETOP, FC_RETOP, HOST_a2);	// mov FC_RETOP, FC_RETOP, lsr a2
+-			*(Bit32u*)(pos+8)=NOP;				// nop
+-			*(Bit32u*)(pos+12)=NOP;				// nop
+-			break;
+-		case t_SHRw:
+-			*(Bit32u*)pos=MOV_REG_LSL_IMM(FC_RETOP, HOST_a1, 16);			// mov FC_RETOP, a1, lsl #16
+-			*(Bit32u*)(pos+4)=MOV_REG_LSR_IMM(FC_RETOP, FC_RETOP, 16);		// mov FC_RETOP, FC_RETOP, lsr #16
+-			*(Bit32u*)(pos+8)=MOV_REG_LSR_REG(FC_RETOP, FC_RETOP, HOST_a2);	// mov FC_RETOP, FC_RETOP, lsr a2
+-			*(Bit32u*)(pos+12)=NOP;				// nop
+-			break;
+-		case t_SHRd:
+-			*(Bit32u*)pos=MOV_REG_LSR_REG(FC_RETOP, HOST_a1, HOST_a2);	// mov FC_RETOP, a1, lsr a2
+-			*(Bit32u*)(pos+4)=NOP;				// nop
+-			*(Bit32u*)(pos+8)=NOP;				// nop
+-			*(Bit32u*)(pos+12)=NOP;				// nop
+-			break;
+-		case t_SARb:
+-			*(Bit32u*)pos=MOV_REG_LSL_IMM(FC_RETOP, HOST_a1, 24);			// mov FC_RETOP, a1, lsl #24
+-			*(Bit32u*)(pos+4)=MOV_REG_ASR_IMM(FC_RETOP, FC_RETOP, 24);		// mov FC_RETOP, FC_RETOP, asr #24
+-			*(Bit32u*)(pos+8)=MOV_REG_ASR_REG(FC_RETOP, FC_RETOP, HOST_a2);	// mov FC_RETOP, FC_RETOP, asr a2
+-			*(Bit32u*)(pos+12)=NOP;				// nop
+-			break;
+-		case t_SARw:
+-			*(Bit32u*)pos=MOV_REG_LSL_IMM(FC_RETOP, HOST_a1, 16);			// mov FC_RETOP, a1, lsl #16
+-			*(Bit32u*)(pos+4)=MOV_REG_ASR_IMM(FC_RETOP, FC_RETOP, 16);		// mov FC_RETOP, FC_RETOP, asr #16
+-			*(Bit32u*)(pos+8)=MOV_REG_ASR_REG(FC_RETOP, FC_RETOP, HOST_a2);	// mov FC_RETOP, FC_RETOP, asr a2
+-			*(Bit32u*)(pos+12)=NOP;				// nop
+-			break;
+-		case t_SARd:
+-			*(Bit32u*)pos=MOV_REG_ASR_REG(FC_RETOP, HOST_a1, HOST_a2);	// mov FC_RETOP, a1, asr a2
+-			*(Bit32u*)(pos+4)=NOP;				// nop
+-			*(Bit32u*)(pos+8)=NOP;				// nop
+-			*(Bit32u*)(pos+12)=NOP;				// nop
+-			break;
+-		case t_RORb:
+-			*(Bit32u*)pos=MOV_REG_LSL_IMM(FC_RETOP, HOST_a1, 24);					// mov FC_RETOP, a1, lsl #24
+-			*(Bit32u*)(pos+4)=ORR_REG_LSR_IMM(FC_RETOP, FC_RETOP, FC_RETOP, 8);		// orr FC_RETOP, FC_RETOP, FC_RETOP, lsr #8
+-			*(Bit32u*)(pos+8)=ORR_REG_LSR_IMM(FC_RETOP, FC_RETOP, FC_RETOP, 16);	// orr FC_RETOP, FC_RETOP, FC_RETOP, lsr #16
+-			*(Bit32u*)(pos+12)=MOV_REG_ROR_REG(FC_RETOP, FC_RETOP, HOST_a2);		// mov FC_RETOP, FC_RETOP, ror a2
+-			break;
+-		case t_RORw:
+-			*(Bit32u*)pos=MOV_REG_LSL_IMM(FC_RETOP, HOST_a1, 16);					// mov FC_RETOP, a1, lsl #16
+-			*(Bit32u*)(pos+4)=ORR_REG_LSR_IMM(FC_RETOP, FC_RETOP, FC_RETOP, 16);	// orr FC_RETOP, FC_RETOP, FC_RETOP, lsr #16
+-			*(Bit32u*)(pos+8)=MOV_REG_ROR_REG(FC_RETOP, FC_RETOP, HOST_a2);			// mov FC_RETOP, FC_RETOP, ror a2
+-			*(Bit32u*)(pos+12)=NOP;				// nop
+-			break;
+-		case t_RORd:
+-			*(Bit32u*)pos=MOV_REG_ROR_REG(FC_RETOP, HOST_a1, HOST_a2);	// mov FC_RETOP, a1, ror a2
+-			*(Bit32u*)(pos+4)=NOP;				// nop
+-			*(Bit32u*)(pos+8)=NOP;				// nop
+-			*(Bit32u*)(pos+12)=NOP;				// nop
+-			break;
+-		case t_ROLw:
+-			*(Bit32u*)pos=MOV_REG_LSL_IMM(FC_RETOP, HOST_a1, 16);					// mov FC_RETOP, a1, lsl #16
+-			*(Bit32u*)(pos+4)=RSB_IMM(HOST_a2, HOST_a2, 32, 0);						// rsb a2, a2, #32
+-			*(Bit32u*)(pos+8)=ORR_REG_LSR_IMM(FC_RETOP, FC_RETOP, FC_RETOP, 16);	// orr FC_RETOP, FC_RETOP, FC_RETOP, lsr #16
+-			*(Bit32u*)(pos+12)=MOV_REG_ROR_REG(FC_RETOP, FC_RETOP, HOST_a2);		// mov FC_RETOP, FC_RETOP, ror a2
+-			break;
+-		case t_ROLd:
+-			*(Bit32u*)pos=RSB_IMM(HOST_a2, HOST_a2, 32, 0);					// rsb a2, a2, #32
+-			*(Bit32u*)(pos+4)=MOV_REG_ROR_REG(FC_RETOP, HOST_a1, HOST_a2);	// mov FC_RETOP, a1, ror a2
+-			*(Bit32u*)(pos+8)=NOP;				// nop
+-			*(Bit32u*)(pos+12)=NOP;				// nop
+-			break;
+-		case t_NEGb:
+-		case t_NEGw:
+-		case t_NEGd:
+-			*(Bit32u*)pos=RSB_IMM(FC_RETOP, HOST_a1, 0, 0);	// rsb FC_RETOP, a1, #0
+-			*(Bit32u*)(pos+4)=NOP;				// nop
+-			*(Bit32u*)(pos+8)=NOP;				// nop
+-			*(Bit32u*)(pos+12)=NOP;				// nop
+-			break;
+-		default:
+-			*(Bit32u*)(pos+12)=(Bit32u)fct_ptr;		// simple_func
+-			break;
+-
+-	}
+-#else
+-	*(Bit32u*)(pos+12)=(Bit32u)fct_ptr;		// simple_func
+-#endif
+-}
+-#endif
+-
+-static void cache_block_before_close(void) { }
+-
+-#ifdef DRC_USE_SEGS_ADDR
+-
+-// mov 16bit value from Segs[index] into dest_reg using FC_SEGS_ADDR (index modulo 2 must be zero)
+-// 16bit moves may destroy the upper 16bit of the destination register
+-static void gen_mov_seg16_to_reg(HostReg dest_reg,Bitu index) {
+-	cache_addd( LDRH_IMM(dest_reg, FC_SEGS_ADDR, index) );      // ldrh dest_reg, [FC_SEGS_ADDR, #index]
+-}
+-
+-// mov 32bit value from Segs[index] into dest_reg using FC_SEGS_ADDR (index modulo 4 must be zero)
+-static void gen_mov_seg32_to_reg(HostReg dest_reg,Bitu index) {
+-	cache_addd( LDR_IMM(dest_reg, FC_SEGS_ADDR, index) );      // ldr dest_reg, [FC_SEGS_ADDR, #index]
+-}
+-
+-// add a 32bit value from Segs[index] to a full register using FC_SEGS_ADDR (index modulo 4 must be zero)
+-static void gen_add_seg32_to_reg(HostReg reg,Bitu index) {
+-	cache_addd( LDR_IMM(temp1, FC_SEGS_ADDR, index) );      // ldr temp1, [FC_SEGS_ADDR, #index]
+-	cache_addd( ADD_REG_LSL_IMM(reg, reg, temp1, 0) );      // add reg, reg, temp1
+-}
+-
+-#endif
+-
+-#ifdef DRC_USE_REGS_ADDR
+-
+-// mov 16bit value from cpu_regs[index] into dest_reg using FC_REGS_ADDR (index modulo 2 must be zero)
+-// 16bit moves may destroy the upper 16bit of the destination register
+-static void gen_mov_regval16_to_reg(HostReg dest_reg,Bitu index) {
+-	cache_addd( LDRH_IMM(dest_reg, FC_REGS_ADDR, index) );      // ldrh dest_reg, [FC_REGS_ADDR, #index]
+-}
+-
+-// mov 32bit value from cpu_regs[index] into dest_reg using FC_REGS_ADDR (index modulo 4 must be zero)
+-static void gen_mov_regval32_to_reg(HostReg dest_reg,Bitu index) {
+-	cache_addd( LDR_IMM(dest_reg, FC_REGS_ADDR, index) );      // ldr dest_reg, [FC_REGS_ADDR, #index]
+-}
+-
+-// move a 32bit (dword==true) or 16bit (dword==false) value from cpu_regs[index] into dest_reg using FC_REGS_ADDR (if dword==true index modulo 4 must be zero) (if dword==false index modulo 2 must be zero)
+-// 16bit moves may destroy the upper 16bit of the destination register
+-static void gen_mov_regword_to_reg(HostReg dest_reg,Bitu index,bool dword) {
+-	if (dword) {
+-		cache_addd( LDR_IMM(dest_reg, FC_REGS_ADDR, index) );      // ldr dest_reg, [FC_REGS_ADDR, #index]
+-	} else {
+-		cache_addd( LDRH_IMM(dest_reg, FC_REGS_ADDR, index) );      // ldrh dest_reg, [FC_REGS_ADDR, #index]
+-	}
+-}
+-
+-// move an 8bit value from cpu_regs[index]  into dest_reg using FC_REGS_ADDR
+-// the upper 24bit of the destination register can be destroyed
+-// this function does not use FC_OP1/FC_OP2 as dest_reg as these
+-// registers might not be directly byte-accessible on some architectures
+-static void gen_mov_regbyte_to_reg_low(HostReg dest_reg,Bitu index) {
+-	cache_addd( LDRB_IMM(dest_reg, FC_REGS_ADDR, index) );      // ldrb dest_reg, [FC_REGS_ADDR, #index]
+-}
+-
+-// move an 8bit value from cpu_regs[index]  into dest_reg using FC_REGS_ADDR
+-// the upper 24bit of the destination register can be destroyed
+-// this function can use FC_OP1/FC_OP2 as dest_reg which are
+-// not directly byte-accessible on some architectures
+-static void INLINE gen_mov_regbyte_to_reg_low_canuseword(HostReg dest_reg,Bitu index) {
+-	cache_addd( LDRB_IMM(dest_reg, FC_REGS_ADDR, index) );      // ldrb dest_reg, [FC_REGS_ADDR, #index]
+-}
+-
+-
+-// add a 32bit value from cpu_regs[index] to a full register using FC_REGS_ADDR (index modulo 4 must be zero)
+-static void gen_add_regval32_to_reg(HostReg reg,Bitu index) {
+-	cache_addd( LDR_IMM(temp2, FC_REGS_ADDR, index) );      // ldr temp2, [FC_REGS_ADDR, #index]
+-	cache_addd( ADD_REG_LSL_IMM(reg, reg, temp2, 0) );      // add reg, reg, temp2
+-}
+-
+-
+-// move 16bit of register into cpu_regs[index] using FC_REGS_ADDR (index modulo 2 must be zero)
+-static void gen_mov_regval16_from_reg(HostReg src_reg,Bitu index) {
+-	cache_addd( STRH_IMM(src_reg, FC_REGS_ADDR, index) );      // strh src_reg, [FC_REGS_ADDR, #index]
+-}
+-
+-// move 32bit of register into cpu_regs[index] using FC_REGS_ADDR (index modulo 4 must be zero)
+-static void gen_mov_regval32_from_reg(HostReg src_reg,Bitu index) {
+-	cache_addd( STR_IMM(src_reg, FC_REGS_ADDR, index) );      // str src_reg, [FC_REGS_ADDR, #index]
+-}
+-
+-// move 32bit (dword==true) or 16bit (dword==false) of a register into cpu_regs[index] using FC_REGS_ADDR (if dword==true index modulo 4 must be zero) (if dword==false index modulo 2 must be zero)
+-static void gen_mov_regword_from_reg(HostReg src_reg,Bitu index,bool dword) {
+-	if (dword) {
+-		cache_addd( STR_IMM(src_reg, FC_REGS_ADDR, index) );      // str src_reg, [FC_REGS_ADDR, #index]
+-	} else {
+-		cache_addd( STRH_IMM(src_reg, FC_REGS_ADDR, index) );      // strh src_reg, [FC_REGS_ADDR, #index]
+-	}
+-}
+-
+-// move the lowest 8bit of a register into cpu_regs[index] using FC_REGS_ADDR
+-static void gen_mov_regbyte_from_reg_low(HostReg src_reg,Bitu index) {
+-	cache_addd( STRB_IMM(src_reg, FC_REGS_ADDR, index) );      // strb src_reg, [FC_REGS_ADDR, #index]
+-}
+-
+-#endif
+diff -Nur dosbox-0.74/src/cpu/core_dynrec/risc_armv4le-thumb.h dosbox/src/cpu/core_dynrec/risc_armv4le-thumb.h
+--- dosbox-0.74/src/cpu/core_dynrec/risc_armv4le-thumb.h	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/cpu/core_dynrec/risc_armv4le-thumb.h	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,7 +16,6 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: risc_armv4le-thumb.h,v 1.6 2009-06-27 12:51:10 c2woody Exp $ */
+ 
+ 
+ /* ARMv4 (little endian) backend by M-HT (thumb version) */
+@@ -51,15 +50,14 @@
+ // temporary register for LEA
+ #define TEMP_REG_DRC HOST_a4
+ 
+-#ifdef DRC_USE_REGS_ADDR
+ // used to hold the address of "cpu_regs" - preferably filled in function gen_run_code
+ #define FC_REGS_ADDR HOST_v7
+-#endif
+ 
+-#ifdef DRC_USE_SEGS_ADDR
+ // used to hold the address of "Segs" - preferably filled in function gen_run_code
+ #define FC_SEGS_ADDR HOST_v8
+-#endif
++
++// used to hold the address of "core_dynrec.readdata" - filled in function gen_run_code
++#define readdata_addr HOST_v5
+ 
+ 
+ // instruction encodings
+@@ -99,10 +97,14 @@
+ // logical
+ // and dst, src
+ #define AND(dst, src) (0x4000 + (dst) + ((src) << 3) )
++// bic dst, src
++#define BIC(dst, src) (0x4380 + (dst) + ((src) << 3) )
+ // eor dst, src
+ #define EOR(dst, src) (0x4040 + (dst) + ((src) << 3) )
+ // orr dst, src
+ #define ORR(dst, src) (0x4300 + (dst) + ((src) << 3) )
++// mvn dst, src
++#define MVN(dst, src) (0x43c0 + (dst) + ((src) << 3) )
+ 
+ // shift/rotate
+ // lsl dst, src, #imm
+@@ -129,6 +131,8 @@
+ #define LDRB_IMM(reg, addr, imm) (0x7800 + (reg) + ((addr) << 3) + ((imm) << 6) )
+ // ldr reg, [pc, #imm]		@	0 <= imm < 1024	&	imm mod 4 = 0
+ #define LDR_PC_IMM(reg, imm) (0x4800 + ((reg) << 8) + ((imm) >> 2) )
++// ldr reg, [addr1, addr2]
++#define LDR_REG(reg, addr1, addr2) (0x5800 + (reg) + ((addr1) << 3) + ((addr2) << 6) )
+ 
+ // store
+ // str reg, [addr, #imm]		@	0 <= imm < 128	&	imm mod 4 = 0
+@@ -151,30 +155,69 @@
+ #define BX(reg) (0x4700 + ((reg) << 3) )
+ 
+ 
++// arm instructions
++
++// arithmetic
++// add dst, src, #(imm ror rimm)		@	0 <= imm <= 255	&	rimm mod 2 = 0
++#define ARM_ADD_IMM(dst, src, imm, rimm) (0xe2800000 + ((dst) << 12) + ((src) << 16) + (imm) + ((rimm) << 7) )
++
++// load
++// ldr reg, [addr, #imm]		@	0 <= imm < 4096
++#define ARM_LDR_IMM(reg, addr, imm) (0xe5900000 + ((reg) << 12) + ((addr) << 16) + (imm) )
++
++// store
++// str reg, [addr, #-(imm)]!		@	0 <= imm < 4096
++#define ARM_STR_IMM_M_W(reg, addr, imm) (0xe5200000 + ((reg) << 12) + ((addr) << 16) + (imm) )
++
++// branch
++// bx reg
++#define ARM_BX(reg) (0xe12fff10 + (reg) )
++
++
+ // move a full register from reg_src to reg_dst
+ static void gen_mov_regs(HostReg reg_dst,HostReg reg_src) {
+ 	if(reg_src == reg_dst) return;
+ 	cache_addw( MOV_REG(reg_dst, reg_src) );      // mov reg_dst, reg_src
+ }
+ 
++// helper function
++static bool val_single_shift(Bit32u value, Bit32u *val_shift) {
++	Bit32u shift;
++
++	if (GCC_UNLIKELY(value == 0)) {
++		*val_shift = 0;
++		return true;
++	}
++
++	shift = 0;
++	while ((value & 1) == 0) {
++		value>>=1;
++		shift+=1;
++	}
++
++	if ((value >> 8) != 0) return false;
++
++	*val_shift = shift;
++	return true;
++}
++
+ // move a 32bit constant value into dest_reg
+ static void gen_mov_dword_to_reg_imm(HostReg dest_reg,Bit32u imm) {
+-	if ((imm & 0xffffff00) == 0) {
+-		cache_addw( MOV_IMM(dest_reg, imm) );      // mov dest_reg, #(imm)
+-	} else if ((imm & 0xffff00ff) == 0) {
+-		cache_addw( MOV_IMM(dest_reg, imm >> 8) );      // mov dest_reg, #(imm >> 8)
+-		cache_addw( LSL_IMM(dest_reg, dest_reg, 8) );      // lsl dest_reg, dest_reg, #8
+-	} else if ((imm & 0xff00ffff) == 0) {
+-		cache_addw( MOV_IMM(dest_reg, imm >> 16) );      // mov dest_reg, #(imm >> 16)
+-		cache_addw( LSL_IMM(dest_reg, dest_reg, 16) );      // lsl dest_reg, dest_reg, #16
+-	} else if ((imm & 0x00ffffff) == 0) {
+-		cache_addw( MOV_IMM(dest_reg, imm >> 24) );      // mov dest_reg, #(imm >> 24)
+-		cache_addw( LSL_IMM(dest_reg, dest_reg, 24) );      // lsl dest_reg, dest_reg, #24
++	Bit32u scale;
++
++	if (imm < 256) {
++		cache_addw( MOV_IMM(dest_reg, imm) );      // mov dest_reg, #imm
++	} else if ((~imm) < 256) {
++		cache_addw( MOV_IMM(dest_reg, ~imm) );      // mov dest_reg, #(~imm)
++		cache_addw( MVN(dest_reg, dest_reg) );      // mvn dest_reg, dest_reg
++	} else if (val_single_shift(imm, &scale)) {
++		cache_addw( MOV_IMM(dest_reg, imm >> scale) );      // mov dest_reg, #(imm >> scale)
++		cache_addw( LSL_IMM(dest_reg, dest_reg, scale) );      // lsl dest_reg, dest_reg, #scale
+ 	} else {
+ 		Bit32u diff;
+-		
++
+ 		diff = imm - ((Bit32u)cache.pos+4);
+-		
++
+ 		if ((diff < 1024) && ((imm & 0x03) == 0)) {
+ 			if (((Bit32u)cache.pos & 0x03) == 0) {
+ 				cache_addw( ADD_LO_PC_IMM(dest_reg, diff) );      // add dest_reg, pc, #(diff >> 2)
+@@ -199,10 +242,58 @@
+ 	}
+ }
+ 
++// helper function
++static bool gen_mov_memval_to_reg_helper(HostReg dest_reg, Bit32u data, Bitu size, HostReg addr_reg, Bit32u addr_data) {
++	switch (size) {
++		case 4:
++#if !defined(C_UNALIGNED_MEMORY)
++			if ((data & 3) == 0)
++#endif
++			{
++				if ((data >= addr_data) && (data < addr_data + 128) && (((data - addr_data) & 3) == 0)) {
++					cache_addw( MOV_LO_HI(templo2, addr_reg) );      // mov templo2, addr_reg
++					cache_addw( LDR_IMM(dest_reg, templo2, data - addr_data) );      // ldr dest_reg, [templo2, #(data - addr_data)]
++					return true;
++				}
++			}
++			break;
++		case 2:
++#if !defined(C_UNALIGNED_MEMORY)
++			if ((data & 1) == 0)
++#endif
++			{
++				if ((data >= addr_data) && (data < addr_data + 64) && (((data - addr_data) & 1) == 0)) {
++					cache_addw( MOV_LO_HI(templo2, addr_reg) );      // mov templo2, addr_reg
++					cache_addw( LDRH_IMM(dest_reg, templo2, data - addr_data) );      // ldrh dest_reg, [templo2, #(data - addr_data)]
++					return true;
++				}
++			}
++			break;
++		case 1:
++			if ((data >= addr_data) && (data < addr_data + 32)) {
++				cache_addw( MOV_LO_HI(templo2, addr_reg) );      // mov templo2, addr_reg
++				cache_addw( LDRB_IMM(dest_reg, templo2, data - addr_data) );      // ldrb dest_reg, [templo2, #(data - addr_data)]
++				return true;
++			}
++		default:
++			break;
++	}
++	return false;
++}
++
++// helper function
++static bool gen_mov_memval_to_reg(HostReg dest_reg, void *data, Bitu size) {
++	if (gen_mov_memval_to_reg_helper(dest_reg, (Bit32u)data, size, FC_REGS_ADDR, (Bit32u)&cpu_regs)) return true;
++	if (gen_mov_memval_to_reg_helper(dest_reg, (Bit32u)data, size, readdata_addr, (Bit32u)&core_dynrec.readdata)) return true;
++	if (gen_mov_memval_to_reg_helper(dest_reg, (Bit32u)data, size, FC_SEGS_ADDR, (Bit32u)&Segs)) return true;
++	return false;
++}
++
+ // helper function for gen_mov_word_to_reg
+ static void gen_mov_word_to_reg_helper(HostReg dest_reg,void* data,bool dword,HostReg data_reg) {
+ 	// alignment....
+ 	if (dword) {
++#if !defined(C_UNALIGNED_MEMORY)
+ 		if ((Bit32u)data & 3) {
+ 			if ( ((Bit32u)data & 3) == 2 ) {
+ 				cache_addw( LDRH_IMM(dest_reg, data_reg, 0) );      // ldrh dest_reg, [data_reg]
+@@ -219,16 +310,21 @@
+ 				cache_addw( LSL_IMM(templo1, templo1, 24) );      // lsl templo1, templo1, #24
+ 				cache_addw( ORR(dest_reg, templo1) );      // orr dest_reg, templo1
+ 			}
+-		} else {
++		} else
++#endif
++		{
+ 			cache_addw( LDR_IMM(dest_reg, data_reg, 0) );      // ldr dest_reg, [data_reg]
+ 		}
+ 	} else {
++#if !defined(C_UNALIGNED_MEMORY)
+ 		if ((Bit32u)data & 1) {
+ 			cache_addw( LDRB_IMM(dest_reg, data_reg, 0) );      // ldrb dest_reg, [data_reg]
+ 			cache_addw( LDRB_IMM(templo1, data_reg, 1) );      // ldrb templo1, [data_reg, #1]
+ 			cache_addw( LSL_IMM(templo1, templo1, 8) );      // lsl templo1, templo1, #8
+ 			cache_addw( ORR(dest_reg, templo1) );      // orr dest_reg, templo1
+-		} else {
++		} else
++#endif
++		{
+ 			cache_addw( LDRH_IMM(dest_reg, data_reg, 0) );      // ldrh dest_reg, [data_reg]
+ 		}
+ 	}
+@@ -237,8 +333,10 @@
+ // move a 32bit (dword==true) or 16bit (dword==false) value from memory into dest_reg
+ // 16bit moves may destroy the upper 16bit of the destination register
+ static void gen_mov_word_to_reg(HostReg dest_reg,void* data,bool dword) {
+-	gen_mov_dword_to_reg_imm(templo2, (Bit32u)data);
+-	gen_mov_word_to_reg_helper(dest_reg, data, dword, templo2);
++	if (!gen_mov_memval_to_reg(dest_reg, data, (dword)?4:2)) {
++		gen_mov_dword_to_reg_imm(templo2, (Bit32u)data);
++		gen_mov_word_to_reg_helper(dest_reg, data, dword, templo2);
++	}
+ }
+ 
+ // move a 16bit constant value into dest_reg
+@@ -247,10 +345,58 @@
+ 	gen_mov_dword_to_reg_imm(dest_reg, (Bit32u)imm);
+ }
+ 
++// helper function
++static bool gen_mov_memval_from_reg_helper(HostReg src_reg, Bit32u data, Bitu size, HostReg addr_reg, Bit32u addr_data) {
++	switch (size) {
++		case 4:
++#if !defined(C_UNALIGNED_MEMORY)
++			if ((data & 3) == 0)
++#endif
++			{
++				if ((data >= addr_data) && (data < addr_data + 128) && (((data - addr_data) & 3) == 0)) {
++					cache_addw( MOV_LO_HI(templo2, addr_reg) );      // mov templo2, addr_reg
++					cache_addw( STR_IMM(src_reg, templo2, data - addr_data) );      // str src_reg, [templo2, #(data - addr_data)]
++					return true;
++				}
++			}
++			break;
++		case 2:
++#if !defined(C_UNALIGNED_MEMORY)
++			if ((data & 1) == 0)
++#endif
++			{
++				if ((data >= addr_data) && (data < addr_data + 64) && (((data - addr_data) & 1) == 0)) {
++					cache_addw( MOV_LO_HI(templo2, addr_reg) );      // mov templo2, addr_reg
++					cache_addw( STRH_IMM(src_reg, templo2, data - addr_data) );      // strh src_reg, [templo2, #(data - addr_data)]
++					return true;
++				}
++			}
++			break;
++		case 1:
++			if ((data >= addr_data) && (data < addr_data + 32)) {
++				cache_addw( MOV_LO_HI(templo2, addr_reg) );      // mov templo2, addr_reg
++				cache_addw( STRB_IMM(src_reg, templo2, data - addr_data) );      // strb src_reg, [templo2, #(data - addr_data)]
++				return true;
++			}
++		default:
++			break;
++	}
++	return false;
++}
++
++// helper function
++static bool gen_mov_memval_from_reg(HostReg src_reg, void *dest, Bitu size) {
++	if (gen_mov_memval_from_reg_helper(src_reg, (Bit32u)dest, size, FC_REGS_ADDR, (Bit32u)&cpu_regs)) return true;
++	if (gen_mov_memval_from_reg_helper(src_reg, (Bit32u)dest, size, readdata_addr, (Bit32u)&core_dynrec.readdata)) return true;
++	if (gen_mov_memval_from_reg_helper(src_reg, (Bit32u)dest, size, FC_SEGS_ADDR, (Bit32u)&Segs)) return true;
++	return false;
++}
++
+ // helper function for gen_mov_word_from_reg
+ static void gen_mov_word_from_reg_helper(HostReg src_reg,void* dest,bool dword, HostReg data_reg) {
+ 	// alignment....
+ 	if (dword) {
++#if !defined(C_UNALIGNED_MEMORY)
+ 		if ((Bit32u)dest & 3) {
+ 			if ( ((Bit32u)dest & 3) == 2 ) {
+ 				cache_addw( STRH_IMM(src_reg, data_reg, 0) );      // strh src_reg, [data_reg]
+@@ -269,16 +415,21 @@
+ 				cache_addw( LSR_IMM(templo1, templo1, 24) );      // lsr templo1, templo1, #24
+ 				cache_addw( STRB_IMM(templo1, data_reg, 3) );      // strb templo1, [data_reg, #3]
+ 			}
+-		} else {
++		} else
++#endif
++		{
+ 			cache_addw( STR_IMM(src_reg, data_reg, 0) );      // str src_reg, [data_reg]
+ 		}
+ 	} else {
++#if !defined(C_UNALIGNED_MEMORY)
+ 		if ((Bit32u)dest & 1) {
+ 			cache_addw( STRB_IMM(src_reg, data_reg, 0) );      // strb src_reg, [data_reg]
+ 			cache_addw( MOV_REG(templo1, src_reg) );      // mov templo1, src_reg
+ 			cache_addw( LSR_IMM(templo1, templo1, 8) );      // lsr templo1, templo1, #8
+ 			cache_addw( STRB_IMM(templo1, data_reg, 1) );      // strb templo1, [data_reg, #1]
+-		} else {
++		} else
++#endif
++		{
+ 			cache_addw( STRH_IMM(src_reg, data_reg, 0) );      // strh src_reg, [data_reg]
+ 		}
+ 	}
+@@ -286,8 +437,10 @@
+ 
+ // move 32bit (dword==true) or 16bit (dword==false) of a register into memory
+ static void gen_mov_word_from_reg(HostReg src_reg,void* dest,bool dword) {
+-	gen_mov_dword_to_reg_imm(templo2, (Bit32u)dest);
+-	gen_mov_word_from_reg_helper(src_reg, dest, dword, templo2);
++	if (!gen_mov_memval_from_reg(src_reg, dest, (dword)?4:2)) {
++		gen_mov_dword_to_reg_imm(templo2, (Bit32u)dest);
++		gen_mov_word_from_reg_helper(src_reg, dest, dword, templo2);
++	}
+ }
+ 
+ // move an 8bit value from memory into dest_reg
+@@ -295,8 +448,10 @@
+ // this function does not use FC_OP1/FC_OP2 as dest_reg as these
+ // registers might not be directly byte-accessible on some architectures
+ static void gen_mov_byte_to_reg_low(HostReg dest_reg,void* data) {
+-	gen_mov_dword_to_reg_imm(templo1, (Bit32u)data);
+-	cache_addw( LDRB_IMM(dest_reg, templo1, 0) );      // ldrb dest_reg, [templo1]
++	if (!gen_mov_memval_to_reg(dest_reg, data, 1)) {
++		gen_mov_dword_to_reg_imm(templo1, (Bit32u)data);
++		cache_addw( LDRB_IMM(dest_reg, templo1, 0) );      // ldrb dest_reg, [templo1]
++	}
+ }
+ 
+ // move an 8bit value from memory into dest_reg
+@@ -325,8 +480,10 @@
+ 
+ // move the lowest 8bit of a register into memory
+ static void gen_mov_byte_from_reg_low(HostReg src_reg,void* dest) {
+-	gen_mov_dword_to_reg_imm(templo1, (Bit32u)dest);
+-	cache_addw( STRB_IMM(src_reg, templo1, 0) );      // strb src_reg, [templo1]
++	if (!gen_mov_memval_from_reg(src_reg, dest, 1)) {
++		gen_mov_dword_to_reg_imm(templo1, (Bit32u)dest);
++		cache_addw( STRB_IMM(src_reg, templo1, 0) );      // strb src_reg, [templo1]
++	}
+ }
+ 
+ 
+@@ -363,16 +520,51 @@
+ 
+ // add a 32bit constant value to a full register
+ static void gen_add_imm(HostReg reg,Bit32u imm) {
++	Bit32u imm2, scale;
++
+ 	if(!imm) return;
+-	gen_mov_dword_to_reg_imm(templo1, imm);
+-	cache_addw( ADD_REG(reg, reg, templo1) );      // add reg, reg, templo1
++
++	imm2 = (Bit32u) (-((Bit32s)imm));
++
++	if (imm <= 255) {
++		cache_addw( ADD_IMM8(reg, imm) );      // add reg, #imm
++	} else if (imm2 <= 255) {
++		cache_addw( SUB_IMM8(reg, imm2) );      // sub reg, #(-imm)
++	} else {
++		if (val_single_shift(imm2, &scale)) {
++			cache_addw( MOV_IMM(templo1, imm2 >> scale) );      // mov templo1, #(~imm >> scale)
++			if (scale) {
++				cache_addw( LSL_IMM(templo1, templo1, scale) );      // lsl templo1, templo1, #scale
++			}
++			cache_addw( SUB_REG(reg, reg, templo1) );      // sub reg, reg, templo1
++		} else {
++			gen_mov_dword_to_reg_imm(templo1, imm);
++			cache_addw( ADD_REG(reg, reg, templo1) );      // add reg, reg, templo1
++		}
++	}
+ }
+ 
+ // and a 32bit constant value with a full register
+ static void gen_and_imm(HostReg reg,Bit32u imm) {
+-	if(imm == 0xffffffff) return;
+-	gen_mov_dword_to_reg_imm(templo1, imm);
+-	cache_addw( AND(reg, templo1) );      // and reg, templo1
++	Bit32u imm2, scale;
++
++	imm2 = ~imm;
++	if(!imm2) return;
++
++	if (!imm) {
++		cache_addw( MOV_IMM(reg, 0) );      // mov reg, #0
++	} else {
++		if (val_single_shift(imm2, &scale)) {
++			cache_addw( MOV_IMM(templo1, imm2 >> scale) );      // mov templo1, #(~imm >> scale)
++			if (scale) {
++				cache_addw( LSL_IMM(templo1, templo1, scale) );      // lsl templo1, templo1, #scale
++			}
++			cache_addw( BIC(reg, templo1) );      // bic reg, templo1
++		} else {
++			gen_mov_dword_to_reg_imm(templo1, imm);
++			cache_addw( AND(reg, templo1) );      // and reg, templo1
++		}
++	}
+ }
+ 
+ 
+@@ -387,66 +579,65 @@
+ 	gen_mov_direct_dword(dest,(Bit32u)imm);
+ }
+ 
+-// add an 8bit constant value to a dword memory value
+-static void gen_add_direct_byte(void* dest,Bit8s imm) {
+-	if(!imm) return;
+-	gen_mov_dword_to_reg_imm(templo2, (Bit32u)dest);
+-	gen_mov_word_to_reg_helper(templo3, dest, 1, templo2);
+-	if (imm >= 0) {
+-		cache_addw( ADD_IMM8(templo3, (Bit32s)imm) );      // add templo3, #(imm)
+-	} else {
+-		cache_addw( SUB_IMM8(templo3, -((Bit32s)imm)) );      // sub templo3, #(-imm)
+-	}
+-	gen_mov_word_from_reg_helper(templo3, dest, 1, templo2);
+-}
+-
+ // add a 32bit (dword==true) or 16bit (dword==false) constant value to a memory value
+ static void gen_add_direct_word(void* dest,Bit32u imm,bool dword) {
++	if (!dword) imm &= 0xffff;
+ 	if(!imm) return;
+-	if (dword && ( (imm<128) || (imm>=0xffffff80) ) ) {
+-		gen_add_direct_byte(dest,(Bit8s)imm);
+-		return;
+-	}
+-	gen_mov_dword_to_reg_imm(templo2, (Bit32u)dest);
+-	gen_mov_word_to_reg_helper(templo3, dest, dword, templo2);
+-	if (dword) {
+-		gen_mov_dword_to_reg_imm(templo1, imm);
+-	} else {
+-		gen_mov_word_to_reg_imm(templo1, (Bit16u)imm);
++
++	if (!gen_mov_memval_to_reg(templo3, dest, (dword)?4:2)) {
++		gen_mov_dword_to_reg_imm(templo2, (Bit32u)dest);
++		gen_mov_word_to_reg_helper(templo3, dest, dword, templo2);
++	}
++	gen_add_imm(templo3, imm);
++	if (!gen_mov_memval_from_reg(templo3, dest, (dword)?4:2)) {
++		gen_mov_word_from_reg_helper(templo3, dest, dword, templo2);
+ 	}
+-	cache_addw( ADD_REG(templo3, templo3, templo1) );      // add templo3, templo3, templo1
+-	gen_mov_word_from_reg_helper(templo3, dest, dword, templo2);
+ }
+ 
+-// subtract an 8bit constant value from a dword memory value
+-static void gen_sub_direct_byte(void* dest,Bit8s imm) {
+-	if(!imm) return;
+-	gen_mov_dword_to_reg_imm(templo2, (Bit32u)dest);
+-	gen_mov_word_to_reg_helper(templo3, dest, 1, templo2);
+-	if (imm >= 0) {
+-		cache_addw( SUB_IMM8(templo3, (Bit32s)imm) );      // sub templo3, #(imm)
+-	} else {
+-		cache_addw( ADD_IMM8(templo3, -((Bit32s)imm)) );      // add templo3, #(-imm)
+-	}
+-	gen_mov_word_from_reg_helper(templo3, dest, 1, templo2);
++// add an 8bit constant value to a dword memory value
++static void gen_add_direct_byte(void* dest,Bit8s imm) {
++	gen_add_direct_word(dest, (Bit32s)imm, 1);
+ }
+ 
+ // subtract a 32bit (dword==true) or 16bit (dword==false) constant value from a memory value
+ static void gen_sub_direct_word(void* dest,Bit32u imm,bool dword) {
++	Bit32u imm2, scale;
++
++	if (!dword) imm &= 0xffff;
+ 	if(!imm) return;
+-	if (dword && ( (imm<128) || (imm>=0xffffff80) ) ) {
+-		gen_sub_direct_byte(dest,(Bit8s)imm);
+-		return;
++
++	if (!gen_mov_memval_to_reg(templo3, dest, (dword)?4:2)) {
++		gen_mov_dword_to_reg_imm(templo2, (Bit32u)dest);
++		gen_mov_word_to_reg_helper(templo3, dest, dword, templo2);
+ 	}
+-	gen_mov_dword_to_reg_imm(templo2, (Bit32u)dest);
+-	gen_mov_word_to_reg_helper(templo3, dest, dword, templo2);
+-	if (dword) {
+-		gen_mov_dword_to_reg_imm(templo1, imm);
++
++	imm2 = (Bit32u) (-((Bit32s)imm));
++
++	if (imm <= 255) {
++		cache_addw( SUB_IMM8(templo3, imm) );      // sub templo3, #imm
++	} else if (imm2 <= 255) {
++		cache_addw( ADD_IMM8(templo3, imm2) );      // add templo3, #(-imm)
+ 	} else {
+-		gen_mov_word_to_reg_imm(templo1, (Bit16u)imm);
++		if (val_single_shift(imm2, &scale)) {
++			cache_addw( MOV_IMM(templo1, imm2 >> scale) );      // mov templo1, #(~imm >> scale)
++			if (scale) {
++				cache_addw( LSL_IMM(templo1, templo1, scale) );      // lsl templo1, templo1, #scale
++			}
++			cache_addw( ADD_REG(templo3, templo3, templo1) );      // add templo3, templo3, templo1
++		} else {
++			gen_mov_dword_to_reg_imm(templo1, imm);
++			cache_addw( SUB_REG(templo3, templo3, templo1) );      // sub templo3, templo3, templo1
++		}
++	}
++
++	if (!gen_mov_memval_from_reg(templo3, dest, (dword)?4:2)) {
++		gen_mov_word_from_reg_helper(templo3, dest, dword, templo2);
+ 	}
+-	cache_addw( SUB_REG(templo3, templo3, templo1) );      // sub templo3, templo3, templo1
+-	gen_mov_word_from_reg_helper(templo3, dest, dword, templo2);
++}
++
++// subtract an 8bit constant value from a dword memory value
++static void gen_sub_direct_byte(void* dest,Bit8s imm) {
++	gen_sub_direct_word(dest, (Bit32s)imm, 1);
+ }
+ 
+ // effective address calculation, destination is dest_reg
+@@ -492,7 +683,7 @@
+ 	// switch from arm to thumb state
+ 	cache_addd(0xe2800000 + (templo1 << 12) + (HOST_pc << 16) + (1));      // add templo1, pc, #1
+ 	cache_addd(0xe12fff10 + (templo1));      // bx templo1
+-	
++
+ 	// thumb state from now on
+ }
+ 
+@@ -538,18 +729,20 @@
+ static void gen_jmp_ptr(void * ptr,Bits imm=0) {
+ 	gen_mov_word_to_reg(templo3, ptr, 1);
+ 
+-	if (imm) {
+-		gen_mov_dword_to_reg_imm(templo2, imm);
+-		cache_addw( ADD_REG(templo3, templo3, templo2) );      // add templo3, templo3, templo2
+-	}
+-
+-#if (1)
+-// (*ptr) should be word aligned 
++#if !defined(C_UNALIGNED_MEMORY)
++// (*ptr) should be word aligned
+ 	if ((imm & 0x03) == 0) {
+-		cache_addw( LDR_IMM(templo2, templo3, 0) );      // ldr templo2, [templo3]
+-	} else
+ #endif
+-	{
++		if ((imm >= 0) && (imm < 128) && ((imm & 3) == 0)) {
++			cache_addw( LDR_IMM(templo2, templo3, imm) );      // ldr templo2, [templo3, #imm]
++		} else {
++			gen_mov_dword_to_reg_imm(templo2, imm);
++			cache_addw( LDR_REG(templo2, templo3, templo2) );      // ldr templo2, [templo3, templo2]
++		}
++#if !defined(C_UNALIGNED_MEMORY)
++	} else {
++		gen_add_imm(templo3, imm);
++
+ 		cache_addw( LDRB_IMM(templo2, templo3, 0) );      // ldrb templo2, [templo3]
+ 		cache_addw( LDRB_IMM(templo1, templo3, 1) );      // ldrb templo1, [templo3, #1]
+ 		cache_addw( LSL_IMM(templo1, templo1, 8) );      // lsl templo1, templo1, #8
+@@ -561,6 +754,7 @@
+ 		cache_addw( LSL_IMM(templo1, templo1, 24) );      // lsl templo1, templo1, #24
+ 		cache_addw( ORR(templo2, templo1) );      // orr templo2, templo1
+ 	}
++#endif
+ 
+ 	// increase jmp address to keep thumb state
+ 	cache_addw( ADD_IMM3(templo2, templo2, 1) );      // add templo2, templo2, #1
+@@ -651,50 +845,53 @@
+ }
+ 
+ static void gen_run_code(void) {
+-	// switch from arm to thumb state
+-	cache_addd(0xe2800000 + (HOST_r3 << 12) + (HOST_pc << 16) + (1));      // add r3, pc, #1
+-	cache_addd(0xe12fff10 + (HOST_r3));      // bx r3
++	Bit8u *pos1, *pos2, *pos3;
+ 
+-	// thumb state from now on
+-	cache_addw(0xb500);      // push {lr}
+-	cache_addw( MOV_LO_HI(HOST_r3, FC_SEGS_ADDR) );      // mov r3, FC_SEGS_ADDR
+-	cache_addw( MOV_LO_HI(HOST_r2, FC_REGS_ADDR) );      // mov r2, FC_REGS_ADDR
+-	cache_addw(0xb4fc);      // push {r2,r3,v1-v4}
+-
+-	// adr: 16
+-	cache_addw( LDR_PC_IMM(HOST_r3, 64 - (16 + 4)) );        // ldr r3, [pc, #(&Segs)]
+-	// adr: 18
+-	cache_addw( LDR_PC_IMM(HOST_r2, 68 - (18 + 2)) );        // ldr r2, [pc, #(&cpu_regs)]
+-	cache_addw( MOV_HI_LO(FC_SEGS_ADDR, HOST_r3) );      // mov FC_SEGS_ADDR, r3
+-	cache_addw( MOV_HI_LO(FC_REGS_ADDR, HOST_r2) );      // mov FC_REGS_ADDR, r2
+-
+-	// align 4
+-	cache_addw( ADD_LO_PC_IMM(HOST_r3, 8) );      // add r3, pc, #8
+-	cache_addw( ADD_IMM8(HOST_r0, 1) );      // add r0, #1
+-	cache_addw( ADD_IMM8(HOST_r3, 1) );      // add r3, #1
+-	cache_addw(0xb408);      // push {r3}
+-	cache_addw( BX(HOST_r0) );      // bx r0
+-	cache_addw( NOP );      // nop
+-
+-	// align 4
+-	cache_addw(0xbcfc);      // pop {r2,r3,v1-v4}
+-	cache_addw( MOV_HI_LO(FC_SEGS_ADDR, HOST_r3) );      // mov FC_SEGS_ADDR, r3
+-	cache_addw( MOV_HI_LO(FC_REGS_ADDR, HOST_r2) );      // mov FC_REGS_ADDR, r2
++#if (__ARM_EABI__)
++	// 8-byte stack alignment
++	cache_addd(0xe92d4ff0);			// stmfd sp!, {v1-v8,lr}
++#else
++	cache_addd(0xe92d4df0);			// stmfd sp!, {v1-v5,v7,v8,lr}
++#endif
+ 
+-	cache_addw(0xbc08);      // pop {r3}
+-	cache_addw( BX(HOST_r3) );      // bx r3
++	cache_addd( ARM_ADD_IMM(HOST_r0, HOST_r0, 1, 0) );      // add r0, r0, #1
++
++	pos1 = cache.pos;
++	cache_addd( 0 );
++	pos2 = cache.pos;
++	cache_addd( 0 );
++	pos3 = cache.pos;
++	cache_addd( 0 );
++
++	cache_addd( ARM_ADD_IMM(HOST_lr, HOST_pc, 4, 0) );			// add lr, pc, #4
++	cache_addd( ARM_STR_IMM_M_W(HOST_lr, HOST_sp, 4) );      // str lr, [sp, #-4]!
++	cache_addd( ARM_BX(HOST_r0) );			// bx r0
++
++#if (__ARM_EABI__)
++	cache_addd(0xe8bd4ff0);			// ldmfd sp!, {v1-v8,lr}
++#else
++	cache_addd(0xe8bd4df0);			// ldmfd sp!, {v1-v5,v7,v8,lr}
++#endif
++	cache_addd( ARM_BX(HOST_lr) );			// bx lr
+ 
+-	// fill up to 64 bytes
+-	cache_addw( NOP );      // nop
+-	cache_addd( NOP | (NOP << 16) );  // nop, nop
+-	cache_addd( NOP | (NOP << 16) );  // nop, nop
+-	cache_addd( NOP | (NOP << 16) );  // nop, nop
+-	cache_addd( NOP | (NOP << 16) );  // nop, nop
++	// align cache.pos to 32 bytes
++	if ((((Bitu)cache.pos) & 0x1f) != 0) {
++		cache.pos = cache.pos + (32 - (((Bitu)cache.pos) & 0x1f));
++	}
+ 
+-	// adr: 64
++	*(Bit32u*)pos1 = ARM_LDR_IMM(FC_SEGS_ADDR, HOST_pc, cache.pos - (pos1 + 8));      // ldr FC_SEGS_ADDR, [pc, #(&Segs)]
+ 	cache_addd((Bit32u)&Segs);      // address of "Segs"
+-	// adr: 68
++
++	*(Bit32u*)pos2 = ARM_LDR_IMM(FC_REGS_ADDR, HOST_pc, cache.pos - (pos2 + 8));      // ldr FC_REGS_ADDR, [pc, #(&cpu_regs)]
+ 	cache_addd((Bit32u)&cpu_regs);  // address of "cpu_regs"
++
++	*(Bit32u*)pos3 = ARM_LDR_IMM(readdata_addr, HOST_pc, cache.pos - (pos3 + 8));      // ldr readdata_addr, [pc, #(&core_dynrec.readdata)]
++	cache_addd((Bit32u)&core_dynrec.readdata);  // address of "core_dynrec.readdata"
++
++	// align cache.pos to 32 bytes
++	if ((((Bitu)cache.pos) & 0x1f) != 0) {
++		cache.pos = cache.pos + (32 - (((Bitu)cache.pos) & 0x1f));
++	}
+ }
+ 
+ // return from a function
+@@ -1024,7 +1221,11 @@
+ }
+ #endif
+ 
+-static void cache_block_before_close(void) { }
++static void cache_block_before_close(void) {
++	if ((((Bit32u)cache.pos) & 3) != 0) {
++		cache_addw( NOP );      // nop
++	}
++}
+ 
+ #ifdef DRC_USE_SEGS_ADDR
+ 
+diff -Nur dosbox-0.74/src/cpu/core_dynrec/risc_armv4le-thumb-iw.h dosbox/src/cpu/core_dynrec/risc_armv4le-thumb-iw.h
+--- dosbox-0.74/src/cpu/core_dynrec/risc_armv4le-thumb-iw.h	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/cpu/core_dynrec/risc_armv4le-thumb-iw.h	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,7 +16,6 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: risc_armv4le-thumb-iw.h,v 1.5 2009-06-27 12:51:10 c2woody Exp $ */
+ 
+ 
+ /* ARMv4 (little endian) backend by M-HT (thumb version with data pool, requires -mthumb-interwork switch when compiling dosbox) */
+@@ -51,15 +50,14 @@
+ // temporary register for LEA
+ #define TEMP_REG_DRC HOST_a4
+ 
+-#ifdef DRC_USE_REGS_ADDR
+ // used to hold the address of "cpu_regs" - preferably filled in function gen_run_code
+ #define FC_REGS_ADDR HOST_v7
+-#endif
+ 
+-#ifdef DRC_USE_SEGS_ADDR
+ // used to hold the address of "Segs" - preferably filled in function gen_run_code
+ #define FC_SEGS_ADDR HOST_v8
+-#endif
++
++// used to hold the address of "core_dynrec.readdata" - filled in function gen_run_code
++#define readdata_addr HOST_v5
+ 
+ 
+ // instruction encodings
+@@ -99,10 +97,14 @@
+ // logical
+ // and dst, src
+ #define AND(dst, src) (0x4000 + (dst) + ((src) << 3) )
++// bic dst, src
++#define BIC(dst, src) (0x4380 + (dst) + ((src) << 3) )
+ // eor dst, src
+ #define EOR(dst, src) (0x4040 + (dst) + ((src) << 3) )
+ // orr dst, src
+ #define ORR(dst, src) (0x4300 + (dst) + ((src) << 3) )
++// mvn dst, src
++#define MVN(dst, src) (0x43c0 + (dst) + ((src) << 3) )
+ 
+ // shift/rotate
+ // lsl dst, src, #imm
+@@ -129,6 +131,8 @@
+ #define LDRB_IMM(reg, addr, imm) (0x7800 + (reg) + ((addr) << 3) + ((imm) << 6) )
+ // ldr reg, [pc, #imm]		@	0 <= imm < 1024	&	imm mod 4 = 0
+ #define LDR_PC_IMM(reg, imm) (0x4800 + ((reg) << 8) + ((imm) >> 2) )
++// ldr reg, [addr1, addr2]
++#define LDR_REG(reg, addr1, addr2) (0x5800 + (reg) + ((addr1) << 3) + ((addr2) << 6) )
+ 
+ // store
+ // str reg, [addr, #imm]		@	0 <= imm < 128	&	imm mod 4 = 0
+@@ -151,6 +155,25 @@
+ #define BX(reg) (0x4700 + ((reg) << 3) )
+ 
+ 
++// arm instructions
++
++// arithmetic
++// add dst, src, #(imm ror rimm)		@	0 <= imm <= 255	&	rimm mod 2 = 0
++#define ARM_ADD_IMM(dst, src, imm, rimm) (0xe2800000 + ((dst) << 12) + ((src) << 16) + (imm) + ((rimm) << 7) )
++
++// load
++// ldr reg, [addr, #imm]		@	0 <= imm < 4096
++#define ARM_LDR_IMM(reg, addr, imm) (0xe5900000 + ((reg) << 12) + ((addr) << 16) + (imm) )
++
++// store
++// str reg, [addr, #-(imm)]!		@	0 <= imm < 4096
++#define ARM_STR_IMM_M_W(reg, addr, imm) (0xe5200000 + ((reg) << 12) + ((addr) << 16) + (imm) )
++
++// branch
++// bx reg
++#define ARM_BX(reg) (0xe12fff10 + (reg) )
++
++
+ // data pool defines
+ #define CACHE_DATA_JUMP	 (2)
+ #define CACHE_DATA_ALIGN (32)
+@@ -194,7 +217,7 @@
+ 		cache_datapos = (Bit8u *) (((Bitu)cache.block.active->cache.start + cache.block.active->cache.size - CACHE_DATA_ALIGN) & ~(CACHE_DATA_ALIGN - 1));
+ 	} else {
+ 		register Bit32u cachemodsize;
+-	
++
+ 		cachemodsize = (cache.pos - cache.block.active->cache.start) & (CACHE_MAXSIZE - 1);
+ 
+ 		if (cachemodsize + CACHE_DATA_MAX + CACHE_DATA_ALIGN <= CACHE_MAXSIZE ||
+@@ -276,30 +299,49 @@
+ 	cache_addw( MOV_REG(reg_dst, reg_src) );      // mov reg_dst, reg_src
+ }
+ 
++// helper function
++static bool val_single_shift(Bit32u value, Bit32u *val_shift) {
++	Bit32u shift;
++
++	if (GCC_UNLIKELY(value == 0)) {
++		*val_shift = 0;
++		return true;
++	}
++
++	shift = 0;
++	while ((value & 1) == 0) {
++		value>>=1;
++		shift+=1;
++	}
++
++	if ((value >> 8) != 0) return false;
++
++	*val_shift = shift;
++	return true;
++}
++
+ // move a 32bit constant value into dest_reg
+ static void gen_mov_dword_to_reg_imm(HostReg dest_reg,Bit32u imm) {
+-	if ((imm & 0xffffff00) == 0) {
++	Bit32u scale;
++
++	if (imm < 256) {
+ 		cache_checkinstr(2);
+ 		cache_addw( MOV_IMM(dest_reg, imm) );      // mov dest_reg, #(imm)
+-	} else if ((imm & 0xffff00ff) == 0) {
++	} else if ((~imm) < 256) {
+ 		cache_checkinstr(4);
+-		cache_addw( MOV_IMM(dest_reg, imm >> 8) );      // mov dest_reg, #(imm >> 8)
+-		cache_addw( LSL_IMM(dest_reg, dest_reg, 8) );      // lsl dest_reg, dest_reg, #8
+-	} else if ((imm & 0xff00ffff) == 0) {
++		cache_addw( MOV_IMM(dest_reg, ~imm) );      // mov dest_reg, #(~imm)
++		cache_addw( MVN(dest_reg, dest_reg) );      // mvn dest_reg, dest_reg
++	} else if (val_single_shift(imm, &scale)) {
+ 		cache_checkinstr(4);
+-		cache_addw( MOV_IMM(dest_reg, imm >> 16) );      // mov dest_reg, #(imm >> 16)
+-		cache_addw( LSL_IMM(dest_reg, dest_reg, 16) );      // lsl dest_reg, dest_reg, #16
+-	} else if ((imm & 0x00ffffff) == 0) {
+-		cache_checkinstr(4);
+-		cache_addw( MOV_IMM(dest_reg, imm >> 24) );      // mov dest_reg, #(imm >> 24)
+-		cache_addw( LSL_IMM(dest_reg, dest_reg, 24) );      // lsl dest_reg, dest_reg, #24
++		cache_addw( MOV_IMM(dest_reg, imm >> scale) );      // mov dest_reg, #(imm >> scale)
++		cache_addw( LSL_IMM(dest_reg, dest_reg, scale) );      // lsl dest_reg, dest_reg, #scale
+ 	} else {
+ 		Bit32u diff;
+ 
+ 		cache_checkinstr(4);
+ 
+ 		diff = imm - ((Bit32u)cache.pos+4);
+-		
++
+ 		if ((diff < 1024) && ((imm & 0x03) == 0)) {
+ 			if (((Bit32u)cache.pos & 0x03) == 0) {
+ 				cache_addw( ADD_LO_PC_IMM(dest_reg, diff >> 2) );      // add dest_reg, pc, #(diff >> 2)
+@@ -322,10 +364,61 @@
+ 	}
+ }
+ 
++// helper function
++static bool gen_mov_memval_to_reg_helper(HostReg dest_reg, Bit32u data, Bitu size, HostReg addr_reg, Bit32u addr_data) {
++	switch (size) {
++		case 4:
++#if !defined(C_UNALIGNED_MEMORY)
++			if ((data & 3) == 0)
++#endif
++			{
++				if ((data >= addr_data) && (data < addr_data + 128) && (((data - addr_data) & 3) == 0)) {
++					cache_checkinstr(4);
++					cache_addw( MOV_LO_HI(templo2, addr_reg) );      // mov templo2, addr_reg
++					cache_addw( LDR_IMM(dest_reg, templo2, data - addr_data) );      // ldr dest_reg, [templo2, #(data - addr_data)]
++					return true;
++				}
++			}
++			break;
++		case 2:
++#if !defined(C_UNALIGNED_MEMORY)
++			if ((data & 1) == 0)
++#endif
++			{
++				if ((data >= addr_data) && (data < addr_data + 64) && (((data - addr_data) & 1) == 0)) {
++					cache_checkinstr(4);
++					cache_addw( MOV_LO_HI(templo2, addr_reg) );      // mov templo2, addr_reg
++					cache_addw( LDRH_IMM(dest_reg, templo2, data - addr_data) );      // ldrh dest_reg, [templo2, #(data - addr_data)]
++					return true;
++				}
++			}
++			break;
++		case 1:
++			if ((data >= addr_data) && (data < addr_data + 32)) {
++				cache_checkinstr(4);
++				cache_addw( MOV_LO_HI(templo2, addr_reg) );      // mov templo2, addr_reg
++				cache_addw( LDRB_IMM(dest_reg, templo2, data - addr_data) );      // ldrb dest_reg, [templo2, #(data - addr_data)]
++				return true;
++			}
++		default:
++			break;
++	}
++	return false;
++}
++
++// helper function
++static bool gen_mov_memval_to_reg(HostReg dest_reg, void *data, Bitu size) {
++	if (gen_mov_memval_to_reg_helper(dest_reg, (Bit32u)data, size, FC_REGS_ADDR, (Bit32u)&cpu_regs)) return true;
++	if (gen_mov_memval_to_reg_helper(dest_reg, (Bit32u)data, size, readdata_addr, (Bit32u)&core_dynrec.readdata)) return true;
++	if (gen_mov_memval_to_reg_helper(dest_reg, (Bit32u)data, size, FC_SEGS_ADDR, (Bit32u)&Segs)) return true;
++	return false;
++}
++
+ // helper function for gen_mov_word_to_reg
+ static void gen_mov_word_to_reg_helper(HostReg dest_reg,void* data,bool dword,HostReg data_reg) {
+ 	// alignment....
+ 	if (dword) {
++#if !defined(C_UNALIGNED_MEMORY)
+ 		if ((Bit32u)data & 3) {
+ 			if ( ((Bit32u)data & 3) == 2 ) {
+ 				cache_checkinstr(8);
+@@ -344,18 +437,23 @@
+ 				cache_addw( LSL_IMM(templo1, templo1, 24) );      // lsl templo1, templo1, #24
+ 				cache_addw( ORR(dest_reg, templo1) );      // orr dest_reg, templo1
+ 			}
+-		} else {
++		} else
++#endif
++		{
+ 			cache_checkinstr(2);
+ 			cache_addw( LDR_IMM(dest_reg, data_reg, 0) );      // ldr dest_reg, [data_reg]
+ 		}
+ 	} else {
++#if !defined(C_UNALIGNED_MEMORY)
+ 		if ((Bit32u)data & 1) {
+ 			cache_checkinstr(8);
+ 			cache_addw( LDRB_IMM(dest_reg, data_reg, 0) );      // ldrb dest_reg, [data_reg]
+ 			cache_addw( LDRB_IMM(templo1, data_reg, 1) );      // ldrb templo1, [data_reg, #1]
+ 			cache_addw( LSL_IMM(templo1, templo1, 8) );      // lsl templo1, templo1, #8
+ 			cache_addw( ORR(dest_reg, templo1) );      // orr dest_reg, templo1
+-		} else {
++		} else
++#endif
++		{
+ 			cache_checkinstr(2);
+ 			cache_addw( LDRH_IMM(dest_reg, data_reg, 0) );      // ldrh dest_reg, [data_reg]
+ 		}
+@@ -365,8 +463,10 @@
+ // move a 32bit (dword==true) or 16bit (dword==false) value from memory into dest_reg
+ // 16bit moves may destroy the upper 16bit of the destination register
+ static void gen_mov_word_to_reg(HostReg dest_reg,void* data,bool dword) {
+-	gen_mov_dword_to_reg_imm(templo2, (Bit32u)data);
+-	gen_mov_word_to_reg_helper(dest_reg, data, dword, templo2);
++	if (!gen_mov_memval_to_reg(dest_reg, data, (dword)?4:2)) {
++		gen_mov_dword_to_reg_imm(templo2, (Bit32u)data);
++		gen_mov_word_to_reg_helper(dest_reg, data, dword, templo2);
++	}
+ }
+ 
+ // move a 16bit constant value into dest_reg
+@@ -375,10 +475,61 @@
+ 	gen_mov_dword_to_reg_imm(dest_reg, (Bit32u)imm);
+ }
+ 
++// helper function
++static bool gen_mov_memval_from_reg_helper(HostReg src_reg, Bit32u data, Bitu size, HostReg addr_reg, Bit32u addr_data) {
++	switch (size) {
++		case 4:
++#if !defined(C_UNALIGNED_MEMORY)
++			if ((data & 3) == 0)
++#endif
++			{
++				if ((data >= addr_data) && (data < addr_data + 128) && (((data - addr_data) & 3) == 0)) {
++					cache_checkinstr(4);
++					cache_addw( MOV_LO_HI(templo2, addr_reg) );      // mov templo2, addr_reg
++					cache_addw( STR_IMM(src_reg, templo2, data - addr_data) );      // str src_reg, [templo2, #(data - addr_data)]
++					return true;
++				}
++			}
++			break;
++		case 2:
++#if !defined(C_UNALIGNED_MEMORY)
++			if ((data & 1) == 0)
++#endif
++			{
++				if ((data >= addr_data) && (data < addr_data + 64) && (((data - addr_data) & 1) == 0)) {
++					cache_checkinstr(4);
++					cache_addw( MOV_LO_HI(templo2, addr_reg) );      // mov templo2, addr_reg
++					cache_addw( STRH_IMM(src_reg, templo2, data - addr_data) );      // strh src_reg, [templo2, #(data - addr_data)]
++					return true;
++				}
++			}
++			break;
++		case 1:
++			if ((data >= addr_data) && (data < addr_data + 32)) {
++				cache_checkinstr(4);
++				cache_addw( MOV_LO_HI(templo2, addr_reg) );      // mov templo2, addr_reg
++				cache_addw( STRB_IMM(src_reg, templo2, data - addr_data) );      // strb src_reg, [templo2, #(data - addr_data)]
++				return true;
++			}
++		default:
++			break;
++	}
++	return false;
++}
++
++// helper function
++static bool gen_mov_memval_from_reg(HostReg src_reg, void *dest, Bitu size) {
++	if (gen_mov_memval_from_reg_helper(src_reg, (Bit32u)dest, size, FC_REGS_ADDR, (Bit32u)&cpu_regs)) return true;
++	if (gen_mov_memval_from_reg_helper(src_reg, (Bit32u)dest, size, readdata_addr, (Bit32u)&core_dynrec.readdata)) return true;
++	if (gen_mov_memval_from_reg_helper(src_reg, (Bit32u)dest, size, FC_SEGS_ADDR, (Bit32u)&Segs)) return true;
++	return false;
++}
++
+ // helper function for gen_mov_word_from_reg
+ static void gen_mov_word_from_reg_helper(HostReg src_reg,void* dest,bool dword, HostReg data_reg) {
+ 	// alignment....
+ 	if (dword) {
++#if !defined(C_UNALIGNED_MEMORY)
+ 		if ((Bit32u)dest & 3) {
+ 			if ( ((Bit32u)dest & 3) == 2 ) {
+ 				cache_checkinstr(8);
+@@ -399,18 +550,23 @@
+ 				cache_addw( LSR_IMM(templo1, templo1, 24) );      // lsr templo1, templo1, #24
+ 				cache_addw( STRB_IMM(templo1, data_reg, 3) );      // strb templo1, [data_reg, #3]
+ 			}
+-		} else {
++		} else
++#endif
++		{
+ 			cache_checkinstr(2);
+ 			cache_addw( STR_IMM(src_reg, data_reg, 0) );      // str src_reg, [data_reg]
+ 		}
+ 	} else {
++#if !defined(C_UNALIGNED_MEMORY)
+ 		if ((Bit32u)dest & 1) {
+ 			cache_checkinstr(8);
+ 			cache_addw( STRB_IMM(src_reg, data_reg, 0) );      // strb src_reg, [data_reg]
+ 			cache_addw( MOV_REG(templo1, src_reg) );      // mov templo1, src_reg
+ 			cache_addw( LSR_IMM(templo1, templo1, 8) );      // lsr templo1, templo1, #8
+ 			cache_addw( STRB_IMM(templo1, data_reg, 1) );      // strb templo1, [data_reg, #1]
+-		} else {
++		} else
++#endif
++		{
+ 			cache_checkinstr(2);
+ 			cache_addw( STRH_IMM(src_reg, data_reg, 0) );      // strh src_reg, [data_reg]
+ 		}
+@@ -419,8 +575,10 @@
+ 
+ // move 32bit (dword==true) or 16bit (dword==false) of a register into memory
+ static void gen_mov_word_from_reg(HostReg src_reg,void* dest,bool dword) {
+-	gen_mov_dword_to_reg_imm(templo2, (Bit32u)dest);
+-	gen_mov_word_from_reg_helper(src_reg, dest, dword, templo2);
++	if (!gen_mov_memval_from_reg(src_reg, dest, (dword)?4:2)) {
++		gen_mov_dword_to_reg_imm(templo2, (Bit32u)dest);
++		gen_mov_word_from_reg_helper(src_reg, dest, dword, templo2);
++	}
+ }
+ 
+ // move an 8bit value from memory into dest_reg
+@@ -428,9 +586,11 @@
+ // this function does not use FC_OP1/FC_OP2 as dest_reg as these
+ // registers might not be directly byte-accessible on some architectures
+ static void gen_mov_byte_to_reg_low(HostReg dest_reg,void* data) {
+-	gen_mov_dword_to_reg_imm(templo1, (Bit32u)data);
+-	cache_checkinstr(2);
+-	cache_addw( LDRB_IMM(dest_reg, templo1, 0) );      // ldrb dest_reg, [templo1]
++	if (!gen_mov_memval_to_reg(dest_reg, data, 1)) {
++		gen_mov_dword_to_reg_imm(templo1, (Bit32u)data);
++		cache_checkinstr(2);
++		cache_addw( LDRB_IMM(dest_reg, templo1, 0) );      // ldrb dest_reg, [templo1]
++	}
+ }
+ 
+ // move an 8bit value from memory into dest_reg
+@@ -460,9 +620,11 @@
+ 
+ // move the lowest 8bit of a register into memory
+ static void gen_mov_byte_from_reg_low(HostReg src_reg,void* dest) {
+-	gen_mov_dword_to_reg_imm(templo1, (Bit32u)dest);
+-	cache_checkinstr(2);
+-	cache_addw( STRB_IMM(src_reg, templo1, 0) );      // strb src_reg, [templo1]
++	if (!gen_mov_memval_from_reg(src_reg, dest, 1)) {
++		gen_mov_dword_to_reg_imm(templo1, (Bit32u)dest);
++		cache_checkinstr(2);
++		cache_addw( STRB_IMM(src_reg, templo1, 0) );      // strb src_reg, [templo1]
++	}
+ }
+ 
+ 
+@@ -502,18 +664,58 @@
+ 
+ // add a 32bit constant value to a full register
+ static void gen_add_imm(HostReg reg,Bit32u imm) {
++	Bit32u imm2, scale;
++
+ 	if(!imm) return;
+-	gen_mov_dword_to_reg_imm(templo1, imm);
+-	cache_checkinstr(2);
+-	cache_addw( ADD_REG(reg, reg, templo1) );      // add reg, reg, templo1
++
++	imm2 = (Bit32u) (-((Bit32s)imm));
++
++	if (imm <= 255) {
++		cache_checkinstr(2);
++		cache_addw( ADD_IMM8(reg, imm) );      // add reg, #imm
++	} else if (imm2 <= 255) {
++		cache_checkinstr(2);
++		cache_addw( SUB_IMM8(reg, imm2) );      // sub reg, #(-imm)
++	} else {
++		if (val_single_shift(imm2, &scale)) {
++			cache_checkinstr((scale)?6:4);
++			cache_addw( MOV_IMM(templo1, imm2 >> scale) );      // mov templo1, #(~imm >> scale)
++			if (scale) {
++				cache_addw( LSL_IMM(templo1, templo1, scale) );      // lsl templo1, templo1, #scale
++			}
++			cache_addw( SUB_REG(reg, reg, templo1) );      // sub reg, reg, templo1
++		} else {
++			gen_mov_dword_to_reg_imm(templo1, imm);
++			cache_checkinstr(2);
++			cache_addw( ADD_REG(reg, reg, templo1) );      // add reg, reg, templo1
++		}
++	}
+ }
+ 
+ // and a 32bit constant value with a full register
+ static void gen_and_imm(HostReg reg,Bit32u imm) {
+-	if(imm == 0xffffffff) return;
+-	gen_mov_dword_to_reg_imm(templo1, imm);
+-	cache_checkinstr(2);
+-	cache_addw( AND(reg, templo1) );      // and reg, templo1
++	Bit32u imm2, scale;
++
++	imm2 = ~imm;
++	if(!imm2) return;
++
++	if (!imm) {
++		cache_checkinstr(2);
++		cache_addw( MOV_IMM(reg, 0) );      // mov reg, #0
++	} else {
++		if (val_single_shift(imm2, &scale)) {
++			cache_checkinstr((scale)?6:4);
++			cache_addw( MOV_IMM(templo1, imm2 >> scale) );      // mov templo1, #(~imm >> scale)
++			if (scale) {
++				cache_addw( LSL_IMM(templo1, templo1, scale) );      // lsl templo1, templo1, #scale
++			}
++			cache_addw( BIC(reg, templo1) );      // bic reg, templo1
++		} else {
++			gen_mov_dword_to_reg_imm(templo1, imm);
++			cache_checkinstr(2);
++			cache_addw( AND(reg, templo1) );      // and reg, templo1
++		}
++	}
+ }
+ 
+ 
+@@ -528,70 +730,69 @@
+ 	gen_mov_direct_dword(dest,(Bit32u)imm);
+ }
+ 
+-// add an 8bit constant value to a dword memory value
+-static void gen_add_direct_byte(void* dest,Bit8s imm) {
+-	if(!imm) return;
+-	gen_mov_dword_to_reg_imm(templo2, (Bit32u)dest);
+-	gen_mov_word_to_reg_helper(templo3, dest, 1, templo2);
+-	cache_checkinstr(2);
+-	if (imm >= 0) {
+-		cache_addw( ADD_IMM8(templo3, (Bit32s)imm) );      // add templo3, #(imm)
+-	} else {
+-		cache_addw( SUB_IMM8(templo3, -((Bit32s)imm)) );      // sub templo3, #(-imm)
+-	}
+-	gen_mov_word_from_reg_helper(templo3, dest, 1, templo2);
+-}
+-
+ // add a 32bit (dword==true) or 16bit (dword==false) constant value to a memory value
+ static void gen_add_direct_word(void* dest,Bit32u imm,bool dword) {
++	if (!dword) imm &= 0xffff;
+ 	if(!imm) return;
+-	if (dword && ( (imm<128) || (imm>=0xffffff80) ) ) {
+-		gen_add_direct_byte(dest,(Bit8s)imm);
+-		return;
+-	}
+-	gen_mov_dword_to_reg_imm(templo2, (Bit32u)dest);
+-	gen_mov_word_to_reg_helper(templo3, dest, dword, templo2);
+-	if (dword) {
+-		gen_mov_dword_to_reg_imm(templo1, imm);
+-	} else {
+-		gen_mov_word_to_reg_imm(templo1, (Bit16u)imm);
++
++	if (!gen_mov_memval_to_reg(templo3, dest, (dword)?4:2)) {
++		gen_mov_dword_to_reg_imm(templo2, (Bit32u)dest);
++		gen_mov_word_to_reg_helper(templo3, dest, dword, templo2);
++	}
++	gen_add_imm(templo3, imm);
++	if (!gen_mov_memval_from_reg(templo3, dest, (dword)?4:2)) {
++		gen_mov_word_from_reg_helper(templo3, dest, dword, templo2);
+ 	}
+-	cache_checkinstr(2);
+-	cache_addw( ADD_REG(templo3, templo3, templo1) );      // add templo3, templo3, templo1
+-	gen_mov_word_from_reg_helper(templo3, dest, dword, templo2);
+ }
+ 
+-// subtract an 8bit constant value from a dword memory value
+-static void gen_sub_direct_byte(void* dest,Bit8s imm) {
+-	if(!imm) return;
+-	gen_mov_dword_to_reg_imm(templo2, (Bit32u)dest);
+-	gen_mov_word_to_reg_helper(templo3, dest, 1, templo2);
+-	cache_checkinstr(2);
+-	if (imm >= 0) {
+-		cache_addw( SUB_IMM8(templo3, (Bit32s)imm) );      // sub templo3, #(imm)
+-	} else {
+-		cache_addw( ADD_IMM8(templo3, -((Bit32s)imm)) );      // add templo3, #(-imm)
+-	}
+-	gen_mov_word_from_reg_helper(templo3, dest, 1, templo2);
++// add an 8bit constant value to a dword memory value
++static void gen_add_direct_byte(void* dest,Bit8s imm) {
++	gen_add_direct_word(dest, (Bit32s)imm, 1);
+ }
+ 
+ // subtract a 32bit (dword==true) or 16bit (dword==false) constant value from a memory value
+ static void gen_sub_direct_word(void* dest,Bit32u imm,bool dword) {
++	Bit32u imm2, scale;
++
++	if (!dword) imm &= 0xffff;
+ 	if(!imm) return;
+-	if (dword && ( (imm<128) || (imm>=0xffffff80) ) ) {
+-		gen_sub_direct_byte(dest,(Bit8s)imm);
+-		return;
++
++	if (!gen_mov_memval_to_reg(templo3, dest, (dword)?4:2)) {
++		gen_mov_dword_to_reg_imm(templo2, (Bit32u)dest);
++		gen_mov_word_to_reg_helper(templo3, dest, dword, templo2);
+ 	}
+-	gen_mov_dword_to_reg_imm(templo2, (Bit32u)dest);
+-	gen_mov_word_to_reg_helper(templo3, dest, dword, templo2);
+-	if (dword) {
+-		gen_mov_dword_to_reg_imm(templo1, imm);
++
++	imm2 = (Bit32u) (-((Bit32s)imm));
++
++	if (imm <= 255) {
++		cache_checkinstr(2);
++		cache_addw( SUB_IMM8(templo3, imm) );      // sub templo3, #imm
++	} else if (imm2 <= 255) {
++		cache_checkinstr(2);
++		cache_addw( ADD_IMM8(templo3, imm2) );      // add templo3, #(-imm)
+ 	} else {
+-		gen_mov_word_to_reg_imm(templo1, (Bit16u)imm);
++		if (val_single_shift(imm2, &scale)) {
++			cache_checkinstr((scale)?6:4);
++			cache_addw( MOV_IMM(templo1, imm2 >> scale) );      // mov templo1, #(~imm >> scale)
++			if (scale) {
++				cache_addw( LSL_IMM(templo1, templo1, scale) );      // lsl templo1, templo1, #scale
++			}
++			cache_addw( ADD_REG(templo3, templo3, templo1) );      // add templo3, templo3, templo1
++		} else {
++			gen_mov_dword_to_reg_imm(templo1, imm);
++			cache_checkinstr(2);
++			cache_addw( SUB_REG(templo3, templo3, templo1) );      // sub templo3, templo3, templo1
++		}
+ 	}
+-	cache_checkinstr(2);
+-	cache_addw( SUB_REG(templo3, templo3, templo1) );      // sub templo3, templo3, templo1
+-	gen_mov_word_from_reg_helper(templo3, dest, dword, templo2);
++
++	if (!gen_mov_memval_from_reg(templo3, dest, (dword)?4:2)) {
++		gen_mov_word_from_reg_helper(templo3, dest, dword, templo2);
++	}
++}
++
++// subtract an 8bit constant value from a dword memory value
++static void gen_sub_direct_byte(void* dest,Bit8s imm) {
++	gen_sub_direct_word(dest, (Bit32s)imm, 1);
+ }
+ 
+ // effective address calculation, destination is dest_reg
+@@ -695,20 +896,22 @@
+ static void gen_jmp_ptr(void * ptr,Bits imm=0) {
+ 	gen_mov_word_to_reg(templo3, ptr, 1);
+ 
+-	if (imm) {
+-		gen_mov_dword_to_reg_imm(templo2, imm);
+-		cache_checkinstr(2);
+-		cache_addw( ADD_REG(templo3, templo3, templo2) );      // add templo3, templo3, templo2
+-	}
+-
+-#if (1)
+-// (*ptr) should be word aligned 
++#if !defined(C_UNALIGNED_MEMORY)
++// (*ptr) should be word aligned
+ 	if ((imm & 0x03) == 0) {
+-		cache_checkinstr(6);
+-		cache_addw( LDR_IMM(templo2, templo3, 0) );      // ldr templo2, [templo3]
+-	} else
+ #endif
+-	{
++		if ((imm >= 0) && (imm < 128) && ((imm & 3) == 0)) {
++			cache_checkinstr(6);
++			cache_addw( LDR_IMM(templo2, templo3, imm) );      // ldr templo2, [templo3, #imm]
++		} else {
++			gen_mov_dword_to_reg_imm(templo2, imm);
++			cache_checkinstr(6);
++			cache_addw( LDR_REG(templo2, templo3, templo2) );      // ldr templo2, [templo3, templo2]
++		}
++#if !defined(C_UNALIGNED_MEMORY)
++	} else {
++		gen_add_imm(templo3, imm);
++
+ 		cache_checkinstr(24);
+ 		cache_addw( LDRB_IMM(templo2, templo3, 0) );      // ldrb templo2, [templo3]
+ 		cache_addw( LDRB_IMM(templo1, templo3, 1) );      // ldrb templo1, [templo3, #1]
+@@ -721,6 +924,7 @@
+ 		cache_addw( LSL_IMM(templo1, templo1, 24) );      // lsl templo1, templo1, #24
+ 		cache_addw( ORR(templo2, templo1) );      // orr templo2, templo1
+ 	}
++#endif
+ 
+ 	// increase jmp address to keep thumb state
+ 	cache_addw( ADD_IMM3(templo2, templo2, 1) );      // add templo2, templo2, #1
+@@ -816,50 +1020,53 @@
+ }
+ 
+ static void gen_run_code(void) {
+-	// switch from arm to thumb state
+-	cache_addd(0xe2800000 + (HOST_r3 << 12) + (HOST_pc << 16) + (1));      // add r3, pc, #1
+-	cache_addd(0xe12fff10 + (HOST_r3));      // bx r3
++	Bit8u *pos1, *pos2, *pos3;
+ 
+-	// thumb state from now on
+-	cache_addw(0xb500);      // push {lr}
+-	cache_addw( MOV_LO_HI(HOST_r3, FC_SEGS_ADDR) );      // mov r3, FC_SEGS_ADDR
+-	cache_addw( MOV_LO_HI(HOST_r2, FC_REGS_ADDR) );      // mov r2, FC_REGS_ADDR
+-	cache_addw(0xb4fc);      // push {r2,r3,v1-v4}
+-
+-	// adr: 16
+-	cache_addw( LDR_PC_IMM(HOST_r3, 64 - (16 + 4)) );        // ldr r3, [pc, #(&Segs)]
+-	// adr: 18
+-	cache_addw( LDR_PC_IMM(HOST_r2, 68 - (18 + 2)) );        // ldr r2, [pc, #(&cpu_regs)]
+-	cache_addw( MOV_HI_LO(FC_SEGS_ADDR, HOST_r3) );      // mov FC_SEGS_ADDR, r3
+-	cache_addw( MOV_HI_LO(FC_REGS_ADDR, HOST_r2) );      // mov FC_REGS_ADDR, r2
+-
+-	// align 4
+-	cache_addw( ADD_LO_PC_IMM(HOST_r3, 8) );      // add r3, pc, #8
+-	cache_addw( ADD_IMM8(HOST_r0, 1) );      // add r0, #1
+-	cache_addw( ADD_IMM8(HOST_r3, 1) );      // add r3, #1
+-	cache_addw(0xb408);      // push {r3}
+-	cache_addw( BX(HOST_r0) );      // bx r0
+-	cache_addw( NOP );      // nop
+-
+-	// align 4
+-	cache_addw(0xbcfc);      // pop {r2,r3,v1-v4}
+-	cache_addw( MOV_HI_LO(FC_SEGS_ADDR, HOST_r3) );      // mov FC_SEGS_ADDR, r3
+-	cache_addw( MOV_HI_LO(FC_REGS_ADDR, HOST_r2) );      // mov FC_REGS_ADDR, r2
+-
+-	cache_addw(0xbc08);      // pop {r3}
+-	cache_addw( BX(HOST_r3) );      // bx r3
+-
+-	// fill up to 64 bytes
+-	cache_addw( NOP );      // nop
+-	cache_addd( NOP | (NOP << 16) );  // nop, nop
+-	cache_addd( NOP | (NOP << 16) );  // nop, nop
+-	cache_addd( NOP | (NOP << 16) );  // nop, nop
+-	cache_addd( NOP | (NOP << 16) );  // nop, nop
++#if (__ARM_EABI__)
++	// 8-byte stack alignment
++	cache_addd(0xe92d4ff0);			// stmfd sp!, {v1-v8,lr}
++#else
++	cache_addd(0xe92d4df0);			// stmfd sp!, {v1-v5,v7,v8,lr}
++#endif
++
++	cache_addd( ARM_ADD_IMM(HOST_r0, HOST_r0, 1, 0) );      // add r0, r0, #1
+ 
+-	// adr: 64
++	pos1 = cache.pos;
++	cache_addd( 0 );
++	pos2 = cache.pos;
++	cache_addd( 0 );
++	pos3 = cache.pos;
++	cache_addd( 0 );
++
++	cache_addd( ARM_ADD_IMM(HOST_lr, HOST_pc, 4, 0) );			// add lr, pc, #4
++	cache_addd( ARM_STR_IMM_M_W(HOST_lr, HOST_sp, 4) );      // str lr, [sp, #-4]!
++	cache_addd( ARM_BX(HOST_r0) );			// bx r0
++
++#if (__ARM_EABI__)
++	cache_addd(0xe8bd4ff0);			// ldmfd sp!, {v1-v8,lr}
++#else
++	cache_addd(0xe8bd4df0);			// ldmfd sp!, {v1-v5,v7,v8,lr}
++#endif
++	cache_addd( ARM_BX(HOST_lr) );			// bx lr
++
++	// align cache.pos to 32 bytes
++	if ((((Bitu)cache.pos) & 0x1f) != 0) {
++		cache.pos = cache.pos + (32 - (((Bitu)cache.pos) & 0x1f));
++	}
++
++	*(Bit32u*)pos1 = ARM_LDR_IMM(FC_SEGS_ADDR, HOST_pc, cache.pos - (pos1 + 8));      // ldr FC_SEGS_ADDR, [pc, #(&Segs)]
+ 	cache_addd((Bit32u)&Segs);      // address of "Segs"
+-	// adr: 68
++
++	*(Bit32u*)pos2 = ARM_LDR_IMM(FC_REGS_ADDR, HOST_pc, cache.pos - (pos2 + 8));      // ldr FC_REGS_ADDR, [pc, #(&cpu_regs)]
+ 	cache_addd((Bit32u)&cpu_regs);  // address of "cpu_regs"
++
++	*(Bit32u*)pos3 = ARM_LDR_IMM(readdata_addr, HOST_pc, cache.pos - (pos3 + 8));      // ldr readdata_addr, [pc, #(&core_dynrec.readdata)]
++	cache_addd((Bit32u)&core_dynrec.readdata);  // address of "core_dynrec.readdata"
++
++	// align cache.pos to 32 bytes
++	if ((((Bitu)cache.pos) & 0x1f) != 0) {
++		cache.pos = cache.pos + (32 - (((Bitu)cache.pos) & 0x1f));
++	}
+ }
+ 
+ // return from a function
+diff -Nur dosbox-0.74/src/cpu/core_dynrec/risc_armv4le-thumb-niw.h dosbox/src/cpu/core_dynrec/risc_armv4le-thumb-niw.h
+--- dosbox-0.74/src/cpu/core_dynrec/risc_armv4le-thumb-niw.h	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/cpu/core_dynrec/risc_armv4le-thumb-niw.h	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,7 +16,6 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: risc_armv4le-thumb-niw.h,v 1.5 2009-06-27 12:51:10 c2woody Exp $ */
+ 
+ 
+ /* ARMv4 (little endian) backend by M-HT (thumb version with data pool) */
+@@ -51,15 +50,14 @@
+ // temporary register for LEA
+ #define TEMP_REG_DRC HOST_a4
+ 
+-#ifdef DRC_USE_REGS_ADDR
+ // used to hold the address of "cpu_regs" - preferably filled in function gen_run_code
+ #define FC_REGS_ADDR HOST_v7
+-#endif
+ 
+-#ifdef DRC_USE_SEGS_ADDR
+ // used to hold the address of "Segs" - preferably filled in function gen_run_code
+ #define FC_SEGS_ADDR HOST_v8
+-#endif
++
++// used to hold the address of "core_dynrec.readdata" - filled in function gen_run_code
++#define readdata_addr HOST_v5
+ 
+ 
+ // instruction encodings
+@@ -99,10 +97,14 @@
+ // logical
+ // and dst, src
+ #define AND(dst, src) (0x4000 + (dst) + ((src) << 3) )
++// bic dst, src
++#define BIC(dst, src) (0x4380 + (dst) + ((src) << 3) )
+ // eor dst, src
+ #define EOR(dst, src) (0x4040 + (dst) + ((src) << 3) )
+ // orr dst, src
+ #define ORR(dst, src) (0x4300 + (dst) + ((src) << 3) )
++// mvn dst, src
++#define MVN(dst, src) (0x43c0 + (dst) + ((src) << 3) )
+ 
+ // shift/rotate
+ // lsl dst, src, #imm
+@@ -129,6 +131,8 @@
+ #define LDRB_IMM(reg, addr, imm) (0x7800 + (reg) + ((addr) << 3) + ((imm) << 6) )
+ // ldr reg, [pc, #imm]		@	0 <= imm < 1024	&	imm mod 4 = 0
+ #define LDR_PC_IMM(reg, imm) (0x4800 + ((reg) << 8) + ((imm) >> 2) )
++// ldr reg, [addr1, addr2]
++#define LDR_REG(reg, addr1, addr2) (0x5800 + (reg) + ((addr1) << 3) + ((addr2) << 6) )
+ 
+ // store
+ // str reg, [addr, #imm]		@	0 <= imm < 128	&	imm mod 4 = 0
+@@ -151,6 +155,25 @@
+ #define BX(reg) (0x4700 + ((reg) << 3) )
+ 
+ 
++// arm instructions
++
++// arithmetic
++// add dst, src, #(imm ror rimm)		@	0 <= imm <= 255	&	rimm mod 2 = 0
++#define ARM_ADD_IMM(dst, src, imm, rimm) (0xe2800000 + ((dst) << 12) + ((src) << 16) + (imm) + ((rimm) << 7) )
++
++// load
++// ldr reg, [addr, #imm]		@	0 <= imm < 4096
++#define ARM_LDR_IMM(reg, addr, imm) (0xe5900000 + ((reg) << 12) + ((addr) << 16) + (imm) )
++
++// store
++// str reg, [addr, #-(imm)]!		@	0 <= imm < 4096
++#define ARM_STR_IMM_M_W(reg, addr, imm) (0xe5200000 + ((reg) << 12) + ((addr) << 16) + (imm) )
++
++// branch
++// bx reg
++#define ARM_BX(reg) (0xe12fff10 + (reg) )
++
++
+ // data pool defines
+ #define CACHE_DATA_JUMP	 (2)
+ #define CACHE_DATA_ALIGN (32)
+@@ -194,7 +217,7 @@
+ 		cache_datapos = (Bit8u *) (((Bitu)cache.block.active->cache.start + cache.block.active->cache.size - CACHE_DATA_ALIGN) & ~(CACHE_DATA_ALIGN - 1));
+ 	} else {
+ 		register Bit32u cachemodsize;
+-	
++
+ 		cachemodsize = (cache.pos - cache.block.active->cache.start) & (CACHE_MAXSIZE - 1);
+ 
+ 		if (cachemodsize + CACHE_DATA_MAX + CACHE_DATA_ALIGN <= CACHE_MAXSIZE ||
+@@ -276,30 +299,49 @@
+ 	cache_addw( MOV_REG(reg_dst, reg_src) );      // mov reg_dst, reg_src
+ }
+ 
++// helper function
++static bool val_single_shift(Bit32u value, Bit32u *val_shift) {
++	Bit32u shift;
++
++	if (GCC_UNLIKELY(value == 0)) {
++		*val_shift = 0;
++		return true;
++	}
++
++	shift = 0;
++	while ((value & 1) == 0) {
++		value>>=1;
++		shift+=1;
++	}
++
++	if ((value >> 8) != 0) return false;
++
++	*val_shift = shift;
++	return true;
++}
++
+ // move a 32bit constant value into dest_reg
+ static void gen_mov_dword_to_reg_imm(HostReg dest_reg,Bit32u imm) {
+-	if ((imm & 0xffffff00) == 0) {
++	Bit32u scale;
++
++	if (imm < 256) {
+ 		cache_checkinstr(2);
+ 		cache_addw( MOV_IMM(dest_reg, imm) );      // mov dest_reg, #(imm)
+-	} else if ((imm & 0xffff00ff) == 0) {
++	} else if ((~imm) < 256) {
+ 		cache_checkinstr(4);
+-		cache_addw( MOV_IMM(dest_reg, imm >> 8) );      // mov dest_reg, #(imm >> 8)
+-		cache_addw( LSL_IMM(dest_reg, dest_reg, 8) );      // lsl dest_reg, dest_reg, #8
+-	} else if ((imm & 0xff00ffff) == 0) {
++		cache_addw( MOV_IMM(dest_reg, ~imm) );      // mov dest_reg, #(~imm)
++		cache_addw( MVN(dest_reg, dest_reg) );      // mvn dest_reg, dest_reg
++	} else if (val_single_shift(imm, &scale)) {
+ 		cache_checkinstr(4);
+-		cache_addw( MOV_IMM(dest_reg, imm >> 16) );      // mov dest_reg, #(imm >> 16)
+-		cache_addw( LSL_IMM(dest_reg, dest_reg, 16) );      // lsl dest_reg, dest_reg, #16
+-	} else if ((imm & 0x00ffffff) == 0) {
+-		cache_checkinstr(4);
+-		cache_addw( MOV_IMM(dest_reg, imm >> 24) );      // mov dest_reg, #(imm >> 24)
+-		cache_addw( LSL_IMM(dest_reg, dest_reg, 24) );      // lsl dest_reg, dest_reg, #24
++		cache_addw( MOV_IMM(dest_reg, imm >> scale) );      // mov dest_reg, #(imm >> scale)
++		cache_addw( LSL_IMM(dest_reg, dest_reg, scale) );      // lsl dest_reg, dest_reg, #scale
+ 	} else {
+ 		Bit32u diff;
+ 
+ 		cache_checkinstr(4);
+ 
+ 		diff = imm - ((Bit32u)cache.pos+4);
+-		
++
+ 		if ((diff < 1024) && ((imm & 0x03) == 0)) {
+ 			if (((Bit32u)cache.pos & 0x03) == 0) {
+ 				cache_addw( ADD_LO_PC_IMM(dest_reg, diff >> 2) );      // add dest_reg, pc, #(diff >> 2)
+@@ -322,10 +364,61 @@
+ 	}
+ }
+ 
++// helper function
++static bool gen_mov_memval_to_reg_helper(HostReg dest_reg, Bit32u data, Bitu size, HostReg addr_reg, Bit32u addr_data) {
++	switch (size) {
++		case 4:
++#if !defined(C_UNALIGNED_MEMORY)
++			if ((data & 3) == 0)
++#endif
++			{
++				if ((data >= addr_data) && (data < addr_data + 128) && (((data - addr_data) & 3) == 0)) {
++					cache_checkinstr(4);
++					cache_addw( MOV_LO_HI(templo2, addr_reg) );      // mov templo2, addr_reg
++					cache_addw( LDR_IMM(dest_reg, templo2, data - addr_data) );      // ldr dest_reg, [templo2, #(data - addr_data)]
++					return true;
++				}
++			}
++			break;
++		case 2:
++#if !defined(C_UNALIGNED_MEMORY)
++			if ((data & 1) == 0)
++#endif
++			{
++				if ((data >= addr_data) && (data < addr_data + 64) && (((data - addr_data) & 1) == 0)) {
++					cache_checkinstr(4);
++					cache_addw( MOV_LO_HI(templo2, addr_reg) );      // mov templo2, addr_reg
++					cache_addw( LDRH_IMM(dest_reg, templo2, data - addr_data) );      // ldrh dest_reg, [templo2, #(data - addr_data)]
++					return true;
++				}
++			}
++			break;
++		case 1:
++			if ((data >= addr_data) && (data < addr_data + 32)) {
++				cache_checkinstr(4);
++				cache_addw( MOV_LO_HI(templo2, addr_reg) );      // mov templo2, addr_reg
++				cache_addw( LDRB_IMM(dest_reg, templo2, data - addr_data) );      // ldrb dest_reg, [templo2, #(data - addr_data)]
++				return true;
++			}
++		default:
++			break;
++	}
++	return false;
++}
++
++// helper function
++static bool gen_mov_memval_to_reg(HostReg dest_reg, void *data, Bitu size) {
++	if (gen_mov_memval_to_reg_helper(dest_reg, (Bit32u)data, size, FC_REGS_ADDR, (Bit32u)&cpu_regs)) return true;
++	if (gen_mov_memval_to_reg_helper(dest_reg, (Bit32u)data, size, readdata_addr, (Bit32u)&core_dynrec.readdata)) return true;
++	if (gen_mov_memval_to_reg_helper(dest_reg, (Bit32u)data, size, FC_SEGS_ADDR, (Bit32u)&Segs)) return true;
++	return false;
++}
++
+ // helper function for gen_mov_word_to_reg
+ static void gen_mov_word_to_reg_helper(HostReg dest_reg,void* data,bool dword,HostReg data_reg) {
+ 	// alignment....
+ 	if (dword) {
++#if !defined(C_UNALIGNED_MEMORY)
+ 		if ((Bit32u)data & 3) {
+ 			if ( ((Bit32u)data & 3) == 2 ) {
+ 				cache_checkinstr(8);
+@@ -344,18 +437,23 @@
+ 				cache_addw( LSL_IMM(templo1, templo1, 24) );      // lsl templo1, templo1, #24
+ 				cache_addw( ORR(dest_reg, templo1) );      // orr dest_reg, templo1
+ 			}
+-		} else {
++		} else
++#endif
++		{
+ 			cache_checkinstr(2);
+ 			cache_addw( LDR_IMM(dest_reg, data_reg, 0) );      // ldr dest_reg, [data_reg]
+ 		}
+ 	} else {
++#if !defined(C_UNALIGNED_MEMORY)
+ 		if ((Bit32u)data & 1) {
+ 			cache_checkinstr(8);
+ 			cache_addw( LDRB_IMM(dest_reg, data_reg, 0) );      // ldrb dest_reg, [data_reg]
+ 			cache_addw( LDRB_IMM(templo1, data_reg, 1) );      // ldrb templo1, [data_reg, #1]
+ 			cache_addw( LSL_IMM(templo1, templo1, 8) );      // lsl templo1, templo1, #8
+ 			cache_addw( ORR(dest_reg, templo1) );      // orr dest_reg, templo1
+-		} else {
++		} else
++#endif
++		{
+ 			cache_checkinstr(2);
+ 			cache_addw( LDRH_IMM(dest_reg, data_reg, 0) );      // ldrh dest_reg, [data_reg]
+ 		}
+@@ -365,8 +463,10 @@
+ // move a 32bit (dword==true) or 16bit (dword==false) value from memory into dest_reg
+ // 16bit moves may destroy the upper 16bit of the destination register
+ static void gen_mov_word_to_reg(HostReg dest_reg,void* data,bool dword) {
+-	gen_mov_dword_to_reg_imm(templo2, (Bit32u)data);
+-	gen_mov_word_to_reg_helper(dest_reg, data, dword, templo2);
++	if (!gen_mov_memval_to_reg(dest_reg, data, (dword)?4:2)) {
++		gen_mov_dword_to_reg_imm(templo2, (Bit32u)data);
++		gen_mov_word_to_reg_helper(dest_reg, data, dword, templo2);
++	}
+ }
+ 
+ // move a 16bit constant value into dest_reg
+@@ -375,10 +475,61 @@
+ 	gen_mov_dword_to_reg_imm(dest_reg, (Bit32u)imm);
+ }
+ 
++// helper function
++static bool gen_mov_memval_from_reg_helper(HostReg src_reg, Bit32u data, Bitu size, HostReg addr_reg, Bit32u addr_data) {
++	switch (size) {
++		case 4:
++#if !defined(C_UNALIGNED_MEMORY)
++			if ((data & 3) == 0)
++#endif
++			{
++				if ((data >= addr_data) && (data < addr_data + 128) && (((data - addr_data) & 3) == 0)) {
++					cache_checkinstr(4);
++					cache_addw( MOV_LO_HI(templo2, addr_reg) );      // mov templo2, addr_reg
++					cache_addw( STR_IMM(src_reg, templo2, data - addr_data) );      // str src_reg, [templo2, #(data - addr_data)]
++					return true;
++				}
++			}
++			break;
++		case 2:
++#if !defined(C_UNALIGNED_MEMORY)
++			if ((data & 1) == 0)
++#endif
++			{
++				if ((data >= addr_data) && (data < addr_data + 64) && (((data - addr_data) & 1) == 0)) {
++					cache_checkinstr(4);
++					cache_addw( MOV_LO_HI(templo2, addr_reg) );      // mov templo2, addr_reg
++					cache_addw( STRH_IMM(src_reg, templo2, data - addr_data) );      // strh src_reg, [templo2, #(data - addr_data)]
++					return true;
++				}
++			}
++			break;
++		case 1:
++			if ((data >= addr_data) && (data < addr_data + 32)) {
++				cache_checkinstr(4);
++				cache_addw( MOV_LO_HI(templo2, addr_reg) );      // mov templo2, addr_reg
++				cache_addw( STRB_IMM(src_reg, templo2, data - addr_data) );      // strb src_reg, [templo2, #(data - addr_data)]
++				return true;
++			}
++		default:
++			break;
++	}
++	return false;
++}
++
++// helper function
++static bool gen_mov_memval_from_reg(HostReg src_reg, void *dest, Bitu size) {
++	if (gen_mov_memval_from_reg_helper(src_reg, (Bit32u)dest, size, FC_REGS_ADDR, (Bit32u)&cpu_regs)) return true;
++	if (gen_mov_memval_from_reg_helper(src_reg, (Bit32u)dest, size, readdata_addr, (Bit32u)&core_dynrec.readdata)) return true;
++	if (gen_mov_memval_from_reg_helper(src_reg, (Bit32u)dest, size, FC_SEGS_ADDR, (Bit32u)&Segs)) return true;
++	return false;
++}
++
+ // helper function for gen_mov_word_from_reg
+ static void gen_mov_word_from_reg_helper(HostReg src_reg,void* dest,bool dword, HostReg data_reg) {
+ 	// alignment....
+ 	if (dword) {
++#if !defined(C_UNALIGNED_MEMORY)
+ 		if ((Bit32u)dest & 3) {
+ 			if ( ((Bit32u)dest & 3) == 2 ) {
+ 				cache_checkinstr(8);
+@@ -399,18 +550,23 @@
+ 				cache_addw( LSR_IMM(templo1, templo1, 24) );      // lsr templo1, templo1, #24
+ 				cache_addw( STRB_IMM(templo1, data_reg, 3) );      // strb templo1, [data_reg, #3]
+ 			}
+-		} else {
++		} else
++#endif
++		{
+ 			cache_checkinstr(2);
+ 			cache_addw( STR_IMM(src_reg, data_reg, 0) );      // str src_reg, [data_reg]
+ 		}
+ 	} else {
++#if !defined(C_UNALIGNED_MEMORY)
+ 		if ((Bit32u)dest & 1) {
+ 			cache_checkinstr(8);
+ 			cache_addw( STRB_IMM(src_reg, data_reg, 0) );      // strb src_reg, [data_reg]
+ 			cache_addw( MOV_REG(templo1, src_reg) );      // mov templo1, src_reg
+ 			cache_addw( LSR_IMM(templo1, templo1, 8) );      // lsr templo1, templo1, #8
+ 			cache_addw( STRB_IMM(templo1, data_reg, 1) );      // strb templo1, [data_reg, #1]
+-		} else {
++		} else
++#endif
++		{
+ 			cache_checkinstr(2);
+ 			cache_addw( STRH_IMM(src_reg, data_reg, 0) );      // strh src_reg, [data_reg]
+ 		}
+@@ -419,8 +575,10 @@
+ 
+ // move 32bit (dword==true) or 16bit (dword==false) of a register into memory
+ static void gen_mov_word_from_reg(HostReg src_reg,void* dest,bool dword) {
+-	gen_mov_dword_to_reg_imm(templo2, (Bit32u)dest);
+-	gen_mov_word_from_reg_helper(src_reg, dest, dword, templo2);
++	if (!gen_mov_memval_from_reg(src_reg, dest, (dword)?4:2)) {
++		gen_mov_dword_to_reg_imm(templo2, (Bit32u)dest);
++		gen_mov_word_from_reg_helper(src_reg, dest, dword, templo2);
++	}
+ }
+ 
+ // move an 8bit value from memory into dest_reg
+@@ -428,9 +586,11 @@
+ // this function does not use FC_OP1/FC_OP2 as dest_reg as these
+ // registers might not be directly byte-accessible on some architectures
+ static void gen_mov_byte_to_reg_low(HostReg dest_reg,void* data) {
+-	gen_mov_dword_to_reg_imm(templo1, (Bit32u)data);
+-	cache_checkinstr(2);
+-	cache_addw( LDRB_IMM(dest_reg, templo1, 0) );      // ldrb dest_reg, [templo1]
++	if (!gen_mov_memval_to_reg(dest_reg, data, 1)) {
++		gen_mov_dword_to_reg_imm(templo1, (Bit32u)data);
++		cache_checkinstr(2);
++		cache_addw( LDRB_IMM(dest_reg, templo1, 0) );      // ldrb dest_reg, [templo1]
++	}
+ }
+ 
+ // move an 8bit value from memory into dest_reg
+@@ -460,9 +620,11 @@
+ 
+ // move the lowest 8bit of a register into memory
+ static void gen_mov_byte_from_reg_low(HostReg src_reg,void* dest) {
+-	gen_mov_dword_to_reg_imm(templo1, (Bit32u)dest);
+-	cache_checkinstr(2);
+-	cache_addw( STRB_IMM(src_reg, templo1, 0) );      // strb src_reg, [templo1]
++	if (!gen_mov_memval_from_reg(src_reg, dest, 1)) {
++		gen_mov_dword_to_reg_imm(templo1, (Bit32u)dest);
++		cache_checkinstr(2);
++		cache_addw( STRB_IMM(src_reg, templo1, 0) );      // strb src_reg, [templo1]
++	}
+ }
+ 
+ 
+@@ -502,18 +664,58 @@
+ 
+ // add a 32bit constant value to a full register
+ static void gen_add_imm(HostReg reg,Bit32u imm) {
++	Bit32u imm2, scale;
++
+ 	if(!imm) return;
+-	gen_mov_dword_to_reg_imm(templo1, imm);
+-	cache_checkinstr(2);
+-	cache_addw( ADD_REG(reg, reg, templo1) );      // add reg, reg, templo1
++
++	imm2 = (Bit32u) (-((Bit32s)imm));
++
++	if (imm <= 255) {
++		cache_checkinstr(2);
++		cache_addw( ADD_IMM8(reg, imm) );      // add reg, #imm
++	} else if (imm2 <= 255) {
++		cache_checkinstr(2);
++		cache_addw( SUB_IMM8(reg, imm2) );      // sub reg, #(-imm)
++	} else {
++		if (val_single_shift(imm2, &scale)) {
++			cache_checkinstr((scale)?6:4);
++			cache_addw( MOV_IMM(templo1, imm2 >> scale) );      // mov templo1, #(~imm >> scale)
++			if (scale) {
++				cache_addw( LSL_IMM(templo1, templo1, scale) );      // lsl templo1, templo1, #scale
++			}
++			cache_addw( SUB_REG(reg, reg, templo1) );      // sub reg, reg, templo1
++		} else {
++			gen_mov_dword_to_reg_imm(templo1, imm);
++			cache_checkinstr(2);
++			cache_addw( ADD_REG(reg, reg, templo1) );      // add reg, reg, templo1
++		}
++	}
+ }
+ 
+ // and a 32bit constant value with a full register
+ static void gen_and_imm(HostReg reg,Bit32u imm) {
+-	if(imm == 0xffffffff) return;
+-	gen_mov_dword_to_reg_imm(templo1, imm);
+-	cache_checkinstr(2);
+-	cache_addw( AND(reg, templo1) );      // and reg, templo1
++	Bit32u imm2, scale;
++
++	imm2 = ~imm;
++	if(!imm2) return;
++
++	if (!imm) {
++		cache_checkinstr(2);
++		cache_addw( MOV_IMM(reg, 0) );      // mov reg, #0
++	} else {
++		if (val_single_shift(imm2, &scale)) {
++			cache_checkinstr((scale)?6:4);
++			cache_addw( MOV_IMM(templo1, imm2 >> scale) );      // mov templo1, #(~imm >> scale)
++			if (scale) {
++				cache_addw( LSL_IMM(templo1, templo1, scale) );      // lsl templo1, templo1, #scale
++			}
++			cache_addw( BIC(reg, templo1) );      // bic reg, templo1
++		} else {
++			gen_mov_dword_to_reg_imm(templo1, imm);
++			cache_checkinstr(2);
++			cache_addw( AND(reg, templo1) );      // and reg, templo1
++		}
++	}
+ }
+ 
+ 
+@@ -528,70 +730,69 @@
+ 	gen_mov_direct_dword(dest,(Bit32u)imm);
+ }
+ 
+-// add an 8bit constant value to a dword memory value
+-static void gen_add_direct_byte(void* dest,Bit8s imm) {
+-	if(!imm) return;
+-	gen_mov_dword_to_reg_imm(templo2, (Bit32u)dest);
+-	gen_mov_word_to_reg_helper(templo3, dest, 1, templo2);
+-	cache_checkinstr(2);
+-	if (imm >= 0) {
+-		cache_addw( ADD_IMM8(templo3, (Bit32s)imm) );      // add templo3, #(imm)
+-	} else {
+-		cache_addw( SUB_IMM8(templo3, -((Bit32s)imm)) );      // sub templo3, #(-imm)
+-	}
+-	gen_mov_word_from_reg_helper(templo3, dest, 1, templo2);
+-}
+-
+ // add a 32bit (dword==true) or 16bit (dword==false) constant value to a memory value
+ static void gen_add_direct_word(void* dest,Bit32u imm,bool dword) {
++	if (!dword) imm &= 0xffff;
+ 	if(!imm) return;
+-	if (dword && ( (imm<128) || (imm>=0xffffff80) ) ) {
+-		gen_add_direct_byte(dest,(Bit8s)imm);
+-		return;
+-	}
+-	gen_mov_dword_to_reg_imm(templo2, (Bit32u)dest);
+-	gen_mov_word_to_reg_helper(templo3, dest, dword, templo2);
+-	if (dword) {
+-		gen_mov_dword_to_reg_imm(templo1, imm);
+-	} else {
+-		gen_mov_word_to_reg_imm(templo1, (Bit16u)imm);
++
++	if (!gen_mov_memval_to_reg(templo3, dest, (dword)?4:2)) {
++		gen_mov_dword_to_reg_imm(templo2, (Bit32u)dest);
++		gen_mov_word_to_reg_helper(templo3, dest, dword, templo2);
++	}
++	gen_add_imm(templo3, imm);
++	if (!gen_mov_memval_from_reg(templo3, dest, (dword)?4:2)) {
++		gen_mov_word_from_reg_helper(templo3, dest, dword, templo2);
+ 	}
+-	cache_checkinstr(2);
+-	cache_addw( ADD_REG(templo3, templo3, templo1) );      // add templo3, templo3, templo1
+-	gen_mov_word_from_reg_helper(templo3, dest, dword, templo2);
+ }
+ 
+-// subtract an 8bit constant value from a dword memory value
+-static void gen_sub_direct_byte(void* dest,Bit8s imm) {
+-	if(!imm) return;
+-	gen_mov_dword_to_reg_imm(templo2, (Bit32u)dest);
+-	gen_mov_word_to_reg_helper(templo3, dest, 1, templo2);
+-	cache_checkinstr(2);
+-	if (imm >= 0) {
+-		cache_addw( SUB_IMM8(templo3, (Bit32s)imm) );      // sub templo3, #(imm)
+-	} else {
+-		cache_addw( ADD_IMM8(templo3, -((Bit32s)imm)) );      // add templo3, #(-imm)
+-	}
+-	gen_mov_word_from_reg_helper(templo3, dest, 1, templo2);
++// add an 8bit constant value to a dword memory value
++static void gen_add_direct_byte(void* dest,Bit8s imm) {
++	gen_add_direct_word(dest, (Bit32s)imm, 1);
+ }
+ 
+ // subtract a 32bit (dword==true) or 16bit (dword==false) constant value from a memory value
+ static void gen_sub_direct_word(void* dest,Bit32u imm,bool dword) {
++	Bit32u imm2, scale;
++
++	if (!dword) imm &= 0xffff;
+ 	if(!imm) return;
+-	if (dword && ( (imm<128) || (imm>=0xffffff80) ) ) {
+-		gen_sub_direct_byte(dest,(Bit8s)imm);
+-		return;
++
++	if (!gen_mov_memval_to_reg(templo3, dest, (dword)?4:2)) {
++		gen_mov_dword_to_reg_imm(templo2, (Bit32u)dest);
++		gen_mov_word_to_reg_helper(templo3, dest, dword, templo2);
+ 	}
+-	gen_mov_dword_to_reg_imm(templo2, (Bit32u)dest);
+-	gen_mov_word_to_reg_helper(templo3, dest, dword, templo2);
+-	if (dword) {
+-		gen_mov_dword_to_reg_imm(templo1, imm);
++
++	imm2 = (Bit32u) (-((Bit32s)imm));
++
++	if (imm <= 255) {
++		cache_checkinstr(2);
++		cache_addw( SUB_IMM8(templo3, imm) );      // sub templo3, #imm
++	} else if (imm2 <= 255) {
++		cache_checkinstr(2);
++		cache_addw( ADD_IMM8(templo3, imm2) );      // add templo3, #(-imm)
+ 	} else {
+-		gen_mov_word_to_reg_imm(templo1, (Bit16u)imm);
++		if (val_single_shift(imm2, &scale)) {
++			cache_checkinstr((scale)?6:4);
++			cache_addw( MOV_IMM(templo1, imm2 >> scale) );      // mov templo1, #(~imm >> scale)
++			if (scale) {
++				cache_addw( LSL_IMM(templo1, templo1, scale) );      // lsl templo1, templo1, #scale
++			}
++			cache_addw( ADD_REG(templo3, templo3, templo1) );      // add templo3, templo3, templo1
++		} else {
++			gen_mov_dword_to_reg_imm(templo1, imm);
++			cache_checkinstr(2);
++			cache_addw( SUB_REG(templo3, templo3, templo1) );      // sub templo3, templo3, templo1
++		}
+ 	}
+-	cache_checkinstr(2);
+-	cache_addw( SUB_REG(templo3, templo3, templo1) );      // sub templo3, templo3, templo1
+-	gen_mov_word_from_reg_helper(templo3, dest, dword, templo2);
++
++	if (!gen_mov_memval_from_reg(templo3, dest, (dword)?4:2)) {
++		gen_mov_word_from_reg_helper(templo3, dest, dword, templo2);
++	}
++}
++
++// subtract an 8bit constant value from a dword memory value
++static void gen_sub_direct_byte(void* dest,Bit8s imm) {
++	gen_sub_direct_word(dest, (Bit32s)imm, 1);
+ }
+ 
+ // effective address calculation, destination is dest_reg
+@@ -697,20 +898,22 @@
+ static void gen_jmp_ptr(void * ptr,Bits imm=0) {
+ 	gen_mov_word_to_reg(templo3, ptr, 1);
+ 
+-	if (imm) {
+-		gen_mov_dword_to_reg_imm(templo2, imm);
+-		cache_checkinstr(2);
+-		cache_addw( ADD_REG(templo3, templo3, templo2) );      // add templo3, templo3, templo2
+-	}
+-
+-#if (1)
+-// (*ptr) should be word aligned 
++#if !defined(C_UNALIGNED_MEMORY)
++// (*ptr) should be word aligned
+ 	if ((imm & 0x03) == 0) {
+-		cache_checkinstr(6);
+-		cache_addw( LDR_IMM(templo2, templo3, 0) );      // ldr templo2, [templo3]
+-	} else
+ #endif
+-	{
++		if ((imm >= 0) && (imm < 128) && ((imm & 3) == 0)) {
++			cache_checkinstr(6);
++			cache_addw( LDR_IMM(templo2, templo3, imm) );      // ldr templo2, [templo3, #imm]
++		} else {
++			gen_mov_dword_to_reg_imm(templo2, imm);
++			cache_checkinstr(6);
++			cache_addw( LDR_REG(templo2, templo3, templo2) );      // ldr templo2, [templo3, templo2]
++		}
++#if !defined(C_UNALIGNED_MEMORY)
++	} else {
++		gen_add_imm(templo3, imm);
++
+ 		cache_checkinstr(24);
+ 		cache_addw( LDRB_IMM(templo2, templo3, 0) );      // ldrb templo2, [templo3]
+ 		cache_addw( LDRB_IMM(templo1, templo3, 1) );      // ldrb templo1, [templo3, #1]
+@@ -723,6 +926,7 @@
+ 		cache_addw( LSL_IMM(templo1, templo1, 24) );      // lsl templo1, templo1, #24
+ 		cache_addw( ORR(templo2, templo1) );      // orr templo2, templo1
+ 	}
++#endif
+ 
+ 	// increase jmp address to keep thumb state
+ 	cache_addw( ADD_IMM3(templo2, templo2, 1) );      // add templo2, templo2, #1
+@@ -818,50 +1022,53 @@
+ }
+ 
+ static void gen_run_code(void) {
+-	// switch from arm to thumb state
+-	cache_addd(0xe2800000 + (HOST_r3 << 12) + (HOST_pc << 16) + (1));      // add r3, pc, #1
+-	cache_addd(0xe12fff10 + (HOST_r3));      // bx r3
++	Bit8u *pos1, *pos2, *pos3;
+ 
+-	// thumb state from now on
+-	cache_addw(0xb500);      // push {lr}
+-	cache_addw( MOV_LO_HI(HOST_r3, FC_SEGS_ADDR) );      // mov r3, FC_SEGS_ADDR
+-	cache_addw( MOV_LO_HI(HOST_r2, FC_REGS_ADDR) );      // mov r2, FC_REGS_ADDR
+-	cache_addw(0xb4fc);      // push {r2,r3,v1-v4}
+-
+-	// adr: 16
+-	cache_addw( LDR_PC_IMM(HOST_r3, 64 - (16 + 4)) );        // ldr r3, [pc, #(&Segs)]
+-	// adr: 18
+-	cache_addw( LDR_PC_IMM(HOST_r2, 68 - (18 + 2)) );        // ldr r2, [pc, #(&cpu_regs)]
+-	cache_addw( MOV_HI_LO(FC_SEGS_ADDR, HOST_r3) );      // mov FC_SEGS_ADDR, r3
+-	cache_addw( MOV_HI_LO(FC_REGS_ADDR, HOST_r2) );      // mov FC_REGS_ADDR, r2
+-
+-	// align 4
+-	cache_addw( ADD_LO_PC_IMM(HOST_r3, 8) );      // add r3, pc, #8
+-	cache_addw( ADD_IMM8(HOST_r0, 1) );      // add r0, #1
+-	cache_addw( ADD_IMM8(HOST_r3, 1) );      // add r3, #1
+-	cache_addw(0xb408);      // push {r3}
+-	cache_addw( BX(HOST_r0) );      // bx r0
+-	cache_addw( NOP );      // nop
+-
+-	// align 4
+-	cache_addw(0xbcfc);      // pop {r2,r3,v1-v4}
+-	cache_addw( MOV_HI_LO(FC_SEGS_ADDR, HOST_r3) );      // mov FC_SEGS_ADDR, r3
+-	cache_addw( MOV_HI_LO(FC_REGS_ADDR, HOST_r2) );      // mov FC_REGS_ADDR, r2
+-
+-	cache_addw(0xbc08);      // pop {r3}
+-	cache_addw( BX(HOST_r3) );      // bx r3
+-
+-	// fill up to 64 bytes
+-	cache_addw( NOP );      // nop
+-	cache_addd( NOP | (NOP << 16) );  // nop, nop
+-	cache_addd( NOP | (NOP << 16) );  // nop, nop
+-	cache_addd( NOP | (NOP << 16) );  // nop, nop
+-	cache_addd( NOP | (NOP << 16) );  // nop, nop
++#if (__ARM_EABI__)
++	// 8-byte stack alignment
++	cache_addd(0xe92d4ff0);			// stmfd sp!, {v1-v8,lr}
++#else
++	cache_addd(0xe92d4df0);			// stmfd sp!, {v1-v5,v7,v8,lr}
++#endif
++
++	cache_addd( ARM_ADD_IMM(HOST_r0, HOST_r0, 1, 0) );      // add r0, r0, #1
+ 
+-	// adr: 64
++	pos1 = cache.pos;
++	cache_addd( 0 );
++	pos2 = cache.pos;
++	cache_addd( 0 );
++	pos3 = cache.pos;
++	cache_addd( 0 );
++
++	cache_addd( ARM_ADD_IMM(HOST_lr, HOST_pc, 4, 0) );			// add lr, pc, #4
++	cache_addd( ARM_STR_IMM_M_W(HOST_lr, HOST_sp, 4) );      // str lr, [sp, #-4]!
++	cache_addd( ARM_BX(HOST_r0) );			// bx r0
++
++#if (__ARM_EABI__)
++	cache_addd(0xe8bd4ff0);			// ldmfd sp!, {v1-v8,lr}
++#else
++	cache_addd(0xe8bd4df0);			// ldmfd sp!, {v1-v5,v7,v8,lr}
++#endif
++	cache_addd( ARM_BX(HOST_lr) );			// bx lr
++
++	// align cache.pos to 32 bytes
++	if ((((Bitu)cache.pos) & 0x1f) != 0) {
++		cache.pos = cache.pos + (32 - (((Bitu)cache.pos) & 0x1f));
++	}
++
++	*(Bit32u*)pos1 = ARM_LDR_IMM(FC_SEGS_ADDR, HOST_pc, cache.pos - (pos1 + 8));      // ldr FC_SEGS_ADDR, [pc, #(&Segs)]
+ 	cache_addd((Bit32u)&Segs);      // address of "Segs"
+-	// adr: 68
++
++	*(Bit32u*)pos2 = ARM_LDR_IMM(FC_REGS_ADDR, HOST_pc, cache.pos - (pos2 + 8));      // ldr FC_REGS_ADDR, [pc, #(&cpu_regs)]
+ 	cache_addd((Bit32u)&cpu_regs);  // address of "cpu_regs"
++
++	*(Bit32u*)pos3 = ARM_LDR_IMM(readdata_addr, HOST_pc, cache.pos - (pos3 + 8));      // ldr readdata_addr, [pc, #(&core_dynrec.readdata)]
++	cache_addd((Bit32u)&core_dynrec.readdata);  // address of "core_dynrec.readdata"
++
++	// align cache.pos to 32 bytes
++	if ((((Bitu)cache.pos) & 0x1f) != 0) {
++		cache.pos = cache.pos + (32 - (((Bitu)cache.pos) & 0x1f));
++	}
+ }
+ 
+ // return from a function
+diff -Nur dosbox-0.74/src/cpu/core_dynrec/risc_mipsel32.h dosbox/src/cpu/core_dynrec/risc_mipsel32.h
+--- dosbox-0.74/src/cpu/core_dynrec/risc_mipsel32.h	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/cpu/core_dynrec/risc_mipsel32.h	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,7 +16,6 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: risc_mipsel32.h,v 1.6 2009-06-25 19:31:43 c2woody Exp $ */
+ 
+ 
+ /* MIPS32 (little endian) backend by crazyc */
+diff -Nur dosbox-0.74/src/cpu/core_dynrec/risc_x64.h dosbox/src/cpu/core_dynrec/risc_x64.h
+--- dosbox-0.74/src/cpu/core_dynrec/risc_x64.h	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/cpu/core_dynrec/risc_x64.h	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,7 +16,6 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: risc_x64.h,v 1.13 2009-06-25 19:31:43 c2woody Exp $ */
+ 
+ 
+ // some configuring defines that specify the capabilities of this architecture
+@@ -84,7 +83,7 @@
+ }
+ 
+ 
+-static INLINE void gen_memaddr(HostReg reg,void* data) {
++static INLINE void gen_reg_memaddr(HostReg reg,void* data) {
+ 	Bit64s diff = (Bit64s)data-((Bit64s)cache.pos+5);
+ 	if ((diff<0x80000000LL) && (diff>-0x80000000LL)) {
+ 		cache_addb(0x05+(reg<<3));
+@@ -98,13 +97,28 @@
+ 	}
+ }
+ 
++static INLINE void gen_memaddr(Bitu op,void* data,Bitu off) {
++	Bit64s diff;
++	diff = (Bit64s)data-((Bit64s)cache.pos+off+5);
++	if ((diff<0x80000000LL) && (diff>-0x80000000LL)) {
++		// RIP-relative addressing is offset after the instruction 
++		cache_addb(op+1);
++		cache_addd((Bit32u)(((Bit64u)diff)&0xffffffffLL)); 
++	} else if ((Bit64u)data<0x100000000LL) {
++		cache_addb(op);
++		cache_addb(0x25);
++		cache_addd((Bit32u)(((Bit64u)data)&0xffffffffLL));
++	} else {
++		E_Exit("DRC64:Unhandled memory reference");
++	}
++}
+ 
+ // move a 32bit (dword==true) or 16bit (dword==false) value from memory into dest_reg
+ // 16bit moves may destroy the upper 16bit of the destination register
+ static void gen_mov_word_to_reg(HostReg dest_reg,void* data,bool dword) {
+ 	if (!dword) cache_addb(0x66);
+ 	cache_addb(0x8b); // mov reg,[data]
+-	gen_memaddr(dest_reg,data);
++	gen_reg_memaddr(dest_reg,data);
+ } 
+ 
+ // move a 16bit constant value into dest_reg
+@@ -125,7 +139,7 @@
+ static void gen_mov_word_from_reg(HostReg src_reg,void* dest,bool dword) {
+ 	if (!dword) cache_addb(0x66);
+ 	cache_addb(0x89);	// mov [data],reg
+-	gen_memaddr(src_reg,dest);
++	gen_reg_memaddr(src_reg,dest);
+ }
+ 
+ // move an 8bit value from memory into dest_reg
+@@ -134,7 +148,7 @@
+ // registers might not be directly byte-accessible on some architectures
+ static void gen_mov_byte_to_reg_low(HostReg dest_reg,void* data) {
+ 	cache_addb(0x8a);	// mov reg,[data]
+-	gen_memaddr(dest_reg,data);
++	gen_reg_memaddr(dest_reg,data);
+ }
+ 
+ // move an 8bit value from memory into dest_reg
+@@ -144,7 +158,7 @@
+ static void gen_mov_byte_to_reg_low_canuseword(HostReg dest_reg,void* data) {
+ 	cache_addb(0x66);
+ 	cache_addb(0x8b);	// mov reg,[data]
+-	gen_memaddr(dest_reg,data);
++	gen_reg_memaddr(dest_reg,data);
+ }
+ 
+ // move an 8bit constant value into dest_reg
+@@ -169,7 +183,7 @@
+ // move the lowest 8bit of a register into memory
+ static void gen_mov_byte_from_reg_low(HostReg src_reg,void* dest) {
+ 	cache_addb(0x88);	// mov [data],reg
+-	gen_memaddr(src_reg,dest);
++	gen_reg_memaddr(src_reg,dest);
+ }
+ 
+ 
+@@ -193,7 +207,7 @@
+ // add a 32bit value from memory to a full register
+ static void gen_add(HostReg reg,void* op) {
+ 	cache_addb(0x03);					// add reg,[data]
+-	gen_memaddr(reg,op);
++	gen_reg_memaddr(reg,op);
+ }
+ 
+ // add a 32bit constant value to a full register
+@@ -212,9 +226,8 @@
+ 
+ // move a 32bit constant value into memory
+ static void gen_mov_direct_dword(void* dest,Bit32u imm) {
+-	cache_addw(0x04c7);					// mov [data],imm
+-	cache_addb(0x25);
+-	cache_addd((Bit32u)(((Bit64u)dest)&0xffffffffLL));
++	cache_addb(0xc7);					// mov [data],imm
++	gen_memaddr(0x04,dest,4);
+ 	cache_addd(imm);
+ }
+ 
+@@ -235,9 +248,8 @@
+ 
+ // add an 8bit constant value to a memory value
+ static void gen_add_direct_byte(void* dest,Bit8s imm) {
+-	cache_addw(0x0483);					// add [data],imm
+-	cache_addb(0x25);
+-	cache_addd((Bit32u)(((Bit64u)dest)&0xffffffffLL));
++	cache_addb(0x83);					// add [data],imm
++	gen_memaddr(0x4,dest,1);
+ 	cache_addb(imm);
+ }
+ 
+@@ -248,18 +260,20 @@
+ 		return;
+ 	}
+ 	if (!dword) cache_addb(0x66);
+-	cache_addw(0x0481);					// add [data],imm
+-	cache_addb(0x25);
+-	cache_addd((Bit32u)(((Bit64u)dest)&0xffffffffLL));
+-	if (dword) cache_addd((Bit32u)imm);
+-	else cache_addw((Bit16u)imm);
++	cache_addb(0x81);					// add [data],imm
++	if (dword) {
++		gen_memaddr(0x4,dest,4);		// size of following immediate value
++		cache_addd((Bit32u)imm);
++	} else {
++		gen_memaddr(0x4,dest,2);		// size of following immediate value
++		cache_addw((Bit16u)imm);
++	}
+ }
+ 
+ // subtract an 8bit constant value from a memory value
+ static void gen_sub_direct_byte(void* dest,Bit8s imm) {
+-	cache_addw(0x2c83);					// sub [data],imm
+-	cache_addb(0x25);
+-	cache_addd((Bit32u)(((Bit64u)dest)&0xffffffffLL));
++	cache_addb(0x83);					// sub [data],imm
++	gen_memaddr(0x2c,dest,1);
+ 	cache_addb(imm);
+ }
+ 
+@@ -270,11 +284,14 @@
+ 		return;
+ 	}
+ 	if (!dword) cache_addb(0x66);
+-	cache_addw(0x2c81);					// sub [data],imm
+-	cache_addb(0x25);
+-	cache_addd((Bit32u)(((Bit64u)dest)&0xffffffffLL));
+-	if (dword) cache_addd((Bit32u)imm);
+-	else cache_addw((Bit16u)imm);
++	cache_addw(0x81);					// sub [data],imm
++	if (dword) {
++		gen_memaddr(0x2c,dest,4);		// size of following immediate value
++		cache_addd((Bit32u)imm);
++	} else {
++		gen_memaddr(0x2c,dest,2);		// size of following immediate value
++		cache_addw((Bit16u)imm);
++	}
+ }
+ 
+ 
+@@ -324,10 +341,18 @@
+ 
+ // generate a call to a parameterless function
+ static void INLINE gen_call_function_raw(void * func) {
++	cache_addb(0x48); 
++	cache_addw(0xec83); 
++	cache_addb(0x08);	// sub rsp,0x08 (align stack to 16 byte boundary)
++
+ 	cache_addb(0x48);
+ 	cache_addb(0xb8);	// mov reg,imm64
+ 	cache_addq((Bit64u)func);
+ 	cache_addw(0xd0ff);
++
++	cache_addb(0x48); 
++	cache_addw(0xc483); 
++	cache_addb(0x08);	// add rsp,0x08 (reset alignment)
+ }
+ 
+ // generate a call to a function with paramcount parameters
+@@ -350,9 +375,13 @@
+ 	cache_addw(0xc483);		// add rsp,0x08
+ 	cache_addb(0x08);
+ 
++	// stack is 16 byte aligned now
++
++
+ 	cache_addb(0x50);		// push rax (==old rsp)
+ 
+-	Bit64u proc_addr=(Bit64u)cache.pos;
++	// returned address relates to where the address is stored in gen_call_function_raw
++	Bit64u proc_addr=(Bit64u)cache.pos-4;
+ 
+ 	// Do the actual call to the procedure
+ 	cache_addb(0x48);
+@@ -596,6 +625,8 @@
+ #ifdef DRC_FLAGS_INVALIDATION
+ // called when a call to a function can be replaced by a
+ // call to a simpler function
++// check gen_call_function_raw and gen_call_function_setup
++// for the targeted code
+ static void gen_fill_function_ptr(Bit8u * pos,void* fct_ptr,Bitu flags_type) {
+ #ifdef DRC_FLAGS_INVALIDATION_DCODE
+ 	// try to avoid function calls but rather directly fill in code
+@@ -604,36 +635,46 @@
+ 		case t_ADDw:
+ 		case t_ADDd:
+ 			*(Bit32u*)(pos+0)=0xf001f889;	// mov eax,edi; add eax,esi
+-			*(Bit32u*)(pos+4)=0x909006eb;	// skip
++			*(Bit32u*)(pos+4)=0x90900eeb;	// skip
+ 			*(Bit32u*)(pos+8)=0x90909090;
++			*(Bit32u*)(pos+12)=0x90909090;
++			*(Bit32u*)(pos+16)=0x90909090;
+ 			break;
+ 		case t_ORb:
+ 		case t_ORw:
+ 		case t_ORd:
+ 			*(Bit32u*)(pos+0)=0xf009f889;	// mov eax,edi; or eax,esi
+-			*(Bit32u*)(pos+4)=0x909006eb;	// skip
++			*(Bit32u*)(pos+4)=0x90900eeb;	// skip
+ 			*(Bit32u*)(pos+8)=0x90909090;
++			*(Bit32u*)(pos+12)=0x90909090;
++			*(Bit32u*)(pos+16)=0x90909090;
+ 			break;
+ 		case t_ANDb:
+ 		case t_ANDw:
+ 		case t_ANDd:
+ 			*(Bit32u*)(pos+0)=0xf021f889;	// mov eax,edi; and eax,esi
+-			*(Bit32u*)(pos+4)=0x909006eb;	// skip
++			*(Bit32u*)(pos+4)=0x90900eeb;	// skip
+ 			*(Bit32u*)(pos+8)=0x90909090;
++			*(Bit32u*)(pos+12)=0x90909090;
++			*(Bit32u*)(pos+16)=0x90909090;
+ 			break;
+ 		case t_SUBb:
+ 		case t_SUBw:
+ 		case t_SUBd:
+ 			*(Bit32u*)(pos+0)=0xf029f889;	// mov eax,edi; sub eax,esi
+-			*(Bit32u*)(pos+4)=0x909006eb;	// skip
++			*(Bit32u*)(pos+4)=0x90900eeb;	// skip
+ 			*(Bit32u*)(pos+8)=0x90909090;
++			*(Bit32u*)(pos+12)=0x90909090;
++			*(Bit32u*)(pos+16)=0x90909090;
+ 			break;
+ 		case t_XORb:
+ 		case t_XORw:
+ 		case t_XORd:
+ 			*(Bit32u*)(pos+0)=0xf031f889;	// mov eax,edi; xor eax,esi
+-			*(Bit32u*)(pos+4)=0x909006eb;	// skip
++			*(Bit32u*)(pos+4)=0x90900eeb;	// skip
+ 			*(Bit32u*)(pos+8)=0x90909090;
++			*(Bit32u*)(pos+12)=0x90909090;
++			*(Bit32u*)(pos+16)=0x90909090;
+ 			break;
+ 		case t_CMPb:
+ 		case t_CMPw:
+@@ -641,37 +682,45 @@
+ 		case t_TESTb:
+ 		case t_TESTw:
+ 		case t_TESTd:
+-			*(Bit32u*)(pos+0)=0x90900aeb;	// skip
++			*(Bit32u*)(pos+0)=0x909012eb;	// skip
+ 			*(Bit32u*)(pos+4)=0x90909090;
+ 			*(Bit32u*)(pos+8)=0x90909090;
++			*(Bit32u*)(pos+12)=0x90909090;
++			*(Bit32u*)(pos+16)=0x90909090;
+ 			break;
+ 		case t_INCb:
+ 		case t_INCw:
+ 		case t_INCd:
+ 			*(Bit32u*)(pos+0)=0xc0fff889;	// mov eax,edi; inc eax
+-			*(Bit32u*)(pos+4)=0x909006eb;	// skip
++			*(Bit32u*)(pos+4)=0x90900eeb;	// skip
+ 			*(Bit32u*)(pos+8)=0x90909090;
++			*(Bit32u*)(pos+12)=0x90909090;
++			*(Bit32u*)(pos+16)=0x90909090;
+ 			break;
+ 		case t_DECb:
+ 		case t_DECw:
+ 		case t_DECd:
+ 			*(Bit32u*)(pos+0)=0xc8fff889;	// mov eax,edi; dec eax
+-			*(Bit32u*)(pos+4)=0x909006eb;	// skip
++			*(Bit32u*)(pos+4)=0x90900eeb;	// skip
+ 			*(Bit32u*)(pos+8)=0x90909090;
++			*(Bit32u*)(pos+12)=0x90909090;
++			*(Bit32u*)(pos+16)=0x90909090;
+ 			break;
+ 		case t_NEGb:
+ 		case t_NEGw:
+ 		case t_NEGd:
+ 			*(Bit32u*)(pos+0)=0xd8f7f889;	// mov eax,edi; neg eax
+-			*(Bit32u*)(pos+4)=0x909006eb;	// skip
++			*(Bit32u*)(pos+4)=0x90900eeb;	// skip
+ 			*(Bit32u*)(pos+8)=0x90909090;
++			*(Bit32u*)(pos+12)=0x90909090;
++			*(Bit32u*)(pos+16)=0x90909090;
+ 			break;
+ 		default:
+-			*(Bit64u*)(pos+2)=(Bit64u)fct_ptr;		// fill function pointer
++			*(Bit64u*)(pos+6)=(Bit64u)fct_ptr;		// fill function pointer
+ 			break;
+ 	}
+ #else
+-	*(Bit64u*)(pos+2)=(Bit64u)fct_ptr;
++	*(Bit64u*)(pos+6)=(Bit64u)fct_ptr;		// fill function pointer
+ #endif
+ }
+ #endif
+diff -Nur dosbox-0.74/src/cpu/core_dynrec/risc_x86.h dosbox/src/cpu/core_dynrec/risc_x86.h
+--- dosbox-0.74/src/cpu/core_dynrec/risc_x86.h	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/cpu/core_dynrec/risc_x86.h	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,7 +16,6 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: risc_x86.h,v 1.10 2009-06-25 19:31:43 c2woody Exp $ */
+ 
+ 
+ // some configuring defines that specify the capabilities of this architecture
+diff -Nur dosbox-0.74/src/cpu/core_dynrec.cpp dosbox/src/cpu/core_dynrec.cpp
+--- dosbox-0.74/src/cpu/core_dynrec.cpp	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/cpu/core_dynrec.cpp	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,7 +16,6 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: core_dynrec.cpp,v 1.15 2009-08-02 16:52:33 c2woody Exp $ */
+ 
+ #include "dosbox.h"
+ 
+@@ -62,11 +61,9 @@
+ #define DYN_PAGE_HASH	(4096>>DYN_HASH_SHIFT)
+ #define DYN_LINKS		(16)
+ 
+-#if 0
+-#define DYN_LOG	LOG_MSG
+-#else 
+-#define DYN_LOG
+-#endif
++
++//#define DYN_LOG 1 //Turn Logging on.
++
+ 
+ #if C_FPU
+ #define CPU_FPU 1                                               //Enable FPU escape instructions
+@@ -140,6 +137,7 @@
+ #define X86_64		0x02
+ #define MIPSEL		0x03
+ #define ARMV4LE		0x04
++#define ARMV7LE		0x05
+ #define POWERPC		0x04
+ 
+ #if C_TARGETCPU == X86_64
+@@ -148,7 +146,7 @@
+ #include "core_dynrec/risc_x86.h"
+ #elif C_TARGETCPU == MIPSEL
+ #include "core_dynrec/risc_mipsel32.h"
+-#elif C_TARGETCPU == ARMV4LE
++#elif (C_TARGETCPU == ARMV4LE) || (C_TARGETCPU == ARMV7LE)
+ #include "core_dynrec/risc_armv4le.h"
+ #elif C_TARGETCPU == POWERPC
+ #include "core_dynrec/risc_ppc.h"
+@@ -166,7 +164,7 @@
+ 		block=temp_handler->FindCacheBlock(temp_ip & 4095);
+ 		if (!block) return NULL;
+ 
+-		// found it, link the current block to 
++		// found it, link the current block to
+ 		cache.block.running->LinkTo(ret==BR_Link2,block);
+ 		return block;
+ 	}
+@@ -222,7 +220,7 @@
+ 					continue;
+ 				}
+ 				CPU_CycleLeft+=old_cycles;
+-				return nc_retcode; 
++				return nc_retcode;
+ 			}
+ 		}
+ 
+@@ -249,7 +247,7 @@
+ 			// the block was exited due to a non-predictable control flow
+ 			// modifying instruction (like ret) or some nontrivial cpu state
+ 			// changing instruction (for example switch to/from pmode),
+-			// or the maximal number of instructions to translate was reached
++			// or the maximum number of instructions to translate was reached
+ #if C_HEAVY_DEBUG
+ 			if (DEBUG_HeavyIsBreakpoint()) return debugCallback;
+ #endif
+@@ -258,7 +256,7 @@
+ 		case BR_Cycles:
+ 			// cycles went negative, return from the core to handle
+ 			// external events, schedule the pic...
+-#if C_HEAVY_DEBUG			
++#if C_HEAVY_DEBUG
+ 			if (DEBUG_HeavyIsBreakpoint()) return debugCallback;
+ #endif
+ 			return CBRET_NONE;
+diff -Nur dosbox-0.74/src/cpu/core_dyn_x86/cache.h dosbox/src/cpu/core_dyn_x86/cache.h
+--- dosbox-0.74/src/cpu/core_dyn_x86/cache.h	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/cpu/core_dyn_x86/cache.h	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,7 +16,6 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: cache.h,v 1.20 2009-07-12 20:13:05 c2woody Exp $ */
+ 
+ class CacheBlock {
+ public:
+@@ -570,3 +569,75 @@
+ 	cache_code_link_blocks = NULL;
+ 	cache_initialized = false; */
+ }
++
++static void cache_reset(void) {
++	if (cache_initialized) {
++		for (;;) {
++			if (cache.used_pages) {
++				CodePageHandler * cpage=cache.used_pages;
++				CodePageHandler * npage=cache.used_pages->next;
++				cpage->ClearRelease();
++				delete cpage;
++				cache.used_pages=npage;
++			} else break;
++		}
++
++		if (cache_blocks == NULL) {
++			cache_blocks=(CacheBlock*)malloc(CACHE_BLOCKS*sizeof(CacheBlock));
++			if(!cache_blocks) E_Exit("Allocating cache_blocks has failed");
++		}
++		memset(cache_blocks,0,sizeof(CacheBlock)*CACHE_BLOCKS);
++		cache.block.free=&cache_blocks[0];
++		for (Bits i=0;i<CACHE_BLOCKS-1;i++) {
++			cache_blocks[i].link[0].to=(CacheBlock *)1;
++			cache_blocks[i].link[1].to=(CacheBlock *)1;
++			cache_blocks[i].cache.next=&cache_blocks[i+1];
++		}
++
++		if (cache_code_start_ptr==NULL) {
++#if defined (WIN32)
++			cache_code_start_ptr=(Bit8u*)VirtualAlloc(0,CACHE_TOTAL+CACHE_MAXSIZE+PAGESIZE_TEMP-1+PAGESIZE_TEMP,
++				MEM_COMMIT,PAGE_EXECUTE_READWRITE);
++			if (!cache_code_start_ptr)
++				cache_code_start_ptr=(Bit8u*)malloc(CACHE_TOTAL+CACHE_MAXSIZE+PAGESIZE_TEMP-1+PAGESIZE_TEMP);
++#else
++			cache_code_start_ptr=(Bit8u*)malloc(CACHE_TOTAL+CACHE_MAXSIZE+PAGESIZE_TEMP-1+PAGESIZE_TEMP);
++#endif
++			if (!cache_code_start_ptr) E_Exit("Allocating dynamic core cache memory failed");
++
++			cache_code=(Bit8u*)(((int)cache_code_start_ptr + PAGESIZE_TEMP-1) & ~(PAGESIZE_TEMP-1)); //MEM LEAK. store old pointer if you want to free it.
++
++			cache_code_link_blocks=cache_code;
++			cache_code+=PAGESIZE_TEMP;
++
++#if (C_HAVE_MPROTECT)
++			if(mprotect(cache_code_link_blocks,CACHE_TOTAL+CACHE_MAXSIZE+PAGESIZE_TEMP,PROT_WRITE|PROT_READ|PROT_EXEC))
++				LOG_MSG("Setting excute permission on the code cache has failed!");
++#endif
++		}
++
++		CacheBlock * block=cache_getblock();
++		cache.block.first=block;
++		cache.block.active=block;
++		block->cache.start=&cache_code[0];
++		block->cache.size=CACHE_TOTAL;
++		block->cache.next=0;								//Last block in the list
++
++		/* Setup the default blocks for block linkage returns */
++		cache.pos=&cache_code_link_blocks[0];
++		link_blocks[0].cache.start=cache.pos;
++		gen_return(BR_Link1);
++		cache.pos=&cache_code_link_blocks[32];
++		link_blocks[1].cache.start=cache.pos;
++		gen_return(BR_Link2);
++		cache.free_pages=0;
++		cache.last_page=0;
++		cache.used_pages=0;
++		/* Setup the code pages */
++		for (Bitu i=0;i<CACHE_PAGES;i++) {
++			CodePageHandler * newpage=new CodePageHandler();
++			newpage->next=cache.free_pages;
++			cache.free_pages=newpage;
++		}
++	}
++}
+diff -Nur dosbox-0.74/src/cpu/core_dyn_x86/decoder.h dosbox/src/cpu/core_dyn_x86/decoder.h
+--- dosbox-0.74/src/cpu/core_dyn_x86/decoder.h	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/cpu/core_dyn_x86/decoder.h	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,7 +16,6 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: decoder.h,v 1.59 2009-10-18 17:52:09 c2woody Exp $ */
+ 
+ #define X86_DYNFPU_DH_ENABLED
+ #define X86_INLINED_MEMACCESS
+@@ -2104,7 +2103,9 @@
+ 			case 0xbf:dyn_mov_ev_gw(true);break;
+ 
+ 			default:
+-				DYN_LOG("Unhandled dual opcode 0F%02X",dual_code);
++#if DYN_LOG
++				LOG_MSG("Unhandled dual opcode 0F%02X",dual_code);
++#endif
+ 				goto illegalopcode;
+ 			}
+ 		}break;
+@@ -2670,11 +2671,13 @@
+ 			}}
+ 			break;
+ 		default:
+-//			DYN_LOG("Dynamic unhandled opcode %X",opcode);
++#if DYN_LOG
++//			LOG_MSG("Dynamic unhandled opcode %X",opcode);
++#endif
+ 			goto illegalopcode;
+ 		}
+ 	}
+-	// link to next block because the maximal number of opcodes has been reached
++	// link to next block because the maximum number of opcodes has been reached
+ 	dyn_set_eip_end();
+ 	dyn_reduce_cycles();
+ 	dyn_save_critical_regs();
+diff -Nur dosbox-0.74/src/cpu/core_dyn_x86/dyn_fpu_dh.h dosbox/src/cpu/core_dyn_x86/dyn_fpu_dh.h
+--- dosbox-0.74/src/cpu/core_dyn_x86/dyn_fpu_dh.h	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/cpu/core_dyn_x86/dyn_fpu_dh.h	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,7 +16,6 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: dyn_fpu_dh.h,v 1.7 2009-09-23 20:55:19 c2woody Exp $ */
+ 
+ #include "dosbox.h"
+ #if C_FPU
+diff -Nur dosbox-0.74/src/cpu/core_dyn_x86/dyn_fpu.h dosbox/src/cpu/core_dyn_x86/dyn_fpu.h
+--- dosbox-0.74/src/cpu/core_dyn_x86/dyn_fpu.h	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/cpu/core_dyn_x86/dyn_fpu.h	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,7 +16,6 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: dyn_fpu.h,v 1.5 2009-09-23 20:55:19 c2woody Exp $ */
+ 
+ #include "dosbox.h"
+ #if C_FPU
+diff -Nur dosbox-0.74/src/cpu/core_dyn_x86/helpers.h dosbox/src/cpu/core_dyn_x86/helpers.h
+--- dosbox-0.74/src/cpu/core_dyn_x86/helpers.h	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/cpu/core_dyn_x86/helpers.h	2014-01-12 14:43:47.000000000 +0100
+@@ -1,3 +1,21 @@
++/*
++ *  Copyright (C) 2002-2013  The DOSBox Team
++ *
++ *  This program is free software; you can redistribute it and/or modify
++ *  it under the terms of the GNU General Public License as published by
++ *  the Free Software Foundation; either version 2 of the License, or
++ *  (at your option) any later version.
++ *
++ *  This program is distributed in the hope that it will be useful,
++ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
++ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
++ *  GNU General Public License for more details.
++ *
++ *  You should have received a copy of the GNU General Public License
++ *  along with this program; if not, write to the Free Software
++ *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
++ */
++
+ static bool dyn_helper_divb(Bit8u val) {
+ 	if (!val) return CPU_PrepareException(0,0);
+ 	Bitu quo=reg_ax / val;
+diff -Nur dosbox-0.74/src/cpu/core_dyn_x86/Makefile.in dosbox/src/cpu/core_dyn_x86/Makefile.in
+--- dosbox-0.74/src/cpu/core_dyn_x86/Makefile.in	2010-05-12 11:57:43.000000000 +0200
++++ dosbox/src/cpu/core_dyn_x86/Makefile.in	1970-01-01 01:00:00.000000000 +0100
+@@ -1,390 +0,0 @@
+-# Makefile.in generated by automake 1.11.1 from Makefile.am.
+-# @configure_input@
+-
+-# Copyright (C) 1994, 1995, 1996, 1997, 1998, 1999, 2000, 2001, 2002,
+-# 2003, 2004, 2005, 2006, 2007, 2008, 2009  Free Software Foundation,
+-# Inc.
+-# This Makefile.in is free software; the Free Software Foundation
+-# gives unlimited permission to copy and/or distribute it,
+-# with or without modifications, as long as this notice is preserved.
+-
+-# This program is distributed in the hope that it will be useful,
+-# but WITHOUT ANY WARRANTY, to the extent permitted by law; without
+-# even the implied warranty of MERCHANTABILITY or FITNESS FOR A
+-# PARTICULAR PURPOSE.
+-
+-@SET_MAKE@
+-
+-VPATH = @srcdir@
+-pkgdatadir = $(datadir)/@PACKAGE@
+-pkgincludedir = $(includedir)/@PACKAGE@
+-pkglibdir = $(libdir)/@PACKAGE@
+-pkglibexecdir = $(libexecdir)/@PACKAGE@
+-am__cd = CDPATH="$${ZSH_VERSION+.}$(PATH_SEPARATOR)" && cd
+-install_sh_DATA = $(install_sh) -c -m 644
+-install_sh_PROGRAM = $(install_sh) -c
+-install_sh_SCRIPT = $(install_sh) -c
+-INSTALL_HEADER = $(INSTALL_DATA)
+-transform = $(program_transform_name)
+-NORMAL_INSTALL = :
+-PRE_INSTALL = :
+-POST_INSTALL = :
+-NORMAL_UNINSTALL = :
+-PRE_UNINSTALL = :
+-POST_UNINSTALL = :
+-build_triplet = @build@
+-host_triplet = @host@
+-subdir = src/cpu/core_dyn_x86
+-DIST_COMMON = $(noinst_HEADERS) $(srcdir)/Makefile.am \
+-	$(srcdir)/Makefile.in
+-ACLOCAL_M4 = $(top_srcdir)/aclocal.m4
+-am__aclocal_m4_deps = $(top_srcdir)/acinclude.m4 \
+-	$(top_srcdir)/configure.in
+-am__configure_deps = $(am__aclocal_m4_deps) $(CONFIGURE_DEPENDENCIES) \
+-	$(ACLOCAL_M4)
+-mkinstalldirs = $(install_sh) -d
+-CONFIG_HEADER = $(top_builddir)/config.h
+-CONFIG_CLEAN_FILES =
+-CONFIG_CLEAN_VPATH_FILES =
+-SOURCES =
+-DIST_SOURCES =
+-HEADERS = $(noinst_HEADERS)
+-ETAGS = etags
+-CTAGS = ctags
+-DISTFILES = $(DIST_COMMON) $(DIST_SOURCES) $(TEXINFOS) $(EXTRA_DIST)
+-ACLOCAL = @ACLOCAL@
+-ALSA_CFLAGS = @ALSA_CFLAGS@
+-ALSA_LIBS = @ALSA_LIBS@
+-AMTAR = @AMTAR@
+-AUTOCONF = @AUTOCONF@
+-AUTOHEADER = @AUTOHEADER@
+-AUTOMAKE = @AUTOMAKE@
+-AWK = @AWK@
+-CC = @CC@
+-CCDEPMODE = @CCDEPMODE@
+-CFLAGS = @CFLAGS@
+-CPP = @CPP@
+-CPPFLAGS = @CPPFLAGS@
+-CXX = @CXX@
+-CXXDEPMODE = @CXXDEPMODE@
+-CXXFLAGS = @CXXFLAGS@
+-CYGPATH_W = @CYGPATH_W@
+-DEFS = @DEFS@
+-DEPDIR = @DEPDIR@
+-ECHO_C = @ECHO_C@
+-ECHO_N = @ECHO_N@
+-ECHO_T = @ECHO_T@
+-EGREP = @EGREP@
+-EXEEXT = @EXEEXT@
+-GREP = @GREP@
+-INSTALL = @INSTALL@
+-INSTALL_DATA = @INSTALL_DATA@
+-INSTALL_PROGRAM = @INSTALL_PROGRAM@
+-INSTALL_SCRIPT = @INSTALL_SCRIPT@
+-INSTALL_STRIP_PROGRAM = @INSTALL_STRIP_PROGRAM@
+-LDFLAGS = @LDFLAGS@
+-LIBOBJS = @LIBOBJS@
+-LIBS = @LIBS@
+-LTLIBOBJS = @LTLIBOBJS@
+-MAKEINFO = @MAKEINFO@
+-MKDIR_P = @MKDIR_P@
+-OBJEXT = @OBJEXT@
+-PACKAGE = @PACKAGE@
+-PACKAGE_BUGREPORT = @PACKAGE_BUGREPORT@
+-PACKAGE_NAME = @PACKAGE_NAME@
+-PACKAGE_STRING = @PACKAGE_STRING@
+-PACKAGE_TARNAME = @PACKAGE_TARNAME@
+-PACKAGE_URL = @PACKAGE_URL@
+-PACKAGE_VERSION = @PACKAGE_VERSION@
+-PATH_SEPARATOR = @PATH_SEPARATOR@
+-RANLIB = @RANLIB@
+-SDL_CFLAGS = @SDL_CFLAGS@
+-SDL_CONFIG = @SDL_CONFIG@
+-SDL_LIBS = @SDL_LIBS@
+-SET_MAKE = @SET_MAKE@
+-SHELL = @SHELL@
+-STRIP = @STRIP@
+-VERSION = @VERSION@
+-WINDRES = @WINDRES@
+-abs_builddir = @abs_builddir@
+-abs_srcdir = @abs_srcdir@
+-abs_top_builddir = @abs_top_builddir@
+-abs_top_srcdir = @abs_top_srcdir@
+-ac_ct_CC = @ac_ct_CC@
+-ac_ct_CXX = @ac_ct_CXX@
+-am__include = @am__include@
+-am__leading_dot = @am__leading_dot@
+-am__quote = @am__quote@
+-am__tar = @am__tar@
+-am__untar = @am__untar@
+-bindir = @bindir@
+-build = @build@
+-build_alias = @build_alias@
+-build_cpu = @build_cpu@
+-build_os = @build_os@
+-build_vendor = @build_vendor@
+-builddir = @builddir@
+-datadir = @datadir@
+-datarootdir = @datarootdir@
+-docdir = @docdir@
+-dvidir = @dvidir@
+-exec_prefix = @exec_prefix@
+-host = @host@
+-host_alias = @host_alias@
+-host_cpu = @host_cpu@
+-host_os = @host_os@
+-host_vendor = @host_vendor@
+-htmldir = @htmldir@
+-includedir = @includedir@
+-infodir = @infodir@
+-install_sh = @install_sh@
+-libdir = @libdir@
+-libexecdir = @libexecdir@
+-localedir = @localedir@
+-localstatedir = @localstatedir@
+-mandir = @mandir@
+-mkdir_p = @mkdir_p@
+-oldincludedir = @oldincludedir@
+-pdfdir = @pdfdir@
+-prefix = @prefix@
+-program_transform_name = @program_transform_name@
+-psdir = @psdir@
+-sbindir = @sbindir@
+-sharedstatedir = @sharedstatedir@
+-srcdir = @srcdir@
+-sysconfdir = @sysconfdir@
+-target_alias = @target_alias@
+-top_build_prefix = @top_build_prefix@
+-top_builddir = @top_builddir@
+-top_srcdir = @top_srcdir@
+-noinst_HEADERS = cache.h helpers.h decoder.h risc_x86.h string.h \
+-                 dyn_fpu.h dyn_fpu_dh.h
+-
+-all: all-am
+-
+-.SUFFIXES:
+-$(srcdir)/Makefile.in:  $(srcdir)/Makefile.am  $(am__configure_deps)
+-	@for dep in $?; do \
+-	  case '$(am__configure_deps)' in \
+-	    *$$dep*) \
+-	      ( cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh ) \
+-	        && { if test -f $@; then exit 0; else break; fi; }; \
+-	      exit 1;; \
+-	  esac; \
+-	done; \
+-	echo ' cd $(top_srcdir) && $(AUTOMAKE) --gnu src/cpu/core_dyn_x86/Makefile'; \
+-	$(am__cd) $(top_srcdir) && \
+-	  $(AUTOMAKE) --gnu src/cpu/core_dyn_x86/Makefile
+-.PRECIOUS: Makefile
+-Makefile: $(srcdir)/Makefile.in $(top_builddir)/config.status
+-	@case '$?' in \
+-	  *config.status*) \
+-	    cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh;; \
+-	  *) \
+-	    echo ' cd $(top_builddir) && $(SHELL) ./config.status $(subdir)/$@ $(am__depfiles_maybe)'; \
+-	    cd $(top_builddir) && $(SHELL) ./config.status $(subdir)/$@ $(am__depfiles_maybe);; \
+-	esac;
+-
+-$(top_builddir)/config.status: $(top_srcdir)/configure $(CONFIG_STATUS_DEPENDENCIES)
+-	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
+-
+-$(top_srcdir)/configure:  $(am__configure_deps)
+-	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
+-$(ACLOCAL_M4):  $(am__aclocal_m4_deps)
+-	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
+-$(am__aclocal_m4_deps):
+-
+-ID: $(HEADERS) $(SOURCES) $(LISP) $(TAGS_FILES)
+-	list='$(SOURCES) $(HEADERS) $(LISP) $(TAGS_FILES)'; \
+-	unique=`for i in $$list; do \
+-	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
+-	  done | \
+-	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
+-	      END { if (nonempty) { for (i in files) print i; }; }'`; \
+-	mkid -fID $$unique
+-tags: TAGS
+-
+-TAGS:  $(HEADERS) $(SOURCES)  $(TAGS_DEPENDENCIES) \
+-		$(TAGS_FILES) $(LISP)
+-	set x; \
+-	here=`pwd`; \
+-	list='$(SOURCES) $(HEADERS)  $(LISP) $(TAGS_FILES)'; \
+-	unique=`for i in $$list; do \
+-	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
+-	  done | \
+-	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
+-	      END { if (nonempty) { for (i in files) print i; }; }'`; \
+-	shift; \
+-	if test -z "$(ETAGS_ARGS)$$*$$unique"; then :; else \
+-	  test -n "$$unique" || unique=$$empty_fix; \
+-	  if test $$# -gt 0; then \
+-	    $(ETAGS) $(ETAGSFLAGS) $(AM_ETAGSFLAGS) $(ETAGS_ARGS) \
+-	      "$$@" $$unique; \
+-	  else \
+-	    $(ETAGS) $(ETAGSFLAGS) $(AM_ETAGSFLAGS) $(ETAGS_ARGS) \
+-	      $$unique; \
+-	  fi; \
+-	fi
+-ctags: CTAGS
+-CTAGS:  $(HEADERS) $(SOURCES)  $(TAGS_DEPENDENCIES) \
+-		$(TAGS_FILES) $(LISP)
+-	list='$(SOURCES) $(HEADERS)  $(LISP) $(TAGS_FILES)'; \
+-	unique=`for i in $$list; do \
+-	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
+-	  done | \
+-	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
+-	      END { if (nonempty) { for (i in files) print i; }; }'`; \
+-	test -z "$(CTAGS_ARGS)$$unique" \
+-	  || $(CTAGS) $(CTAGSFLAGS) $(AM_CTAGSFLAGS) $(CTAGS_ARGS) \
+-	     $$unique
+-
+-GTAGS:
+-	here=`$(am__cd) $(top_builddir) && pwd` \
+-	  && $(am__cd) $(top_srcdir) \
+-	  && gtags -i $(GTAGS_ARGS) "$$here"
+-
+-distclean-tags:
+-	-rm -f TAGS ID GTAGS GRTAGS GSYMS GPATH tags
+-
+-distdir: $(DISTFILES)
+-	@srcdirstrip=`echo "$(srcdir)" | sed 's/[].[^$$\\*]/\\\\&/g'`; \
+-	topsrcdirstrip=`echo "$(top_srcdir)" | sed 's/[].[^$$\\*]/\\\\&/g'`; \
+-	list='$(DISTFILES)'; \
+-	  dist_files=`for file in $$list; do echo $$file; done | \
+-	  sed -e "s|^$$srcdirstrip/||;t" \
+-	      -e "s|^$$topsrcdirstrip/|$(top_builddir)/|;t"`; \
+-	case $$dist_files in \
+-	  */*) $(MKDIR_P) `echo "$$dist_files" | \
+-			   sed '/\//!d;s|^|$(distdir)/|;s,/[^/]*$$,,' | \
+-			   sort -u` ;; \
+-	esac; \
+-	for file in $$dist_files; do \
+-	  if test -f $$file || test -d $$file; then d=.; else d=$(srcdir); fi; \
+-	  if test -d $$d/$$file; then \
+-	    dir=`echo "/$$file" | sed -e 's,/[^/]*$$,,'`; \
+-	    if test -d "$(distdir)/$$file"; then \
+-	      find "$(distdir)/$$file" -type d ! -perm -700 -exec chmod u+rwx {} \;; \
+-	    fi; \
+-	    if test -d $(srcdir)/$$file && test $$d != $(srcdir); then \
+-	      cp -fpR $(srcdir)/$$file "$(distdir)$$dir" || exit 1; \
+-	      find "$(distdir)/$$file" -type d ! -perm -700 -exec chmod u+rwx {} \;; \
+-	    fi; \
+-	    cp -fpR $$d/$$file "$(distdir)$$dir" || exit 1; \
+-	  else \
+-	    test -f "$(distdir)/$$file" \
+-	    || cp -p $$d/$$file "$(distdir)/$$file" \
+-	    || exit 1; \
+-	  fi; \
+-	done
+-check-am: all-am
+-check: check-am
+-all-am: Makefile $(HEADERS)
+-installdirs:
+-install: install-am
+-install-exec: install-exec-am
+-install-data: install-data-am
+-uninstall: uninstall-am
+-
+-install-am: all-am
+-	@$(MAKE) $(AM_MAKEFLAGS) install-exec-am install-data-am
+-
+-installcheck: installcheck-am
+-install-strip:
+-	$(MAKE) $(AM_MAKEFLAGS) INSTALL_PROGRAM="$(INSTALL_STRIP_PROGRAM)" \
+-	  install_sh_PROGRAM="$(INSTALL_STRIP_PROGRAM)" INSTALL_STRIP_FLAG=-s \
+-	  `test -z '$(STRIP)' || \
+-	    echo "INSTALL_PROGRAM_ENV=STRIPPROG='$(STRIP)'"` install
+-mostlyclean-generic:
+-
+-clean-generic:
+-
+-distclean-generic:
+-	-test -z "$(CONFIG_CLEAN_FILES)" || rm -f $(CONFIG_CLEAN_FILES)
+-	-test . = "$(srcdir)" || test -z "$(CONFIG_CLEAN_VPATH_FILES)" || rm -f $(CONFIG_CLEAN_VPATH_FILES)
+-
+-maintainer-clean-generic:
+-	@echo "This command is intended for maintainers to use"
+-	@echo "it deletes files that may require special tools to rebuild."
+-clean: clean-am
+-
+-clean-am: clean-generic mostlyclean-am
+-
+-distclean: distclean-am
+-	-rm -f Makefile
+-distclean-am: clean-am distclean-generic distclean-tags
+-
+-dvi: dvi-am
+-
+-dvi-am:
+-
+-html: html-am
+-
+-html-am:
+-
+-info: info-am
+-
+-info-am:
+-
+-install-data-am:
+-
+-install-dvi: install-dvi-am
+-
+-install-dvi-am:
+-
+-install-exec-am:
+-
+-install-html: install-html-am
+-
+-install-html-am:
+-
+-install-info: install-info-am
+-
+-install-info-am:
+-
+-install-man:
+-
+-install-pdf: install-pdf-am
+-
+-install-pdf-am:
+-
+-install-ps: install-ps-am
+-
+-install-ps-am:
+-
+-installcheck-am:
+-
+-maintainer-clean: maintainer-clean-am
+-	-rm -f Makefile
+-maintainer-clean-am: distclean-am maintainer-clean-generic
+-
+-mostlyclean: mostlyclean-am
+-
+-mostlyclean-am: mostlyclean-generic
+-
+-pdf: pdf-am
+-
+-pdf-am:
+-
+-ps: ps-am
+-
+-ps-am:
+-
+-uninstall-am:
+-
+-.MAKE: install-am install-strip
+-
+-.PHONY: CTAGS GTAGS all all-am check check-am clean clean-generic \
+-	ctags distclean distclean-generic distclean-tags distdir dvi \
+-	dvi-am html html-am info info-am install install-am \
+-	install-data install-data-am install-dvi install-dvi-am \
+-	install-exec install-exec-am install-html install-html-am \
+-	install-info install-info-am install-man install-pdf \
+-	install-pdf-am install-ps install-ps-am install-strip \
+-	installcheck installcheck-am installdirs maintainer-clean \
+-	maintainer-clean-generic mostlyclean mostlyclean-generic pdf \
+-	pdf-am ps ps-am tags uninstall uninstall-am
+-
+-
+-# Tell versions [3.59,3.63) of GNU make to not export all variables.
+-# Otherwise a system limit (for SysV at least) may be exceeded.
+-.NOEXPORT:
+diff -Nur dosbox-0.74/src/cpu/core_dyn_x86/risc_x86.h dosbox/src/cpu/core_dyn_x86/risc_x86.h
+--- dosbox-0.74/src/cpu/core_dyn_x86/risc_x86.h	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/cpu/core_dyn_x86/risc_x86.h	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,7 +16,6 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: risc_x86.h,v 1.32 2009-05-27 09:15:41 qbix79 Exp $ */
+ 
+ static void gen_init(void);
+ 
+diff -Nur dosbox-0.74/src/cpu/core_dyn_x86/string.h dosbox/src/cpu/core_dyn_x86/string.h
+--- dosbox-0.74/src/cpu/core_dyn_x86/string.h	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/cpu/core_dyn_x86/string.h	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+diff -Nur dosbox-0.74/src/cpu/core_dyn_x86.cpp dosbox/src/cpu/core_dyn_x86.cpp
+--- dosbox-0.74/src/cpu/core_dyn_x86.cpp	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/cpu/core_dyn_x86.cpp	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,7 +16,6 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: core_dyn_x86.cpp,v 1.36 2009-07-20 17:55:52 c2woody Exp $ */
+ 
+ #include "dosbox.h"
+ 
+@@ -61,11 +60,8 @@
+ #define DYN_PAGE_HASH	(4096>>DYN_HASH_SHIFT)
+ #define DYN_LINKS		(16)
+ 
+-#if 0
+-#define DYN_LOG	LOG_MSG
+-#else 
+-#define DYN_LOG
+-#endif
++//#define DYN_LOG 1 //Turn logging on
++
+ 
+ #if C_FPU
+ #define CPU_FPU 1                                               //Enable FPU escape instructions
+@@ -251,8 +247,8 @@
+ {										\
+ 	__asm__ volatile (					\
+ 		"fnsave		%0			\n"		\
++		:	"=m" (dyn_dh_fpu.state[0])	\
+ 		:								\
+-		:	"m" (dyn_dh_fpu.state[0])	\
+ 		:	"memory"					\
+ 	);									\
+ 	dyn_dh_fpu.state_used=false;		\
+@@ -307,7 +303,10 @@
+ 		}
+ #endif
+ 		if (!GETFLAG(TF)) {
+-			if (GETFLAG(IF) && PIC_IRQCheck) return CBRET_NONE;
++			if (GETFLAG(IF) && PIC_IRQCheck) {
++				if (dyn_dh_fpu.state_used) DH_FPU_SAVE_REINIT
++				return CBRET_NONE;
++			}
+ 			goto restart_core;
+ 		}
+ 		cpudecoder=CPU_Core_Dyn_X86_Trap_Run;
+@@ -454,8 +453,8 @@
+ 		"finit					\n"
+ 		"fsave		%0			\n"
+ 		"fstcw		%1			\n"
++		:	"=m" (dyn_dh_fpu.state[0]), "=m" (dyn_dh_fpu.host_cw)
+ 		:
+-		:	"m" (dyn_dh_fpu.state[0]), "m" (dyn_dh_fpu.host_cw)
+ 		:	"memory"
+ 	);
+ #endif
+@@ -472,8 +471,62 @@
+ 	cache_close();
+ }
+ 
++void CPU_Core_Dyn_X86_Cache_Reset(void) {
++	cache_reset();
++}
++
+ void CPU_Core_Dyn_X86_SetFPUMode(bool dh_fpu) {
+ 	dyn_dh_fpu.dh_fpu_enabled=dh_fpu;
+ }
+ 
++Bit32u fpu_state[32];
++
++void CPU_Core_Dyn_X86_SaveDHFPUState(void) {
++	if (dyn_dh_fpu.dh_fpu_enabled) {
++		if (dyn_dh_fpu.state_used!=0) {
++#if defined (_MSC_VER)
++			__asm {
++			__asm	fsave	fpu_state[0]
++			__asm	finit
++			}
++#else
++			__asm__ volatile (
++				"fsave		%0			\n"
++				"finit					\n"
++				:	"=m" (fpu_state[0])
++				:
++				:	"memory"
++			);
++#endif
++		}
++	}
++}
++
++void CPU_Core_Dyn_X86_RestoreDHFPUState(void) {
++	if (dyn_dh_fpu.dh_fpu_enabled) {
++		if (dyn_dh_fpu.state_used!=0) {
++#if defined (_MSC_VER)
++			__asm {
++			__asm	frstor	fpu_state[0]
++			}
++#else
++			__asm__ volatile (
++				"frstor		%0			\n"
++				:
++				:	"m" (fpu_state[0])
++				:
++			);
++#endif
++		}
++	}
++}
++
++#else
++
++void CPU_Core_Dyn_X86_SaveDHFPUState(void) {
++}
++
++void CPU_Core_Dyn_X86_RestoreDHFPUState(void) {
++}
++
+ #endif
+diff -Nur dosbox-0.74/src/cpu/core_full/ea_lookup.h dosbox/src/cpu/core_full/ea_lookup.h
+--- dosbox-0.74/src/cpu/core_full/ea_lookup.h	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/cpu/core_full/ea_lookup.h	2014-01-12 14:43:47.000000000 +0100
+@@ -1,3 +1,21 @@
++/*
++ *  Copyright (C) 2002-2013  The DOSBox Team
++ *
++ *  This program is free software; you can redistribute it and/or modify
++ *  it under the terms of the GNU General Public License as published by
++ *  the Free Software Foundation; either version 2 of the License, or
++ *  (at your option) any later version.
++ *
++ *  This program is distributed in the hope that it will be useful,
++ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
++ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
++ *  GNU General Public License for more details.
++ *
++ *  You should have received a copy of the GNU General Public License
++ *  along with this program; if not, write to the Free Software
++ *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
++ */
++
+ {
+ 	EAPoint seg_base;
+ 	Bit16u off;
+diff -Nur dosbox-0.74/src/cpu/core_full/load.h dosbox/src/cpu/core_full/load.h
+--- dosbox-0.74/src/cpu/core_full/load.h	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/cpu/core_full/load.h	2014-01-12 14:43:47.000000000 +0100
+@@ -1,3 +1,21 @@
++/*
++ *  Copyright (C) 2002-2013  The DOSBox Team
++ *
++ *  This program is free software; you can redistribute it and/or modify
++ *  it under the terms of the GNU General Public License as published by
++ *  the Free Software Foundation; either version 2 of the License, or
++ *  (at your option) any later version.
++ *
++ *  This program is distributed in the hope that it will be useful,
++ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
++ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
++ *  GNU General Public License for more details.
++ *
++ *  You should have received a copy of the GNU General Public License
++ *  along with this program; if not, write to the Free Software
++ *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
++ */
++
+ switch (inst.code.load) {
+ /* General loading */
+ 	case L_POPwRM:
+@@ -482,6 +500,13 @@
+ 	case D_ICEBP:
+ 		CPU_SW_Interrupt_NoIOPLCheck(1,GetIP());
+ 		continue;
++	case D_RDTSC: {
++		if (CPU_ArchitectureType<CPU_ARCHTYPE_PENTIUMSLOW) goto illegalopcode;
++		Bit64s tsc=(Bit64s)(PIC_FullIndex()*(double)(CPU_CycleAutoAdjust?70000:CPU_CycleMax));
++		reg_edx=(Bit32u)(tsc>>32);
++		reg_eax=(Bit32u)(tsc&0xffffffff);
++		break;
++		}
+ 	default:
+ 		LOG(LOG_CPU,LOG_ERROR)("LOAD:Unhandled code %d opcode %X",inst.code.load,inst.entry);
+ 		goto illegalopcode;
+diff -Nur dosbox-0.74/src/cpu/core_full/loadwrite.h dosbox/src/cpu/core_full/loadwrite.h
+--- dosbox-0.74/src/cpu/core_full/loadwrite.h	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/cpu/core_full/loadwrite.h	2014-01-12 14:43:47.000000000 +0100
+@@ -1,3 +1,21 @@
++/*
++ *  Copyright (C) 2002-2013  The DOSBox Team
++ *
++ *  This program is free software; you can redistribute it and/or modify
++ *  it under the terms of the GNU General Public License as published by
++ *  the Free Software Foundation; either version 2 of the License, or
++ *  (at your option) any later version.
++ *
++ *  This program is distributed in the hope that it will be useful,
++ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
++ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
++ *  GNU General Public License for more details.
++ *
++ *  You should have received a copy of the GNU General Public License
++ *  along with this program; if not, write to the Free Software
++ *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
++ */
++
+ #define SaveIP() reg_eip=(Bit32u)(inst.cseip-SegBase(cs));
+ #define LoadIP() inst.cseip=SegBase(cs)+reg_eip;
+ #define GetIP()	(inst.cseip-SegBase(cs))
+diff -Nur dosbox-0.74/src/cpu/core_full/Makefile.in dosbox/src/cpu/core_full/Makefile.in
+--- dosbox-0.74/src/cpu/core_full/Makefile.in	2010-05-12 11:57:43.000000000 +0200
++++ dosbox/src/cpu/core_full/Makefile.in	1970-01-01 01:00:00.000000000 +0100
+@@ -1,390 +0,0 @@
+-# Makefile.in generated by automake 1.11.1 from Makefile.am.
+-# @configure_input@
+-
+-# Copyright (C) 1994, 1995, 1996, 1997, 1998, 1999, 2000, 2001, 2002,
+-# 2003, 2004, 2005, 2006, 2007, 2008, 2009  Free Software Foundation,
+-# Inc.
+-# This Makefile.in is free software; the Free Software Foundation
+-# gives unlimited permission to copy and/or distribute it,
+-# with or without modifications, as long as this notice is preserved.
+-
+-# This program is distributed in the hope that it will be useful,
+-# but WITHOUT ANY WARRANTY, to the extent permitted by law; without
+-# even the implied warranty of MERCHANTABILITY or FITNESS FOR A
+-# PARTICULAR PURPOSE.
+-
+-@SET_MAKE@
+-
+-VPATH = @srcdir@
+-pkgdatadir = $(datadir)/@PACKAGE@
+-pkgincludedir = $(includedir)/@PACKAGE@
+-pkglibdir = $(libdir)/@PACKAGE@
+-pkglibexecdir = $(libexecdir)/@PACKAGE@
+-am__cd = CDPATH="$${ZSH_VERSION+.}$(PATH_SEPARATOR)" && cd
+-install_sh_DATA = $(install_sh) -c -m 644
+-install_sh_PROGRAM = $(install_sh) -c
+-install_sh_SCRIPT = $(install_sh) -c
+-INSTALL_HEADER = $(INSTALL_DATA)
+-transform = $(program_transform_name)
+-NORMAL_INSTALL = :
+-PRE_INSTALL = :
+-POST_INSTALL = :
+-NORMAL_UNINSTALL = :
+-PRE_UNINSTALL = :
+-POST_UNINSTALL = :
+-build_triplet = @build@
+-host_triplet = @host@
+-subdir = src/cpu/core_full
+-DIST_COMMON = $(noinst_HEADERS) $(srcdir)/Makefile.am \
+-	$(srcdir)/Makefile.in
+-ACLOCAL_M4 = $(top_srcdir)/aclocal.m4
+-am__aclocal_m4_deps = $(top_srcdir)/acinclude.m4 \
+-	$(top_srcdir)/configure.in
+-am__configure_deps = $(am__aclocal_m4_deps) $(CONFIGURE_DEPENDENCIES) \
+-	$(ACLOCAL_M4)
+-mkinstalldirs = $(install_sh) -d
+-CONFIG_HEADER = $(top_builddir)/config.h
+-CONFIG_CLEAN_FILES =
+-CONFIG_CLEAN_VPATH_FILES =
+-SOURCES =
+-DIST_SOURCES =
+-HEADERS = $(noinst_HEADERS)
+-ETAGS = etags
+-CTAGS = ctags
+-DISTFILES = $(DIST_COMMON) $(DIST_SOURCES) $(TEXINFOS) $(EXTRA_DIST)
+-ACLOCAL = @ACLOCAL@
+-ALSA_CFLAGS = @ALSA_CFLAGS@
+-ALSA_LIBS = @ALSA_LIBS@
+-AMTAR = @AMTAR@
+-AUTOCONF = @AUTOCONF@
+-AUTOHEADER = @AUTOHEADER@
+-AUTOMAKE = @AUTOMAKE@
+-AWK = @AWK@
+-CC = @CC@
+-CCDEPMODE = @CCDEPMODE@
+-CFLAGS = @CFLAGS@
+-CPP = @CPP@
+-CPPFLAGS = @CPPFLAGS@
+-CXX = @CXX@
+-CXXDEPMODE = @CXXDEPMODE@
+-CXXFLAGS = @CXXFLAGS@
+-CYGPATH_W = @CYGPATH_W@
+-DEFS = @DEFS@
+-DEPDIR = @DEPDIR@
+-ECHO_C = @ECHO_C@
+-ECHO_N = @ECHO_N@
+-ECHO_T = @ECHO_T@
+-EGREP = @EGREP@
+-EXEEXT = @EXEEXT@
+-GREP = @GREP@
+-INSTALL = @INSTALL@
+-INSTALL_DATA = @INSTALL_DATA@
+-INSTALL_PROGRAM = @INSTALL_PROGRAM@
+-INSTALL_SCRIPT = @INSTALL_SCRIPT@
+-INSTALL_STRIP_PROGRAM = @INSTALL_STRIP_PROGRAM@
+-LDFLAGS = @LDFLAGS@
+-LIBOBJS = @LIBOBJS@
+-LIBS = @LIBS@
+-LTLIBOBJS = @LTLIBOBJS@
+-MAKEINFO = @MAKEINFO@
+-MKDIR_P = @MKDIR_P@
+-OBJEXT = @OBJEXT@
+-PACKAGE = @PACKAGE@
+-PACKAGE_BUGREPORT = @PACKAGE_BUGREPORT@
+-PACKAGE_NAME = @PACKAGE_NAME@
+-PACKAGE_STRING = @PACKAGE_STRING@
+-PACKAGE_TARNAME = @PACKAGE_TARNAME@
+-PACKAGE_URL = @PACKAGE_URL@
+-PACKAGE_VERSION = @PACKAGE_VERSION@
+-PATH_SEPARATOR = @PATH_SEPARATOR@
+-RANLIB = @RANLIB@
+-SDL_CFLAGS = @SDL_CFLAGS@
+-SDL_CONFIG = @SDL_CONFIG@
+-SDL_LIBS = @SDL_LIBS@
+-SET_MAKE = @SET_MAKE@
+-SHELL = @SHELL@
+-STRIP = @STRIP@
+-VERSION = @VERSION@
+-WINDRES = @WINDRES@
+-abs_builddir = @abs_builddir@
+-abs_srcdir = @abs_srcdir@
+-abs_top_builddir = @abs_top_builddir@
+-abs_top_srcdir = @abs_top_srcdir@
+-ac_ct_CC = @ac_ct_CC@
+-ac_ct_CXX = @ac_ct_CXX@
+-am__include = @am__include@
+-am__leading_dot = @am__leading_dot@
+-am__quote = @am__quote@
+-am__tar = @am__tar@
+-am__untar = @am__untar@
+-bindir = @bindir@
+-build = @build@
+-build_alias = @build_alias@
+-build_cpu = @build_cpu@
+-build_os = @build_os@
+-build_vendor = @build_vendor@
+-builddir = @builddir@
+-datadir = @datadir@
+-datarootdir = @datarootdir@
+-docdir = @docdir@
+-dvidir = @dvidir@
+-exec_prefix = @exec_prefix@
+-host = @host@
+-host_alias = @host_alias@
+-host_cpu = @host_cpu@
+-host_os = @host_os@
+-host_vendor = @host_vendor@
+-htmldir = @htmldir@
+-includedir = @includedir@
+-infodir = @infodir@
+-install_sh = @install_sh@
+-libdir = @libdir@
+-libexecdir = @libexecdir@
+-localedir = @localedir@
+-localstatedir = @localstatedir@
+-mandir = @mandir@
+-mkdir_p = @mkdir_p@
+-oldincludedir = @oldincludedir@
+-pdfdir = @pdfdir@
+-prefix = @prefix@
+-program_transform_name = @program_transform_name@
+-psdir = @psdir@
+-sbindir = @sbindir@
+-sharedstatedir = @sharedstatedir@
+-srcdir = @srcdir@
+-sysconfdir = @sysconfdir@
+-target_alias = @target_alias@
+-top_build_prefix = @top_build_prefix@
+-top_builddir = @top_builddir@
+-top_srcdir = @top_srcdir@
+-noinst_HEADERS = ea_lookup.h load.h loadwrite.h op.h optable.h save.h \
+-		 string.h support.h
+-
+-all: all-am
+-
+-.SUFFIXES:
+-$(srcdir)/Makefile.in:  $(srcdir)/Makefile.am  $(am__configure_deps)
+-	@for dep in $?; do \
+-	  case '$(am__configure_deps)' in \
+-	    *$$dep*) \
+-	      ( cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh ) \
+-	        && { if test -f $@; then exit 0; else break; fi; }; \
+-	      exit 1;; \
+-	  esac; \
+-	done; \
+-	echo ' cd $(top_srcdir) && $(AUTOMAKE) --gnu src/cpu/core_full/Makefile'; \
+-	$(am__cd) $(top_srcdir) && \
+-	  $(AUTOMAKE) --gnu src/cpu/core_full/Makefile
+-.PRECIOUS: Makefile
+-Makefile: $(srcdir)/Makefile.in $(top_builddir)/config.status
+-	@case '$?' in \
+-	  *config.status*) \
+-	    cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh;; \
+-	  *) \
+-	    echo ' cd $(top_builddir) && $(SHELL) ./config.status $(subdir)/$@ $(am__depfiles_maybe)'; \
+-	    cd $(top_builddir) && $(SHELL) ./config.status $(subdir)/$@ $(am__depfiles_maybe);; \
+-	esac;
+-
+-$(top_builddir)/config.status: $(top_srcdir)/configure $(CONFIG_STATUS_DEPENDENCIES)
+-	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
+-
+-$(top_srcdir)/configure:  $(am__configure_deps)
+-	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
+-$(ACLOCAL_M4):  $(am__aclocal_m4_deps)
+-	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
+-$(am__aclocal_m4_deps):
+-
+-ID: $(HEADERS) $(SOURCES) $(LISP) $(TAGS_FILES)
+-	list='$(SOURCES) $(HEADERS) $(LISP) $(TAGS_FILES)'; \
+-	unique=`for i in $$list; do \
+-	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
+-	  done | \
+-	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
+-	      END { if (nonempty) { for (i in files) print i; }; }'`; \
+-	mkid -fID $$unique
+-tags: TAGS
+-
+-TAGS:  $(HEADERS) $(SOURCES)  $(TAGS_DEPENDENCIES) \
+-		$(TAGS_FILES) $(LISP)
+-	set x; \
+-	here=`pwd`; \
+-	list='$(SOURCES) $(HEADERS)  $(LISP) $(TAGS_FILES)'; \
+-	unique=`for i in $$list; do \
+-	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
+-	  done | \
+-	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
+-	      END { if (nonempty) { for (i in files) print i; }; }'`; \
+-	shift; \
+-	if test -z "$(ETAGS_ARGS)$$*$$unique"; then :; else \
+-	  test -n "$$unique" || unique=$$empty_fix; \
+-	  if test $$# -gt 0; then \
+-	    $(ETAGS) $(ETAGSFLAGS) $(AM_ETAGSFLAGS) $(ETAGS_ARGS) \
+-	      "$$@" $$unique; \
+-	  else \
+-	    $(ETAGS) $(ETAGSFLAGS) $(AM_ETAGSFLAGS) $(ETAGS_ARGS) \
+-	      $$unique; \
+-	  fi; \
+-	fi
+-ctags: CTAGS
+-CTAGS:  $(HEADERS) $(SOURCES)  $(TAGS_DEPENDENCIES) \
+-		$(TAGS_FILES) $(LISP)
+-	list='$(SOURCES) $(HEADERS)  $(LISP) $(TAGS_FILES)'; \
+-	unique=`for i in $$list; do \
+-	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
+-	  done | \
+-	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
+-	      END { if (nonempty) { for (i in files) print i; }; }'`; \
+-	test -z "$(CTAGS_ARGS)$$unique" \
+-	  || $(CTAGS) $(CTAGSFLAGS) $(AM_CTAGSFLAGS) $(CTAGS_ARGS) \
+-	     $$unique
+-
+-GTAGS:
+-	here=`$(am__cd) $(top_builddir) && pwd` \
+-	  && $(am__cd) $(top_srcdir) \
+-	  && gtags -i $(GTAGS_ARGS) "$$here"
+-
+-distclean-tags:
+-	-rm -f TAGS ID GTAGS GRTAGS GSYMS GPATH tags
+-
+-distdir: $(DISTFILES)
+-	@srcdirstrip=`echo "$(srcdir)" | sed 's/[].[^$$\\*]/\\\\&/g'`; \
+-	topsrcdirstrip=`echo "$(top_srcdir)" | sed 's/[].[^$$\\*]/\\\\&/g'`; \
+-	list='$(DISTFILES)'; \
+-	  dist_files=`for file in $$list; do echo $$file; done | \
+-	  sed -e "s|^$$srcdirstrip/||;t" \
+-	      -e "s|^$$topsrcdirstrip/|$(top_builddir)/|;t"`; \
+-	case $$dist_files in \
+-	  */*) $(MKDIR_P) `echo "$$dist_files" | \
+-			   sed '/\//!d;s|^|$(distdir)/|;s,/[^/]*$$,,' | \
+-			   sort -u` ;; \
+-	esac; \
+-	for file in $$dist_files; do \
+-	  if test -f $$file || test -d $$file; then d=.; else d=$(srcdir); fi; \
+-	  if test -d $$d/$$file; then \
+-	    dir=`echo "/$$file" | sed -e 's,/[^/]*$$,,'`; \
+-	    if test -d "$(distdir)/$$file"; then \
+-	      find "$(distdir)/$$file" -type d ! -perm -700 -exec chmod u+rwx {} \;; \
+-	    fi; \
+-	    if test -d $(srcdir)/$$file && test $$d != $(srcdir); then \
+-	      cp -fpR $(srcdir)/$$file "$(distdir)$$dir" || exit 1; \
+-	      find "$(distdir)/$$file" -type d ! -perm -700 -exec chmod u+rwx {} \;; \
+-	    fi; \
+-	    cp -fpR $$d/$$file "$(distdir)$$dir" || exit 1; \
+-	  else \
+-	    test -f "$(distdir)/$$file" \
+-	    || cp -p $$d/$$file "$(distdir)/$$file" \
+-	    || exit 1; \
+-	  fi; \
+-	done
+-check-am: all-am
+-check: check-am
+-all-am: Makefile $(HEADERS)
+-installdirs:
+-install: install-am
+-install-exec: install-exec-am
+-install-data: install-data-am
+-uninstall: uninstall-am
+-
+-install-am: all-am
+-	@$(MAKE) $(AM_MAKEFLAGS) install-exec-am install-data-am
+-
+-installcheck: installcheck-am
+-install-strip:
+-	$(MAKE) $(AM_MAKEFLAGS) INSTALL_PROGRAM="$(INSTALL_STRIP_PROGRAM)" \
+-	  install_sh_PROGRAM="$(INSTALL_STRIP_PROGRAM)" INSTALL_STRIP_FLAG=-s \
+-	  `test -z '$(STRIP)' || \
+-	    echo "INSTALL_PROGRAM_ENV=STRIPPROG='$(STRIP)'"` install
+-mostlyclean-generic:
+-
+-clean-generic:
+-
+-distclean-generic:
+-	-test -z "$(CONFIG_CLEAN_FILES)" || rm -f $(CONFIG_CLEAN_FILES)
+-	-test . = "$(srcdir)" || test -z "$(CONFIG_CLEAN_VPATH_FILES)" || rm -f $(CONFIG_CLEAN_VPATH_FILES)
+-
+-maintainer-clean-generic:
+-	@echo "This command is intended for maintainers to use"
+-	@echo "it deletes files that may require special tools to rebuild."
+-clean: clean-am
+-
+-clean-am: clean-generic mostlyclean-am
+-
+-distclean: distclean-am
+-	-rm -f Makefile
+-distclean-am: clean-am distclean-generic distclean-tags
+-
+-dvi: dvi-am
+-
+-dvi-am:
+-
+-html: html-am
+-
+-html-am:
+-
+-info: info-am
+-
+-info-am:
+-
+-install-data-am:
+-
+-install-dvi: install-dvi-am
+-
+-install-dvi-am:
+-
+-install-exec-am:
+-
+-install-html: install-html-am
+-
+-install-html-am:
+-
+-install-info: install-info-am
+-
+-install-info-am:
+-
+-install-man:
+-
+-install-pdf: install-pdf-am
+-
+-install-pdf-am:
+-
+-install-ps: install-ps-am
+-
+-install-ps-am:
+-
+-installcheck-am:
+-
+-maintainer-clean: maintainer-clean-am
+-	-rm -f Makefile
+-maintainer-clean-am: distclean-am maintainer-clean-generic
+-
+-mostlyclean: mostlyclean-am
+-
+-mostlyclean-am: mostlyclean-generic
+-
+-pdf: pdf-am
+-
+-pdf-am:
+-
+-ps: ps-am
+-
+-ps-am:
+-
+-uninstall-am:
+-
+-.MAKE: install-am install-strip
+-
+-.PHONY: CTAGS GTAGS all all-am check check-am clean clean-generic \
+-	ctags distclean distclean-generic distclean-tags distdir dvi \
+-	dvi-am html html-am info info-am install install-am \
+-	install-data install-data-am install-dvi install-dvi-am \
+-	install-exec install-exec-am install-html install-html-am \
+-	install-info install-info-am install-man install-pdf \
+-	install-pdf-am install-ps install-ps-am install-strip \
+-	installcheck installcheck-am installdirs maintainer-clean \
+-	maintainer-clean-generic mostlyclean mostlyclean-generic pdf \
+-	pdf-am ps ps-am tags uninstall uninstall-am
+-
+-
+-# Tell versions [3.59,3.63) of GNU make to not export all variables.
+-# Otherwise a system limit (for SysV at least) may be exceeded.
+-.NOEXPORT:
+diff -Nur dosbox-0.74/src/cpu/core_full/op.h dosbox/src/cpu/core_full/op.h
+--- dosbox-0.74/src/cpu/core_full/op.h	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/cpu/core_full/op.h	2014-01-12 14:43:47.000000000 +0100
+@@ -1,3 +1,21 @@
++/*
++ *  Copyright (C) 2002-2013  The DOSBox Team
++ *
++ *  This program is free software; you can redistribute it and/or modify
++ *  it under the terms of the GNU General Public License as published by
++ *  the Free Software Foundation; either version 2 of the License, or
++ *  (at your option) any later version.
++ *
++ *  This program is distributed in the hope that it will be useful,
++ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
++ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
++ *  GNU General Public License for more details.
++ *
++ *  You should have received a copy of the GNU General Public License
++ *  along with this program; if not, write to the Free Software
++ *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
++ */
++
+ /* Do the actual opcode */
+ switch (inst.code.op) {
+ 	case t_ADDb:	case t_ADDw:	case t_ADDd:
+diff -Nur dosbox-0.74/src/cpu/core_full/optable.h dosbox/src/cpu/core_full/optable.h
+--- dosbox-0.74/src/cpu/core_full/optable.h	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/cpu/core_full/optable.h	2014-01-12 14:43:47.000000000 +0100
+@@ -1,3 +1,21 @@
++/*
++ *  Copyright (C) 2002-2013  The DOSBox Team
++ *
++ *  This program is free software; you can redistribute it and/or modify
++ *  it under the terms of the GNU General Public License as published by
++ *  the Free Software Foundation; either version 2 of the License, or
++ *  (at your option) any later version.
++ *
++ *  This program is distributed in the hope that it will be useful,
++ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
++ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
++ *  GNU General Public License for more details.
++ *
++ *  You should have received a copy of the GNU General Public License
++ *  along with this program; if not, write to the Free Software
++ *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
++ */
++
+ /* Big ass opcode table normal,double, 66 normal, 66 double */
+ static OpCode OpCodeTable[1024]={
+ /* 0x00 - 0x07 */
+@@ -216,7 +234,7 @@
+ {0			,0			,0		,0		},{0		,0			,0		,0		},
+ 
+ /* 0x130 - 0x137 */
+-{0			,0			,0		,0		},{0		,0			,0		,0		},
++{0			,0			,0		,0		},{D_RDTSC	,0			,0		,0		},
+ {0			,0			,0		,0		},{0		,0			,0		,0		},
+ {0			,0			,0		,0		},{0		,0			,0		,0		},
+ {0			,0			,0		,0		},{0		,0			,0		,0		},
+@@ -572,7 +590,7 @@
+ {0			,0			,0		,0		},{0		,0			,0		,0		},
+ 
+ /* 0x330 - 0x337 */
+-{0			,0			,0		,0		},{0		,0			,0		,0		},
++{0			,0			,0		,0		},{D_RDTSC	,0			,0		,0		},
+ {0			,0			,0		,0		},{0		,0			,0		,0		},
+ {0			,0			,0		,0		},{0		,0			,0		,0		},
+ {0			,0			,0		,0		},{0		,0			,0		,0		},
+diff -Nur dosbox-0.74/src/cpu/core_full/save.h dosbox/src/cpu/core_full/save.h
+--- dosbox-0.74/src/cpu/core_full/save.h	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/cpu/core_full/save.h	2014-01-12 14:43:47.000000000 +0100
+@@ -1,3 +1,21 @@
++/*
++ *  Copyright (C) 2002-2013  The DOSBox Team
++ *
++ *  This program is free software; you can redistribute it and/or modify
++ *  it under the terms of the GNU General Public License as published by
++ *  the Free Software Foundation; either version 2 of the License, or
++ *  (at your option) any later version.
++ *
++ *  This program is distributed in the hope that it will be useful,
++ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
++ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
++ *  GNU General Public License for more details.
++ *
++ *  You should have received a copy of the GNU General Public License
++ *  along with this program; if not, write to the Free Software
++ *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
++ */
++
+ /* Write the data from the opcode */
+ switch (inst.code.save) {
+ /* Byte */
+diff -Nur dosbox-0.74/src/cpu/core_full/string.h dosbox/src/cpu/core_full/string.h
+--- dosbox-0.74/src/cpu/core_full/string.h	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/cpu/core_full/string.h	2014-01-12 14:43:47.000000000 +0100
+@@ -1,3 +1,21 @@
++/*
++ *  Copyright (C) 2002-2013  The DOSBox Team
++ *
++ *  This program is free software; you can redistribute it and/or modify
++ *  it under the terms of the GNU General Public License as published by
++ *  the Free Software Foundation; either version 2 of the License, or
++ *  (at your option) any later version.
++ *
++ *  This program is distributed in the hope that it will be useful,
++ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
++ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
++ *  GNU General Public License for more details.
++ *
++ *  You should have received a copy of the GNU General Public License
++ *  along with this program; if not, write to the Free Software
++ *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
++ */
++
+ {
+ 	EAPoint si_base,di_base;
+ 	Bitu	si_index,di_index;
+@@ -70,6 +88,13 @@
+ 			di_index=(di_index+add_index) & add_mask;
+ 		}
+ 		break;
++	case R_INSD:
++		add_index<<=2;
++		for (;count>0;count--) {
++			SaveMd(di_base+di_index,IO_ReadD(reg_dx));
++			di_index=(di_index+add_index) & add_mask;
++		}
++		break;
+ 	case R_STOSB:
+ 		for (;count>0;count--) {
+ 			SaveMb(di_base+di_index,reg_al);
+diff -Nur dosbox-0.74/src/cpu/core_full/support.h dosbox/src/cpu/core_full/support.h
+--- dosbox-0.74/src/cpu/core_full/support.h	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/cpu/core_full/support.h	2014-01-12 14:43:47.000000000 +0100
+@@ -1,3 +1,21 @@
++/*
++ *  Copyright (C) 2002-2013  The DOSBox Team
++ *
++ *  This program is free software; you can redistribute it and/or modify
++ *  it under the terms of the GNU General Public License as published by
++ *  the Free Software Foundation; either version 2 of the License, or
++ *  (at your option) any later version.
++ *
++ *  This program is distributed in the hope that it will be useful,
++ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
++ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
++ *  GNU General Public License for more details.
++ *
++ *  You should have received a copy of the GNU General Public License
++ *  along with this program; if not, write to the Free Software
++ *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
++ */
++
+ enum {
+ 	L_N=0,
+ 	L_SKIP,
+@@ -46,6 +64,7 @@
+ 	D_CPUID,
+ 	D_HLT,D_CLTS,
+ 	D_LOCK,D_ICEBP,
++	D_RDTSC,
+ 	L_ERROR
+ };
+ 
+diff -Nur dosbox-0.74/src/cpu/core_full.cpp dosbox/src/cpu/core_full.cpp
+--- dosbox-0.74/src/cpu/core_full.cpp	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/cpu/core_full.cpp	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+diff -Nur dosbox-0.74/src/cpu/core_normal/helpers.h dosbox/src/cpu/core_normal/helpers.h
+--- dosbox-0.74/src/cpu/core_normal/helpers.h	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/cpu/core_normal/helpers.h	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+diff -Nur dosbox-0.74/src/cpu/core_normal/Makefile.in dosbox/src/cpu/core_normal/Makefile.in
+--- dosbox-0.74/src/cpu/core_normal/Makefile.in	2010-05-12 11:57:43.000000000 +0200
++++ dosbox/src/cpu/core_normal/Makefile.in	1970-01-01 01:00:00.000000000 +0100
+@@ -1,390 +0,0 @@
+-# Makefile.in generated by automake 1.11.1 from Makefile.am.
+-# @configure_input@
+-
+-# Copyright (C) 1994, 1995, 1996, 1997, 1998, 1999, 2000, 2001, 2002,
+-# 2003, 2004, 2005, 2006, 2007, 2008, 2009  Free Software Foundation,
+-# Inc.
+-# This Makefile.in is free software; the Free Software Foundation
+-# gives unlimited permission to copy and/or distribute it,
+-# with or without modifications, as long as this notice is preserved.
+-
+-# This program is distributed in the hope that it will be useful,
+-# but WITHOUT ANY WARRANTY, to the extent permitted by law; without
+-# even the implied warranty of MERCHANTABILITY or FITNESS FOR A
+-# PARTICULAR PURPOSE.
+-
+-@SET_MAKE@
+-
+-VPATH = @srcdir@
+-pkgdatadir = $(datadir)/@PACKAGE@
+-pkgincludedir = $(includedir)/@PACKAGE@
+-pkglibdir = $(libdir)/@PACKAGE@
+-pkglibexecdir = $(libexecdir)/@PACKAGE@
+-am__cd = CDPATH="$${ZSH_VERSION+.}$(PATH_SEPARATOR)" && cd
+-install_sh_DATA = $(install_sh) -c -m 644
+-install_sh_PROGRAM = $(install_sh) -c
+-install_sh_SCRIPT = $(install_sh) -c
+-INSTALL_HEADER = $(INSTALL_DATA)
+-transform = $(program_transform_name)
+-NORMAL_INSTALL = :
+-PRE_INSTALL = :
+-POST_INSTALL = :
+-NORMAL_UNINSTALL = :
+-PRE_UNINSTALL = :
+-POST_UNINSTALL = :
+-build_triplet = @build@
+-host_triplet = @host@
+-subdir = src/cpu/core_normal
+-DIST_COMMON = $(noinst_HEADERS) $(srcdir)/Makefile.am \
+-	$(srcdir)/Makefile.in
+-ACLOCAL_M4 = $(top_srcdir)/aclocal.m4
+-am__aclocal_m4_deps = $(top_srcdir)/acinclude.m4 \
+-	$(top_srcdir)/configure.in
+-am__configure_deps = $(am__aclocal_m4_deps) $(CONFIGURE_DEPENDENCIES) \
+-	$(ACLOCAL_M4)
+-mkinstalldirs = $(install_sh) -d
+-CONFIG_HEADER = $(top_builddir)/config.h
+-CONFIG_CLEAN_FILES =
+-CONFIG_CLEAN_VPATH_FILES =
+-SOURCES =
+-DIST_SOURCES =
+-HEADERS = $(noinst_HEADERS)
+-ETAGS = etags
+-CTAGS = ctags
+-DISTFILES = $(DIST_COMMON) $(DIST_SOURCES) $(TEXINFOS) $(EXTRA_DIST)
+-ACLOCAL = @ACLOCAL@
+-ALSA_CFLAGS = @ALSA_CFLAGS@
+-ALSA_LIBS = @ALSA_LIBS@
+-AMTAR = @AMTAR@
+-AUTOCONF = @AUTOCONF@
+-AUTOHEADER = @AUTOHEADER@
+-AUTOMAKE = @AUTOMAKE@
+-AWK = @AWK@
+-CC = @CC@
+-CCDEPMODE = @CCDEPMODE@
+-CFLAGS = @CFLAGS@
+-CPP = @CPP@
+-CPPFLAGS = @CPPFLAGS@
+-CXX = @CXX@
+-CXXDEPMODE = @CXXDEPMODE@
+-CXXFLAGS = @CXXFLAGS@
+-CYGPATH_W = @CYGPATH_W@
+-DEFS = @DEFS@
+-DEPDIR = @DEPDIR@
+-ECHO_C = @ECHO_C@
+-ECHO_N = @ECHO_N@
+-ECHO_T = @ECHO_T@
+-EGREP = @EGREP@
+-EXEEXT = @EXEEXT@
+-GREP = @GREP@
+-INSTALL = @INSTALL@
+-INSTALL_DATA = @INSTALL_DATA@
+-INSTALL_PROGRAM = @INSTALL_PROGRAM@
+-INSTALL_SCRIPT = @INSTALL_SCRIPT@
+-INSTALL_STRIP_PROGRAM = @INSTALL_STRIP_PROGRAM@
+-LDFLAGS = @LDFLAGS@
+-LIBOBJS = @LIBOBJS@
+-LIBS = @LIBS@
+-LTLIBOBJS = @LTLIBOBJS@
+-MAKEINFO = @MAKEINFO@
+-MKDIR_P = @MKDIR_P@
+-OBJEXT = @OBJEXT@
+-PACKAGE = @PACKAGE@
+-PACKAGE_BUGREPORT = @PACKAGE_BUGREPORT@
+-PACKAGE_NAME = @PACKAGE_NAME@
+-PACKAGE_STRING = @PACKAGE_STRING@
+-PACKAGE_TARNAME = @PACKAGE_TARNAME@
+-PACKAGE_URL = @PACKAGE_URL@
+-PACKAGE_VERSION = @PACKAGE_VERSION@
+-PATH_SEPARATOR = @PATH_SEPARATOR@
+-RANLIB = @RANLIB@
+-SDL_CFLAGS = @SDL_CFLAGS@
+-SDL_CONFIG = @SDL_CONFIG@
+-SDL_LIBS = @SDL_LIBS@
+-SET_MAKE = @SET_MAKE@
+-SHELL = @SHELL@
+-STRIP = @STRIP@
+-VERSION = @VERSION@
+-WINDRES = @WINDRES@
+-abs_builddir = @abs_builddir@
+-abs_srcdir = @abs_srcdir@
+-abs_top_builddir = @abs_top_builddir@
+-abs_top_srcdir = @abs_top_srcdir@
+-ac_ct_CC = @ac_ct_CC@
+-ac_ct_CXX = @ac_ct_CXX@
+-am__include = @am__include@
+-am__leading_dot = @am__leading_dot@
+-am__quote = @am__quote@
+-am__tar = @am__tar@
+-am__untar = @am__untar@
+-bindir = @bindir@
+-build = @build@
+-build_alias = @build_alias@
+-build_cpu = @build_cpu@
+-build_os = @build_os@
+-build_vendor = @build_vendor@
+-builddir = @builddir@
+-datadir = @datadir@
+-datarootdir = @datarootdir@
+-docdir = @docdir@
+-dvidir = @dvidir@
+-exec_prefix = @exec_prefix@
+-host = @host@
+-host_alias = @host_alias@
+-host_cpu = @host_cpu@
+-host_os = @host_os@
+-host_vendor = @host_vendor@
+-htmldir = @htmldir@
+-includedir = @includedir@
+-infodir = @infodir@
+-install_sh = @install_sh@
+-libdir = @libdir@
+-libexecdir = @libexecdir@
+-localedir = @localedir@
+-localstatedir = @localstatedir@
+-mandir = @mandir@
+-mkdir_p = @mkdir_p@
+-oldincludedir = @oldincludedir@
+-pdfdir = @pdfdir@
+-prefix = @prefix@
+-program_transform_name = @program_transform_name@
+-psdir = @psdir@
+-sbindir = @sbindir@
+-sharedstatedir = @sharedstatedir@
+-srcdir = @srcdir@
+-sysconfdir = @sysconfdir@
+-target_alias = @target_alias@
+-top_build_prefix = @top_build_prefix@
+-top_builddir = @top_builddir@
+-top_srcdir = @top_srcdir@
+-noinst_HEADERS = helpers.h prefix_none.h prefix_66.h prefix_0f.h support.h table_ea.h \
+-		prefix_66_0f.h string.h
+-
+-all: all-am
+-
+-.SUFFIXES:
+-$(srcdir)/Makefile.in:  $(srcdir)/Makefile.am  $(am__configure_deps)
+-	@for dep in $?; do \
+-	  case '$(am__configure_deps)' in \
+-	    *$$dep*) \
+-	      ( cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh ) \
+-	        && { if test -f $@; then exit 0; else break; fi; }; \
+-	      exit 1;; \
+-	  esac; \
+-	done; \
+-	echo ' cd $(top_srcdir) && $(AUTOMAKE) --gnu src/cpu/core_normal/Makefile'; \
+-	$(am__cd) $(top_srcdir) && \
+-	  $(AUTOMAKE) --gnu src/cpu/core_normal/Makefile
+-.PRECIOUS: Makefile
+-Makefile: $(srcdir)/Makefile.in $(top_builddir)/config.status
+-	@case '$?' in \
+-	  *config.status*) \
+-	    cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh;; \
+-	  *) \
+-	    echo ' cd $(top_builddir) && $(SHELL) ./config.status $(subdir)/$@ $(am__depfiles_maybe)'; \
+-	    cd $(top_builddir) && $(SHELL) ./config.status $(subdir)/$@ $(am__depfiles_maybe);; \
+-	esac;
+-
+-$(top_builddir)/config.status: $(top_srcdir)/configure $(CONFIG_STATUS_DEPENDENCIES)
+-	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
+-
+-$(top_srcdir)/configure:  $(am__configure_deps)
+-	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
+-$(ACLOCAL_M4):  $(am__aclocal_m4_deps)
+-	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
+-$(am__aclocal_m4_deps):
+-
+-ID: $(HEADERS) $(SOURCES) $(LISP) $(TAGS_FILES)
+-	list='$(SOURCES) $(HEADERS) $(LISP) $(TAGS_FILES)'; \
+-	unique=`for i in $$list; do \
+-	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
+-	  done | \
+-	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
+-	      END { if (nonempty) { for (i in files) print i; }; }'`; \
+-	mkid -fID $$unique
+-tags: TAGS
+-
+-TAGS:  $(HEADERS) $(SOURCES)  $(TAGS_DEPENDENCIES) \
+-		$(TAGS_FILES) $(LISP)
+-	set x; \
+-	here=`pwd`; \
+-	list='$(SOURCES) $(HEADERS)  $(LISP) $(TAGS_FILES)'; \
+-	unique=`for i in $$list; do \
+-	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
+-	  done | \
+-	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
+-	      END { if (nonempty) { for (i in files) print i; }; }'`; \
+-	shift; \
+-	if test -z "$(ETAGS_ARGS)$$*$$unique"; then :; else \
+-	  test -n "$$unique" || unique=$$empty_fix; \
+-	  if test $$# -gt 0; then \
+-	    $(ETAGS) $(ETAGSFLAGS) $(AM_ETAGSFLAGS) $(ETAGS_ARGS) \
+-	      "$$@" $$unique; \
+-	  else \
+-	    $(ETAGS) $(ETAGSFLAGS) $(AM_ETAGSFLAGS) $(ETAGS_ARGS) \
+-	      $$unique; \
+-	  fi; \
+-	fi
+-ctags: CTAGS
+-CTAGS:  $(HEADERS) $(SOURCES)  $(TAGS_DEPENDENCIES) \
+-		$(TAGS_FILES) $(LISP)
+-	list='$(SOURCES) $(HEADERS)  $(LISP) $(TAGS_FILES)'; \
+-	unique=`for i in $$list; do \
+-	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
+-	  done | \
+-	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
+-	      END { if (nonempty) { for (i in files) print i; }; }'`; \
+-	test -z "$(CTAGS_ARGS)$$unique" \
+-	  || $(CTAGS) $(CTAGSFLAGS) $(AM_CTAGSFLAGS) $(CTAGS_ARGS) \
+-	     $$unique
+-
+-GTAGS:
+-	here=`$(am__cd) $(top_builddir) && pwd` \
+-	  && $(am__cd) $(top_srcdir) \
+-	  && gtags -i $(GTAGS_ARGS) "$$here"
+-
+-distclean-tags:
+-	-rm -f TAGS ID GTAGS GRTAGS GSYMS GPATH tags
+-
+-distdir: $(DISTFILES)
+-	@srcdirstrip=`echo "$(srcdir)" | sed 's/[].[^$$\\*]/\\\\&/g'`; \
+-	topsrcdirstrip=`echo "$(top_srcdir)" | sed 's/[].[^$$\\*]/\\\\&/g'`; \
+-	list='$(DISTFILES)'; \
+-	  dist_files=`for file in $$list; do echo $$file; done | \
+-	  sed -e "s|^$$srcdirstrip/||;t" \
+-	      -e "s|^$$topsrcdirstrip/|$(top_builddir)/|;t"`; \
+-	case $$dist_files in \
+-	  */*) $(MKDIR_P) `echo "$$dist_files" | \
+-			   sed '/\//!d;s|^|$(distdir)/|;s,/[^/]*$$,,' | \
+-			   sort -u` ;; \
+-	esac; \
+-	for file in $$dist_files; do \
+-	  if test -f $$file || test -d $$file; then d=.; else d=$(srcdir); fi; \
+-	  if test -d $$d/$$file; then \
+-	    dir=`echo "/$$file" | sed -e 's,/[^/]*$$,,'`; \
+-	    if test -d "$(distdir)/$$file"; then \
+-	      find "$(distdir)/$$file" -type d ! -perm -700 -exec chmod u+rwx {} \;; \
+-	    fi; \
+-	    if test -d $(srcdir)/$$file && test $$d != $(srcdir); then \
+-	      cp -fpR $(srcdir)/$$file "$(distdir)$$dir" || exit 1; \
+-	      find "$(distdir)/$$file" -type d ! -perm -700 -exec chmod u+rwx {} \;; \
+-	    fi; \
+-	    cp -fpR $$d/$$file "$(distdir)$$dir" || exit 1; \
+-	  else \
+-	    test -f "$(distdir)/$$file" \
+-	    || cp -p $$d/$$file "$(distdir)/$$file" \
+-	    || exit 1; \
+-	  fi; \
+-	done
+-check-am: all-am
+-check: check-am
+-all-am: Makefile $(HEADERS)
+-installdirs:
+-install: install-am
+-install-exec: install-exec-am
+-install-data: install-data-am
+-uninstall: uninstall-am
+-
+-install-am: all-am
+-	@$(MAKE) $(AM_MAKEFLAGS) install-exec-am install-data-am
+-
+-installcheck: installcheck-am
+-install-strip:
+-	$(MAKE) $(AM_MAKEFLAGS) INSTALL_PROGRAM="$(INSTALL_STRIP_PROGRAM)" \
+-	  install_sh_PROGRAM="$(INSTALL_STRIP_PROGRAM)" INSTALL_STRIP_FLAG=-s \
+-	  `test -z '$(STRIP)' || \
+-	    echo "INSTALL_PROGRAM_ENV=STRIPPROG='$(STRIP)'"` install
+-mostlyclean-generic:
+-
+-clean-generic:
+-
+-distclean-generic:
+-	-test -z "$(CONFIG_CLEAN_FILES)" || rm -f $(CONFIG_CLEAN_FILES)
+-	-test . = "$(srcdir)" || test -z "$(CONFIG_CLEAN_VPATH_FILES)" || rm -f $(CONFIG_CLEAN_VPATH_FILES)
+-
+-maintainer-clean-generic:
+-	@echo "This command is intended for maintainers to use"
+-	@echo "it deletes files that may require special tools to rebuild."
+-clean: clean-am
+-
+-clean-am: clean-generic mostlyclean-am
+-
+-distclean: distclean-am
+-	-rm -f Makefile
+-distclean-am: clean-am distclean-generic distclean-tags
+-
+-dvi: dvi-am
+-
+-dvi-am:
+-
+-html: html-am
+-
+-html-am:
+-
+-info: info-am
+-
+-info-am:
+-
+-install-data-am:
+-
+-install-dvi: install-dvi-am
+-
+-install-dvi-am:
+-
+-install-exec-am:
+-
+-install-html: install-html-am
+-
+-install-html-am:
+-
+-install-info: install-info-am
+-
+-install-info-am:
+-
+-install-man:
+-
+-install-pdf: install-pdf-am
+-
+-install-pdf-am:
+-
+-install-ps: install-ps-am
+-
+-install-ps-am:
+-
+-installcheck-am:
+-
+-maintainer-clean: maintainer-clean-am
+-	-rm -f Makefile
+-maintainer-clean-am: distclean-am maintainer-clean-generic
+-
+-mostlyclean: mostlyclean-am
+-
+-mostlyclean-am: mostlyclean-generic
+-
+-pdf: pdf-am
+-
+-pdf-am:
+-
+-ps: ps-am
+-
+-ps-am:
+-
+-uninstall-am:
+-
+-.MAKE: install-am install-strip
+-
+-.PHONY: CTAGS GTAGS all all-am check check-am clean clean-generic \
+-	ctags distclean distclean-generic distclean-tags distdir dvi \
+-	dvi-am html html-am info info-am install install-am \
+-	install-data install-data-am install-dvi install-dvi-am \
+-	install-exec install-exec-am install-html install-html-am \
+-	install-info install-info-am install-man install-pdf \
+-	install-pdf-am install-ps install-ps-am install-strip \
+-	installcheck installcheck-am installdirs maintainer-clean \
+-	maintainer-clean-generic mostlyclean mostlyclean-generic pdf \
+-	pdf-am ps ps-am tags uninstall uninstall-am
+-
+-
+-# Tell versions [3.59,3.63) of GNU make to not export all variables.
+-# Otherwise a system limit (for SysV at least) may be exceeded.
+-.NOEXPORT:
+diff -Nur dosbox-0.74/src/cpu/core_normal/prefix_0f.h dosbox/src/cpu/core_normal/prefix_0f.h
+--- dosbox-0.74/src/cpu/core_normal/prefix_0f.h	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/cpu/core_normal/prefix_0f.h	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -228,7 +228,8 @@
+ 	CASE_0F_B(0x31)												/* RDTSC */
+ 		{
+ 			if (CPU_ArchitectureType<CPU_ARCHTYPE_PENTIUMSLOW) goto illegal_opcode;
+-			Bit64s tsc=(Bit64s)(PIC_FullIndex()*(double)CPU_CycleMax);
++			/* Use a fixed number when in auto cycles mode as else the reported value changes constantly */
++			Bit64s tsc=(Bit64s)(PIC_FullIndex()*(double) (CPU_CycleAutoAdjust?70000:CPU_CycleMax));
+ 			reg_edx=(Bit32u)(tsc>>32);
+ 			reg_eax=(Bit32u)(tsc&0xffffffff);
+ 		}
+diff -Nur dosbox-0.74/src/cpu/core_normal/prefix_66_0f.h dosbox/src/cpu/core_normal/prefix_66_0f.h
+--- dosbox-0.74/src/cpu/core_normal/prefix_66_0f.h	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/cpu/core_normal/prefix_66_0f.h	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+diff -Nur dosbox-0.74/src/cpu/core_normal/prefix_66.h dosbox/src/cpu/core_normal/prefix_66.h
+--- dosbox-0.74/src/cpu/core_normal/prefix_66.h	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/cpu/core_normal/prefix_66.h	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+diff -Nur dosbox-0.74/src/cpu/core_normal/prefix_none.h dosbox/src/cpu/core_normal/prefix_none.h
+--- dosbox-0.74/src/cpu/core_normal/prefix_none.h	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/cpu/core_normal/prefix_none.h	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -879,7 +879,7 @@
+ 		{	
+ 			Bitu port=Fetchb();
+ 			if (CPU_IO_Exception(port,2)) RUNEXCEPTION();
+-			reg_al=IO_ReadW(port);
++			reg_ax=IO_ReadW(port);
+ 			break;
+ 		}
+ 	CASE_B(0xe6)												/* OUT Ib,AL */
+diff -Nur dosbox-0.74/src/cpu/core_normal/string.h dosbox/src/cpu/core_normal/string.h
+--- dosbox-0.74/src/cpu/core_normal/string.h	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/cpu/core_normal/string.h	2014-01-12 14:43:47.000000000 +0100
+@@ -1,3 +1,21 @@
++/*
++ *  Copyright (C) 2002-2013  The DOSBox Team
++ *
++ *  This program is free software; you can redistribute it and/or modify
++ *  it under the terms of the GNU General Public License as published by
++ *  the Free Software Foundation; either version 2 of the License, or
++ *  (at your option) any later version.
++ *
++ *  This program is distributed in the hope that it will be useful,
++ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
++ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
++ *  GNU General Public License for more details.
++ *
++ *  You should have received a copy of the GNU General Public License
++ *  along with this program; if not, write to the Free Software
++ *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
++ */
++
+ enum STRING_OP {
+ 	R_OUTSB,R_OUTSW,R_OUTSD,
+ 	R_INSB,R_INSW,R_INSD,
+@@ -75,6 +93,13 @@
+ 			di_index=(di_index+add_index) & add_mask;
+ 		}
+ 		break;
++	case R_INSD:
++		add_index<<=2;
++		for (;count>0;count--) {
++			SaveMd(di_base+di_index,IO_ReadD(reg_dx));
++			di_index=(di_index+add_index) & add_mask;
++		}
++		break;
+ 	case R_STOSB:
+ 		for (;count>0;count--) {
+ 			SaveMb(di_base+di_index,reg_al);
+diff -Nur dosbox-0.74/src/cpu/core_normal/support.h dosbox/src/cpu/core_normal/support.h
+--- dosbox-0.74/src/cpu/core_normal/support.h	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/cpu/core_normal/support.h	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+diff -Nur dosbox-0.74/src/cpu/core_normal/table_ea.h dosbox/src/cpu/core_normal/table_ea.h
+--- dosbox-0.74/src/cpu/core_normal/table_ea.h	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/cpu/core_normal/table_ea.h	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+diff -Nur dosbox-0.74/src/cpu/core_normal.cpp dosbox/src/cpu/core_normal.cpp
+--- dosbox-0.74/src/cpu/core_normal.cpp	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/cpu/core_normal.cpp	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+diff -Nur dosbox-0.74/src/cpu/core_prefetch.cpp dosbox/src/cpu/core_prefetch.cpp
+--- dosbox-0.74/src/cpu/core_prefetch.cpp	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/cpu/core_prefetch.cpp	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,7 +16,6 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: core_prefetch.cpp,v 1.3 2009-06-26 16:43:30 c2woody Exp $ */
+ 
+ #include <stdio.h>
+ 
+diff -Nur dosbox-0.74/src/cpu/core_simple.cpp dosbox/src/cpu/core_simple.cpp
+--- dosbox-0.74/src/cpu/core_simple.cpp	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/cpu/core_simple.cpp	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+diff -Nur dosbox-0.74/src/cpu/cpu.cpp dosbox/src/cpu/cpu.cpp
+--- dosbox-0.74/src/cpu/cpu.cpp	2010-05-12 11:57:31.000000000 +0200
++++ dosbox/src/cpu/cpu.cpp	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,10 +16,10 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: cpu.cpp,v 1.116 2009-03-16 18:10:08 c2woody Exp $ */
+ 
+ #include <assert.h>
+ #include <sstream>
++#include <stddef.h>
+ #include "dosbox.h"
+ #include "cpu.h"
+ #include "memory.h"
+@@ -64,7 +64,7 @@
+ 
+ Bitu CPU_ArchitectureType = CPU_ARCHTYPE_MIXED;
+ 
+-Bitu CPU_flag_id_toggle=0;
++Bitu CPU_extflags_toggle=0;	// ID and AC flags may be toggled depending on emulated CPU architecture
+ 
+ Bitu CPU_PrefetchQueueSize=0;
+ 
+@@ -170,7 +170,7 @@
+ 
+ 
+ void CPU_SetFlags(Bitu word,Bitu mask) {
+-	mask|=CPU_flag_id_toggle;	// ID-flag can be toggled on cpuid-supporting CPUs
++	mask|=CPU_extflags_toggle;	// ID-flag and AC-flag can be toggled on CPUID-supporting CPUs
+ 	reg_flags=(reg_flags & ~mask)|(word & mask)|2;
+ 	cpu.direction=1-((reg_flags & FLAG_DF) >> 9);
+ }
+@@ -1547,6 +1547,7 @@
+ 	switch (cr) {
+ 	case 0:
+ 		{
++			value|=CR0_FPUPRESENT;
+ 			Bitu changed=cpu.cr0 ^ value;
+ 			if (!changed) return;
+ 			cpu.cr0=value;
+@@ -2048,6 +2049,7 @@
+ 	if (reg_eip!=cpu.hlt.eip || SegValue(cs) != cpu.hlt.cs) {
+ 		cpudecoder=cpu.hlt.old_decoder;
+ 	} else {
++		CPU_IODelayRemoved += CPU_Cycles;
+ 		CPU_Cycles=0;
+ 	}
+ 	return 0;
+@@ -2055,6 +2057,7 @@
+ 
+ void CPU_HLT(Bitu oldeip) {
+ 	reg_eip=oldeip;
++	CPU_IODelayRemoved += CPU_Cycles;
+ 	CPU_Cycles=0;
+ 	cpu.hlt.cs=SegValue(cs);
+ 	cpu.hlt.eip=reg_eip;
+@@ -2387,8 +2390,9 @@
+ 			CPU_ArchitectureType = CPU_ARCHTYPE_PENTIUMSLOW;
+ 		}
+ 
+-		if (CPU_ArchitectureType>=CPU_ARCHTYPE_486NEWSLOW) CPU_flag_id_toggle=FLAG_ID;
+-		else CPU_flag_id_toggle=0;
++		if (CPU_ArchitectureType>=CPU_ARCHTYPE_486NEWSLOW) CPU_extflags_toggle=(FLAG_ID|FLAG_AC);
++		else if (CPU_ArchitectureType>=CPU_ARCHTYPE_486OLDSLOW) CPU_extflags_toggle=(FLAG_AC);
++		else CPU_extflags_toggle=0;
+ 
+ 
+ 		if(CPU_CycleMax <= 0) CPU_CycleMax = 3000;
+diff -Nur dosbox-0.74/src/cpu/flags.cpp dosbox/src/cpu/flags.cpp
+--- dosbox-0.74/src/cpu/flags.cpp	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/cpu/flags.cpp	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+diff -Nur dosbox-0.74/src/cpu/instructions.h dosbox/src/cpu/instructions.h
+--- dosbox-0.74/src/cpu/instructions.h	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/cpu/instructions.h	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -798,7 +798,7 @@
+ 	Bits res=((Bit16s)op2) * ((Bit16s)op3);					\
+ 	save(op1,res & 0xffff);									\
+ 	FillFlagsNoCFOF();										\
+-	if ((res> -32768)  && (res<32767)) {					\
++	if ((res>= -32768)  && (res<=32767)) {					\
+ 		SETFLAGBIT(CF,false);SETFLAGBIT(OF,false);			\
+ 	} else {												\
+ 		SETFLAGBIT(CF,true);SETFLAGBIT(OF,true);			\
+@@ -810,8 +810,8 @@
+ 	Bit64s res=((Bit64s)((Bit32s)op2))*((Bit64s)((Bit32s)op3));	\
+ 	save(op1,(Bit32s)res);									\
+ 	FillFlagsNoCFOF();										\
+-	if ((res>-((Bit64s)(2147483647)+1)) &&					\
+-		(res<(Bit64s)2147483647)) {							\
++	if ((res>=-((Bit64s)(2147483647)+1)) &&					\
++		(res<=(Bit64s)2147483647)) {						\
+ 		SETFLAGBIT(CF,false);SETFLAGBIT(OF,false);			\
+ 	} else {												\
+ 		SETFLAGBIT(CF,true);SETFLAGBIT(OF,true);			\
+diff -Nur dosbox-0.74/src/cpu/lazyflags.h dosbox/src/cpu/lazyflags.h
+--- dosbox-0.74/src/cpu/lazyflags.h	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/cpu/lazyflags.h	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+diff -Nur dosbox-0.74/src/cpu/Makefile.in dosbox/src/cpu/Makefile.in
+--- dosbox-0.74/src/cpu/Makefile.in	2010-05-12 11:57:43.000000000 +0200
++++ dosbox/src/cpu/Makefile.in	1970-01-01 01:00:00.000000000 +0100
+@@ -1,613 +0,0 @@
+-# Makefile.in generated by automake 1.11.1 from Makefile.am.
+-# @configure_input@
+-
+-# Copyright (C) 1994, 1995, 1996, 1997, 1998, 1999, 2000, 2001, 2002,
+-# 2003, 2004, 2005, 2006, 2007, 2008, 2009  Free Software Foundation,
+-# Inc.
+-# This Makefile.in is free software; the Free Software Foundation
+-# gives unlimited permission to copy and/or distribute it,
+-# with or without modifications, as long as this notice is preserved.
+-
+-# This program is distributed in the hope that it will be useful,
+-# but WITHOUT ANY WARRANTY, to the extent permitted by law; without
+-# even the implied warranty of MERCHANTABILITY or FITNESS FOR A
+-# PARTICULAR PURPOSE.
+-
+-@SET_MAKE@
+-
+-VPATH = @srcdir@
+-pkgdatadir = $(datadir)/@PACKAGE@
+-pkgincludedir = $(includedir)/@PACKAGE@
+-pkglibdir = $(libdir)/@PACKAGE@
+-pkglibexecdir = $(libexecdir)/@PACKAGE@
+-am__cd = CDPATH="$${ZSH_VERSION+.}$(PATH_SEPARATOR)" && cd
+-install_sh_DATA = $(install_sh) -c -m 644
+-install_sh_PROGRAM = $(install_sh) -c
+-install_sh_SCRIPT = $(install_sh) -c
+-INSTALL_HEADER = $(INSTALL_DATA)
+-transform = $(program_transform_name)
+-NORMAL_INSTALL = :
+-PRE_INSTALL = :
+-POST_INSTALL = :
+-NORMAL_UNINSTALL = :
+-PRE_UNINSTALL = :
+-POST_UNINSTALL = :
+-build_triplet = @build@
+-host_triplet = @host@
+-subdir = src/cpu
+-DIST_COMMON = $(srcdir)/Makefile.am $(srcdir)/Makefile.in
+-ACLOCAL_M4 = $(top_srcdir)/aclocal.m4
+-am__aclocal_m4_deps = $(top_srcdir)/acinclude.m4 \
+-	$(top_srcdir)/configure.in
+-am__configure_deps = $(am__aclocal_m4_deps) $(CONFIGURE_DEPENDENCIES) \
+-	$(ACLOCAL_M4)
+-mkinstalldirs = $(install_sh) -d
+-CONFIG_HEADER = $(top_builddir)/config.h
+-CONFIG_CLEAN_FILES =
+-CONFIG_CLEAN_VPATH_FILES =
+-LIBRARIES = $(noinst_LIBRARIES)
+-AR = ar
+-ARFLAGS = cru
+-libcpu_a_AR = $(AR) $(ARFLAGS)
+-libcpu_a_LIBADD =
+-am_libcpu_a_OBJECTS = callback.$(OBJEXT) cpu.$(OBJEXT) flags.$(OBJEXT) \
+-	modrm.$(OBJEXT) core_full.$(OBJEXT) paging.$(OBJEXT) \
+-	core_normal.$(OBJEXT) core_simple.$(OBJEXT) \
+-	core_prefetch.$(OBJEXT) core_dyn_x86.$(OBJEXT) \
+-	core_dynrec.$(OBJEXT)
+-libcpu_a_OBJECTS = $(am_libcpu_a_OBJECTS)
+-DEFAULT_INCLUDES = -I.@am__isrc@ -I$(top_builddir)
+-depcomp = $(SHELL) $(top_srcdir)/depcomp
+-am__depfiles_maybe = depfiles
+-am__mv = mv -f
+-CXXCOMPILE = $(CXX) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) \
+-	$(AM_CPPFLAGS) $(CPPFLAGS) $(AM_CXXFLAGS) $(CXXFLAGS)
+-CXXLD = $(CXX)
+-CXXLINK = $(CXXLD) $(AM_CXXFLAGS) $(CXXFLAGS) $(AM_LDFLAGS) $(LDFLAGS) \
+-	-o $@
+-COMPILE = $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) \
+-	$(CPPFLAGS) $(AM_CFLAGS) $(CFLAGS)
+-CCLD = $(CC)
+-LINK = $(CCLD) $(AM_CFLAGS) $(CFLAGS) $(AM_LDFLAGS) $(LDFLAGS) -o $@
+-SOURCES = $(libcpu_a_SOURCES)
+-DIST_SOURCES = $(libcpu_a_SOURCES)
+-RECURSIVE_TARGETS = all-recursive check-recursive dvi-recursive \
+-	html-recursive info-recursive install-data-recursive \
+-	install-dvi-recursive install-exec-recursive \
+-	install-html-recursive install-info-recursive \
+-	install-pdf-recursive install-ps-recursive install-recursive \
+-	installcheck-recursive installdirs-recursive pdf-recursive \
+-	ps-recursive uninstall-recursive
+-RECURSIVE_CLEAN_TARGETS = mostlyclean-recursive clean-recursive	\
+-  distclean-recursive maintainer-clean-recursive
+-AM_RECURSIVE_TARGETS = $(RECURSIVE_TARGETS:-recursive=) \
+-	$(RECURSIVE_CLEAN_TARGETS:-recursive=) tags TAGS ctags CTAGS \
+-	distdir
+-ETAGS = etags
+-CTAGS = ctags
+-DIST_SUBDIRS = $(SUBDIRS)
+-DISTFILES = $(DIST_COMMON) $(DIST_SOURCES) $(TEXINFOS) $(EXTRA_DIST)
+-am__relativize = \
+-  dir0=`pwd`; \
+-  sed_first='s,^\([^/]*\)/.*$$,\1,'; \
+-  sed_rest='s,^[^/]*/*,,'; \
+-  sed_last='s,^.*/\([^/]*\)$$,\1,'; \
+-  sed_butlast='s,/*[^/]*$$,,'; \
+-  while test -n "$$dir1"; do \
+-    first=`echo "$$dir1" | sed -e "$$sed_first"`; \
+-    if test "$$first" != "."; then \
+-      if test "$$first" = ".."; then \
+-        dir2=`echo "$$dir0" | sed -e "$$sed_last"`/"$$dir2"; \
+-        dir0=`echo "$$dir0" | sed -e "$$sed_butlast"`; \
+-      else \
+-        first2=`echo "$$dir2" | sed -e "$$sed_first"`; \
+-        if test "$$first2" = "$$first"; then \
+-          dir2=`echo "$$dir2" | sed -e "$$sed_rest"`; \
+-        else \
+-          dir2="../$$dir2"; \
+-        fi; \
+-        dir0="$$dir0"/"$$first"; \
+-      fi; \
+-    fi; \
+-    dir1=`echo "$$dir1" | sed -e "$$sed_rest"`; \
+-  done; \
+-  reldir="$$dir2"
+-ACLOCAL = @ACLOCAL@
+-ALSA_CFLAGS = @ALSA_CFLAGS@
+-ALSA_LIBS = @ALSA_LIBS@
+-AMTAR = @AMTAR@
+-AUTOCONF = @AUTOCONF@
+-AUTOHEADER = @AUTOHEADER@
+-AUTOMAKE = @AUTOMAKE@
+-AWK = @AWK@
+-CC = @CC@
+-CCDEPMODE = @CCDEPMODE@
+-CFLAGS = @CFLAGS@
+-CPP = @CPP@
+-CPPFLAGS = @CPPFLAGS@
+-CXX = @CXX@
+-CXXDEPMODE = @CXXDEPMODE@
+-CXXFLAGS = @CXXFLAGS@
+-CYGPATH_W = @CYGPATH_W@
+-DEFS = @DEFS@
+-DEPDIR = @DEPDIR@
+-ECHO_C = @ECHO_C@
+-ECHO_N = @ECHO_N@
+-ECHO_T = @ECHO_T@
+-EGREP = @EGREP@
+-EXEEXT = @EXEEXT@
+-GREP = @GREP@
+-INSTALL = @INSTALL@
+-INSTALL_DATA = @INSTALL_DATA@
+-INSTALL_PROGRAM = @INSTALL_PROGRAM@
+-INSTALL_SCRIPT = @INSTALL_SCRIPT@
+-INSTALL_STRIP_PROGRAM = @INSTALL_STRIP_PROGRAM@
+-LDFLAGS = @LDFLAGS@
+-LIBOBJS = @LIBOBJS@
+-LIBS = @LIBS@
+-LTLIBOBJS = @LTLIBOBJS@
+-MAKEINFO = @MAKEINFO@
+-MKDIR_P = @MKDIR_P@
+-OBJEXT = @OBJEXT@
+-PACKAGE = @PACKAGE@
+-PACKAGE_BUGREPORT = @PACKAGE_BUGREPORT@
+-PACKAGE_NAME = @PACKAGE_NAME@
+-PACKAGE_STRING = @PACKAGE_STRING@
+-PACKAGE_TARNAME = @PACKAGE_TARNAME@
+-PACKAGE_URL = @PACKAGE_URL@
+-PACKAGE_VERSION = @PACKAGE_VERSION@
+-PATH_SEPARATOR = @PATH_SEPARATOR@
+-RANLIB = @RANLIB@
+-SDL_CFLAGS = @SDL_CFLAGS@
+-SDL_CONFIG = @SDL_CONFIG@
+-SDL_LIBS = @SDL_LIBS@
+-SET_MAKE = @SET_MAKE@
+-SHELL = @SHELL@
+-STRIP = @STRIP@
+-VERSION = @VERSION@
+-WINDRES = @WINDRES@
+-abs_builddir = @abs_builddir@
+-abs_srcdir = @abs_srcdir@
+-abs_top_builddir = @abs_top_builddir@
+-abs_top_srcdir = @abs_top_srcdir@
+-ac_ct_CC = @ac_ct_CC@
+-ac_ct_CXX = @ac_ct_CXX@
+-am__include = @am__include@
+-am__leading_dot = @am__leading_dot@
+-am__quote = @am__quote@
+-am__tar = @am__tar@
+-am__untar = @am__untar@
+-bindir = @bindir@
+-build = @build@
+-build_alias = @build_alias@
+-build_cpu = @build_cpu@
+-build_os = @build_os@
+-build_vendor = @build_vendor@
+-builddir = @builddir@
+-datadir = @datadir@
+-datarootdir = @datarootdir@
+-docdir = @docdir@
+-dvidir = @dvidir@
+-exec_prefix = @exec_prefix@
+-host = @host@
+-host_alias = @host_alias@
+-host_cpu = @host_cpu@
+-host_os = @host_os@
+-host_vendor = @host_vendor@
+-htmldir = @htmldir@
+-includedir = @includedir@
+-infodir = @infodir@
+-install_sh = @install_sh@
+-libdir = @libdir@
+-libexecdir = @libexecdir@
+-localedir = @localedir@
+-localstatedir = @localstatedir@
+-mandir = @mandir@
+-mkdir_p = @mkdir_p@
+-oldincludedir = @oldincludedir@
+-pdfdir = @pdfdir@
+-prefix = @prefix@
+-program_transform_name = @program_transform_name@
+-psdir = @psdir@
+-sbindir = @sbindir@
+-sharedstatedir = @sharedstatedir@
+-srcdir = @srcdir@
+-sysconfdir = @sysconfdir@
+-target_alias = @target_alias@
+-top_build_prefix = @top_build_prefix@
+-top_builddir = @top_builddir@
+-top_srcdir = @top_srcdir@
+-SUBDIRS = core_full core_normal core_dyn_x86 core_dynrec
+-AM_CPPFLAGS = -I$(top_srcdir)/include
+-noinst_LIBRARIES = libcpu.a
+-libcpu_a_SOURCES = callback.cpp cpu.cpp flags.cpp modrm.cpp modrm.h core_full.cpp instructions.h	\
+-		   paging.cpp lazyflags.h core_normal.cpp core_simple.cpp core_prefetch.cpp \
+-		   core_dyn_x86.cpp core_dynrec.cpp
+-
+-all: all-recursive
+-
+-.SUFFIXES:
+-.SUFFIXES: .cpp .o .obj
+-$(srcdir)/Makefile.in:  $(srcdir)/Makefile.am  $(am__configure_deps)
+-	@for dep in $?; do \
+-	  case '$(am__configure_deps)' in \
+-	    *$$dep*) \
+-	      ( cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh ) \
+-	        && { if test -f $@; then exit 0; else break; fi; }; \
+-	      exit 1;; \
+-	  esac; \
+-	done; \
+-	echo ' cd $(top_srcdir) && $(AUTOMAKE) --gnu src/cpu/Makefile'; \
+-	$(am__cd) $(top_srcdir) && \
+-	  $(AUTOMAKE) --gnu src/cpu/Makefile
+-.PRECIOUS: Makefile
+-Makefile: $(srcdir)/Makefile.in $(top_builddir)/config.status
+-	@case '$?' in \
+-	  *config.status*) \
+-	    cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh;; \
+-	  *) \
+-	    echo ' cd $(top_builddir) && $(SHELL) ./config.status $(subdir)/$@ $(am__depfiles_maybe)'; \
+-	    cd $(top_builddir) && $(SHELL) ./config.status $(subdir)/$@ $(am__depfiles_maybe);; \
+-	esac;
+-
+-$(top_builddir)/config.status: $(top_srcdir)/configure $(CONFIG_STATUS_DEPENDENCIES)
+-	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
+-
+-$(top_srcdir)/configure:  $(am__configure_deps)
+-	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
+-$(ACLOCAL_M4):  $(am__aclocal_m4_deps)
+-	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
+-$(am__aclocal_m4_deps):
+-
+-clean-noinstLIBRARIES:
+-	-test -z "$(noinst_LIBRARIES)" || rm -f $(noinst_LIBRARIES)
+-libcpu.a: $(libcpu_a_OBJECTS) $(libcpu_a_DEPENDENCIES) 
+-	-rm -f libcpu.a
+-	$(libcpu_a_AR) libcpu.a $(libcpu_a_OBJECTS) $(libcpu_a_LIBADD)
+-	$(RANLIB) libcpu.a
+-
+-mostlyclean-compile:
+-	-rm -f *.$(OBJEXT)
+-
+-distclean-compile:
+-	-rm -f *.tab.c
+-
+-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/callback.Po@am__quote@
+-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/core_dyn_x86.Po@am__quote@
+-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/core_dynrec.Po@am__quote@
+-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/core_full.Po@am__quote@
+-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/core_normal.Po@am__quote@
+-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/core_prefetch.Po@am__quote@
+-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/core_simple.Po@am__quote@
+-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/cpu.Po@am__quote@
+-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/flags.Po@am__quote@
+-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/modrm.Po@am__quote@
+-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/paging.Po@am__quote@
+-
+-.cpp.o:
+-@am__fastdepCXX_TRUE@	$(CXXCOMPILE) -MT $@ -MD -MP -MF $(DEPDIR)/$*.Tpo -c -o $@ $<
+-@am__fastdepCXX_TRUE@	$(am__mv) $(DEPDIR)/$*.Tpo $(DEPDIR)/$*.Po
+-@AMDEP_TRUE@@am__fastdepCXX_FALSE@	source='$<' object='$@' libtool=no @AMDEPBACKSLASH@
+-@AMDEP_TRUE@@am__fastdepCXX_FALSE@	DEPDIR=$(DEPDIR) $(CXXDEPMODE) $(depcomp) @AMDEPBACKSLASH@
+-@am__fastdepCXX_FALSE@	$(CXXCOMPILE) -c -o $@ $<
+-
+-.cpp.obj:
+-@am__fastdepCXX_TRUE@	$(CXXCOMPILE) -MT $@ -MD -MP -MF $(DEPDIR)/$*.Tpo -c -o $@ `$(CYGPATH_W) '$<'`
+-@am__fastdepCXX_TRUE@	$(am__mv) $(DEPDIR)/$*.Tpo $(DEPDIR)/$*.Po
+-@AMDEP_TRUE@@am__fastdepCXX_FALSE@	source='$<' object='$@' libtool=no @AMDEPBACKSLASH@
+-@AMDEP_TRUE@@am__fastdepCXX_FALSE@	DEPDIR=$(DEPDIR) $(CXXDEPMODE) $(depcomp) @AMDEPBACKSLASH@
+-@am__fastdepCXX_FALSE@	$(CXXCOMPILE) -c -o $@ `$(CYGPATH_W) '$<'`
+-
+-# This directory's subdirectories are mostly independent; you can cd
+-# into them and run `make' without going through this Makefile.
+-# To change the values of `make' variables: instead of editing Makefiles,
+-# (1) if the variable is set in `config.status', edit `config.status'
+-#     (which will cause the Makefiles to be regenerated when you run `make');
+-# (2) otherwise, pass the desired values on the `make' command line.
+-$(RECURSIVE_TARGETS):
+-	@fail= failcom='exit 1'; \
+-	for f in x $$MAKEFLAGS; do \
+-	  case $$f in \
+-	    *=* | --[!k]*);; \
+-	    *k*) failcom='fail=yes';; \
+-	  esac; \
+-	done; \
+-	dot_seen=no; \
+-	target=`echo $@ | sed s/-recursive//`; \
+-	list='$(SUBDIRS)'; for subdir in $$list; do \
+-	  echo "Making $$target in $$subdir"; \
+-	  if test "$$subdir" = "."; then \
+-	    dot_seen=yes; \
+-	    local_target="$$target-am"; \
+-	  else \
+-	    local_target="$$target"; \
+-	  fi; \
+-	  ($(am__cd) $$subdir && $(MAKE) $(AM_MAKEFLAGS) $$local_target) \
+-	  || eval $$failcom; \
+-	done; \
+-	if test "$$dot_seen" = "no"; then \
+-	  $(MAKE) $(AM_MAKEFLAGS) "$$target-am" || exit 1; \
+-	fi; test -z "$$fail"
+-
+-$(RECURSIVE_CLEAN_TARGETS):
+-	@fail= failcom='exit 1'; \
+-	for f in x $$MAKEFLAGS; do \
+-	  case $$f in \
+-	    *=* | --[!k]*);; \
+-	    *k*) failcom='fail=yes';; \
+-	  esac; \
+-	done; \
+-	dot_seen=no; \
+-	case "$@" in \
+-	  distclean-* | maintainer-clean-*) list='$(DIST_SUBDIRS)' ;; \
+-	  *) list='$(SUBDIRS)' ;; \
+-	esac; \
+-	rev=''; for subdir in $$list; do \
+-	  if test "$$subdir" = "."; then :; else \
+-	    rev="$$subdir $$rev"; \
+-	  fi; \
+-	done; \
+-	rev="$$rev ."; \
+-	target=`echo $@ | sed s/-recursive//`; \
+-	for subdir in $$rev; do \
+-	  echo "Making $$target in $$subdir"; \
+-	  if test "$$subdir" = "."; then \
+-	    local_target="$$target-am"; \
+-	  else \
+-	    local_target="$$target"; \
+-	  fi; \
+-	  ($(am__cd) $$subdir && $(MAKE) $(AM_MAKEFLAGS) $$local_target) \
+-	  || eval $$failcom; \
+-	done && test -z "$$fail"
+-tags-recursive:
+-	list='$(SUBDIRS)'; for subdir in $$list; do \
+-	  test "$$subdir" = . || ($(am__cd) $$subdir && $(MAKE) $(AM_MAKEFLAGS) tags); \
+-	done
+-ctags-recursive:
+-	list='$(SUBDIRS)'; for subdir in $$list; do \
+-	  test "$$subdir" = . || ($(am__cd) $$subdir && $(MAKE) $(AM_MAKEFLAGS) ctags); \
+-	done
+-
+-ID: $(HEADERS) $(SOURCES) $(LISP) $(TAGS_FILES)
+-	list='$(SOURCES) $(HEADERS) $(LISP) $(TAGS_FILES)'; \
+-	unique=`for i in $$list; do \
+-	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
+-	  done | \
+-	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
+-	      END { if (nonempty) { for (i in files) print i; }; }'`; \
+-	mkid -fID $$unique
+-tags: TAGS
+-
+-TAGS: tags-recursive $(HEADERS) $(SOURCES)  $(TAGS_DEPENDENCIES) \
+-		$(TAGS_FILES) $(LISP)
+-	set x; \
+-	here=`pwd`; \
+-	if ($(ETAGS) --etags-include --version) >/dev/null 2>&1; then \
+-	  include_option=--etags-include; \
+-	  empty_fix=.; \
+-	else \
+-	  include_option=--include; \
+-	  empty_fix=; \
+-	fi; \
+-	list='$(SUBDIRS)'; for subdir in $$list; do \
+-	  if test "$$subdir" = .; then :; else \
+-	    test ! -f $$subdir/TAGS || \
+-	      set "$$@" "$$include_option=$$here/$$subdir/TAGS"; \
+-	  fi; \
+-	done; \
+-	list='$(SOURCES) $(HEADERS)  $(LISP) $(TAGS_FILES)'; \
+-	unique=`for i in $$list; do \
+-	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
+-	  done | \
+-	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
+-	      END { if (nonempty) { for (i in files) print i; }; }'`; \
+-	shift; \
+-	if test -z "$(ETAGS_ARGS)$$*$$unique"; then :; else \
+-	  test -n "$$unique" || unique=$$empty_fix; \
+-	  if test $$# -gt 0; then \
+-	    $(ETAGS) $(ETAGSFLAGS) $(AM_ETAGSFLAGS) $(ETAGS_ARGS) \
+-	      "$$@" $$unique; \
+-	  else \
+-	    $(ETAGS) $(ETAGSFLAGS) $(AM_ETAGSFLAGS) $(ETAGS_ARGS) \
+-	      $$unique; \
+-	  fi; \
+-	fi
+-ctags: CTAGS
+-CTAGS: ctags-recursive $(HEADERS) $(SOURCES)  $(TAGS_DEPENDENCIES) \
+-		$(TAGS_FILES) $(LISP)
+-	list='$(SOURCES) $(HEADERS)  $(LISP) $(TAGS_FILES)'; \
+-	unique=`for i in $$list; do \
+-	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
+-	  done | \
+-	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
+-	      END { if (nonempty) { for (i in files) print i; }; }'`; \
+-	test -z "$(CTAGS_ARGS)$$unique" \
+-	  || $(CTAGS) $(CTAGSFLAGS) $(AM_CTAGSFLAGS) $(CTAGS_ARGS) \
+-	     $$unique
+-
+-GTAGS:
+-	here=`$(am__cd) $(top_builddir) && pwd` \
+-	  && $(am__cd) $(top_srcdir) \
+-	  && gtags -i $(GTAGS_ARGS) "$$here"
+-
+-distclean-tags:
+-	-rm -f TAGS ID GTAGS GRTAGS GSYMS GPATH tags
+-
+-distdir: $(DISTFILES)
+-	@srcdirstrip=`echo "$(srcdir)" | sed 's/[].[^$$\\*]/\\\\&/g'`; \
+-	topsrcdirstrip=`echo "$(top_srcdir)" | sed 's/[].[^$$\\*]/\\\\&/g'`; \
+-	list='$(DISTFILES)'; \
+-	  dist_files=`for file in $$list; do echo $$file; done | \
+-	  sed -e "s|^$$srcdirstrip/||;t" \
+-	      -e "s|^$$topsrcdirstrip/|$(top_builddir)/|;t"`; \
+-	case $$dist_files in \
+-	  */*) $(MKDIR_P) `echo "$$dist_files" | \
+-			   sed '/\//!d;s|^|$(distdir)/|;s,/[^/]*$$,,' | \
+-			   sort -u` ;; \
+-	esac; \
+-	for file in $$dist_files; do \
+-	  if test -f $$file || test -d $$file; then d=.; else d=$(srcdir); fi; \
+-	  if test -d $$d/$$file; then \
+-	    dir=`echo "/$$file" | sed -e 's,/[^/]*$$,,'`; \
+-	    if test -d "$(distdir)/$$file"; then \
+-	      find "$(distdir)/$$file" -type d ! -perm -700 -exec chmod u+rwx {} \;; \
+-	    fi; \
+-	    if test -d $(srcdir)/$$file && test $$d != $(srcdir); then \
+-	      cp -fpR $(srcdir)/$$file "$(distdir)$$dir" || exit 1; \
+-	      find "$(distdir)/$$file" -type d ! -perm -700 -exec chmod u+rwx {} \;; \
+-	    fi; \
+-	    cp -fpR $$d/$$file "$(distdir)$$dir" || exit 1; \
+-	  else \
+-	    test -f "$(distdir)/$$file" \
+-	    || cp -p $$d/$$file "$(distdir)/$$file" \
+-	    || exit 1; \
+-	  fi; \
+-	done
+-	@list='$(DIST_SUBDIRS)'; for subdir in $$list; do \
+-	  if test "$$subdir" = .; then :; else \
+-	    test -d "$(distdir)/$$subdir" \
+-	    || $(MKDIR_P) "$(distdir)/$$subdir" \
+-	    || exit 1; \
+-	  fi; \
+-	done
+-	@list='$(DIST_SUBDIRS)'; for subdir in $$list; do \
+-	  if test "$$subdir" = .; then :; else \
+-	    dir1=$$subdir; dir2="$(distdir)/$$subdir"; \
+-	    $(am__relativize); \
+-	    new_distdir=$$reldir; \
+-	    dir1=$$subdir; dir2="$(top_distdir)"; \
+-	    $(am__relativize); \
+-	    new_top_distdir=$$reldir; \
+-	    echo " (cd $$subdir && $(MAKE) $(AM_MAKEFLAGS) top_distdir="$$new_top_distdir" distdir="$$new_distdir" \\"; \
+-	    echo "     am__remove_distdir=: am__skip_length_check=: am__skip_mode_fix=: distdir)"; \
+-	    ($(am__cd) $$subdir && \
+-	      $(MAKE) $(AM_MAKEFLAGS) \
+-	        top_distdir="$$new_top_distdir" \
+-	        distdir="$$new_distdir" \
+-		am__remove_distdir=: \
+-		am__skip_length_check=: \
+-		am__skip_mode_fix=: \
+-	        distdir) \
+-	      || exit 1; \
+-	  fi; \
+-	done
+-check-am: all-am
+-check: check-recursive
+-all-am: Makefile $(LIBRARIES)
+-installdirs: installdirs-recursive
+-installdirs-am:
+-install: install-recursive
+-install-exec: install-exec-recursive
+-install-data: install-data-recursive
+-uninstall: uninstall-recursive
+-
+-install-am: all-am
+-	@$(MAKE) $(AM_MAKEFLAGS) install-exec-am install-data-am
+-
+-installcheck: installcheck-recursive
+-install-strip:
+-	$(MAKE) $(AM_MAKEFLAGS) INSTALL_PROGRAM="$(INSTALL_STRIP_PROGRAM)" \
+-	  install_sh_PROGRAM="$(INSTALL_STRIP_PROGRAM)" INSTALL_STRIP_FLAG=-s \
+-	  `test -z '$(STRIP)' || \
+-	    echo "INSTALL_PROGRAM_ENV=STRIPPROG='$(STRIP)'"` install
+-mostlyclean-generic:
+-
+-clean-generic:
+-
+-distclean-generic:
+-	-test -z "$(CONFIG_CLEAN_FILES)" || rm -f $(CONFIG_CLEAN_FILES)
+-	-test . = "$(srcdir)" || test -z "$(CONFIG_CLEAN_VPATH_FILES)" || rm -f $(CONFIG_CLEAN_VPATH_FILES)
+-
+-maintainer-clean-generic:
+-	@echo "This command is intended for maintainers to use"
+-	@echo "it deletes files that may require special tools to rebuild."
+-clean: clean-recursive
+-
+-clean-am: clean-generic clean-noinstLIBRARIES mostlyclean-am
+-
+-distclean: distclean-recursive
+-	-rm -rf ./$(DEPDIR)
+-	-rm -f Makefile
+-distclean-am: clean-am distclean-compile distclean-generic \
+-	distclean-tags
+-
+-dvi: dvi-recursive
+-
+-dvi-am:
+-
+-html: html-recursive
+-
+-html-am:
+-
+-info: info-recursive
+-
+-info-am:
+-
+-install-data-am:
+-
+-install-dvi: install-dvi-recursive
+-
+-install-dvi-am:
+-
+-install-exec-am:
+-
+-install-html: install-html-recursive
+-
+-install-html-am:
+-
+-install-info: install-info-recursive
+-
+-install-info-am:
+-
+-install-man:
+-
+-install-pdf: install-pdf-recursive
+-
+-install-pdf-am:
+-
+-install-ps: install-ps-recursive
+-
+-install-ps-am:
+-
+-installcheck-am:
+-
+-maintainer-clean: maintainer-clean-recursive
+-	-rm -rf ./$(DEPDIR)
+-	-rm -f Makefile
+-maintainer-clean-am: distclean-am maintainer-clean-generic
+-
+-mostlyclean: mostlyclean-recursive
+-
+-mostlyclean-am: mostlyclean-compile mostlyclean-generic
+-
+-pdf: pdf-recursive
+-
+-pdf-am:
+-
+-ps: ps-recursive
+-
+-ps-am:
+-
+-uninstall-am:
+-
+-.MAKE: $(RECURSIVE_CLEAN_TARGETS) $(RECURSIVE_TARGETS) ctags-recursive \
+-	install-am install-strip tags-recursive
+-
+-.PHONY: $(RECURSIVE_CLEAN_TARGETS) $(RECURSIVE_TARGETS) CTAGS GTAGS \
+-	all all-am check check-am clean clean-generic \
+-	clean-noinstLIBRARIES ctags ctags-recursive distclean \
+-	distclean-compile distclean-generic distclean-tags distdir dvi \
+-	dvi-am html html-am info info-am install install-am \
+-	install-data install-data-am install-dvi install-dvi-am \
+-	install-exec install-exec-am install-html install-html-am \
+-	install-info install-info-am install-man install-pdf \
+-	install-pdf-am install-ps install-ps-am install-strip \
+-	installcheck installcheck-am installdirs installdirs-am \
+-	maintainer-clean maintainer-clean-generic mostlyclean \
+-	mostlyclean-compile mostlyclean-generic pdf pdf-am ps ps-am \
+-	tags tags-recursive uninstall uninstall-am
+-
+-
+-# Tell versions [3.59,3.63) of GNU make to not export all variables.
+-# Otherwise a system limit (for SysV at least) may be exceeded.
+-.NOEXPORT:
+diff -Nur dosbox-0.74/src/cpu/modrm.cpp dosbox/src/cpu/modrm.cpp
+--- dosbox-0.74/src/cpu/modrm.cpp	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/cpu/modrm.cpp	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+diff -Nur dosbox-0.74/src/cpu/modrm.h dosbox/src/cpu/modrm.h
+--- dosbox-0.74/src/cpu/modrm.h	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/cpu/modrm.h	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+diff -Nur dosbox-0.74/src/cpu/paging.cpp dosbox/src/cpu/paging.cpp
+--- dosbox-0.74/src/cpu/paging.cpp	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/cpu/paging.cpp	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,7 +16,6 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: paging.cpp,v 1.36 2009-05-27 09:15:41 qbix79 Exp $ */
+ 
+ #include <stdlib.h>
+ #include <assert.h>
+@@ -44,16 +43,16 @@
+ 	return 0;
+ }
+ Bitu PageHandler::readw(PhysPt addr) {
+-	return 
+-		(readb(addr+0) << 0) |
+-		(readb(addr+1) << 8);
++	Bitu ret = (readb(addr+0) << 0);
++	ret     |= (readb(addr+1) << 8);
++	return ret;
+ }
+ Bitu PageHandler::readd(PhysPt addr) {
+-	return 
+-		(readb(addr+0) << 0)  |
+-		(readb(addr+1) << 8)  |
+-		(readb(addr+2) << 16) |
+-		(readb(addr+3) << 24);
++	Bitu ret = (readb(addr+0) << 0);
++	ret     |= (readb(addr+1) << 8);
++	ret     |= (readb(addr+2) << 16);
++	ret     |= (readb(addr+3) << 24);
++	return ret;
+ }
+ 
+ void PageHandler::writeb(PhysPt addr,Bitu /*val*/) {
+@@ -850,7 +849,7 @@
+ }
+ 
+ void PAGING_Enable(bool enabled) {
+-	/* If paging is disable we work from a default paging table */
++	/* If paging is disabled, we work from a default paging table */
+ 	if (paging.enabled==enabled) return;
+ 	paging.enabled=enabled;
+ 	if (enabled) {
+diff -Nur dosbox-0.74/src/debug/debug.cpp dosbox/src/debug/debug.cpp
+--- dosbox-0.74/src/debug/debug.cpp	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/debug/debug.cpp	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,7 +16,6 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: debug.cpp,v 1.97 2009-04-11 19:49:52 c2woody Exp $ */
+ 
+ #include "dosbox.h"
+ #if C_DEBUG
+@@ -62,8 +61,8 @@
+ // Forwards
+ static void DrawCode(void);
+ static void DEBUG_RaiseTimerIrq(void);
+-static void SaveMemory(Bitu seg, Bitu ofs1, Bit32u num);
+-static void SaveMemoryBin(Bitu seg, Bitu ofs1, Bit32u num);
++static void SaveMemory(Bit16u seg, Bit32u ofs1, Bit32u num);
++static void SaveMemoryBin(Bit16u seg, Bit32u ofs1, Bit32u num);
+ static void LogMCBS(void);
+ static void LogGDT(void);
+ static void LogLDT(void);
+@@ -76,6 +75,7 @@
+ char* AnalyzeInstruction(char* inst, bool saveSelector);
+ Bit32u GetHexValue(char* str, char*& hex);
+ 
++#if 0
+ class DebugPageHandler : public PageHandler {
+ public:
+ 	Bitu readb(PhysPt /*addr*/) {
+@@ -90,10 +90,8 @@
+ 	}
+ 	void writed(PhysPt /*addr*/,Bitu /*val*/) {
+ 	}
+-
+-
+-
+ };
++#endif
+ 
+ 
+ class DEBUG;
+@@ -123,7 +121,6 @@
+ static Segment oldsegs[6];
+ static Bitu oldflags,oldcpucpl;
+ DBGBlock dbg;
+-static Bitu input_count;
+ Bitu cycle_count;
+ static bool debugging;
+ 
+@@ -136,23 +133,34 @@
+ 	}
+ }
+ 
++#define MAXCMDLEN 254 
+ struct SCodeViewData {	
+-	int		cursorPos;
++	int     cursorPos;
+ 	Bit16u  firstInstSize;
+-	Bit16u	useCS;
+-	Bit32u	useEIPlast, useEIPmid;
+-	Bit32u	useEIP;
++	Bit16u  useCS;
++	Bit32u  useEIPlast, useEIPmid;
++	Bit32u  useEIP;
+ 	Bit16u  cursorSeg;
+-	Bit32u	cursorOfs;
+-	bool	inputMode;
+-	char	inputStr[255];
+-	char	prevInputStr[255];
+-
++	Bit32u  cursorOfs;
++	bool    ovrMode;
++	char    inputStr[MAXCMDLEN+1];
++	char    suspInputStr[MAXCMDLEN+1];
++	int     inputPos;
+ } codeViewData;
+ 
+-static Bit16u	dataSeg;
+-static Bit32u	dataOfs;
+-static bool		showExtend = true;
++static Bit16u  dataSeg;
++static Bit32u  dataOfs;
++static bool    showExtend = true;
++
++static void ClearInputLine(void) {
++	codeViewData.inputStr[0] = 0;
++	codeViewData.inputPos = 0;
++}
++
++// History stuff
++#define MAX_HIST_BUFFER 50
++static list<string> histBuff;
++static list<string>::iterator histBuffPos = histBuff.end();
+ 
+ /***********/
+ /* Helpers */
+@@ -273,32 +281,34 @@
+ public:
+ 
+ 	CBreakpoint(void);
+-	void					SetAddress		(Bit16u seg, Bit32u off)	{ location = GetAddress(seg,off);	type = BKPNT_PHYSICAL; segment = seg; offset = off; };
+-	void					SetAddress		(PhysPt adr)				{ location = adr;				type = BKPNT_PHYSICAL; };
+-	void					SetInt			(Bit8u _intNr, Bit16u ah)	{ intNr = _intNr, ahValue = ah; type = BKPNT_INTERRUPT; };
++	void					SetAddress		(Bit16u seg, Bit32u off)	{ location = GetAddress(seg,off); type = BKPNT_PHYSICAL; segment = seg; offset = off; };
++	void					SetAddress		(PhysPt adr)				{ location = adr; type = BKPNT_PHYSICAL; };
++	void					SetInt			(Bit8u _intNr, Bit16u ah, Bit16u al)	{ intNr = _intNr, ahValue = ah; alValue = al; type = BKPNT_INTERRUPT; };
+ 	void					SetOnce			(bool _once)				{ once = _once; };
+ 	void					SetType			(EBreakpoint _type)			{ type = _type; };
+ 	void					SetValue		(Bit8u value)				{ ahValue = value; };
++	void					SetOther		(Bit8u other)				{ alValue = other; };
+ 
+ 	bool					IsActive		(void)						{ return active; };
+ 	void					Activate		(bool _active);
+ 
+ 	EBreakpoint				GetType			(void)						{ return type; };
+ 	bool					GetOnce			(void)						{ return once; };
+-	PhysPt					GetLocation		(void)						{ if (GetType()!=BKPNT_INTERRUPT)	return location;	else return 0; };
++	PhysPt					GetLocation		(void)						{ return location; };
+ 	Bit16u					GetSegment		(void)						{ return segment; };
+ 	Bit32u					GetOffset		(void)						{ return offset; };
+-	Bit8u					GetIntNr		(void)						{ if (GetType()==BKPNT_INTERRUPT)	return intNr;		else return 0; };
+-	Bit16u					GetValue		(void)						{ if (GetType()!=BKPNT_PHYSICAL)	return ahValue;		else return 0; };
++	Bit8u					GetIntNr		(void)						{ return intNr; };
++	Bit16u					GetValue		(void)						{ return ahValue; };
++	Bit16u					GetOther		(void)						{ return alValue; };
+ 
+ 	// statics
+ 	static CBreakpoint*		AddBreakpoint		(Bit16u seg, Bit32u off, bool once);
+-	static CBreakpoint*		AddIntBreakpoint	(Bit8u intNum, Bit16u ah, bool once);
++	static CBreakpoint*		AddIntBreakpoint	(Bit8u intNum, Bit16u ah, Bit16u al, bool once);
+ 	static CBreakpoint*		AddMemBreakpoint	(Bit16u seg, Bit32u off);
+ 	static void				ActivateBreakpoints	(PhysPt adr, bool activate);
+ 	static bool				CheckBreakpoint		(PhysPt adr);
+ 	static bool				CheckBreakpoint		(Bitu seg, Bitu off);
+-	static bool				CheckIntBreakpoint	(PhysPt adr, Bit8u intNr, Bit16u ahValue);
++	static bool				CheckIntBreakpoint	(PhysPt adr, Bit8u intNr, Bit16u ahValue, Bit16u alValue);
+ 	static bool				IsBreakpoint		(PhysPt where);
+ 	static bool				IsBreakpointDrawn	(PhysPt where);
+ 	static bool				DeleteBreakpoint	(PhysPt where);
+@@ -317,6 +327,7 @@
+ 	// Int
+ 	Bit8u		intNr;
+ 	Bit16u		ahValue;
++	Bit16u		alValue;
+ 	// Shared
+ 	bool		active;
+ 	bool		once;
+@@ -329,7 +340,7 @@
+ CBreakpoint::CBreakpoint(void):
+ location(0),
+ active(false),once(false),
+-segment(0),offset(0),intNr(0),ahValue(0),
++segment(0),offset(0),intNr(0),ahValue(0),alValue(0),
+ type(BKPNT_UNKNOWN) { };
+ 
+ void CBreakpoint::Activate(bool _active)
+@@ -357,7 +368,7 @@
+ // Statics
+ std::list<CBreakpoint*> CBreakpoint::BPoints;
+ CBreakpoint*			CBreakpoint::ignoreOnce = 0;
+-Bitu					ignoreAddressOnce = 0;
++PhysPt					ignoreAddressOnce = 0;
+ 
+ CBreakpoint* CBreakpoint::AddBreakpoint(Bit16u seg, Bit32u off, bool once)
+ {
+@@ -368,10 +379,10 @@
+ 	return bp;
+ };
+ 
+-CBreakpoint* CBreakpoint::AddIntBreakpoint(Bit8u intNum, Bit16u ah, bool once)
++CBreakpoint* CBreakpoint::AddIntBreakpoint(Bit8u intNum, Bit16u ah, Bit16u al, bool once)
+ {
+ 	CBreakpoint* bp = new CBreakpoint();
+-	bp->SetInt			(intNum,ah);
++	bp->SetInt			(intNum,ah,al);
+ 	bp->SetOnce			(once);
+ 	BPoints.push_front	(bp);
+ 	return bp;
+@@ -394,7 +405,7 @@
+ 	CBreakpoint* bp;
+ 	for(i=BPoints.begin(); i != BPoints.end(); i++) {
+ 		bp = (*i);
+-		// Do not activate, when bp is an actual adress
++		// Do not activate, when bp is an actual address
+ 		if (activate && (bp->GetType()==BKPNT_PHYSICAL) && (bp->GetLocation()==adr)) {
+ 			// Do not activate :)
+ 			continue;
+@@ -404,7 +415,7 @@
+ };
+ 
+ bool CBreakpoint::CheckBreakpoint(Bitu seg, Bitu off)
+-// Checks if breakpoint is valid an should stop execution
++// Checks if breakpoint is valid and should stop execution
+ {
+ 	if ((ignoreAddressOnce!=0) && (GetAddress(seg,off)==ignoreAddressOnce)) {
+ 		ignoreAddressOnce = 0;
+@@ -467,8 +478,8 @@
+ 	return false;
+ };
+ 
+-bool CBreakpoint::CheckIntBreakpoint(PhysPt adr, Bit8u intNr, Bit16u ahValue)
+-// Checks if interrupt breakpoint is valid an should stop execution
++bool CBreakpoint::CheckIntBreakpoint(PhysPt adr, Bit8u intNr, Bit16u ahValue, Bit16u alValue)
++// Checks if interrupt breakpoint is valid and should stop execution
+ {
+ 	if ((ignoreAddressOnce!=0) && (adr==ignoreAddressOnce)) {
+ 		ignoreAddressOnce = 0;
+@@ -482,8 +493,8 @@
+ 	for(i=BPoints.begin(); i != BPoints.end(); i++) {
+ 		bp = (*i);
+ 		if ((bp->GetType()==BKPNT_INTERRUPT) && bp->IsActive() && (bp->GetIntNr()==intNr)) {
+-			if ((bp->GetValue()==BPINT_ALL) || (bp->GetValue()==ahValue)) {
+-				// Ignoie it once ?
++			if (((bp->GetValue()==BPINT_ALL) || (bp->GetValue()==ahValue)) && ((bp->GetOther()==BPINT_ALL) || (bp->GetOther()==alValue))) {
++				// Ignore it once ?
+ 				if (ignoreOnce==bp) {
+ 					ignoreOnce=0;
+ 					bp->Activate(true);
+@@ -598,8 +609,9 @@
+ 		if (bp->GetType()==BKPNT_PHYSICAL) {
+ 			DEBUG_ShowMsg("%02X. BP %04X:%04X\n",nr,bp->GetSegment(),bp->GetOffset());
+ 		} else if (bp->GetType()==BKPNT_INTERRUPT) {
+-			if (bp->GetValue()==BPINT_ALL)	DEBUG_ShowMsg("%02X. BPINT %02X\n",nr,bp->GetIntNr());					
+-			else							DEBUG_ShowMsg("%02X. BPINT %02X AH=%02X\n",nr,bp->GetIntNr(),bp->GetValue());
++			if (bp->GetValue()==BPINT_ALL) DEBUG_ShowMsg("%02X. BPINT %02X\n",nr,bp->GetIntNr());
++			else if (bp->GetOther()==BPINT_ALL) DEBUG_ShowMsg("%02X. BPINT %02X AH=%02X\n",nr,bp->GetIntNr(),bp->GetValue());
++			else DEBUG_ShowMsg("%02X. BPINT %02X AH=%02X AL=%02X\n",nr,bp->GetIntNr(),bp->GetValue(),bp->GetOther());
+ 		} else if (bp->GetType()==BKPNT_MEMORY) {
+ 			DEBUG_ShowMsg("%02X. BPMEM %04X:%04X (%02X)\n",nr,bp->GetSegment(),bp->GetOffset(),bp->GetValue());
+ 		} else if (bp->GetType()==BKPNT_MEMORY_PROT) {
+@@ -613,7 +625,7 @@
+ 
+ bool DEBUG_Breakpoint(void)
+ {
+-	/* First get the phyiscal address and check for a set Breakpoint */
++	/* First get the physical address and check for a set Breakpoint */
+ 	if (!CBreakpoint::CheckBreakpoint(SegValue(cs),reg_eip)) return false;
+ 	// Found. Breakpoint is valid
+ 	PhysPt where=GetAddress(SegValue(cs),reg_eip);
+@@ -623,9 +635,9 @@
+ 
+ bool DEBUG_IntBreakpoint(Bit8u intNum)
+ {
+-	/* First get the phyiscal address and check for a set Breakpoint */
++	/* First get the physical address and check for a set Breakpoint */
+ 	PhysPt where=GetAddress(SegValue(cs),reg_eip);
+-	if (!CBreakpoint::CheckIntBreakpoint(where,intNum,reg_ah)) return false;
++	if (!CBreakpoint::CheckIntBreakpoint(where,intNum,reg_ah,reg_al)) return false;
+ 	// Found. Breakpoint is valid
+ 	CBreakpoint::ActivateBreakpoints(where,false);	// Deactivate all breakpoints
+ 	return true;
+@@ -673,7 +685,7 @@
+ 	Bit32u address;
+ 	/* Data win */	
+ 	for (int y=0; y<8; y++) {
+-		// Adress
++		// Address
+ 		if (add<0x10000) mvwprintw (dbg.win_data,1+y,0,"%04X:%04X     ",dataSeg,add);
+ 		else mvwprintw (dbg.win_data,1+y,0,"%04X:%08X ",dataSeg,add);
+ 		for (int x=0; x<16; x++) {
+@@ -775,6 +787,8 @@
+ 				wattrset(dbg.win_code,COLOR_PAIR(PAIR_GREEN_BLACK));			
+ 				if (codeViewData.cursorPos==-1) {
+ 					codeViewData.cursorPos = i; // Set Cursor 
++				}
++				if (i == codeViewData.cursorPos) {
+ 					codeViewData.cursorSeg = SegValue(cs);
+ 					codeViewData.cursorOfs = disEIP;
+ 				}
+@@ -837,12 +851,18 @@
+ 	
+ 	wattrset(dbg.win_code,0);			
+ 	if (!debugging) {
+-		mvwprintw(dbg.win_code,10,0,"(Running)",codeViewData.inputStr);
+-	} else { 
+-		if(!*codeViewData.inputStr) { //Clear old commands
+-			mvwprintw(dbg.win_code,10,0,"                                                                            ");
+-		}
+-		mvwprintw(dbg.win_code,10,0,"-> %s_  ",codeViewData.inputStr);
++		mvwprintw(dbg.win_code,10,0,"%s","(Running)");
++		wclrtoeol(dbg.win_code);
++	} else {
++		//TODO long lines
++		char* dispPtr = codeViewData.inputStr; 
++		char* curPtr = &codeViewData.inputStr[codeViewData.inputPos];
++		mvwprintw(dbg.win_code,10,0,"%c-> %s%c",
++			(codeViewData.ovrMode?'O':'I'),dispPtr,(*curPtr?' ':'_'));
++		wclrtoeol(dbg.win_code); // not correct in pdcurses if full line
++		if (*curPtr) {
++			mvwchgat(dbg.win_code,10,(curPtr-dispPtr+4),1,0,(PAIR_BLACK_GREY),NULL);
++ 		} 
+ 	}
+ 
+ 	wrefresh(dbg.win_code);
+@@ -973,7 +993,7 @@
+ 		return true;
+ 	};
+ 
+-	if (command == "MEMDUMPBIN") { // Dump memory to file bineary
++	if (command == "MEMDUMPBIN") { // Dump memory to file binary
+ 		Bit16u seg = (Bit16u)GetHexValue(found,found); found++;
+ 		Bit32u ofs = GetHexValue(found,found); found++;
+ 		Bit32u num = GetHexValue(found,found); found++;
+@@ -1021,6 +1041,11 @@
+ 		return true;
+ 	};
+ 
++	if (command == "ADDLOG") {
++		if(found && *found)	DEBUG_ShowMsg("NOTICE: %s\n",found);
++		return true;
++	};
++
+ 	if (command == "SR") { // Set register value
+ 		DEBUG_ShowMsg("DEBUG: Set Register %s.\n",(ChangeRegister(found)?"success":"failure"));
+ 		return true;
+@@ -1084,14 +1109,21 @@
+ 
+ 	if (command == "BPINT") { // Add Interrupt Breakpoint
+ 		Bit8u intNr	= (Bit8u)GetHexValue(found,found);
+-		bool all = !(*found);found++;
+-		Bit8u valAH	= (Bit8u)GetHexValue(found,found);
++		bool all = !(*found);
++		Bit8u valAH = (Bit8u)GetHexValue(found,found);
+ 		if ((valAH==0x00) && (*found=='*' || all)) {
+-			CBreakpoint::AddIntBreakpoint(intNr,BPINT_ALL,false);
++			CBreakpoint::AddIntBreakpoint(intNr,BPINT_ALL,BPINT_ALL,false);
+ 			DEBUG_ShowMsg("DEBUG: Set interrupt breakpoint at INT %02X\n",intNr);
+ 		} else {
+-			CBreakpoint::AddIntBreakpoint(intNr,valAH,false);
+-			DEBUG_ShowMsg("DEBUG: Set interrupt breakpoint at INT %02X AH=%02X\n",intNr,valAH);
++			all = !(*found);
++			Bit8u valAL = (Bit8u)GetHexValue(found,found);
++			if ((valAL==0x00) && (*found=='*' || all)) {
++				CBreakpoint::AddIntBreakpoint(intNr,valAH,BPINT_ALL,false);
++				DEBUG_ShowMsg("DEBUG: Set interrupt breakpoint at INT %02X AH=%02X\n",intNr,valAH);
++			} else {
++				CBreakpoint::AddIntBreakpoint(intNr,valAH,valAL,false);
++				DEBUG_ShowMsg("DEBUG: Set interrupt breakpoint at INT %02X AH=%02X AL=%02X\n",intNr,valAH,valAL);
++			}
+ 		}
+ 		return true;
+ 	};
+@@ -1121,6 +1153,7 @@
+ 		DEBUG_ShowMsg("DEBUG: Set code overview to %04X:%04X\n",codeSeg,codeOfs);
+ 		codeViewData.useCS	= codeSeg;
+ 		codeViewData.useEIP = codeOfs;
++		codeViewData.cursorPos = 0;
+ 		return true;
+ 	};
+ 
+@@ -1226,6 +1259,7 @@
+ 			DEBUG_ShowMsg("DEBUG: Set code overview to interrupt handler %X\n",intNr);
+ 			codeViewData.useCS	= mem_readw(intNr*4+2);
+ 			codeViewData.useEIP = mem_readw(intNr*4);
++			codeViewData.cursorPos = 0;
+ 			return true;
+ 		}
+ 	};
+@@ -1259,7 +1293,8 @@
+ 	if (command == "HELP" || command == "?") {
+ 		DEBUG_ShowMsg("Debugger commands (enter all values in hex or as register):\n");
+ 		DEBUG_ShowMsg("--------------------------------------------------------------------------\n");
+-		DEBUG_ShowMsg("F3/F6                     - Re-enter previous command.\n");
++		DEBUG_ShowMsg("F3/F6                     - Previous command in history.\n");
++		DEBUG_ShowMsg("F4/F7                     - Next command in history.\n");
+ 		DEBUG_ShowMsg("F5                        - Run.\n");
+ 		DEBUG_ShowMsg("F9                        - Set/Remove breakpoint.\n");
+ 		DEBUG_ShowMsg("F10/F11                   - Step over / trace into instruction.\n");
+@@ -1270,7 +1305,8 @@
+ 		DEBUG_ShowMsg("Home/End                  - Scroll log messages.\n");
+ 		DEBUG_ShowMsg("BP     [segment]:[offset] - Set breakpoint.\n");
+ 		DEBUG_ShowMsg("BPINT  [intNr] *          - Set interrupt breakpoint.\n");
+-		DEBUG_ShowMsg("BPINT  [intNr] [ah]       - Set interrupt breakpoint with ah.\n");
++		DEBUG_ShowMsg("BPINT  [intNr] [ah] *     - Set interrupt breakpoint with ah.\n");
++		DEBUG_ShowMsg("BPINT  [intNr] [ah] [al]  - Set interrupt breakpoint with ah and al.\n");
+ #if C_HEAVY_DEBUG
+ 		DEBUG_ShowMsg("BPM    [segment]:[offset] - Set memory breakpoint (memory change).\n");
+ 		DEBUG_ShowMsg("BPPM   [selector]:[offset]- Set pmode-memory breakpoint (memory change).\n");
+@@ -1285,7 +1321,7 @@
+ 		DEBUG_ShowMsg("LOG [num]                 - Write cpu log file.\n");
+ 		DEBUG_ShowMsg("LOGS/LOGL [num]           - Write short/long cpu log file.\n");
+ 		DEBUG_ShowMsg("HEAVYLOG                  - Enable/Disable automatic cpu log when dosbox exits.\n");
+-		DEBUG_ShowMsg("ZEROPROTECT               - Enable/Disable zero code execution detecion.\n");
++		DEBUG_ShowMsg("ZEROPROTECT               - Enable/Disable zero code execution detection.\n");
+ #endif
+ 		DEBUG_ShowMsg("SR [reg] [value]          - Set register value.\n");
+ 		DEBUG_ShowMsg("SM [seg]:[off] [val] [.]..- Set memory with following values.\n");	
+@@ -1294,6 +1330,8 @@
+ 		DEBUG_ShowMsg("SV [filename]             - Save var list in file.\n");
+ 		DEBUG_ShowMsg("LV [filename]             - Load var list from file.\n");
+ 
++		DEBUG_ShowMsg("ADDLOG [message]          - Add message to the log file.\n");
++
+ 		DEBUG_ShowMsg("MEMDUMP [seg]:[off] [len] - Write memory to file memdump.txt.\n");
+ 		DEBUG_ShowMsg("MEMDUMPBIN [s]:[o] [len]  - Write memory to file memdump.bin.\n");
+ 		DEBUG_ShowMsg("SELINFO [segName]         - Show selector info.\n");
+@@ -1383,7 +1421,7 @@
+ 		// Variable found ?
+ 		CDebugVar* var = CDebugVar::FindVar(address);
+ 		if (var) {
+-			// Replace occurance
++			// Replace occurrence
+ 			char* pos1 = strchr(inst,'[');
+ 			char* pos2 = strchr(inst,']');
+ 			if (pos1 && pos2) {
+@@ -1476,12 +1514,12 @@
+ 		if (jmp) {
+ 			pos = strchr(instu,'$');
+ 			if (pos) {
+-			pos = strchr(instu,'+');
+-			if (pos) {
+-				strcpy(result,"(down)");
+-			} else {
+-				strcpy(result,"(up)");
+-			}
++				pos = strchr(instu,'+');
++				if (pos) {
++					strcpy(result,"(down)");
++				} else {
++					strcpy(result,"(up)");
++				}
+ 			}
+ 		} else {
+ 			sprintf(result,"(no jmp)");
+@@ -1497,6 +1535,11 @@
+ 	if (key>0) {
+ #if defined(WIN32) && defined(__PDCURSES__)
+ 		switch (key) {
++		case PADENTER:	key=0x0A;	break;
++		case PADSLASH:	key='/';	break;
++		case PADSTAR:	key='*';	break;
++		case PADMINUS:	key='-';	break;
++		case PADPLUS:	key='+';	break;
+ 		case ALT_D:
+ 			if (ungetch('D') != ERR) key=27;
+ 			break;
+@@ -1518,7 +1561,7 @@
+ 		case 27:	// escape (a bit slow): Clears line. and processes alt commands.
+ 			key=getch();
+ 			if(key < 0) { //Purely escape Clear line
+-				codeViewData.inputStr[0] = 0; 
++				ClearInputLine();
+ 				break;
+ 			}
+ 
+@@ -1584,23 +1627,54 @@
+ 		case KEY_END:	// End: scroll log page down
+ 				DEBUG_RefreshPage(1);
+ 				break;
+-		case KEY_F(6):  // Re-enter previous command (f1-f4 generate rubbish at my place)
+-		case KEY_F(3):  // Re-enter previous command
+-				// copy prevInputStr back into inputStr
+-				safe_strncpy(codeViewData.inputStr, codeViewData.prevInputStr, sizeof(codeViewData.inputStr));
++		case KEY_IC:	// Insert: toggle insert/overwrite
++				codeViewData.ovrMode = !codeViewData.ovrMode;
++				break;
++		case KEY_LEFT:	// move to the left in command line
++				if (codeViewData.inputPos > 0) codeViewData.inputPos--;
++ 				break;
++		case KEY_RIGHT:	// move to the right in command line
++				if (codeViewData.inputStr[codeViewData.inputPos]) codeViewData.inputPos++;
++				break;
++		case KEY_F(6):	// previous command (f1-f4 generate rubbish at my place)
++		case KEY_F(3):	// previous command 
++				if (histBuffPos == histBuff.begin()) break;
++				if (histBuffPos == histBuff.end()) {
++					// copy inputStr to suspInputStr so we can restore it
++					safe_strncpy(codeViewData.suspInputStr, codeViewData.inputStr, sizeof(codeViewData.suspInputStr));
++				}
++				safe_strncpy(codeViewData.inputStr,(*--histBuffPos).c_str(),sizeof(codeViewData.inputStr));
++				codeViewData.inputPos = strlen(codeViewData.inputStr);
+ 				break;
++		case KEY_F(7):	// next command (f1-f4 generate rubbish at my place)
++		case KEY_F(4):	// next command
++				if (histBuffPos == histBuff.end()) break;
++				if (++histBuffPos != histBuff.end()) {
++					safe_strncpy(codeViewData.inputStr,(*histBuffPos).c_str(),sizeof(codeViewData.inputStr));
++				} else {
++					// copy suspInputStr back into inputStr
++					safe_strncpy(codeViewData.inputStr, codeViewData.suspInputStr, sizeof(codeViewData.inputStr));
++				}
++				codeViewData.inputPos = strlen(codeViewData.inputStr);
++				break; 
+ 		case KEY_F(5):	// Run Program
+ 				debugging=false;
+ 				CBreakpoint::ActivateBreakpoints(SegPhys(cs)+reg_eip,true);						
+ 				ignoreAddressOnce = SegPhys(cs)+reg_eip;
+ 				DOSBOX_SetNormalLoop();	
+ 				break;
+-		case KEY_F(9):	// Set/Remove TBreakpoint
++		case KEY_F(9):	// Set/Remove Breakpoint
+ 				{	PhysPt ptr = GetAddress(codeViewData.cursorSeg,codeViewData.cursorOfs);
+-					if (CBreakpoint::IsBreakpoint(ptr)) CBreakpoint::DeleteBreakpoint(ptr);
+-					else								CBreakpoint::AddBreakpoint(codeViewData.cursorSeg, codeViewData.cursorOfs, false);
++					if (CBreakpoint::IsBreakpoint(ptr)) {
++						CBreakpoint::DeleteBreakpoint(ptr);
++						DEBUG_ShowMsg("DEBUG: Breakpoint deletion success.\n");
++					}
++					else {
++						CBreakpoint::AddBreakpoint(codeViewData.cursorSeg, codeViewData.cursorOfs, false);
++						DEBUG_ShowMsg("DEBUG: Set breakpoint at %04X:%04X\n",codeViewData.cursorSeg,codeViewData.cursorOfs);
++					}
+ 				}
+-						break;
++				break;
+ 		case KEY_F(10):	// Step over inst
+ 				if (StepOver()) return 0;
+ 				else {
+@@ -1621,30 +1695,59 @@
+ 				CBreakpoint::ignoreOnce = 0;
+ 				break;
+ 		case 0x0A: //Parse typed Command
+-				codeViewData.inputMode = true;
++				codeViewData.inputStr[MAXCMDLEN] = '\0';
+ 				if(ParseCommand(codeViewData.inputStr)) {
+-					// copy inputStr to prevInputStr so we can restore it if the user hits F3
+-					safe_strncpy(codeViewData.prevInputStr, codeViewData.inputStr, sizeof(codeViewData.prevInputStr));
+-					// clear input line ready for next command
+-					codeViewData.inputStr[0] = 0;
+-				}
++					char* cmd = ltrim(codeViewData.inputStr);
++					if (histBuff.empty() || *--histBuff.end()!=cmd)
++						histBuff.push_back(cmd);
++					if (histBuff.size() > MAX_HIST_BUFFER) histBuff.pop_front();
++					histBuffPos = histBuff.end();
++					ClearInputLine();
++				} else { 
++					codeViewData.inputPos = strlen(codeViewData.inputStr);
++				} 
+ 				break;
+-		case 0x107:     //backspace (linux)
+-		case 0x7f:	//backspace in some terminal emulators (linux)
+-		case 0x08:	// delete
+-				if (strlen(codeViewData.inputStr)>0) codeViewData.inputStr[strlen(codeViewData.inputStr)-1] = 0;
+-				break;
+-		default	:	if ((key>=32) && (key<=128) && (strlen(codeViewData.inputStr)<253)) {
+-					Bit32u len = strlen(codeViewData.inputStr);
+-					codeViewData.inputStr[len]	= char(key);
+-					codeViewData.inputStr[len+1] = 0;
++		case KEY_BACKSPACE: //backspace (linux)
++		case 0x7f:	// backspace in some terminal emulators (linux)
++		case 0x08:	// delete 
++				if (codeViewData.inputPos == 0) break;
++				codeViewData.inputPos--;
++				// fallthrough
++		case KEY_DC: // delete character 
++				if ((codeViewData.inputPos<0) || (codeViewData.inputPos>=MAXCMDLEN)) break;
++				if (codeViewData.inputStr[codeViewData.inputPos] != 0) {
++						codeViewData.inputStr[MAXCMDLEN] = '\0';
++						for(char* p=&codeViewData.inputStr[codeViewData.inputPos];(*p=*(p+1));p++) {}
++				}
++ 				break;
++		default:
++				if ((key>=32) && (key<127)) {
++					if ((codeViewData.inputPos<0) || (codeViewData.inputPos>=MAXCMDLEN)) break;
++					codeViewData.inputStr[MAXCMDLEN] = '\0';
++					if (codeViewData.inputStr[codeViewData.inputPos] == 0) {
++							codeViewData.inputStr[codeViewData.inputPos++] = char(key);
++							codeViewData.inputStr[codeViewData.inputPos] = '\0';
++					} else if (!codeViewData.ovrMode) {
++						int len = (int) strlen(codeViewData.inputStr);
++						if (len < MAXCMDLEN) { 
++							for(len++;len>codeViewData.inputPos;len--)
++								codeViewData.inputStr[len]=codeViewData.inputStr[len-1];
++							codeViewData.inputStr[codeViewData.inputPos++] = char(key);
++						}
++					} else {
++						codeViewData.inputStr[codeViewData.inputPos++] = char(key);
++					}
++				} else if (key==killchar()) {
++					ClearInputLine();
+ 				}
+ 				break;
+-
+ 		}
+-                if (ret<0) return ret;
++		if (ret<0) return ret;
+ 		if (ret>0) {
+-			ret=(*CallBack_Handlers[ret])();
++			if (GCC_UNLIKELY(ret >= CB_MAX)) 
++				ret = 0;
++			else
++				ret = (*CallBack_Handlers[ret])();
+ 			if (ret) {
+ 				exitLoop=true;
+ 				CPU_Cycles=CPU_CycleLeft=0;
+@@ -1706,7 +1809,8 @@
+ 	DOS_MCB mcb(mcb_segment);
+ 	char filename[9]; // 8 characters plus a terminating NUL
+ 	const char *psp_seg_note;
+-	PhysPt dataAddr = PhysMake(dataSeg,dataOfs);// location being viewed in the "Data Overview"
++	Bit16u DOS_dataOfs = static_cast<Bit16u>(dataOfs); //Realmode addressing only
++	PhysPt dataAddr = PhysMake(dataSeg,DOS_dataOfs);// location being viewed in the "Data Overview"
+ 
+ 	// loop forever, breaking out of the loop once we've processed the last MCB
+ 	while (true) {
+@@ -1736,7 +1840,7 @@
+ 		PhysPt mcbStartAddr = PhysMake(mcb_segment+1,0);
+ 		PhysPt mcbEndAddr = PhysMake(mcb_segment+1+mcb.GetSize(),0);
+ 		if (dataAddr >= mcbStartAddr && dataAddr < mcbEndAddr) {
+-			LOG(LOG_MISC,LOG_ERROR)("   (data addr %04hX:%04X is %u bytes past this MCB)",dataSeg,dataOfs,dataAddr - mcbStartAddr);
++			LOG(LOG_MISC,LOG_ERROR)("   (data addr %04hX:%04X is %u bytes past this MCB)",dataSeg,DOS_dataOfs,dataAddr - mcbStartAddr);
+ 		}
+ 
+ 		// if we've just processed the last MCB in the chain, break out of the loop
+@@ -1772,9 +1876,9 @@
+ 	while (address<max) {
+ 		desc.Load(address);
+ 		sprintf(out1,"%04X: b:%08X type: %02X parbg",(i<<3),desc.GetBase(),desc.saved.seg.type);
+-		LOG(LOG_MISC,LOG_ERROR)(out1);
++		LOG(LOG_MISC,LOG_ERROR)("%s",out1);
+ 		sprintf(out1,"      l:%08X dpl : %01X  %1X%1X%1X%1X%1X",desc.GetLimit(),desc.saved.seg.dpl,desc.saved.seg.p,desc.saved.seg.avl,desc.saved.seg.r,desc.saved.seg.big,desc.saved.seg.g);
+-		LOG(LOG_MISC,LOG_ERROR)(out1);
++		LOG(LOG_MISC,LOG_ERROR)("%s",out1);
+ 		address+=8; i++;
+ 	};
+ };
+@@ -1792,9 +1896,9 @@
+ 	while (address<max) {
+ 		desc.Load(address);
+ 		sprintf(out1,"%04X: b:%08X type: %02X parbg",(i<<3)|4,desc.GetBase(),desc.saved.seg.type);
+-		LOG(LOG_MISC,LOG_ERROR)(out1);
++		LOG(LOG_MISC,LOG_ERROR)("%s",out1);
+ 		sprintf(out1,"      l:%08X dpl : %01X  %1X%1X%1X%1X%1X",desc.GetLimit(),desc.saved.seg.dpl,desc.saved.seg.p,desc.saved.seg.avl,desc.saved.seg.r,desc.saved.seg.big,desc.saved.seg.g);
+-		LOG(LOG_MISC,LOG_ERROR)(out1);
++		LOG(LOG_MISC,LOG_ERROR)("%s",out1);
+ 		address+=8; i++;
+ 	};
+ };
+@@ -1806,7 +1910,7 @@
+ 	while (address<256*8) {
+ 		if (cpu.idt.GetDescriptor(address,desc)) {
+ 			sprintf(out1,"%04X: sel:%04X off:%02X",address/8,desc.GetSelector(),desc.GetOffset());
+-			LOG(LOG_MISC,LOG_ERROR)(out1);
++			LOG(LOG_MISC,LOG_ERROR)("%s",out1);
+ 		}
+ 		address+=8;
+ 	};
+@@ -1829,7 +1933,7 @@
+ 						sprintf(out1,"page %05Xxxx -> %04Xxxx  flags [uw] %x:%x::%x:%x [d=%x|a=%x]",
+ 							i,entry.block.base,entry.block.us,table.block.us,
+ 							entry.block.wr,table.block.wr,entry.block.d,entry.block.a);
+-						LOG(LOG_MISC,LOG_ERROR)(out1);
++						LOG(LOG_MISC,LOG_ERROR)("%s",out1);
+ 					}
+ 				}
+ 			}
+@@ -1842,10 +1946,10 @@
+ 				Bitu entry_addr=(table.block.base<<12)+(sel & 0x3ff)*4;
+ 				entry.load=phys_readd(entry_addr);
+ 				sprintf(out1,"page %05Xxxx -> %04Xxxx  flags [puw] %x:%x::%x:%x::%x:%x",sel,entry.block.base,entry.block.p,table.block.p,entry.block.us,table.block.us,entry.block.wr,table.block.wr);
+-				LOG(LOG_MISC,LOG_ERROR)(out1);
++				LOG(LOG_MISC,LOG_ERROR)("%s",out1);
+ 			} else {
+ 				sprintf(out1,"pagetable %03X not present, flags [puw] %x::%x::%x",(sel >> 10),table.block.p,table.block.us,table.block.wr);
+-				LOG(LOG_MISC,LOG_ERROR)(out1);
++				LOG(LOG_MISC,LOG_ERROR)("%s",out1);
+ 			}
+ 		}
+ 	}
+@@ -1854,24 +1958,24 @@
+ static void LogCPUInfo(void) {
+ 	char out1[512];
+ 	sprintf(out1,"cr0:%08X cr2:%08X cr3:%08X  cpl=%x",cpu.cr0,paging.cr2,paging.cr3,cpu.cpl);
+-	LOG(LOG_MISC,LOG_ERROR)(out1);
++	LOG(LOG_MISC,LOG_ERROR)("%s",out1);
+ 	sprintf(out1,"eflags:%08X [vm=%x iopl=%x nt=%x]",reg_flags,GETFLAG(VM)>>17,GETFLAG(IOPL)>>12,GETFLAG(NT)>>14);
+-	LOG(LOG_MISC,LOG_ERROR)(out1);
++	LOG(LOG_MISC,LOG_ERROR)("%s",out1);
+ 	sprintf(out1,"GDT base=%08X limit=%08X",cpu.gdt.GetBase(),cpu.gdt.GetLimit());
+-	LOG(LOG_MISC,LOG_ERROR)(out1);
++	LOG(LOG_MISC,LOG_ERROR)("%s",out1);
+ 	sprintf(out1,"IDT base=%08X limit=%08X",cpu.idt.GetBase(),cpu.idt.GetLimit());
+-	LOG(LOG_MISC,LOG_ERROR)(out1);
++	LOG(LOG_MISC,LOG_ERROR)("%s",out1);
+ 
+ 	Bitu sel=CPU_STR();
+ 	Descriptor desc;
+ 	if (cpu.gdt.GetDescriptor(sel,desc)) {
+ 		sprintf(out1,"TR selector=%04X, base=%08X limit=%08X*%X",sel,desc.GetBase(),desc.GetLimit(),desc.saved.seg.g?0x4000:1);
+-		LOG(LOG_MISC,LOG_ERROR)(out1);
++		LOG(LOG_MISC,LOG_ERROR)("%s",out1);
+ 	}
+ 	sel=CPU_SLDT();
+ 	if (cpu.gdt.GetDescriptor(sel,desc)) {
+ 		sprintf(out1,"LDT selector=%04X, base=%08X limit=%08X*%X",sel,desc.GetBase(),desc.GetLimit(),desc.saved.seg.g?0x4000:1);
+-		LOG(LOG_MISC,LOG_ERROR)(out1);
++		LOG(LOG_MISC,LOG_ERROR)("%s",out1);
+ 	}
+ };
+ 
+@@ -1902,7 +2006,7 @@
+ 		char ibytes[200]="";	char tmpc[200];
+ 		for (Bitu i=0; i<size; i++) {
+ 			Bit8u value;
+-			if (mem_readb_checked(start+i,&value)) sprintf(tmpc,"?? ",value);
++			if (mem_readb_checked(start+i,&value)) sprintf(tmpc,"%s","?? ");
+ 			else sprintf(tmpc,"%02X ",value);
+ 			strcat(ibytes,tmpc);
+ 		}
+@@ -1952,13 +2056,12 @@
+ 		}
+ 	   
+ 		char filename[128];
+-		char args[256];
++		char args[256+1];
+ 	
+ 		cmd->FindCommand(1,temp_line);
+ 		safe_strncpy(filename,temp_line.c_str(),128);
+ 		// Read commandline
+ 		Bit16u i	=2;
+-		bool ok		= false; 
+ 		args[0]		= 0;
+ 		for (;cmd->FindCommand(i++,temp_line)==true;) {
+ 			strncat(args,temp_line.c_str(),256);
+@@ -2022,26 +2125,27 @@
+ 	WIN32_Console();
+ 	#else
+ 	tcgetattr(0,&consolesettings);
+-	printf("\e[8;50;80t"); //resize terminal
+-	fflush(NULL);
++	//curses must be inited first in order to catch the resize (is an event)
++//	printf("\e[8;50;80t"); //resize terminal
++//	fflush(NULL);
+ 	#endif	
+ 	memset((void *)&dbg,0,sizeof(dbg));
+ 	debugging=false;
+-	dbg.active_win=3;
+-	input_count=0;
++//	dbg.active_win=3;
+ 	/* Start the Debug Gui */
+ 	DBGUI_StartUp();
+ }
+ 
+-static void DEBUG_ShutDown(Section * /*sec*/) {
++void DEBUG_ShutDown(Section * /*sec*/) {
+ 	CBreakpoint::DeleteAll();
+ 	CDebugVar::DeleteAll();
+ 	curs_set(old_cursor_state);
++	endwin();
+ 	#ifndef WIN32
+ 	tcsetattr(0, TCSANOW,&consolesettings);
+ //	printf("\e[0m\e[2J"); //Seems to destroy scrolling
+-	printf("\ec");
+-	fflush(NULL);
++//	printf("\ec"); //Doesn't seem to be needed anymore
++//	fflush(NULL);
+ 	#endif
+ }
+ 
+@@ -2049,11 +2153,11 @@
+ 
+ void DEBUG_Init(Section* sec) {
+ 
+-	MSG_Add("DEBUG_CONFIGFILE_HELP","Debugger related options.\n");
++//	MSG_Add("DEBUG_CONFIGFILE_HELP","Debugger related options.\n");
+ 	DEBUG_DrawScreen();
+ 	/* Add some keyhandlers */
+ 	MAPPER_AddHandler(DEBUG_Enable,MK_pause,MMOD2,"debugger","Debugger");
+-	/* Clear the TBreakpoint list */
++	/* Reset code overview and input line */
+ 	memset((void*)&codeViewData,0,sizeof(codeViewData));
+ 	/* setup debug.com */
+ 	PROGRAMS_MakeFile("DEBUG.COM",DEBUG_ProgramStart);
+@@ -2093,11 +2197,11 @@
+ 	return 0;
+ };
+ 
+-bool CDebugVar::SaveVars(char* name)
+-{
++bool CDebugVar::SaveVars(char* name) {
++	if (varList.size()>65535) return false;
++
+ 	FILE* f = fopen(name,"wb+");
+ 	if (!f) return false;
+-	if (varList.size()>65535) return false;
+ 
+ 	// write number of vars
+ 	Bit16u num = (Bit16u)varList.size();
+@@ -2124,15 +2228,15 @@
+ 
+ 	// read number of vars
+ 	Bit16u num;
+-	fread(&num,1,sizeof(num),f);
++	if (fread(&num,sizeof(num),1,f) != 1) return false;
+ 
+ 	for (Bit16u i=0; i<num; i++) {
+ 		char name[16];
+ 		// name
+-		fread(name,1,16,f);
++		if (fread(name,16,1,f) != 1) break;
+ 		// adr
+ 		PhysPt adr;
+-		fread(&adr,1,sizeof(adr),f);
++		if (fread(&adr,sizeof(adr),1,f) != 1) break;
+ 		// insert
+ 		InsertVariable(name,adr);
+ 	};
+@@ -2140,7 +2244,7 @@
+ 	return true;
+ };
+ 
+-static void SaveMemory(Bitu seg, Bitu ofs1, Bit32u num) {
++static void SaveMemory(Bit16u seg, Bit32u ofs1, Bit32u num) {
+ 	FILE* f = fopen("MEMDUMP.TXT","wt");
+ 	if (!f) {
+ 		DEBUG_ShowMsg("DEBUG: Memory dump failed.\n");
+@@ -2154,7 +2258,7 @@
+ 		sprintf(buffer,"%04X:%04X   ",seg,ofs1);
+ 		for (Bit16u x=0; x<16; x++) {
+ 			Bit8u value;
+-			if (mem_readb_checked(GetAddress(seg,ofs1+x),&value)) sprintf(temp,"?? ",value);
++			if (mem_readb_checked(GetAddress(seg,ofs1+x),&value)) sprintf(temp,"%s","?? ");
+ 			else sprintf(temp,"%02X ",value);
+ 			strcat(buffer,temp);
+ 		}
+@@ -2167,7 +2271,7 @@
+ 		sprintf(buffer,"%04X:%04X   ",seg,ofs1);
+ 		for (Bit16u x=0; x<num; x++) {
+ 			Bit8u value;
+-			if (mem_readb_checked(GetAddress(seg,ofs1+x),&value)) sprintf(temp,"?? ",value);
++			if (mem_readb_checked(GetAddress(seg,ofs1+x),&value)) sprintf(temp,"%s","?? ");
+ 			else sprintf(temp,"%02X ",value);
+ 			strcat(buffer,temp);
+ 		}
+@@ -2177,7 +2281,7 @@
+ 	DEBUG_ShowMsg("DEBUG: Memory dump success.\n");
+ }
+ 
+-static void SaveMemoryBin(Bitu seg, Bitu ofs1, Bit32u num) {
++static void SaveMemoryBin(Bit16u seg, Bit32u ofs1, Bit32u num) {
+ 	FILE* f = fopen("MEMDUMP.BIN","wb");
+ 	if (!f) {
+ 		DEBUG_ShowMsg("DEBUG: Memory binary dump failed.\n");
+@@ -2229,7 +2333,7 @@
+ 
+ 		Bit16u value;
+ 		if (mem_readw_checked(dv->GetAdr(),&value))
+-			snprintf(buffer,DEBUG_VAR_BUF_LEN, "??????", value);
++			snprintf(buffer,DEBUG_VAR_BUF_LEN, "%s", "??????");
+ 		else
+ 			snprintf(buffer,DEBUG_VAR_BUF_LEN, "0x%04x", value);
+ 
+@@ -2248,8 +2352,6 @@
+ 
+ const Bit32u LOGCPUMAX = 20000;
+ 
+-static Bit16u logCpuCS [LOGCPUMAX];
+-static Bit32u logCpuEIP[LOGCPUMAX];
+ static Bit32u logCount = 0;
+ 
+ struct TLogInst {
+@@ -2287,7 +2389,7 @@
+ 
+ 	PhysPt start = GetAddress(SegValue(cs),reg_eip);
+ 	char dline[200];
+-	Bitu size = DasmI386(dline, start, reg_eip, cpu.code.big);
++	DasmI386(dline, start, reg_eip, cpu.code.big);
+ 	char* res = empty;
+ 	if (showExtend) {
+ 		res = AnalyzeInstruction(dline,false);
+@@ -2343,7 +2445,7 @@
+ 	out << hex << noshowbase << setfill('0') << uppercase;
+ 	Bit32u startLog = logCount;
+ 	do {
+-		// Write Intructions
++		// Write Instructions
+ 		TLogInst & inst = logInst[startLog];
+ 		out << setw(4) << inst.s_cs << ":" << setw(8) << inst.eip << "  " 
+ 		    << inst.dline << "  " << inst.res << " EAX:" << setw(8)<< inst.eax
+diff -Nur dosbox-0.74/src/debug/debug_disasm.cpp dosbox/src/debug/debug_disasm.cpp
+--- dosbox-0.74/src/debug/debug_disasm.cpp	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/debug/debug_disasm.cpp	2014-01-12 14:43:47.000000000 +0100
+@@ -283,8 +283,10 @@
+   0,                  0,                 0,                0,
+   0,                  0,                 0,                0,
+ /* 3 */
+-  0, 0, 0, 0, 0, 0, 0, 0,
+-  0, 0, 0, 0, 0, 0, 0, 0,
++  0,                  "rdtsc",           0,                0,
++  0,                  0,                 0,                0,
++  0,                  0,                 0,                0,
++  0,                  0,                 0,                0,
+ /* 4 */
+   0, 0, 0, 0, 0, 0, 0, 0,
+   0, 0, 0, 0, 0, 0, 0, 0,
+@@ -947,7 +949,9 @@
+        break;
+ 
+   case '2':                            /* old [pop cs]! now indexes */
+-       ua_str(second[getbyte()]);      /* instructions in 386/486   */
++       c = getbyte();
++       wordop = c & 1;
++       ua_str(second[c]);              /* instructions in 386/486   */
+        break;
+ 
+   case 'g':                            /* modrm group `subtype' (0--7) */
+diff -Nur dosbox-0.74/src/debug/debug_gui.cpp dosbox/src/debug/debug_gui.cpp
+--- dosbox-0.74/src/debug/debug_gui.cpp	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/debug/debug_gui.cpp	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,7 +16,6 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: debug_gui.cpp,v 1.38 2009-05-27 09:15:41 qbix79 Exp $ */
+ 
+ #include "dosbox.h"
+ 
+@@ -87,6 +86,7 @@
+ 	list<string>::iterator i = logBuffPos;
+ 	int maxy, maxx; getmaxyx(dbg.win_out,maxy,maxx);
+ 	int rem_lines = maxy;
++	if(rem_lines == -1) return;
+ 
+ 	wclear(dbg.win_out);
+ 
+@@ -110,7 +110,7 @@
+ 
+ 	if (d_type>=LOG_MAX) return;
+ 	if ((d_severity!=LOG_ERROR) && (!loggrp[d_type].enabled)) return;
+-	DEBUG_ShowMsg("%10u: %s:%s\n",cycle_count,loggrp[d_type].front,buf);
++	DEBUG_ShowMsg("%10u: %s:%s\n",static_cast<Bit32u>(cycle_count),loggrp[d_type].front,buf);
+ }
+ 
+ 
+@@ -146,40 +146,42 @@
+ 		attrset(COLOR_PAIR(PAIR_BLACK_BLUE));
+ 	}
+ 	/* Show the Register bar */
+-	mvaddstr(dbg.win_reg->_begy-1,0, "---(Register Overview                   )---");
++	mvaddstr(1-1,0, "---(Register Overview                   )---");
+ 	/* Show the Data Overview bar perhaps with more special stuff in the end */
+-	mvaddstr(dbg.win_data->_begy-1,0,"---(Data Overview   Scroll: page up/down)---");
++	mvaddstr(6-1,0,"---(Data Overview   Scroll: page up/down)---");
+ 	/* Show the Code Overview perhaps with special stuff in bar too */
+-	mvaddstr(dbg.win_code->_begy-1,0,"---(Code Overview   Scroll: up/down     )---");
++	mvaddstr(17-1,0,"---(Code Overview   Scroll: up/down     )---");
+ 	/* Show the Variable Overview bar */
+-	mvaddstr(dbg.win_var->_begy-1,0, "---(Variable Overview                   )---");
++	mvaddstr(29-1,0, "---(Variable Overview                   )---");
+ 	/* Show the Output OverView */
+-	mvaddstr(dbg.win_out->_begy-1,0, "---(OutPut/Input    Scroll: home/end    )---");
++	mvaddstr(34-1,0, "---(Output          Scroll: home/end    )---");
+ 	attrset(0);
++	//Match values with below. So we don't need to touch the internal window structures
+ }
+ 
+ 
+ 
+ static void MakeSubWindows(void) {
+-	/* The Std output win should go in bottem */
++	/* The Std output win should go at the bottom */
+ 	/* Make all the subwindows */
+ 	int win_main_maxy, win_main_maxx; getmaxyx(dbg.win_main,win_main_maxy,win_main_maxx);
+-	int outy=1;
++	int outy=1; //Match values with above
+ 	/* The Register window  */
+ 	dbg.win_reg=subwin(dbg.win_main,4,win_main_maxx,outy,0);
+-	outy+=5;
++	outy+=5; // 6
+ 	/* The Data Window */
+ 	dbg.win_data=subwin(dbg.win_main,10,win_main_maxx,outy,0);
+-	outy+=11;
++	outy+=11; // 17
+ 	/* The Code Window */
+ 	dbg.win_code=subwin(dbg.win_main,11,win_main_maxx,outy,0);
+-	outy+=12;
++	outy+=12; // 29
+ 	/* The Variable Window */
+ 	dbg.win_var=subwin(dbg.win_main,4,win_main_maxx,outy,0);
+-	outy+=5;
++	outy+=5; // 34
+ 	/* The Output Window */	
+-	dbg.win_out=subwin(dbg.win_main,win_main_maxy-outy-1,win_main_maxx,outy,0);
+-	dbg.input_y=win_main_maxy-1;
++	dbg.win_out=subwin(dbg.win_main,win_main_maxy-outy,win_main_maxx,outy,0);
++	if(!dbg.win_reg ||!dbg.win_data || !dbg.win_code || !dbg.win_var || !dbg.win_out) E_Exit("Setting up windows failed");
++//	dbg.input_y=win_main_maxy-1;
+ 	scrollok(dbg.win_out,TRUE);
+ 	DrawBars();
+ 	Draw_RegisterLayout();
+@@ -245,6 +247,7 @@
+ 	loggrp[LOG_MISC].front="MISC";
+ 
+ 	loggrp[LOG_IO].front="IO";
++	loggrp[LOG_PCI].front="PCI";
+ 	
+ 	/* Register the log section */
+ 	Section_prop * sect=control->AddSection_prop("log",LOG_Init);
+@@ -257,7 +260,7 @@
+ 		Prop_bool* Pbool = sect->Add_bool(buf,Property::Changeable::Always,true);
+ 		Pbool->Set_help("Enable/Disable logging of this type.");
+ 	}
+-	MSG_Add("LOG_CONFIGFILE_HELP","Logging related options for the debugger.\n");
++//	MSG_Add("LOG_CONFIGFILE_HELP","Logging related options for the debugger.\n");
+ }
+ 
+ 
+@@ -271,6 +274,8 @@
+ 	nodelay(dbg.win_main,true);
+ 	keypad(dbg.win_main,true);
+ 	#ifndef WIN32
++	printf("\e[8;50;80t");
++	fflush(NULL);
+ 	resizeterm(50,80);
+ 	touchwin(dbg.win_main);
+ 	#endif
+diff -Nur dosbox-0.74/src/debug/debug_inc.h dosbox/src/debug/debug_inc.h
+--- dosbox-0.74/src/debug/debug_inc.h	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/debug/debug_inc.h	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -18,7 +18,6 @@
+ 
+ /* Local Debug Function */
+ 
+-/* $Id: debug_inc.h,v 1.12 2009-05-27 09:15:41 qbix79 Exp $ */
+ 
+ #include <curses.h>
+ #include "mem.h"
+diff -Nur dosbox-0.74/src/debug/debug_win32.cpp dosbox/src/debug/debug_win32.cpp
+--- dosbox-0.74/src/debug/debug_win32.cpp	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/debug/debug_win32.cpp	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+diff -Nur dosbox-0.74/src/debug/disasm_tables.h dosbox/src/debug/disasm_tables.h
+--- dosbox-0.74/src/debug/disasm_tables.h	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/debug/disasm_tables.h	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+diff -Nur dosbox-0.74/src/debug/Makefile.in dosbox/src/debug/Makefile.in
+--- dosbox-0.74/src/debug/Makefile.in	2010-05-12 11:57:44.000000000 +0200
++++ dosbox/src/debug/Makefile.in	1970-01-01 01:00:00.000000000 +0100
+@@ -1,447 +0,0 @@
+-# Makefile.in generated by automake 1.11.1 from Makefile.am.
+-# @configure_input@
+-
+-# Copyright (C) 1994, 1995, 1996, 1997, 1998, 1999, 2000, 2001, 2002,
+-# 2003, 2004, 2005, 2006, 2007, 2008, 2009  Free Software Foundation,
+-# Inc.
+-# This Makefile.in is free software; the Free Software Foundation
+-# gives unlimited permission to copy and/or distribute it,
+-# with or without modifications, as long as this notice is preserved.
+-
+-# This program is distributed in the hope that it will be useful,
+-# but WITHOUT ANY WARRANTY, to the extent permitted by law; without
+-# even the implied warranty of MERCHANTABILITY or FITNESS FOR A
+-# PARTICULAR PURPOSE.
+-
+-@SET_MAKE@
+-
+-VPATH = @srcdir@
+-pkgdatadir = $(datadir)/@PACKAGE@
+-pkgincludedir = $(includedir)/@PACKAGE@
+-pkglibdir = $(libdir)/@PACKAGE@
+-pkglibexecdir = $(libexecdir)/@PACKAGE@
+-am__cd = CDPATH="$${ZSH_VERSION+.}$(PATH_SEPARATOR)" && cd
+-install_sh_DATA = $(install_sh) -c -m 644
+-install_sh_PROGRAM = $(install_sh) -c
+-install_sh_SCRIPT = $(install_sh) -c
+-INSTALL_HEADER = $(INSTALL_DATA)
+-transform = $(program_transform_name)
+-NORMAL_INSTALL = :
+-PRE_INSTALL = :
+-POST_INSTALL = :
+-NORMAL_UNINSTALL = :
+-PRE_UNINSTALL = :
+-POST_UNINSTALL = :
+-build_triplet = @build@
+-host_triplet = @host@
+-subdir = src/debug
+-DIST_COMMON = $(srcdir)/Makefile.am $(srcdir)/Makefile.in
+-ACLOCAL_M4 = $(top_srcdir)/aclocal.m4
+-am__aclocal_m4_deps = $(top_srcdir)/acinclude.m4 \
+-	$(top_srcdir)/configure.in
+-am__configure_deps = $(am__aclocal_m4_deps) $(CONFIGURE_DEPENDENCIES) \
+-	$(ACLOCAL_M4)
+-mkinstalldirs = $(install_sh) -d
+-CONFIG_HEADER = $(top_builddir)/config.h
+-CONFIG_CLEAN_FILES =
+-CONFIG_CLEAN_VPATH_FILES =
+-LIBRARIES = $(noinst_LIBRARIES)
+-AR = ar
+-ARFLAGS = cru
+-libdebug_a_AR = $(AR) $(ARFLAGS)
+-libdebug_a_LIBADD =
+-am_libdebug_a_OBJECTS = debug.$(OBJEXT) debug_gui.$(OBJEXT) \
+-	debug_disasm.$(OBJEXT) debug_win32.$(OBJEXT)
+-libdebug_a_OBJECTS = $(am_libdebug_a_OBJECTS)
+-DEFAULT_INCLUDES = -I.@am__isrc@ -I$(top_builddir)
+-depcomp = $(SHELL) $(top_srcdir)/depcomp
+-am__depfiles_maybe = depfiles
+-am__mv = mv -f
+-CXXCOMPILE = $(CXX) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) \
+-	$(AM_CPPFLAGS) $(CPPFLAGS) $(AM_CXXFLAGS) $(CXXFLAGS)
+-CXXLD = $(CXX)
+-CXXLINK = $(CXXLD) $(AM_CXXFLAGS) $(CXXFLAGS) $(AM_LDFLAGS) $(LDFLAGS) \
+-	-o $@
+-COMPILE = $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) \
+-	$(CPPFLAGS) $(AM_CFLAGS) $(CFLAGS)
+-CCLD = $(CC)
+-LINK = $(CCLD) $(AM_CFLAGS) $(CFLAGS) $(AM_LDFLAGS) $(LDFLAGS) -o $@
+-SOURCES = $(libdebug_a_SOURCES)
+-DIST_SOURCES = $(libdebug_a_SOURCES)
+-ETAGS = etags
+-CTAGS = ctags
+-DISTFILES = $(DIST_COMMON) $(DIST_SOURCES) $(TEXINFOS) $(EXTRA_DIST)
+-ACLOCAL = @ACLOCAL@
+-ALSA_CFLAGS = @ALSA_CFLAGS@
+-ALSA_LIBS = @ALSA_LIBS@
+-AMTAR = @AMTAR@
+-AUTOCONF = @AUTOCONF@
+-AUTOHEADER = @AUTOHEADER@
+-AUTOMAKE = @AUTOMAKE@
+-AWK = @AWK@
+-CC = @CC@
+-CCDEPMODE = @CCDEPMODE@
+-CFLAGS = @CFLAGS@
+-CPP = @CPP@
+-CPPFLAGS = @CPPFLAGS@
+-CXX = @CXX@
+-CXXDEPMODE = @CXXDEPMODE@
+-CXXFLAGS = @CXXFLAGS@
+-CYGPATH_W = @CYGPATH_W@
+-DEFS = @DEFS@
+-DEPDIR = @DEPDIR@
+-ECHO_C = @ECHO_C@
+-ECHO_N = @ECHO_N@
+-ECHO_T = @ECHO_T@
+-EGREP = @EGREP@
+-EXEEXT = @EXEEXT@
+-GREP = @GREP@
+-INSTALL = @INSTALL@
+-INSTALL_DATA = @INSTALL_DATA@
+-INSTALL_PROGRAM = @INSTALL_PROGRAM@
+-INSTALL_SCRIPT = @INSTALL_SCRIPT@
+-INSTALL_STRIP_PROGRAM = @INSTALL_STRIP_PROGRAM@
+-LDFLAGS = @LDFLAGS@
+-LIBOBJS = @LIBOBJS@
+-LIBS = @LIBS@
+-LTLIBOBJS = @LTLIBOBJS@
+-MAKEINFO = @MAKEINFO@
+-MKDIR_P = @MKDIR_P@
+-OBJEXT = @OBJEXT@
+-PACKAGE = @PACKAGE@
+-PACKAGE_BUGREPORT = @PACKAGE_BUGREPORT@
+-PACKAGE_NAME = @PACKAGE_NAME@
+-PACKAGE_STRING = @PACKAGE_STRING@
+-PACKAGE_TARNAME = @PACKAGE_TARNAME@
+-PACKAGE_URL = @PACKAGE_URL@
+-PACKAGE_VERSION = @PACKAGE_VERSION@
+-PATH_SEPARATOR = @PATH_SEPARATOR@
+-RANLIB = @RANLIB@
+-SDL_CFLAGS = @SDL_CFLAGS@
+-SDL_CONFIG = @SDL_CONFIG@
+-SDL_LIBS = @SDL_LIBS@
+-SET_MAKE = @SET_MAKE@
+-SHELL = @SHELL@
+-STRIP = @STRIP@
+-VERSION = @VERSION@
+-WINDRES = @WINDRES@
+-abs_builddir = @abs_builddir@
+-abs_srcdir = @abs_srcdir@
+-abs_top_builddir = @abs_top_builddir@
+-abs_top_srcdir = @abs_top_srcdir@
+-ac_ct_CC = @ac_ct_CC@
+-ac_ct_CXX = @ac_ct_CXX@
+-am__include = @am__include@
+-am__leading_dot = @am__leading_dot@
+-am__quote = @am__quote@
+-am__tar = @am__tar@
+-am__untar = @am__untar@
+-bindir = @bindir@
+-build = @build@
+-build_alias = @build_alias@
+-build_cpu = @build_cpu@
+-build_os = @build_os@
+-build_vendor = @build_vendor@
+-builddir = @builddir@
+-datadir = @datadir@
+-datarootdir = @datarootdir@
+-docdir = @docdir@
+-dvidir = @dvidir@
+-exec_prefix = @exec_prefix@
+-host = @host@
+-host_alias = @host_alias@
+-host_cpu = @host_cpu@
+-host_os = @host_os@
+-host_vendor = @host_vendor@
+-htmldir = @htmldir@
+-includedir = @includedir@
+-infodir = @infodir@
+-install_sh = @install_sh@
+-libdir = @libdir@
+-libexecdir = @libexecdir@
+-localedir = @localedir@
+-localstatedir = @localstatedir@
+-mandir = @mandir@
+-mkdir_p = @mkdir_p@
+-oldincludedir = @oldincludedir@
+-pdfdir = @pdfdir@
+-prefix = @prefix@
+-program_transform_name = @program_transform_name@
+-psdir = @psdir@
+-sbindir = @sbindir@
+-sharedstatedir = @sharedstatedir@
+-srcdir = @srcdir@
+-sysconfdir = @sysconfdir@
+-target_alias = @target_alias@
+-top_build_prefix = @top_build_prefix@
+-top_builddir = @top_builddir@
+-top_srcdir = @top_srcdir@
+-AM_CPPFLAGS = -I$(top_srcdir)/include
+-noinst_LIBRARIES = libdebug.a
+-libdebug_a_SOURCES = debug.cpp debug_gui.cpp debug_disasm.cpp debug_inc.h disasm_tables.h debug_win32.cpp
+-all: all-am
+-
+-.SUFFIXES:
+-.SUFFIXES: .cpp .o .obj
+-$(srcdir)/Makefile.in:  $(srcdir)/Makefile.am  $(am__configure_deps)
+-	@for dep in $?; do \
+-	  case '$(am__configure_deps)' in \
+-	    *$$dep*) \
+-	      ( cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh ) \
+-	        && { if test -f $@; then exit 0; else break; fi; }; \
+-	      exit 1;; \
+-	  esac; \
+-	done; \
+-	echo ' cd $(top_srcdir) && $(AUTOMAKE) --gnu src/debug/Makefile'; \
+-	$(am__cd) $(top_srcdir) && \
+-	  $(AUTOMAKE) --gnu src/debug/Makefile
+-.PRECIOUS: Makefile
+-Makefile: $(srcdir)/Makefile.in $(top_builddir)/config.status
+-	@case '$?' in \
+-	  *config.status*) \
+-	    cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh;; \
+-	  *) \
+-	    echo ' cd $(top_builddir) && $(SHELL) ./config.status $(subdir)/$@ $(am__depfiles_maybe)'; \
+-	    cd $(top_builddir) && $(SHELL) ./config.status $(subdir)/$@ $(am__depfiles_maybe);; \
+-	esac;
+-
+-$(top_builddir)/config.status: $(top_srcdir)/configure $(CONFIG_STATUS_DEPENDENCIES)
+-	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
+-
+-$(top_srcdir)/configure:  $(am__configure_deps)
+-	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
+-$(ACLOCAL_M4):  $(am__aclocal_m4_deps)
+-	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
+-$(am__aclocal_m4_deps):
+-
+-clean-noinstLIBRARIES:
+-	-test -z "$(noinst_LIBRARIES)" || rm -f $(noinst_LIBRARIES)
+-libdebug.a: $(libdebug_a_OBJECTS) $(libdebug_a_DEPENDENCIES) 
+-	-rm -f libdebug.a
+-	$(libdebug_a_AR) libdebug.a $(libdebug_a_OBJECTS) $(libdebug_a_LIBADD)
+-	$(RANLIB) libdebug.a
+-
+-mostlyclean-compile:
+-	-rm -f *.$(OBJEXT)
+-
+-distclean-compile:
+-	-rm -f *.tab.c
+-
+-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/debug.Po@am__quote@
+-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/debug_disasm.Po@am__quote@
+-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/debug_gui.Po@am__quote@
+-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/debug_win32.Po@am__quote@
+-
+-.cpp.o:
+-@am__fastdepCXX_TRUE@	$(CXXCOMPILE) -MT $@ -MD -MP -MF $(DEPDIR)/$*.Tpo -c -o $@ $<
+-@am__fastdepCXX_TRUE@	$(am__mv) $(DEPDIR)/$*.Tpo $(DEPDIR)/$*.Po
+-@AMDEP_TRUE@@am__fastdepCXX_FALSE@	source='$<' object='$@' libtool=no @AMDEPBACKSLASH@
+-@AMDEP_TRUE@@am__fastdepCXX_FALSE@	DEPDIR=$(DEPDIR) $(CXXDEPMODE) $(depcomp) @AMDEPBACKSLASH@
+-@am__fastdepCXX_FALSE@	$(CXXCOMPILE) -c -o $@ $<
+-
+-.cpp.obj:
+-@am__fastdepCXX_TRUE@	$(CXXCOMPILE) -MT $@ -MD -MP -MF $(DEPDIR)/$*.Tpo -c -o $@ `$(CYGPATH_W) '$<'`
+-@am__fastdepCXX_TRUE@	$(am__mv) $(DEPDIR)/$*.Tpo $(DEPDIR)/$*.Po
+-@AMDEP_TRUE@@am__fastdepCXX_FALSE@	source='$<' object='$@' libtool=no @AMDEPBACKSLASH@
+-@AMDEP_TRUE@@am__fastdepCXX_FALSE@	DEPDIR=$(DEPDIR) $(CXXDEPMODE) $(depcomp) @AMDEPBACKSLASH@
+-@am__fastdepCXX_FALSE@	$(CXXCOMPILE) -c -o $@ `$(CYGPATH_W) '$<'`
+-
+-ID: $(HEADERS) $(SOURCES) $(LISP) $(TAGS_FILES)
+-	list='$(SOURCES) $(HEADERS) $(LISP) $(TAGS_FILES)'; \
+-	unique=`for i in $$list; do \
+-	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
+-	  done | \
+-	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
+-	      END { if (nonempty) { for (i in files) print i; }; }'`; \
+-	mkid -fID $$unique
+-tags: TAGS
+-
+-TAGS:  $(HEADERS) $(SOURCES)  $(TAGS_DEPENDENCIES) \
+-		$(TAGS_FILES) $(LISP)
+-	set x; \
+-	here=`pwd`; \
+-	list='$(SOURCES) $(HEADERS)  $(LISP) $(TAGS_FILES)'; \
+-	unique=`for i in $$list; do \
+-	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
+-	  done | \
+-	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
+-	      END { if (nonempty) { for (i in files) print i; }; }'`; \
+-	shift; \
+-	if test -z "$(ETAGS_ARGS)$$*$$unique"; then :; else \
+-	  test -n "$$unique" || unique=$$empty_fix; \
+-	  if test $$# -gt 0; then \
+-	    $(ETAGS) $(ETAGSFLAGS) $(AM_ETAGSFLAGS) $(ETAGS_ARGS) \
+-	      "$$@" $$unique; \
+-	  else \
+-	    $(ETAGS) $(ETAGSFLAGS) $(AM_ETAGSFLAGS) $(ETAGS_ARGS) \
+-	      $$unique; \
+-	  fi; \
+-	fi
+-ctags: CTAGS
+-CTAGS:  $(HEADERS) $(SOURCES)  $(TAGS_DEPENDENCIES) \
+-		$(TAGS_FILES) $(LISP)
+-	list='$(SOURCES) $(HEADERS)  $(LISP) $(TAGS_FILES)'; \
+-	unique=`for i in $$list; do \
+-	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
+-	  done | \
+-	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
+-	      END { if (nonempty) { for (i in files) print i; }; }'`; \
+-	test -z "$(CTAGS_ARGS)$$unique" \
+-	  || $(CTAGS) $(CTAGSFLAGS) $(AM_CTAGSFLAGS) $(CTAGS_ARGS) \
+-	     $$unique
+-
+-GTAGS:
+-	here=`$(am__cd) $(top_builddir) && pwd` \
+-	  && $(am__cd) $(top_srcdir) \
+-	  && gtags -i $(GTAGS_ARGS) "$$here"
+-
+-distclean-tags:
+-	-rm -f TAGS ID GTAGS GRTAGS GSYMS GPATH tags
+-
+-distdir: $(DISTFILES)
+-	@srcdirstrip=`echo "$(srcdir)" | sed 's/[].[^$$\\*]/\\\\&/g'`; \
+-	topsrcdirstrip=`echo "$(top_srcdir)" | sed 's/[].[^$$\\*]/\\\\&/g'`; \
+-	list='$(DISTFILES)'; \
+-	  dist_files=`for file in $$list; do echo $$file; done | \
+-	  sed -e "s|^$$srcdirstrip/||;t" \
+-	      -e "s|^$$topsrcdirstrip/|$(top_builddir)/|;t"`; \
+-	case $$dist_files in \
+-	  */*) $(MKDIR_P) `echo "$$dist_files" | \
+-			   sed '/\//!d;s|^|$(distdir)/|;s,/[^/]*$$,,' | \
+-			   sort -u` ;; \
+-	esac; \
+-	for file in $$dist_files; do \
+-	  if test -f $$file || test -d $$file; then d=.; else d=$(srcdir); fi; \
+-	  if test -d $$d/$$file; then \
+-	    dir=`echo "/$$file" | sed -e 's,/[^/]*$$,,'`; \
+-	    if test -d "$(distdir)/$$file"; then \
+-	      find "$(distdir)/$$file" -type d ! -perm -700 -exec chmod u+rwx {} \;; \
+-	    fi; \
+-	    if test -d $(srcdir)/$$file && test $$d != $(srcdir); then \
+-	      cp -fpR $(srcdir)/$$file "$(distdir)$$dir" || exit 1; \
+-	      find "$(distdir)/$$file" -type d ! -perm -700 -exec chmod u+rwx {} \;; \
+-	    fi; \
+-	    cp -fpR $$d/$$file "$(distdir)$$dir" || exit 1; \
+-	  else \
+-	    test -f "$(distdir)/$$file" \
+-	    || cp -p $$d/$$file "$(distdir)/$$file" \
+-	    || exit 1; \
+-	  fi; \
+-	done
+-check-am: all-am
+-check: check-am
+-all-am: Makefile $(LIBRARIES)
+-installdirs:
+-install: install-am
+-install-exec: install-exec-am
+-install-data: install-data-am
+-uninstall: uninstall-am
+-
+-install-am: all-am
+-	@$(MAKE) $(AM_MAKEFLAGS) install-exec-am install-data-am
+-
+-installcheck: installcheck-am
+-install-strip:
+-	$(MAKE) $(AM_MAKEFLAGS) INSTALL_PROGRAM="$(INSTALL_STRIP_PROGRAM)" \
+-	  install_sh_PROGRAM="$(INSTALL_STRIP_PROGRAM)" INSTALL_STRIP_FLAG=-s \
+-	  `test -z '$(STRIP)' || \
+-	    echo "INSTALL_PROGRAM_ENV=STRIPPROG='$(STRIP)'"` install
+-mostlyclean-generic:
+-
+-clean-generic:
+-
+-distclean-generic:
+-	-test -z "$(CONFIG_CLEAN_FILES)" || rm -f $(CONFIG_CLEAN_FILES)
+-	-test . = "$(srcdir)" || test -z "$(CONFIG_CLEAN_VPATH_FILES)" || rm -f $(CONFIG_CLEAN_VPATH_FILES)
+-
+-maintainer-clean-generic:
+-	@echo "This command is intended for maintainers to use"
+-	@echo "it deletes files that may require special tools to rebuild."
+-clean: clean-am
+-
+-clean-am: clean-generic clean-noinstLIBRARIES mostlyclean-am
+-
+-distclean: distclean-am
+-	-rm -rf ./$(DEPDIR)
+-	-rm -f Makefile
+-distclean-am: clean-am distclean-compile distclean-generic \
+-	distclean-tags
+-
+-dvi: dvi-am
+-
+-dvi-am:
+-
+-html: html-am
+-
+-html-am:
+-
+-info: info-am
+-
+-info-am:
+-
+-install-data-am:
+-
+-install-dvi: install-dvi-am
+-
+-install-dvi-am:
+-
+-install-exec-am:
+-
+-install-html: install-html-am
+-
+-install-html-am:
+-
+-install-info: install-info-am
+-
+-install-info-am:
+-
+-install-man:
+-
+-install-pdf: install-pdf-am
+-
+-install-pdf-am:
+-
+-install-ps: install-ps-am
+-
+-install-ps-am:
+-
+-installcheck-am:
+-
+-maintainer-clean: maintainer-clean-am
+-	-rm -rf ./$(DEPDIR)
+-	-rm -f Makefile
+-maintainer-clean-am: distclean-am maintainer-clean-generic
+-
+-mostlyclean: mostlyclean-am
+-
+-mostlyclean-am: mostlyclean-compile mostlyclean-generic
+-
+-pdf: pdf-am
+-
+-pdf-am:
+-
+-ps: ps-am
+-
+-ps-am:
+-
+-uninstall-am:
+-
+-.MAKE: install-am install-strip
+-
+-.PHONY: CTAGS GTAGS all all-am check check-am clean clean-generic \
+-	clean-noinstLIBRARIES ctags distclean distclean-compile \
+-	distclean-generic distclean-tags distdir dvi dvi-am html \
+-	html-am info info-am install install-am install-data \
+-	install-data-am install-dvi install-dvi-am install-exec \
+-	install-exec-am install-html install-html-am install-info \
+-	install-info-am install-man install-pdf install-pdf-am \
+-	install-ps install-ps-am install-strip installcheck \
+-	installcheck-am installdirs maintainer-clean \
+-	maintainer-clean-generic mostlyclean mostlyclean-compile \
+-	mostlyclean-generic pdf pdf-am ps ps-am tags uninstall \
+-	uninstall-am
+-
+-
+-# Tell versions [3.59,3.63) of GNU make to not export all variables.
+-# Otherwise a system limit (for SysV at least) may be exceeded.
+-.NOEXPORT:
+diff -Nur dosbox-0.74/src/dos/cdrom_aspi_win32.cpp dosbox/src/dos/cdrom_aspi_win32.cpp
+--- dosbox-0.74/src/dos/cdrom_aspi_win32.cpp	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/dos/cdrom_aspi_win32.cpp	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,7 +16,6 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: cdrom_aspi_win32.cpp,v 1.21 2009-05-27 09:15:41 qbix79 Exp $ */
+ 
+ #if defined (WIN32)
+ 
+diff -Nur dosbox-0.74/src/dos/cdrom.cpp dosbox/src/dos/cdrom.cpp
+--- dosbox-0.74/src/dos/cdrom.cpp	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/dos/cdrom.cpp	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,7 +16,6 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: cdrom.cpp,v 1.27 2009-04-26 18:24:36 qbix79 Exp $ */
+ 
+ // ******************************************************
+ // SDL CDROM 
+diff -Nur dosbox-0.74/src/dos/cdrom.h dosbox/src/dos/cdrom.h
+--- dosbox-0.74/src/dos/cdrom.h	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/dos/cdrom.h	2014-01-12 14:43:47.000000000 +0100
+@@ -1,3 +1,21 @@
++/*
++ *  Copyright (C) 2002-2013  The DOSBox Team
++ *
++ *  This program is free software; you can redistribute it and/or modify
++ *  it under the terms of the GNU General Public License as published by
++ *  the Free Software Foundation; either version 2 of the License, or
++ *  (at your option) any later version.
++ *
++ *  This program is distributed in the hope that it will be useful,
++ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
++ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
++ *  GNU General Public License for more details.
++ *
++ *  You should have received a copy of the GNU General Public License
++ *  along with this program; if not, write to the Free Software
++ *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
++ */
++
+ 
+ #ifndef __CDROM_INTERFACE__
+ #define __CDROM_INTERFACE__
+@@ -31,6 +49,11 @@
+ 	unsigned char fr;
+ } TMSF;
+ 
++typedef struct SCtrl {
++	Bit8u	out[4];			// output channel
++	Bit8u	vol[4];			// channel volume
++} TCtrl;
++
+ extern int CDROM_GetMountType(char* path, int force);
+ 
+ class CDROM_Interface
+@@ -52,6 +75,7 @@
+ 	virtual bool	PlayAudioSector		(unsigned long start,unsigned long len) = 0;
+ 	virtual bool	PauseAudio			(bool resume) = 0;
+ 	virtual bool	StopAudio			(void) = 0;
++	virtual void	ChannelControl		(TCtrl ctrl) = 0;
+ 	
+ 	virtual bool	ReadSectors			(PhysPt buffer, bool raw, unsigned long sector, unsigned long num) = 0;
+ 
+@@ -76,6 +100,7 @@
+ 	virtual bool	PlayAudioSector		(unsigned long start,unsigned long len);
+ 	virtual bool	PauseAudio			(bool resume);
+ 	virtual bool	StopAudio			(void);
++	virtual void	ChannelControl		(TCtrl ctrl) { return; };
+ 	virtual bool	ReadSectors			(PhysPt /*buffer*/, bool /*raw*/, unsigned long /*sector*/, unsigned long /*num*/) { return false; };
+ 	virtual bool	LoadUnloadMedia		(bool unload);
+ 
+@@ -101,6 +126,7 @@
+ 	bool	PlayAudioSector		(unsigned long /*start*/,unsigned long /*len*/) { return true; };
+ 	bool	PauseAudio			(bool /*resume*/) { return true; };
+ 	bool	StopAudio			(void) { return true; };
++	void	ChannelControl		(TCtrl ctrl) { return; };
+ 	bool	ReadSectors			(PhysPt /*buffer*/, bool /*raw*/, unsigned long /*sector*/, unsigned long /*num*/) { return true; };
+ 	bool	LoadUnloadMedia		(bool /*unload*/) { return true; };
+ };	
+@@ -166,6 +192,7 @@
+ 	bool	PlayAudioSector		(unsigned long start,unsigned long len);
+ 	bool	PauseAudio		(bool resume);
+ 	bool	StopAudio		(void);
++	void	ChannelControl		(TCtrl ctrl);
+ 	bool	ReadSectors		(PhysPt buffer, bool raw, unsigned long sector, unsigned long num);
+ 	bool	LoadUnloadMedia		(bool unload);
+ 	bool	ReadSector		(Bit8u *buffer, bool raw, unsigned long sector);
+@@ -188,6 +215,8 @@
+ 		int     targetFrame;
+ 		bool    isPlaying;
+ 		bool    isPaused;
++		bool    ctrlUsed;
++		TCtrl   ctrlData;
+ 	} player;
+ 	
+ 	void 	ClearTracks();
+@@ -234,6 +263,7 @@
+ 	bool	PlayAudioSector		(unsigned long start,unsigned long len);
+ 	bool	PauseAudio			(bool resume);
+ 	bool	StopAudio			(void);
++	void	ChannelControl		(TCtrl ctrl) { return; };
+ 	
+ 	bool	ReadSectors			(PhysPt buffer, bool raw, unsigned long sector, unsigned long num);
+ 
+@@ -284,6 +314,7 @@
+ 	bool	PlayAudioSector		(unsigned long start,unsigned long len);
+ 	bool	PauseAudio			(bool resume);
+ 	bool	StopAudio			(void);
++	void	ChannelControl		(TCtrl ctrl);
+ 	
+ 	bool	ReadSector			(Bit8u *buffer, bool raw, unsigned long sector);
+ 	bool	ReadSectors			(PhysPt buffer, bool raw, unsigned long sector, unsigned long num);
+@@ -338,6 +369,8 @@
+ 		int     targetFrame;
+ 		bool    isPlaying;
+ 		bool    isPaused;
++		bool    ctrlUsed;
++		TCtrl   ctrlData;
+ 	} player;
+ 
+ };
+diff -Nur dosbox-0.74/src/dos/cdrom_image.cpp dosbox/src/dos/cdrom_image.cpp
+--- dosbox-0.74/src/dos/cdrom_image.cpp	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/dos/cdrom_image.cpp	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,7 +16,6 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: cdrom_image.cpp,v 1.24 2009-03-19 20:45:42 c2woody Exp $ */
+ 
+ #include <cctype>
+ #include <cmath>
+@@ -131,7 +130,7 @@
+ int CDROM_Interface_Image::refCount = 0;
+ CDROM_Interface_Image* CDROM_Interface_Image::images[26];
+ CDROM_Interface_Image::imagePlayer CDROM_Interface_Image::player = {
+-	NULL, NULL, NULL, {0}, 0, 0, 0, false, false };
++	NULL, NULL, NULL, {0}, 0, 0, 0, false, false, false, {0} };
+ 
+ 	
+ CDROM_Interface_Image::CDROM_Interface_Image(Bit8u subUnit)
+@@ -247,7 +246,6 @@
+ 
+ bool CDROM_Interface_Image::PauseAudio(bool resume)
+ {
+-	if (!player.isPlaying) return false;
+ 	player.isPaused = !resume;
+ 	return true;
+ }
+@@ -259,6 +257,12 @@
+ 	return true;
+ }
+ 
++void CDROM_Interface_Image::ChannelControl(TCtrl ctrl)
++{
++	player.ctrlUsed = (ctrl.out[0]!=0 || ctrl.out[1]!=1 || ctrl.vol[0]<0xfe || ctrl.vol[1]<0xfe);
++	player.ctrlData = ctrl;
++}
++
+ bool CDROM_Interface_Image::ReadSectors(PhysPt buffer, bool raw, unsigned long sector, unsigned long num)
+ {
+ 	int sectorSize = raw ? RAW_SECTOR_SIZE : COOKED_SECTOR_SIZE;
+@@ -336,9 +340,25 @@
+ 		}
+ 	}
+ 	SDL_mutexV(player.mutex);
++	if (player.ctrlUsed) {
++		Bit16s sample0,sample1;
++		Bit16s * samples=(Bit16s *)&player.buffer;
++		for (Bitu pos=0;pos<len/4;pos++) {
+ #if defined(WORDS_BIGENDIAN)
+-	player.channel->AddSamples_s16_nonnative(len/4,(Bit16s *)player.buffer);
++			sample0=(Bit16s)host_readw((HostPt)&samples[pos*2+player.ctrlData.out[0]]);
++			sample1=(Bit16s)host_readw((HostPt)&samples[pos*2+player.ctrlData.out[1]]);
+ #else
++			sample0=samples[pos*2+player.ctrlData.out[0]];
++			sample1=samples[pos*2+player.ctrlData.out[1]];
++#endif
++			samples[pos*2+0]=(Bit16s)(sample0*player.ctrlData.vol[0]/255.0);
++			samples[pos*2+1]=(Bit16s)(sample1*player.ctrlData.vol[1]/255.0);
++		}
++#if defined(WORDS_BIGENDIAN)
++		player.channel->AddSamples_s16(len/4,(Bit16s *)player.buffer);
++	} else	player.channel->AddSamples_s16_nonnative(len/4,(Bit16s *)player.buffer);
++#else
++	}
+ 	player.channel->AddSamples_s16(len/4,(Bit16s *)player.buffer);
+ #endif
+ 	memmove(player.buffer, &player.buffer[len], player.bufLen - len);
+@@ -638,7 +658,30 @@
+ 			return true;
+ 		}
+ 	}
+-	
++#if defined (WIN32) || defined(OS2)
++	//Nothing
++#else
++	//Consider the possibility that the filename has a windows directory seperator (inside the CUE file) 
++	//which is common for some commercial rereleases of DOS games using DOSBox
++
++	string copy = filename;
++	size_t l = copy.size();
++	for (size_t i = 0; i < l;i++) {
++		if(copy[i] == '\\') copy[i] = '/';
++	}
++
++	if (stat(copy.c_str(), &test) == 0) {
++		filename = copy;
++		return true;
++	}
++
++	tmpstr = pathname + "/" + copy;
++	if (stat(tmpstr.c_str(), &test) == 0) {
++		filename = tmpstr;
++		return true;
++	}
++
++#endif
+ 	return false;
+ }
+ 
+diff -Nur dosbox-0.74/src/dos/cdrom_ioctl_linux.cpp dosbox/src/dos/cdrom_ioctl_linux.cpp
+--- dosbox-0.74/src/dos/cdrom_ioctl_linux.cpp	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/dos/cdrom_ioctl_linux.cpp	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -37,7 +37,7 @@
+ bool CDROM_Interface_Ioctl::GetUPC(unsigned char& attr, char* upc)
+ {
+ 	int cdrom_fd = open(device_name, O_RDONLY | O_NONBLOCK);
+-	if (cdrom_fd <= 0) return false;
++	if (cdrom_fd == -1) return false;
+ 	
+ 	struct cdrom_mcn cdrom_mcn;
+ 	int ret = ioctl(cdrom_fd, CDROM_GET_MCN, &cdrom_mcn);
+@@ -55,7 +55,7 @@
+ bool CDROM_Interface_Ioctl::ReadSectors(PhysPt buffer, bool raw, unsigned long sector, unsigned long num)
+ {
+ 	int cdrom_fd = open(device_name, O_RDONLY | O_NONBLOCK);
+-	if (cdrom_fd <= 0) return false;
++	if (cdrom_fd == -1) return false;
+ 	
+ 	Bits buflen = raw ? num * CD_FRAMESIZE_RAW : num * CD_FRAMESIZE;
+ 	Bit8u* buf = new Bit8u[buflen];	
+diff -Nur dosbox-0.74/src/dos/cdrom_ioctl_os2.cpp dosbox/src/dos/cdrom_ioctl_os2.cpp
+--- dosbox-0.74/src/dos/cdrom_ioctl_os2.cpp	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/dos/cdrom_ioctl_os2.cpp	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,7 +16,6 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: cdrom_ioctl_os2.cpp,v 1.4 2009-05-27 09:15:41 qbix79 Exp $ */
+ 
+ #include <string.h>
+ #include "dosbox.h"
+diff -Nur dosbox-0.74/src/dos/cdrom_ioctl_win32.cpp dosbox/src/dos/cdrom_ioctl_win32.cpp
+--- dosbox-0.74/src/dos/cdrom_ioctl_win32.cpp	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/dos/cdrom_ioctl_win32.cpp	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,7 +16,6 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: cdrom_ioctl_win32.cpp,v 1.16 2009-01-07 22:39:18 c2woody Exp $ */
+ 
+ #if defined (WIN32)
+ 
+@@ -175,7 +174,7 @@
+ 
+ 
+ CDROM_Interface_Ioctl::dxPlayer CDROM_Interface_Ioctl::player = {
+-	NULL, NULL, NULL, 0, 0,	0, 0, 0, false,	false };
++	NULL, NULL, NULL, {0}, 0, 0, 0, false, false, false, {0} };
+ 
+ CDROM_Interface_Ioctl::CDROM_Interface_Ioctl(cdioctl_cdatype ioctl_cda) {
+ 	pathname[0] = 0;
+@@ -430,7 +429,6 @@
+ 		return false;
+ 	}
+ 	if (use_dxplay) {
+-		if (!player.isPlaying) return false;
+ 		player.isPaused = !resume;
+ 		return true;
+ 	}
+@@ -462,6 +460,12 @@
+ 	return bStat>0;
+ }
+ 
++void CDROM_Interface_Ioctl::ChannelControl(TCtrl ctrl)
++{
++	player.ctrlUsed = (ctrl.out[0]!=0 || ctrl.out[1]!=1 || ctrl.vol[0]<0xfe || ctrl.vol[1]<0xfe);
++	player.ctrlData = ctrl;
++}
++
+ bool CDROM_Interface_Ioctl::LoadUnloadMedia(bool unload) {
+ 	BOOL bStat; 
+ 	DWORD byteCount;
+@@ -553,6 +557,16 @@
+ 		}
+ 	}
+ 	SDL_mutexV(player.mutex);
++	if (player.ctrlUsed) {
++		Bit16s sample0,sample1;
++		Bit16s * samples=(Bit16s *)&player.buffer;
++		for (Bitu pos=0;pos<len/4;pos++) {
++			sample0=samples[pos*2+player.ctrlData.out[0]];
++			sample1=samples[pos*2+player.ctrlData.out[1]];
++			samples[pos*2+0]=(Bit16s)(sample0*player.ctrlData.vol[0]/255.0);
++			samples[pos*2+1]=(Bit16s)(sample1*player.ctrlData.vol[1]/255.0);
++		}
++	}
+ 	player.channel->AddSamples_s16(len/4,(Bit16s *)player.buffer);
+ 	memmove(player.buffer, &player.buffer[len], player.bufLen - len);
+ 	player.bufLen -= len;
+diff -Nur dosbox-0.74/src/dos/dev_con.h dosbox/src/dos/dev_con.h
+--- dosbox-0.74/src/dos/dev_con.h	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/dos/dev_con.h	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,7 +16,6 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: dev_con.h,v 1.35 2009-05-27 09:15:41 qbix79 Exp $ */
+ 
+ #include "dos_inc.h"
+ #include "../ints/int10.h"
+@@ -38,7 +37,7 @@
+ private:
+ 	Bit8u readcache;
+ 	Bit8u lastwrite;
+-	struct ansi { /* should create a constructor which fills them with the appriorate values */
++	struct ansi { /* should create a constructor, which would fill them with the appropriate values */
+ 		bool esc;
+ 		bool sci;
+ 		bool enabled;
+@@ -129,7 +128,7 @@
+ 				count++;
+ 				continue;
+ 			} else { 
+-				/* Some sort of "hack" now that \n doesn't set col to 0 (int10_char.cpp old chessgame) */
++				/* Some sort of "hack" now that '\n' doesn't set col to 0 (int10_char.cpp old chessgame) */
+ 				if((data[count] == '\n') && (lastwrite != '\r')) INT10_TeletypeOutputAttr('\r',ansi.attr,ansi.enabled);
+ 				/* pass attribute only if ansi is enabled */
+ 				INT10_TeletypeOutputAttr(data[count],ansi.attr,ansi.enabled);
+diff -Nur dosbox-0.74/src/dos/dos_classes.cpp dosbox/src/dos/dos_classes.cpp
+--- dosbox-0.74/src/dos/dos_classes.cpp	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/dos/dos_classes.cpp	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,7 +16,6 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: dos_classes.cpp,v 1.58 2009-07-09 20:06:57 c2woody Exp $ */
+ 
+ #include <string.h>
+ #include <stdlib.h>
+@@ -301,6 +300,9 @@
+ }
+ 
+ bool DOS_PSP::SetNumFiles(Bit16u fileNum) {
++	//20 minimum. clipper program.
++	if (fileNum < 20) fileNum = 20;
++	 
+ 	if (fileNum>20) {
+ 		// Allocate needed paragraphs
+ 		fileNum+=2;	// Add a few more files for safety
+@@ -492,6 +494,10 @@
+ 	if(extended) mem_writeb(pt - 1,attr);
+ }
+ 
++void DOS_FCB::SetResultAttr(Bit8u attr) {
++	mem_writeb(pt + 12,attr);
++}
++
+ void DOS_SDA::Init() {
+ 	/* Clear */
+ 	for(Bitu i=0;i<sizeof(sSDA);i++) mem_writeb(pt+i,0x00);
+diff -Nur dosbox-0.74/src/dos/dos.cpp dosbox/src/dos/dos.cpp
+--- dosbox-0.74/src/dos/dos.cpp	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/dos/dos.cpp	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,12 +16,10 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: dos.cpp,v 1.121 2009-10-28 21:45:12 qbix79 Exp $ */
+ 
+ #include <stdlib.h>
+ #include <string.h>
+ #include <ctype.h>
+-#include <time.h>
+ #include "dosbox.h"
+ #include "bios.h"
+ #include "mem.h"
+@@ -42,6 +40,34 @@
+ 	dos.errorcode=code;
+ }
+ 
++const Bit8u DOS_DATE_months[] = {
++	0, 31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31
++};
++
++static void DOS_AddDays(Bitu days) {
++	dos.date.day += days;
++	Bit8u monthlimit = DOS_DATE_months[dos.date.month];
++
++	if(dos.date.day > monthlimit) {
++		if((dos.date.year %4 == 0) && (dos.date.month==2)) {
++			// leap year
++			if(dos.date.day > 29) {
++				dos.date.month++;
++				dos.date.day -= 29;
++			}
++		} else {
++			//not leap year
++			dos.date.month++;
++			dos.date.day -= monthlimit;
++		}
++		if(dos.date.month > 12) {
++			// year over
++			dos.date.month = 1;
++			dos.date.year++;
++		}
++	}
++}
++
+ #define DATA_TRANSFERS_TAKE_CYCLES 1
+ #ifdef DATA_TRANSFERS_TAKE_CYCLES
+ 
+@@ -86,6 +112,8 @@
+ 
+ 	char name1[DOSNAMEBUF+2+DOS_NAMELENGTH_ASCII];
+ 	char name2[DOSNAMEBUF+2+DOS_NAMELENGTH_ASCII];
++	
++	static Bitu time_start = 0; //For emulating temporary time changes.
+ 
+ 	switch (reg_ah) {
+ 	case 0x00:		/* Terminate Program */
+@@ -192,6 +220,7 @@
+ 			Bit8u free=mem_readb(data);
+ 			Bit8u read=0;Bit8u c;Bit16u n=1;
+ 			if (!free) break;
++			free--;
+ 			for(;;) {
+ 				DOS_ReadFile(STDIN,&c,&n);
+ 				if (c == 8) {			// Backspace
+@@ -204,7 +233,7 @@
+ 					}
+ 					continue;
+ 				}
+-				if (read >= free) {		// Keyboard buffer full
++				if (read == free && c != 13) {		// Keyboard buffer full
+ 					Bit8u bell = 7;
+ 					DOS_WriteFile(STDOUT, &bell, &n);
+ 					continue;
+@@ -227,10 +256,13 @@
+ 		break;
+ 	case 0x0c:		/* Flush Buffer and read STDIN call */
+ 		{
+-			/* flush STDIN-buffer */
+-			Bit8u c;Bit16u n;
+-			while (DOS_GetSTDINStatus()) {
+-				n=1;	DOS_ReadFile(STDIN,&c,&n);
++			/* flush buffer if STDIN is CON */
++			Bit8u handle=RealHandle(STDIN);
++			if (handle!=0xFF && Files[handle] && Files[handle]->IsName("CON")) {
++				Bit8u c;Bit16u n;
++				while (DOS_GetSTDINStatus()) {
++					n=1;	DOS_ReadFile(STDIN,&c,&n);
++				}
+ 			}
+ 			switch (reg_al) {
+ 			case 0x1:
+@@ -316,11 +348,17 @@
+ 		if (!DOS_GetAllocationInfo(reg_dl,&reg_cx,&reg_al,&reg_dx)) reg_al=0xff;
+ 		break;
+ 	case 0x21:		/* Read random record from FCB */
+-		reg_al = DOS_FCBRandomRead(SegValue(ds),reg_dx,1,true);
++		{
++			Bit16u toread=1;
++			reg_al = DOS_FCBRandomRead(SegValue(ds),reg_dx,&toread,true);
++		}
+ 		LOG(LOG_FCB,LOG_NORMAL)("DOS:0x21 FCB-Random read used, result:al=%d",reg_al);
+ 		break;
+ 	case 0x22:		/* Write random record to FCB */
+-		reg_al=DOS_FCBRandomWrite(SegValue(ds),reg_dx,1,true);
++		{
++			Bit16u towrite=1;
++			reg_al=DOS_FCBRandomWrite(SegValue(ds),reg_dx,&towrite,true);
++		}
+ 		LOG(LOG_FCB,LOG_NORMAL)("DOS:0x22 FCB-Random write used, result:al=%d",reg_al);
+ 		break;
+ 	case 0x23:		/* Get file size for FCB */
+@@ -331,11 +369,11 @@
+ 		DOS_FCBSetRandomRecord(SegValue(ds),reg_dx);
+ 		break;
+ 	case 0x27:		/* Random block read from FCB */
+-		reg_al = DOS_FCBRandomRead(SegValue(ds),reg_dx,reg_cx,false);
++		reg_al = DOS_FCBRandomRead(SegValue(ds),reg_dx,&reg_cx,false);
+ 		LOG(LOG_FCB,LOG_NORMAL)("DOS:0x27 FCB-Random(block) read used, result:al=%d",reg_al);
+ 		break;
+ 	case 0x28:		/* Random Block write to FCB */
+-		reg_al=DOS_FCBRandomWrite(SegValue(ds),reg_dx,reg_cx,false);
++		reg_al=DOS_FCBRandomWrite(SegValue(ds),reg_dx,&reg_cx,false);
+ 		LOG(LOG_FCB,LOG_NORMAL)("DOS:0x28 FCB-Random(block) write used, result:al=%d",reg_al);
+ 		break;
+ 	case 0x29:		/* Parse filename into FCB */
+@@ -359,9 +397,13 @@
+ 		break;
+ 	case 0x26:		/* Create new PSP */
+ 		DOS_NewPSP(reg_dx,DOS_PSP(dos.psp()).GetSize());
++		reg_al=0xf0;	/* al destroyed */		
+ 		break;
+ 	case 0x2a:		/* Get System Date */
+ 		{
++			reg_ax=0; // get time
++			CALLBACK_RunRealInt(0x1a);
++			if(reg_al) DOS_AddDays(reg_al);
+ 			int a = (14 - dos.date.month)/12;
+ 			int y = dos.date.year - a;
+ 			int m = dos.date.month + 12*a - 2;
+@@ -374,34 +416,49 @@
+ 	case 0x2b:		/* Set System Date */
+ 		if (reg_cx<1980) { reg_al=0xff;break;}
+ 		if ((reg_dh>12) || (reg_dh==0))	{ reg_al=0xff;break;}
+-		if ((reg_dl>31) || (reg_dl==0))	{ reg_al=0xff;break;}
++		if (reg_dl==0) { reg_al=0xff;break;}
++ 		if (reg_dl>DOS_DATE_months[reg_dh]) {
++			if(!((reg_dh==2)&&(reg_cx%4 == 0)&&(reg_dl==29))) // february pass
++			{ reg_al=0xff;break; }
++		}
+ 		dos.date.year=reg_cx;
+ 		dos.date.month=reg_dh;
+ 		dos.date.day=reg_dl;
+ 		reg_al=0;
+ 		break;
+-	case 0x2c:		/* Get System Time */
+-//TODO Get time through bios calls date is fixed
+-		{
+-/*	Calculate how many miliseconds have passed */
+-			Bitu ticks=5*mem_readd(BIOS_TIMER);
+-			ticks = ((ticks / 59659u) << 16) + ((ticks % 59659u) << 16) / 59659u;
+-			Bitu seconds=(ticks/100);
+-			reg_ch=(Bit8u)(seconds/3600);
+-			reg_cl=(Bit8u)((seconds % 3600)/60);
+-			reg_dh=(Bit8u)(seconds % 60);
+-			reg_dl=(Bit8u)(ticks % 100);
+-		}
++	case 0x2c: {	/* Get System Time */
++		reg_ax=0; // get time
++		CALLBACK_RunRealInt(0x1a);
++		if(reg_al) DOS_AddDays(reg_al);
++		reg_ah=0x2c;
++
++		Bitu ticks=((Bitu)reg_cx<<16)|reg_dx;
++		if(time_start<=ticks) ticks-=time_start;
++		Bitu time=(Bitu)((100.0/((double)PIT_TICK_RATE/65536.0)) * (double)ticks);
++
++		reg_dl=(Bit8u)((Bitu)time % 100); // 1/100 seconds
++		time/=100;
++		reg_dh=(Bit8u)((Bitu)time % 60); // seconds
++		time/=60;
++		reg_cl=(Bit8u)((Bitu)time % 60); // minutes
++		time/=60;
++		reg_ch=(Bit8u)((Bitu)time % 24); // hours
++
+ 		//Simulate DOS overhead for timing-sensitive games
+-        	//Robomaze 2
++        //Robomaze 2
+ 		overhead();
+ 		break;
++	}
+ 	case 0x2d:		/* Set System Time */
+ 		LOG(LOG_DOSMISC,LOG_ERROR)("DOS:Set System Time not supported");
+ 		//Check input parameters nonetheless
+ 		if( reg_ch > 23 || reg_cl > 59 || reg_dh > 59 || reg_dl > 99 )
+ 			reg_al = 0xff; 
+-		else reg_al = 0;
++		else { //Allow time to be set to zero. Restore the orginal time for all other parameters. (QuickBasic)
++			if (reg_cx == 0 && reg_dx == 0) {time_start = mem_readd(BIOS_TIMER);LOG_MSG("Warning: game messes with DOS time!");}
++			else time_start = 0;
++			reg_al = 0;
++		}
+ 		break;
+ 	case 0x2e:		/* Set Verify flag */
+ 		dos.verify=(reg_al==1);
+@@ -458,7 +515,9 @@
+ 				reg_dh=0x10;								/* Dos in HMA */
+ 				break;
+ 			default:
+-				E_Exit("DOS:Illegal 0x33 Call %2X",reg_al);					
++				LOG(LOG_DOSMISC,LOG_ERROR)("Weird 0x33 call %2X",reg_al);
++				reg_al =0xff;
++				break;
+ 		}
+ 		break;
+ 	case 0x34:		/* Get INDos Flag */
+@@ -520,6 +579,7 @@
+ 	case 0x39:		/* MKDIR Create directory */
+ 		MEM_StrCopy(SegPhys(ds)+reg_dx,name1,DOSNAMEBUF);
+ 		if (DOS_MakeDir(name1)) {
++			reg_ax=0x05;	/* ax destroyed */
+ 			CALLBACK_SCF(false);
+ 		} else {
+ 			reg_ax=dos.errorcode;
+@@ -529,6 +589,7 @@
+ 	case 0x3a:		/* RMDIR Remove directory */
+ 		MEM_StrCopy(SegPhys(ds)+reg_dx,name1,DOSNAMEBUF);
+ 		if  (DOS_RemoveDir(name1)) {
++			reg_ax=0x05;	/* ax destroyed */
+ 			CALLBACK_SCF(false);
+ 		} else {
+ 			reg_ax=dos.errorcode;
+@@ -539,6 +600,7 @@
+ 	case 0x3b:		/* CHDIR Set current directory */
+ 		MEM_StrCopy(SegPhys(ds)+reg_dx,name1,DOSNAMEBUF);
+ 		if  (DOS_ChangeDir(name1)) {
++			reg_ax=0x00;	/* ax destroyed */
+ 			CALLBACK_SCF(false);
+ 		} else {
+ 			reg_ax=dos.errorcode;
+@@ -565,6 +627,7 @@
+ 		break;
+ 	case 0x3e:		/* CLOSE Close file */
+ 		if (DOS_CloseFile(reg_bx)) {
++//			reg_al=0x01;	/* al destroyed. Refcount */
+ 			CALLBACK_SCF(false);
+ 		} else {
+ 			reg_ax=dos.errorcode;
+@@ -786,6 +849,7 @@
+ 	case 0x55:					/* Create Child PSP*/
+ 		DOS_ChildPSP(reg_dx,reg_si);
+ 		dos.psp(reg_dx);
++		reg_al=0xf0;	/* al destroyed */
+ 		break;
+ 	case 0x56:					/* RENAME Rename file */
+ 		MEM_StrCopy(SegPhys(ds)+reg_dx,name1,DOSNAMEBUF);
+@@ -1056,7 +1120,7 @@
+ 
+ 	case 0x71:					/* Unknown probably 4dos detection */
+ 		reg_ax=0x7100;
+-		CALLBACK_SCF(true);
++		CALLBACK_SCF(true); //Check this! What needs this ? See default case
+ 		LOG(LOG_DOSMISC,LOG_NORMAL)("DOS:Windows long file name support call %2X",reg_al);
+ 		break;
+ 
+@@ -1070,7 +1134,7 @@
+ 	case 0xEF:                  /* Used in Ancient Art Of War CGA */
+ 	case 0x5e:					/* More Network Functions */
+ 	default:
+-		LOG(LOG_DOSMISC,LOG_ERROR)("DOS:Unhandled call %02X al=%02X. Set al to default of 0",reg_ah,reg_al);
++		if (reg_ah < 0x6d) LOG(LOG_DOSMISC,LOG_ERROR)("DOS:Unhandled call %02X al=%02X. Set al to default of 0",reg_ah,reg_al); //Less errors. above 0x6c the functions are simply always skipped, only al is zeroed, all other registers untouched
+ 		reg_al=0x00; /* default value */
+ 		break;
+ 	};
+@@ -1093,27 +1157,29 @@
+ }
+ 
+ static Bitu DOS_25Handler(void) {
+-	if(Drives[reg_al]==0){
+-		reg_ax=0x8002;
++	if (Drives[reg_al] == 0){
++		reg_ax = 0x8002;
+ 		SETFLAGBIT(CF,true);
+-	}else{
++	} else {
+ 		SETFLAGBIT(CF,false);
+-		if((reg_cx != 1) ||(reg_dx != 1))
++		if ((reg_cx != 1) ||(reg_dx != 1))
+ 			LOG(LOG_DOSMISC,LOG_NORMAL)("int 25 called but not as diskdetection drive %X",reg_al);
+ 
+-	   reg_ax=0;
++	   reg_ax = 0;
+ 	}
++	SETFLAGBIT(IF,true);
+     return CBRET_NONE;
+ }
+ static Bitu DOS_26Handler(void) {
+ 	LOG(LOG_DOSMISC,LOG_NORMAL)("int 26 called: hope for the best!");
+-	if(Drives[reg_al]==0){
+-		reg_ax=0x8002;
++	if (Drives[reg_al] == 0){
++		reg_ax = 0x8002;
+ 		SETFLAGBIT(CF,true);
+-	}else{
++	} else {
+ 		SETFLAGBIT(CF,false);
+-		reg_ax=0;
++		reg_ax = 0;
+ 	}
++	SETFLAGBIT(IF,true);
+     return CBRET_NONE;
+ }
+ 
+@@ -1166,16 +1232,6 @@
+ 	
+ 		dos.version.major=5;
+ 		dos.version.minor=0;
+-	
+-		/* Setup time and date */
+-		time_t curtime;struct tm *loctime;
+-		curtime = time (NULL);loctime = localtime (&curtime);
+-	
+-		dos.date.day=(Bit8u)loctime->tm_mday;
+-		dos.date.month=(Bit8u)loctime->tm_mon+1;
+-		dos.date.year=(Bit16u)loctime->tm_year+1900;
+-		Bit32u ticks=(Bit32u)((loctime->tm_hour*3600+loctime->tm_min*60+loctime->tm_sec)*(float)PIT_TICK_RATE/65536.0);
+-		mem_writed(BIOS_TIMER,ticks);
+ 	}
+ 	~DOS(){
+ 		for (Bit16u i=0;i<DOS_DRIVES;i++) delete Drives[i];
+diff -Nur dosbox-0.74/src/dos/dos_devices.cpp dosbox/src/dos/dos_devices.cpp
+--- dosbox-0.74/src/dos/dos_devices.cpp	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/dos/dos_devices.cpp	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,7 +16,6 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: dos_devices.cpp,v 1.22 2009-05-27 09:15:41 qbix79 Exp $ */ 
+ 
+ #include <string.h>
+ #include "dosbox.h"
+@@ -61,6 +60,10 @@
+ public:
+    	device_LPT1() { SetName("LPT1");}
+ 	Bit16u GetInformation(void) { return 0x80A0; }
++	bool Read(Bit8u* data,Bit16u * size){
++		DOS_SetError(DOSERR_ACCESS_DENIED);
++		return false;
++	}	
+ };
+ 
+ bool DOS_Device::Read(Bit8u * data,Bit16u * size) {
+@@ -98,6 +101,7 @@
+ 	attr=orig.attr;
+ 	refCtr=orig.refCtr;
+ 	open=orig.open;
++	hdrive=orig.hdrive;
+ 	name=0;
+ 	if(orig.name) {
+ 		name=new char [strlen(orig.name) + 1];strcpy(name,orig.name);
+@@ -111,6 +115,7 @@
+ 	attr=orig.attr;
+ 	refCtr=orig.refCtr;
+ 	open=orig.open;
++	hdrive=orig.hdrive;
+ 	if(name) {
+ 		delete [] name; name=0;
+ 	}
+diff -Nur dosbox-0.74/src/dos/dos_execute.cpp dosbox/src/dos/dos_execute.cpp
+--- dosbox-0.74/src/dos/dos_execute.cpp	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/dos/dos_execute.cpp	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,7 +16,6 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: dos_execute.cpp,v 1.68 2009-10-04 14:28:07 c2woody Exp $ */
+ 
+ #include <string.h>
+ #include <ctype.h>
+@@ -94,8 +93,13 @@
+ 	DOS_MCB mcb(dos.psp()-1);
+ 	static char name[9];
+ 	mcb.GetFileName(name);
++	name[8] = 0;
+ 	if (!strlen(name)) strcpy(name,"DOSBOX");
+-	RunningProgram=name;
++	for(Bitu i = 0;i < 8;i++) { //Don't put garbage in the title bar. Mac OS X doesn't like it
++		if (name[i] == 0) break;
++		if ( !isprint(*reinterpret_cast<unsigned char*>(&name[i])) ) name[i] = '?';
++	}
++	RunningProgram = name;
+ 	GFX_SetTitle(-1,-1,false);
+ }
+ 
+diff -Nur dosbox-0.74/src/dos/dos_files.cpp dosbox/src/dos/dos_files.cpp
+--- dosbox-0.74/src/dos/dos_files.cpp	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/dos/dos_files.cpp	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,7 +16,6 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: dos_files.cpp,v 1.113 2009-08-31 18:03:08 qbix79 Exp $ */
+ 
+ #include <string.h>
+ #include <stdlib.h>
+@@ -93,7 +92,7 @@
+ 		case '!':	case '%':	case '{':	case '}':	case '`':	case '~':
+ 		case '_':	case '-':	case '.':	case '*':	case '?':	case '&':
+ 		case '\'':	case '+':	case '^':	case 246:	case 255:	case 0xa0:
+-		case 0xe5:	case 0xbd:
++		case 0xe5:	case 0xbd:	case 0x9d:
+ 			upname[w++]=c;
+ 			break;
+ 		default:
+@@ -203,7 +202,18 @@
+ 
+ bool DOS_ChangeDir(char const * const dir) {
+ 	Bit8u drive;char fulldir[DOS_PATHLENGTH];
++	const char * testdir=dir;
++	if (strlen(testdir) && testdir[1]==':') testdir+=2;
++	size_t len=strlen(testdir);
++	if (!len) {
++		DOS_SetError(DOSERR_PATH_NOT_FOUND);
++		return false;
++	}
+ 	if (!DOS_MakeName(dir,fulldir,&drive)) return false;
++	if (strlen(fulldir) && testdir[len-1]=='\\') {
++		DOS_SetError(DOSERR_PATH_NOT_FOUND);
++		return false;
++	}
+ 	
+ 	if (Drives[drive]->TestDir(fulldir)) {
+ 		strcpy(Drives[drive]->curdir,fulldir);
+@@ -289,7 +299,7 @@
+ 	}
+ 
+ 	if (Drives[drivenew]->Rename(fullold,fullnew)) return true;
+-	/* If it still fails. which error should we give ? PATH NOT FOUND or EACCESS */
++	/* If it still fails, which error should we give ? PATH NOT FOUND or EACCESS */
+ 	LOG(LOG_FILES,LOG_NORMAL)("Rename fails for %s to %s, no proper errorcode returned.",oldname,newname);
+ 	DOS_SetError(DOSERR_FILE_NOT_FOUND);
+ 	return false;
+@@ -880,7 +890,7 @@
+ 
+ static void DTAExtendName(char * const name,char * const filename,char * const ext) {
+ 	char * find=strchr(name,'.');
+-	if (find) {
++	if (find && find!=name) {
+ 		strcpy(ext,find+1);
+ 		*find=0;
+ 	} else ext[0]=0;
+@@ -898,12 +908,15 @@
+ 	char file_name[9];char ext[4];
+ 	find_dta.GetResult(name,size,date,time,attr);
+ 	drive=find_fcb.GetDrive()+1;
++	Bit8u find_attr = DOS_ATTR_ARCHIVE;
++	find_fcb.GetAttr(find_attr); /* Gets search attributes if extended */
+ 	/* Create a correct file and extention */
+ 	DTAExtendName(name,file_name,ext);	
+ 	DOS_FCB fcb(RealSeg(dos.dta()),RealOff(dos.dta()));//TODO
+ 	fcb.Create(find_fcb.Extended());
+ 	fcb.SetName(drive,file_name,ext);
+-	fcb.SetAttr(attr);      /* Only adds attribute if fcb is extended */
++	fcb.SetAttr(find_attr);      /* Only adds attribute if fcb is extended */
++	fcb.SetResultAttr(attr);
+ 	fcb.SetSizeDateTime(size,date,time);
+ }
+ 
+@@ -911,7 +924,10 @@
+ 	DOS_FCB fcb(seg,offset);
+ 	char shortname[DOS_FCBNAME];Bit16u handle;
+ 	fcb.GetName(shortname);
+-	if (!DOS_CreateFile(shortname,DOS_ATTR_ARCHIVE,&handle)) return false;
++	Bit8u attr = DOS_ATTR_ARCHIVE;
++	fcb.GetAttr(attr);
++	if (!attr) attr = DOS_ATTR_ARCHIVE; //Better safe than sorry 
++	if (!DOS_CreateFile(shortname,attr,&handle)) return false;
+ 	fcb.FileOpen((Bit8u)handle);
+ 	return true;
+ }
+@@ -980,6 +996,11 @@
+ 	DOS_FCB fcb(seg,offset);
+ 	Bit8u fhandle,cur_rec;Bit16u cur_block,rec_size;
+ 	fcb.GetSeqData(fhandle,rec_size);
++	if (fhandle==0xff && rec_size!=0) {
++		if (!DOS_FCBOpen(seg,offset)) return FCB_READ_NODATA;
++		LOG(LOG_FCB,LOG_WARN)("Reopened closed FCB");
++		fcb.GetSeqData(fhandle,rec_size);
++	}
+ 	fcb.GetRecord(cur_block,cur_rec);
+ 	Bit32u pos=((cur_block*128)+cur_rec)*rec_size;
+ 	if (!DOS_SeekFile(fhandle,&pos,DOS_SEEK_SET)) return FCB_READ_NODATA; 
+@@ -1002,6 +1023,11 @@
+ 	DOS_FCB fcb(seg,offset);
+ 	Bit8u fhandle,cur_rec;Bit16u cur_block,rec_size;
+ 	fcb.GetSeqData(fhandle,rec_size);
++	if (fhandle==0xff && rec_size!=0) {
++		if (!DOS_FCBOpen(seg,offset)) return FCB_READ_NODATA;
++		LOG(LOG_FCB,LOG_WARN)("Reopened closed FCB");
++		fcb.GetSeqData(fhandle,rec_size);
++	}
+ 	fcb.GetRecord(cur_block,cur_rec);
+ 	Bit32u pos=((cur_block*128)+cur_rec)*rec_size;
+ 	if (!DOS_SeekFile(fhandle,&pos,DOS_SEEK_SET)) return FCB_ERR_WRITE; 
+@@ -1056,32 +1082,30 @@
+ 	return FCB_SUCCESS;
+ }
+ 
+-Bit8u DOS_FCBRandomRead(Bit16u seg,Bit16u offset,Bit16u numRec,bool restore) {
++Bit8u DOS_FCBRandomRead(Bit16u seg,Bit16u offset,Bit16u * numRec,bool restore) {
+ /* if restore is true :random read else random blok read. 
+  * random read updates old block and old record to reflect the random data
+  * before the read!!!!!!!!! and the random data is not updated! (user must do this)
+  * Random block read updates these fields to reflect the state after the read!
+  */
+-
+-/* BUG: numRec should return the amount of records read! 
+- * Not implemented yet as I'm unsure how to count on error states (partial/failed) 
+- */
+-
+ 	DOS_FCB fcb(seg,offset);
+ 	Bit32u random;
+ 	Bit16u old_block=0;
+ 	Bit8u old_rec=0;
+ 	Bit8u error=0;
++	Bit16u count;
+ 
+ 	/* Set the correct record from the random data */
+ 	fcb.GetRandom(random);
+ 	fcb.SetRecord((Bit16u)(random / 128),(Bit8u)(random & 127));
+ 	if (restore) fcb.GetRecord(old_block,old_rec);//store this for after the read.
+ 	// Read records
+-	for (int i=0; i<numRec; i++) {
+-		error = DOS_FCBRead(seg,offset,(Bit16u)i);
+-		if (error!=0x00) break;
++	for (count=0; count<*numRec; count++) {
++		error = DOS_FCBRead(seg,offset,count);
++		if (error!=FCB_SUCCESS) break;
+ 	}
++	if (error==FCB_READ_PARTIAL) count++;	//partial read counts
++	*numRec=count;
+ 	Bit16u new_block;Bit8u new_rec;
+ 	fcb.GetRecord(new_block,new_rec);
+ 	if (restore) fcb.SetRecord(old_block,old_rec);
+@@ -1090,24 +1114,26 @@
+ 	return error;
+ }
+ 
+-Bit8u DOS_FCBRandomWrite(Bit16u seg,Bit16u offset,Bit16u numRec,bool restore) {
++Bit8u DOS_FCBRandomWrite(Bit16u seg,Bit16u offset,Bit16u * numRec,bool restore) {
+ /* see FCB_RandomRead */
+ 	DOS_FCB fcb(seg,offset);
+ 	Bit32u random;
+ 	Bit16u old_block=0;
+ 	Bit8u old_rec=0;
+ 	Bit8u error=0;
++	Bit16u count;
+ 
+ 	/* Set the correct record from the random data */
+ 	fcb.GetRandom(random);
+ 	fcb.SetRecord((Bit16u)(random / 128),(Bit8u)(random & 127));
+ 	if (restore) fcb.GetRecord(old_block,old_rec);
+-	if (numRec>0) {
++	if (*numRec > 0) {
+ 		/* Write records */
+-		for (int i=0; i<numRec; i++) {
+-			error = DOS_FCBWrite(seg,offset,(Bit16u)i);// dos_fcbwrite return 0 false when true...
+-			if (error!=0x00) break;
++		for (count=0; count<*numRec; count++) {
++			error = DOS_FCBWrite(seg,offset,count);// dos_fcbwrite return 0 false when true...
++			if (error!=FCB_SUCCESS) break;
+ 		}
++		*numRec=count;
+ 	} else {
+ 		DOS_FCBIncreaseSize(seg,offset);
+ 	}
+@@ -1115,7 +1141,7 @@
+ 	fcb.GetRecord(new_block,new_rec);
+ 	if (restore) fcb.SetRecord(old_block,old_rec);
+ 	/* Update the random record pointer with new position only when restore is false */
+-	if(!restore) fcb.SetRandom(new_block*128+new_rec); 
++	if (!restore) fcb.SetRandom(new_block*128+new_rec); 
+ 	return error;
+ }
+ 
+@@ -1141,10 +1167,11 @@
+  * stored. This can not be the tempdta as that one is used by fcbfindfirst
+  */
+ 	RealPt old_dta=dos.dta();dos.dta(dos.tables.tempdta_fcbdelete);
+-	DOS_FCB fcb(RealSeg(dos.dta()),RealOff(dos.dta()));
++	RealPt new_dta=dos.dta();
+ 	bool nextfile = false;
+ 	bool return_value = false;
+ 	nextfile = DOS_FCBFindFirst(seg,offset);
++	DOS_FCB fcb(RealSeg(new_dta),RealOff(new_dta));
+ 	while(nextfile) {
+ 		char shortname[DOS_FCBNAME] = { 0 };
+ 		fcb.GetName(shortname);
+@@ -1159,9 +1186,29 @@
+ bool DOS_FCBRenameFile(Bit16u seg, Bit16u offset){
+ 	DOS_FCB fcbold(seg,offset);
+ 	DOS_FCB fcbnew(seg,offset+16);
++	if(!fcbold.Valid()) return false;
+ 	char oldname[DOS_FCBNAME];
+ 	char newname[DOS_FCBNAME];
+ 	fcbold.GetName(oldname);fcbnew.GetName(newname);
++
++	/* Check, if sourcefile is still open. This was possible in DOS, but modern oses don't like this */
++	Bit8u drive; char fullname[DOS_PATHLENGTH];
++	if (!DOS_MakeName(oldname,fullname,&drive)) return false;
++	
++	DOS_PSP psp(dos.psp());
++	for (Bit8u i=0;i<DOS_FILES;i++) {
++		if (Files[i] && Files[i]->IsOpen() && Files[i]->IsName(fullname)) {
++			Bit16u handle = psp.FindEntryByHandle(i);
++			if (handle == 0xFF) {
++				// This shouldnt happen
++				LOG(LOG_FILES,LOG_ERROR)("DOS: File %s is opened but has no psp entry.",oldname);
++				return false;
++			}
++			DOS_CloseFile(handle);
++		}
++	}
++
++	/* Rename the file */
+ 	return DOS_Rename(oldname,newname);
+ }
+ 
+@@ -1182,7 +1229,10 @@
+ bool DOS_GetAllocationInfo(Bit8u drive,Bit16u * _bytes_sector,Bit8u * _sectors_cluster,Bit16u * _total_clusters) {
+ 	if (!drive) drive =  DOS_GetDefaultDrive();
+ 	else drive--;
+-	if (drive >= DOS_DRIVES || !Drives[drive]) return false;
++	if (drive >= DOS_DRIVES || !Drives[drive]) {
++		DOS_SetError(DOSERR_INVALID_DRIVE);
++		return false;
++	}
+ 	Bit16u _free_clusters;
+ 	Drives[drive]->AllocationInfo(_bytes_sector,_sectors_cluster,_total_clusters,&_free_clusters);
+ 	SegSet16(ds,RealSeg(dos.tables.mediaid));
+diff -Nur dosbox-0.74/src/dos/dos_ioctl.cpp dosbox/src/dos/dos_ioctl.cpp
+--- dosbox-0.74/src/dos/dos_ioctl.cpp	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/dos/dos_ioctl.cpp	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,7 +16,6 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: dos_ioctl.cpp,v 1.35 2009-04-16 12:16:52 qbix79 Exp $ */
+ 
+ #include <string.h>
+ #include "dosbox.h"
+@@ -41,7 +40,7 @@
+ 	} else if (reg_al<0x12) { 				/* those use a diskdrive except 0x0b */
+ 		if (reg_al!=0x0b) {
+ 			drive=reg_bl;if (!drive) drive = DOS_GetDefaultDrive();else drive--;
+-			if( !(( drive < DOS_DRIVES ) && Drives[drive]) ) {
++			if( (drive >= 2) && !(( drive < DOS_DRIVES ) && Drives[drive]) ) {
+ 				DOS_SetError(DOSERR_INVALID_DRIVE);
+ 				return false;
+ 			}
+@@ -134,7 +133,7 @@
+ 		}
+ 		return true;
+ 	case 0x09:		/* Check if block device remote */
+-		if (Drives[drive]->isRemote()) {
++		if ((drive >= 2) && Drives[drive]->isRemote()) {
+ 			reg_dx=0x1000;	// device is remote
+ 			// undocumented bits always clear
+ 		} else {
+@@ -152,7 +151,7 @@
+ 		return true;
+ 	case 0x0D:		/* Generic block device request */
+ 		{
+-			if (Drives[drive]->isRemovable()) {
++			if ((drive < 2) || Drives[drive]->isRemovable()) {
+ 				DOS_SetError(DOSERR_FUNCTION_NUMBER_INVALID);
+ 				return false;
+ 			}
+@@ -203,11 +202,14 @@
+ 			return true;
+ 		}
+ 	case 0x0E:			/* Get Logical Drive Map */
+-		if (Drives[drive]->isRemovable()) {
++		if (drive < 2) {
++			if (Drives[drive]) reg_al=drive+1;
++			else reg_al=1;
++		} else if (Drives[drive]->isRemovable()) {
+ 			DOS_SetError(DOSERR_FUNCTION_NUMBER_INVALID);
+ 			return false;
+-		}
+-		reg_al = 0;		/* Only 1 logical drive assigned */
++		} else reg_al=0;	/* Only 1 logical drive assigned */
++		reg_ah=0x07;
+ 		return true;
+ 	default:
+ 		LOG(LOG_DOSMISC,LOG_ERROR)("DOS:IOCTL Call %2X unhandled",reg_al);
+diff -Nur dosbox-0.74/src/dos/dos_keyboard_layout.cpp dosbox/src/dos/dos_keyboard_layout.cpp
+--- dosbox-0.74/src/dos/dos_keyboard_layout.cpp	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/dos/dos_keyboard_layout.cpp	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,7 +16,6 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: dos_keyboard_layout.cpp,v 1.22 2009-09-06 19:25:33 c2woody Exp $ */
+ 
+ #include "dosbox.h"
+ #include "bios.h"
+@@ -443,7 +442,14 @@
+ 					}
+ 				}
+ 
+-				current_layout[scan*layout_pages+layout_pages-1]=read_buf[read_buf_pos-2];	// flags
++				// calculate max length of entries, taking into account old number of entries
++				Bit8u new_flags=current_layout[scan*layout_pages+layout_pages-1]&0x7;
++				if ((read_buf[read_buf_pos-2]&0x7) > new_flags) new_flags = read_buf[read_buf_pos-2]&0x7;
++
++				// merge flag bits in as well
++				new_flags |= (read_buf[read_buf_pos-2] | current_layout[scan*layout_pages+layout_pages-1]) & 0xf0;
++
++				current_layout[scan*layout_pages+layout_pages-1]=new_flags;
+ 				if (read_buf[read_buf_pos-2]&0x80) scan_length*=2;		// granularity flag (S)
+ 			}
+ 			i+=scan_length;		// advance pointer
+diff -Nur dosbox-0.74/src/dos/dos_memory.cpp dosbox/src/dos/dos_memory.cpp
+--- dosbox-0.74/src/dos/dos_memory.cpp	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/dos/dos_memory.cpp	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,7 +16,6 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: dos_memory.cpp,v 1.45 2009-07-15 17:05:07 c2woody Exp $ */
+ 
+ #include "dosbox.h"
+ #include "mem.h"
+@@ -436,7 +435,7 @@
+ 	if (machine==MCH_TANDY) {
+ 		/* memory up to 608k available, the rest (to 640k) is used by
+ 			the tandy graphics system's variable mapping of 0xb800 */
+-		mcb.SetSize(0x97FF - DOS_MEM_START - mcb_sizes);
++		mcb.SetSize(0x9BFF - DOS_MEM_START - mcb_sizes);
+ 	} else if (machine==MCH_PCJR) {
+ 		/* memory from 128k to 640k is available */
+ 		mcb_devicedummy.SetPt((Bit16u)0x2000);
+diff -Nur dosbox-0.74/src/dos/dos_misc.cpp dosbox/src/dos/dos_misc.cpp
+--- dosbox-0.74/src/dos/dos_misc.cpp	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/dos/dos_misc.cpp	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,7 +16,6 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: dos_misc.cpp,v 1.24 2009-09-25 20:51:21 qbix79 Exp $ */
+ 
+ #include "dosbox.h"
+ #include "callback.h"
+diff -Nur dosbox-0.74/src/dos/dos_mscdex.cpp dosbox/src/dos/dos_mscdex.cpp
+--- dosbox-0.74/src/dos/dos_mscdex.cpp	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/dos/dos_mscdex.cpp	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,7 +16,6 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: dos_mscdex.cpp,v 1.59 2009-04-16 12:28:30 qbix79 Exp $ */
+ 
+ #include <string.h>
+ #include <ctype.h>
+@@ -152,6 +151,7 @@
+ 		bool	locked;			// drive locked ?
+ 		bool	lastResult;		// last operation success ?
+ 		Bit32u	volumeSize;		// for media change
++		TCtrl	audioCtrl;		// audio channel control
+ 	} TDriveInfo;
+ 
+ 	Bit16u				defaultBufSeg;
+@@ -160,6 +160,9 @@
+ 	
+ public:
+ 	Bit16u		rootDriverHeaderSeg;
++
++	bool		ChannelControl		(Bit8u subUnit, TCtrl ctrl);
++	bool		GetChannelControl	(Bit8u subUnit, TCtrl& ctrl);
+ };
+ 
+ CMscdex::CMscdex(void) {
+@@ -368,25 +371,34 @@
+ 		devHeader.SetInterrupt(off+5);
+ 	}
+ 
+-	subUnit = (Bit8u)numDrives;
+ 	// Set drive
+ 	DOS_DeviceHeader devHeader(PhysMake(rootDriverHeaderSeg,0));
+ 	devHeader.SetNumSubUnits(devHeader.GetNumSubUnits()+1);
+ 
+ 	if (dinfo[0].drive-1==_drive) {
+ 		CDROM_Interface *_cdrom = cdrom[numDrives];
++		CDROM_Interface_Image *_cdimg = CDROM_Interface_Image::images[numDrives];
+ 		for (Bit16u i=GetNumDrives(); i>0; i--) {
+ 			dinfo[i] = dinfo[i-1];
+ 			cdrom[i] = cdrom[i-1];
++			CDROM_Interface_Image::images[i] = CDROM_Interface_Image::images[i-1];
+ 		}
+ 		cdrom[0] = _cdrom;
++		CDROM_Interface_Image::images[0] = _cdimg;
+ 		dinfo[0].drive		= (Bit8u)_drive;
+ 		dinfo[0].physDrive	= (Bit8u)toupper(physicalPath[0]);
++		subUnit = 0;
+ 	} else {
+ 		dinfo[numDrives].drive		= (Bit8u)_drive;
+ 		dinfo[numDrives].physDrive	= (Bit8u)toupper(physicalPath[0]);
++		subUnit = (Bit8u)numDrives;
+ 	}
+ 	numDrives++;
++	// init channel control
++	for (Bit8u chan=0;chan<4;chan++) {
++		dinfo[subUnit].audioCtrl.out[chan]=chan;
++		dinfo[subUnit].audioCtrl.vol[chan]=0xff;
++	}
+ 	// stop audio
+ 	StopAudio(subUnit);
+ 	return result;
+@@ -426,8 +438,7 @@
+ 	};
+ }
+ 
+-bool CMscdex::GetCDInfo(Bit8u subUnit, Bit8u& tr1, Bit8u& tr2, TMSF& leadOut)
+-{
++bool CMscdex::GetCDInfo(Bit8u subUnit, Bit8u& tr1, Bit8u& tr2, TMSF& leadOut) {
+ 	if (subUnit>=numDrives) return false;
+ 	int tr1i,tr2i;
+ 	// Assume Media change
+@@ -443,23 +454,21 @@
+ 	return dinfo[subUnit].lastResult;
+ }
+ 
+-bool CMscdex::GetTrackInfo(Bit8u subUnit, Bit8u track, Bit8u& attr, TMSF& start)
+-{
++bool CMscdex::GetTrackInfo(Bit8u subUnit, Bit8u track, Bit8u& attr, TMSF& start) {
+ 	if (subUnit>=numDrives) return false;
+ 	dinfo[subUnit].lastResult = cdrom[subUnit]->GetAudioTrackInfo(track,start,attr);	
+ 	if (!dinfo[subUnit].lastResult) {
+ 		attr = 0;
+ 		memset(&start,0,sizeof(start));
+-	};
++	}
+ 	return dinfo[subUnit].lastResult;
+ }
+ 
+-bool CMscdex::PlayAudioSector(Bit8u subUnit, Bit32u sector, Bit32u length)
+-{
++bool CMscdex::PlayAudioSector(Bit8u subUnit, Bit32u sector, Bit32u length) {
+ 	if (subUnit>=numDrives) return false;
+ 	// If value from last stop is used, this is meant as a resume
+ 	// better start using resume command
+-	if (dinfo[subUnit].audioPaused && (sector==dinfo[subUnit].audioStart)) {
++	if (dinfo[subUnit].audioPaused && (sector==dinfo[subUnit].audioStart) && (dinfo[subUnit].audioEnd!=0)) {
+ 		dinfo[subUnit].lastResult = cdrom[subUnit]->PauseAudio(true);
+ 	} else 
+ 		dinfo[subUnit].lastResult = cdrom[subUnit]->PlayAudioSector(sector,length);
+@@ -469,12 +478,11 @@
+ 		dinfo[subUnit].audioPaused	= false;
+ 		dinfo[subUnit].audioStart	= sector;
+ 		dinfo[subUnit].audioEnd		= length;
+-	};
++	}
+ 	return dinfo[subUnit].lastResult;
+ }
+ 
+-bool CMscdex::PlayAudioMSF(Bit8u subUnit, Bit32u start, Bit32u length)
+-{
++bool CMscdex::PlayAudioMSF(Bit8u subUnit, Bit32u start, Bit32u length) {
+ 	if (subUnit>=numDrives) return false;
+ 	Bit8u min		= (Bit8u)(start>>16) & 0xFF;
+ 	Bit8u sec		= (Bit8u)(start>> 8) & 0xFF;
+@@ -483,48 +491,61 @@
+ 	return dinfo[subUnit].lastResult = PlayAudioSector(subUnit,sector,length);
+ }
+ 
+-bool CMscdex::GetSubChannelData(Bit8u subUnit, Bit8u& attr, Bit8u& track, Bit8u &index, TMSF& rel, TMSF& abs)
+-{
++bool CMscdex::GetSubChannelData(Bit8u subUnit, Bit8u& attr, Bit8u& track, Bit8u &index, TMSF& rel, TMSF& abs) {
+ 	if (subUnit>=numDrives) return false;
+ 	dinfo[subUnit].lastResult = cdrom[subUnit]->GetAudioSub(attr,track,index,rel,abs);
+ 	if (!dinfo[subUnit].lastResult) {
+ 		attr = track = index = 0;
+ 		memset(&rel,0,sizeof(rel));
+ 		memset(&abs,0,sizeof(abs));
+-	};
++	}
+ 	return dinfo[subUnit].lastResult;
+ }
+ 
+-bool CMscdex::GetAudioStatus(Bit8u subUnit, bool& playing, bool& pause, TMSF& start, TMSF& end)
+-{
++bool CMscdex::GetAudioStatus(Bit8u subUnit, bool& playing, bool& pause, TMSF& start, TMSF& end) {
+ 	if (subUnit>=numDrives) return false;
+ 	dinfo[subUnit].lastResult = cdrom[subUnit]->GetAudioStatus(playing,pause);
+ 	if (dinfo[subUnit].lastResult) {
+-		// Start
+-		Bit32u addr	= dinfo[subUnit].audioStart + 150;
+-		start.fr	= (Bit8u)(addr%75);	addr/=75;
+-		start.sec	= (Bit8u)(addr%60); 
+-		start.min	= (Bit8u)(addr/60);
+-		// End
+-		addr		= dinfo[subUnit].audioEnd + 150;
+-		end.fr		= (Bit8u)(addr%75);	addr/=75;
+-		end.sec		= (Bit8u)(addr%60); 
+-		end.min		= (Bit8u)(addr/60);
++		if (playing) {
++			// Start
++			Bit32u addr	= dinfo[subUnit].audioStart + 150;
++			start.fr	= (Bit8u)(addr%75);	addr/=75;
++			start.sec	= (Bit8u)(addr%60); 
++			start.min	= (Bit8u)(addr/60);
++			// End
++			addr		= dinfo[subUnit].audioEnd + 150;
++			end.fr		= (Bit8u)(addr%75);	addr/=75;
++			end.sec		= (Bit8u)(addr%60); 
++			end.min		= (Bit8u)(addr/60);
++		} else {
++			memset(&start,0,sizeof(start));
++			memset(&end,0,sizeof(end));
++		}
+ 	} else {
+ 		playing		= false;
+ 		pause		= false;
+ 		memset(&start,0,sizeof(start));
+ 		memset(&end,0,sizeof(end));
+-	};
++	}
+ 	
+ 	return dinfo[subUnit].lastResult;
+ }
+ 
+-bool CMscdex::StopAudio(Bit8u subUnit)
+-{
++bool CMscdex::StopAudio(Bit8u subUnit) {
+ 	if (subUnit>=numDrives) return false;
+-	if (dinfo[subUnit].audioPlay)	dinfo[subUnit].lastResult = cdrom[subUnit]->PauseAudio(false);
+-	else							dinfo[subUnit].lastResult = cdrom[subUnit]->StopAudio();
++	if (dinfo[subUnit].audioPlay) {
++		// Check if audio is still playing....
++		TMSF start,end;
++		bool playing,pause;
++		if (GetAudioStatus(subUnit,playing,pause,start,end))
++			dinfo[subUnit].audioPlay = playing;
++		else
++			dinfo[subUnit].audioPlay = false;
++	}
++	if (dinfo[subUnit].audioPlay)
++		dinfo[subUnit].lastResult = cdrom[subUnit]->PauseAudio(false);
++	else
++		dinfo[subUnit].lastResult = cdrom[subUnit]->StopAudio();
+ 	
+ 	if (dinfo[subUnit].lastResult) {
+ 		if (dinfo[subUnit].audioPlay) {
+@@ -536,9 +557,9 @@
+ 			dinfo[subUnit].audioPaused  = false;
+ 			dinfo[subUnit].audioStart	= 0;
+ 			dinfo[subUnit].audioEnd		= 0;
+-		};
++		}
+ 		dinfo[subUnit].audioPlay = false;
+-	};
++	}
+ 	return dinfo[subUnit].lastResult;
+ }
+ 
+@@ -600,8 +621,13 @@
+ 	PhysPt ptoc = GetTempBuffer();
+ 	success = ReadVTOC(drive,0x00,ptoc,error);
+ 	if (success) {
+-		MEM_BlockCopy(data,ptoc+702,37);
+-		mem_writeb(data+37,0);
++		Bitu len;
++		for (len=0;len<37;len++) {
++			Bit8u c=mem_readb(ptoc+702+len);
++			if (c==0 || c==0x20) break;
++		}
++		MEM_BlockCopy(data,ptoc+702,len);
++		mem_writeb(data+len,0);
+ 	};
+ 	return success; 
+ }
+@@ -612,8 +638,13 @@
+ 	PhysPt ptoc = GetTempBuffer();
+ 	success = ReadVTOC(drive,0x00,ptoc,error);
+ 	if (success) {
+-		MEM_BlockCopy(data,ptoc+739,37);
+-		mem_writeb(data+37,0);
++		Bitu len;
++		for (len=0;len<37;len++) {
++			Bit8u c=mem_readb(ptoc+739+len);
++			if (c==0 || c==0x20) break;
++		}
++		MEM_BlockCopy(data,ptoc+739,len);
++		mem_writeb(data+len,0);
+ 	};
+ 	return success; 
+ }
+@@ -624,8 +655,13 @@
+ 	PhysPt ptoc = GetTempBuffer();
+ 	success = ReadVTOC(drive,0x00,ptoc,error);
+ 	if (success) {
+-		MEM_BlockCopy(data,ptoc+776,37);
+-		mem_writeb(data+37,0);
++		Bitu len;
++		for (len=0;len<37;len++) {
++			Bit8u c=mem_readb(ptoc+776+len);
++			if (c==0 || c==0x20) break;
++		}
++		MEM_BlockCopy(data,ptoc+776,len);
++		mem_writeb(data+len,0);
+ 	};
+ 	return success; 
+ }
+@@ -658,13 +694,13 @@
+ 	return ReadSectors(GetSubUnit(drive),false,sector,num,data);
+ }
+ 
+-bool CMscdex::GetDirectoryEntry(Bit16u drive, bool copyFlag, PhysPt pathname, PhysPt buffer, Bit16u& error)
+-{
++bool CMscdex::GetDirectoryEntry(Bit16u drive, bool copyFlag, PhysPt pathname, PhysPt buffer, Bit16u& error) {
+ 	char	volumeID[6] = {0};
+ 	char	searchName[256];
+ 	char	entryName[256];
+ 	bool	foundComplete = false;
+ 	bool	foundName;
++	bool	nextPart = true;
+ 	char*	useName = 0;
+ 	Bitu	entryLength,nameLength;
+ 	// clear error
+@@ -695,14 +731,15 @@
+ 		if (!ReadSectors(GetSubUnit(drive),false,dirEntrySector,1,defBuffer)) return false;
+ 		// Get string part
+ 		foundName	= false;
+-		if (searchPos) { 
+-			useName = searchPos; 
+-			searchPos = strchr(searchPos,'\\'); 
++		if (nextPart) {
++			if (searchPos) { 
++				useName = searchPos; 
++				searchPos = strchr(searchPos,'\\'); 
++			}
++			if (searchPos) { *searchPos = 0; searchPos++; }
++			else foundComplete = true;
+ 		}
+ 
+-	   	if (searchPos) { *searchPos = 0; searchPos++; }
+-		else foundComplete = true;
+-
+ 		do {
+ 			entryLength = mem_readb(defBuffer+index);
+ 			if (entryLength==0) break;
+@@ -759,18 +796,19 @@
+ 			// change directory
+ 			dirEntrySector = mem_readd(defBuffer+index+2);
+ 			dirSize	= mem_readd(defBuffer+index+10);
++			nextPart = true;
+ 		} else {
+ 			// continue search in next sector
+ 			dirSize -= 2048;
+ 			dirEntrySector++;
++			nextPart = false;
+ 		}
+-	};
++	}
+ 	error = 2; // file not found
+ 	return false; // not found
+ }
+ 
+-bool CMscdex::GetCurrentPos(Bit8u subUnit, TMSF& pos)
+-{
++bool CMscdex::GetCurrentPos(Bit8u subUnit, TMSF& pos) {
+ 	if (subUnit>=numDrives) return false;
+ 	TMSF rel;
+ 	Bit8u attr,track,index;
+@@ -779,30 +817,39 @@
+ 	return dinfo[subUnit].lastResult;
+ }
+ 
+-bool CMscdex::GetMediaStatus(Bit8u subUnit, bool& media, bool& changed, bool& trayOpen)
+-{
++bool CMscdex::GetMediaStatus(Bit8u subUnit, bool& media, bool& changed, bool& trayOpen) {
+ 	if (subUnit>=numDrives) return false;
+ 	dinfo[subUnit].lastResult = cdrom[subUnit]->GetMediaTrayStatus(media,changed,trayOpen);
+ 	return dinfo[subUnit].lastResult;
+ }
+ 
+-Bit32u CMscdex::GetDeviceStatus(Bit8u subUnit)
+-{
++Bit32u CMscdex::GetDeviceStatus(Bit8u subUnit) {
+ 	if (subUnit>=numDrives) return false;
+ 	bool media,changed,trayOpen;
+ 
+ 	dinfo[subUnit].lastResult = GetMediaStatus(subUnit,media,changed,trayOpen);
+-	Bit32u status = (trayOpen << 0)					|	// Drive is open ?
+-					(dinfo[subUnit].locked	<< 1)	|	// Drive is locked ?
+-					(1<<2)							|	// raw + cooked sectors
+-					(1<<4)							|	// Can read sudio
+-					(1<<9)							|	// Red book & HSG
+-					((!media) << 11);					// Drive is empty ?
++	if (dinfo[subUnit].audioPlay) {
++		// Check if audio is still playing....
++		TMSF start,end;
++		bool playing,pause;
++		if (GetAudioStatus(subUnit,playing,pause,start,end))
++			dinfo[subUnit].audioPlay = playing;
++		else
++			dinfo[subUnit].audioPlay = false;
++	}
++
++	Bit32u status = ((trayOpen?1:0) << 0)					|	// Drive is open ?
++					((dinfo[subUnit].locked?1:0) << 1)		|	// Drive is locked ?
++					(1<<2)									|	// raw + cooked sectors
++					(1<<4)									|	// Can read sudio
++					(1<<8)									|	// Can control audio
++					(1<<9)									|	// Red book & HSG
++					((dinfo[subUnit].audioPlay?1:0) << 10)	|	// Audio is playing ?
++					((media?0:1) << 11);						// Drive is empty ?
+ 	return status;
+ }
+ 
+-bool CMscdex::GetMediaStatus(Bit8u subUnit, Bit8u& status)
+-{
++bool CMscdex::GetMediaStatus(Bit8u subUnit, Bit8u& status) {
+ 	if (subUnit>=numDrives) return false;
+ /*	bool media,changed,open,result;
+ 	result = GetMediaStatus(subUnit,media,changed,open);
+@@ -812,15 +859,13 @@
+ 	return true;
+ }
+ 
+-bool CMscdex::LoadUnloadMedia(Bit8u subUnit, bool unload)
+-{
++bool CMscdex::LoadUnloadMedia(Bit8u subUnit, bool unload) {
+ 	if (subUnit>=numDrives) return false;
+ 	dinfo[subUnit].lastResult = cdrom[subUnit]->LoadUnloadMedia(unload);
+ 	return dinfo[subUnit].lastResult;
+ }
+ 
+-bool CMscdex::SendDriverRequest(Bit16u drive, PhysPt data)
+-{
++bool CMscdex::SendDriverRequest(Bit16u drive, PhysPt data) {
+ 	Bit8u subUnit = GetSubUnit(drive);
+ 	if (subUnit>=numDrives) return false;
+ 	// Get SubUnit
+@@ -831,8 +876,7 @@
+ 	return true;
+ }
+ 
+-Bit16u CMscdex::GetStatusWord(Bit8u subUnit,Bit16u status)
+-{
++Bit16u CMscdex::GetStatusWord(Bit8u subUnit,Bit16u status) {
+ 	if (subUnit>=numDrives) return REQUEST_STATUS_ERROR | 0x02; // error : Drive not ready
+ 
+ 	if (dinfo[subUnit].lastResult)	status |= REQUEST_STATUS_DONE;				// ok
+@@ -860,6 +904,22 @@
+ 	}
+ }
+ 
++bool CMscdex::ChannelControl(Bit8u subUnit, TCtrl ctrl) {
++	if (subUnit>=numDrives) return false;
++	// adjust strange channel mapping
++	if (ctrl.out[0]>1) ctrl.out[0]=0;
++	if (ctrl.out[1]>1) ctrl.out[1]=1;
++	dinfo[subUnit].audioCtrl=ctrl;
++	cdrom[subUnit]->ChannelControl(ctrl);
++	return true;
++}
++
++bool CMscdex::GetChannelControl(Bit8u subUnit, TCtrl& ctrl) {
++	if (subUnit>=numDrives) return false;
++	ctrl=dinfo[subUnit].audioCtrl;
++	return true;
++}
++
+ static CMscdex* mscdex = 0;
+ static PhysPt curReqheaderPtr = 0;
+ 
+@@ -889,6 +949,14 @@
+ 						return 0x03;		// invalid function
+ 					}
+ 				   }break;
++		case 0x04 : /* Audio Channel control */
++					TCtrl ctrl;
++					if (!mscdex->GetChannelControl(drive_unit,ctrl)) return 0x01;
++					for (Bit8u chan=0;chan<4;chan++) {
++						mem_writeb(buffer+chan*2+1,ctrl.out[chan]);
++						mem_writeb(buffer+chan*2+2,ctrl.vol[chan]);
++					}
++					break;
+ 		case 0x06 : /* Get Device status */
+ 					mem_writed(buffer+1,mscdex->GetDeviceStatus(drive_unit)); 
+ 					break;
+@@ -980,7 +1048,13 @@
+ 					if (!mscdex->LoadUnloadMedia(drive_unit,true)) return 0x02;
+ 					break;
+ 		case 0x03: //Audio Channel control
+-					MSCDEX_LOG("MSCDEX: Audio Channel Control used. Not handled. Faking succes!");
++					TCtrl ctrl;
++					for (Bit8u chan=0;chan<4;chan++) {
++						ctrl.out[chan]=mem_readb(buffer+chan*2+1);
++						ctrl.vol[chan]=mem_readb(buffer+chan*2+2);
++					}
++					if (!mscdex->ChannelControl(drive_unit,ctrl)) return 0x01;
++					break;
+ 		case 0x01 : // (un)Lock door 
+ 					// do nothing -> report as success
+ 					break;
+@@ -990,6 +1064,7 @@
+ 					break;
+ 		case 0x05 :	// load media
+ 					if (!mscdex->LoadUnloadMedia(drive_unit,false)) return 0x02;
++					break;
+ 		default	:	LOG(LOG_MISC,LOG_ERROR)("MSCDEX: Unsupported IOCTL OUTPUT Subfunction %02X",ioctl_fct);
+ 					return 0x03;	// invalid function
+ 	}
+diff -Nur dosbox-0.74/src/dos/dos_programs.cpp dosbox/src/dos/dos_programs.cpp
+--- dosbox-0.74/src/dos/dos_programs.cpp	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/dos/dos_programs.cpp	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,7 +16,6 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: dos_programs.cpp,v 1.94 2009-06-12 20:10:09 c2woody Exp $ */
+ 
+ #include "dosbox.h"
+ #include <stdlib.h>
+@@ -34,6 +33,7 @@
+ #include "dos_system.h"
+ #include "dos_inc.h"
+ #include "bios.h"
++#include "bios_disk.h" 
+ #include "setup.h"
+ #include "control.h"
+ 
+@@ -49,27 +49,55 @@
+ #endif
+ 
+ void MSCDEX_SetCDInterface(int intNr, int forceCD);
+-
++static Bitu ZDRIVE_NUM = 25;
+ 
+ class MOUNT : public Program {
+ public:
+-	void Run(void)
+-	{
++	void ListMounts(void) {
++		char name[DOS_NAMELENGTH_ASCII];Bit32u size;Bit16u date;Bit16u time;Bit8u attr;
++		/* Command uses dta so set it to our internal dta */
++		RealPt save_dta = dos.dta();
++		dos.dta(dos.tables.tempdta);
++		DOS_DTA dta(dos.dta());
++
++		WriteOut(MSG_Get("PROGRAM_MOUNT_STATUS_1"));
++		WriteOut(MSG_Get("PROGRAM_MOUNT_STATUS_FORMAT"),"Drive","Type","Label");
++		for(int p = 0;p < 8;p++) WriteOut("----------");
++
++		for (int d = 0;d < DOS_DRIVES;d++) {
++			if (!Drives[d]) continue;
++
++			char root[4] = {'A'+d,':','\\',0};
++			bool ret = DOS_FindFirst(root,DOS_ATTR_VOLUME);
++			if (ret) {
++				dta.GetResult(name,size,date,time,attr);
++				DOS_FindNext(); //Mark entry as invalid
++			} else name[0] = 0;
++
++			/* Change 8.3 to 11.0 */
++			char* dot = strchr(name,'.');
++			if(dot && (dot - name == 8) ) { 
++				name[8] = name[9];name[9] = name[10];name[10] = name[11];name[11] = 0;
++			}
++
++			root[1] = 0; //This way, the format string can be reused.
++			WriteOut(MSG_Get("PROGRAM_MOUNT_STATUS_FORMAT"),root, Drives[d]->GetInfo(),name);		
++		}
++		dos.dta(save_dta);
++	}
++
++	void Run(void) {
+ 		DOS_Drive * newdrive;char drive;
+ 		std::string label;
+ 		std::string umount;
++		std::string newz;
+ 
+ 		//Hack To allow long commandlines
+ 		ChangeToLongCmd();
+ 		/* Parse the command line */
+ 		/* if the command line is empty show current mounts */
+ 		if (!cmd->GetCount()) {
+-			WriteOut(MSG_Get("PROGRAM_MOUNT_STATUS_1"));
+-			for (int d=0;d<DOS_DRIVES;d++) {
+-				if (Drives[d]) {
+-					WriteOut(MSG_Get("PROGRAM_MOUNT_STATUS_2"),d+'A',Drives[d]->GetInfo());
+-				}
+-			}
++			ListMounts();
+ 			return;
+ 		}
+ 
+@@ -84,12 +112,12 @@
+ 		if (cmd->FindString("-u",umount,false)) {
+ 			umount[0] = toupper(umount[0]);
+ 			int i_drive = umount[0]-'A';
+-				if(i_drive < DOS_DRIVES && i_drive >= 0 && Drives[i_drive]) {
++				if (i_drive < DOS_DRIVES && i_drive >= 0 && Drives[i_drive]) {
+ 					switch (DriveManager::UnmountDrive(i_drive)) {
+ 					case 0:
+ 						Drives[i_drive] = 0;
+ 						if(i_drive == DOS_GetDefaultDrive()) 
+-							DOS_SetDrive(toupper('Z') - 'A');
++							DOS_SetDrive(ZDRIVE_NUM);
+ 						WriteOut(MSG_Get("PROGRAM_MOUNT_UMOUNT_SUCCESS"),umount[0]);
+ 						break;
+ 					case 1:
+@@ -104,8 +132,46 @@
+ 				}
+ 			return;
+ 		}
+-	   
+-		// Show list of cdroms
++		
++		/* Check for moving Z: */
++		/* Only allowing moving it once. It is merely a convenience added for the wine team */
++		if (ZDRIVE_NUM == 25 && cmd->FindString("-z", newz,false)) {
++			newz[0] = toupper(newz[0]);
++			int i_newz = newz[0] - 'A';
++			if (i_newz >= 0 && i_newz < DOS_DRIVES-1 && !Drives[i_newz]) {
++				ZDRIVE_NUM = i_newz;
++				/* remap drives */
++				Drives[i_newz] = Drives[25];
++				Drives[25] = 0;
++				DOS_Shell *fs = static_cast<DOS_Shell *>(first_shell); //dynamic ?				
++				/* Update environment */
++				std::string line = "";
++				char ppp[2] = {newz[0],0};
++				std::string tempenv = ppp; tempenv += ":\\";
++				if (fs->GetEnvStr("PATH",line)){
++					std::string::size_type idx = line.find('=');
++					std::string value = line.substr(idx +1 , std::string::npos);
++					while ( (idx = value.find("Z:\\")) != std::string::npos ||
++					        (idx = value.find("z:\\")) != std::string::npos  )
++						value.replace(idx,3,tempenv);
++					line = value;
++				}
++				if (!line.size()) line = tempenv;
++				fs->SetEnv("PATH",line.c_str());
++				tempenv += "COMMAND.COM";
++				fs->SetEnv("COMSPEC",tempenv.c_str());
++
++				/* Update batch file if running from Z: (very likely: autoexec) */
++				if(fs->bf) {
++					std::string &name = fs->bf->filename;
++					if(name.length() >2 &&  name[0] == 'Z' && name[1] == ':') name[0] = newz[0];
++				}
++				/* Change the active drive */
++				if (DOS_GetDefaultDrive() == 25) DOS_SetDrive(i_newz);
++			}
++			return;
++		}
++		/* Show list of cdroms */
+ 		if (cmd->FindExist("-cd",false)) {
+ 			int num = SDL_CDNumDrives();
+    			WriteOut(MSG_Get("PROGRAM_MOUNT_CDROMS_FOUND"),num);
+@@ -126,9 +192,9 @@
+ 				str_size="512,1,2880,2880";/* All space free */
+ 				mediaid=0xF0;		/* Floppy 1.44 media */
+ 			} else if (type=="dir") {
+-				// 512*127*16383==~1GB total size
+-				// 512*127*4031==~250MB total free size
+-				str_size="512,127,16383,4031";
++				// 512*32*32765==~500MB total size
++				// 512*32*16000==~250MB total free size
++				str_size="512,32,32765,16000";
+ 				mediaid=0xF8;		/* Hard Disk */
+ 			} else if (type=="cdrom") {
+ 				str_size="2048,1,65535,0";
+@@ -141,11 +207,17 @@
+ 			std::string mb_size;
+ 			if(cmd->FindString("-freesize",mb_size,true)) {
+ 				char teststr[1024];
+-				Bit16u sizemb = static_cast<Bit16u>(atoi(mb_size.c_str()));
++				Bit16u freesize = static_cast<Bit16u>(atoi(mb_size.c_str()));
+ 				if (type=="floppy") {
+-					sprintf(teststr,"512,1,2880,%d",sizemb*1024/(512*1));
++					// freesize in kb
++					sprintf(teststr,"512,1,2880,%d",freesize*1024/(512*1));
+ 				} else {
+-					sprintf(teststr,"512,127,16513,%d",sizemb*1024*1024/(512*127));
++					Bit32u total_size_cyl=32765;
++					Bit32u free_size_cyl=(Bit32u)freesize*1024*1024/(512*32);
++					if (free_size_cyl>65534) free_size_cyl=65534;
++					if (total_size_cyl<free_size_cyl) total_size_cyl=free_size_cyl+10;
++					if (total_size_cyl>65534) total_size_cyl=65534;
++					sprintf(teststr,"512,32,%d,%d",total_size_cyl,free_size_cyl);
+ 				}
+ 				str_size=teststr;
+ 			}
+@@ -319,6 +391,7 @@
+ 			label = drive; label += "_FLOPPY";
+ 			newdrive->dirCache.SetLabel(label.c_str(),iscdrom,true);
+ 		}
++		if(type == "floppy") incrementFDD();
+ 		return;
+ showusage:
+ #if defined (WIN32) || defined(OS2)
+@@ -908,11 +981,29 @@
+ 
+ void RESCAN::Run(void) 
+ {
+-	// Get current drive
++	bool all = false;
++	
+ 	Bit8u drive = DOS_GetDefaultDrive();
+-	if (Drives[drive]) {
+-		Drives[drive]->EmptyCache();
++	
++	if(cmd->FindCommand(1,temp_line)) {
++		//-A -All /A /All 
++		if(temp_line.size() >= 2 && (temp_line[0] == '-' ||temp_line[0] =='/')&& (temp_line[1] == 'a' || temp_line[1] =='A') ) all = true;
++		else if(temp_line.size() == 2 && temp_line[1] == ':') {
++			lowcase(temp_line);
++			drive  = temp_line[0] - 'a';
++		}
++	}
++	// Get current drive
++	if (all) {
++		for(Bitu i =0; i<DOS_DRIVES;i++) {
++			if (Drives[i]) Drives[i]->EmptyCache();
++		}
+ 		WriteOut(MSG_Get("PROGRAM_RESCAN_SUCCESS"));
++	} else {
++		if (drive < DOS_DRIVES && Drives[drive]) {
++			Drives[drive]->EmptyCache();
++			WriteOut(MSG_Get("PROGRAM_RESCAN_SUCCESS"));
++		}
+ 	}
+ }
+ 
+@@ -1026,7 +1117,7 @@
+ 			if (type=="floppy") {
+ 				mediaid=0xF0;		
+ 			} else if (type=="iso") {
+-				str_size="650,127,16513,1700";
++				str_size=="2048,1,60000,0";	// ignored, see drive_iso.cpp (AllocationInfo)
+ 				mediaid=0xF8;		
+ 				fstype = "iso";
+ 			} 
+@@ -1123,10 +1214,6 @@
+ 			}
+ 			if (paths.size() == 1)
+ 				temp_line = paths[0];
+-			if (paths.size() > 1 && fstype != "iso") {
+-				WriteOut(MSG_Get("PROGRAM_IMGMOUNT_MULTIPLE_NON_CUEISO_FILES"));
+-				return;
+-			}
+ 
+ 			if(fstype=="fat") {
+ 				if (imgsizedetect) {
+@@ -1158,12 +1245,122 @@
+ 					LOG_MSG("autosized image file: %d:%d:%d:%d",sizes[0],sizes[1],sizes[2],sizes[3]);
+ 				}
+ 
+-				newdrive=new fatDrive(temp_line.c_str(),sizes[0],sizes[1],sizes[2],sizes[3],0);
+-				if(!(dynamic_cast<fatDrive*>(newdrive))->created_successfully) {
+-					delete newdrive;
+-					newdrive = 0;
++				if (Drives[drive-'A']) {
++					WriteOut(MSG_Get("PROGRAM_IMGMOUNT_ALREADY_MOUNTED"));
++					return;
++				}
++
++				std::vector<DOS_Drive*> imgDisks;
++				std::vector<std::string>::size_type i;
++				std::vector<DOS_Drive*>::size_type ct;
++				
++				for (i = 0; i < paths.size(); i++) {
++					DOS_Drive* newDrive = new fatDrive(paths[i].c_str(),sizes[0],sizes[1],sizes[2],sizes[3],0);
++					imgDisks.push_back(newDrive);
++					if(!(dynamic_cast<fatDrive*>(newDrive))->created_successfully) {
++						WriteOut(MSG_Get("PROGRAM_IMGMOUNT_CANT_CREATE"));
++						for(ct = 0; ct < imgDisks.size(); ct++) {
++							delete imgDisks[ct];
++						}
++						return;
++					}
++				}
++
++				// Update DriveManager
++				for(ct = 0; ct < imgDisks.size(); ct++) {
++					DriveManager::AppendDisk(drive - 'A', imgDisks[ct]);
++				}
++				DriveManager::InitializeDrive(drive - 'A');
++
++				// Set the correct media byte in the table 
++				mem_writeb(Real2Phys(dos.tables.mediaid) + (drive - 'A') * 2, mediaid);
++				
++				/* Command uses dta so set it to our internal dta */
++				RealPt save_dta = dos.dta();
++				dos.dta(dos.tables.tempdta);
++
++				for(ct = 0; ct < imgDisks.size(); ct++) {
++					DriveManager::CycleAllDisks();
++
++					char root[4] = {drive, ':', '\\', 0};
++					DOS_FindFirst(root, DOS_ATTR_VOLUME); // force obtaining the label and saving it in dirCache
++				}
++				dos.dta(save_dta);
++
++				std::string tmp(paths[0]);
++				for (i = 1; i < paths.size(); i++) {
++					tmp += "; " + paths[i];
++				}
++				WriteOut(MSG_Get("PROGRAM_MOUNT_STATUS_2"), drive, tmp.c_str());
++
++				if (paths.size() == 1) {
++					newdrive = imgDisks[0];
++					if(((fatDrive *)newdrive)->loadedDisk->hardDrive) {
++						if(imageDiskList[2] == NULL) {
++							imageDiskList[2] = ((fatDrive *)newdrive)->loadedDisk;
++							updateDPT();
++							return;
++						}
++						if(imageDiskList[3] == NULL) {
++							imageDiskList[3] = ((fatDrive *)newdrive)->loadedDisk;
++							updateDPT();
++							return;
++						}
++					}
++					if(!((fatDrive *)newdrive)->loadedDisk->hardDrive) {
++						imageDiskList[0] = ((fatDrive *)newdrive)->loadedDisk;
++					}
+ 				}
+ 			} else if (fstype=="iso") {
++
++				if (Drives[drive-'A']) {
++					WriteOut(MSG_Get("PROGRAM_IMGMOUNT_ALREADY_MOUNTED"));
++					return;
++				}
++				MSCDEX_SetCDInterface(CDROM_USE_SDL, -1);
++				// create new drives for all images
++				std::vector<DOS_Drive*> isoDisks;
++				std::vector<std::string>::size_type i;
++				std::vector<DOS_Drive*>::size_type ct;
++				for (i = 0; i < paths.size(); i++) {
++					int error = -1;
++					DOS_Drive* newDrive = new isoDrive(drive, paths[i].c_str(), mediaid, error);
++					isoDisks.push_back(newDrive);
++					switch (error) {
++						case 0  :	break;
++						case 1  :	WriteOut(MSG_Get("MSCDEX_ERROR_MULTIPLE_CDROMS"));	break;
++						case 2  :	WriteOut(MSG_Get("MSCDEX_ERROR_NOT_SUPPORTED"));	break;
++						case 3  :	WriteOut(MSG_Get("MSCDEX_ERROR_OPEN"));				break;
++						case 4  :	WriteOut(MSG_Get("MSCDEX_TOO_MANY_DRIVES"));		break;
++						case 5  :	WriteOut(MSG_Get("MSCDEX_LIMITED_SUPPORT"));		break;
++						case 6  :	WriteOut(MSG_Get("MSCDEX_INVALID_FILEFORMAT"));		break;
++						default :	WriteOut(MSG_Get("MSCDEX_UNKNOWN_ERROR"));			break;
++					}
++					// error: clean up and leave
++					if (error) {
++						for(ct = 0; ct < isoDisks.size(); ct++) {
++							delete isoDisks[ct];
++						}
++						return;
++					}
++				}
++				// Update DriveManager
++				for(ct = 0; ct < isoDisks.size(); ct++) {
++					DriveManager::AppendDisk(drive - 'A', isoDisks[ct]);
++				}
++				DriveManager::InitializeDrive(drive - 'A');
++				
++				// Set the correct media byte in the table 
++				mem_writeb(Real2Phys(dos.tables.mediaid) + (drive - 'A') * 2, mediaid);
++				
++				// Print status message (success)
++				WriteOut(MSG_Get("MSCDEX_SUCCESS"));
++				std::string tmp(paths[0]);
++				for (i = 1; i < paths.size(); i++) {
++					tmp += "; " + paths[i];
++				}
++				WriteOut(MSG_Get("PROGRAM_MOUNT_STATUS_2"), drive, tmp.c_str());
++
+ 			} else {
+ 				FILE *newDisk = fopen(temp_line.c_str(), "rb+");
+ 				fseek(newDisk,0L, SEEK_END);
+@@ -1177,82 +1374,7 @@
+ 			return;
+ 		}
+ 
+-		if(fstype=="fat") {
+-			if (Drives[drive-'A']) {
+-				WriteOut(MSG_Get("PROGRAM_IMGMOUNT_ALREADY_MOUNTED"));
+-				if (newdrive) delete newdrive;
+-				return;
+-			}
+-			if (!newdrive) {WriteOut(MSG_Get("PROGRAM_IMGMOUNT_CANT_CREATE"));return;}
+-			Drives[drive-'A']=newdrive;
+-			// Set the correct media byte in the table 
+-			mem_writeb(Real2Phys(dos.tables.mediaid)+(drive-'A')*2,mediaid);
+-			WriteOut(MSG_Get("PROGRAM_MOUNT_STATUS_2"),drive,temp_line.c_str());
+-			if(((fatDrive *)newdrive)->loadedDisk->hardDrive) {
+-				if(imageDiskList[2] == NULL) {
+-					imageDiskList[2] = ((fatDrive *)newdrive)->loadedDisk;
+-					updateDPT();
+-					return;
+-				}
+-				if(imageDiskList[3] == NULL) {
+-					imageDiskList[3] = ((fatDrive *)newdrive)->loadedDisk;
+-					updateDPT();
+-					return;
+-				}
+-			}
+-			if(!((fatDrive *)newdrive)->loadedDisk->hardDrive) {
+-				imageDiskList[0] = ((fatDrive *)newdrive)->loadedDisk;
+-			}
+-		} else if (fstype=="iso") {
+-			if (Drives[drive-'A']) {
+-				WriteOut(MSG_Get("PROGRAM_IMGMOUNT_ALREADY_MOUNTED"));
+-				return;
+-			}
+-			MSCDEX_SetCDInterface(CDROM_USE_SDL, -1);
+-			// create new drives for all images
+-			std::vector<DOS_Drive*> isoDisks;
+-			std::vector<std::string>::size_type i;
+-			std::vector<DOS_Drive*>::size_type ct;
+-			for (i = 0; i < paths.size(); i++) {
+-				int error = -1;
+-				DOS_Drive* newDrive = new isoDrive(drive, paths[i].c_str(), mediaid, error);
+-				isoDisks.push_back(newDrive);
+-				switch (error) {
+-					case 0  :	break;
+-					case 1  :	WriteOut(MSG_Get("MSCDEX_ERROR_MULTIPLE_CDROMS"));	break;
+-					case 2  :	WriteOut(MSG_Get("MSCDEX_ERROR_NOT_SUPPORTED"));	break;
+-					case 3  :	WriteOut(MSG_Get("MSCDEX_ERROR_OPEN"));				break;
+-					case 4  :	WriteOut(MSG_Get("MSCDEX_TOO_MANY_DRIVES"));		break;
+-					case 5  :	WriteOut(MSG_Get("MSCDEX_LIMITED_SUPPORT"));		break;
+-					case 6  :	WriteOut(MSG_Get("MSCDEX_INVALID_FILEFORMAT"));		break;
+-					default :	WriteOut(MSG_Get("MSCDEX_UNKNOWN_ERROR"));			break;
+-				}
+-				// error: clean up and leave
+-				if (error) {
+-					for(ct = 0; ct < isoDisks.size(); ct++) {
+-						delete isoDisks[ct];
+-					}
+-					return;
+-				}
+-			}
+-			// Update DriveManager
+-			for(ct = 0; ct < isoDisks.size(); ct++) {
+-				DriveManager::AppendDisk(drive - 'A', isoDisks[ct]);
+-			}
+-			DriveManager::InitializeDrive(drive - 'A');
+-			
+-			// Set the correct media byte in the table 
+-			mem_writeb(Real2Phys(dos.tables.mediaid) + (drive - 'A') * 2, mediaid);
+-			
+-			// Print status message (success)
+-			WriteOut(MSG_Get("MSCDEX_SUCCESS"));
+-			std::string tmp(paths[0]);
+-			for (i = 1; i < paths.size(); i++) {
+-				tmp += "; " + paths[i];
+-			}
+-			WriteOut(MSG_Get("PROGRAM_MOUNT_STATUS_2"), drive, tmp.c_str());
+-			
+-		} else if (fstype=="none") {
++		if (fstype=="none") {
+ 			if(imageDiskList[drive-'0'] != NULL) delete imageDiskList[drive-'0'];
+ 			imageDiskList[drive-'0'] = newImage;
+ 			updateDPT();
+@@ -1347,8 +1469,9 @@
+ 	/*Add Messages */
+ 
+ 	MSG_Add("PROGRAM_MOUNT_CDROMS_FOUND","CDROMs found: %d\n");
++	MSG_Add("PROGRAM_MOUNT_STATUS_FORMAT","%-5s  %-58s %-12s\n");
+ 	MSG_Add("PROGRAM_MOUNT_STATUS_2","Drive %c is mounted as %s\n");
+-	MSG_Add("PROGRAM_MOUNT_STATUS_1","Current mounted drives are:\n");
++	MSG_Add("PROGRAM_MOUNT_STATUS_1","The currently mounted drives are:\n");
+ 	MSG_Add("PROGRAM_MOUNT_ERROR_1","Directory %s doesn't exist.\n");
+ 	MSG_Add("PROGRAM_MOUNT_ERROR_2","%s isn't a directory\n");
+ 	MSG_Add("PROGRAM_MOUNT_ILL_TYPE","Illegal type %s\n");
+diff -Nur dosbox-0.74/src/dos/dos_tables.cpp dosbox/src/dos/dos_tables.cpp
+--- dosbox-0.74/src/dos/dos_tables.cpp	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/dos/dos_tables.cpp	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,7 +16,6 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: dos_tables.cpp,v 1.32 2009-10-28 21:45:12 qbix79 Exp $ */
+ 
+ #include "dosbox.h"
+ #include "mem.h"
+diff -Nur dosbox-0.74/src/dos/drive_cache.cpp dosbox/src/dos/drive_cache.cpp
+--- dosbox-0.74/src/dos/drive_cache.cpp	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/dos/drive_cache.cpp	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,7 +16,6 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: drive_cache.cpp,v 1.59 2009-04-16 12:28:30 qbix79 Exp $ */
+ 
+ #include "drives.h"
+ #include "dos_inc.h"
+@@ -67,7 +66,7 @@
+ 	srchNr			= 0;
+ 	label[0]		= 0;
+ 	nextFreeFindFirst	= 0;
+-	for (Bit32u i=0; i<MAX_OPENDIRS; i++) { dirSearch[i] = 0; free[i] = true; dirFindFirst[i] = 0; };
++	for (Bit32u i=0; i<MAX_OPENDIRS; i++) { dirSearch[i] = 0; dirFindFirst[i] = 0; };
+ 	SetDirSort(DIRALPHABETICAL);
+ 	updatelabel = true;
+ }
+@@ -78,7 +77,7 @@
+ 	srchNr			= 0;
+ 	label[0]		= 0;
+ 	nextFreeFindFirst	= 0;
+-	for (Bit32u i=0; i<MAX_OPENDIRS; i++) { dirSearch[i] = 0; free[i] = true; dirFindFirst[i] = 0; };
++	for (Bit32u i=0; i<MAX_OPENDIRS; i++) { dirSearch[i] = 0; dirFindFirst[i] = 0; };
+ 	SetDirSort(DIRALPHABETICAL);
+ 	SetBaseDir(path);
+ 	updatelabel = true;
+@@ -86,11 +85,11 @@
+ 
+ DOS_Drive_Cache::~DOS_Drive_Cache(void) {
+ 	Clear();
+-	for (Bit32u i=0; i<MAX_OPENDIRS; i++) { delete dirFindFirst[i]; dirFindFirst[i]=0; };
++	for (Bit32u i=0; i<MAX_OPENDIRS; i++) { DeleteFileInfo(dirFindFirst[i]); dirFindFirst[i]=0; };
+ }
+ 
+ void DOS_Drive_Cache::Clear(void) {
+-	delete dirBase; dirBase = 0;
++	DeleteFileInfo(dirBase); dirBase = 0;
+ 	nextFreeFindFirst	= 0;
+ 	for (Bit32u i=0; i<MAX_OPENDIRS; i++) dirSearch[i] = 0;
+ }
+@@ -101,7 +100,6 @@
+ 	dirBase		= new CFileInfo;
+ 	save_dir	= 0;
+ 	srchNr		= 0;
+-	for (Bit32u i=0; i<MAX_OPENDIRS; i++) free[i] = true; 
+ 	SetBaseDir(basePath);
+ }
+ 
+@@ -117,8 +115,16 @@
+ }
+ 
+ Bit16u DOS_Drive_Cache::GetFreeID(CFileInfo* dir) {
+-	for (Bit16u i=0; i<MAX_OPENDIRS; i++) if (free[i] || (dir==dirSearch[i])) return i;
++	if (dir->id != MAX_OPENDIRS)
++		return dir->id;
++	for (Bit16u i=0; i<MAX_OPENDIRS; i++) {
++		if (!dirSearch[i]) {
++			dir->id = i;
++			return i;
++		}
++	}
+ 	LOG(LOG_FILES,LOG_NORMAL)("DIRCACHE: Too many open directories!");
++	dir->id=0;
+ 	return 0;
+ }
+ 
+@@ -262,7 +268,7 @@
+ 	// delete file objects...
+ 	for(Bit32u i=0; i<dir->fileList.size(); i++) {
+ 		if (dirSearch[srchNr]==dir->fileList[i]) dirSearch[srchNr] = 0;
+-		delete dir->fileList[i]; dir->fileList[i] = 0;
++		DeleteFileInfo(dir->fileList[i]); dir->fileList[i] = 0;
+ 	}
+ 	// clear lists
+ 	dir->fileList.clear();
+@@ -370,6 +376,60 @@
+ 	return false;
+ }
+ 
++#define WINE_DRIVE_SUPPORT 1
++#if WINE_DRIVE_SUPPORT
++//Changes to interact with WINE by supporting their namemangling.
++//The code is rather slow, because orglist is unordered, so it needs to be avoided if possible.
++//Hence the tests in GetLongFileName
++
++
++// From the Wine project
++static Bits wine_hash_short_file_name( char* name, char* buffer )
++{
++	static const char hash_chars[] = "ABCDEFGHIJKLMNOPQRSTUVWXYZ012345";
++	static const char invalid_chars[] = { '*','?','<','>','|','"','+','=',',',';','[',']',' ','\345','~','.',0 };
++	char* p;
++	char* ext;
++	char* end = name + strlen(name);
++	char* dst;
++	unsigned short hash;
++	int i;
++
++	// Compute the hash code of the file name
++	for (p = name, hash = 0xbeef; p < end - 1; p++)
++		hash = (hash<<3) ^ (hash>>5) ^ tolower(*p) ^ (tolower(p[1]) << 8);
++	hash = (hash<<3) ^ (hash>>5) ^ tolower(*p); // Last character
++
++
++	// Find last dot for start of the extension
++	for (p = name + 1, ext = NULL; p < end - 1; p++) if (*p == '.') ext = p;
++
++	// Copy first 4 chars, replacing invalid chars with '_'
++	for (i = 4, p = name, dst = buffer; i > 0; i--, p++)
++	{
++		if (p == end || p == ext) break;
++		*dst++ = (*p < 0 || strchr( invalid_chars, *p ) != NULL) ? '_' : toupper(*p);
++	}
++	// Pad to 5 chars with '~'
++	while (i-- >= 0) *dst++ = '~';
++
++	// Insert hash code converted to 3 ASCII chars
++	*dst++ = hash_chars[(hash >> 10) & 0x1f];
++	*dst++ = hash_chars[(hash >> 5) & 0x1f];
++	*dst++ = hash_chars[hash & 0x1f];
++
++	// Copy the first 3 chars of the extension (if any)
++	if (ext)
++	{
++		*dst++ = '.';
++		for (i = 3, ext++; (i > 0) && ext < end; i--, ext++)
++			*dst++ = (*ext < 0 || strchr( invalid_chars, *ext ) != NULL) ? '_' : toupper(*ext);
++	}
++
++	return dst - buffer;
++}
++#endif
++
+ Bits DOS_Drive_Cache::GetLongName(CFileInfo* curDir, char* shortName) {
+ 	std::vector<CFileInfo*>::size_type filelist_size = curDir->fileList.size();
+ 	if (GCC_UNLIKELY(filelist_size<=0)) return -1;
+@@ -390,6 +450,21 @@
+ 			return mid;
+ 		};
+ 	}
++#ifdef WINE_DRIVE_SUPPORT
++	if (strlen(shortName) < 8 || shortName[4] != '~' || shortName[5] == '.' || shortName[6] == '.' || shortName[7] == '.') return -1; // not available
++	// else it's most likely a Wine style short name ABCD~###, # = not dot  (length at least 8) 
++	// The above test is rather strict as the following loop can be really slow if filelist_size is large.
++	char buff[CROSS_LEN];
++	for (Bitu i = 0; i < filelist_size; i++) {
++		res = wine_hash_short_file_name(curDir->fileList[i]->orgname,buff);
++		buff[res] = 0;
++		if (!strcmp(shortName,buff)) {	
++			// Found
++			strcpy(shortName,curDir->fileList[i]->orgname);
++			return (Bits)i;
++		}
++	}
++#endif
+ 	// not available
+ 	return -1;
+ }
+@@ -524,7 +599,10 @@
+ 			strcpy(buffer,dirPath);
+ 			ReadDir(id,result);
+ 			strcpy(dirPath,buffer);
+-			free[id] = true;
++			if (dirSearch[id]) {
++				dirSearch[id]->id = MAX_OPENDIRS;
++				dirSearch[id] = 0;
++			}
+ 		};
+ 	};
+ 
+@@ -554,7 +632,10 @@
+ 					strcpy(buffer,dirPath);
+ 					ReadDir(id,result);
+ 					strcpy(dirPath,buffer);
+-					free[id] = true;
++					if (dirSearch[id]) {
++						dirSearch[id]->id = MAX_OPENDIRS;
++						dirSearch[id] = 0;
++					}
+ 				};
+ 			}
+ 		};
+@@ -598,9 +679,12 @@
+ 			// Reset it..
+ 			close_directory(dirp);
+ 			strcpy(dirPath,expandcopy);
+-			free[id] = false;
+ 			return true;
+ 		}
++		if (dirSearch[id]) {
++			dirSearch[id]->id = MAX_OPENDIRS;
++			dirSearch[id] = 0;
++		}
+ 	};
+ 	return false;
+ }
+@@ -659,7 +743,10 @@
+ 		// Try to open directory
+ 		dir_information* dirp = open_directory(dirPath);
+ 		if (!dirp) {
+-			free[id] = true;
++			if (dirSearch[id]) {
++				dirSearch[id]->id = MAX_OPENDIRS;
++				dirSearch[id] = 0;
++			}
+ 			return false;
+ 		}
+ 		// Read complete directory
+@@ -686,7 +773,10 @@
+ 		};*/
+ 	};
+ 	if (SetResult(dirSearch[id], result, dirSearch[id]->nextEntry)) return true;
+-	free[id] = true;
++	if (dirSearch[id]) {
++		dirSearch[id]->id = MAX_OPENDIRS;
++		dirSearch[id] = 0;
++	}
+ 	return false;
+ }
+ 
+@@ -730,7 +820,7 @@
+ 		this->nextFreeFindFirst = 1; //the next free one after this search
+ 		for(Bitu n=0; n<MAX_OPENDIRS;n++) {	
+ 	     	// Clear and reuse slot
+-			delete dirFindFirst[n];
++			DeleteFileInfo(dirFindFirst[n]);
+ 			dirFindFirst[n]=0;
+ 		}
+ 	   
+@@ -765,8 +855,25 @@
+ 	}
+ 	if (!SetResult(dirFindFirst[id], result, dirFindFirst[id]->nextEntry)) {
+ 		// free slot
+-		delete dirFindFirst[id]; dirFindFirst[id] = 0;
++		DeleteFileInfo(dirFindFirst[id]); dirFindFirst[id] = 0;
+ 		return false;
+ 	}
+ 	return true;
+ }
++
++void DOS_Drive_Cache::ClearFileInfo(CFileInfo *dir) {
++	for(Bit32u i=0; i<dir->fileList.size(); i++) {
++		if (CFileInfo *info = dir->fileList[i])
++			ClearFileInfo(info);
++	}
++	if (dir->id != MAX_OPENDIRS) {
++		dirSearch[dir->id] = 0;
++		dir->id = MAX_OPENDIRS;
++	}
++}
++
++void DOS_Drive_Cache::DeleteFileInfo(CFileInfo *dir) {
++	if (dir)
++		ClearFileInfo(dir);
++	delete dir;
++}
+diff -Nur dosbox-0.74/src/dos/drive_fat.cpp dosbox/src/dos/drive_fat.cpp
+--- dosbox-0.74/src/dos/drive_fat.cpp	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/dos/drive_fat.cpp	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,7 +16,6 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: drive_fat.cpp,v 1.28 2009-06-19 18:28:10 c2woody Exp $ */
+ 
+ #include <stdio.h>
+ #include <stdlib.h>
+@@ -28,6 +27,7 @@
+ #include "support.h"
+ #include "cross.h"
+ #include "bios.h"
++#include "bios_disk.h"
+ 
+ #define IMGTYPE_FLOPPY 0
+ #define IMGTYPE_ISO    1
+@@ -37,9 +37,6 @@
+ #define FAT16		   1
+ #define FAT32		   2
+ 
+-Bit8u fatSectBuffer[1024];
+-Bit32u curFatSect;
+-
+ class fatFile : public DOS_File {
+ public:
+ 	fatFile(const char* name, Bit32u startCluster, Bit32u fileLen, fatDrive *useDrive);
+@@ -529,6 +526,10 @@
+ 		}
+ 		if((isEOF) && (skipClust>=1)) {
+ 			//LOG_MSG("End of cluster chain reached before end of logical sector seek!");
++			if (skipClust == 1 && fattype == FAT12) {
++				//break;
++				LOG(LOG_DOSMISC,LOG_ERROR)("End of cluster chain reached, but maybe good afterall ?");
++			}
+ 			return 0;
+ 		}
+ 		currentClust = testvalue;
+@@ -725,6 +726,9 @@
+ 
+ 	memset(fatSectBuffer,0,1024);
+ 	curFatSect = 0xffffffff;
++
++	strcpy(info, "fatDrive ");
++	strcat(info, sysFilename);
+ }
+ 
+ bool fatDrive::AllocationInfo(Bit16u *_bytes_sector, Bit8u *_sectors_cluster, Bit16u *_total_clusters, Bit16u *_free_clusters) {
+@@ -856,6 +860,7 @@
+ 
+ bool fatDrive::FindFirst(char *_dir, DOS_DTA &dta,bool /*fcb_findfirst*/) {
+ 	direntry dummyClust;
++#if 0
+ 	Bit8u attr;char pattern[DOS_NAMELENGTH_ASCII];
+ 	dta.GetSearchParams(attr,pattern);
+ 	if(attr==DOS_ATTR_VOLUME) {
+@@ -868,6 +873,7 @@
+ 	}
+ 	if(attr & DOS_ATTR_VOLUME) //check for root dir or fcb_findfirst
+ 		LOG(LOG_DOSMISC,LOG_WARN)("findfirst for volumelabel used on fatDrive. Unhandled!!!!!");
++#endif
+ 	if(!getDirClustNum(_dir, &cwdDirCluster, false)) {
+ 		DOS_SetError(DOSERR_PATH_NOT_FOUND);
+ 		return false;
+@@ -935,26 +941,37 @@
+ 		DOS_SetError(DOSERR_NO_MORE_FILES);
+ 		return false;
+ 	}
+-
+ 	memset(find_name,0,DOS_NAMELENGTH_ASCII);
+ 	memset(extension,0,4);
+ 	memcpy(find_name,&sectbuf[entryoffset].entryname[0],8);
+ 	memcpy(extension,&sectbuf[entryoffset].entryname[8],3);
+ 	trimString(&find_name[0]);
+ 	trimString(&extension[0]);
+-	if(!(sectbuf[entryoffset].attrib & DOS_ATTR_DIRECTORY) || extension[0]!=0) { 
++	
++	//if(!(sectbuf[entryoffset].attrib & DOS_ATTR_DIRECTORY))
++	if (extension[0]!=0) {
+ 		strcat(find_name, ".");
+ 		strcat(find_name, extension);
+ 	}
+ 
+-	/* Ignore files with volume label. FindFirst should search for those. (return the first one found) */
+-	if(sectbuf[entryoffset].attrib & 0x8) goto nextfile;
+-   
+-	/* Always find ARCHIVES even if bit is not set  Perhaps test is not the best test */
+-	if(~attrs & sectbuf[entryoffset].attrib & (DOS_ATTR_DIRECTORY | DOS_ATTR_HIDDEN | DOS_ATTR_SYSTEM) )  goto nextfile;
++	/* Compare attributes to search attributes */
++
++	//TODO What about attrs = DOS_ATTR_VOLUME|DOS_ATTR_DIRECTORY ?
++	if (attrs == DOS_ATTR_VOLUME) {
++		if (!(sectbuf[entryoffset].attrib & DOS_ATTR_VOLUME)) goto nextfile;
++		dirCache.SetLabel(find_name, false, true);
++	} else {
++		if (~attrs & sectbuf[entryoffset].attrib & (DOS_ATTR_DIRECTORY | DOS_ATTR_VOLUME | DOS_ATTR_SYSTEM | DOS_ATTR_HIDDEN) ) goto nextfile;
++	}
++
++
++	/* Compare name to search pattern */
+ 	if(!WildFileCmp(find_name,srch_pattern)) goto nextfile;
+ 
+-	dta.SetResult(find_name, sectbuf[entryoffset].entrysize, sectbuf[entryoffset].crtDate, sectbuf[entryoffset].crtTime, sectbuf[entryoffset].attrib);
++	//dta.SetResult(find_name, sectbuf[entryoffset].entrysize, sectbuf[entryoffset].crtDate, sectbuf[entryoffset].crtTime, sectbuf[entryoffset].attrib);
++
++	dta.SetResult(find_name, sectbuf[entryoffset].entrysize, sectbuf[entryoffset].modDate, sectbuf[entryoffset].modTime, sectbuf[entryoffset].attrib);
++
+ 	memcpy(foundEntry, &sectbuf[entryoffset], sizeof(direntry));
+ 
+ 	return true;
+@@ -983,11 +1000,13 @@
+ 		/* Find directory entry in parent directory */
+ 		Bit32s fileidx = 2;
+ 		if (dirClust==0) fileidx = 0;	// root directory
+-		while(directoryBrowse(dirClust, &fileEntry, fileidx)) {
++		Bit32s last_idx=0;
++		while(directoryBrowse(dirClust, &fileEntry, fileidx, last_idx)) {
+ 			if(memcmp(&fileEntry.entryname, &pathName[0], 11) == 0) {
+ 				*attr=fileEntry.attrib;
+ 				return true;
+ 			}
++			last_idx=fileidx;
+ 			fileidx++;
+ 		}
+ 		return false;
+@@ -995,12 +1014,15 @@
+ 	return true;
+ }
+ 
+-bool fatDrive::directoryBrowse(Bit32u dirClustNumber, direntry *useEntry, Bit32s entNum) {
++bool fatDrive::directoryBrowse(Bit32u dirClustNumber, direntry *useEntry, Bit32s entNum, Bit32s start/*=0*/) {
+ 	direntry sectbuf[16];	/* 16 directory entries per sector */
+ 	Bit32u logentsector;	/* Logical entry sector */
+ 	Bit32u entryoffset = 0;	/* Index offset within sector */
+ 	Bit32u tmpsector;
+-	Bit16u dirPos = 0;
++	if ((start<0) || (start>65535)) return false;
++	Bit16u dirPos = (Bit16u)start;
++	if (entNum<start) return false;
++	entNum-=start;
+ 
+ 	while(entNum>=0) {
+ 
+diff -Nur dosbox-0.74/src/dos/drive_iso.cpp dosbox/src/dos/drive_iso.cpp
+--- dosbox-0.74/src/dos/drive_iso.cpp	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/dos/drive_iso.cpp	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,7 +16,6 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: drive_iso.cpp,v 1.27 2009-09-22 21:48:08 c2woody Exp $ */
+ 
+ #include <cctype>
+ #include <cstring>
+@@ -256,13 +255,8 @@
+ 	dta.GetSearchParams(attr, pattern);
+    
+ 	if (attr == DOS_ATTR_VOLUME) {
+-		if (strlen(discLabel) != 0) {
+-			dta.SetResult(discLabel, 0, 0, 0, DOS_ATTR_VOLUME);
+-			return true;
+-		} else {
+-			DOS_SetError(DOSERR_NO_MORE_FILES);		
+-			return false;
+-		}
++		dta.SetResult(discLabel, 0, 0, 0, DOS_ATTR_VOLUME);
++		return true;
+ 	} else if ((attr & DOS_ATTR_VOLUME) && isRoot && !fcb_findfirst) {
+ 		if (WildFileCmp(discLabel,pattern)) {
+ 			// Get Volume Label (DOS_ATTR_VOLUME) and only in basedir and if it matches the searchstring
+@@ -289,7 +283,7 @@
+ 		else findAttr |= DOS_ATTR_ARCHIVE;
+ 		if (IS_HIDDEN(de.fileFlags)) findAttr |= DOS_ATTR_HIDDEN;
+ 
+-		if (!(isRoot && de.ident[0]=='.') && WildFileCmp((char*)de.ident, pattern)
++		if (!IS_ASSOC(de.fileFlags) && !(isRoot && de.ident[0]=='.') && WildFileCmp((char*)de.ident, pattern)
+ 			&& !(~attr & findAttr & (DOS_ATTR_DIRECTORY | DOS_ATTR_HIDDEN | DOS_ATTR_SYSTEM))) {
+ 			
+ 			/* file is okay, setup everything to be copied in DTA Block */
+@@ -333,7 +327,7 @@
+ bool isoDrive::AllocationInfo(Bit16u *bytes_sector, Bit8u *sectors_cluster, Bit16u *total_clusters, Bit16u *free_clusters) {
+ 	*bytes_sector = 2048;
+ 	*sectors_cluster = 1; // cluster size for cdroms ?
+-	*total_clusters = 60000;
++	*total_clusters = 65535;
+ 	*free_clusters = 0;
+ 	return true;
+ }
+@@ -494,13 +488,13 @@
+ 			if (de->ident[tmp - 1] == '.') de->ident[tmp - 1] = 0;
+ 		}
+ 	}
+-	const char* dotpos = strchr((char*)de->ident, '.');
++	char* dotpos = strchr((char*)de->ident, '.');
+ 	if (dotpos!=NULL) {
++		if (strlen(dotpos)>4) dotpos[4]=0;
+ 		if (dotpos-(char*)de->ident>8) {
+ 			strcpy((char*)(&de->ident[8]),dotpos);
+ 		}
+-	}
+-	if (strlen((char*)de->ident)>12) de->ident[12]=0;
++	} else if (strlen((char*)de->ident)>8) de->ident[8]=0;
+ 	return de->length;
+ }
+ 
+@@ -541,7 +535,7 @@
+ 			// look for the current path element
+ 			int dirIterator = GetDirIterator(de);
+ 			while (!found && GetNextDirEntry(dirIterator, de)) {
+-				if (0 == strncasecmp((char*) de->ident, name, ISO_MAX_FILENAME_LENGTH)) {
++				if (!IS_ASSOC(de->fileFlags) && (0 == strncasecmp((char*) de->ident, name, ISO_MAX_FILENAME_LENGTH))) {
+ 					found = true;
+ 				}
+ 			}
+diff -Nur dosbox-0.74/src/dos/drive_local.cpp dosbox/src/dos/drive_local.cpp
+--- dosbox-0.74/src/dos/drive_local.cpp	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/dos/drive_local.cpp	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,7 +16,6 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: drive_local.cpp,v 1.82 2009-07-18 18:42:55 c2woody Exp $ */
+ 
+ #include <stdio.h>
+ #include <stdlib.h>
+@@ -41,6 +40,7 @@
+ 	Bit16u GetInformation(void);
+ 	bool UpdateDateTimeFromHost(void);   
+ 	void FlagReadOnlyMedium(void);
++	void Flush(void);
+ private:
+ 	FILE * fhandle;
+ 	bool read_only_medium;
+@@ -82,9 +82,10 @@
+ bool localDrive::FileOpen(DOS_File * * file,char * name,Bit32u flags) {
+ 	const char* type;
+ 	switch (flags&0xf) {
+-	case OPEN_READ:type="rb"; break;
+-	case OPEN_WRITE:type="rb+"; break;
+-	case OPEN_READWRITE:type="rb+"; break;
++	case OPEN_READ:        type = "rb" ; break;
++	case OPEN_WRITE:       type = "rb+"; break;
++	case OPEN_READWRITE:   type = "rb+"; break;
++	case OPEN_READ_NO_MOD: type = "rb" ; break; //No modification of dates. LORD4.07 uses this
+ 	default:
+ 		DOS_SetError(DOSERR_ACCESS_CODE_INVALID);
+ 		return false;
+@@ -95,6 +96,22 @@
+ 	CROSS_FILENAME(newname);
+ 	dirCache.ExpandName(newname);
+ 
++	//Flush the buffer of handles for the same file. (Betrayal in Antara)
++	Bit8u i,drive=DOS_DRIVES;
++	localFile *lfp;
++	for (i=0;i<DOS_DRIVES;i++) {
++		if (Drives[i]==this) {
++			drive=i;
++			break;
++		}
++	}
++	for (i=0;i<DOS_FILES;i++) {
++		if (Files[i] && Files[i]->IsOpen() && Files[i]->GetDrive()==drive && Files[i]->IsName(name)) {
++			lfp=dynamic_cast<localFile*>(Files[i]);
++			if (lfp) lfp->Flush();
++		}
++	}
++
+ 	FILE * hand=fopen(newname,type);
+ //	Bit32u err=errno;
+ 	if (!hand) { 
+@@ -362,8 +379,6 @@
+ }
+ 
+ bool localDrive::AllocationInfo(Bit16u * _bytes_sector,Bit8u * _sectors_cluster,Bit16u * _total_clusters,Bit16u * _free_clusters) {
+-	/* Always report 100 mb free should be enough */
+-	/* Total size is always 1 gb */
+ 	*_bytes_sector=allocation.bytes_sector;
+ 	*_sectors_cluster=allocation.sectors_cluster;
+ 	*_total_clusters=allocation.total_clusters;
+@@ -377,9 +392,9 @@
+ 	strcat(newname,name);
+ 	CROSS_FILENAME(newname);
+ 	dirCache.ExpandName(newname);
+-	FILE* Temp=fopen(newname,"rb");
+-	if(Temp==NULL) return false;
+-	fclose(Temp);
++	struct stat temp_stat;
++	if(stat(newname,&temp_stat)!=0) return false;
++	if(temp_stat.st_mode & S_IFDIR) return false;
+ 	return true;
+ }
+ 
+@@ -541,6 +556,13 @@
+ 	return true;
+ }
+ 
++void localFile::Flush(void) {
++	if (last_action==WRITE) {
++		fseek(fhandle,ftell(fhandle),SEEK_SET);
++		last_action=NONE;
++	}
++}
++
+ 
+ // ********************************************
+ // CDROM DRIVE
+diff -Nur dosbox-0.74/src/dos/drives.cpp dosbox/src/dos/drives.cpp
+--- dosbox-0.74/src/dos/drives.cpp	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/dos/drives.cpp	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,7 +16,6 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: drives.cpp,v 1.15 2009-05-27 09:15:41 qbix79 Exp $ */
+ 
+ #include "dosbox.h"
+ #include "dos_system.h"
+diff -Nur dosbox-0.74/src/dos/drives.h dosbox/src/dos/drives.h
+--- dosbox-0.74/src/dos/drives.h	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/dos/drives.h	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,7 +16,6 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: drives.h,v 1.41 2009-05-27 09:15:41 qbix79 Exp $ */
+ 
+ #ifndef _DRIVES_H__
+ #define _DRIVES_H__
+@@ -25,7 +24,6 @@
+ #include <sys/types.h>
+ #include "dos_system.h"
+ #include "shell.h" /* for DOS_Shell */
+-#include "bios_disk.h"  /* for fatDrive */
+ 
+ bool WildFileCmp(const char * file, const char * wild);
+ void Set_Label(char const * const input, char * const output, bool cdrom);
+@@ -143,7 +141,8 @@
+ #ifdef _MSC_VER
+ #pragma pack ()
+ #endif
+-
++//Forward
++class imageDisk;
+ class fatDrive : public DOS_Drive {
+ public:
+ 	fatDrive(const char * sysFilename, Bit32u bytesector, Bit32u cylsector, Bit32u headscyl, Bit32u cylinders, Bit32u startSector);
+@@ -172,7 +171,7 @@
+ 	Bit32u appendCluster(Bit32u startCluster);
+ 	void deleteClustChain(Bit32u startCluster);
+ 	Bit32u getFirstFreeClust(void);
+-	bool directoryBrowse(Bit32u dirClustNumber, direntry *useEntry, Bit32s entNum);
++	bool directoryBrowse(Bit32u dirClustNumber, direntry *useEntry, Bit32s entNum, Bit32s start=0);
+ 	bool directoryChange(Bit32u dirClustNumber, direntry *useEntry, Bit32s entNum);
+ 	imageDisk *loadedDisk;
+ 	bool created_successfully;
+@@ -208,6 +207,9 @@
+ 
+ 	Bit32u cwdDirCluster;
+ 	Bit32u dirPosition; /* Position in directory search */
++
++	Bit8u fatSectBuffer[1024];
++	Bit32u curFatSect;
+ };
+ 
+ 
+@@ -298,11 +300,13 @@
+ #endif
+ 
+ #define ISO_FRAMESIZE		2048
++#define ISO_ASSOCIATED		4
+ #define ISO_DIRECTORY		2
+ #define ISO_HIDDEN		1
+ #define ISO_MAX_FILENAME_LENGTH 37
+ #define ISO_MAXPATHNAME		256
+ #define ISO_FIRST_VD		16
++#define IS_ASSOC(fileFlags)	(fileFlags & ISO_ASSOCIATED)
+ #define IS_DIR(fileFlags)	(fileFlags & ISO_DIRECTORY)
+ #define IS_HIDDEN(fileFlags)	(fileFlags & ISO_HIDDEN)
+ #define ISO_MAX_HASH_TABLE_SIZE 	100
+diff -Nur dosbox-0.74/src/dos/drive_virtual.cpp dosbox/src/dos/drive_virtual.cpp
+--- dosbox-0.74/src/dos/drive_virtual.cpp	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/dos/drive_virtual.cpp	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -101,7 +101,7 @@
+ }
+ 
+ bool Virtual_File::Write(Bit8u * data,Bit16u * size){
+-/* Not really writeable */
++	/* Not really writable */
+ 	return false;
+ }
+ 
+@@ -248,12 +248,10 @@
+ }
+ 
+ bool Virtual_Drive::AllocationInfo(Bit16u * _bytes_sector,Bit8u * _sectors_cluster,Bit16u * _total_clusters,Bit16u * _free_clusters) {
+-	/* Always report 100 mb free should be enough */
+-	/* Total size is always 1 gb */
+ 	*_bytes_sector=512;
+-	*_sectors_cluster=127;
+-	*_total_clusters=16513;
+-	*_free_clusters=00;
++	*_sectors_cluster=32;
++	*_total_clusters=32765;	// total size is always 500 mb
++	*_free_clusters=0;		// nothing free here
+ 	return true;
+ }
+ 
+diff -Nur dosbox-0.74/src/dos/Makefile.in dosbox/src/dos/Makefile.in
+--- dosbox-0.74/src/dos/Makefile.in	2010-05-12 11:57:44.000000000 +0200
++++ dosbox/src/dos/Makefile.in	1970-01-01 01:00:00.000000000 +0100
+@@ -1,482 +0,0 @@
+-# Makefile.in generated by automake 1.11.1 from Makefile.am.
+-# @configure_input@
+-
+-# Copyright (C) 1994, 1995, 1996, 1997, 1998, 1999, 2000, 2001, 2002,
+-# 2003, 2004, 2005, 2006, 2007, 2008, 2009  Free Software Foundation,
+-# Inc.
+-# This Makefile.in is free software; the Free Software Foundation
+-# gives unlimited permission to copy and/or distribute it,
+-# with or without modifications, as long as this notice is preserved.
+-
+-# This program is distributed in the hope that it will be useful,
+-# but WITHOUT ANY WARRANTY, to the extent permitted by law; without
+-# even the implied warranty of MERCHANTABILITY or FITNESS FOR A
+-# PARTICULAR PURPOSE.
+-
+-@SET_MAKE@
+-
+-VPATH = @srcdir@
+-pkgdatadir = $(datadir)/@PACKAGE@
+-pkgincludedir = $(includedir)/@PACKAGE@
+-pkglibdir = $(libdir)/@PACKAGE@
+-pkglibexecdir = $(libexecdir)/@PACKAGE@
+-am__cd = CDPATH="$${ZSH_VERSION+.}$(PATH_SEPARATOR)" && cd
+-install_sh_DATA = $(install_sh) -c -m 644
+-install_sh_PROGRAM = $(install_sh) -c
+-install_sh_SCRIPT = $(install_sh) -c
+-INSTALL_HEADER = $(INSTALL_DATA)
+-transform = $(program_transform_name)
+-NORMAL_INSTALL = :
+-PRE_INSTALL = :
+-POST_INSTALL = :
+-NORMAL_UNINSTALL = :
+-PRE_UNINSTALL = :
+-POST_UNINSTALL = :
+-build_triplet = @build@
+-host_triplet = @host@
+-subdir = src/dos
+-DIST_COMMON = $(srcdir)/Makefile.am $(srcdir)/Makefile.in
+-ACLOCAL_M4 = $(top_srcdir)/aclocal.m4
+-am__aclocal_m4_deps = $(top_srcdir)/acinclude.m4 \
+-	$(top_srcdir)/configure.in
+-am__configure_deps = $(am__aclocal_m4_deps) $(CONFIGURE_DEPENDENCIES) \
+-	$(ACLOCAL_M4)
+-mkinstalldirs = $(install_sh) -d
+-CONFIG_HEADER = $(top_builddir)/config.h
+-CONFIG_CLEAN_FILES =
+-CONFIG_CLEAN_VPATH_FILES =
+-LIBRARIES = $(noinst_LIBRARIES)
+-AR = ar
+-ARFLAGS = cru
+-libdos_a_AR = $(AR) $(ARFLAGS)
+-libdos_a_LIBADD =
+-am_libdos_a_OBJECTS = dos.$(OBJEXT) dos_devices.$(OBJEXT) \
+-	dos_execute.$(OBJEXT) dos_files.$(OBJEXT) dos_ioctl.$(OBJEXT) \
+-	dos_memory.$(OBJEXT) dos_misc.$(OBJEXT) dos_classes.$(OBJEXT) \
+-	dos_programs.$(OBJEXT) dos_tables.$(OBJEXT) drives.$(OBJEXT) \
+-	drive_virtual.$(OBJEXT) drive_local.$(OBJEXT) \
+-	drive_cache.$(OBJEXT) drive_fat.$(OBJEXT) drive_iso.$(OBJEXT) \
+-	dos_mscdex.$(OBJEXT) dos_keyboard_layout.$(OBJEXT) \
+-	cdrom.$(OBJEXT) cdrom_ioctl_win32.$(OBJEXT) \
+-	cdrom_aspi_win32.$(OBJEXT) cdrom_ioctl_linux.$(OBJEXT) \
+-	cdrom_image.$(OBJEXT) cdrom_ioctl_os2.$(OBJEXT)
+-libdos_a_OBJECTS = $(am_libdos_a_OBJECTS)
+-DEFAULT_INCLUDES = -I.@am__isrc@ -I$(top_builddir)
+-depcomp = $(SHELL) $(top_srcdir)/depcomp
+-am__depfiles_maybe = depfiles
+-am__mv = mv -f
+-CXXCOMPILE = $(CXX) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) \
+-	$(AM_CPPFLAGS) $(CPPFLAGS) $(AM_CXXFLAGS) $(CXXFLAGS)
+-CXXLD = $(CXX)
+-CXXLINK = $(CXXLD) $(AM_CXXFLAGS) $(CXXFLAGS) $(AM_LDFLAGS) $(LDFLAGS) \
+-	-o $@
+-COMPILE = $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) \
+-	$(CPPFLAGS) $(AM_CFLAGS) $(CFLAGS)
+-CCLD = $(CC)
+-LINK = $(CCLD) $(AM_CFLAGS) $(CFLAGS) $(AM_LDFLAGS) $(LDFLAGS) -o $@
+-SOURCES = $(libdos_a_SOURCES)
+-DIST_SOURCES = $(libdos_a_SOURCES)
+-ETAGS = etags
+-CTAGS = ctags
+-DISTFILES = $(DIST_COMMON) $(DIST_SOURCES) $(TEXINFOS) $(EXTRA_DIST)
+-ACLOCAL = @ACLOCAL@
+-ALSA_CFLAGS = @ALSA_CFLAGS@
+-ALSA_LIBS = @ALSA_LIBS@
+-AMTAR = @AMTAR@
+-AUTOCONF = @AUTOCONF@
+-AUTOHEADER = @AUTOHEADER@
+-AUTOMAKE = @AUTOMAKE@
+-AWK = @AWK@
+-CC = @CC@
+-CCDEPMODE = @CCDEPMODE@
+-CFLAGS = @CFLAGS@
+-CPP = @CPP@
+-CPPFLAGS = @CPPFLAGS@
+-CXX = @CXX@
+-CXXDEPMODE = @CXXDEPMODE@
+-CXXFLAGS = @CXXFLAGS@
+-CYGPATH_W = @CYGPATH_W@
+-DEFS = @DEFS@
+-DEPDIR = @DEPDIR@
+-ECHO_C = @ECHO_C@
+-ECHO_N = @ECHO_N@
+-ECHO_T = @ECHO_T@
+-EGREP = @EGREP@
+-EXEEXT = @EXEEXT@
+-GREP = @GREP@
+-INSTALL = @INSTALL@
+-INSTALL_DATA = @INSTALL_DATA@
+-INSTALL_PROGRAM = @INSTALL_PROGRAM@
+-INSTALL_SCRIPT = @INSTALL_SCRIPT@
+-INSTALL_STRIP_PROGRAM = @INSTALL_STRIP_PROGRAM@
+-LDFLAGS = @LDFLAGS@
+-LIBOBJS = @LIBOBJS@
+-LIBS = @LIBS@
+-LTLIBOBJS = @LTLIBOBJS@
+-MAKEINFO = @MAKEINFO@
+-MKDIR_P = @MKDIR_P@
+-OBJEXT = @OBJEXT@
+-PACKAGE = @PACKAGE@
+-PACKAGE_BUGREPORT = @PACKAGE_BUGREPORT@
+-PACKAGE_NAME = @PACKAGE_NAME@
+-PACKAGE_STRING = @PACKAGE_STRING@
+-PACKAGE_TARNAME = @PACKAGE_TARNAME@
+-PACKAGE_URL = @PACKAGE_URL@
+-PACKAGE_VERSION = @PACKAGE_VERSION@
+-PATH_SEPARATOR = @PATH_SEPARATOR@
+-RANLIB = @RANLIB@
+-SDL_CFLAGS = @SDL_CFLAGS@
+-SDL_CONFIG = @SDL_CONFIG@
+-SDL_LIBS = @SDL_LIBS@
+-SET_MAKE = @SET_MAKE@
+-SHELL = @SHELL@
+-STRIP = @STRIP@
+-VERSION = @VERSION@
+-WINDRES = @WINDRES@
+-abs_builddir = @abs_builddir@
+-abs_srcdir = @abs_srcdir@
+-abs_top_builddir = @abs_top_builddir@
+-abs_top_srcdir = @abs_top_srcdir@
+-ac_ct_CC = @ac_ct_CC@
+-ac_ct_CXX = @ac_ct_CXX@
+-am__include = @am__include@
+-am__leading_dot = @am__leading_dot@
+-am__quote = @am__quote@
+-am__tar = @am__tar@
+-am__untar = @am__untar@
+-bindir = @bindir@
+-build = @build@
+-build_alias = @build_alias@
+-build_cpu = @build_cpu@
+-build_os = @build_os@
+-build_vendor = @build_vendor@
+-builddir = @builddir@
+-datadir = @datadir@
+-datarootdir = @datarootdir@
+-docdir = @docdir@
+-dvidir = @dvidir@
+-exec_prefix = @exec_prefix@
+-host = @host@
+-host_alias = @host_alias@
+-host_cpu = @host_cpu@
+-host_os = @host_os@
+-host_vendor = @host_vendor@
+-htmldir = @htmldir@
+-includedir = @includedir@
+-infodir = @infodir@
+-install_sh = @install_sh@
+-libdir = @libdir@
+-libexecdir = @libexecdir@
+-localedir = @localedir@
+-localstatedir = @localstatedir@
+-mandir = @mandir@
+-mkdir_p = @mkdir_p@
+-oldincludedir = @oldincludedir@
+-pdfdir = @pdfdir@
+-prefix = @prefix@
+-program_transform_name = @program_transform_name@
+-psdir = @psdir@
+-sbindir = @sbindir@
+-sharedstatedir = @sharedstatedir@
+-srcdir = @srcdir@
+-sysconfdir = @sysconfdir@
+-target_alias = @target_alias@
+-top_build_prefix = @top_build_prefix@
+-top_builddir = @top_builddir@
+-top_srcdir = @top_srcdir@
+-AM_CPPFLAGS = -I$(top_srcdir)/include
+-noinst_LIBRARIES = libdos.a
+-EXTRA_DIST = scsidefs.h wnaspi32.h dos_codepages.h dos_keyboard_layout_data.h
+-libdos_a_SOURCES = dos.cpp dos_devices.cpp dos_execute.cpp dos_files.cpp dos_ioctl.cpp dos_memory.cpp \
+-                   dos_misc.cpp dos_classes.cpp dos_programs.cpp dos_tables.cpp \
+-		   drives.cpp drives.h drive_virtual.cpp drive_local.cpp drive_cache.cpp drive_fat.cpp \
+-		   drive_iso.cpp dev_con.h dos_mscdex.cpp dos_keyboard_layout.cpp \
+-		   cdrom.h cdrom.cpp cdrom_ioctl_win32.cpp cdrom_aspi_win32.cpp cdrom_ioctl_linux.cpp cdrom_image.cpp \
+-		   cdrom_ioctl_os2.cpp
+-
+-all: all-am
+-
+-.SUFFIXES:
+-.SUFFIXES: .cpp .o .obj
+-$(srcdir)/Makefile.in:  $(srcdir)/Makefile.am  $(am__configure_deps)
+-	@for dep in $?; do \
+-	  case '$(am__configure_deps)' in \
+-	    *$$dep*) \
+-	      ( cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh ) \
+-	        && { if test -f $@; then exit 0; else break; fi; }; \
+-	      exit 1;; \
+-	  esac; \
+-	done; \
+-	echo ' cd $(top_srcdir) && $(AUTOMAKE) --gnu src/dos/Makefile'; \
+-	$(am__cd) $(top_srcdir) && \
+-	  $(AUTOMAKE) --gnu src/dos/Makefile
+-.PRECIOUS: Makefile
+-Makefile: $(srcdir)/Makefile.in $(top_builddir)/config.status
+-	@case '$?' in \
+-	  *config.status*) \
+-	    cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh;; \
+-	  *) \
+-	    echo ' cd $(top_builddir) && $(SHELL) ./config.status $(subdir)/$@ $(am__depfiles_maybe)'; \
+-	    cd $(top_builddir) && $(SHELL) ./config.status $(subdir)/$@ $(am__depfiles_maybe);; \
+-	esac;
+-
+-$(top_builddir)/config.status: $(top_srcdir)/configure $(CONFIG_STATUS_DEPENDENCIES)
+-	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
+-
+-$(top_srcdir)/configure:  $(am__configure_deps)
+-	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
+-$(ACLOCAL_M4):  $(am__aclocal_m4_deps)
+-	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
+-$(am__aclocal_m4_deps):
+-
+-clean-noinstLIBRARIES:
+-	-test -z "$(noinst_LIBRARIES)" || rm -f $(noinst_LIBRARIES)
+-libdos.a: $(libdos_a_OBJECTS) $(libdos_a_DEPENDENCIES) 
+-	-rm -f libdos.a
+-	$(libdos_a_AR) libdos.a $(libdos_a_OBJECTS) $(libdos_a_LIBADD)
+-	$(RANLIB) libdos.a
+-
+-mostlyclean-compile:
+-	-rm -f *.$(OBJEXT)
+-
+-distclean-compile:
+-	-rm -f *.tab.c
+-
+-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/cdrom.Po@am__quote@
+-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/cdrom_aspi_win32.Po@am__quote@
+-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/cdrom_image.Po@am__quote@
+-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/cdrom_ioctl_linux.Po@am__quote@
+-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/cdrom_ioctl_os2.Po@am__quote@
+-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/cdrom_ioctl_win32.Po@am__quote@
+-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/dos.Po@am__quote@
+-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/dos_classes.Po@am__quote@
+-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/dos_devices.Po@am__quote@
+-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/dos_execute.Po@am__quote@
+-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/dos_files.Po@am__quote@
+-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/dos_ioctl.Po@am__quote@
+-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/dos_keyboard_layout.Po@am__quote@
+-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/dos_memory.Po@am__quote@
+-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/dos_misc.Po@am__quote@
+-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/dos_mscdex.Po@am__quote@
+-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/dos_programs.Po@am__quote@
+-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/dos_tables.Po@am__quote@
+-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/drive_cache.Po@am__quote@
+-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/drive_fat.Po@am__quote@
+-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/drive_iso.Po@am__quote@
+-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/drive_local.Po@am__quote@
+-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/drive_virtual.Po@am__quote@
+-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/drives.Po@am__quote@
+-
+-.cpp.o:
+-@am__fastdepCXX_TRUE@	$(CXXCOMPILE) -MT $@ -MD -MP -MF $(DEPDIR)/$*.Tpo -c -o $@ $<
+-@am__fastdepCXX_TRUE@	$(am__mv) $(DEPDIR)/$*.Tpo $(DEPDIR)/$*.Po
+-@AMDEP_TRUE@@am__fastdepCXX_FALSE@	source='$<' object='$@' libtool=no @AMDEPBACKSLASH@
+-@AMDEP_TRUE@@am__fastdepCXX_FALSE@	DEPDIR=$(DEPDIR) $(CXXDEPMODE) $(depcomp) @AMDEPBACKSLASH@
+-@am__fastdepCXX_FALSE@	$(CXXCOMPILE) -c -o $@ $<
+-
+-.cpp.obj:
+-@am__fastdepCXX_TRUE@	$(CXXCOMPILE) -MT $@ -MD -MP -MF $(DEPDIR)/$*.Tpo -c -o $@ `$(CYGPATH_W) '$<'`
+-@am__fastdepCXX_TRUE@	$(am__mv) $(DEPDIR)/$*.Tpo $(DEPDIR)/$*.Po
+-@AMDEP_TRUE@@am__fastdepCXX_FALSE@	source='$<' object='$@' libtool=no @AMDEPBACKSLASH@
+-@AMDEP_TRUE@@am__fastdepCXX_FALSE@	DEPDIR=$(DEPDIR) $(CXXDEPMODE) $(depcomp) @AMDEPBACKSLASH@
+-@am__fastdepCXX_FALSE@	$(CXXCOMPILE) -c -o $@ `$(CYGPATH_W) '$<'`
+-
+-ID: $(HEADERS) $(SOURCES) $(LISP) $(TAGS_FILES)
+-	list='$(SOURCES) $(HEADERS) $(LISP) $(TAGS_FILES)'; \
+-	unique=`for i in $$list; do \
+-	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
+-	  done | \
+-	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
+-	      END { if (nonempty) { for (i in files) print i; }; }'`; \
+-	mkid -fID $$unique
+-tags: TAGS
+-
+-TAGS:  $(HEADERS) $(SOURCES)  $(TAGS_DEPENDENCIES) \
+-		$(TAGS_FILES) $(LISP)
+-	set x; \
+-	here=`pwd`; \
+-	list='$(SOURCES) $(HEADERS)  $(LISP) $(TAGS_FILES)'; \
+-	unique=`for i in $$list; do \
+-	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
+-	  done | \
+-	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
+-	      END { if (nonempty) { for (i in files) print i; }; }'`; \
+-	shift; \
+-	if test -z "$(ETAGS_ARGS)$$*$$unique"; then :; else \
+-	  test -n "$$unique" || unique=$$empty_fix; \
+-	  if test $$# -gt 0; then \
+-	    $(ETAGS) $(ETAGSFLAGS) $(AM_ETAGSFLAGS) $(ETAGS_ARGS) \
+-	      "$$@" $$unique; \
+-	  else \
+-	    $(ETAGS) $(ETAGSFLAGS) $(AM_ETAGSFLAGS) $(ETAGS_ARGS) \
+-	      $$unique; \
+-	  fi; \
+-	fi
+-ctags: CTAGS
+-CTAGS:  $(HEADERS) $(SOURCES)  $(TAGS_DEPENDENCIES) \
+-		$(TAGS_FILES) $(LISP)
+-	list='$(SOURCES) $(HEADERS)  $(LISP) $(TAGS_FILES)'; \
+-	unique=`for i in $$list; do \
+-	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
+-	  done | \
+-	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
+-	      END { if (nonempty) { for (i in files) print i; }; }'`; \
+-	test -z "$(CTAGS_ARGS)$$unique" \
+-	  || $(CTAGS) $(CTAGSFLAGS) $(AM_CTAGSFLAGS) $(CTAGS_ARGS) \
+-	     $$unique
+-
+-GTAGS:
+-	here=`$(am__cd) $(top_builddir) && pwd` \
+-	  && $(am__cd) $(top_srcdir) \
+-	  && gtags -i $(GTAGS_ARGS) "$$here"
+-
+-distclean-tags:
+-	-rm -f TAGS ID GTAGS GRTAGS GSYMS GPATH tags
+-
+-distdir: $(DISTFILES)
+-	@srcdirstrip=`echo "$(srcdir)" | sed 's/[].[^$$\\*]/\\\\&/g'`; \
+-	topsrcdirstrip=`echo "$(top_srcdir)" | sed 's/[].[^$$\\*]/\\\\&/g'`; \
+-	list='$(DISTFILES)'; \
+-	  dist_files=`for file in $$list; do echo $$file; done | \
+-	  sed -e "s|^$$srcdirstrip/||;t" \
+-	      -e "s|^$$topsrcdirstrip/|$(top_builddir)/|;t"`; \
+-	case $$dist_files in \
+-	  */*) $(MKDIR_P) `echo "$$dist_files" | \
+-			   sed '/\//!d;s|^|$(distdir)/|;s,/[^/]*$$,,' | \
+-			   sort -u` ;; \
+-	esac; \
+-	for file in $$dist_files; do \
+-	  if test -f $$file || test -d $$file; then d=.; else d=$(srcdir); fi; \
+-	  if test -d $$d/$$file; then \
+-	    dir=`echo "/$$file" | sed -e 's,/[^/]*$$,,'`; \
+-	    if test -d "$(distdir)/$$file"; then \
+-	      find "$(distdir)/$$file" -type d ! -perm -700 -exec chmod u+rwx {} \;; \
+-	    fi; \
+-	    if test -d $(srcdir)/$$file && test $$d != $(srcdir); then \
+-	      cp -fpR $(srcdir)/$$file "$(distdir)$$dir" || exit 1; \
+-	      find "$(distdir)/$$file" -type d ! -perm -700 -exec chmod u+rwx {} \;; \
+-	    fi; \
+-	    cp -fpR $$d/$$file "$(distdir)$$dir" || exit 1; \
+-	  else \
+-	    test -f "$(distdir)/$$file" \
+-	    || cp -p $$d/$$file "$(distdir)/$$file" \
+-	    || exit 1; \
+-	  fi; \
+-	done
+-check-am: all-am
+-check: check-am
+-all-am: Makefile $(LIBRARIES)
+-installdirs:
+-install: install-am
+-install-exec: install-exec-am
+-install-data: install-data-am
+-uninstall: uninstall-am
+-
+-install-am: all-am
+-	@$(MAKE) $(AM_MAKEFLAGS) install-exec-am install-data-am
+-
+-installcheck: installcheck-am
+-install-strip:
+-	$(MAKE) $(AM_MAKEFLAGS) INSTALL_PROGRAM="$(INSTALL_STRIP_PROGRAM)" \
+-	  install_sh_PROGRAM="$(INSTALL_STRIP_PROGRAM)" INSTALL_STRIP_FLAG=-s \
+-	  `test -z '$(STRIP)' || \
+-	    echo "INSTALL_PROGRAM_ENV=STRIPPROG='$(STRIP)'"` install
+-mostlyclean-generic:
+-
+-clean-generic:
+-
+-distclean-generic:
+-	-test -z "$(CONFIG_CLEAN_FILES)" || rm -f $(CONFIG_CLEAN_FILES)
+-	-test . = "$(srcdir)" || test -z "$(CONFIG_CLEAN_VPATH_FILES)" || rm -f $(CONFIG_CLEAN_VPATH_FILES)
+-
+-maintainer-clean-generic:
+-	@echo "This command is intended for maintainers to use"
+-	@echo "it deletes files that may require special tools to rebuild."
+-clean: clean-am
+-
+-clean-am: clean-generic clean-noinstLIBRARIES mostlyclean-am
+-
+-distclean: distclean-am
+-	-rm -rf ./$(DEPDIR)
+-	-rm -f Makefile
+-distclean-am: clean-am distclean-compile distclean-generic \
+-	distclean-tags
+-
+-dvi: dvi-am
+-
+-dvi-am:
+-
+-html: html-am
+-
+-html-am:
+-
+-info: info-am
+-
+-info-am:
+-
+-install-data-am:
+-
+-install-dvi: install-dvi-am
+-
+-install-dvi-am:
+-
+-install-exec-am:
+-
+-install-html: install-html-am
+-
+-install-html-am:
+-
+-install-info: install-info-am
+-
+-install-info-am:
+-
+-install-man:
+-
+-install-pdf: install-pdf-am
+-
+-install-pdf-am:
+-
+-install-ps: install-ps-am
+-
+-install-ps-am:
+-
+-installcheck-am:
+-
+-maintainer-clean: maintainer-clean-am
+-	-rm -rf ./$(DEPDIR)
+-	-rm -f Makefile
+-maintainer-clean-am: distclean-am maintainer-clean-generic
+-
+-mostlyclean: mostlyclean-am
+-
+-mostlyclean-am: mostlyclean-compile mostlyclean-generic
+-
+-pdf: pdf-am
+-
+-pdf-am:
+-
+-ps: ps-am
+-
+-ps-am:
+-
+-uninstall-am:
+-
+-.MAKE: install-am install-strip
+-
+-.PHONY: CTAGS GTAGS all all-am check check-am clean clean-generic \
+-	clean-noinstLIBRARIES ctags distclean distclean-compile \
+-	distclean-generic distclean-tags distdir dvi dvi-am html \
+-	html-am info info-am install install-am install-data \
+-	install-data-am install-dvi install-dvi-am install-exec \
+-	install-exec-am install-html install-html-am install-info \
+-	install-info-am install-man install-pdf install-pdf-am \
+-	install-ps install-ps-am install-strip installcheck \
+-	installcheck-am installdirs maintainer-clean \
+-	maintainer-clean-generic mostlyclean mostlyclean-compile \
+-	mostlyclean-generic pdf pdf-am ps ps-am tags uninstall \
+-	uninstall-am
+-
+-
+-# Tell versions [3.59,3.63) of GNU make to not export all variables.
+-# Otherwise a system limit (for SysV at least) may be exceeded.
+-.NOEXPORT:
+diff -Nur dosbox-0.74/src/dos/scsidefs.h dosbox/src/dos/scsidefs.h
+--- dosbox-0.74/src/dos/scsidefs.h	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/dos/scsidefs.h	2014-01-12 14:43:47.000000000 +0100
+@@ -1,12 +1,7 @@
+ /* Got it from Bochs */
+ 
+-/////////////////////////////////////////////////////////////////////////
+-// $Id: scsidefs.h,v 1.3 2005-07-21 12:49:52 qbix79 Exp $
+-/////////////////////////////////////////////////////////////////////////
+-//
+ //
+ // iodev/scsidefs.h
+-// $Id: scsidefs.h,v 1.3 2005-07-21 12:49:52 qbix79 Exp $
+ //
+ // This file was copied from ... ?
+ //
+diff -Nur dosbox-0.74/src/dosbox.cpp dosbox/src/dosbox.cpp
+--- dosbox-0.74/src/dosbox.cpp	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/dosbox.cpp	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,7 +16,6 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: dosbox.cpp,v 1.150 2009-11-03 20:17:42 qbix79 Exp $ */
+ 
+ #include <stdlib.h>
+ #include <stdarg.h>
+@@ -42,6 +41,7 @@
+ #include "mapper.h"
+ #include "ints/int10.h"
+ #include "render.h"
++#include "pci_bus.h"
+ 
+ Config * control;
+ MachineType machine;
+@@ -74,6 +74,10 @@
+ void MIDI_Init(Section*);
+ void HARDWARE_Init(Section*);
+ 
++#if defined(PCI_FUNCTIONALITY_ENABLED)
++void PCI_Init(Section*);
++#endif
++
+ 
+ void KEYBOARD_Init(Section*);	//TODO This should setup INT 16 too but ok ;)
+ void JOYSTICK_Init(Section*);
+@@ -129,10 +133,11 @@
+ 	Bits ret;
+ 	while (1) {
+ 		if (PIC_RunQueue()) {
+-			ret=(*cpudecoder)();
++			ret = (*cpudecoder)();
+ 			if (GCC_UNLIKELY(ret<0)) return 1;
+ 			if (ret>0) {
+-				Bitu blah=(*CallBack_Handlers[ret])();
++				if (GCC_UNLIKELY(ret >= CB_MAX)) return 0;
++				Bitu blah = (*CallBack_Handlers[ret])();
+ 				if (GCC_UNLIKELY(blah)) return blah;
+ 			}
+ #if C_DEBUG
+@@ -174,7 +179,7 @@
+ 					Bit32s new_cmax = CPU_CycleMax;
+ 					Bit64s cproc = (Bit64s)CPU_CycleMax * (Bit64s)ticksScheduled;
+ 					if (cproc > 0) {
+-						/* ignore the cycles added due to the io delay code in order
++						/* ignore the cycles added due to the IO delay code in order
+ 						   to have smoother auto cycle adjustments */
+ 						double ratioremoved = (double) CPU_IODelayRemoved / (double) cproc;
+ 						if (ratioremoved < 1.0) {
+@@ -184,10 +189,13 @@
+ 							if (ticksScheduled >= 250 && ticksDone < 10 && ratio > 20480) 
+ 								ratio = 20480;
+ 							Bit64s cmax_scaled = (Bit64s)CPU_CycleMax * (Bit64s)ratio;
++							/* The auto cycle code seems reliable enough to disable the fast cut back code.
++							 * This should improve the fluency of complex games.
+ 							if (ratio <= 1024) 
+ 								new_cmax = (Bit32s)(cmax_scaled / (Bit64s)1024);
+ 							else 
+-								new_cmax = (Bit32s)(1 + (CPU_CycleMax >> 1) + cmax_scaled / (Bit64s)2048);
++							 */
++							new_cmax = (Bit32s)(1 + (CPU_CycleMax >> 1) + cmax_scaled / (Bit64s)2048);
+ 						}
+ 					}
+ 
+@@ -333,14 +341,14 @@
+ 	const char* machines[] = {
+ 		"hercules", "cga", "tandy", "pcjr", "ega",
+ 		"vgaonly", "svga_s3", "svga_et3000", "svga_et4000",
+-		 "svga_paradise", "vesa_nolfb", "vesa_oldvbe", 0 };
++		"svga_paradise", "vesa_nolfb", "vesa_oldvbe", 0 };
+ 	secprop=control->AddSection_prop("dosbox",&DOSBOX_RealInit);
+ 	Pstring = secprop->Add_path("language",Property::Changeable::Always,"");
+ 	Pstring->Set_help("Select another language file.");
+ 
+ 	Pstring = secprop->Add_string("machine",Property::Changeable::OnlyAtStart,"svga_s3");
+ 	Pstring->Set_values(machines);
+-	Pstring->Set_help("The type of machine tries to emulate.");
++	Pstring->Set_help("The type of machine DOSBox tries to emulate.");
+ 
+ 	Pstring = secprop->Add_path("captures",Property::Changeable::Always,"capture");
+ 	Pstring->Set_help("Directory where things like wave, midi, screenshot get captured.");
+@@ -376,8 +384,8 @@
+ 
+ 	Pmulti = secprop->Add_multi("scaler",Property::Changeable::Always," ");
+ 	Pmulti->SetValue("normal2x");
+-	Pmulti->Set_help("Scaler used to enlarge/enhance low resolution modes.\n"
+-	                 "  If 'forced' is appended, then the scaler will be used even if the result might not be desired.");
++	Pmulti->Set_help("Scaler used to enlarge/enhance low resolution modes. If 'forced' is appended,\n"
++	                 "then the scaler will be used even if the result might not be desired.");
+ 	Pstring = Pmulti->GetSection()->Add_string("type",Property::Changeable::Always,"normal2x");
+ 
+ 	const char *scalers[] = { 
+@@ -403,7 +411,8 @@
+ 		"normal", "simple",0 };
+ 	Pstring = secprop->Add_string("core",Property::Changeable::WhenIdle,"auto");
+ 	Pstring->Set_values(cores);
+-	Pstring->Set_help("CPU Core used in emulation. auto will switch to dynamic if available and appropriate.");
++	Pstring->Set_help("CPU Core used in emulation. auto will switch to dynamic if available and\n"
++		"appropriate.");
+ 
+ 	const char* cputype_values[] = { "auto", "386", "386_slow", "486_slow", "pentium_slow", "386_prefetch", 0};
+ 	Pstring = secprop->Add_string("cputype",Property::Changeable::Always,"auto");
+@@ -418,9 +427,10 @@
+ 		"Cycles can be set in 3 ways:\n"
+ 		"  'auto'          tries to guess what a game needs.\n"
+ 		"                  It usually works, but can fail for certain games.\n"
+-		"  'fixed #number' will set a fixed amount of cycles. This is what you usually need if 'auto' fails.\n"
+-		"                  (Example: fixed 4000).\n"
+-		"  'max'           will allocate as much cycles as your computer is able to handle.\n");
++		"  'fixed #number' will set a fixed amount of cycles. This is what you usually\n"
++		"                  need if 'auto' fails (Example: fixed 4000).\n"
++		"  'max'           will allocate as much cycles as your computer is able to\n"
++		"                  handle.");
+ 
+ 	const char* cyclest[] = { "auto","fixed","max","%u",0 };
+ 	Pstring = Pmulti_remain->GetSection()->Add_string("type",Property::Changeable::Always,"auto");
+@@ -431,7 +441,7 @@
+ 	
+ 	Pint = secprop->Add_int("cycleup",Property::Changeable::Always,10);
+ 	Pint->SetMinMax(1,1000000);
+-	Pint->Set_help("Amount of cycles to decrease/increase with keycombo.(CTRL-F11/CTRL-F12)");
++	Pint->Set_help("Amount of cycles to decrease/increase with keycombos.(CTRL-F11/CTRL-F12)");
+ 
+ 	Pint = secprop->Add_int("cycledown",Property::Changeable::Always,20);
+ 	Pint->SetMinMax(1,1000000);
+@@ -444,6 +454,12 @@
+ 	secprop->AddInitFunction(&VGA_Init);
+ 	secprop->AddInitFunction(&KEYBOARD_Init);
+ 
++
++#if defined(PCI_FUNCTIONALITY_ENABLED)
++	secprop=control->AddSection_prop("pci",&PCI_Init,false); //PCI bus
++#endif
++
++
+ 	secprop=control->AddSection_prop("mixer",&MIXER_Init);
+ 	Pbool = secprop->Add_bool("nosound",Property::Changeable::OnlyAtStart,false);
+ 	Pbool->Set_help("Enable silent mode, sound is still emulated though.");
+@@ -478,6 +494,9 @@
+ 
+ 	Pstring = secprop->Add_string("midiconfig",Property::Changeable::WhenIdle,"");
+ 	Pstring->Set_help("Special configuration options for the device driver. This is usually the id of the device you want to use.\n"
++	                  "  or in the case of coreaudio, you can specify a soundfont here.\n"
++	                  "  When using a Roland MT-32 rev. 0 as midi output device, some games may require a delay in order to prevent 'buffer overflow' issues.\n"
++	                  "  In that case, add 'delaysysex', for example: midiconfig=2 delaysysex\n"
+ 	                  "  See the README/Manual for more details.");
+ 
+ #if C_DEBUG
+@@ -654,8 +673,13 @@
+ 	Pbool->Set_help("Enable XMS support.");
+ 
+ 	secprop->AddInitFunction(&EMS_Init,true);//done
+-	Pbool = secprop->Add_bool("ems",Property::Changeable::WhenIdle,true);
+-	Pbool->Set_help("Enable EMS support.");
++	const char* ems_settings[] = { "true", "emsboard", "emm386", "false", 0};
++	Pstring = secprop->Add_string("ems",Property::Changeable::WhenIdle,"true");
++	Pstring->Set_values(ems_settings);
++	Pstring->Set_help("Enable EMS support. The default (=true) provides the best\n"
++		"compatibility but certain applications may run better with\n"
++		"other choices, or require EMS support to be disabled (=false)\n"
++		"to work at all.");
+ 
+ 	Pbool = secprop->Add_bool("umb",Property::Changeable::WhenIdle,true);
+ 	Pbool->Set_help("Enable UMB support.");
+@@ -682,8 +706,8 @@
+ 		"You can put your MOUNT lines here.\n"
+ 	);
+ 	MSG_Add("CONFIGFILE_INTRO",
+-	        "# This is the configurationfile for DOSBox %s. (Please use the latest version of DOSBox)\n"
+-	        "# Lines starting with a # are commentlines and are ignored by DOSBox.\n"
++	        "# This is the configuration file for DOSBox %s. (Please use the latest version of DOSBox)\n"
++	        "# Lines starting with a # are comment lines and are ignored by DOSBox.\n"
+ 	        "# They are used to (briefly) document the effect of each option.\n");
+ 	MSG_Add("CONFIG_SUGGESTED_VALUES", "Possible values");
+ 
+diff -Nur dosbox-0.74/src/fpu/fpu.cpp dosbox/src/fpu/fpu.cpp
+--- dosbox-0.74/src/fpu/fpu.cpp	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/fpu/fpu.cpp	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,7 +16,6 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: fpu.cpp,v 1.31 2009-09-16 18:01:53 qbix79 Exp $ */
+ 
+ #include "dosbox.h"
+ #if C_FPU
+diff -Nur dosbox-0.74/src/fpu/fpu_instructions.h dosbox/src/fpu/fpu_instructions.h
+--- dosbox-0.74/src/fpu/fpu_instructions.h	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/fpu/fpu_instructions.h	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,7 +16,6 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: fpu_instructions.h,v 1.33 2009-05-27 09:15:41 qbix79 Exp $ */
+ 
+ 
+ static void FPU_FINIT(void) {
+@@ -97,7 +96,7 @@
+ 	test.eind.l.lower = mem_readd(addr);
+ 	test.eind.l.upper = mem_readd(addr+4);
+ 	test.begin = mem_readw(addr+8);
+-
++   
+ 	Bit64s exp64 = (((test.begin&0x7fff) - BIAS80));
+ 	Bit64s blah = ((exp64 >0)?exp64:-exp64)&0x3ff;
+ 	Bit64s exp64final = ((exp64 >0)?blah:-blah) +BIAS64;
+@@ -106,6 +105,11 @@
+ 	Bit64s sign = (test.begin&0x8000)?1:0;
+ 	FPU_Reg result;
+ 	result.ll = (sign <<63)|(exp64final << 52)| mant64;
++
++	if(test.eind.l.lower == 0 && test.eind.l.upper == 0x80000000 && (test.begin&0x7fff) == 0x7fff) {
++		//Detect INF and -INF (score 3.11 when drawing a slur.)
++		result.d = sign?-HUGE_VAL:HUGE_VAL;
++	}
+ 	return result.d;
+ 
+ 	//mant64= test.mant80/2***64    * 2 **53 
+diff -Nur dosbox-0.74/src/fpu/fpu_instructions_x86.h dosbox/src/fpu/fpu_instructions_x86.h
+--- dosbox-0.74/src/fpu/fpu_instructions_x86.h	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/fpu/fpu_instructions_x86.h	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,7 +16,6 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: fpu_instructions_x86.h,v 1.7 2009-05-27 09:15:41 qbix79 Exp $ */
+ 
+ 
+ // #define WEAK_EXCEPTIONS
+@@ -313,23 +312,7 @@
+ #endif
+ 
+ // handles fdiv,fdivr
+-#ifdef WEAK_EXCEPTIONS
+-#define FPUD_ARITH3(op)						\
+-		Bit16u save_cw;						\
+-		__asm {								\
+-		__asm	fnstcw	save_cw				\
+-		__asm	mov		eax, op1			\
+-		__asm	shl		eax, 4				\
+-		__asm	fldcw	fpu.cw_mask_all		\
+-		__asm	mov		ebx, op2			\
+-		__asm	shl		ebx, 4				\
+-		__asm	fld		TBYTE PTR fpu.p_regs[eax].m1	\
+-		__asm	fld		TBYTE PTR fpu.p_regs[ebx].m1	\
+-		__asm	op		st(1), st(0)		\
+-		__asm	fstp	TBYTE PTR fpu.p_regs[eax].m1	 \
+-		__asm	fldcw	save_cw				\
+-		}
+-#else
++// (This is identical to FPUD_ARITH1 but without a WEAK_EXCEPTIONS variant)
+ #define FPUD_ARITH3(op)						\
+ 		Bit16u new_sw,save_cw;				\
+ 		__asm {								\
+@@ -348,24 +331,9 @@
+ 		__asm	fldcw	save_cw				\
+ 		}									\
+ 		fpu.sw=(new_sw&0xffbf)|(fpu.sw&0x80ff);
+-#endif
+ 
+ // handles fdiv,fdivr
+-#ifdef WEAK_EXCEPTIONS
+-#define FPUD_ARITH3_EA(op)					\
+-		Bit16u save_cw;						\
+-		__asm {								\
+-		__asm	fnstcw	save_cw				\
+-		__asm	mov		eax, op1			\
+-		__asm	fldcw	fpu.cw_mask_all		\
+-		__asm	shl		eax, 4				\
+-		__asm	fld		TBYTE PTR fpu.p_regs[eax].m1	\
+-		__asm	fxch	\
+-		__asm	op		st(1), st(0)		\
+-		__asm	fstp	TBYTE PTR fpu.p_regs[eax].m1	 \
+-		__asm	fldcw	save_cw				\
+-		}
+-#else
++// (This is identical to FPUD_ARITH1_EA but without a WEAK_EXCEPTIONS variant)
+ #define FPUD_ARITH3_EA(op)					\
+ 		Bit16u new_sw,save_cw;				\
+ 		__asm {								\
+@@ -382,10 +350,9 @@
+ 		__asm	fldcw	save_cw				\
+ 		}									\
+ 		fpu.sw=(new_sw&0xffbf)|(fpu.sw&0x80ff);
+-#endif
+ 
+ // handles fprem,fprem1,fscale
+-#define FPUD_REMINDER(op)			\
++#define FPUD_REMAINDER(op)			\
+ 		Bit16u new_sw;				\
+ 		__asm {						\
+ 		__asm	mov		eax, TOP	\
+@@ -533,6 +500,8 @@
+ 
+ #else
+ 
++// !defined _MSC_VER
++
+ #ifdef WEAK_EXCEPTIONS
+ #define clx
+ #else
+@@ -542,55 +511,44 @@
+ #ifdef WEAK_EXCEPTIONS
+ #define FPUD_LOAD(op,szI,szA)				\
+ 		__asm__ volatile (					\
+-			"movl		$128, %%eax		\n"	\
+-			"shl		$4, %0			\n"	\
+-			#op #szA "	(%1, %%eax)		\n"	\
+-			"fstpt		(%1, %0)		"	\
+-			:								\
+-			:	"r" (store_to), "r" (fpu.p_regs)	\
+-			:	"eax", "memory"						\
++			#op #szA "	%1				\n"	\
++			"fstpt		%0				"	\
++			:	"=m" (fpu.p_regs[store_to])	\
++			:	"m" (fpu.p_regs[8])			\
+ 		);
+ #else
+ #define FPUD_LOAD(op,szI,szA)				\
+ 		Bit16u new_sw;						\
+ 		__asm__ volatile (					\
+-			"movl		$8, %%eax		\n"	\
+-			"shl		$4, %%eax		\n"	\
+-			"shl		$4, %1			\n"	\
+ 			"fclex						\n"	\
+-			#op #szA "	(%2, %%eax)		\n"	\
++			#op #szA "	%2				\n"	\
+ 			"fnstsw		%0				\n"	\
+-			"fstpt		(%2, %1)		"	\
+-			:	"=m" (new_sw)				\
+-			:	"r" (store_to), "r" (fpu.p_regs)	\
+-			:	"eax", "memory"						\
++			"fstpt		%1				"	\
++			:	"=&am" (new_sw), "=m" (fpu.p_regs[store_to])		\
++			:	"m" (fpu.p_regs[8])			\
+ 		);									\
+-		fpu.sw=(new_sw&0xffbf)|(fpu.sw&0x80ff);
++		fpu.sw=(new_sw&exc_mask)|(fpu.sw&0x80ff);
+ #endif
+ 
+ #ifdef WEAK_EXCEPTIONS
+ #define FPUD_LOAD_EA(op,szI,szA)			\
+ 		__asm__ volatile (					\
+-			"movl		$128, %%eax		\n"	\
+-			#op #szA "	(%0, %%eax)		\n"	\
++			#op #szA "	%0				\n"	\
+ 			:								\
+-			:	"r" (fpu.p_regs)			\
+-			:	"eax", "memory"				\
++			:	"m" (fpu.p_regs[8])			\
+ 		);
+ #else
+ #define FPUD_LOAD_EA(op,szI,szA)			\
+ 		Bit16u new_sw;						\
+ 		__asm__ volatile (					\
+-			"movl		$8, %%eax		\n"	\
+-			"shl		$4, %%eax		\n"	\
+ 			"fclex						\n"	\
+-			#op #szA "	(%1, %%eax)		\n"	\
++			#op #szA "	%1				\n"	\
+ 			"fnstsw		%0				\n"	\
+-			:	"=m" (new_sw)				\
+-			:	"r" (fpu.p_regs)			\
+-			:	"eax", "memory"				\
++			:	"=&am" (new_sw)				\
++			:	"m" (fpu.p_regs[8])			\
++			:								\
+ 		);									\
+-		fpu.sw=(new_sw&0xffbf)|(fpu.sw&0x80ff);
++		fpu.sw=(new_sw&exc_mask)|(fpu.sw&0x80ff);
+ #endif
+ 
+ #ifdef WEAK_EXCEPTIONS
+@@ -598,15 +556,12 @@
+ 		Bit16u save_cw;						\
+ 		__asm__ volatile (					\
+ 			"fnstcw		%0				\n"	\
+-			"shll		$4, %1			\n"	\
+ 			"fldcw		%3				\n"	\
+-			"movl		$128, %%eax		\n"	\
+-			"fldt		(%2, %1)		\n"	\
+-			#op #szA "	(%2, %%eax)		\n"	\
++			"fldt		%2				\n"	\
++			#op #szA "	%1				\n"	\
+ 			"fldcw		%0				"	\
+-			:	"=m" (save_cw)				\
+-			:	"r" (TOP), "r" (fpu.p_regs), "m" (fpu.cw_mask_all)		\
+-			:	"eax", "memory"						\
++			:	"=m" (save_cw), "=m" (fpu.p_regs[8])	\
++			:	"m" (fpu.p_regs[TOP]), "m" (fpu.cw_mask_all)		\
+ 		);
+ #else
+ #define FPUD_STORE(op,szI,szA)				\
+@@ -614,18 +569,14 @@
+ 		__asm__ volatile (					\
+ 			"fnstcw		%1				\n"	\
+ 			"fldcw		%4				\n"	\
+-			"shll		$4, %2			\n"	\
+-			"movl		$8, %%eax		\n"	\
+-			"shl		$4, %%eax		\n"	\
+-			"fldt		(%3, %2)		\n"	\
+-			clx" 						\n"	\
+-			#op #szA "	(%3, %%eax)		\n"	\
++			"fldt		%3				\n"	\
++			"fclex 						\n"	\
++			#op #szA "	%2				\n"	\
+ 			"fnstsw		%0				\n"	\
+ 			"fldcw		%1				"	\
+-			:	"=m" (new_sw), "=m" (save_cw)	\
+-			:	"r" (TOP), "r" (fpu.p_regs), "m" (fpu.cw_mask_all)		\
+-			:	"eax", "memory"						\
+-		);										\
++			:	"=&am" (new_sw), "=m" (save_cw), "=m" (fpu.p_regs[8])	\
++			:	"m" (fpu.p_regs[TOP]), "m" (fpu.cw_mask_all)			\
++		);									\
+ 		fpu.sw=(new_sw&exc_mask)|(fpu.sw&0x80ff);
+ #endif
+ 
+@@ -633,15 +584,12 @@
+ #define FPUD_TRIG(op)						\
+ 		Bit16u new_sw;						\
+ 		__asm__ volatile (					\
+-			"shll		$4, %1			\n"	\
+-			"fldt		(%2, %1)		\n"	\
++			"fldt		%1				\n"	\
+ 			clx" 						\n"	\
+ 			#op" 						\n"	\
+ 			"fnstsw		%0				\n"	\
+-			"fstpt		(%2, %1)		"	\
+-			:	"=m" (new_sw)				\
+-			:	"r" (TOP), "r" (fpu.p_regs)	\
+-			:	"memory"					\
++			"fstpt		%1				"	\
++			:	"=&am" (new_sw), "+m" (fpu.p_regs[TOP])		\
+ 		);									\
+ 		fpu.sw=(new_sw&exc_mask)|(fpu.sw&0x80ff);
+ 
+@@ -649,24 +597,20 @@
+ #define FPUD_SINCOS()					\
+ 		Bit16u new_sw;						\
+ 		__asm__ volatile (					\
+-			"movl		%1, %%eax		\n"	\
+-			"shll		$4, %1			\n"	\
+-			"decl		%%eax			\n"	\
+-			"andl		$7, %%eax		\n"	\
+-			"shll		$4, %%eax		\n"	\
+-			"fldt		(%2, %1)		\n"	\
++			"fldt		%1				\n"	\
+ 			clx" 						\n"	\
+ 			"fsincos					\n"	\
+ 			"fnstsw		%0				\n"	\
+-			"fstpt		(%2, %%eax)		\n"	\
++			"fstpt		%2				\n"	\
+ 			"movw		%0, %%ax		\n"	\
+ 			"sahf						\n"	\
+-			"jp			argument_too_large1		\n"	\
+-			"fstpt		(%2, %1)		\n"	\
+-			"argument_too_large1:		"	\
+-			:	"=m" (new_sw)				\
+-			:	"r" (TOP), "r" (fpu.p_regs)	\
+-			:	"eax", "cc", "memory"		\
++			"jp			1f				\n"	\
++			"fstpt		%1				\n"	\
++			"1:							"	\
++			:	"=m" (new_sw), "+m" (fpu.p_regs[TOP]),	\
++				"=m" (fpu.p_regs[(TOP-1)&7])			\
++			:								\
++			:	"ax", "cc"					\
+ 		);									\
+ 		fpu.sw=(new_sw&exc_mask)|(fpu.sw&0x80ff);		\
+ 		if ((new_sw&0x0400)==0) FPU_PREP_PUSH();
+@@ -675,24 +619,20 @@
+ #define FPUD_PTAN()						\
+ 		Bit16u new_sw;						\
+ 		__asm__ volatile (					\
+-			"movl		%1, %%eax		\n"	\
+-			"shll		$4, %1			\n"	\
+-			"decl		%%eax			\n"	\
+-			"andl		$7, %%eax		\n"	\
+-			"shll		$4, %%eax		\n"	\
+-			"fldt		(%2, %1)		\n"	\
++			"fldt		%1				\n"	\
+ 			clx" 						\n"	\
+ 			"fptan 						\n"	\
+ 			"fnstsw		%0				\n"	\
+-			"fstpt		(%2, %%eax)		\n"	\
++			"fstpt		%2				\n"	\
+ 			"movw		%0, %%ax		\n"	\
+ 			"sahf						\n"	\
+-			"jp			argument_too_large2		\n"	\
+-			"fstpt		(%2, %1)		\n"	\
+-			"argument_too_large2:		"	\
+-			:	"=m" (new_sw)				\
+-			:	"r" (TOP), "r" (fpu.p_regs)	\
+-			:	"eax", "cc", "memory"		\
++			"jp			1f				\n"	\
++			"fstpt		%1				\n"	\
++			"1:							"	\
++			:	"=m" (new_sw), "+m" (fpu.p_regs[TOP]),	\
++				"=m" (fpu.p_regs[(TOP-1)&7])			\
++			:								\
++			:	"ax", "cc"					\
+ 		);									\
+ 		fpu.sw=(new_sw&exc_mask)|(fpu.sw&0x80ff);		\
+ 		if ((new_sw&0x0400)==0) FPU_PREP_PUSH();
+@@ -701,40 +641,27 @@
+ #ifdef WEAK_EXCEPTIONS
+ #define FPUD_XTRACT						\
+ 		__asm__ volatile (					\
+-			"movl		%0, %%eax		\n"	\
+-			"shll		$4, %0			\n"	\
+-			"decl		%%eax			\n"	\
+-			"andl		$7, %%eax		\n"	\
+-			"shll		$4, %%eax		\n"	\
+-			"fldt		(%1, %0)		\n"	\
++			"fldt		%0				\n"	\
+ 			"fxtract					\n"	\
+-			"fstpt		(%1, %%eax)		\n"	\
+-			"fstpt		(%1, %0)		"	\
+-			:								\
+-			:	"r" (TOP), "r" (fpu.p_regs)	\
+-			:	"eax", "memory"				\
++			"fstpt		%1				\n"	\
++			"fstpt		%0				"	\
++			:	"+m" (fpu.p_regs[TOP]), "=m" (fpu.p_regs[(TOP-1)&7])	\
+ 		);									\
+ 		FPU_PREP_PUSH();
+ #else
+ #define FPUD_XTRACT						\
+ 		Bit16u new_sw;						\
+ 		__asm__ volatile (					\
+-			"movl		%1, %%eax		\n"	\
+-			"shll		$4, %1			\n"	\
+-			"decl		%%eax			\n"	\
+-			"andl		$7, %%eax		\n"	\
+-			"shll		$4, %%eax		\n"	\
+-			"fldt		(%2, %1)		\n"	\
++			"fldt		%1				\n"	\
+ 			"fclex						\n"	\
+ 			"fxtract					\n"	\
+ 			"fnstsw		%0				\n"	\
+-			"fstpt		(%2, %%eax)		\n"	\
+-			"fstpt		(%2, %1)		"	\
+-			:	"=m" (new_sw)				\
+-			:	"r" (TOP), "r" (fpu.p_regs)	\
+-			:	"eax", "memory"						\
++			"fstpt		%2				\n"	\
++			"fstpt		%1				"	\
++			:	"=&am" (new_sw), "+m" (fpu.p_regs[TOP]),	\
++				"=m" (fpu.p_regs[(TOP-1)&7])			\
+ 		);									\
+-		fpu.sw=(new_sw&0xffbf)|(fpu.sw&0x80ff);		\
++		fpu.sw=(new_sw&exc_mask)|(fpu.sw&0x80ff);		\
+ 		FPU_PREP_PUSH();
+ #endif
+ 
+@@ -744,36 +671,30 @@
+ 		Bit16u save_cw;						\
+ 		__asm__ volatile (					\
+ 			"fnstcw		%0				\n"	\
+-			"fldcw		%4				\n"	\
+-			"shll		$4, %2			\n"	\
+-			"shll		$4, %1			\n"	\
+-			"fldt		(%3, %2)		\n"	\
+-			"fldt		(%3, %1)		\n"	\
++			"fldcw		%3				\n"	\
++			"fldt		%2				\n"	\
++			"fldt		%1				\n"	\
+ 			#op"						\n"	\
+-			"fstpt		(%3, %1)		\n"	\
++			"fstpt		%1				\n"	\
+ 			"fldcw		%0				"	\
+-			:	"=m" (save_cw)		\
+-			:	"r" (op1), "r" (op2), "r" (fpu.p_regs), "m" (fpu.cw_mask_all)		\
+-			:	"memory"				\
++			:	"=m" (save_cw), "+m" (fpu.p_regs[op1])				\
++			:	"m" (fpu.p_regs[op2]), "m" (fpu.cw_mask_all)		\
+ 		);
+ #else
+ #define FPUD_ARITH1(op)						\
+ 		Bit16u new_sw,save_cw;				\
+ 		__asm__ volatile (					\
+ 			"fnstcw		%1				\n"	\
+-			"fldcw		%5				\n"	\
+-			"shll		$4, %3			\n"	\
+-			"shll		$4, %2			\n"	\
+-			"fldt		(%4, %3)		\n"	\
+-			"fldt		(%4, %2)		\n"	\
+-			clx" 						\n"	\
++			"fldcw		%4				\n"	\
++			"fldt		%3				\n"	\
++			"fldt		%2				\n"	\
++			"fclex 						\n"	\
+ 			#op"						\n"	\
+ 			"fnstsw		%0				\n"	\
+-			"fstpt		(%4, %2)		\n"	\
++			"fstpt		%2				\n"	\
+ 			"fldcw		%1				"	\
+-			:	"=m" (new_sw), "=m" (save_cw)		\
+-			:	"r" (op1), "r" (op2), "r" (fpu.p_regs), "m" (fpu.cw_mask_all)		\
+-			:	"memory"				\
++			:	"=&am" (new_sw), "=m" (save_cw), "+m" (fpu.p_regs[op1])	\
++			:	"m" (fpu.p_regs[op2]), "m" (fpu.cw_mask_all)		\
+ 		);									\
+ 		fpu.sw=(new_sw&exc_mask)|(fpu.sw&0x80ff);
+ #endif
+@@ -784,32 +705,28 @@
+ 		Bit16u save_cw;						\
+ 		__asm__ volatile (					\
+ 			"fnstcw		%0				\n"	\
+-			"fldcw		%3				\n"	\
+-			"shll		$4, %1			\n"	\
+-			"fldt		(%2, %1)		\n"	\
++			"fldcw		%2				\n"	\
++			"fldt		%1				\n"	\
+ 			#op"						\n"	\
+-			"fstpt		(%2, %1)		\n"	\
++			"fstpt		%1				\n"	\
+ 			"fldcw		%0				"	\
+-			:	"=m" (save_cw)		\
+-			:	"r" (op1), "r" (fpu.p_regs), "m" (fpu.cw_mask_all)		\
+-			:	"memory"				\
++			:	"=m" (save_cw), "+m" (fpu.p_regs[op1])		\
++			:	"m" (fpu.cw_mask_all)		\
+ 		);
+ #else
+ #define FPUD_ARITH1_EA(op)					\
+ 		Bit16u new_sw,save_cw;				\
+ 		__asm__ volatile (					\
+ 			"fnstcw		%1				\n"	\
+-			"fldcw		%4				\n"	\
+-			"shll		$4, %2			\n"	\
+-			"fldt		(%3, %2)		\n"	\
+-			clx" 						\n"	\
++			"fldcw		%3				\n"	\
++			"fldt		%2				\n"	\
++			"fclex 						\n"	\
+ 			#op"						\n"	\
+ 			"fnstsw		%0				\n"	\
+-			"fstpt		(%3, %2)		\n"	\
++			"fstpt		%2				\n"	\
+ 			"fldcw		%1				"	\
+-			:	"=m" (new_sw), "=m" (save_cw)		\
+-			:	"r" (op1), "r" (fpu.p_regs), "m" (fpu.cw_mask_all)		\
+-			:	"memory"				\
++			:	"=&am" (new_sw), "=m" (save_cw), "+m" (fpu.p_regs[op1])	\
++			:	"m" (fpu.cw_mask_all)		\
+ 		);									\
+ 		fpu.sw=(new_sw&exc_mask)|(fpu.sw&0x80ff);
+ #endif
+@@ -820,131 +737,82 @@
+ 		Bit16u save_cw;						\
+ 		__asm__ volatile (					\
+ 			"fnstcw		%0				\n"	\
+-			"fldcw		%3				\n"	\
+-			"shll		$4, %1			\n"	\
+-			"fldt		(%2, %1)		\n"	\
++			"fldcw		%2				\n"	\
++			"fldt		%1				\n"	\
+ 			#op" 						\n"	\
+-			"fstpt		(%2, %1)		\n"	\
++			"fstpt		%1				\n"	\
+ 			"fldcw		%0				"	\
+-			:	"=m" (save_cw)				\
+-			:	"r" (TOP), "r" (fpu.p_regs), "m" (fpu.cw_mask_all)		\
+-			:	"memory"				\
++			:	"=m" (save_cw), "+m" (fpu.p_regs[TOP])		\
++			:	"m" (fpu.cw_mask_all)		\
+ 		);
+ #else
+ #define FPUD_ARITH2(op)						\
+ 		Bit16u new_sw,save_cw;				\
+ 		__asm__ volatile (					\
+ 			"fnstcw		%1				\n"	\
+-			"fldcw		%4				\n"	\
+-			"shll		$4, %2			\n"	\
+-			"fldt		(%3, %2)		\n"	\
+-			clx" 						\n"	\
++			"fldcw		%3				\n"	\
++			"fldt		%2				\n"	\
++			"fclex 						\n"	\
+ 			#op" 						\n"	\
+ 			"fnstsw		%0				\n"	\
+-			"fstpt		(%3, %2)		\n"	\
++			"fstpt		%2				\n"	\
+ 			"fldcw		%1				"	\
+-			:	"=m" (new_sw), "=m" (save_cw)	\
+-			:	"r" (TOP), "r" (fpu.p_regs), "m" (fpu.cw_mask_all)		\
+-			:	"memory"				\
++			:	"=&am" (new_sw), "=m" (save_cw), "+m" (fpu.p_regs[TOP])	\
++			:	"m" (fpu.cw_mask_all)		\
+ 		);										\
+ 		fpu.sw=(new_sw&exc_mask)|(fpu.sw&0x80ff);
+ #endif
+ 
+ // handles fdiv,fdivr
+-#ifdef WEAK_EXCEPTIONS
+-#define FPUD_ARITH3(op)						\
+-		Bit16u save_cw;						\
+-		__asm__ volatile (					\
+-			"fnstcw		%0				\n"	\
+-			"fldcw		%4				\n"	\
+-			"shll		$4, %2			\n"	\
+-			"shll		$4, %1			\n"	\
+-			"fldt		(%3, %2)		\n"	\
+-			"fldt		(%3, %1)		\n"	\
+-			#op"						\n"	\
+-			"fstpt		(%3, %1)		\n"	\
+-			"fldcw		%0				"	\
+-			:	"=m" (save_cw)				\
+-			:	"r" (op1), "r" (op2), "r" (fpu.p_regs), "m" (fpu.cw_mask_all)		\
+-			:	"memory"					\
+-		);
+-#else
++// (This is identical to FPUD_ARITH1 but without a WEAK_EXCEPTIONS variant)
+ #define FPUD_ARITH3(op)						\
+ 		Bit16u new_sw,save_cw;				\
+ 		__asm__ volatile (					\
+ 			"fnstcw		%1				\n"	\
+-			"fldcw		%5				\n"	\
+-			"shll		$4, %3			\n"	\
+-			"shll		$4, %2			\n"	\
+-			"fldt		(%4, %3)		\n"	\
+-			"fldt		(%4, %2)		\n"	\
+-			"fclex						\n"	\
++			"fldcw		%4				\n"	\
++			"fldt		%3				\n"	\
++			"fldt		%2				\n"	\
++			"fclex 						\n"	\
+ 			#op"						\n"	\
+ 			"fnstsw		%0				\n"	\
+-			"fstpt		(%4, %2)		\n"	\
++			"fstpt		%2				\n"	\
+ 			"fldcw		%1				"	\
+-			:	"=m" (new_sw), "=m" (save_cw)		\
+-			:	"r" (op1), "r" (op2), "r" (fpu.p_regs), "m" (fpu.cw_mask_all)		\
+-			:	"memory"					\
++			:	"=&am" (new_sw), "=m" (save_cw), "+m" (fpu.p_regs[op1])	\
++			:	"m" (fpu.p_regs[op2]), "m" (fpu.cw_mask_all)		\
+ 		);									\
+ 		fpu.sw=(new_sw&0xffbf)|(fpu.sw&0x80ff);
+-#endif
+ 
+ // handles fdiv,fdivr
+-#ifdef WEAK_EXCEPTIONS
+-#define FPUD_ARITH3_EA(op)					\
+-		Bit16u save_cw;						\
+-		__asm__ volatile (					\
+-			"fnstcw		%0				\n"	\
+-			"fldcw		%3				\n"	\
+-			"shll		$4, %1			\n"	\
+-			"fldt		(%2, %1)		\n"	\
+-			#op"						\n"	\
+-			"fstpt		(%2, %1)		\n"	\
+-			"fldcw		%0				"	\
+-			:	"=m" (save_cw)				\
+-			:	"r" (op1), "r" (fpu.p_regs), "m" (fpu.cw_mask_all)		\
+-			:	"memory"					\
+-		);
+-#else
++// (This is identical to FPUD_ARITH1_EA but without a WEAK_EXCEPTIONS variant)
+ #define FPUD_ARITH3_EA(op)					\
+ 		Bit16u new_sw,save_cw;				\
+ 		__asm__ volatile (					\
+ 			"fnstcw		%1				\n"	\
+-			"fldcw		%4				\n"	\
+-			"shll		$4, %2			\n"	\
+-			"fldt		(%3, %2)		\n"	\
+-			"fclex						\n"	\
++			"fldcw		%3				\n"	\
++			"fldt		%2				\n"	\
++			"fclex 						\n"	\
+ 			#op"						\n"	\
+ 			"fnstsw		%0				\n"	\
+-			"fstpt		(%3, %2)		\n"	\
++			"fstpt		%2				\n"	\
+ 			"fldcw		%1				"	\
+-			:	"=m" (new_sw), "=m" (save_cw)		\
+-			:	"r" (op1), "r" (fpu.p_regs), "m" (fpu.cw_mask_all)		\
+-			:	"memory"					\
++			:	"=&am" (new_sw), "=m" (save_cw), "+m" (fpu.p_regs[op1])	\
++			:	"m" (fpu.cw_mask_all)		\
+ 		);									\
+ 		fpu.sw=(new_sw&0xffbf)|(fpu.sw&0x80ff);
+-#endif
+ 
+ // handles fprem,fprem1,fscale
+-#define FPUD_REMINDER(op)					\
++#define FPUD_REMAINDER(op)					\
+ 		Bit16u new_sw;						\
+ 		__asm__ volatile (					\
+-			"movl		%1, %%eax		\n"	\
+-			"incl		%%eax			\n"	\
+-			"andl		$7, %%eax		\n"	\
+-			"shll		$4, %%eax		\n"	\
+-			"shll		$4, %1			\n"	\
+-			"fldt		(%2, %%eax)		\n"	\
+-			"fldt		(%2, %1)		\n"	\
++			"fldt		%2				\n"	\
++			"fldt		%1				\n"	\
+ 			"fclex						\n"	\
+ 			#op" 						\n"	\
+ 			"fnstsw		%0				\n"	\
+-			"fstpt		(%2, %1)		\n"	\
++			"fstpt		%1				\n"	\
+ 			"fstp		%%st(0)			"	\
+-			:	"=m" (new_sw)				\
+-			:	"r" (TOP), "r" (fpu.p_regs)	\
+-			:	"eax", "memory"						\
++			:	"=&am" (new_sw), "+m" (fpu.p_regs[TOP])	\
++			:	"m" (fpu.p_regs[(TOP+1)&7])				\
+ 		);									\
+ 		fpu.sw=(new_sw&0xffbf)|(fpu.sw&0x80ff);
+ 
+@@ -952,16 +820,13 @@
+ #define FPUD_COMPARE(op)					\
+ 		Bit16u new_sw;						\
+ 		__asm__ volatile (					\
+-			"shll		$4, %2			\n"	\
+-			"shll		$4, %1			\n"	\
+-			"fldt		(%3, %2)		\n"	\
+-			"fldt		(%3, %1)		\n"	\
++			"fldt		%2				\n"	\
++			"fldt		%1				\n"	\
+ 			clx" 						\n"	\
+ 			#op" 						\n"	\
+ 			"fnstsw		%0				"	\
+-			:	"=m" (new_sw)				\
+-			:	"r" (op1), "r" (op2), "r" (fpu.p_regs) 		\
+-			:	"memory"					\
++			:	"=&am" (new_sw)				\
++			:	"m" (fpu.p_regs[op1]), "m" (fpu.p_regs[op2])	\
+ 		);									\
+ 		fpu.sw=(new_sw&exc_mask)|(fpu.sw&0x80ff);
+ 
+@@ -969,14 +834,12 @@
+ #define FPUD_COMPARE_EA(op)					\
+ 		Bit16u new_sw;						\
+ 		__asm__ volatile (					\
+-			"shll		$4, %1			\n"	\
+-			"fldt		(%2, %1)		\n"	\
++			"fldt		%1				\n"	\
+ 			clx" 						\n"	\
+ 			#op" 						\n"	\
+ 			"fnstsw		%0				"	\
+-			:	"=m" (new_sw)				\
+-			:	"r" (op1), "r" (fpu.p_regs) 		\
+-			:	"memory"					\
++			:	"=&am" (new_sw)				\
++			:	"m" (fpu.p_regs[op1])		\
+ 		);									\
+ 		fpu.sw=(new_sw&exc_mask)|(fpu.sw&0x80ff);
+ 
+@@ -984,15 +847,13 @@
+ #define FPUD_EXAMINE(op)					\
+ 		Bit16u new_sw;						\
+ 		__asm__ volatile (					\
+-			"shll		$4, %1			\n"	\
+-			"fldt		(%2, %1)		\n"	\
++			"fldt		%1				\n"	\
+ 			clx" 						\n"	\
+ 			#op" 						\n"	\
+ 			"fnstsw		%0				\n"	\
+ 			"fstp		%%st(0)			"	\
+-			:	"=m" (new_sw)				\
+-			:	"r" (TOP), "r" (fpu.p_regs)	\
+-			:	"memory"				\
++			:	"=&am" (new_sw)				\
++			:	"m" (fpu.p_regs[TOP])		\
+ 		);									\
+ 		fpu.sw=(new_sw&exc_mask)|(fpu.sw&0x80ff);
+ 
+@@ -1000,40 +861,28 @@
+ #ifdef WEAK_EXCEPTIONS
+ #define FPUD_WITH_POP(op)					\
+ 		__asm__ volatile (					\
+-			"movl		%0, %%eax		\n"	\
+-			"incl		%%eax			\n"	\
+-			"andl		$7, %%eax		\n"	\
+-			"shll		$4, %%eax		\n"	\
+-			"shll		$4, %0			\n"	\
+-			"fldt		(%1, %%eax)		\n"	\
+-			"fldt		(%1, %0)		\n"	\
++			"fldt		%0				\n"	\
++			"fldt		%1				\n"	\
+ 			#op" 						\n"	\
+-			"fstpt		(%1, %%eax)		\n"	\
+-			:								\
+-			:	"r" (TOP), "r" (fpu.p_regs)	\
+-			:	"eax", "memory"				\
++			"fstpt		%0				\n"	\
++			:	"+m" (fpu.p_regs[(TOP+1)&7])	\
++			:	"m" (fpu.p_regs[TOP])		\
+ 		);									\
+ 		FPU_FPOP();
+ #else
+ #define FPUD_WITH_POP(op)					\
+ 		Bit16u new_sw;						\
+ 		__asm__ volatile (					\
+-			"movl		%1, %%eax		\n"	\
+-			"incl		%%eax			\n"	\
+-			"andl		$7, %%eax		\n"	\
+-			"shll		$4, %%eax		\n"	\
+-			"shll		$4, %1			\n"	\
+-			"fldt		(%2, %%eax)		\n"	\
+-			"fldt		(%2, %1)		\n"	\
++			"fldt		%1				\n"	\
++			"fldt		%2				\n"	\
+ 			"fclex						\n"	\
+ 			#op" 						\n"	\
+ 			"fnstsw		%0				\n"	\
+-			"fstpt		(%2, %%eax)		\n"	\
+-			:	"=m" (new_sw)				\
+-			:	"r" (TOP), "r" (fpu.p_regs)	\
+-			:	"eax", "memory"						\
++			"fstpt		%1				\n"	\
++			:	"=&am" (new_sw), "+m" (fpu.p_regs[(TOP+1)&7])		\
++			:	"m" (fpu.p_regs[TOP])		\
+ 		);									\
+-		fpu.sw=(new_sw&0xffbf)|(fpu.sw&0x80ff);		\
++		fpu.sw=(new_sw&exc_mask)|(fpu.sw&0x80ff);		\
+ 		FPU_FPOP();
+ #endif
+ 
+@@ -1041,40 +890,28 @@
+ #ifdef WEAK_EXCEPTIONS
+ #define FPUD_FYL2X(op)						\
+ 		__asm__ volatile (					\
+-			"movl		%0, %%eax		\n"	\
+-			"incl		%%eax			\n"	\
+-			"andl		$7, %%eax		\n"	\
+-			"shll		$4, %%eax		\n"	\
+-			"shll		$4, %0			\n"	\
+-			"fldt		(%1, %%eax)		\n"	\
+-			"fldt		(%1, %0)		\n"	\
++			"fldt		%0				\n"	\
++			"fldt		%1				\n"	\
+ 			#op" 						\n"	\
+-			"fstpt		(%1, %%eax)		\n"	\
+-			:								\
+-			:	"r" (TOP), "r" (fpu.p_regs)	\
+-			:	"eax", "memory"				\
++			"fstpt		%0				\n"	\
++			:	"+m" (fpu.p_regs[(TOP+1)&7])	\
++			:	"m" (fpu.p_regs[TOP]) 		\
+ 		);									\
+ 		FPU_FPOP();
+ #else
+ #define FPUD_FYL2X(op)						\
+ 		Bit16u new_sw;						\
+ 		__asm__ volatile (					\
+-			"movl		%1, %%eax		\n"	\
+-			"incl		%%eax			\n"	\
+-			"andl		$7, %%eax		\n"	\
+-			"shll		$4, %%eax		\n"	\
+-			"shll		$4, %1			\n"	\
+-			"fldt		(%2, %%eax)		\n"	\
+-			"fldt		(%2, %1)		\n"	\
++			"fldt		%1				\n"	\
++			"fldt		%2				\n"	\
+ 			"fclex						\n"	\
+ 			#op" 						\n"	\
+ 			"fnstsw		%0				\n"	\
+-			"fstpt		(%2, %%eax)		\n"	\
+-			:	"=m" (new_sw)				\
+-			:	"r" (TOP), "r" (fpu.p_regs)	\
+-			:	"eax", "memory"				\
++			"fstpt		%1				\n"	\
++			:	"=&am" (new_sw), "+m" (fpu.p_regs[(TOP+1)&7])		\
++			:	"m" (fpu.p_regs[TOP]) 		\
+ 		);									\
+-		fpu.sw=(new_sw&0xffbf)|(fpu.sw&0x80ff);		\
++		fpu.sw=(new_sw&exc_mask)|(fpu.sw&0x80ff);		\
+ 		FPU_FPOP();
+ #endif
+ 
+@@ -1082,13 +919,10 @@
+ #define FPUD_LOAD_CONST(op)				\
+ 		FPU_PREP_PUSH();					\
+ 		__asm__ volatile (					\
+-			"shll		$4, %0			\n"	\
+ 			clx" 						\n"	\
+ 			#op" 						\n"	\
+-			"fstpt		(%1, %0)		\n"	\
+-			:								\
+-			:	"r" (TOP), "r" (fpu.p_regs)	\
+-			:	"memory"					\
++			"fstpt		%0				\n"	\
++			:	"=m" (fpu.p_regs[TOP])		\
+ 		);
+ 
+ #endif
+@@ -1162,12 +996,12 @@
+ 
+ static void FPU_FLD_I16(PhysPt addr,Bitu store_to) {
+ 	fpu.p_regs[8].m1 = (Bit32u)mem_readw(addr);
+-	FPUD_LOAD(fild,WORD,)
++	FPUD_LOAD(fild,WORD,s)
+ }
+ 
+ static void FPU_FLD_I16_EA(PhysPt addr) {
+ 	fpu.p_regs[8].m1 = (Bit32u)mem_readw(addr);
+-	FPUD_LOAD_EA(fild,WORD,)
++	FPUD_LOAD_EA(fild,WORD,s)
+ }
+ 
+ static void FPU_FLD_I32(PhysPt addr,Bitu store_to) {
+@@ -1212,7 +1046,7 @@
+ }
+ 
+ static void FPU_FST_I16(PhysPt addr) {
+-	FPUD_STORE(fistp,WORD,)
++	FPUD_STORE(fistp,WORD,s)
+ 	mem_writew(addr,(Bit16u)fpu.p_regs[8].m1);
+ }
+ 
+@@ -1354,11 +1188,11 @@
+ }
+ 
+ static void FPU_FPREM(void){
+-	FPUD_REMINDER(fprem)
++	FPUD_REMAINDER(fprem)
+ }
+ 
+ static void FPU_FPREM1(void){
+-	FPUD_REMINDER(fprem1)
++	FPUD_REMAINDER(fprem1)
+ }
+ 
+ static void FPU_FXAM(void){
+@@ -1383,7 +1217,7 @@
+ }
+ 
+ static void FPU_FSCALE(void){
+-	FPUD_REMINDER(fscale)
++	FPUD_REMAINDER(fscale)
+ }
+ 
+ 
+diff -Nur dosbox-0.74/src/fpu/Makefile.in dosbox/src/fpu/Makefile.in
+--- dosbox-0.74/src/fpu/Makefile.in	2010-05-12 11:57:44.000000000 +0200
++++ dosbox/src/fpu/Makefile.in	1970-01-01 01:00:00.000000000 +0100
+@@ -1,445 +0,0 @@
+-# Makefile.in generated by automake 1.11.1 from Makefile.am.
+-# @configure_input@
+-
+-# Copyright (C) 1994, 1995, 1996, 1997, 1998, 1999, 2000, 2001, 2002,
+-# 2003, 2004, 2005, 2006, 2007, 2008, 2009  Free Software Foundation,
+-# Inc.
+-# This Makefile.in is free software; the Free Software Foundation
+-# gives unlimited permission to copy and/or distribute it,
+-# with or without modifications, as long as this notice is preserved.
+-
+-# This program is distributed in the hope that it will be useful,
+-# but WITHOUT ANY WARRANTY, to the extent permitted by law; without
+-# even the implied warranty of MERCHANTABILITY or FITNESS FOR A
+-# PARTICULAR PURPOSE.
+-
+-@SET_MAKE@
+-
+-VPATH = @srcdir@
+-pkgdatadir = $(datadir)/@PACKAGE@
+-pkgincludedir = $(includedir)/@PACKAGE@
+-pkglibdir = $(libdir)/@PACKAGE@
+-pkglibexecdir = $(libexecdir)/@PACKAGE@
+-am__cd = CDPATH="$${ZSH_VERSION+.}$(PATH_SEPARATOR)" && cd
+-install_sh_DATA = $(install_sh) -c -m 644
+-install_sh_PROGRAM = $(install_sh) -c
+-install_sh_SCRIPT = $(install_sh) -c
+-INSTALL_HEADER = $(INSTALL_DATA)
+-transform = $(program_transform_name)
+-NORMAL_INSTALL = :
+-PRE_INSTALL = :
+-POST_INSTALL = :
+-NORMAL_UNINSTALL = :
+-PRE_UNINSTALL = :
+-POST_UNINSTALL = :
+-build_triplet = @build@
+-host_triplet = @host@
+-subdir = src/fpu
+-DIST_COMMON = $(srcdir)/Makefile.am $(srcdir)/Makefile.in
+-ACLOCAL_M4 = $(top_srcdir)/aclocal.m4
+-am__aclocal_m4_deps = $(top_srcdir)/acinclude.m4 \
+-	$(top_srcdir)/configure.in
+-am__configure_deps = $(am__aclocal_m4_deps) $(CONFIGURE_DEPENDENCIES) \
+-	$(ACLOCAL_M4)
+-mkinstalldirs = $(install_sh) -d
+-CONFIG_HEADER = $(top_builddir)/config.h
+-CONFIG_CLEAN_FILES =
+-CONFIG_CLEAN_VPATH_FILES =
+-LIBRARIES = $(noinst_LIBRARIES)
+-AR = ar
+-ARFLAGS = cru
+-libfpu_a_AR = $(AR) $(ARFLAGS)
+-libfpu_a_LIBADD =
+-am_libfpu_a_OBJECTS = fpu.$(OBJEXT)
+-libfpu_a_OBJECTS = $(am_libfpu_a_OBJECTS)
+-DEFAULT_INCLUDES = -I.@am__isrc@ -I$(top_builddir)
+-depcomp = $(SHELL) $(top_srcdir)/depcomp
+-am__depfiles_maybe = depfiles
+-am__mv = mv -f
+-CXXCOMPILE = $(CXX) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) \
+-	$(AM_CPPFLAGS) $(CPPFLAGS) $(AM_CXXFLAGS) $(CXXFLAGS)
+-CXXLD = $(CXX)
+-CXXLINK = $(CXXLD) $(AM_CXXFLAGS) $(CXXFLAGS) $(AM_LDFLAGS) $(LDFLAGS) \
+-	-o $@
+-COMPILE = $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) \
+-	$(CPPFLAGS) $(AM_CFLAGS) $(CFLAGS)
+-CCLD = $(CC)
+-LINK = $(CCLD) $(AM_CFLAGS) $(CFLAGS) $(AM_LDFLAGS) $(LDFLAGS) -o $@
+-SOURCES = $(libfpu_a_SOURCES)
+-DIST_SOURCES = $(libfpu_a_SOURCES)
+-ETAGS = etags
+-CTAGS = ctags
+-DISTFILES = $(DIST_COMMON) $(DIST_SOURCES) $(TEXINFOS) $(EXTRA_DIST)
+-ACLOCAL = @ACLOCAL@
+-ALSA_CFLAGS = @ALSA_CFLAGS@
+-ALSA_LIBS = @ALSA_LIBS@
+-AMTAR = @AMTAR@
+-AUTOCONF = @AUTOCONF@
+-AUTOHEADER = @AUTOHEADER@
+-AUTOMAKE = @AUTOMAKE@
+-AWK = @AWK@
+-CC = @CC@
+-CCDEPMODE = @CCDEPMODE@
+-CFLAGS = @CFLAGS@
+-CPP = @CPP@
+-CPPFLAGS = @CPPFLAGS@
+-CXX = @CXX@
+-CXXDEPMODE = @CXXDEPMODE@
+-CXXFLAGS = @CXXFLAGS@
+-CYGPATH_W = @CYGPATH_W@
+-DEFS = @DEFS@
+-DEPDIR = @DEPDIR@
+-ECHO_C = @ECHO_C@
+-ECHO_N = @ECHO_N@
+-ECHO_T = @ECHO_T@
+-EGREP = @EGREP@
+-EXEEXT = @EXEEXT@
+-GREP = @GREP@
+-INSTALL = @INSTALL@
+-INSTALL_DATA = @INSTALL_DATA@
+-INSTALL_PROGRAM = @INSTALL_PROGRAM@
+-INSTALL_SCRIPT = @INSTALL_SCRIPT@
+-INSTALL_STRIP_PROGRAM = @INSTALL_STRIP_PROGRAM@
+-LDFLAGS = @LDFLAGS@
+-LIBOBJS = @LIBOBJS@
+-LIBS = @LIBS@
+-LTLIBOBJS = @LTLIBOBJS@
+-MAKEINFO = @MAKEINFO@
+-MKDIR_P = @MKDIR_P@
+-OBJEXT = @OBJEXT@
+-PACKAGE = @PACKAGE@
+-PACKAGE_BUGREPORT = @PACKAGE_BUGREPORT@
+-PACKAGE_NAME = @PACKAGE_NAME@
+-PACKAGE_STRING = @PACKAGE_STRING@
+-PACKAGE_TARNAME = @PACKAGE_TARNAME@
+-PACKAGE_URL = @PACKAGE_URL@
+-PACKAGE_VERSION = @PACKAGE_VERSION@
+-PATH_SEPARATOR = @PATH_SEPARATOR@
+-RANLIB = @RANLIB@
+-SDL_CFLAGS = @SDL_CFLAGS@
+-SDL_CONFIG = @SDL_CONFIG@
+-SDL_LIBS = @SDL_LIBS@
+-SET_MAKE = @SET_MAKE@
+-SHELL = @SHELL@
+-STRIP = @STRIP@
+-VERSION = @VERSION@
+-WINDRES = @WINDRES@
+-abs_builddir = @abs_builddir@
+-abs_srcdir = @abs_srcdir@
+-abs_top_builddir = @abs_top_builddir@
+-abs_top_srcdir = @abs_top_srcdir@
+-ac_ct_CC = @ac_ct_CC@
+-ac_ct_CXX = @ac_ct_CXX@
+-am__include = @am__include@
+-am__leading_dot = @am__leading_dot@
+-am__quote = @am__quote@
+-am__tar = @am__tar@
+-am__untar = @am__untar@
+-bindir = @bindir@
+-build = @build@
+-build_alias = @build_alias@
+-build_cpu = @build_cpu@
+-build_os = @build_os@
+-build_vendor = @build_vendor@
+-builddir = @builddir@
+-datadir = @datadir@
+-datarootdir = @datarootdir@
+-docdir = @docdir@
+-dvidir = @dvidir@
+-exec_prefix = @exec_prefix@
+-host = @host@
+-host_alias = @host_alias@
+-host_cpu = @host_cpu@
+-host_os = @host_os@
+-host_vendor = @host_vendor@
+-htmldir = @htmldir@
+-includedir = @includedir@
+-infodir = @infodir@
+-install_sh = @install_sh@
+-libdir = @libdir@
+-libexecdir = @libexecdir@
+-localedir = @localedir@
+-localstatedir = @localstatedir@
+-mandir = @mandir@
+-mkdir_p = @mkdir_p@
+-oldincludedir = @oldincludedir@
+-pdfdir = @pdfdir@
+-prefix = @prefix@
+-program_transform_name = @program_transform_name@
+-psdir = @psdir@
+-sbindir = @sbindir@
+-sharedstatedir = @sharedstatedir@
+-srcdir = @srcdir@
+-sysconfdir = @sysconfdir@
+-target_alias = @target_alias@
+-top_build_prefix = @top_build_prefix@
+-top_builddir = @top_builddir@
+-top_srcdir = @top_srcdir@
+-AM_CPPFLAGS = -I$(top_srcdir)/include
+-noinst_LIBRARIES = libfpu.a
+-libfpu_a_SOURCES = fpu.cpp fpu_instructions.h \
+-                   fpu_instructions_x86.h
+-
+-all: all-am
+-
+-.SUFFIXES:
+-.SUFFIXES: .cpp .o .obj
+-$(srcdir)/Makefile.in:  $(srcdir)/Makefile.am  $(am__configure_deps)
+-	@for dep in $?; do \
+-	  case '$(am__configure_deps)' in \
+-	    *$$dep*) \
+-	      ( cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh ) \
+-	        && { if test -f $@; then exit 0; else break; fi; }; \
+-	      exit 1;; \
+-	  esac; \
+-	done; \
+-	echo ' cd $(top_srcdir) && $(AUTOMAKE) --gnu src/fpu/Makefile'; \
+-	$(am__cd) $(top_srcdir) && \
+-	  $(AUTOMAKE) --gnu src/fpu/Makefile
+-.PRECIOUS: Makefile
+-Makefile: $(srcdir)/Makefile.in $(top_builddir)/config.status
+-	@case '$?' in \
+-	  *config.status*) \
+-	    cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh;; \
+-	  *) \
+-	    echo ' cd $(top_builddir) && $(SHELL) ./config.status $(subdir)/$@ $(am__depfiles_maybe)'; \
+-	    cd $(top_builddir) && $(SHELL) ./config.status $(subdir)/$@ $(am__depfiles_maybe);; \
+-	esac;
+-
+-$(top_builddir)/config.status: $(top_srcdir)/configure $(CONFIG_STATUS_DEPENDENCIES)
+-	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
+-
+-$(top_srcdir)/configure:  $(am__configure_deps)
+-	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
+-$(ACLOCAL_M4):  $(am__aclocal_m4_deps)
+-	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
+-$(am__aclocal_m4_deps):
+-
+-clean-noinstLIBRARIES:
+-	-test -z "$(noinst_LIBRARIES)" || rm -f $(noinst_LIBRARIES)
+-libfpu.a: $(libfpu_a_OBJECTS) $(libfpu_a_DEPENDENCIES) 
+-	-rm -f libfpu.a
+-	$(libfpu_a_AR) libfpu.a $(libfpu_a_OBJECTS) $(libfpu_a_LIBADD)
+-	$(RANLIB) libfpu.a
+-
+-mostlyclean-compile:
+-	-rm -f *.$(OBJEXT)
+-
+-distclean-compile:
+-	-rm -f *.tab.c
+-
+-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/fpu.Po@am__quote@
+-
+-.cpp.o:
+-@am__fastdepCXX_TRUE@	$(CXXCOMPILE) -MT $@ -MD -MP -MF $(DEPDIR)/$*.Tpo -c -o $@ $<
+-@am__fastdepCXX_TRUE@	$(am__mv) $(DEPDIR)/$*.Tpo $(DEPDIR)/$*.Po
+-@AMDEP_TRUE@@am__fastdepCXX_FALSE@	source='$<' object='$@' libtool=no @AMDEPBACKSLASH@
+-@AMDEP_TRUE@@am__fastdepCXX_FALSE@	DEPDIR=$(DEPDIR) $(CXXDEPMODE) $(depcomp) @AMDEPBACKSLASH@
+-@am__fastdepCXX_FALSE@	$(CXXCOMPILE) -c -o $@ $<
+-
+-.cpp.obj:
+-@am__fastdepCXX_TRUE@	$(CXXCOMPILE) -MT $@ -MD -MP -MF $(DEPDIR)/$*.Tpo -c -o $@ `$(CYGPATH_W) '$<'`
+-@am__fastdepCXX_TRUE@	$(am__mv) $(DEPDIR)/$*.Tpo $(DEPDIR)/$*.Po
+-@AMDEP_TRUE@@am__fastdepCXX_FALSE@	source='$<' object='$@' libtool=no @AMDEPBACKSLASH@
+-@AMDEP_TRUE@@am__fastdepCXX_FALSE@	DEPDIR=$(DEPDIR) $(CXXDEPMODE) $(depcomp) @AMDEPBACKSLASH@
+-@am__fastdepCXX_FALSE@	$(CXXCOMPILE) -c -o $@ `$(CYGPATH_W) '$<'`
+-
+-ID: $(HEADERS) $(SOURCES) $(LISP) $(TAGS_FILES)
+-	list='$(SOURCES) $(HEADERS) $(LISP) $(TAGS_FILES)'; \
+-	unique=`for i in $$list; do \
+-	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
+-	  done | \
+-	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
+-	      END { if (nonempty) { for (i in files) print i; }; }'`; \
+-	mkid -fID $$unique
+-tags: TAGS
+-
+-TAGS:  $(HEADERS) $(SOURCES)  $(TAGS_DEPENDENCIES) \
+-		$(TAGS_FILES) $(LISP)
+-	set x; \
+-	here=`pwd`; \
+-	list='$(SOURCES) $(HEADERS)  $(LISP) $(TAGS_FILES)'; \
+-	unique=`for i in $$list; do \
+-	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
+-	  done | \
+-	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
+-	      END { if (nonempty) { for (i in files) print i; }; }'`; \
+-	shift; \
+-	if test -z "$(ETAGS_ARGS)$$*$$unique"; then :; else \
+-	  test -n "$$unique" || unique=$$empty_fix; \
+-	  if test $$# -gt 0; then \
+-	    $(ETAGS) $(ETAGSFLAGS) $(AM_ETAGSFLAGS) $(ETAGS_ARGS) \
+-	      "$$@" $$unique; \
+-	  else \
+-	    $(ETAGS) $(ETAGSFLAGS) $(AM_ETAGSFLAGS) $(ETAGS_ARGS) \
+-	      $$unique; \
+-	  fi; \
+-	fi
+-ctags: CTAGS
+-CTAGS:  $(HEADERS) $(SOURCES)  $(TAGS_DEPENDENCIES) \
+-		$(TAGS_FILES) $(LISP)
+-	list='$(SOURCES) $(HEADERS)  $(LISP) $(TAGS_FILES)'; \
+-	unique=`for i in $$list; do \
+-	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
+-	  done | \
+-	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
+-	      END { if (nonempty) { for (i in files) print i; }; }'`; \
+-	test -z "$(CTAGS_ARGS)$$unique" \
+-	  || $(CTAGS) $(CTAGSFLAGS) $(AM_CTAGSFLAGS) $(CTAGS_ARGS) \
+-	     $$unique
+-
+-GTAGS:
+-	here=`$(am__cd) $(top_builddir) && pwd` \
+-	  && $(am__cd) $(top_srcdir) \
+-	  && gtags -i $(GTAGS_ARGS) "$$here"
+-
+-distclean-tags:
+-	-rm -f TAGS ID GTAGS GRTAGS GSYMS GPATH tags
+-
+-distdir: $(DISTFILES)
+-	@srcdirstrip=`echo "$(srcdir)" | sed 's/[].[^$$\\*]/\\\\&/g'`; \
+-	topsrcdirstrip=`echo "$(top_srcdir)" | sed 's/[].[^$$\\*]/\\\\&/g'`; \
+-	list='$(DISTFILES)'; \
+-	  dist_files=`for file in $$list; do echo $$file; done | \
+-	  sed -e "s|^$$srcdirstrip/||;t" \
+-	      -e "s|^$$topsrcdirstrip/|$(top_builddir)/|;t"`; \
+-	case $$dist_files in \
+-	  */*) $(MKDIR_P) `echo "$$dist_files" | \
+-			   sed '/\//!d;s|^|$(distdir)/|;s,/[^/]*$$,,' | \
+-			   sort -u` ;; \
+-	esac; \
+-	for file in $$dist_files; do \
+-	  if test -f $$file || test -d $$file; then d=.; else d=$(srcdir); fi; \
+-	  if test -d $$d/$$file; then \
+-	    dir=`echo "/$$file" | sed -e 's,/[^/]*$$,,'`; \
+-	    if test -d "$(distdir)/$$file"; then \
+-	      find "$(distdir)/$$file" -type d ! -perm -700 -exec chmod u+rwx {} \;; \
+-	    fi; \
+-	    if test -d $(srcdir)/$$file && test $$d != $(srcdir); then \
+-	      cp -fpR $(srcdir)/$$file "$(distdir)$$dir" || exit 1; \
+-	      find "$(distdir)/$$file" -type d ! -perm -700 -exec chmod u+rwx {} \;; \
+-	    fi; \
+-	    cp -fpR $$d/$$file "$(distdir)$$dir" || exit 1; \
+-	  else \
+-	    test -f "$(distdir)/$$file" \
+-	    || cp -p $$d/$$file "$(distdir)/$$file" \
+-	    || exit 1; \
+-	  fi; \
+-	done
+-check-am: all-am
+-check: check-am
+-all-am: Makefile $(LIBRARIES)
+-installdirs:
+-install: install-am
+-install-exec: install-exec-am
+-install-data: install-data-am
+-uninstall: uninstall-am
+-
+-install-am: all-am
+-	@$(MAKE) $(AM_MAKEFLAGS) install-exec-am install-data-am
+-
+-installcheck: installcheck-am
+-install-strip:
+-	$(MAKE) $(AM_MAKEFLAGS) INSTALL_PROGRAM="$(INSTALL_STRIP_PROGRAM)" \
+-	  install_sh_PROGRAM="$(INSTALL_STRIP_PROGRAM)" INSTALL_STRIP_FLAG=-s \
+-	  `test -z '$(STRIP)' || \
+-	    echo "INSTALL_PROGRAM_ENV=STRIPPROG='$(STRIP)'"` install
+-mostlyclean-generic:
+-
+-clean-generic:
+-
+-distclean-generic:
+-	-test -z "$(CONFIG_CLEAN_FILES)" || rm -f $(CONFIG_CLEAN_FILES)
+-	-test . = "$(srcdir)" || test -z "$(CONFIG_CLEAN_VPATH_FILES)" || rm -f $(CONFIG_CLEAN_VPATH_FILES)
+-
+-maintainer-clean-generic:
+-	@echo "This command is intended for maintainers to use"
+-	@echo "it deletes files that may require special tools to rebuild."
+-clean: clean-am
+-
+-clean-am: clean-generic clean-noinstLIBRARIES mostlyclean-am
+-
+-distclean: distclean-am
+-	-rm -rf ./$(DEPDIR)
+-	-rm -f Makefile
+-distclean-am: clean-am distclean-compile distclean-generic \
+-	distclean-tags
+-
+-dvi: dvi-am
+-
+-dvi-am:
+-
+-html: html-am
+-
+-html-am:
+-
+-info: info-am
+-
+-info-am:
+-
+-install-data-am:
+-
+-install-dvi: install-dvi-am
+-
+-install-dvi-am:
+-
+-install-exec-am:
+-
+-install-html: install-html-am
+-
+-install-html-am:
+-
+-install-info: install-info-am
+-
+-install-info-am:
+-
+-install-man:
+-
+-install-pdf: install-pdf-am
+-
+-install-pdf-am:
+-
+-install-ps: install-ps-am
+-
+-install-ps-am:
+-
+-installcheck-am:
+-
+-maintainer-clean: maintainer-clean-am
+-	-rm -rf ./$(DEPDIR)
+-	-rm -f Makefile
+-maintainer-clean-am: distclean-am maintainer-clean-generic
+-
+-mostlyclean: mostlyclean-am
+-
+-mostlyclean-am: mostlyclean-compile mostlyclean-generic
+-
+-pdf: pdf-am
+-
+-pdf-am:
+-
+-ps: ps-am
+-
+-ps-am:
+-
+-uninstall-am:
+-
+-.MAKE: install-am install-strip
+-
+-.PHONY: CTAGS GTAGS all all-am check check-am clean clean-generic \
+-	clean-noinstLIBRARIES ctags distclean distclean-compile \
+-	distclean-generic distclean-tags distdir dvi dvi-am html \
+-	html-am info info-am install install-am install-data \
+-	install-data-am install-dvi install-dvi-am install-exec \
+-	install-exec-am install-html install-html-am install-info \
+-	install-info-am install-man install-pdf install-pdf-am \
+-	install-ps install-ps-am install-strip installcheck \
+-	installcheck-am installdirs maintainer-clean \
+-	maintainer-clean-generic mostlyclean mostlyclean-compile \
+-	mostlyclean-generic pdf pdf-am ps ps-am tags uninstall \
+-	uninstall-am
+-
+-
+-# Tell versions [3.59,3.63) of GNU make to not export all variables.
+-# Otherwise a system limit (for SysV at least) may be exceeded.
+-.NOEXPORT:
+diff -Nur dosbox-0.74/src/gui/dosbox_logo.h dosbox/src/gui/dosbox_logo.h
+--- dosbox-0.74/src/gui/dosbox_logo.h	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/gui/dosbox_logo.h	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,7 +16,6 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: dosbox_logo.h,v 1.5 2009-05-27 09:15:41 qbix79 Exp $ */
+ 
+ /* DOSBox icon designed by Ido Beeri */
+ 
+diff -Nur dosbox-0.74/src/gui/Makefile.in dosbox/src/gui/Makefile.in
+--- dosbox-0.74/src/gui/Makefile.in	2010-05-12 11:57:44.000000000 +0200
++++ dosbox/src/gui/Makefile.in	1970-01-01 01:00:00.000000000 +0100
+@@ -1,457 +0,0 @@
+-# Makefile.in generated by automake 1.11.1 from Makefile.am.
+-# @configure_input@
+-
+-# Copyright (C) 1994, 1995, 1996, 1997, 1998, 1999, 2000, 2001, 2002,
+-# 2003, 2004, 2005, 2006, 2007, 2008, 2009  Free Software Foundation,
+-# Inc.
+-# This Makefile.in is free software; the Free Software Foundation
+-# gives unlimited permission to copy and/or distribute it,
+-# with or without modifications, as long as this notice is preserved.
+-
+-# This program is distributed in the hope that it will be useful,
+-# but WITHOUT ANY WARRANTY, to the extent permitted by law; without
+-# even the implied warranty of MERCHANTABILITY or FITNESS FOR A
+-# PARTICULAR PURPOSE.
+-
+-@SET_MAKE@
+-
+-VPATH = @srcdir@
+-pkgdatadir = $(datadir)/@PACKAGE@
+-pkgincludedir = $(includedir)/@PACKAGE@
+-pkglibdir = $(libdir)/@PACKAGE@
+-pkglibexecdir = $(libexecdir)/@PACKAGE@
+-am__cd = CDPATH="$${ZSH_VERSION+.}$(PATH_SEPARATOR)" && cd
+-install_sh_DATA = $(install_sh) -c -m 644
+-install_sh_PROGRAM = $(install_sh) -c
+-install_sh_SCRIPT = $(install_sh) -c
+-INSTALL_HEADER = $(INSTALL_DATA)
+-transform = $(program_transform_name)
+-NORMAL_INSTALL = :
+-PRE_INSTALL = :
+-POST_INSTALL = :
+-NORMAL_UNINSTALL = :
+-PRE_UNINSTALL = :
+-POST_UNINSTALL = :
+-build_triplet = @build@
+-host_triplet = @host@
+-subdir = src/gui
+-DIST_COMMON = $(srcdir)/Makefile.am $(srcdir)/Makefile.in
+-ACLOCAL_M4 = $(top_srcdir)/aclocal.m4
+-am__aclocal_m4_deps = $(top_srcdir)/acinclude.m4 \
+-	$(top_srcdir)/configure.in
+-am__configure_deps = $(am__aclocal_m4_deps) $(CONFIGURE_DEPENDENCIES) \
+-	$(ACLOCAL_M4)
+-mkinstalldirs = $(install_sh) -d
+-CONFIG_HEADER = $(top_builddir)/config.h
+-CONFIG_CLEAN_FILES =
+-CONFIG_CLEAN_VPATH_FILES =
+-LIBRARIES = $(noinst_LIBRARIES)
+-AR = ar
+-ARFLAGS = cru
+-libgui_a_AR = $(AR) $(ARFLAGS)
+-libgui_a_LIBADD =
+-am_libgui_a_OBJECTS = sdlmain.$(OBJEXT) sdl_mapper.$(OBJEXT) \
+-	render.$(OBJEXT) render_scalers.$(OBJEXT) midi.$(OBJEXT) \
+-	sdl_gui.$(OBJEXT)
+-libgui_a_OBJECTS = $(am_libgui_a_OBJECTS)
+-DEFAULT_INCLUDES = -I.@am__isrc@ -I$(top_builddir)
+-depcomp = $(SHELL) $(top_srcdir)/depcomp
+-am__depfiles_maybe = depfiles
+-am__mv = mv -f
+-CXXCOMPILE = $(CXX) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) \
+-	$(AM_CPPFLAGS) $(CPPFLAGS) $(AM_CXXFLAGS) $(CXXFLAGS)
+-CXXLD = $(CXX)
+-CXXLINK = $(CXXLD) $(AM_CXXFLAGS) $(CXXFLAGS) $(AM_LDFLAGS) $(LDFLAGS) \
+-	-o $@
+-COMPILE = $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) \
+-	$(CPPFLAGS) $(AM_CFLAGS) $(CFLAGS)
+-CCLD = $(CC)
+-LINK = $(CCLD) $(AM_CFLAGS) $(CFLAGS) $(AM_LDFLAGS) $(LDFLAGS) -o $@
+-SOURCES = $(libgui_a_SOURCES)
+-DIST_SOURCES = $(libgui_a_SOURCES)
+-ETAGS = etags
+-CTAGS = ctags
+-DISTFILES = $(DIST_COMMON) $(DIST_SOURCES) $(TEXINFOS) $(EXTRA_DIST)
+-ACLOCAL = @ACLOCAL@
+-ALSA_CFLAGS = @ALSA_CFLAGS@
+-ALSA_LIBS = @ALSA_LIBS@
+-AMTAR = @AMTAR@
+-AUTOCONF = @AUTOCONF@
+-AUTOHEADER = @AUTOHEADER@
+-AUTOMAKE = @AUTOMAKE@
+-AWK = @AWK@
+-CC = @CC@
+-CCDEPMODE = @CCDEPMODE@
+-CFLAGS = @CFLAGS@
+-CPP = @CPP@
+-CPPFLAGS = @CPPFLAGS@
+-CXX = @CXX@
+-CXXDEPMODE = @CXXDEPMODE@
+-CXXFLAGS = @CXXFLAGS@
+-CYGPATH_W = @CYGPATH_W@
+-DEFS = @DEFS@
+-DEPDIR = @DEPDIR@
+-ECHO_C = @ECHO_C@
+-ECHO_N = @ECHO_N@
+-ECHO_T = @ECHO_T@
+-EGREP = @EGREP@
+-EXEEXT = @EXEEXT@
+-GREP = @GREP@
+-INSTALL = @INSTALL@
+-INSTALL_DATA = @INSTALL_DATA@
+-INSTALL_PROGRAM = @INSTALL_PROGRAM@
+-INSTALL_SCRIPT = @INSTALL_SCRIPT@
+-INSTALL_STRIP_PROGRAM = @INSTALL_STRIP_PROGRAM@
+-LDFLAGS = @LDFLAGS@
+-LIBOBJS = @LIBOBJS@
+-LIBS = @LIBS@
+-LTLIBOBJS = @LTLIBOBJS@
+-MAKEINFO = @MAKEINFO@
+-MKDIR_P = @MKDIR_P@
+-OBJEXT = @OBJEXT@
+-PACKAGE = @PACKAGE@
+-PACKAGE_BUGREPORT = @PACKAGE_BUGREPORT@
+-PACKAGE_NAME = @PACKAGE_NAME@
+-PACKAGE_STRING = @PACKAGE_STRING@
+-PACKAGE_TARNAME = @PACKAGE_TARNAME@
+-PACKAGE_URL = @PACKAGE_URL@
+-PACKAGE_VERSION = @PACKAGE_VERSION@
+-PATH_SEPARATOR = @PATH_SEPARATOR@
+-RANLIB = @RANLIB@
+-SDL_CFLAGS = @SDL_CFLAGS@
+-SDL_CONFIG = @SDL_CONFIG@
+-SDL_LIBS = @SDL_LIBS@
+-SET_MAKE = @SET_MAKE@
+-SHELL = @SHELL@
+-STRIP = @STRIP@
+-VERSION = @VERSION@
+-WINDRES = @WINDRES@
+-abs_builddir = @abs_builddir@
+-abs_srcdir = @abs_srcdir@
+-abs_top_builddir = @abs_top_builddir@
+-abs_top_srcdir = @abs_top_srcdir@
+-ac_ct_CC = @ac_ct_CC@
+-ac_ct_CXX = @ac_ct_CXX@
+-am__include = @am__include@
+-am__leading_dot = @am__leading_dot@
+-am__quote = @am__quote@
+-am__tar = @am__tar@
+-am__untar = @am__untar@
+-bindir = @bindir@
+-build = @build@
+-build_alias = @build_alias@
+-build_cpu = @build_cpu@
+-build_os = @build_os@
+-build_vendor = @build_vendor@
+-builddir = @builddir@
+-datadir = @datadir@
+-datarootdir = @datarootdir@
+-docdir = @docdir@
+-dvidir = @dvidir@
+-exec_prefix = @exec_prefix@
+-host = @host@
+-host_alias = @host_alias@
+-host_cpu = @host_cpu@
+-host_os = @host_os@
+-host_vendor = @host_vendor@
+-htmldir = @htmldir@
+-includedir = @includedir@
+-infodir = @infodir@
+-install_sh = @install_sh@
+-libdir = @libdir@
+-libexecdir = @libexecdir@
+-localedir = @localedir@
+-localstatedir = @localstatedir@
+-mandir = @mandir@
+-mkdir_p = @mkdir_p@
+-oldincludedir = @oldincludedir@
+-pdfdir = @pdfdir@
+-prefix = @prefix@
+-program_transform_name = @program_transform_name@
+-psdir = @psdir@
+-sbindir = @sbindir@
+-sharedstatedir = @sharedstatedir@
+-srcdir = @srcdir@
+-sysconfdir = @sysconfdir@
+-target_alias = @target_alias@
+-top_build_prefix = @top_build_prefix@
+-top_builddir = @top_builddir@
+-top_srcdir = @top_srcdir@
+-AM_CPPFLAGS = -I$(top_srcdir)/include
+-noinst_LIBRARIES = libgui.a
+-libgui_a_SOURCES = sdlmain.cpp sdl_mapper.cpp dosbox_logo.h \
+-	render.cpp render_scalers.cpp render_scalers.h \
+-	render_templates.h render_loops.h render_simple.h \
+-	render_templates_sai.h render_templates_hq.h \
+-	render_templates_hq2x.h render_templates_hq3x.h \
+-	midi.cpp midi_win32.h midi_oss.h midi_coreaudio.h midi_alsa.h \
+-	midi_coremidi.h sdl_gui.cpp dosbox_splash.h
+-
+-all: all-am
+-
+-.SUFFIXES:
+-.SUFFIXES: .cpp .o .obj
+-$(srcdir)/Makefile.in:  $(srcdir)/Makefile.am  $(am__configure_deps)
+-	@for dep in $?; do \
+-	  case '$(am__configure_deps)' in \
+-	    *$$dep*) \
+-	      ( cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh ) \
+-	        && { if test -f $@; then exit 0; else break; fi; }; \
+-	      exit 1;; \
+-	  esac; \
+-	done; \
+-	echo ' cd $(top_srcdir) && $(AUTOMAKE) --gnu src/gui/Makefile'; \
+-	$(am__cd) $(top_srcdir) && \
+-	  $(AUTOMAKE) --gnu src/gui/Makefile
+-.PRECIOUS: Makefile
+-Makefile: $(srcdir)/Makefile.in $(top_builddir)/config.status
+-	@case '$?' in \
+-	  *config.status*) \
+-	    cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh;; \
+-	  *) \
+-	    echo ' cd $(top_builddir) && $(SHELL) ./config.status $(subdir)/$@ $(am__depfiles_maybe)'; \
+-	    cd $(top_builddir) && $(SHELL) ./config.status $(subdir)/$@ $(am__depfiles_maybe);; \
+-	esac;
+-
+-$(top_builddir)/config.status: $(top_srcdir)/configure $(CONFIG_STATUS_DEPENDENCIES)
+-	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
+-
+-$(top_srcdir)/configure:  $(am__configure_deps)
+-	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
+-$(ACLOCAL_M4):  $(am__aclocal_m4_deps)
+-	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
+-$(am__aclocal_m4_deps):
+-
+-clean-noinstLIBRARIES:
+-	-test -z "$(noinst_LIBRARIES)" || rm -f $(noinst_LIBRARIES)
+-libgui.a: $(libgui_a_OBJECTS) $(libgui_a_DEPENDENCIES) 
+-	-rm -f libgui.a
+-	$(libgui_a_AR) libgui.a $(libgui_a_OBJECTS) $(libgui_a_LIBADD)
+-	$(RANLIB) libgui.a
+-
+-mostlyclean-compile:
+-	-rm -f *.$(OBJEXT)
+-
+-distclean-compile:
+-	-rm -f *.tab.c
+-
+-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/midi.Po@am__quote@
+-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/render.Po@am__quote@
+-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/render_scalers.Po@am__quote@
+-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/sdl_gui.Po@am__quote@
+-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/sdl_mapper.Po@am__quote@
+-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/sdlmain.Po@am__quote@
+-
+-.cpp.o:
+-@am__fastdepCXX_TRUE@	$(CXXCOMPILE) -MT $@ -MD -MP -MF $(DEPDIR)/$*.Tpo -c -o $@ $<
+-@am__fastdepCXX_TRUE@	$(am__mv) $(DEPDIR)/$*.Tpo $(DEPDIR)/$*.Po
+-@AMDEP_TRUE@@am__fastdepCXX_FALSE@	source='$<' object='$@' libtool=no @AMDEPBACKSLASH@
+-@AMDEP_TRUE@@am__fastdepCXX_FALSE@	DEPDIR=$(DEPDIR) $(CXXDEPMODE) $(depcomp) @AMDEPBACKSLASH@
+-@am__fastdepCXX_FALSE@	$(CXXCOMPILE) -c -o $@ $<
+-
+-.cpp.obj:
+-@am__fastdepCXX_TRUE@	$(CXXCOMPILE) -MT $@ -MD -MP -MF $(DEPDIR)/$*.Tpo -c -o $@ `$(CYGPATH_W) '$<'`
+-@am__fastdepCXX_TRUE@	$(am__mv) $(DEPDIR)/$*.Tpo $(DEPDIR)/$*.Po
+-@AMDEP_TRUE@@am__fastdepCXX_FALSE@	source='$<' object='$@' libtool=no @AMDEPBACKSLASH@
+-@AMDEP_TRUE@@am__fastdepCXX_FALSE@	DEPDIR=$(DEPDIR) $(CXXDEPMODE) $(depcomp) @AMDEPBACKSLASH@
+-@am__fastdepCXX_FALSE@	$(CXXCOMPILE) -c -o $@ `$(CYGPATH_W) '$<'`
+-
+-ID: $(HEADERS) $(SOURCES) $(LISP) $(TAGS_FILES)
+-	list='$(SOURCES) $(HEADERS) $(LISP) $(TAGS_FILES)'; \
+-	unique=`for i in $$list; do \
+-	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
+-	  done | \
+-	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
+-	      END { if (nonempty) { for (i in files) print i; }; }'`; \
+-	mkid -fID $$unique
+-tags: TAGS
+-
+-TAGS:  $(HEADERS) $(SOURCES)  $(TAGS_DEPENDENCIES) \
+-		$(TAGS_FILES) $(LISP)
+-	set x; \
+-	here=`pwd`; \
+-	list='$(SOURCES) $(HEADERS)  $(LISP) $(TAGS_FILES)'; \
+-	unique=`for i in $$list; do \
+-	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
+-	  done | \
+-	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
+-	      END { if (nonempty) { for (i in files) print i; }; }'`; \
+-	shift; \
+-	if test -z "$(ETAGS_ARGS)$$*$$unique"; then :; else \
+-	  test -n "$$unique" || unique=$$empty_fix; \
+-	  if test $$# -gt 0; then \
+-	    $(ETAGS) $(ETAGSFLAGS) $(AM_ETAGSFLAGS) $(ETAGS_ARGS) \
+-	      "$$@" $$unique; \
+-	  else \
+-	    $(ETAGS) $(ETAGSFLAGS) $(AM_ETAGSFLAGS) $(ETAGS_ARGS) \
+-	      $$unique; \
+-	  fi; \
+-	fi
+-ctags: CTAGS
+-CTAGS:  $(HEADERS) $(SOURCES)  $(TAGS_DEPENDENCIES) \
+-		$(TAGS_FILES) $(LISP)
+-	list='$(SOURCES) $(HEADERS)  $(LISP) $(TAGS_FILES)'; \
+-	unique=`for i in $$list; do \
+-	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
+-	  done | \
+-	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
+-	      END { if (nonempty) { for (i in files) print i; }; }'`; \
+-	test -z "$(CTAGS_ARGS)$$unique" \
+-	  || $(CTAGS) $(CTAGSFLAGS) $(AM_CTAGSFLAGS) $(CTAGS_ARGS) \
+-	     $$unique
+-
+-GTAGS:
+-	here=`$(am__cd) $(top_builddir) && pwd` \
+-	  && $(am__cd) $(top_srcdir) \
+-	  && gtags -i $(GTAGS_ARGS) "$$here"
+-
+-distclean-tags:
+-	-rm -f TAGS ID GTAGS GRTAGS GSYMS GPATH tags
+-
+-distdir: $(DISTFILES)
+-	@srcdirstrip=`echo "$(srcdir)" | sed 's/[].[^$$\\*]/\\\\&/g'`; \
+-	topsrcdirstrip=`echo "$(top_srcdir)" | sed 's/[].[^$$\\*]/\\\\&/g'`; \
+-	list='$(DISTFILES)'; \
+-	  dist_files=`for file in $$list; do echo $$file; done | \
+-	  sed -e "s|^$$srcdirstrip/||;t" \
+-	      -e "s|^$$topsrcdirstrip/|$(top_builddir)/|;t"`; \
+-	case $$dist_files in \
+-	  */*) $(MKDIR_P) `echo "$$dist_files" | \
+-			   sed '/\//!d;s|^|$(distdir)/|;s,/[^/]*$$,,' | \
+-			   sort -u` ;; \
+-	esac; \
+-	for file in $$dist_files; do \
+-	  if test -f $$file || test -d $$file; then d=.; else d=$(srcdir); fi; \
+-	  if test -d $$d/$$file; then \
+-	    dir=`echo "/$$file" | sed -e 's,/[^/]*$$,,'`; \
+-	    if test -d "$(distdir)/$$file"; then \
+-	      find "$(distdir)/$$file" -type d ! -perm -700 -exec chmod u+rwx {} \;; \
+-	    fi; \
+-	    if test -d $(srcdir)/$$file && test $$d != $(srcdir); then \
+-	      cp -fpR $(srcdir)/$$file "$(distdir)$$dir" || exit 1; \
+-	      find "$(distdir)/$$file" -type d ! -perm -700 -exec chmod u+rwx {} \;; \
+-	    fi; \
+-	    cp -fpR $$d/$$file "$(distdir)$$dir" || exit 1; \
+-	  else \
+-	    test -f "$(distdir)/$$file" \
+-	    || cp -p $$d/$$file "$(distdir)/$$file" \
+-	    || exit 1; \
+-	  fi; \
+-	done
+-check-am: all-am
+-check: check-am
+-all-am: Makefile $(LIBRARIES)
+-installdirs:
+-install: install-am
+-install-exec: install-exec-am
+-install-data: install-data-am
+-uninstall: uninstall-am
+-
+-install-am: all-am
+-	@$(MAKE) $(AM_MAKEFLAGS) install-exec-am install-data-am
+-
+-installcheck: installcheck-am
+-install-strip:
+-	$(MAKE) $(AM_MAKEFLAGS) INSTALL_PROGRAM="$(INSTALL_STRIP_PROGRAM)" \
+-	  install_sh_PROGRAM="$(INSTALL_STRIP_PROGRAM)" INSTALL_STRIP_FLAG=-s \
+-	  `test -z '$(STRIP)' || \
+-	    echo "INSTALL_PROGRAM_ENV=STRIPPROG='$(STRIP)'"` install
+-mostlyclean-generic:
+-
+-clean-generic:
+-
+-distclean-generic:
+-	-test -z "$(CONFIG_CLEAN_FILES)" || rm -f $(CONFIG_CLEAN_FILES)
+-	-test . = "$(srcdir)" || test -z "$(CONFIG_CLEAN_VPATH_FILES)" || rm -f $(CONFIG_CLEAN_VPATH_FILES)
+-
+-maintainer-clean-generic:
+-	@echo "This command is intended for maintainers to use"
+-	@echo "it deletes files that may require special tools to rebuild."
+-clean: clean-am
+-
+-clean-am: clean-generic clean-noinstLIBRARIES mostlyclean-am
+-
+-distclean: distclean-am
+-	-rm -rf ./$(DEPDIR)
+-	-rm -f Makefile
+-distclean-am: clean-am distclean-compile distclean-generic \
+-	distclean-tags
+-
+-dvi: dvi-am
+-
+-dvi-am:
+-
+-html: html-am
+-
+-html-am:
+-
+-info: info-am
+-
+-info-am:
+-
+-install-data-am:
+-
+-install-dvi: install-dvi-am
+-
+-install-dvi-am:
+-
+-install-exec-am:
+-
+-install-html: install-html-am
+-
+-install-html-am:
+-
+-install-info: install-info-am
+-
+-install-info-am:
+-
+-install-man:
+-
+-install-pdf: install-pdf-am
+-
+-install-pdf-am:
+-
+-install-ps: install-ps-am
+-
+-install-ps-am:
+-
+-installcheck-am:
+-
+-maintainer-clean: maintainer-clean-am
+-	-rm -rf ./$(DEPDIR)
+-	-rm -f Makefile
+-maintainer-clean-am: distclean-am maintainer-clean-generic
+-
+-mostlyclean: mostlyclean-am
+-
+-mostlyclean-am: mostlyclean-compile mostlyclean-generic
+-
+-pdf: pdf-am
+-
+-pdf-am:
+-
+-ps: ps-am
+-
+-ps-am:
+-
+-uninstall-am:
+-
+-.MAKE: install-am install-strip
+-
+-.PHONY: CTAGS GTAGS all all-am check check-am clean clean-generic \
+-	clean-noinstLIBRARIES ctags distclean distclean-compile \
+-	distclean-generic distclean-tags distdir dvi dvi-am html \
+-	html-am info info-am install install-am install-data \
+-	install-data-am install-dvi install-dvi-am install-exec \
+-	install-exec-am install-html install-html-am install-info \
+-	install-info-am install-man install-pdf install-pdf-am \
+-	install-ps install-ps-am install-strip installcheck \
+-	installcheck-am installdirs maintainer-clean \
+-	maintainer-clean-generic mostlyclean mostlyclean-compile \
+-	mostlyclean-generic pdf pdf-am ps ps-am tags uninstall \
+-	uninstall-am
+-
+-
+-# Tell versions [3.59,3.63) of GNU make to not export all variables.
+-# Otherwise a system limit (for SysV at least) may be exceeded.
+-.NOEXPORT:
+diff -Nur dosbox-0.74/src/gui/midi_alsa.h dosbox/src/gui/midi_alsa.h
+--- dosbox-0.74/src/gui/midi_alsa.h	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/gui/midi_alsa.h	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,7 +16,6 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: midi_alsa.h,v 1.20 2009-04-27 17:33:12 qbix79 Exp $ */
+ 
+ #define ALSA_PCM_OLD_HW_PARAMS_API
+ #define ALSA_PCM_OLD_SW_PARAMS_API
+diff -Nur dosbox-0.74/src/gui/midi_coreaudio.h dosbox/src/gui/midi_coreaudio.h
+--- dosbox-0.74/src/gui/midi_coreaudio.h	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/gui/midi_coreaudio.h	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,7 +16,6 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: midi_coreaudio.h,v 1.12 2009-10-18 18:06:28 qbix79 Exp $ */
+ 
+ #include <AudioToolbox/AUGraph.h>
+ #include <CoreServices/CoreServices.h>
+@@ -33,6 +32,7 @@
+ private:
+ 	AUGraph m_auGraph;
+ 	AudioUnit m_synth;
++        const char *soundfont;
+ public:
+ 	MidiHandler_coreaudio() : m_auGraph(0), m_synth(0) {}
+ 	const char * GetName(void) { return "coreaudio"; }
+@@ -72,6 +72,22 @@
+ 		// Get the music device from the graph.
+ 		RequireNoErr(AUGraphGetNodeInfo(m_auGraph, synthNode, NULL, NULL, NULL, &m_synth));
+ 
++                // Optionally load a soundfont 
++                if (conf && conf[0]) {
++                  soundfont = conf;
++                  FSRef soundfontRef;
++                  RequireNoErr(FSPathMakeRef((const UInt8*)soundfont, &soundfontRef, NULL));
++                  RequireNoErr(AudioUnitSetProperty(
++                                                    m_synth,
++                                                    kMusicDeviceProperty_SoundBankFSRef, 
++                                                    kAudioUnitScope_Global,
++                                                    0,
++                                                    &soundfontRef,
++                                                    sizeof(soundfontRef)
++                                                    ));
++                  LOG_MSG("MIDI:coreaudio: loaded soundfont: %s",soundfont);
++                } 
++
+ 		// Finally: Start the graph!
+ 		RequireNoErr(AUGraphStart(m_auGraph));
+ 
+diff -Nur dosbox-0.74/src/gui/midi_coremidi.h dosbox/src/gui/midi_coremidi.h
+--- dosbox-0.74/src/gui/midi_coremidi.h	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/gui/midi_coremidi.h	2014-01-12 14:43:47.000000000 +0100
+@@ -25,14 +25,14 @@
+ public:
+ 	MidiHandler_coremidi()  {m_pCurPacket = 0;}
+ 	const char * GetName(void) { return "coremidi"; }
+-	bool Open(const char * conf) {
+-	
++	bool Open(const char * conf) {	
+ 		// Get the MIDIEndPoint
+ 		m_endpoint = 0;
+ 		OSStatus result;
+ 		Bitu numDests = MIDIGetNumberOfDestinations();
+-	        Bitu destId = 0;
+-	        if(conf && conf[0]) destId = atoi(conf);
++		Bitu destId = 0;
++		if(conf && conf[0]) destId = atoi(conf);
++		
+ 		if (destId < numDests)
+ 		{
+ 			m_endpoint = MIDIGetDestination(destId);
+@@ -67,7 +67,8 @@
+ 		MIDIClientDispose(m_client);
+ 
+ 		// Dispose the endpoint
+-		MIDIEndpointDispose(m_endpoint);
++		// Not, as it is for Endpoints created by us
++//		MIDIEndpointDispose(m_endpoint);
+ 	}
+ 	
+ 	void PlayMsg(Bit8u * msg) {
+@@ -99,6 +100,21 @@
+ 		// Send the MIDIPacketList
+ 		MIDISend(m_port,m_endpoint,packetList);
+ 	}
++	void ListAll(Program* base) {
++		Bitu numDests = MIDIGetNumberOfDestinations();
++		for(Bitu i = 0; i < numDests; i++){
++			MIDIEndpointRef dest = MIDIGetDestination(i);
++			if(!dest) continue;
++			CFStringRef midiname = 0;
++			if(MIDIObjectGetStringProperty(dest, kMIDIPropertyDisplayName, &midiname) == noErr) {
++				const char * s = CFStringGetCStringPtr(midiname, kCFStringEncodingMacRoman);
++				if(s) base->WriteOut("%02d\t%s\n",i,s);
++			}
++			//This is for EndPoints created by us.
++			//MIDIEndpointDispose(dest);
++		}
++
++	}
+ };
+ 
+ MidiHandler_coremidi Midi_coremidi;
+diff -Nur dosbox-0.74/src/gui/midi.cpp dosbox/src/gui/midi.cpp
+--- dosbox-0.74/src/gui/midi.cpp	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/gui/midi.cpp	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -19,16 +19,21 @@
+ #include <assert.h>
+ #include <string.h>
+ #include <stdlib.h>
++#include <string>
++#include <algorithm>
++
++#include "SDL.h"
+ 
+ #include "dosbox.h"
++#include "midi.h"
+ #include "cross.h"
+ #include "support.h"
+ #include "setup.h"
+ #include "mapper.h"
+ #include "pic.h"
+ #include "hardware.h"
++#include "timer.h"
+ 
+-#define SYSEX_SIZE 1024
+ #define RAWBUF	1024
+ 
+ Bit8u MIDI_evt_len[256] = {
+@@ -54,23 +59,11 @@
+   0,2,3,2, 0,0,1,0, 1,0,1,1, 1,0,1,0   // 0xf0
+ };
+ 
+-class MidiHandler;
+-
+-MidiHandler * handler_list=0;
++MidiHandler * handler_list = 0;
+ 
+-class MidiHandler {
+-public:
+-	MidiHandler() {
+-		next=handler_list;
+-		handler_list=this;
+-	};
+-	virtual bool Open(const char * /*conf*/) { return true; };
+-	virtual void Close(void) {};
+-	virtual void PlayMsg(Bit8u * /*msg*/) {};
+-	virtual void PlaySysex(Bit8u * /*sysex*/,Bitu /*len*/) {};
+-	virtual const char * GetName(void) { return "none"; };
+-	virtual ~MidiHandler() { };
+-	MidiHandler * next;
++MidiHandler::MidiHandler(){
++	next = handler_list;
++	handler_list = this;
+ };
+ 
+ MidiHandler Midi_none;
+@@ -98,21 +91,14 @@
+ 
+ #endif
+ 
+-static struct {
+-	Bitu status;
+-	Bitu cmd_len;
+-	Bitu cmd_pos;
+-	Bit8u cmd_buf[8];
+-	Bit8u rt_buf[8];
+-	struct {
+-		Bit8u buf[SYSEX_SIZE];
+-		Bitu used;
+-	} sysex;
+-	bool available;
+-	MidiHandler * handler;
+-} midi;
++DB_Midi midi;
+ 
+ void MIDI_RawOutByte(Bit8u data) {
++	if (midi.sysex.start) {
++		Bit32u passed_ticks = GetTicks() - midi.sysex.start;
++		if (passed_ticks < midi.sysex.delay) SDL_Delay(midi.sysex.delay - passed_ticks);
++	}
++
+ 	/* Test for a realtime MIDI message */
+ 	if (data>=0xf8) {
+ 		midi.rt_buf[0]=data;
+@@ -122,11 +108,28 @@
+ 	/* Test for a active sysex tranfer */
+ 	if (midi.status==0xf0) {
+ 		if (!(data&0x80)) { 
+-			if (midi.sysex.used<(SYSEX_SIZE-1)) midi.sysex.buf[midi.sysex.used++]=data;
++			if (midi.sysex.used<(SYSEX_SIZE-1)) midi.sysex.buf[midi.sysex.used++] = data;
+ 			return;
+ 		} else {
+-			midi.sysex.buf[midi.sysex.used++]=0xf7;
+-			midi.handler->PlaySysex(midi.sysex.buf,midi.sysex.used);
++			midi.sysex.buf[midi.sysex.used++] = 0xf7;
++
++			if ((midi.sysex.start) && (midi.sysex.used >= 4) && (midi.sysex.used <= 9) && (midi.sysex.buf[1] == 0x41) && (midi.sysex.buf[3] == 0x16)) {
++				LOG(LOG_ALL,LOG_ERROR)("MIDI:Skipping invalid MT-32 SysEx midi message (too short to contain a checksum)");
++			} else {
++//				LOG(LOG_ALL,LOG_NORMAL)("Play sysex; address:%02X %02X %02X, length:%4d, delay:%3d", midi.sysex.buf[5], midi.sysex.buf[6], midi.sysex.buf[7], midi.sysex.used, midi.sysex.delay);
++				midi.handler->PlaySysex(midi.sysex.buf, midi.sysex.used);
++				if (midi.sysex.start) {
++					if (midi.sysex.buf[5] == 0x7F) {
++						midi.sysex.delay = 290; // All Parameters reset
++					} else if (midi.sysex.buf[5] == 0x10 && midi.sysex.buf[6] == 0x00 && midi.sysex.buf[7] == 0x04) {
++						midi.sysex.delay = 145; // Viking Child
++					} else if (midi.sysex.buf[5] == 0x10 && midi.sysex.buf[6] == 0x00 && midi.sysex.buf[7] == 0x01) {
++						midi.sysex.delay = 30; // Dark Sun 1
++					} else midi.sysex.delay = (Bitu)(((float)(midi.sysex.used) * 1.25f) * 1000.0f / 3125.0f) + 2;
++					midi.sysex.start = GetTicks();
++				}
++			}
++
+ 			LOG(LOG_ALL,LOG_NORMAL)("Sysex message size %d",midi.sysex.used);
+ 			if (CaptureState & CAPTURE_MIDI) {
+ 				CAPTURE_AddMidi( true, midi.sysex.used-1, &midi.sysex.buf[1]);
+@@ -163,10 +166,19 @@
+ 	MIDI(Section* configuration):Module_base(configuration){
+ 		Section_prop * section=static_cast<Section_prop *>(configuration);
+ 		const char * dev=section->Get_string("mididevice");
+-		const char * conf=section->Get_string("midiconfig");
++		std::string fullconf=section->Get_string("midiconfig");
+ 		/* If device = "default" go for first handler that works */
+ 		MidiHandler * handler;
+ //		MAPPER_AddHandler(MIDI_SaveRawEvent,MK_f8,MMOD1|MMOD2,"caprawmidi","Cap MIDI");
++		midi.sysex.delay = 0;
++		midi.sysex.start = 0;
++		if (fullconf.find("delaysysex") != std::string::npos) {
++			midi.sysex.start = GetTicks();
++			fullconf.erase(fullconf.find("delaysysex"));
++			LOG_MSG("MIDI:Using delayed SysEx processing");
++		}
++		std::remove(fullconf.begin(), fullconf.end(), ' ');
++		const char * conf = fullconf.c_str();
+ 		midi.status=0x00;
+ 		midi.cmd_pos=0;
+ 		midi.cmd_len=0;
+diff -Nur dosbox-0.74/src/gui/midi_oss.h dosbox/src/gui/midi_oss.h
+--- dosbox-0.74/src/gui/midi_oss.h	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/gui/midi_oss.h	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+diff -Nur dosbox-0.74/src/gui/midi_win32.h dosbox/src/gui/midi_win32.h
+--- dosbox-0.74/src/gui/midi_win32.h	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/gui/midi_win32.h	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,7 +16,6 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: midi_win32.h,v 1.16 2009-05-27 09:15:41 qbix79 Exp $ */
+ 
+ #ifndef WIN32_LEAN_AND_MEAN
+ #define WIN32_LEAN_AND_MEAN
+@@ -48,10 +47,10 @@
+ 				MIDIOUTCAPS mididev;
+ 				midiOutGetDevCaps(nummer, &mididev, sizeof(MIDIOUTCAPS));
+ 				LOG_MSG("MIDI:win32 selected %s",mididev.szPname);
+-				res = midiOutOpen(&m_out, nummer, (DWORD)m_event, 0, CALLBACK_EVENT);
++				res = midiOutOpen(&m_out, nummer, (DWORD_PTR)m_event, 0, CALLBACK_EVENT);
+ 			}
+ 		} else {
+-			res = midiOutOpen(&m_out, MIDI_MAPPER, (DWORD)m_event, 0, CALLBACK_EVENT);
++			res = midiOutOpen(&m_out, MIDI_MAPPER, (DWORD_PTR)m_event, 0, CALLBACK_EVENT);
+ 		}
+ 		if (res != MMSYSERR_NOERROR) return false;
+ 		isOpen=true;
+@@ -88,6 +87,14 @@
+ 			return;
+ 		}
+ 	}
++	void ListAll(Program* base) {
++		unsigned int total = midiOutGetNumDevs();	
++		for(unsigned int i = 0;i < total;i++) {
++			MIDIOUTCAPS mididev;
++			midiOutGetDevCaps(i, &mididev, sizeof(MIDIOUTCAPS));
++			base->WriteOut("%2d\t \"%s\"\n",i,mididev.szPname);
++		}
++	}
+ };
+ 
+ MidiHandler_win32 Midi_win32; 
+diff -Nur dosbox-0.74/src/gui/render.cpp dosbox/src/gui/render.cpp
+--- dosbox-0.74/src/gui/render.cpp	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/gui/render.cpp	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,7 +16,6 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: render.cpp,v 1.60 2009-04-26 19:14:50 harekiet Exp $ */
+ 
+ #include <sys/types.h>
+ #include <assert.h>
+diff -Nur dosbox-0.74/src/gui/render_loops.h dosbox/src/gui/render_loops.h
+--- dosbox-0.74/src/gui/render_loops.h	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/gui/render_loops.h	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+diff -Nur dosbox-0.74/src/gui/render_scalers.cpp dosbox/src/gui/render_scalers.cpp
+--- dosbox-0.74/src/gui/render_scalers.cpp	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/gui/render_scalers.cpp	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+diff -Nur dosbox-0.74/src/gui/render_scalers.h dosbox/src/gui/render_scalers.h
+--- dosbox-0.74/src/gui/render_scalers.h	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/gui/render_scalers.h	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+diff -Nur dosbox-0.74/src/gui/render_simple.h dosbox/src/gui/render_simple.h
+--- dosbox-0.74/src/gui/render_simple.h	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/gui/render_simple.h	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,7 +16,6 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: render_simple.h,v 1.7 2009-05-27 09:15:41 qbix79 Exp $ */
+ 
+ #if defined (SCALERLINEAR)
+ static void conc4d(SCALERNAME,SBPP,DBPP,L)(const void *s) {
+diff -Nur dosbox-0.74/src/gui/render_templates.h dosbox/src/gui/render_templates.h
+--- dosbox-0.74/src/gui/render_templates.h	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/gui/render_templates.h	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+diff -Nur dosbox-0.74/src/gui/render_templates_hq2x.h dosbox/src/gui/render_templates_hq2x.h
+--- dosbox-0.74/src/gui/render_templates_hq2x.h	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/gui/render_templates_hq2x.h	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+diff -Nur dosbox-0.74/src/gui/render_templates_hq3x.h dosbox/src/gui/render_templates_hq3x.h
+--- dosbox-0.74/src/gui/render_templates_hq3x.h	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/gui/render_templates_hq3x.h	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+diff -Nur dosbox-0.74/src/gui/render_templates_hq.h dosbox/src/gui/render_templates_hq.h
+--- dosbox-0.74/src/gui/render_templates_hq.h	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/gui/render_templates_hq.h	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+diff -Nur dosbox-0.74/src/gui/render_templates_sai.h dosbox/src/gui/render_templates_sai.h
+--- dosbox-0.74/src/gui/render_templates_sai.h	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/gui/render_templates_sai.h	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+diff -Nur dosbox-0.74/src/gui/sdl_gui.cpp dosbox/src/gui/sdl_gui.cpp
+--- dosbox-0.74/src/gui/sdl_gui.cpp	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/gui/sdl_gui.cpp	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,7 +16,6 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: sdl_gui.cpp,v 1.11 2009-02-25 19:58:11 c2woody Exp $ */
+ 
+ #if 0
+ #include "SDL.h"
+@@ -40,7 +39,7 @@
+ 
+ extern Bit8u int10_font_14[256 * 14];
+ extern Program * first_shell;
+-extern void MSG_Write(const char *);
++extern bool MSG_Write(const char *);
+ extern void GFX_SetTitle(Bit32s cycles, Bits frameskip, bool paused);
+ 
+ static int cursor, saved_bpp;
+@@ -570,7 +569,7 @@
+ 			Section_prop *section = static_cast<Section_prop *>(sec);
+ 			new SectionEditor(getScreen(), 50, 30, section);
+ 		} else if (arg == "About") {
+-			new GUI::MessageBox(getScreen(), 200, 150, 280, "About DOSBox", "\nDOSBox 0.72\nAn emulator for old DOS Games\n\nCopyright 2002-2009\nThe DOSBox Team");
++			new GUI::MessageBox(getScreen(), 200, 150, 280, "About DOSBox", "\nDOSBox 0.74\nAn emulator for old DOS Games\n\nCopyright 2002-2013\nThe DOSBox Team");
+ 		} else if (arg == "Introduction") {
+ 			new GUI::MessageBox(getScreen(), 20, 50, 600, "Introduction", MSG_Get("PROGRAM_INTRO"));
+ 		} else if (arg == "Getting Started") {
+diff -Nur dosbox-0.74/src/gui/sdlmain.cpp dosbox/src/gui/sdlmain.cpp
+--- dosbox-0.74/src/gui/sdlmain.cpp	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/gui/sdlmain.cpp	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,7 +16,6 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: sdlmain.cpp,v 1.154 2009-06-01 10:25:51 qbix79 Exp $ */
+ 
+ #ifndef _GNU_SOURCE
+ #define _GNU_SOURCE
+@@ -64,34 +63,30 @@
+ #define APIENTRYP APIENTRY *
+ #endif
+ 
+-#ifdef __WIN32__
+-#define NVIDIA_PixelDataRange 1
+-
+-#ifndef WGL_NV_allocate_memory
+-#define WGL_NV_allocate_memory 1
+-typedef void * (APIENTRY * PFNWGLALLOCATEMEMORYNVPROC) (int size, float readfreq, float writefreq, float priority);
+-typedef void (APIENTRY * PFNWGLFREEMEMORYNVPROC) (void *pointer);
+-#endif
+-
+-PFNWGLALLOCATEMEMORYNVPROC db_glAllocateMemoryNV = NULL;
+-PFNWGLFREEMEMORYNVPROC db_glFreeMemoryNV = NULL;
+-
+-#else
+-
+-#endif
+-
+-#if defined(NVIDIA_PixelDataRange)
+-
+-#ifndef GL_NV_pixel_data_range
+-#define GL_NV_pixel_data_range 1
+-#define GL_WRITE_PIXEL_DATA_RANGE_NV      0x8878
+-typedef void (APIENTRYP PFNGLPIXELDATARANGENVPROC) (GLenum target, GLsizei length, GLvoid *pointer);
+-typedef void (APIENTRYP PFNGLFLUSHPIXELDATARANGENVPROC) (GLenum target);
+-#endif
+-
+-PFNGLPIXELDATARANGENVPROC glPixelDataRangeNV = NULL;
+-
+-#endif
++#ifndef GL_ARB_pixel_buffer_object
++#define GL_ARB_pixel_buffer_object 1
++#define GL_PIXEL_PACK_BUFFER_ARB           0x88EB
++#define GL_PIXEL_UNPACK_BUFFER_ARB         0x88EC
++#define GL_PIXEL_PACK_BUFFER_BINDING_ARB   0x88ED
++#define GL_PIXEL_UNPACK_BUFFER_BINDING_ARB 0x88EF
++#endif
++
++#ifndef GL_ARB_vertex_buffer_object
++#define GL_ARB_vertex_buffer_object 1
++typedef void (APIENTRYP PFNGLGENBUFFERSARBPROC) (GLsizei n, GLuint *buffers);
++typedef void (APIENTRYP PFNGLBINDBUFFERARBPROC) (GLenum target, GLuint buffer);
++typedef void (APIENTRYP PFNGLDELETEBUFFERSARBPROC) (GLsizei n, const GLuint *buffers);
++typedef void (APIENTRYP PFNGLBUFFERDATAARBPROC) (GLenum target, GLsizeiptr size, const GLvoid *data, GLenum usage);
++typedef GLvoid* (APIENTRYP PFNGLMAPBUFFERARBPROC) (GLenum target, GLenum access);
++typedef GLboolean (APIENTRYP PFNGLUNMAPBUFFERARBPROC) (GLenum target);
++#endif
++
++PFNGLGENBUFFERSARBPROC glGenBuffersARB = NULL;
++PFNGLBINDBUFFERARBPROC glBindBufferARB = NULL;
++PFNGLDELETEBUFFERSARBPROC glDeleteBuffersARB = NULL;
++PFNGLBUFFERDATAARBPROC glBufferDataARB = NULL;
++PFNGLMAPBUFFERARBPROC glMapBufferARB = NULL;
++PFNGLUNMAPBUFFERARBPROC glUnmapBufferARB = NULL;
+ 
+ #endif //C_OPENGL
+ 
+@@ -172,6 +167,8 @@
+ 		} window;
+ 		Bit8u bpp;
+ 		bool fullscreen;
++		bool lazy_fullscreen;
++		bool lazy_fullscreen_req;
+ 		bool doublebuf;
+ 		SCREEN_TYPES type;
+ 		SCREEN_TYPES want_type;
+@@ -180,15 +177,14 @@
+ 	struct {
+ 		Bitu pitch;
+ 		void * framebuf;
++		GLuint buffer;
+ 		GLuint texture;
+ 		GLuint displaylist;
+ 		GLint max_texsize;
+ 		bool bilinear;
+ 		bool packed_pixel;
+ 		bool paletted_texture;
+-#if defined(NVIDIA_PixelDataRange)
+-		bool pixel_data_range;
+-#endif
++		bool pixel_buffer_object;
+ 	} opengl;
+ #endif
+ 	struct {
+@@ -229,22 +225,47 @@
+ //Globals for keyboard initialisation
+ bool startup_state_numlock=false;
+ bool startup_state_capslock=false;
++
+ void GFX_SetTitle(Bit32s cycles,Bits frameskip,bool paused){
+ 	char title[200]={0};
+ 	static Bit32s internal_cycles=0;
+-	static Bits internal_frameskip=0;
++	static Bit32s internal_frameskip=0;
+ 	if(cycles != -1) internal_cycles = cycles;
+ 	if(frameskip != -1) internal_frameskip = frameskip;
+ 	if(CPU_CycleAutoAdjust) {
+-		sprintf(title,"DOSBox %s, Cpu speed: max %3d%% cycles, Frameskip %2d, Program: %8s",VERSION,internal_cycles,internal_frameskip,RunningProgram);
++		sprintf(title,"DOSBox %s, CPU speed: max %3d%% cycles, Frameskip %2d, Program: %8s",VERSION,internal_cycles,internal_frameskip,RunningProgram);
+ 	} else {
+-		sprintf(title,"DOSBox %s, Cpu speed: %8d cycles, Frameskip %2d, Program: %8s",VERSION,internal_cycles,internal_frameskip,RunningProgram);
++		sprintf(title,"DOSBox %s, CPU speed: %8d cycles, Frameskip %2d, Program: %8s",VERSION,internal_cycles,internal_frameskip,RunningProgram);
+ 	}
+ 
+ 	if(paused) strcat(title," PAUSED");
+ 	SDL_WM_SetCaption(title,VERSION);
+ }
+ 
++static unsigned char logo[32*32*4]= {
++#include "dosbox_logo.h"
++};
++static void GFX_SetIcon() {
++#if !defined(MACOSX)
++	/* Set Icon (must be done before any sdl_setvideomode call) */
++	/* But don't set it on OS X, as we use a nicer external icon there. */
++	/* Made into a separate call, so it can be called again when we restart the graphics output on win32 */
++#if WORDS_BIGENDIAN
++	SDL_Surface* logos= SDL_CreateRGBSurfaceFrom((void*)logo,32,32,32,128,0xff000000,0x00ff0000,0x0000ff00,0);
++#else
++	SDL_Surface* logos= SDL_CreateRGBSurfaceFrom((void*)logo,32,32,32,128,0x000000ff,0x0000ff00,0x00ff0000,0);
++#endif
++	SDL_WM_SetIcon(logos,NULL);
++#endif
++}
++
++
++static void KillSwitch(bool pressed) {
++	if (!pressed)
++		return;
++	throw 1;
++}
++
+ static void PauseDOSBox(bool pressed) {
+ 	if (!pressed)
+ 		return;
+@@ -261,15 +282,22 @@
+ 		SDL_WaitEvent(&event);    // since we're not polling, cpu usage drops to 0.
+ 		switch (event.type) {
+ 
+-			case SDL_QUIT: throw(0); break;
++			case SDL_QUIT: KillSwitch(true); break;
+ 			case SDL_KEYDOWN:   // Must use Pause/Break Key to resume.
+ 			case SDL_KEYUP:
+-			if(event.key.keysym.sym==SDLK_PAUSE) {
++			if(event.key.keysym.sym == SDLK_PAUSE) {
+ 
+-				paused=false;
++				paused = false;
+ 				GFX_SetTitle(-1,-1,false);
+ 				break;
+ 			}
++#if defined (MACOSX)
++			if (event.key.keysym.sym == SDLK_q && (event.key.keysym.mod == KMOD_RMETA || event.key.keysym.mod == KMOD_LMETA) ) {
++				/* On macs, all aps exit when pressing cmd-q */
++				KillSwitch(true);
++				break;
++			} 
++#endif
+ 		}
+ 	}
+ }
+@@ -354,6 +382,16 @@
+ 	CPU_Reset_AutoAdjust();
+ }
+ 
++void GFX_ForceFullscreenExit(void) {
++	if (sdl.desktop.lazy_fullscreen) {
++//		sdl.desktop.lazy_fullscreen_req=true;
++		LOG_MSG("GFX LF: invalid screen change");
++	} else {
++		sdl.desktop.fullscreen=false;
++		GFX_ResetScreen();
++	}
++}
++
+ static int int_log2 (int val) {
+     int log = 0;
+     while ((val >>= 1) != 0)
+@@ -406,6 +444,16 @@
+ 	}
+ }
+ 
++void GFX_TearDown(void) {
++	if (sdl.updating)
++		GFX_EndUpdate( 0 );
++
++	if (sdl.blit.surface) {
++		SDL_FreeSurface(sdl.blit.surface);
++		sdl.blit.surface=0;
++	}
++}
++
+ Bitu GFX_SetSize(Bitu width,Bitu height,Bitu flags,double scalex,double scaley,GFX_CallBack_t callback) {
+ 	if (sdl.updating)
+ 		GFX_EndUpdate( 0 );
+@@ -416,7 +464,7 @@
+ 	sdl.draw.scalex=scalex;
+ 	sdl.draw.scaley=scaley;
+ 
+-	Bitu bpp=0;
++	int bpp=0;
+ 	Bitu retFlags = 0;
+ 
+ 	if (sdl.blit.surface) {
+@@ -447,7 +495,7 @@
+ 					SDL_FULLSCREEN | ((flags & GFX_CAN_RANDOM) ? SDL_SWSURFACE : SDL_HWSURFACE) |
+ 					(sdl.desktop.doublebuf ? SDL_DOUBLEBUF|SDL_ASYNCBLIT  : 0)|SDL_HWPALETTE);
+ 				if (sdl.surface == NULL)
+-					E_Exit("Could not set fullscreen video mode %ix%i-%i: %s",width,height,bpp,SDL_GetError());
++					E_Exit("Could not set fullscreen video mode %ix%i-%i: %s",(int)width,(int)height,bpp,SDL_GetError());
+ 			}
+ 		} else {
+ 			sdl.clip.x=0;sdl.clip.y=0;
+@@ -465,11 +513,13 @@
+ 					sdl.using_windib=false;
+ 				}
+ 				SDL_InitSubSystem(SDL_INIT_VIDEO);
++				GFX_SetIcon(); //Set Icon again
+ 				sdl.surface = SDL_SetVideoMode(width,height,bpp,SDL_HWSURFACE);
++				if(sdl.surface) GFX_SetTitle(-1,-1,false); //refresh title.
+ 			}
+ #endif
+ 			if (sdl.surface == NULL)
+-				E_Exit("Could not set windowed video mode %ix%i-%i: %s",width,height,bpp,SDL_GetError());
++				E_Exit("Could not set windowed video mode %ix%i-%i: %s",(int)width,(int)height,bpp,SDL_GetError());
+ 		}
+ 		if (sdl.surface) {
+ 			switch (sdl.surface->format->BitsPerPixel) {
+@@ -556,11 +606,10 @@
+ #if C_OPENGL
+ 	case SCREEN_OPENGL:
+ 	{
+-		if (sdl.opengl.framebuf) {
+-#if defined(NVIDIA_PixelDataRange)
+-			if (sdl.opengl.pixel_data_range) db_glFreeMemoryNV(sdl.opengl.framebuf);
+-			else
+-#endif
++		if (sdl.opengl.pixel_buffer_object) {
++			glBindBufferARB(GL_PIXEL_UNPACK_BUFFER_EXT, 0);
++			if (sdl.opengl.buffer) glDeleteBuffersARB(1, &sdl.opengl.buffer);
++		} else if (sdl.opengl.framebuf) {
+ 			free(sdl.opengl.framebuf);
+ 		}
+ 		sdl.opengl.framebuf=0;
+@@ -580,15 +629,12 @@
+ 			goto dosurface;
+ 		}
+ 		/* Create the texture and display list */
+-#if defined(NVIDIA_PixelDataRange)
+-		if (sdl.opengl.pixel_data_range) {
+-			sdl.opengl.framebuf=db_glAllocateMemoryNV(width*height*4,0.0,1.0,1.0);
+-			glPixelDataRangeNV(GL_WRITE_PIXEL_DATA_RANGE_NV,width*height*4,sdl.opengl.framebuf);
+-			glEnableClientState(GL_WRITE_PIXEL_DATA_RANGE_NV);
++		if (sdl.opengl.pixel_buffer_object) {
++			glGenBuffersARB(1, &sdl.opengl.buffer);
++			glBindBufferARB(GL_PIXEL_UNPACK_BUFFER_EXT, sdl.opengl.buffer);
++			glBufferDataARB(GL_PIXEL_UNPACK_BUFFER_EXT, width*height*4, NULL, GL_STREAM_DRAW_ARB);
++			glBindBufferARB(GL_PIXEL_UNPACK_BUFFER_EXT, 0);
+ 		} else {
+-#else
+-		{
+-#endif
+ 			sdl.opengl.framebuf=malloc(width*height*4);		//32 bit color
+ 		}
+ 		sdl.opengl.pitch=width*4;
+@@ -642,10 +688,8 @@
+ 		glEndList();
+ 		sdl.desktop.type=SCREEN_OPENGL;
+ 		retFlags = GFX_CAN_32 | GFX_SCALING;
+-#if defined(NVIDIA_PixelDataRange)
+-		if (sdl.opengl.pixel_data_range)
++		if (sdl.opengl.pixel_buffer_object)
+ 			retFlags |= GFX_HARDWARE;
+-#endif
+ 	break;
+ 		}//OPENGL
+ #endif	//C_OPENGL
+@@ -671,6 +715,18 @@
+         mouselocked=sdl.mouse.locked;
+ }
+ 
++void GFX_UpdateSDLCaptureState(void) {
++	if (sdl.mouse.locked) {
++		SDL_WM_GrabInput(SDL_GRAB_ON);
++		SDL_ShowCursor(SDL_DISABLE);
++	} else {
++		SDL_WM_GrabInput(SDL_GRAB_OFF);
++		if (sdl.mouse.autoenable || !sdl.mouse.autolock) SDL_ShowCursor(SDL_ENABLE);
++	}
++	CPU_Reset_AutoAdjust();
++	GFX_SetTitle(-1,-1,false);
++}
++
+ bool mouselocked; //Global variable for mapper
+ static void CaptureMouse(bool pressed) {
+ 	if (!pressed)
+@@ -678,12 +734,40 @@
+ 	GFX_CaptureMouse();
+ }
+ 
++#if defined (WIN32)
++STICKYKEYS stick_keys = {sizeof(STICKYKEYS), 0};
++void sticky_keys(bool restore){
++	static bool inited = false;
++	if (!inited){
++		inited = true;
++		SystemParametersInfo(SPI_GETSTICKYKEYS, sizeof(STICKYKEYS), &stick_keys, 0);
++	} 
++	if (restore) {
++		SystemParametersInfo(SPI_SETSTICKYKEYS, sizeof(STICKYKEYS), &stick_keys, 0);
++		return;
++	}
++	//Get current sticky keys layout:
++	STICKYKEYS s = {sizeof(STICKYKEYS), 0};
++	SystemParametersInfo(SPI_GETSTICKYKEYS, sizeof(STICKYKEYS), &s, 0);
++	if ( !(s.dwFlags & SKF_STICKYKEYSON)) { //Not on already
++		s.dwFlags &= ~SKF_HOTKEYACTIVE;
++		SystemParametersInfo(SPI_SETSTICKYKEYS, sizeof(STICKYKEYS), &s, 0);
++	}
++}
++#endif
++
+ void GFX_SwitchFullScreen(void) {
+ 	sdl.desktop.fullscreen=!sdl.desktop.fullscreen;
+ 	if (sdl.desktop.fullscreen) {
+ 		if (!sdl.mouse.locked) GFX_CaptureMouse();
++#if defined (WIN32)
++		sticky_keys(false); //disable sticky keys in fullscreen mode
++#endif
+ 	} else {
+ 		if (sdl.mouse.locked) GFX_CaptureMouse();
++#if defined (WIN32)		
++		sticky_keys(true); //restore sticky keys to default state in windowed mode.
++#endif
+ 	}
+ 	GFX_ResetScreen();
+ }
+@@ -691,7 +775,32 @@
+ static void SwitchFullScreen(bool pressed) {
+ 	if (!pressed)
+ 		return;
+-	GFX_SwitchFullScreen();
++
++	if (sdl.desktop.lazy_fullscreen) {
++//		sdl.desktop.lazy_fullscreen_req=true;
++		LOG_MSG("GFX LF: fullscreen switching not supported");
++	} else {
++		GFX_SwitchFullScreen();
++	}
++}
++
++void GFX_SwitchLazyFullscreen(bool lazy) {
++	sdl.desktop.lazy_fullscreen=lazy;
++	sdl.desktop.lazy_fullscreen_req=false;
++}
++
++void GFX_SwitchFullscreenNoReset(void) {
++	sdl.desktop.fullscreen=!sdl.desktop.fullscreen;
++}
++
++bool GFX_LazyFullscreenRequested(void) {
++	if (sdl.desktop.lazy_fullscreen) return sdl.desktop.lazy_fullscreen_req;
++	return false;
++}
++
++void GFX_RestoreMode(void) {
++	GFX_SetSize(sdl.draw.width,sdl.draw.height,sdl.draw.flags,sdl.draw.scalex,sdl.draw.scaley,sdl.draw.callback);
++	GFX_UpdateSDLCaptureState();
+ }
+ 
+ 
+@@ -727,14 +836,18 @@
+ 		return true;
+ #endif
+ 	case SCREEN_OVERLAY:
+-		SDL_LockYUVOverlay(sdl.overlay);
++		if (SDL_LockYUVOverlay(sdl.overlay)) return false;
+ 		pixels=(Bit8u *)*(sdl.overlay->pixels);
+ 		pitch=*(sdl.overlay->pitches);
+ 		sdl.updating=true;
+ 		return true;
+ #if C_OPENGL
+ 	case SCREEN_OPENGL:
+-		pixels=(Bit8u *)sdl.opengl.framebuf;
++		if(sdl.opengl.pixel_buffer_object) {
++		    glBindBufferARB(GL_PIXEL_UNPACK_BUFFER_EXT, sdl.opengl.buffer);
++		    pixels=(Bit8u *)glMapBufferARB(GL_PIXEL_UNPACK_BUFFER_EXT, GL_WRITE_ONLY);
++		} else
++		    pixels=(Bit8u *)sdl.opengl.framebuf;
+ 		pitch=sdl.opengl.pitch;
+ 		sdl.updating=true;
+ 		return true;
+@@ -814,19 +927,18 @@
+ 		break;
+ #if C_OPENGL
+ 	case SCREEN_OPENGL:
+-#if defined(NVIDIA_PixelDataRange)
+-		if (sdl.opengl.pixel_data_range) {
+-            glBindTexture(GL_TEXTURE_2D, sdl.opengl.texture);
++		if (sdl.opengl.pixel_buffer_object) {
++			glUnmapBufferARB(GL_PIXEL_UNPACK_BUFFER_EXT);
++			glBindTexture(GL_TEXTURE_2D, sdl.opengl.texture);
+ 			glTexSubImage2D(GL_TEXTURE_2D, 0, 0, 0,
+ 					sdl.draw.width, sdl.draw.height, GL_BGRA_EXT,
+-					GL_UNSIGNED_INT_8_8_8_8_REV, sdl.opengl.framebuf);
++					GL_UNSIGNED_INT_8_8_8_8_REV, 0);
++			glBindBufferARB(GL_PIXEL_UNPACK_BUFFER_EXT, 0);
+ 			glCallList(sdl.opengl.displaylist);
+ 			SDL_GL_SwapBuffers();
+-		} else
+-#endif
+-		if (changedLines) {
++		} else if (changedLines) {
+ 			Bitu y = 0, index = 0;
+-            glBindTexture(GL_TEXTURE_2D, sdl.opengl.texture);
++			glBindTexture(GL_TEXTURE_2D, sdl.opengl.texture);
+ 			while (y < sdl.draw.height) {
+ 				if (!(index & 1)) {
+ 					y += changedLines[index];
+@@ -905,11 +1017,6 @@
+ 	if (sdl.desktop.fullscreen) GFX_SwitchFullScreen();
+ }
+ 
+-static void KillSwitch(bool pressed) {
+-	if (!pressed)
+-		return;
+-	throw 1;
+-}
+ 
+ static void SetPriority(PRIORITY_LEVELS level) {
+ 
+@@ -983,28 +1090,21 @@
+ 	}
+ }
+ 
+-static unsigned char logo[32*32*4]= {
+-#include "dosbox_logo.h"
+-};
+ #include "dosbox_splash.h"
+ 
+ //extern void UI_Run(bool);
++void Restart(bool pressed);
++
+ static void GUI_StartUp(Section * sec) {
+ 	sec->AddDestroyFunction(&GUI_ShutDown);
+ 	Section_prop * section=static_cast<Section_prop *>(sec);
+ 	sdl.active=false;
+ 	sdl.updating=false;
+ 
+-#if !defined(MACOSX)
+-	/* Set Icon (must be done before any sdl_setvideomode call) */
+-	/* But don't set it on OS X, as we use a nicer external icon there. */
+-#if WORDS_BIGENDIAN
+-	SDL_Surface* logos= SDL_CreateRGBSurfaceFrom((void*)logo,32,32,32,128,0xff000000,0x00ff0000,0x0000ff00,0);
+-#else
+-	SDL_Surface* logos= SDL_CreateRGBSurfaceFrom((void*)logo,32,32,32,128,0x000000ff,0x0000ff00,0x00ff0000,0);
+-#endif
+-	SDL_WM_SetIcon(logos,NULL);
+-#endif
++	GFX_SetIcon();
++
++	sdl.desktop.lazy_fullscreen=false;
++	sdl.desktop.lazy_fullscreen_req=false;
+ 
+ 	sdl.desktop.fullscreen=section->Get_bool("fullscreen");
+ 	sdl.wait_on_error=section->Get_bool("waitonerror");
+@@ -1043,13 +1143,15 @@
+ 		char res[100];
+ 		strncpy( res, fullresolution, sizeof( res ));
+ 		fullresolution = lowcase (res);//so x and X are allowed
+-		if(strcmp(fullresolution,"original")) {
++		if (strcmp(fullresolution,"original")) {
+ 			sdl.desktop.full.fixed = true;
+-			char* height = const_cast<char*>(strchr(fullresolution,'x'));
+-			if(height && * height) {
+-				*height = 0;
+-				sdl.desktop.full.height = (Bit16u)atoi(height+1);
+-				sdl.desktop.full.width  = (Bit16u)atoi(res);
++			if (strcmp(fullresolution,"desktop")) { //desktop = 0x0
++				char* height = const_cast<char*>(strchr(fullresolution,'x'));
++				if (height && * height) {
++					*height = 0;
++					sdl.desktop.full.height = (Bit16u)atoi(height+1);
++					sdl.desktop.full.width  = (Bit16u)atoi(res);
++				}
+ 			}
+ 		}
+ 	}
+@@ -1071,10 +1173,22 @@
+ 		}
+ 	}
+ 	sdl.desktop.doublebuf=section->Get_bool("fulldouble");
++#if SDL_VERSION_ATLEAST(1, 2, 10)
++	if (!sdl.desktop.full.width || !sdl.desktop.full.height){
++		//Can only be done on the very first call! Not restartable.
++		const SDL_VideoInfo* vidinfo = SDL_GetVideoInfo();
++		if (vidinfo) {
++			sdl.desktop.full.width = vidinfo->current_w;
++			sdl.desktop.full.height = vidinfo->current_h;
++		}
++	}
++#endif
++
+ 	if (!sdl.desktop.full.width) {
+ #ifdef WIN32
+ 		sdl.desktop.full.width=(Bit16u)GetSystemMetrics(SM_CXSCREEN);
+ #else
++		LOG_MSG("Your fullscreen resolution can NOT be determined, it's assumed to be 1024x768.\nPlease edit the configuration file if this value is wrong.");
+ 		sdl.desktop.full.width=1024;
+ #endif
+ 	}
+@@ -1123,24 +1237,24 @@
+ 		LOG_MSG("Could not initialize OpenGL, switching back to surface");
+ 		sdl.desktop.want_type=SCREEN_SURFACE;
+ 	} else {
++	sdl.opengl.buffer=0;
+ 	sdl.opengl.framebuf=0;
+ 	sdl.opengl.texture=0;
+ 	sdl.opengl.displaylist=0;
+ 	glGetIntegerv (GL_MAX_TEXTURE_SIZE, &sdl.opengl.max_texsize);
+-#if defined(__WIN32__) && defined(NVIDIA_PixelDataRange)
+-	glPixelDataRangeNV = (PFNGLPIXELDATARANGENVPROC) wglGetProcAddress("glPixelDataRangeNV");
+-	db_glAllocateMemoryNV = (PFNWGLALLOCATEMEMORYNVPROC) wglGetProcAddress("wglAllocateMemoryNV");
+-	db_glFreeMemoryNV = (PFNWGLFREEMEMORYNVPROC) wglGetProcAddress("wglFreeMemoryNV");
+-#endif
++	glGenBuffersARB = (PFNGLGENBUFFERSARBPROC)SDL_GL_GetProcAddress("glGenBuffersARB");
++	glBindBufferARB = (PFNGLBINDBUFFERARBPROC)SDL_GL_GetProcAddress("glBindBufferARB");
++	glDeleteBuffersARB = (PFNGLDELETEBUFFERSARBPROC)SDL_GL_GetProcAddress("glDeleteBuffersARB");
++	glBufferDataARB = (PFNGLBUFFERDATAARBPROC)SDL_GL_GetProcAddress("glBufferDataARB");
++	glMapBufferARB = (PFNGLMAPBUFFERARBPROC)SDL_GL_GetProcAddress("glMapBufferARB");
++	glUnmapBufferARB = (PFNGLUNMAPBUFFERARBPROC)SDL_GL_GetProcAddress("glUnmapBufferARB");
+ 	const char * gl_ext = (const char *)glGetString (GL_EXTENSIONS);
+ 	if(gl_ext && *gl_ext){
+ 		sdl.opengl.packed_pixel=(strstr(gl_ext,"EXT_packed_pixels") > 0);
+ 		sdl.opengl.paletted_texture=(strstr(gl_ext,"EXT_paletted_texture") > 0);
+-#if defined(NVIDIA_PixelDataRange)
+-		sdl.opengl.pixel_data_range=(strstr(gl_ext,"GL_NV_pixel_data_range") >0 ) &&
+-			glPixelDataRangeNV && db_glAllocateMemoryNV && db_glFreeMemoryNV;
+-		sdl.opengl.pixel_data_range = 0;
+-#endif
++		sdl.opengl.pixel_buffer_object=(strstr(gl_ext,"GL_ARB_pixel_buffer_object") >0 ) &&
++		    glGenBuffersARB && glBindBufferARB && glDeleteBuffersARB && glBufferDataARB &&
++		    glMapBufferARB && glUnmapBufferARB;
+     	} else {
+ 		sdl.opengl.packed_pixel=sdl.opengl.paletted_texture=false;
+ 	}
+@@ -1234,6 +1348,7 @@
+ 	MAPPER_AddHandler(KillSwitch,MK_f9,MMOD1,"shutdown","ShutDown");
+ 	MAPPER_AddHandler(CaptureMouse,MK_f10,MMOD1,"capmouse","Cap Mouse");
+ 	MAPPER_AddHandler(SwitchFullScreen,MK_return,MMOD2,"fullscr","Fullscreen");
++	MAPPER_AddHandler(Restart,MK_home,MMOD1|MMOD2,"restart","Restart");
+ #if C_DEBUG
+ 	/* Pause binds with activate-debugger */
+ #else
+@@ -1309,6 +1424,10 @@
+ 	MAPPER_LosingFocus();
+ }
+ 
++bool GFX_IsFullscreen(void) {
++	return sdl.desktop.fullscreen;
++}
++
+ void GFX_Events() {
+ 	SDL_Event event;
+ #if defined (REDUCE_JOYSTICK_POLLING)
+@@ -1334,8 +1453,7 @@
+ #ifdef WIN32
+ 						if (sdl.desktop.fullscreen) {
+ 							VGA_KillDrawing();
+-							sdl.desktop.fullscreen=false;
+-							GFX_ResetScreen();
++							GFX_ForceFullscreenExit();
+ 						}
+ #endif
+ 						GFX_CaptureMouse();
+@@ -1418,6 +1536,15 @@
+ 			if (((event.key.keysym.sym==SDLK_TAB)) &&
+ 				((sdl.laltstate==SDL_KEYDOWN) || (sdl.raltstate==SDL_KEYDOWN))) break;
+ #endif
++#if defined (MACOSX)			
++		case SDL_KEYDOWN:
++		case SDL_KEYUP:
++			/* On macs CMD-Q is the default key to close an application */
++			if (event.key.keysym.sym == SDLK_q && (event.key.keysym.mod == KMOD_RMETA || event.key.keysym.mod == KMOD_LMETA) ) {
++				KillSwitch(true);
++				break;
++			} 
++#endif
+ 		default:
+ 			void MAPPER_CheckEvent(SDL_Event * event);
+ 			MAPPER_CheckEvent(&event);
+@@ -1471,7 +1598,7 @@
+ 	Pbool->Set_help("Use double buffering in fullscreen. It can reduce screen flickering, but it can also result in a slow DOSBox.");
+ 
+ 	Pstring = sdl_sec->Add_string("fullresolution",Property::Changeable::Always,"original");
+-	Pstring->Set_help("What resolution to use for fullscreen: original or fixed size (e.g. 1024x768).\n"
++	Pstring->Set_help("What resolution to use for fullscreen: original, desktop or a fixed size (e.g. 1024x768).\n"
+ 	                  "  Using your monitor's native resolution with aspect=true might give the best results.\n"
+ 			  "  If you end up with small window on a large screen, try an output different from surface.");
+ 
+@@ -1516,7 +1643,7 @@
+ 	Pstring->Set_values(inactt);
+ 
+ 	Pstring = sdl_sec->Add_path("mapperfile",Property::Changeable::Always,MAPPERFILE);
+-	Pstring->Set_help("File used to load/save the key/event mappings from. Resetmapper only works with the defaul value.");
++	Pstring->Set_help("File used to load/save the key/event mappings from. Resetmapper only works with the default value.");
+ 
+ 	Pbool = sdl_sec->Add_bool("usescancodes",Property::Changeable::Always,true);
+ 	Pbool->Set_help("Avoid usage of symkeys, might not work on all operating systems.");
+@@ -1529,7 +1656,7 @@
+ 	if ( !sdl.inited && SDL_Init(SDL_INIT_VIDEO|SDL_INIT_NOPARACHUTE) < 0 ) textonly = true;
+ 	sdl.inited = true;
+ #endif
+-	printf(message);
++	printf("%s",message);
+ 	if(textonly) return;
+ 	if(!sdl.surface) sdl.surface = SDL_SetVideoMode(640,400,0,0);
+ 	if(!sdl.surface) return;
+@@ -1586,6 +1713,32 @@
+ 	printf("can't find editor(s) specified at the command line.\n");
+ 	exit(1);
+ }
++#if C_DEBUG
++extern void DEBUG_ShutDown(Section * /*sec*/);
++#endif
++
++void restart_program(std::vector<std::string> & parameters) {
++	char** newargs = new char* [parameters.size()+1];
++	// parameter 0 is the executable path
++	// contents of the vector follow
++	// last one is NULL
++	for(Bitu i = 0; i < parameters.size(); i++) newargs[i]=(char*)parameters[i].c_str();
++	newargs[parameters.size()] = NULL;
++	SDL_CloseAudio();
++	SDL_Delay(50);
++	SDL_Quit();
++#if C_DEBUG
++	// shutdown curses
++	DEBUG_ShutDown(NULL);
++#endif
++
++	execvp(newargs[0], newargs);
++	free(newargs);
++}
++void Restart(bool pressed) { // mapper handler
++	restart_program(control->startup_params);
++}
++
+ static void launchcaptures(std::string const& edit) {
+ 	std::string path,file;
+ 	Section* t = control->GetSection("dosbox");
+@@ -1665,7 +1818,6 @@
+ }
+ 
+ 
+-
+ //extern void UI_Init(void);
+ int main(int argc, char* argv[]) {
+ 	try {
+@@ -1683,7 +1835,7 @@
+ 		if(control->cmdline->FindExist("-resetconf")) eraseconfigfile();
+ 		if(control->cmdline->FindExist("-erasemapper")) erasemapperfile();
+ 		if(control->cmdline->FindExist("-resetmapper")) erasemapperfile();
+-
++		
+ 		/* Can't disable the console with debugger enabled */
+ #if defined(WIN32) && !(C_DEBUG)
+ 		if (control->cmdline->FindExist("-noconsole")) {
+@@ -1708,7 +1860,7 @@
+ #endif  //defined(WIN32) && !(C_DEBUG)
+ 		if (control->cmdline->FindExist("-version") ||
+ 		    control->cmdline->FindExist("--version") ) {
+-			printf("\nDOSBox version %s, copyright 2002-2010 DOSBox Team.\n\n",VERSION);
++			printf("\nDOSBox version %s, copyright 2002-2013 DOSBox Team.\n\n",VERSION);
+ 			printf("DOSBox is written by the DOSBox Team (See AUTHORS file))\n");
+ 			printf("DOSBox comes with ABSOLUTELY NO WARRANTY.  This is free software,\n");
+ 			printf("and you are welcome to redistribute it under certain conditions;\n");
+@@ -1736,11 +1888,15 @@
+ 
+ 	/* Display Welcometext in the console */
+ 	LOG_MSG("DOSBox version %s",VERSION);
+-	LOG_MSG("Copyright 2002-2010 DOSBox Team, published under GNU GPL.");
++	LOG_MSG("Copyright 2002-2013 DOSBox Team, published under GNU GPL.");
+ 	LOG_MSG("---");
+ 
+ 	/* Init SDL */
+ #if SDL_VERSION_ATLEAST(1, 2, 14)
++	/* Or debian/ubuntu with older libsdl version as they have done this themselves, but then differently.
++	 * with this variable they will work correctly. I've only tested the 1.2.14 behaviour against the windows version
++	 * of libsdl
++	 */
+ 	putenv(const_cast<char*>("SDL_DISABLE_LOCK_KEYS=1"));
+ #endif
+ 	if ( SDL_Init( SDL_INIT_AUDIO|SDL_INIT_VIDEO|SDL_INIT_TIMER|SDL_INIT_CDROM
+@@ -1790,15 +1946,16 @@
+ 
+ 	/* Parse configuration files */
+ 	std::string config_file,config_path;
+-	bool parsed_anyconfigfile = false;
+-	//First Parse -userconf
++	Cross::GetPlatformConfigDir(config_path);
++	
++	//First parse -userconf
+ 	if(control->cmdline->FindExist("-userconf",true)){
+ 		config_file.clear();
+ 		Cross::GetPlatformConfigDir(config_path);
+ 		Cross::GetPlatformConfigName(config_file);
+ 		config_path += config_file;
+-		if(control->ParseConfigFile(config_path.c_str())) parsed_anyconfigfile = true;
+-		if(!parsed_anyconfigfile) {
++		control->ParseConfigFile(config_path.c_str());
++		if(!control->configfiles.size()) {
+ 			//Try to create the userlevel configfile.
+ 			config_file.clear();
+ 			Cross::CreatePlatformConfigDir(config_path);
+@@ -1807,29 +1964,29 @@
+ 			if(control->PrintConfig(config_path.c_str())) {
+ 				LOG_MSG("CONFIG: Generating default configuration.\nWriting it to %s",config_path.c_str());
+ 				//Load them as well. Makes relative paths much easier
+-				if(control->ParseConfigFile(config_path.c_str())) parsed_anyconfigfile = true;
++				control->ParseConfigFile(config_path.c_str());
+ 			}
+ 		}
+ 	}
+ 
+-	//Second parse -conf entries
+-	while(control->cmdline->FindString("-conf",config_file,true))
+-		if (control->ParseConfigFile(config_file.c_str())) parsed_anyconfigfile = true;
+-
+-	//if none found => parse localdir conf
+-	config_file = "dosbox.conf";
+-	if (!parsed_anyconfigfile && control->ParseConfigFile(config_file.c_str())) parsed_anyconfigfile = true;
++	//Second parse -conf switches
++	while(control->cmdline->FindString("-conf",config_file,true)) {
++		if(!control->ParseConfigFile(config_file.c_str())) {
++			// try to load it from the user directory
++			control->ParseConfigFile((config_path + config_file).c_str());
++		}
++	}
++	// if none found => parse localdir conf
++	if(!control->configfiles.size()) control->ParseConfigFile("dosbox.conf");
+ 
+-	//if none found => parse userlevel conf
+-	if(!parsed_anyconfigfile) {
++	// if none found => parse userlevel conf
++	if(!control->configfiles.size()) {
+ 		config_file.clear();
+-		Cross::GetPlatformConfigDir(config_path);
+ 		Cross::GetPlatformConfigName(config_file);
+-		config_path += config_file;
+-		if(control->ParseConfigFile(config_path.c_str())) parsed_anyconfigfile = true;
++		control->ParseConfigFile((config_path + config_file).c_str());
+ 	}
+ 
+-	if(!parsed_anyconfigfile) {
++	if(!control->configfiles.size()) {
+ 		//Try to create the userlevel configfile.
+ 		config_file.clear();
+ 		Cross::CreatePlatformConfigDir(config_path);
+@@ -1856,7 +2013,7 @@
+ 		Section_prop * sdl_sec=static_cast<Section_prop *>(control->GetSection("sdl"));
+ 
+ 		if (control->cmdline->FindExist("-fullscreen") || sdl_sec->Get_bool("fullscreen")) {
+-			if(!sdl.desktop.fullscreen) { //only switch if not allready in fullscreen
++			if(!sdl.desktop.fullscreen) { //only switch if not already in fullscreen
+ 				GFX_SwitchFullScreen();
+ 			}
+ 		}
+@@ -1868,6 +2025,9 @@
+ 		control->StartUp();
+ 		/* Shutdown everything */
+ 	} catch (char * error) {
++#if defined (WIN32)
++		sticky_keys(true);
++#endif
+ 		GFX_ShowMsg("Exit to error: %s",error);
+ 		fflush(NULL);
+ 		if(sdl.wait_on_error) {
+@@ -1883,14 +2043,14 @@
+ 
+ 	}
+ 	catch (int){
+-		;//nothing pressed killswitch
++		; //nothing, pressed killswitch
+ 	}
+ 	catch(...){
+-		//Force visible mouse to end user. Somehow this sometimes doesn't happen
+-		SDL_WM_GrabInput(SDL_GRAB_OFF);
+-		SDL_ShowCursor(SDL_ENABLE);
+-		throw;//dunno what happened. rethrow for sdl to catch
++		; // Unknown error, let's just exit.
+ 	}
++#if defined (WIN32)
++	sticky_keys(true); //Might not be needed if the shutdown function switches to windowed mode, but it doesn't hurt
++#endif 
+ 	//Force visible mouse to end user. Somehow this sometimes doesn't happen
+ 	SDL_WM_GrabInput(SDL_GRAB_OFF);
+ 	SDL_ShowCursor(SDL_ENABLE);
+diff -Nur dosbox-0.74/src/gui/sdl_mapper.cpp dosbox/src/gui/sdl_mapper.cpp
+--- dosbox-0.74/src/gui/sdl_mapper.cpp	2010-05-10 20:58:06.000000000 +0200
++++ dosbox/src/gui/sdl_mapper.cpp	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,7 +16,6 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: sdl_mapper.cpp,v 1.60 2009-06-01 10:25:51 qbix79 Exp $ */
+ 
+ #include <vector>
+ #include <list>
+@@ -521,11 +520,12 @@
+ };
+ 
+ #define MAX_VJOY_BUTTONS 8
+-
++#define MAX_VJOY_HAT 16
++#define MAX_VJOY_AXIS 8
+ static struct {
+ 	bool button_pressed[MAX_VJOY_BUTTONS];
+-	Bit16s axis_pos[8];
+-	bool hat_pressed[16];
++	Bit16s axis_pos[MAX_VJOY_AXIS];
++	bool hat_pressed[MAX_VJOY_HAT];
+ } virtual_joysticks[2];
+ 
+ 
+@@ -1584,6 +1584,9 @@
+ 		case MK_printscreen:
+ 			key=SDLK_PRINT;
+ 			break;
++		case MK_home: 
++			key=SDLK_HOME; 
++			break;
+ 		}
+ 		sprintf(buf,"%s \"key %d%s%s%s\"",
+ 			entry,
+@@ -2105,7 +2108,7 @@
+ }
+ 
+ void MAPPER_AddHandler(MAPPER_Handler * handler,MapKeys key,Bitu mods,char const * const eventname,char const * const buttonname) {
+-	//Check if it allready exists=> if so return.
++	//Check if it already exists=> if so return.
+ 	for(CHandlerEventVector_it it=handlergroup.begin();it!=handlergroup.end();it++)
+ 		if(strcmp((*it)->buttonname,buttonname) == 0) return;
+ 
+@@ -2359,17 +2362,21 @@
+ 	if (!MAPPER_LoadBinds()) CreateDefaultBinds();
+ 	if (SDL_GetModState()&KMOD_CAPS) {
+ 		for (CBindList_it bit=caps_lock_event->bindlist.begin();bit!=caps_lock_event->bindlist.end();bit++) {
+-			(*bit)->ActivateBind(32767,true,true);
+ #if SDL_VERSION_ATLEAST(1, 2, 14)
++			(*bit)->ActivateBind(32767,true,false);
+ 			(*bit)->DeActivateBind(false);
++#else
++			(*bit)->ActivateBind(32767,true,true); //Skip the action itself as bios_keyboard.cpp handles the startup state.
+ #endif
+ 		}
+ 	}
+ 	if (SDL_GetModState()&KMOD_NUM) {
+ 		for (CBindList_it bit=num_lock_event->bindlist.begin();bit!=num_lock_event->bindlist.end();bit++) {
+-			(*bit)->ActivateBind(32767,true,true);
+ #if SDL_VERSION_ATLEAST(1, 2, 14)
++			(*bit)->ActivateBind(32767,true,false);
+ 			(*bit)->DeActivateBind(false);
++#else
++			(*bit)->ActivateBind(32767,true,true);
+ #endif
+ 		}
+ 	}
+@@ -2384,15 +2391,17 @@
+ 	mapper.sticks.num=0;
+ 	mapper.sticks.num_groups=0;
+ 	Bitu i;
+-	for (i=0; i<16; i++) {
++	for (i=0; i<MAX_VJOY_BUTTONS; i++) {
+ 		virtual_joysticks[0].button_pressed[i]=false;
+ 		virtual_joysticks[1].button_pressed[i]=false;
++	}
++	for (i=0; i<MAX_VJOY_HAT; i++) {
+ 		virtual_joysticks[0].hat_pressed[i]=false;
+ 		virtual_joysticks[1].hat_pressed[i]=false;
+ 	}
+-	for (i=0; i<8; i++) {
+-		virtual_joysticks[0].axis_pos[i]=0;
++	for (i=0; i<MAX_VJOY_AXIS; i++) {
+ 		virtual_joysticks[0].axis_pos[i]=0;
++		virtual_joysticks[1].axis_pos[i]=0;
+ 	}
+ 
+ 	usescancodes = false;
+diff -Nur dosbox-0.74/src/hardware/adlib.cpp dosbox/src/hardware/adlib.cpp
+--- dosbox-0.74/src/hardware/adlib.cpp	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/hardware/adlib.cpp	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,7 +16,6 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: adlib.cpp,v 1.42 2009-11-03 20:17:42 qbix79 Exp $ */
+ 
+ #include <stdlib.h>
+ #include <string.h>
+diff -Nur dosbox-0.74/src/hardware/adlib.h dosbox/src/hardware/adlib.h
+--- dosbox-0.74/src/hardware/adlib.h	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/hardware/adlib.h	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,7 +16,6 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: adlib.h,v 1.5 2009-04-28 21:45:43 c2woody Exp $ */
+ 
+ #ifndef DOSBOX_ADLIB_H
+ #define DOSBOX_ADLIB_H
+diff -Nur dosbox-0.74/src/hardware/cmos.cpp dosbox/src/hardware/cmos.cpp
+--- dosbox-0.74/src/hardware/cmos.cpp	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/hardware/cmos.cpp	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,7 +16,6 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: cmos.cpp,v 1.29 2009-06-16 18:19:18 qbix79 Exp $ */
+ 
+ #include <time.h>
+ #include <math.h>
+diff -Nur dosbox-0.74/src/hardware/dbopl.cpp dosbox/src/hardware/dbopl.cpp
+--- dosbox-0.74/src/hardware/dbopl.cpp	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/hardware/dbopl.cpp	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -32,7 +32,6 @@
+ 	//DUNNO Keyon in 4op, switch to 2op without keyoff.
+ */
+ 
+-/* $Id: dbopl.cpp,v 1.10 2009-06-10 19:54:51 harekiet Exp $ */
+ 
+ 
+ #include <math.h>
+diff -Nur dosbox-0.74/src/hardware/dbopl.h dosbox/src/hardware/dbopl.h
+--- dosbox-0.74/src/hardware/dbopl.h	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/hardware/dbopl.h	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+diff -Nur dosbox-0.74/src/hardware/disney.cpp dosbox/src/hardware/disney.cpp
+--- dosbox-0.74/src/hardware/disney.cpp	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/hardware/disney.cpp	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,7 +16,6 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: disney.cpp,v 1.17 2009-05-14 17:04:37 qbix79 Exp $ */
+ 
+ #include <string.h>
+ #include "dosbox.h"
+@@ -70,11 +69,9 @@
+ 	if(disney.mo) {
+ 		disney.chan->AddSilence();
+ 		disney.chan->Enable(false);
+-		delete disney.mo;
+ 	}
+ 	disney.leader = 0;
+ 	disney.last_used = 0;
+-	disney.mo = 0;
+ 	disney.state = DS_IDLE;
+ 	disney.interface_det = 0;
+ 	disney.interface_det_ext = 0;
+@@ -91,8 +88,7 @@
+ 		if(disney.stereo) LOG(LOG_MISC,LOG_NORMAL)("disney enable %d Hz, stereo",freq);
+ 		else LOG(LOG_MISC,LOG_NORMAL)("disney enable %d Hz, mono",freq);
+ #endif
+-		disney.mo = new MixerObject();
+-		disney.chan=disney.mo->Install(&DISNEY_CallBack,freq,"DISNEY");
++		disney.chan->SetFreq(freq);
+ 		disney.chan->Enable(true);
+ 		disney.state = DS_RUNNING;
+ 	}
+@@ -378,11 +374,16 @@
+ 		disney.control=0;
+ 		disney.last_used=0;
+ 
+-		disney.mo=0;
++		disney.mo = new MixerObject();
++		disney.chan=disney.mo->Install(&DISNEY_CallBack,10000,"DISNEY");
+ 		DISNEY_disable(0);
++
++
+ 	}
+ 	~DISNEY(){
+ 		DISNEY_disable(0);
++		if (disney.mo)
++			delete disney.mo;
+ 	}
+ };
+ 
+diff -Nur dosbox-0.74/src/hardware/dma.cpp dosbox/src/hardware/dma.cpp
+--- dosbox-0.74/src/hardware/dma.cpp	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/hardware/dma.cpp	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,7 +16,6 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: dma.cpp,v 1.41 2009-07-24 09:56:14 c2woody Exp $ */
+ 
+ #include <string.h>
+ #include "dosbox.h"
+@@ -32,6 +31,8 @@
+ #define EMM_PAGEFRAME4K	((0xE000*16)/4096)
+ Bit32u ems_board_mapping[LINK_START];
+ 
++static Bit32u dma_wrapping = 0xffff;
++
+ static void UpdateEMSMapping(void) {
+ 	/* if EMS is not present, this will result in a 1:1 mapping */
+ 	Bitu i;
+@@ -48,7 +49,9 @@
+ 	offset <<= dma16;
+ 	Bit32u dma_wrap = ((0xffff<<dma16)+dma16) | dma_wrapping;
+ 	for ( ; size ; size--, offset++) {
+-		if (offset>(dma_wrapping<<dma16)) E_Exit("DMA segbound wrapping (read)");
++		if (offset>(dma_wrapping<<dma16)) {
++			LOG_MSG("DMA segbound wrapping (read): %x:%x size %x [%x] wrap %x",spage,offset,size,dma16,dma_wrapping);
++		}
+ 		offset &= dma_wrap;
+ 		Bitu page = highpart_addr_page+(offset >> 12);
+ 		/* care for EMS pageframe etc. */
+@@ -67,7 +70,9 @@
+ 	offset <<= dma16;
+ 	Bit32u dma_wrap = ((0xffff<<dma16)+dma16) | dma_wrapping;
+ 	for ( ; size ; size--, offset++) {
+-		if (offset>(dma_wrapping<<dma16)) E_Exit("DMA segbound wrapping (write)");
++		if (offset>(dma_wrapping<<dma16)) {
++			LOG_MSG("DMA segbound wrapping (write): %x:%x size %x [%x] wrap %x",spage,offset,size,dma16,dma_wrapping);
++		}
+ 		offset &= dma_wrap;
+ 		Bitu page = highpart_addr_page+(offset >> 12);
+ 		/* care for EMS pageframe etc. */
+diff -Nur dosbox-0.74/src/hardware/gameblaster.cpp dosbox/src/hardware/gameblaster.cpp
+--- dosbox-0.74/src/hardware/gameblaster.cpp	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/hardware/gameblaster.cpp	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+diff -Nur dosbox-0.74/src/hardware/gus.cpp dosbox/src/hardware/gus.cpp
+--- dosbox-0.74/src/hardware/gus.cpp	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/hardware/gus.cpp	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,7 +16,6 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: gus.cpp,v 1.37 2009-09-03 16:03:01 c2woody Exp $ */
+ 
+ #include <string.h>
+ #include <iomanip>
+@@ -770,7 +769,7 @@
+ 		vol16bit[i]=(Bit16s)out;
+ 		out/=1.002709201;		/* 0.0235 dB Steps */
+ 	}
+-	pantable[0]=0;
++	pantable[0] = 4095 << RAMP_FRACT;
+ 	for (i=1;i<16;i++) {
+ 		pantable[i]=(Bit32u)(-128.0*(log((double)i/15.0)/log(2.0))*(double)(1 << RAMP_FRACT));
+ 	}
+diff -Nur dosbox-0.74/src/hardware/hardware.cpp dosbox/src/hardware/hardware.cpp
+--- dosbox-0.74/src/hardware/hardware.cpp	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/hardware/hardware.cpp	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,7 +16,6 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: hardware.cpp,v 1.23 2009-10-11 18:09:22 qbix79 Exp $ */
+ 
+ #include <string.h>
+ #include <stdlib.h>
+@@ -161,13 +160,17 @@
+ #endif
+ 
+ #if (C_SSHOT)
++static void CAPTURE_VideoEvent(bool pressed) {
++	if (!pressed)
++		return;
++	if (CaptureState & CAPTURE_VIDEO) {
++		/* Close the video */
++		CaptureState &= ~CAPTURE_VIDEO;
++		LOG_MSG("Stopped capturing video.");	
+ 
+-static void CAPTURE_VideoHeader() {
+ 		Bit8u avi_header[AVI_HEADER_SIZE];
+ 		Bitu main_list;
+ 		Bitu header_pos=0;
+-		Bitu save_pos=ftell(capture.video.handle);
+-
+ #define AVIOUT4(_S_) memcpy(&avi_header[header_pos],_S_,4);header_pos+=4;
+ #define AVIOUTw(_S_) host_writew(&avi_header[header_pos], _S_);header_pos+=2;
+ #define AVIOUTd(_S_) host_writed(&avi_header[header_pos], _S_);header_pos+=4;
+@@ -284,20 +287,6 @@
+ 		fwrite( capture.video.index, 1, capture.video.indexused, capture.video.handle);
+ 		fseek(capture.video.handle, 0, SEEK_SET);
+ 		fwrite(&avi_header, 1, AVI_HEADER_SIZE, capture.video.handle);
+-		fseek(capture.video.handle, save_pos, SEEK_SET);
+-}
+-
+-static void CAPTURE_VideoEvent(bool pressed) {
+-	if (!pressed)
+-		return;
+-	if (CaptureState & CAPTURE_VIDEO) {
+-		/* Close the video */
+-		CaptureState &= ~CAPTURE_VIDEO;
+-		LOG_MSG("Stopped capturing video.");	
+-
+-		/* Adds AVI header to the file */
+-		CAPTURE_VideoHeader();
+-
+ 		fclose( capture.video.handle );
+ 		free( capture.video.index );
+ 		free( capture.video.buf );
+@@ -334,7 +323,7 @@
+ 		/* Open the actual file */
+ 		FILE * fp=OpenCaptureFile("Screenshot",".png");
+ 		if (!fp) goto skip_shot;
+-		/* First try to alloacte the png structures */
++		/* First try to allocate the png structures */
+ 		png_ptr = png_create_write_struct(PNG_LIBPNG_VER_STRING, NULL,NULL, NULL);
+ 		if (!png_ptr) goto skip_shot;
+ 		info_ptr = png_create_info_struct(png_ptr);
+@@ -370,7 +359,23 @@
+ 				8, PNG_COLOR_TYPE_RGB, PNG_INTERLACE_NONE,
+ 				PNG_COMPRESSION_TYPE_DEFAULT, PNG_FILTER_TYPE_DEFAULT);
+ 		}
++#ifdef PNG_TEXT_SUPPORTED
++		int fields = 1;
++		png_text text[1];
++		const char* text_s = "DOSBox " VERSION;
++		size_t strl = strlen(text_s);
++		char* ptext_s = new char[strl + 1];
++		strcpy(ptext_s, text_s);
++		char software[9] = { 'S','o','f','t','w','a','r','e',0};
++		text[0].compression = PNG_TEXT_COMPRESSION_NONE;
++		text[0].key  = software;
++		text[0].text = ptext_s;
++		png_set_text(png_ptr, info_ptr, text, fields);
++#endif
+ 		png_write_info(png_ptr, info_ptr);
++#ifdef PNG_TEXT_SUPPORTED
++		delete [] ptext_s;
++#endif
+ 		for (i=0;i<height;i++) {
+ 			void *rowPointer;
+ 			void *srcLine;
+@@ -557,9 +562,6 @@
+ 			capture.video.audioused = 0;
+ 		}
+ 
+-		/* Adds AVI header to the file */
+-		CAPTURE_VideoHeader();
+-
+ 		/* Everything went okay, set flag again for next frame */
+ 		CaptureState |= CAPTURE_VIDEO;
+ 	}
+@@ -756,6 +758,9 @@
+ #endif
+ 	}
+ 	~HARDWARE(){
++#if (C_SSHOT)
++		if (capture.video.handle) CAPTURE_VideoEvent(true);
++#endif
+ 		if (capture.wave.handle) CAPTURE_WaveEvent(true);
+ 		if (capture.midi.handle) CAPTURE_MidiEvent(true);
+ 	}
+diff -Nur dosbox-0.74/src/hardware/iohandler.cpp dosbox/src/hardware/iohandler.cpp
+--- dosbox-0.74/src/hardware/iohandler.cpp	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/hardware/iohandler.cpp	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,7 +16,6 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: iohandler.cpp,v 1.30 2009-05-27 09:15:41 qbix79 Exp $ */
+ 
+ #include <string.h>
+ #include "dosbox.h"
+@@ -45,7 +44,7 @@
+ 		io_readhandlers[0][port]=IO_ReadBlocked;
+ 		return 0xff;
+ 	case 2:
+-		return 
++		return
+ 			(io_readhandlers[0][port+0](port+0,1) << 0) |
+ 			(io_readhandlers[0][port+1](port+1,1) << 8);
+ 	case 4:
+@@ -59,7 +58,7 @@
+ void IO_WriteDefault(Bitu port,Bitu val,Bitu iolen) {
+ 	switch (iolen) {
+ 	case 1:
+-		LOG(LOG_IO,LOG_WARN)("Writing %02X to port %04X",val,port);		
++		LOG(LOG_IO,LOG_WARN)("Writing %02X to port %04X",val,port);
+ 		io_writehandlers[0][port]=IO_WriteBlocked;
+ 		break;
+ 	case 2:
+@@ -116,12 +115,17 @@
+ 		m_mask=mask;
+ 		m_range=range;
+ 		IO_RegisterReadHandler(port,handler,mask,range);
+-	} else E_Exit("IO_readHandler allready installed port %x",port);
++	} else E_Exit("IO_readHandler already installed port %x",port);
+ }
+ 
+-IO_ReadHandleObject::~IO_ReadHandleObject(){
++void IO_ReadHandleObject::Uninstall(){
+ 	if(!installed) return;
+ 	IO_FreeReadHandler(m_port,m_mask,m_range);
++	installed=false;
++}
++
++IO_ReadHandleObject::~IO_ReadHandleObject(){
++	Uninstall();
+ }
+ 
+ void IO_WriteHandleObject::Install(Bitu port,IO_WriteHandler * handler,Bitu mask,Bitu range) {
+@@ -131,12 +135,17 @@
+ 		m_mask=mask;
+ 		m_range=range;
+ 		IO_RegisterWriteHandler(port,handler,mask,range);
+-	} else E_Exit("IO_writeHandler allready installed port %x",port);
++	} else E_Exit("IO_writeHandler already installed port %x",port);
+ }
+ 
+-IO_WriteHandleObject::~IO_WriteHandleObject(){
++void IO_WriteHandleObject::Uninstall() {
+ 	if(!installed) return;
+ 	IO_FreeWriteHandler(m_port,m_mask,m_range);
++	installed=false;
++}
++
++IO_WriteHandleObject::~IO_WriteHandleObject(){
++	Uninstall();
+ 	//LOG_MSG("FreeWritehandler called with port %X",m_port);
+ }
+ 
+@@ -157,7 +166,7 @@
+ 	Bits ret=CPU_Core_Full_Run();
+ 	CPU_CycleLeft+=CPU_Cycles;
+ 	if (ret<0) E_Exit("Got a dosbox close machine in IO-fault core?");
+-	if (ret) 
++	if (ret)
+ 		return ret;
+ 	if (!iof_queue.used) E_Exit("IO-faul Core without IO-faul");
+ 	IOF_Entry * entry=&iof_queue.entries[iof_queue.used-1];
+@@ -187,7 +196,7 @@
+ inline void IO_USEC_write_delay_old() {
+ 	if(CPU_CycleMax > static_cast<Bit32s>((IODELAY_WRITE_MICROS*1000.0))) {
+ 		// this could be calculated whenever CPU_CycleMax changes
+-		Bits delaycyc = static_cast<Bits>((CPU_CycleMax/1000)*IODELAY_WRITE_MICROS); 
++		Bits delaycyc = static_cast<Bits>((CPU_CycleMax/1000)*IODELAY_WRITE_MICROS);
+ 		if(CPU_Cycles > delaycyc) CPU_Cycles -= delaycyc;
+ 		else CPU_Cycles = 0;
+ 	}
+@@ -205,7 +214,7 @@
+ }
+ 
+ inline void IO_USEC_write_delay() {
+-	Bits delaycyc = CPU_CycleMax/IODELAY_WRITE_MICROSk; 
++	Bits delaycyc = CPU_CycleMax/IODELAY_WRITE_MICROSk;
+ 	if(GCC_UNLIKELY(CPU_Cycles < 3*delaycyc)) delaycyc=0;
+ 	CPU_Cycles -= delaycyc;
+ 	CPU_IODelayRemoved += delaycyc;
+@@ -328,7 +337,7 @@
+ 		CPU_Push16(reg_ip);
+ 		Bit16u old_ax = reg_ax;
+ 		Bit16u old_dx = reg_dx;
+-		reg_al = val;
++		reg_ax = val;
+ 		reg_dx = port;
+ 		RealPt icb = CALLBACK_RealPointer(call_priv_io);
+ 		SegSet16(cs,RealSeg(icb));
+@@ -364,7 +373,7 @@
+ 		CPU_Push16(reg_ip);
+ 		Bit32u old_eax = reg_eax;
+ 		Bit16u old_dx = reg_dx;
+-		reg_al = val;
++		reg_eax = val;
+ 		reg_dx = port;
+ 		RealPt icb = CALLBACK_RealPointer(call_priv_io);
+ 		SegSet16(cs,RealSeg(icb));
+@@ -406,7 +415,7 @@
+ 		iof_queue.used--;
+ 
+ 		retval = reg_al;
+-		reg_dx = old_dx;		
++		reg_dx = old_dx;
+ 		memcpy(&lflags,&old_lflags,sizeof(LazyFlags));
+ 		cpudecoder=old_cpudecoder;
+ 		return retval;
+@@ -443,7 +452,7 @@
+ 		iof_queue.used--;
+ 
+ 		retval = reg_ax;
+-		reg_dx = old_dx;		
++		reg_dx = old_dx;
+ 		memcpy(&lflags,&old_lflags,sizeof(LazyFlags));
+ 		cpudecoder=old_cpudecoder;
+ 	}
+@@ -479,7 +488,7 @@
+ 		iof_queue.used--;
+ 
+ 		retval = reg_eax;
+-		reg_dx = old_dx;		
++		reg_dx = old_dx;
+ 		memcpy(&lflags,&old_lflags,sizeof(LazyFlags));
+ 		cpudecoder=old_cpudecoder;
+ 	} else {
+diff -Nur dosbox-0.74/src/hardware/ipx.cpp dosbox/src/hardware/ipx.cpp
+--- dosbox-0.74/src/hardware/ipx.cpp	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/hardware/ipx.cpp	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,7 +16,6 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: ipx.cpp,v 1.17 2009-05-27 09:15:41 qbix79 Exp $ */
+ 
+ #include "dosbox.h"
+ 
+@@ -936,7 +935,7 @@
+ 			if(strcasecmp("startserver", temp_line.c_str()) == 0) {
+ 				if(!isIpxServer) {
+ 					if(incomingPacket.connected) {
+-						WriteOut("IPX Tunneling Client alreadu connected to another server.  Disconnect first.\n");
++						WriteOut("IPX Tunneling Client already connected to another server.  Disconnect first.\n");
+ 						return;
+ 					}
+ 					bool startsuccess;
+diff -Nur dosbox-0.74/src/hardware/ipxserver.cpp dosbox/src/hardware/ipxserver.cpp
+--- dosbox-0.74/src/hardware/ipxserver.cpp	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/hardware/ipxserver.cpp	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,7 +16,6 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: ipxserver.cpp,v 1.10 2009-05-27 09:15:41 qbix79 Exp $ */
+ 
+ #include "dosbox.h"
+ 
+diff -Nur dosbox-0.74/src/hardware/joystick.cpp dosbox/src/hardware/joystick.cpp
+--- dosbox-0.74/src/hardware/joystick.cpp	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/hardware/joystick.cpp	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,7 +16,6 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: joystick.cpp,v 1.21 2009-05-27 09:15:41 qbix79 Exp $ */
+ 
+ #include <string.h>
+ #include "dosbox.h"
+diff -Nur dosbox-0.74/src/hardware/keyboard.cpp dosbox/src/hardware/keyboard.cpp
+--- dosbox-0.74/src/hardware/keyboard.cpp	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/hardware/keyboard.cpp	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,7 +16,6 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: keyboard.cpp,v 1.41 2009-05-27 09:15:41 qbix79 Exp $ */
+ 
+ #include "dosbox.h"
+ #include "keyboard.h"
+@@ -348,15 +347,18 @@
+ 	}
+ 	/* Add the actual key in the keyboard queue */
+ 	if (pressed) {
+-		if (keyb.repeat.key==keytype) keyb.repeat.wait=keyb.repeat.rate;		
+-		else keyb.repeat.wait=keyb.repeat.pause;
+-		keyb.repeat.key=keytype;
++		if (keyb.repeat.key == keytype) keyb.repeat.wait = keyb.repeat.rate;		
++		else keyb.repeat.wait = keyb.repeat.pause;
++		keyb.repeat.key = keytype;
+ 	} else {
+-		keyb.repeat.key=KBD_NONE;
+-		keyb.repeat.wait=0;
+-		ret+=128;
++		if (keyb.repeat.key == keytype) {
++			/* repeated key being released */
++			keyb.repeat.key  = KBD_NONE;
++			keyb.repeat.wait = 0;
++		}
++		ret += 128;
+ 	}
+-	if (extend) KEYBOARD_AddBuffer(0xe0); 
++	if (extend) KEYBOARD_AddBuffer(0xe0);
+ 	KEYBOARD_AddBuffer(ret);
+ }
+ 
+diff -Nur dosbox-0.74/src/hardware/Makefile.am dosbox/src/hardware/Makefile.am
+--- dosbox-0.74/src/hardware/Makefile.am	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/hardware/Makefile.am	2014-01-12 14:43:47.000000000 +0100
+@@ -2,12 +2,12 @@
+ 
+ SUBDIRS = serialport
+ 
+-EXTRA_DIST = opl.cpp opl.h adlib.h dbopl.h
++EXTRA_DIST = opl.cpp opl.h adlib.h dbopl.h pci_devices.h
+ 
+ noinst_LIBRARIES = libhardware.a
+ 
+ libhardware_a_SOURCES = adlib.cpp dma.cpp gameblaster.cpp hardware.cpp iohandler.cpp joystick.cpp keyboard.cpp \
+-                        memory.cpp mixer.cpp pcspeaker.cpp pic.cpp sblaster.cpp tandy_sound.cpp timer.cpp \
++                        memory.cpp mixer.cpp pcspeaker.cpp pci_bus.cpp pic.cpp sblaster.cpp tandy_sound.cpp timer.cpp \
+ 			vga.cpp vga_attr.cpp vga_crtc.cpp vga_dac.cpp vga_draw.cpp vga_gfx.cpp vga_other.cpp \
+ 			vga_memory.cpp vga_misc.cpp vga_seq.cpp vga_xga.cpp vga_s3.cpp vga_tseng.cpp vga_paradise.cpp \
+ 			cmos.cpp disney.cpp gus.cpp mpu401.cpp ipx.cpp ipxserver.cpp dbopl.cpp
+diff -Nur dosbox-0.74/src/hardware/Makefile.in dosbox/src/hardware/Makefile.in
+--- dosbox-0.74/src/hardware/Makefile.in	2010-05-12 11:57:44.000000000 +0200
++++ dosbox/src/hardware/Makefile.in	1970-01-01 01:00:00.000000000 +0100
+@@ -1,643 +0,0 @@
+-# Makefile.in generated by automake 1.11.1 from Makefile.am.
+-# @configure_input@
+-
+-# Copyright (C) 1994, 1995, 1996, 1997, 1998, 1999, 2000, 2001, 2002,
+-# 2003, 2004, 2005, 2006, 2007, 2008, 2009  Free Software Foundation,
+-# Inc.
+-# This Makefile.in is free software; the Free Software Foundation
+-# gives unlimited permission to copy and/or distribute it,
+-# with or without modifications, as long as this notice is preserved.
+-
+-# This program is distributed in the hope that it will be useful,
+-# but WITHOUT ANY WARRANTY, to the extent permitted by law; without
+-# even the implied warranty of MERCHANTABILITY or FITNESS FOR A
+-# PARTICULAR PURPOSE.
+-
+-@SET_MAKE@
+-
+-VPATH = @srcdir@
+-pkgdatadir = $(datadir)/@PACKAGE@
+-pkgincludedir = $(includedir)/@PACKAGE@
+-pkglibdir = $(libdir)/@PACKAGE@
+-pkglibexecdir = $(libexecdir)/@PACKAGE@
+-am__cd = CDPATH="$${ZSH_VERSION+.}$(PATH_SEPARATOR)" && cd
+-install_sh_DATA = $(install_sh) -c -m 644
+-install_sh_PROGRAM = $(install_sh) -c
+-install_sh_SCRIPT = $(install_sh) -c
+-INSTALL_HEADER = $(INSTALL_DATA)
+-transform = $(program_transform_name)
+-NORMAL_INSTALL = :
+-PRE_INSTALL = :
+-POST_INSTALL = :
+-NORMAL_UNINSTALL = :
+-PRE_UNINSTALL = :
+-POST_UNINSTALL = :
+-build_triplet = @build@
+-host_triplet = @host@
+-subdir = src/hardware
+-DIST_COMMON = $(srcdir)/Makefile.am $(srcdir)/Makefile.in
+-ACLOCAL_M4 = $(top_srcdir)/aclocal.m4
+-am__aclocal_m4_deps = $(top_srcdir)/acinclude.m4 \
+-	$(top_srcdir)/configure.in
+-am__configure_deps = $(am__aclocal_m4_deps) $(CONFIGURE_DEPENDENCIES) \
+-	$(ACLOCAL_M4)
+-mkinstalldirs = $(install_sh) -d
+-CONFIG_HEADER = $(top_builddir)/config.h
+-CONFIG_CLEAN_FILES =
+-CONFIG_CLEAN_VPATH_FILES =
+-LIBRARIES = $(noinst_LIBRARIES)
+-AR = ar
+-ARFLAGS = cru
+-libhardware_a_AR = $(AR) $(ARFLAGS)
+-libhardware_a_LIBADD =
+-am_libhardware_a_OBJECTS = adlib.$(OBJEXT) dma.$(OBJEXT) \
+-	gameblaster.$(OBJEXT) hardware.$(OBJEXT) iohandler.$(OBJEXT) \
+-	joystick.$(OBJEXT) keyboard.$(OBJEXT) memory.$(OBJEXT) \
+-	mixer.$(OBJEXT) pcspeaker.$(OBJEXT) pic.$(OBJEXT) \
+-	sblaster.$(OBJEXT) tandy_sound.$(OBJEXT) timer.$(OBJEXT) \
+-	vga.$(OBJEXT) vga_attr.$(OBJEXT) vga_crtc.$(OBJEXT) \
+-	vga_dac.$(OBJEXT) vga_draw.$(OBJEXT) vga_gfx.$(OBJEXT) \
+-	vga_other.$(OBJEXT) vga_memory.$(OBJEXT) vga_misc.$(OBJEXT) \
+-	vga_seq.$(OBJEXT) vga_xga.$(OBJEXT) vga_s3.$(OBJEXT) \
+-	vga_tseng.$(OBJEXT) vga_paradise.$(OBJEXT) cmos.$(OBJEXT) \
+-	disney.$(OBJEXT) gus.$(OBJEXT) mpu401.$(OBJEXT) ipx.$(OBJEXT) \
+-	ipxserver.$(OBJEXT) dbopl.$(OBJEXT)
+-libhardware_a_OBJECTS = $(am_libhardware_a_OBJECTS)
+-DEFAULT_INCLUDES = -I.@am__isrc@ -I$(top_builddir)
+-depcomp = $(SHELL) $(top_srcdir)/depcomp
+-am__depfiles_maybe = depfiles
+-am__mv = mv -f
+-CXXCOMPILE = $(CXX) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) \
+-	$(AM_CPPFLAGS) $(CPPFLAGS) $(AM_CXXFLAGS) $(CXXFLAGS)
+-CXXLD = $(CXX)
+-CXXLINK = $(CXXLD) $(AM_CXXFLAGS) $(CXXFLAGS) $(AM_LDFLAGS) $(LDFLAGS) \
+-	-o $@
+-SOURCES = $(libhardware_a_SOURCES)
+-DIST_SOURCES = $(libhardware_a_SOURCES)
+-RECURSIVE_TARGETS = all-recursive check-recursive dvi-recursive \
+-	html-recursive info-recursive install-data-recursive \
+-	install-dvi-recursive install-exec-recursive \
+-	install-html-recursive install-info-recursive \
+-	install-pdf-recursive install-ps-recursive install-recursive \
+-	installcheck-recursive installdirs-recursive pdf-recursive \
+-	ps-recursive uninstall-recursive
+-RECURSIVE_CLEAN_TARGETS = mostlyclean-recursive clean-recursive	\
+-  distclean-recursive maintainer-clean-recursive
+-AM_RECURSIVE_TARGETS = $(RECURSIVE_TARGETS:-recursive=) \
+-	$(RECURSIVE_CLEAN_TARGETS:-recursive=) tags TAGS ctags CTAGS \
+-	distdir
+-ETAGS = etags
+-CTAGS = ctags
+-DIST_SUBDIRS = $(SUBDIRS)
+-DISTFILES = $(DIST_COMMON) $(DIST_SOURCES) $(TEXINFOS) $(EXTRA_DIST)
+-am__relativize = \
+-  dir0=`pwd`; \
+-  sed_first='s,^\([^/]*\)/.*$$,\1,'; \
+-  sed_rest='s,^[^/]*/*,,'; \
+-  sed_last='s,^.*/\([^/]*\)$$,\1,'; \
+-  sed_butlast='s,/*[^/]*$$,,'; \
+-  while test -n "$$dir1"; do \
+-    first=`echo "$$dir1" | sed -e "$$sed_first"`; \
+-    if test "$$first" != "."; then \
+-      if test "$$first" = ".."; then \
+-        dir2=`echo "$$dir0" | sed -e "$$sed_last"`/"$$dir2"; \
+-        dir0=`echo "$$dir0" | sed -e "$$sed_butlast"`; \
+-      else \
+-        first2=`echo "$$dir2" | sed -e "$$sed_first"`; \
+-        if test "$$first2" = "$$first"; then \
+-          dir2=`echo "$$dir2" | sed -e "$$sed_rest"`; \
+-        else \
+-          dir2="../$$dir2"; \
+-        fi; \
+-        dir0="$$dir0"/"$$first"; \
+-      fi; \
+-    fi; \
+-    dir1=`echo "$$dir1" | sed -e "$$sed_rest"`; \
+-  done; \
+-  reldir="$$dir2"
+-ACLOCAL = @ACLOCAL@
+-ALSA_CFLAGS = @ALSA_CFLAGS@
+-ALSA_LIBS = @ALSA_LIBS@
+-AMTAR = @AMTAR@
+-AUTOCONF = @AUTOCONF@
+-AUTOHEADER = @AUTOHEADER@
+-AUTOMAKE = @AUTOMAKE@
+-AWK = @AWK@
+-CC = @CC@
+-CCDEPMODE = @CCDEPMODE@
+-CFLAGS = @CFLAGS@
+-CPP = @CPP@
+-CPPFLAGS = @CPPFLAGS@
+-CXX = @CXX@
+-CXXDEPMODE = @CXXDEPMODE@
+-CXXFLAGS = @CXXFLAGS@
+-CYGPATH_W = @CYGPATH_W@
+-DEFS = @DEFS@
+-DEPDIR = @DEPDIR@
+-ECHO_C = @ECHO_C@
+-ECHO_N = @ECHO_N@
+-ECHO_T = @ECHO_T@
+-EGREP = @EGREP@
+-EXEEXT = @EXEEXT@
+-GREP = @GREP@
+-INSTALL = @INSTALL@
+-INSTALL_DATA = @INSTALL_DATA@
+-INSTALL_PROGRAM = @INSTALL_PROGRAM@
+-INSTALL_SCRIPT = @INSTALL_SCRIPT@
+-INSTALL_STRIP_PROGRAM = @INSTALL_STRIP_PROGRAM@
+-LDFLAGS = @LDFLAGS@
+-LIBOBJS = @LIBOBJS@
+-LIBS = @LIBS@
+-LTLIBOBJS = @LTLIBOBJS@
+-MAKEINFO = @MAKEINFO@
+-MKDIR_P = @MKDIR_P@
+-OBJEXT = @OBJEXT@
+-PACKAGE = @PACKAGE@
+-PACKAGE_BUGREPORT = @PACKAGE_BUGREPORT@
+-PACKAGE_NAME = @PACKAGE_NAME@
+-PACKAGE_STRING = @PACKAGE_STRING@
+-PACKAGE_TARNAME = @PACKAGE_TARNAME@
+-PACKAGE_URL = @PACKAGE_URL@
+-PACKAGE_VERSION = @PACKAGE_VERSION@
+-PATH_SEPARATOR = @PATH_SEPARATOR@
+-RANLIB = @RANLIB@
+-SDL_CFLAGS = @SDL_CFLAGS@
+-SDL_CONFIG = @SDL_CONFIG@
+-SDL_LIBS = @SDL_LIBS@
+-SET_MAKE = @SET_MAKE@
+-SHELL = @SHELL@
+-STRIP = @STRIP@
+-VERSION = @VERSION@
+-WINDRES = @WINDRES@
+-abs_builddir = @abs_builddir@
+-abs_srcdir = @abs_srcdir@
+-abs_top_builddir = @abs_top_builddir@
+-abs_top_srcdir = @abs_top_srcdir@
+-ac_ct_CC = @ac_ct_CC@
+-ac_ct_CXX = @ac_ct_CXX@
+-am__include = @am__include@
+-am__leading_dot = @am__leading_dot@
+-am__quote = @am__quote@
+-am__tar = @am__tar@
+-am__untar = @am__untar@
+-bindir = @bindir@
+-build = @build@
+-build_alias = @build_alias@
+-build_cpu = @build_cpu@
+-build_os = @build_os@
+-build_vendor = @build_vendor@
+-builddir = @builddir@
+-datadir = @datadir@
+-datarootdir = @datarootdir@
+-docdir = @docdir@
+-dvidir = @dvidir@
+-exec_prefix = @exec_prefix@
+-host = @host@
+-host_alias = @host_alias@
+-host_cpu = @host_cpu@
+-host_os = @host_os@
+-host_vendor = @host_vendor@
+-htmldir = @htmldir@
+-includedir = @includedir@
+-infodir = @infodir@
+-install_sh = @install_sh@
+-libdir = @libdir@
+-libexecdir = @libexecdir@
+-localedir = @localedir@
+-localstatedir = @localstatedir@
+-mandir = @mandir@
+-mkdir_p = @mkdir_p@
+-oldincludedir = @oldincludedir@
+-pdfdir = @pdfdir@
+-prefix = @prefix@
+-program_transform_name = @program_transform_name@
+-psdir = @psdir@
+-sbindir = @sbindir@
+-sharedstatedir = @sharedstatedir@
+-srcdir = @srcdir@
+-sysconfdir = @sysconfdir@
+-target_alias = @target_alias@
+-top_build_prefix = @top_build_prefix@
+-top_builddir = @top_builddir@
+-top_srcdir = @top_srcdir@
+-AM_CPPFLAGS = -I$(top_srcdir)/include
+-SUBDIRS = serialport
+-EXTRA_DIST = opl.cpp opl.h adlib.h dbopl.h
+-noinst_LIBRARIES = libhardware.a
+-libhardware_a_SOURCES = adlib.cpp dma.cpp gameblaster.cpp hardware.cpp iohandler.cpp joystick.cpp keyboard.cpp \
+-                        memory.cpp mixer.cpp pcspeaker.cpp pic.cpp sblaster.cpp tandy_sound.cpp timer.cpp \
+-			vga.cpp vga_attr.cpp vga_crtc.cpp vga_dac.cpp vga_draw.cpp vga_gfx.cpp vga_other.cpp \
+-			vga_memory.cpp vga_misc.cpp vga_seq.cpp vga_xga.cpp vga_s3.cpp vga_tseng.cpp vga_paradise.cpp \
+-			cmos.cpp disney.cpp gus.cpp mpu401.cpp ipx.cpp ipxserver.cpp dbopl.cpp
+-
+-all: all-recursive
+-
+-.SUFFIXES:
+-.SUFFIXES: .cpp .o .obj
+-$(srcdir)/Makefile.in:  $(srcdir)/Makefile.am  $(am__configure_deps)
+-	@for dep in $?; do \
+-	  case '$(am__configure_deps)' in \
+-	    *$$dep*) \
+-	      ( cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh ) \
+-	        && { if test -f $@; then exit 0; else break; fi; }; \
+-	      exit 1;; \
+-	  esac; \
+-	done; \
+-	echo ' cd $(top_srcdir) && $(AUTOMAKE) --gnu src/hardware/Makefile'; \
+-	$(am__cd) $(top_srcdir) && \
+-	  $(AUTOMAKE) --gnu src/hardware/Makefile
+-.PRECIOUS: Makefile
+-Makefile: $(srcdir)/Makefile.in $(top_builddir)/config.status
+-	@case '$?' in \
+-	  *config.status*) \
+-	    cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh;; \
+-	  *) \
+-	    echo ' cd $(top_builddir) && $(SHELL) ./config.status $(subdir)/$@ $(am__depfiles_maybe)'; \
+-	    cd $(top_builddir) && $(SHELL) ./config.status $(subdir)/$@ $(am__depfiles_maybe);; \
+-	esac;
+-
+-$(top_builddir)/config.status: $(top_srcdir)/configure $(CONFIG_STATUS_DEPENDENCIES)
+-	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
+-
+-$(top_srcdir)/configure:  $(am__configure_deps)
+-	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
+-$(ACLOCAL_M4):  $(am__aclocal_m4_deps)
+-	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
+-$(am__aclocal_m4_deps):
+-
+-clean-noinstLIBRARIES:
+-	-test -z "$(noinst_LIBRARIES)" || rm -f $(noinst_LIBRARIES)
+-libhardware.a: $(libhardware_a_OBJECTS) $(libhardware_a_DEPENDENCIES) 
+-	-rm -f libhardware.a
+-	$(libhardware_a_AR) libhardware.a $(libhardware_a_OBJECTS) $(libhardware_a_LIBADD)
+-	$(RANLIB) libhardware.a
+-
+-mostlyclean-compile:
+-	-rm -f *.$(OBJEXT)
+-
+-distclean-compile:
+-	-rm -f *.tab.c
+-
+-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/adlib.Po@am__quote@
+-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/cmos.Po@am__quote@
+-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/dbopl.Po@am__quote@
+-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/disney.Po@am__quote@
+-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/dma.Po@am__quote@
+-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/gameblaster.Po@am__quote@
+-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/gus.Po@am__quote@
+-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/hardware.Po@am__quote@
+-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/iohandler.Po@am__quote@
+-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/ipx.Po@am__quote@
+-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/ipxserver.Po@am__quote@
+-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/joystick.Po@am__quote@
+-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/keyboard.Po@am__quote@
+-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/memory.Po@am__quote@
+-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/mixer.Po@am__quote@
+-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/mpu401.Po@am__quote@
+-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/pcspeaker.Po@am__quote@
+-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/pic.Po@am__quote@
+-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/sblaster.Po@am__quote@
+-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/tandy_sound.Po@am__quote@
+-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/timer.Po@am__quote@
+-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/vga.Po@am__quote@
+-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/vga_attr.Po@am__quote@
+-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/vga_crtc.Po@am__quote@
+-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/vga_dac.Po@am__quote@
+-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/vga_draw.Po@am__quote@
+-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/vga_gfx.Po@am__quote@
+-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/vga_memory.Po@am__quote@
+-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/vga_misc.Po@am__quote@
+-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/vga_other.Po@am__quote@
+-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/vga_paradise.Po@am__quote@
+-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/vga_s3.Po@am__quote@
+-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/vga_seq.Po@am__quote@
+-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/vga_tseng.Po@am__quote@
+-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/vga_xga.Po@am__quote@
+-
+-.cpp.o:
+-@am__fastdepCXX_TRUE@	$(CXXCOMPILE) -MT $@ -MD -MP -MF $(DEPDIR)/$*.Tpo -c -o $@ $<
+-@am__fastdepCXX_TRUE@	$(am__mv) $(DEPDIR)/$*.Tpo $(DEPDIR)/$*.Po
+-@AMDEP_TRUE@@am__fastdepCXX_FALSE@	source='$<' object='$@' libtool=no @AMDEPBACKSLASH@
+-@AMDEP_TRUE@@am__fastdepCXX_FALSE@	DEPDIR=$(DEPDIR) $(CXXDEPMODE) $(depcomp) @AMDEPBACKSLASH@
+-@am__fastdepCXX_FALSE@	$(CXXCOMPILE) -c -o $@ $<
+-
+-.cpp.obj:
+-@am__fastdepCXX_TRUE@	$(CXXCOMPILE) -MT $@ -MD -MP -MF $(DEPDIR)/$*.Tpo -c -o $@ `$(CYGPATH_W) '$<'`
+-@am__fastdepCXX_TRUE@	$(am__mv) $(DEPDIR)/$*.Tpo $(DEPDIR)/$*.Po
+-@AMDEP_TRUE@@am__fastdepCXX_FALSE@	source='$<' object='$@' libtool=no @AMDEPBACKSLASH@
+-@AMDEP_TRUE@@am__fastdepCXX_FALSE@	DEPDIR=$(DEPDIR) $(CXXDEPMODE) $(depcomp) @AMDEPBACKSLASH@
+-@am__fastdepCXX_FALSE@	$(CXXCOMPILE) -c -o $@ `$(CYGPATH_W) '$<'`
+-
+-# This directory's subdirectories are mostly independent; you can cd
+-# into them and run `make' without going through this Makefile.
+-# To change the values of `make' variables: instead of editing Makefiles,
+-# (1) if the variable is set in `config.status', edit `config.status'
+-#     (which will cause the Makefiles to be regenerated when you run `make');
+-# (2) otherwise, pass the desired values on the `make' command line.
+-$(RECURSIVE_TARGETS):
+-	@fail= failcom='exit 1'; \
+-	for f in x $$MAKEFLAGS; do \
+-	  case $$f in \
+-	    *=* | --[!k]*);; \
+-	    *k*) failcom='fail=yes';; \
+-	  esac; \
+-	done; \
+-	dot_seen=no; \
+-	target=`echo $@ | sed s/-recursive//`; \
+-	list='$(SUBDIRS)'; for subdir in $$list; do \
+-	  echo "Making $$target in $$subdir"; \
+-	  if test "$$subdir" = "."; then \
+-	    dot_seen=yes; \
+-	    local_target="$$target-am"; \
+-	  else \
+-	    local_target="$$target"; \
+-	  fi; \
+-	  ($(am__cd) $$subdir && $(MAKE) $(AM_MAKEFLAGS) $$local_target) \
+-	  || eval $$failcom; \
+-	done; \
+-	if test "$$dot_seen" = "no"; then \
+-	  $(MAKE) $(AM_MAKEFLAGS) "$$target-am" || exit 1; \
+-	fi; test -z "$$fail"
+-
+-$(RECURSIVE_CLEAN_TARGETS):
+-	@fail= failcom='exit 1'; \
+-	for f in x $$MAKEFLAGS; do \
+-	  case $$f in \
+-	    *=* | --[!k]*);; \
+-	    *k*) failcom='fail=yes';; \
+-	  esac; \
+-	done; \
+-	dot_seen=no; \
+-	case "$@" in \
+-	  distclean-* | maintainer-clean-*) list='$(DIST_SUBDIRS)' ;; \
+-	  *) list='$(SUBDIRS)' ;; \
+-	esac; \
+-	rev=''; for subdir in $$list; do \
+-	  if test "$$subdir" = "."; then :; else \
+-	    rev="$$subdir $$rev"; \
+-	  fi; \
+-	done; \
+-	rev="$$rev ."; \
+-	target=`echo $@ | sed s/-recursive//`; \
+-	for subdir in $$rev; do \
+-	  echo "Making $$target in $$subdir"; \
+-	  if test "$$subdir" = "."; then \
+-	    local_target="$$target-am"; \
+-	  else \
+-	    local_target="$$target"; \
+-	  fi; \
+-	  ($(am__cd) $$subdir && $(MAKE) $(AM_MAKEFLAGS) $$local_target) \
+-	  || eval $$failcom; \
+-	done && test -z "$$fail"
+-tags-recursive:
+-	list='$(SUBDIRS)'; for subdir in $$list; do \
+-	  test "$$subdir" = . || ($(am__cd) $$subdir && $(MAKE) $(AM_MAKEFLAGS) tags); \
+-	done
+-ctags-recursive:
+-	list='$(SUBDIRS)'; for subdir in $$list; do \
+-	  test "$$subdir" = . || ($(am__cd) $$subdir && $(MAKE) $(AM_MAKEFLAGS) ctags); \
+-	done
+-
+-ID: $(HEADERS) $(SOURCES) $(LISP) $(TAGS_FILES)
+-	list='$(SOURCES) $(HEADERS) $(LISP) $(TAGS_FILES)'; \
+-	unique=`for i in $$list; do \
+-	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
+-	  done | \
+-	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
+-	      END { if (nonempty) { for (i in files) print i; }; }'`; \
+-	mkid -fID $$unique
+-tags: TAGS
+-
+-TAGS: tags-recursive $(HEADERS) $(SOURCES)  $(TAGS_DEPENDENCIES) \
+-		$(TAGS_FILES) $(LISP)
+-	set x; \
+-	here=`pwd`; \
+-	if ($(ETAGS) --etags-include --version) >/dev/null 2>&1; then \
+-	  include_option=--etags-include; \
+-	  empty_fix=.; \
+-	else \
+-	  include_option=--include; \
+-	  empty_fix=; \
+-	fi; \
+-	list='$(SUBDIRS)'; for subdir in $$list; do \
+-	  if test "$$subdir" = .; then :; else \
+-	    test ! -f $$subdir/TAGS || \
+-	      set "$$@" "$$include_option=$$here/$$subdir/TAGS"; \
+-	  fi; \
+-	done; \
+-	list='$(SOURCES) $(HEADERS)  $(LISP) $(TAGS_FILES)'; \
+-	unique=`for i in $$list; do \
+-	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
+-	  done | \
+-	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
+-	      END { if (nonempty) { for (i in files) print i; }; }'`; \
+-	shift; \
+-	if test -z "$(ETAGS_ARGS)$$*$$unique"; then :; else \
+-	  test -n "$$unique" || unique=$$empty_fix; \
+-	  if test $$# -gt 0; then \
+-	    $(ETAGS) $(ETAGSFLAGS) $(AM_ETAGSFLAGS) $(ETAGS_ARGS) \
+-	      "$$@" $$unique; \
+-	  else \
+-	    $(ETAGS) $(ETAGSFLAGS) $(AM_ETAGSFLAGS) $(ETAGS_ARGS) \
+-	      $$unique; \
+-	  fi; \
+-	fi
+-ctags: CTAGS
+-CTAGS: ctags-recursive $(HEADERS) $(SOURCES)  $(TAGS_DEPENDENCIES) \
+-		$(TAGS_FILES) $(LISP)
+-	list='$(SOURCES) $(HEADERS)  $(LISP) $(TAGS_FILES)'; \
+-	unique=`for i in $$list; do \
+-	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
+-	  done | \
+-	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
+-	      END { if (nonempty) { for (i in files) print i; }; }'`; \
+-	test -z "$(CTAGS_ARGS)$$unique" \
+-	  || $(CTAGS) $(CTAGSFLAGS) $(AM_CTAGSFLAGS) $(CTAGS_ARGS) \
+-	     $$unique
+-
+-GTAGS:
+-	here=`$(am__cd) $(top_builddir) && pwd` \
+-	  && $(am__cd) $(top_srcdir) \
+-	  && gtags -i $(GTAGS_ARGS) "$$here"
+-
+-distclean-tags:
+-	-rm -f TAGS ID GTAGS GRTAGS GSYMS GPATH tags
+-
+-distdir: $(DISTFILES)
+-	@srcdirstrip=`echo "$(srcdir)" | sed 's/[].[^$$\\*]/\\\\&/g'`; \
+-	topsrcdirstrip=`echo "$(top_srcdir)" | sed 's/[].[^$$\\*]/\\\\&/g'`; \
+-	list='$(DISTFILES)'; \
+-	  dist_files=`for file in $$list; do echo $$file; done | \
+-	  sed -e "s|^$$srcdirstrip/||;t" \
+-	      -e "s|^$$topsrcdirstrip/|$(top_builddir)/|;t"`; \
+-	case $$dist_files in \
+-	  */*) $(MKDIR_P) `echo "$$dist_files" | \
+-			   sed '/\//!d;s|^|$(distdir)/|;s,/[^/]*$$,,' | \
+-			   sort -u` ;; \
+-	esac; \
+-	for file in $$dist_files; do \
+-	  if test -f $$file || test -d $$file; then d=.; else d=$(srcdir); fi; \
+-	  if test -d $$d/$$file; then \
+-	    dir=`echo "/$$file" | sed -e 's,/[^/]*$$,,'`; \
+-	    if test -d "$(distdir)/$$file"; then \
+-	      find "$(distdir)/$$file" -type d ! -perm -700 -exec chmod u+rwx {} \;; \
+-	    fi; \
+-	    if test -d $(srcdir)/$$file && test $$d != $(srcdir); then \
+-	      cp -fpR $(srcdir)/$$file "$(distdir)$$dir" || exit 1; \
+-	      find "$(distdir)/$$file" -type d ! -perm -700 -exec chmod u+rwx {} \;; \
+-	    fi; \
+-	    cp -fpR $$d/$$file "$(distdir)$$dir" || exit 1; \
+-	  else \
+-	    test -f "$(distdir)/$$file" \
+-	    || cp -p $$d/$$file "$(distdir)/$$file" \
+-	    || exit 1; \
+-	  fi; \
+-	done
+-	@list='$(DIST_SUBDIRS)'; for subdir in $$list; do \
+-	  if test "$$subdir" = .; then :; else \
+-	    test -d "$(distdir)/$$subdir" \
+-	    || $(MKDIR_P) "$(distdir)/$$subdir" \
+-	    || exit 1; \
+-	  fi; \
+-	done
+-	@list='$(DIST_SUBDIRS)'; for subdir in $$list; do \
+-	  if test "$$subdir" = .; then :; else \
+-	    dir1=$$subdir; dir2="$(distdir)/$$subdir"; \
+-	    $(am__relativize); \
+-	    new_distdir=$$reldir; \
+-	    dir1=$$subdir; dir2="$(top_distdir)"; \
+-	    $(am__relativize); \
+-	    new_top_distdir=$$reldir; \
+-	    echo " (cd $$subdir && $(MAKE) $(AM_MAKEFLAGS) top_distdir="$$new_top_distdir" distdir="$$new_distdir" \\"; \
+-	    echo "     am__remove_distdir=: am__skip_length_check=: am__skip_mode_fix=: distdir)"; \
+-	    ($(am__cd) $$subdir && \
+-	      $(MAKE) $(AM_MAKEFLAGS) \
+-	        top_distdir="$$new_top_distdir" \
+-	        distdir="$$new_distdir" \
+-		am__remove_distdir=: \
+-		am__skip_length_check=: \
+-		am__skip_mode_fix=: \
+-	        distdir) \
+-	      || exit 1; \
+-	  fi; \
+-	done
+-check-am: all-am
+-check: check-recursive
+-all-am: Makefile $(LIBRARIES)
+-installdirs: installdirs-recursive
+-installdirs-am:
+-install: install-recursive
+-install-exec: install-exec-recursive
+-install-data: install-data-recursive
+-uninstall: uninstall-recursive
+-
+-install-am: all-am
+-	@$(MAKE) $(AM_MAKEFLAGS) install-exec-am install-data-am
+-
+-installcheck: installcheck-recursive
+-install-strip:
+-	$(MAKE) $(AM_MAKEFLAGS) INSTALL_PROGRAM="$(INSTALL_STRIP_PROGRAM)" \
+-	  install_sh_PROGRAM="$(INSTALL_STRIP_PROGRAM)" INSTALL_STRIP_FLAG=-s \
+-	  `test -z '$(STRIP)' || \
+-	    echo "INSTALL_PROGRAM_ENV=STRIPPROG='$(STRIP)'"` install
+-mostlyclean-generic:
+-
+-clean-generic:
+-
+-distclean-generic:
+-	-test -z "$(CONFIG_CLEAN_FILES)" || rm -f $(CONFIG_CLEAN_FILES)
+-	-test . = "$(srcdir)" || test -z "$(CONFIG_CLEAN_VPATH_FILES)" || rm -f $(CONFIG_CLEAN_VPATH_FILES)
+-
+-maintainer-clean-generic:
+-	@echo "This command is intended for maintainers to use"
+-	@echo "it deletes files that may require special tools to rebuild."
+-clean: clean-recursive
+-
+-clean-am: clean-generic clean-noinstLIBRARIES mostlyclean-am
+-
+-distclean: distclean-recursive
+-	-rm -rf ./$(DEPDIR)
+-	-rm -f Makefile
+-distclean-am: clean-am distclean-compile distclean-generic \
+-	distclean-tags
+-
+-dvi: dvi-recursive
+-
+-dvi-am:
+-
+-html: html-recursive
+-
+-html-am:
+-
+-info: info-recursive
+-
+-info-am:
+-
+-install-data-am:
+-
+-install-dvi: install-dvi-recursive
+-
+-install-dvi-am:
+-
+-install-exec-am:
+-
+-install-html: install-html-recursive
+-
+-install-html-am:
+-
+-install-info: install-info-recursive
+-
+-install-info-am:
+-
+-install-man:
+-
+-install-pdf: install-pdf-recursive
+-
+-install-pdf-am:
+-
+-install-ps: install-ps-recursive
+-
+-install-ps-am:
+-
+-installcheck-am:
+-
+-maintainer-clean: maintainer-clean-recursive
+-	-rm -rf ./$(DEPDIR)
+-	-rm -f Makefile
+-maintainer-clean-am: distclean-am maintainer-clean-generic
+-
+-mostlyclean: mostlyclean-recursive
+-
+-mostlyclean-am: mostlyclean-compile mostlyclean-generic
+-
+-pdf: pdf-recursive
+-
+-pdf-am:
+-
+-ps: ps-recursive
+-
+-ps-am:
+-
+-uninstall-am:
+-
+-.MAKE: $(RECURSIVE_CLEAN_TARGETS) $(RECURSIVE_TARGETS) ctags-recursive \
+-	install-am install-strip tags-recursive
+-
+-.PHONY: $(RECURSIVE_CLEAN_TARGETS) $(RECURSIVE_TARGETS) CTAGS GTAGS \
+-	all all-am check check-am clean clean-generic \
+-	clean-noinstLIBRARIES ctags ctags-recursive distclean \
+-	distclean-compile distclean-generic distclean-tags distdir dvi \
+-	dvi-am html html-am info info-am install install-am \
+-	install-data install-data-am install-dvi install-dvi-am \
+-	install-exec install-exec-am install-html install-html-am \
+-	install-info install-info-am install-man install-pdf \
+-	install-pdf-am install-ps install-ps-am install-strip \
+-	installcheck installcheck-am installdirs installdirs-am \
+-	maintainer-clean maintainer-clean-generic mostlyclean \
+-	mostlyclean-compile mostlyclean-generic pdf pdf-am ps ps-am \
+-	tags tags-recursive uninstall uninstall-am
+-
+-
+-# Tell versions [3.59,3.63) of GNU make to not export all variables.
+-# Otherwise a system limit (for SysV at least) may be exceeded.
+-.NOEXPORT:
+diff -Nur dosbox-0.74/src/hardware/memory.cpp dosbox/src/hardware/memory.cpp
+--- dosbox-0.74/src/hardware/memory.cpp	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/hardware/memory.cpp	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,7 +16,6 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: memory.cpp,v 1.56 2009-05-27 09:15:41 qbix79 Exp $ */
+ 
+ #include "dosbox.h"
+ #include "mem.h"
+@@ -428,15 +427,17 @@
+ 
+ /* Memory access functions */
+ Bit16u mem_unalignedreadw(PhysPt address) {
+-	return mem_readb_inline(address) |
+-		mem_readb_inline(address+1) << 8;
++	Bit16u ret = mem_readb_inline(address);
++	ret       |= mem_readb_inline(address+1) << 8;
++	return ret;
+ }
+ 
+ Bit32u mem_unalignedreadd(PhysPt address) {
+-	return mem_readb_inline(address) |
+-		(mem_readb_inline(address+1) << 8) |
+-		(mem_readb_inline(address+2) << 16) |
+-		(mem_readb_inline(address+3) << 24);
++	Bit32u ret = mem_readb_inline(address);
++	ret       |= mem_readb_inline(address+1) << 8;
++	ret       |= mem_readb_inline(address+2) << 16;
++	ret       |= mem_readb_inline(address+3) << 24;
++	return ret;
+ }
+ 
+ 
+diff -Nur dosbox-0.74/src/hardware/mixer.cpp dosbox/src/hardware/mixer.cpp
+--- dosbox-0.74/src/hardware/mixer.cpp	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/hardware/mixer.cpp	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,7 +16,6 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: mixer.cpp,v 1.54 2009-09-05 11:10:04 qbix79 Exp $ */
+ 
+ /* 
+ 	Remove the sdl code from here and have it handeld in the sdlmain.
+@@ -48,6 +47,7 @@
+ #include "mapper.h"
+ #include "hardware.h"
+ #include "programs.h"
++#include "midi.h"
+ 
+ #define MIXER_SSIZE 4
+ #define MIXER_SHIFT 14
+@@ -578,15 +578,7 @@
+ 	}
+ 
+ 	void ListMidi(){
+-#if defined (WIN32)
+-		unsigned int total = midiOutGetNumDevs();	
+-		for(unsigned int i=0;i<total;i++) {
+-			MIDIOUTCAPS mididev;
+-			midiOutGetDevCaps(i, &mididev, sizeof(MIDIOUTCAPS));
+-			WriteOut("%2d\t \"%s\"\n",i,mididev.szPname);
+-		}
+-#endif
+-	return;
++		if(midi.handler) midi.handler->ListAll(this);
+ 	};
+ 
+ };
+@@ -602,7 +594,7 @@
+ 		installed = true;
+ 		return MIXER_AddChannel(handler,freq,name);
+ 	} else {
+-		E_Exit("allready added mixer channel.");
++		E_Exit("already added mixer channel.");
+ 		return 0; //Compiler happy
+ 	}
+ }
+diff -Nur dosbox-0.74/src/hardware/mpu401.cpp dosbox/src/hardware/mpu401.cpp
+--- dosbox-0.74/src/hardware/mpu401.cpp	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/hardware/mpu401.cpp	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2012  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,7 +16,6 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: mpu401.cpp,v 1.29 2009-05-27 09:15:41 qbix79 Exp $ */
+ 
+ #include <string.h>
+ #include "dosbox.h"
+@@ -31,12 +30,15 @@
+ 
+ static void MPU401_Event(Bitu);
+ static void MPU401_Reset(void);
+-static void MPU401_EOIHandler(void);
++static void MPU401_ResetDone(Bitu);
++static void MPU401_EOIHandler(Bitu val=0);
++static void MPU401_EOIHandlerDispatch(void);
+ 
+ #define MPU401_VERSION	0x15
+ #define MPU401_REVISION	0x01
+ #define MPU401_QUEUE 32
+ #define MPU401_TIMECONSTANT (60000000/1000.0f)
++#define MPU401_RESETBUSY 27.0f
+ 
+ enum MpuMode { M_UART,M_INTELLIGENT };
+ enum MpuDataType {T_OVERFLOW,T_MARK,T_MIDI_SYS,T_MIDI_NORM,T_COMMAND};
+@@ -73,8 +75,9 @@
+ 		bool wsd,wsm,wsd_start;
+ 		bool run_irq,irq_pending;
+ 		bool send_now;
++		bool eoi_scheduled;
+ 		Bits data_onoff;
+-		Bitu command_byte;
++		Bitu command_byte,cmd_pending;
+ 		Bit8u tmask,cmask,amask;
+ 		Bit16u midi_mask;
+ 		Bit16u req_mask;
+@@ -113,12 +116,13 @@
+ 
+ static Bitu MPU401_ReadStatus(Bitu port,Bitu iolen) {
+ 	Bit8u ret=0x3f;	/* Bits 6 and 7 clear */
++	if (mpu.state.cmd_pending) ret|=0x40;
+ 	if (!mpu.queue_used) ret|=0x80;
+ 	return ret;
+ }
+ 
+ static void MPU401_WriteCommand(Bitu port,Bitu val,Bitu iolen) {
+-	mpu.state.reset=0;
++	if (mpu.state.reset) {mpu.state.cmd_pending=val+1;return;}
+ 	if (val<=0x2f) {
+ 		switch (val&3) { /* MIDI stop, start, continue */
+ 			case 1: {MIDI_RawOutByte(0xfc);break;}
+@@ -240,12 +244,10 @@
+ 			break;
+ 		case 0xff:	/* Reset MPU-401 */
+ 			LOG(LOG_MISC,LOG_NORMAL)("MPU-401:Reset %X",val);
+-			mpu.state.reset=1;
+-			if (CPU_Cycles > 5) { //It came from the desert wants a fast irq
+-				CPU_CycleLeft += CPU_Cycles;
+-				CPU_Cycles = 5;
+-			}
++			PIC_AddEvent(MPU401_ResetDone,MPU401_RESETBUSY);
++			mpu.state.reset=true;
+ 			MPU401_Reset();
++			if (mpu.mode==M_UART) return;//do not send ack in UART mode
+ 			break;
+ 		case 0x3f:	/* UART mode */
+ 			LOG(LOG_MISC,LOG_NORMAL)("MPU-401:Set UART mode %X",val);
+@@ -285,7 +287,7 @@
+ 	}
+ 	if (ret==MSG_MPU_END || ret==MSG_MPU_CLOCK || ret==MSG_MPU_ACK) {
+ 		mpu.state.data_onoff=-1;
+-		MPU401_EOIHandler();
++		MPU401_EOIHandlerDispatch();
+ 	}
+ 	return ret;
+ }
+@@ -391,7 +393,7 @@
+ 				if (val<0xf0) mpu.state.data_onoff++;
+ 				else {
+ 					mpu.state.data_onoff=-1;
+-					MPU401_EOIHandler();
++					MPU401_EOIHandlerDispatch();
+ 					return;
+ 				}
+ 				if (val==0) mpu.state.send_now=true;
+@@ -403,13 +405,13 @@
+ 				if (val==0xf8 || val==0xf9) mpu.condbuf.type=T_OVERFLOW;
+ 				mpu.condbuf.value[mpu.condbuf.vlength]=val;
+ 				mpu.condbuf.vlength++;
+-				if ((val&0xf0)!=0xe0) MPU401_EOIHandler();
++				if ((val&0xf0)!=0xe0) MPU401_EOIHandlerDispatch();
+ 				else mpu.state.data_onoff++;
+ 				break;
+ 			case  2:/* Command byte #2 */
+ 				mpu.condbuf.value[mpu.condbuf.vlength]=val;
+ 				mpu.condbuf.vlength++;
+-				MPU401_EOIHandler();
++				MPU401_EOIHandlerDispatch();
+ 				break;
+ 		}
+ 		return;
+@@ -421,7 +423,7 @@
+ 			if (val<0xf0) mpu.state.data_onoff=1;
+ 			else {
+ 				mpu.state.data_onoff=-1;
+-				MPU401_EOIHandler();
++				MPU401_EOIHandlerDispatch();
+ 				return;
+ 			}
+ 			if (val==0) mpu.state.send_now=true;
+@@ -462,7 +464,7 @@
+ 				}
+ 			}
+ 			if (!(posd==1 && val>=0xf0)) mpu.playbuf[mpu.state.channel].value[posd-1]=val;
+-			if (posd==length) MPU401_EOIHandler();
++			if (posd==length) MPU401_EOIHandlerDispatch();
+ 	}
+ }
+ 
+@@ -541,7 +543,18 @@
+ 	PIC_AddEvent(MPU401_Event,MPU401_TIMECONSTANT/new_time);
+ }
+ 
+-static void MPU401_EOIHandler(void) {
++
++static void MPU401_EOIHandlerDispatch(void) {
++	if (mpu.state.send_now) {
++		mpu.state.eoi_scheduled=true;
++		PIC_AddEvent(MPU401_EOIHandler,0.06f); //Possible a bit longer
++	}
++	else if (!mpu.state.eoi_scheduled) MPU401_EOIHandler();
++}
++
++//Updates counters and requests new data on "End of Input"
++static void MPU401_EOIHandler(Bitu val) {
++	mpu.state.eoi_scheduled=false;
+ 	if (mpu.state.send_now) {
+ 		mpu.state.send_now=false;
+ 		if (mpu.state.cond_req) UpdateConductor();
+@@ -559,9 +572,18 @@
+ 	} while ((i++)<16);
+ }
+ 
++static void MPU401_ResetDone(Bitu) {
++	mpu.state.reset=false;
++	if (mpu.state.cmd_pending) {
++		MPU401_WriteCommand(0x331,mpu.state.cmd_pending-1,1);
++		mpu.state.cmd_pending=0;
++	}
++}
+ static void MPU401_Reset(void) {
+ 	PIC_DeActivateIRQ(mpu.irq);
+ 	mpu.mode=(mpu.intelligent ? M_INTELLIGENT : M_UART);
++	PIC_RemoveEvents(MPU401_EOIHandler);
++	mpu.state.eoi_scheduled=false;
+ 	mpu.state.wsd=false;
+ 	mpu.state.wsm=false;
+ 	mpu.state.conductor=false;
+diff -Nur dosbox-0.74/src/hardware/opl.cpp dosbox/src/hardware/opl.cpp
+--- dosbox-0.74/src/hardware/opl.cpp	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/hardware/opl.cpp	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *  OPL2/OPL3 emulation library
+  *
+  *  This library is free software; you can redistribute it and/or
+diff -Nur dosbox-0.74/src/hardware/opl.h dosbox/src/hardware/opl.h
+--- dosbox-0.74/src/hardware/opl.h	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/hardware/opl.h	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *  OPL2/OPL3 emulation library
+  *
+  *  This library is free software; you can redistribute it and/or
+diff -Nur dosbox-0.74/src/hardware/pci_bus.cpp dosbox/src/hardware/pci_bus.cpp
+--- dosbox-0.74/src/hardware/pci_bus.cpp	1970-01-01 01:00:00.000000000 +0100
++++ dosbox/src/hardware/pci_bus.cpp	2014-01-12 14:43:47.000000000 +0100
+@@ -0,0 +1,444 @@
++/*
++ *  Copyright (C) 2002-2013  The DOSBox Team
++ *
++ *  This program is free software; you can redistribute it and/or modify
++ *  it under the terms of the GNU General Public License as published by
++ *  the Free Software Foundation; either version 2 of the License, or
++ *  (at your option) any later version.
++ *
++ *  This program is distributed in the hope that it will be useful,
++ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
++ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
++ *  GNU General Public License for more details.
++ *
++ *  You should have received a copy of the GNU General Public License
++ *  along with this program; if not, write to the Free Software
++ *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
++ */
++
++
++#include "dosbox.h"
++#include "inout.h"
++#include "mem.h"
++#include "pci_bus.h"
++#include "setup.h"
++#include "debug.h"
++#include "callback.h"
++#include "regs.h"
++
++
++#if defined(PCI_FUNCTIONALITY_ENABLED)
++
++static Bit32u pci_caddress=0;			// current PCI addressing
++static Bitu pci_devices_installed=0;	// number of registered PCI devices
++
++static Bit8u pci_cfg_data[PCI_MAX_PCIDEVICES][PCI_MAX_PCIFUNCTIONS][256];		// PCI configuration data
++static PCI_Device* pci_devices[PCI_MAX_PCIDEVICES];		// registered PCI devices
++
++
++// PCI address
++// 31    - set for a PCI access
++// 30-24 - 0
++// 23-16 - bus number			(0x00ff0000)
++// 15-11 - device number (slot)	(0x0000f800)
++// 10- 8 - subfunction number	(0x00000700)
++//  7- 2 - config register #	(0x000000fc)
++
++static void write_pci_addr(Bitu port,Bitu val,Bitu iolen) {
++	LOG(LOG_PCI,LOG_NORMAL)("Write PCI address :=%x",val);
++	pci_caddress=val;
++}
++
++static void write_pci_register(PCI_Device* dev,Bit8u regnum,Bit8u value) {
++	// vendor/device/class IDs/header type/etc. are read-only
++	if ((regnum<0x04) || ((regnum>=0x06) && (regnum<0x0c)) || (regnum==0x0e)) return;
++	if (dev==NULL) return;
++	switch (pci_cfg_data[dev->PCIId()][dev->PCISubfunction()][0x0e]&0x7f) {	// header-type specific handling
++		case 0x00:
++			if ((regnum>=0x28) && (regnum<0x30)) return;	// subsystem information is read-only
++			break;
++		case 0x01:
++		case 0x02:
++		default:
++			break;
++	}
++
++	// call device routine for special actions and the
++	// possibility to discard/replace the value that is to be written
++	Bits parsed_register=dev->ParseWriteRegister(regnum,value);
++	if (parsed_register>=0)
++		pci_cfg_data[dev->PCIId()][dev->PCISubfunction()][regnum]=(Bit8u)(parsed_register&0xff);
++}
++
++static void write_pci(Bitu port,Bitu val,Bitu iolen) {
++	LOG(LOG_PCI,LOG_NORMAL)("Write PCI data :=%x (len %d)",port,val,iolen);
++
++	// check for enabled/bus 0
++	if ((pci_caddress & 0x80ff0000) == 0x80000000) {
++		Bit8u devnum = (Bit8u)((pci_caddress >> 11) & 0x1f);
++		Bit8u fctnum = (Bit8u)((pci_caddress >> 8) & 0x7);
++		Bit8u regnum = (Bit8u)((pci_caddress & 0xfc) + (port & 0x03));
++		LOG(LOG_PCI,LOG_NORMAL)("  Write to device %x register %x (function %x) (:=%x)",devnum,regnum,fctnum,val);
++
++		if (devnum>=pci_devices_installed) return;
++		PCI_Device* masterdev=pci_devices[devnum];
++		if (masterdev==NULL) return;
++		if (fctnum>masterdev->NumSubdevices()) return;
++
++		PCI_Device* dev=masterdev->GetSubdevice(fctnum);
++		if (dev==NULL) return;
++
++		// write data to PCI device/configuration
++		switch (iolen) {
++			case 1: write_pci_register(dev,regnum+0,(Bit8u)(val&0xff)); break;
++			case 2: write_pci_register(dev,regnum+0,(Bit8u)(val&0xff));
++					write_pci_register(dev,regnum+1,(Bit8u)((val>>8)&0xff)); break;
++			case 4: write_pci_register(dev,regnum+0,(Bit8u)(val&0xff));
++					write_pci_register(dev,regnum+1,(Bit8u)((val>>8)&0xff));
++					write_pci_register(dev,regnum+2,(Bit8u)((val>>16)&0xff));
++					write_pci_register(dev,regnum+3,(Bit8u)((val>>24)&0xff)); break;
++		}
++	}
++}
++
++
++static Bitu read_pci_addr(Bitu port,Bitu iolen) {
++	LOG(LOG_PCI,LOG_NORMAL)("Read PCI address -> %x",pci_caddress);
++	return pci_caddress;
++}
++
++// read single 8bit value from register file (special register treatment included)
++static Bit8u read_pci_register(PCI_Device* dev,Bit8u regnum) {
++	switch (regnum) {
++		case 0x00:
++			return (Bit8u)(dev->VendorID()&0xff);
++		case 0x01:
++			return (Bit8u)((dev->VendorID()>>8)&0xff);
++		case 0x02:
++			return (Bit8u)(dev->DeviceID()&0xff);
++		case 0x03:
++			return (Bit8u)((dev->DeviceID()>>8)&0xff);
++
++		case 0x0e:
++			return (pci_cfg_data[dev->PCIId()][dev->PCISubfunction()][regnum]&0x7f) |
++						((dev->NumSubdevices()>0)?0x80:0x00);
++		default:
++			break;
++	}
++
++	// call device routine for special actions and possibility to discard/remap register
++	Bits parsed_regnum=dev->ParseReadRegister(regnum);
++	if ((parsed_regnum>=0) && (parsed_regnum<256))
++		return pci_cfg_data[dev->PCIId()][dev->PCISubfunction()][parsed_regnum];
++
++	Bit8u newval, mask;
++	if (dev->OverrideReadRegister(regnum, &newval, &mask)) {
++		Bit8u oldval=pci_cfg_data[dev->PCIId()][dev->PCISubfunction()][regnum] & (~mask);
++		return oldval | (newval & mask);
++	}
++
++	return 0xff;
++}
++
++static Bitu read_pci(Bitu port,Bitu iolen) {
++	LOG(LOG_PCI,LOG_NORMAL)("Read PCI data -> %x",pci_caddress);
++
++	if ((pci_caddress & 0x80ff0000) == 0x80000000) {
++		Bit8u devnum = (Bit8u)((pci_caddress >> 11) & 0x1f);
++		Bit8u fctnum = (Bit8u)((pci_caddress >> 8) & 0x7);
++		Bit8u regnum = (Bit8u)((pci_caddress & 0xfc) + (port & 0x03));
++		if (devnum>=pci_devices_installed) return 0xffffffff;
++		LOG(LOG_PCI,LOG_NORMAL)("  Read from device %x register %x (function %x); addr %x",
++			devnum,regnum,fctnum,pci_caddress);
++
++		PCI_Device* masterdev=pci_devices[devnum];
++		if (masterdev==NULL) return 0xffffffff;
++		if (fctnum>masterdev->NumSubdevices()) return 0xffffffff;
++
++		PCI_Device* dev=masterdev->GetSubdevice(fctnum);
++
++		if (dev!=NULL) {
++			switch (iolen) {
++				case 1:
++					{
++						Bit8u val8=read_pci_register(dev,regnum);
++						return val8;
++					}
++				case 2:
++					{
++						Bit16u val16=read_pci_register(dev,regnum);
++						val16|=(read_pci_register(dev,regnum+1)<<8);
++						return val16;
++					}
++				case 4:
++					{
++						Bit32u val32=read_pci_register(dev,regnum);
++						val32|=(read_pci_register(dev,regnum+1)<<8);
++						val32|=(read_pci_register(dev,regnum+2)<<16);
++						val32|=(read_pci_register(dev,regnum+3)<<24);
++						return val32;
++					}
++				default:
++					break;
++			}
++		}
++	}
++	return 0xffffffff;
++}
++
++
++static Bitu PCI_PM_Handler() {
++	LOG_MSG("PCI PMode handler, function %x",reg_ax);
++	return CBRET_NONE;
++}
++
++
++PCI_Device::PCI_Device(Bit16u vendor, Bit16u device) {
++	pci_id=-1;
++	pci_subfunction=-1;
++	vendor_id=vendor;
++	device_id=device;
++	num_subdevices=0;
++	for (Bitu dct=0;dct<PCI_MAX_PCIFUNCTIONS-1;dct++) subdevices[dct]=0;
++}
++
++void PCI_Device::SetPCIId(Bitu number, Bits subfct) {
++	if ((number>=0) && (number<PCI_MAX_PCIDEVICES)) {
++		pci_id=number;
++		if ((subfct>=0) && (subfct<PCI_MAX_PCIFUNCTIONS-1))
++			pci_subfunction=subfct;
++		else
++			pci_subfunction=-1;
++	}
++}
++
++bool PCI_Device::AddSubdevice(PCI_Device* dev) {
++	if (num_subdevices<PCI_MAX_PCIFUNCTIONS-1) {
++		if (subdevices[num_subdevices]!=NULL) E_Exit("PCI subdevice slot already in use!");
++		subdevices[num_subdevices]=dev;
++		num_subdevices++;
++		return true;
++	}
++	return false;
++}
++
++void PCI_Device::RemoveSubdevice(Bits subfct) {
++	if ((subfct>0) && (subfct<PCI_MAX_PCIFUNCTIONS)) {
++		if (subfct<=this->NumSubdevices()) {
++			delete subdevices[subfct-1];
++			subdevices[subfct-1]=NULL;
++			// should adjust things like num_subdevices as well...
++		}
++	}
++}
++
++PCI_Device* PCI_Device::GetSubdevice(Bits subfct) {
++	if (subfct>=PCI_MAX_PCIFUNCTIONS) return NULL;
++	if (subfct>0) {
++		if (subfct<=this->NumSubdevices()) return subdevices[subfct-1];
++	} else if (subfct==0) {
++		return this;
++	}
++	return NULL;
++}
++
++
++// queued devices (PCI device registering requested before the PCI framework was initialized)
++static const Bitu max_rqueued_devices=16;
++static Bitu num_rqueued_devices=0;
++static PCI_Device* rqueued_devices[max_rqueued_devices];
++
++
++#include "pci_devices.h"
++
++class PCI:public Module_base{
++private:
++	bool initialized;
++
++protected:
++	IO_WriteHandleObject PCI_WriteHandler[5];
++	IO_ReadHandleObject PCI_ReadHandler[5];
++
++	CALLBACK_HandlerObject callback_pci;
++
++public:
++
++	PhysPt GetPModeCallbackPointer(void) {
++		return Real2Phys(callback_pci.Get_RealPointer());
++	}
++
++	bool IsInitialized(void) {
++		return initialized;
++	}
++
++	// set up port handlers and configuration data
++	void InitializePCI(void) {
++		// install PCI-addressing ports
++		PCI_WriteHandler[0].Install(0xcf8,write_pci_addr,IO_MD);
++		PCI_ReadHandler[0].Install(0xcf8,read_pci_addr,IO_MD);
++		// install PCI-register read/write handlers
++		for (Bitu ct=0;ct<4;ct++) {
++			PCI_WriteHandler[1+ct].Install(0xcfc+ct,write_pci,IO_MB);
++			PCI_ReadHandler[1+ct].Install(0xcfc+ct,read_pci,IO_MB);
++		}
++
++		for (Bitu dev=0; dev<PCI_MAX_PCIDEVICES; dev++)
++			for (Bitu fct=0; fct<PCI_MAX_PCIFUNCTIONS-1; fct++)
++				for (Bitu reg=0; reg<256; reg++)
++					pci_cfg_data[dev][fct][reg] = 0;
++
++		callback_pci.Install(&PCI_PM_Handler,CB_IRETD,"PCI PM");
++
++		initialized=true;
++	}
++
++	// register PCI device to bus and setup data
++	Bits RegisterPCIDevice(PCI_Device* device, Bits slot=-1) {
++		if (device==NULL) return -1;
++
++		if (slot>=0) {
++			// specific slot specified, basic check for validity
++			if (slot>=PCI_MAX_PCIDEVICES) return -1;
++		} else {
++			// auto-add to new slot, check if one is still free
++			if (pci_devices_installed>=PCI_MAX_PCIDEVICES) return -1;
++		}
++
++		if (!initialized) InitializePCI();
++
++		if (slot<0) slot=pci_devices_installed;	// use next slot
++		Bits subfunction=0;	// main device unless specific already-occupied slot is requested
++		if (pci_devices[slot]!=NULL) {
++			subfunction=pci_devices[slot]->GetNextSubdeviceNumber();
++			if (subfunction<0) E_Exit("Too many PCI subdevices!");
++		}
++
++		if (device->InitializeRegisters(pci_cfg_data[slot][subfunction])) {
++			device->SetPCIId(slot, subfunction);
++			if (pci_devices[slot]==NULL) {
++				pci_devices[slot]=device;
++				pci_devices_installed++;
++			} else {
++				pci_devices[slot]->AddSubdevice(device);
++			}
++
++			return slot;
++		}
++
++		return -1;
++	}
++
++	void Deinitialize(void) {
++		initialized=false;
++		pci_devices_installed=0;
++		num_rqueued_devices=0;
++		pci_caddress=0;
++
++		for (Bitu dev=0; dev<PCI_MAX_PCIDEVICES; dev++)
++			for (Bitu fct=0; fct<PCI_MAX_PCIFUNCTIONS-1; fct++)
++				for (Bitu reg=0; reg<256; reg++)
++					pci_cfg_data[dev][fct][reg] = 0;
++
++		// install PCI-addressing ports
++		PCI_WriteHandler[0].Uninstall();
++		PCI_ReadHandler[0].Uninstall();
++		// install PCI-register read/write handlers
++		for (Bitu ct=0;ct<4;ct++) {
++			PCI_WriteHandler[1+ct].Uninstall();
++			PCI_ReadHandler[1+ct].Uninstall();
++		}
++
++		callback_pci.Uninstall();
++	}
++
++	void RemoveDevice(Bit16u vendor_id, Bit16u device_id) {
++		for (Bitu dct=0;dct<pci_devices_installed;dct++) {
++			if (pci_devices[dct]!=NULL) {
++				if (pci_devices[dct]->NumSubdevices()>0) {
++					for (Bitu sct=1;sct<PCI_MAX_PCIFUNCTIONS;sct++) {
++						PCI_Device* sdev=pci_devices[dct]->GetSubdevice(sct);
++						if (sdev!=NULL) {
++							if ((sdev->VendorID()==vendor_id) && (sdev->DeviceID()==device_id)) {
++								pci_devices[dct]->RemoveSubdevice(sct);
++							}
++						}
++					}
++				}
++
++				if ((pci_devices[dct]->VendorID()==vendor_id) && (pci_devices[dct]->DeviceID()==device_id)) {
++					delete pci_devices[dct];
++					pci_devices[dct]=NULL;
++				}
++			}
++		}
++
++		// check if all devices have been removed
++		bool any_device_left=false;
++		for (Bitu dct=0;dct<PCI_MAX_PCIDEVICES;dct++) {
++			if (dct>=pci_devices_installed) break;
++			if (pci_devices[dct]!=NULL) {
++				any_device_left=true;
++				break;
++			}
++		}
++		if (!any_device_left) Deinitialize();
++
++		Bitu last_active_device=PCI_MAX_PCIDEVICES;
++		for (Bitu dct=0;dct<PCI_MAX_PCIDEVICES;dct++) {
++			if (pci_devices[dct]!=NULL) last_active_device=dct;
++		}
++		if (last_active_device<pci_devices_installed)
++			pci_devices_installed=last_active_device+1;
++	}
++
++	PCI(Section* configuration):Module_base(configuration) {
++		initialized=false;
++		pci_devices_installed=0;
++
++		for (Bitu devct=0;devct<PCI_MAX_PCIDEVICES;devct++)
++			pci_devices[devct]=NULL;
++
++		if (num_rqueued_devices>0) {
++			// register all devices that have been added before the PCI bus was instantiated
++			for (Bitu dct=0;dct<num_rqueued_devices;dct++) {
++				this->RegisterPCIDevice(rqueued_devices[dct]);
++			}
++			num_rqueued_devices=0;
++		}
++	}
++
++	~PCI(){
++		initialized=false;
++		pci_devices_installed=0;
++		num_rqueued_devices=0;
++	}
++
++};
++
++static PCI* pci_interface=NULL;
++
++
++PhysPt PCI_GetPModeInterface(void) {
++	if (pci_interface) {
++		return pci_interface->GetPModeCallbackPointer();
++	}
++	return 0;
++}
++
++bool PCI_IsInitialized() {
++	if (pci_interface) return pci_interface->IsInitialized();
++	return false;
++}
++
++
++void PCI_ShutDown(Section* sec){
++	delete pci_interface;
++	pci_interface=NULL;
++}
++
++void PCI_Init(Section* sec) {
++	pci_interface = new PCI(sec);
++	sec->AddDestroyFunction(&PCI_ShutDown,false);
++}
++
++#endif
+diff -Nur dosbox-0.74/src/hardware/pci_devices.h dosbox/src/hardware/pci_devices.h
+--- dosbox-0.74/src/hardware/pci_devices.h	1970-01-01 01:00:00.000000000 +0100
++++ dosbox/src/hardware/pci_devices.h	2014-01-12 14:43:47.000000000 +0100
+@@ -0,0 +1,18 @@
++/*
++ *  Copyright (C) 2002-2013  The DOSBox Team
++ *
++ *  This program is free software; you can redistribute it and/or modify
++ *  it under the terms of the GNU General Public License as published by
++ *  the Free Software Foundation; either version 2 of the License, or
++ *  (at your option) any later version.
++ *
++ *  This program is distributed in the hope that it will be useful,
++ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
++ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
++ *  GNU General Public License for more details.
++ *
++ *  You should have received a copy of the GNU General Public License
++ *  along with this program; if not, write to the Free Software
++ *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
++ */
++
+diff -Nur dosbox-0.74/src/hardware/pcspeaker.cpp dosbox/src/hardware/pcspeaker.cpp
+--- dosbox-0.74/src/hardware/pcspeaker.cpp	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/hardware/pcspeaker.cpp	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,7 +16,6 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+  
+- /* $Id: pcspeaker.cpp,v 1.26 2009-05-27 09:15:41 qbix79 Exp $ */
+ 
+ #include <math.h>
+ #include "dosbox.h"
+diff -Nur dosbox-0.74/src/hardware/pic.cpp dosbox/src/hardware/pic.cpp
+--- dosbox-0.74/src/hardware/pic.cpp	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/hardware/pic.cpp	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,10 +16,6 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: pic.cpp,v 1.44 2009-05-27 09:15:41 qbix79 Exp $ */
+-
+-#include <list>
+-
+ #include "dosbox.h"
+ #include "inout.h"
+ #include "cpu.h"
+@@ -30,35 +26,144 @@
+ 
+ #define PIC_QUEUESIZE 512
+ 
+-struct IRQ_Block {
+-	bool masked;
+-	bool active;
+-	bool inservice;
+-	Bitu vector;
+-};
+-
+ struct PIC_Controller {
+ 	Bitu icw_words;
+ 	Bitu icw_index;
+-	Bitu masked;
+-
+ 	bool special;
+ 	bool auto_eoi;
+ 	bool rotate_on_auto_eoi;
+ 	bool single;
+ 	bool request_issr;
+ 	Bit8u vector_base;
+-};
+ 
+-Bitu PIC_Ticks=0;
+-Bitu PIC_IRQCheck;
+-Bitu PIC_IRQOnSecondPicActive;
+-Bitu PIC_IRQActive;
++	Bit8u irr;        // request register
++	Bit8u imr;        // mask register
++	Bit8u imrr;       // mask register reversed (makes bit tests simpler)
++	Bit8u isr;        // in service register
++	Bit8u isrr;       // in service register reversed (makes bit tests simpler)
++	Bit8u active_irq; //currently active irq
++
++
++	void set_imr(Bit8u val);
++
++	void check_after_EOI(){
++		//Update the active_irq as an EOI is likely to change that.
++		update_active_irq();
++		if((irr&imrr)&isrr) check_for_irq();
++	}
++
++	void update_active_irq() {
++		if(isr == 0) {active_irq = 8; return;}
++		for(Bit8u i = 0, s = 1; i < 8;i++, s<<=1){
++			if( isr & s){
++				active_irq = i;
++				return;
++			}
++		}
++	}
++
++	void check_for_irq(){
++		const Bit8u possible_irq = (irr&imrr)&isrr;
++		if (possible_irq) {
++			const Bit8u a_irq = special?8:active_irq;
++			for(Bit8u i = 0, s = 1; i < a_irq;i++, s<<=1){
++				if ( possible_irq & s ) {
++					//There is an irq ready to be served => signal master and/or cpu
++					activate();
++					return;
++				}
++			}
++		}
++		deactivate(); //No irq, remove signal to master and/or cpu
++	}
++
++	//Signals master/cpu that there is an irq ready.
++	void activate();
+ 
++	//Removes signal to master/cpu that there is an irq ready.
++	void deactivate();
++
++	void raise_irq(Bit8u val){
++		Bit8u bit = 1 << (val);
++		if((irr & bit)==0) { //value changed (as it is currently not active)
++			irr|=bit;
++			if((bit&imrr)&isrr) { //not masked and not in service
++				if(special || val < active_irq) activate();
++			}
++		}
++	}
++
++	void lower_irq(Bit8u val){
++		Bit8u bit = 1 << ( val);
++		if(irr & bit) { //value will change (as it is currently active)
++			irr&=~bit;
++			if((bit&imrr)&isrr) { //not masked and not in service
++				//This irq might have toggled PIC_IRQCheck/caused irq 2 on master, when it was raised.
++				//If it is active, then recheck it, we can't just deactivate as there might be more IRQS raised.
++				if(special || val < active_irq) check_for_irq();
++			}
++		}
++	}
++
++	//handles all bits and logic related to starting this IRQ, it does NOT start the interrupt on the CPU.
++	void start_irq(Bit8u val);
++};
+ 
+-static IRQ_Block irqs[16];
+ static PIC_Controller pics[2];
+-static bool PIC_Special_Mode = false; //Saves one compare in the pic_run_irqloop
++static PIC_Controller& master = pics[0];
++static PIC_Controller& slave  = pics[1];
++Bitu PIC_Ticks = 0;
++Bitu PIC_IRQCheck = 0; //Maybe make it a bool and/or ensure 32bit size (x86 dynamic core seems to assume 32 bit variable size)
++
++
++void PIC_Controller::set_imr(Bit8u val) {
++	if (GCC_UNLIKELY(machine==MCH_PCJR)) {
++		//irq 6 is a NMI on the PCJR
++		if (this == &master) val &= ~(1 <<(6));
++	}
++	Bit8u change = (imr) ^ (val); //Bits that have changed become 1.
++	imr  =  val;
++	imrr = ~val;
++
++	//Test if changed bits are set in irr and are not being served at the moment
++	//Those bits have impact on whether the cpu emulation should be paused or not.
++	if((irr & change)&isrr) check_for_irq();
++}
++
++void PIC_Controller::activate() { 
++	//Stops CPU if master, signals master if slave
++	if(this == &master) {
++		PIC_IRQCheck = 1;
++		//cycles 0, take care of the port IO stuff added in raise_irq base caller.
++		CPU_CycleLeft += CPU_Cycles;
++		CPU_Cycles = 0;
++		//maybe when coming from a EOI, give a tiny delay. (for the cpu to pick it up) (see PIC_Activate_IRQ)
++	} else {
++		master.raise_irq(2);
++	}
++}
++
++void PIC_Controller::deactivate() { 
++	//removes irq check value  if master, signals master if slave
++	if(this == &master) {
++		PIC_IRQCheck = 0;
++	} else {
++		master.lower_irq(2);
++	}
++}
++
++void PIC_Controller::start_irq(Bit8u val){
++	irr&=~(1<<(val));
++	if (!auto_eoi) {
++		active_irq = val;
++		isr |= 1<<(val);
++		isrr = ~isr;
++	} else if (GCC_UNLIKELY(rotate_on_auto_eoi)) {
++		E_Exit("rotate on auto EOI not handled");
++	}
++}
++
++
+ struct PICEntry {
+ 	float index;
+ 	Bitu value;
+@@ -74,10 +179,7 @@
+ 
+ static void write_command(Bitu port,Bitu val,Bitu iolen) {
+ 	PIC_Controller * pic=&pics[port==0x20 ? 0 : 1];
+-	Bitu irq_base=port==0x20 ? 0 : 8;
+-	Bitu i;
+-	static Bit16u IRQ_priority_table[16] = 
+-		{ 0,1,2,8,9,10,11,12,13,14,15,3,4,5,6,7 };
++
+ 	if (GCC_UNLIKELY(val&0x10)) {		// ICW1 issued
+ 		if (val&0x04) E_Exit("PIC: 4 byte interval not handled");
+ 		if (val&0x08) E_Exit("PIC: level triggered mode not handled");
+@@ -92,42 +194,26 @@
+ 			else pic->request_issr=false;			/* select read interrupt request register */
+ 		}
+ 		if (val&0x40) {		// special mask select
+-			if (val&0x20) pic->special=true;
+-			else pic->special=false;
+-			if(pic[0].special || pics[1].special) 
+-				PIC_Special_Mode = true; else 
+-				PIC_Special_Mode = false;
+-			if (PIC_IRQCheck) { //Recheck irqs
+-				CPU_CycleLeft += CPU_Cycles;
+-				CPU_Cycles = 0;
+-			}
++			if (val&0x20) pic->special = true;
++			else pic->special = false;
++			//Check if there are irqs ready to run, as the priority system has possibly been changed.
++			pic->check_for_irq();
+ 			LOG(LOG_PIC,LOG_NORMAL)("port %X : special mask %s",port,(pic->special)?"ON":"OFF");
+ 		}
+ 	} else {	// OCW2 issued
+ 		if (val&0x20) {		// EOI commands
+ 			if (GCC_UNLIKELY(val&0x80)) E_Exit("rotate mode not supported");
+ 			if (val&0x40) {		// specific EOI
+-				if (PIC_IRQActive==(irq_base+val-0x60U)) {
+-					irqs[PIC_IRQActive].inservice=false;
+-					PIC_IRQActive=PIC_NOIRQ;
+-					for (i=0; i<=15; i++) {
+-						if (irqs[IRQ_priority_table[i]].inservice) {
+-							PIC_IRQActive=IRQ_priority_table[i];
+-							break;
+-						}
+-					}
+-				}
++				pic->isr &= ~(1<< ((val-0x60)));
++				pic->isrr = ~pic->isr;
++				pic->check_after_EOI();
+ //				if (val&0x80);	// perform rotation
+ 			} else {		// nonspecific EOI
+-				if (PIC_IRQActive<(irq_base+8)) {
+-					irqs[PIC_IRQActive].inservice=false;
+-					PIC_IRQActive=PIC_NOIRQ;
+-					for (i=0; i<=15; i++){
+-						if(GCC_UNLIKELY(irqs[IRQ_priority_table[i]].inservice)) {
+-							PIC_IRQActive=IRQ_priority_table[i];
+-							break;
+-						}
+-					}
++				if (pic->active_irq != 8) { 
++					//If there is no irq in service, ignore the call, some games send an eoi to both pics when a sound irq happens (regardless of the irq).
++					pic->isr &= ~(1 << (pic->active_irq));
++					pic->isrr = ~pic->isr;
++					pic->check_after_EOI();
+ 				}
+ //				if (val&0x80);	// perform rotation
+ 			}
+@@ -144,43 +230,13 @@
+ 
+ static void write_data(Bitu port,Bitu val,Bitu iolen) {
+ 	PIC_Controller * pic=&pics[port==0x21 ? 0 : 1];
+-	Bitu irq_base=(port==0x21) ? 0 : 8;
+-	Bitu i;
+-	bool old_irq2_mask = irqs[2].masked;
+ 	switch(pic->icw_index) {
+ 	case 0:                        /* mask register */
+-		LOG(LOG_PIC,LOG_NORMAL)("%d mask %X",port==0x21 ? 0 : 1,val);
+-		for (i=0;i<=7;i++) {
+-			irqs[i+irq_base].masked=(val&(1<<i))>0;
+-			if(port==0x21) {
+-				if (irqs[i+irq_base].active && !irqs[i+irq_base].masked) PIC_IRQCheck|=(1 << (i+irq_base));
+-				else PIC_IRQCheck&=~(1 << (i+irq_base));
+-			} else {
+-				if (irqs[i+irq_base].active && !irqs[i+irq_base].masked && !irqs[2].masked) PIC_IRQCheck|=(1 << (i+irq_base));
+-				else PIC_IRQCheck&=~(1 << (i+irq_base));
+-			}
+-		}
+-		if (machine==MCH_PCJR) {
+-			/* irq6 cannot be disabled as it serves as pseudo-NMI */
+-			irqs[6].masked=false;
+-		}
+-		if(irqs[2].masked != old_irq2_mask) {
+-		/* Irq 2 mask has changed recheck second pic */
+-			for(i=8;i<=15;i++) {
+-				if (irqs[i].active && !irqs[i].masked && !irqs[2].masked) PIC_IRQCheck|=(1 << (i));
+-				else PIC_IRQCheck&=~(1 << (i));
+-			}
+-		}
+-		if (PIC_IRQCheck) {
+-			CPU_CycleLeft+=CPU_Cycles;
+-			CPU_Cycles=0;
+-		}
++		pic->set_imr(val);
+ 		break;
+ 	case 1:                        /* icw2          */
+ 		LOG(LOG_PIC,LOG_NORMAL)("%d:Base vector %X",port==0x21 ? 0 : 1,val);
+-		for (i=0;i<=7;i++) {
+-			irqs[i+irq_base].vector=(val&0xf8)+i;
+-		};
++		pic->vector_base = val&0xf8;
+ 		if(pic->icw_index++ >= pic->icw_words) pic->icw_index=0;
+ 		else if(pic->single) pic->icw_index=3;		/* skip ICW3 in single mode */
+ 		break;
+@@ -215,71 +271,70 @@
+ 
+ static Bitu read_command(Bitu port,Bitu iolen) {
+ 	PIC_Controller * pic=&pics[port==0x20 ? 0 : 1];
+-	Bitu irq_base=(port==0x20) ? 0 : 8;
+-	Bitu i;Bit8u ret=0;Bit8u b=1;
+-	if (pic->request_issr) {
+-		for (i=irq_base;i<irq_base+8;i++) {
+-			if (irqs[i].inservice) ret|=b;
+-			b <<= 1;
+-		}
+-	} else {
+-		for (i=irq_base;i<irq_base+8;i++) {
+-			if (irqs[i].active)	ret|=b;
+-			b <<= 1;
+-		}
+-		if (irq_base==0 && (PIC_IRQCheck&0xff00)) ret |=4;
++	if (pic->request_issr){
++		return pic->isr;
++	} else { 
++		return pic->irr;
+ 	}
+-	return ret;
+ }
+ 
++
+ static Bitu read_data(Bitu port,Bitu iolen) {
+-	Bitu irq_base=(port==0x21) ? 0 : 8;
+-	Bitu i;Bit8u ret=0;Bit8u b=1;
+-	for (i=irq_base;i<=irq_base+7;i++) {
+-		if (irqs[i].masked)	ret|=b;
+-		b <<= 1;
+-	}
+-	return ret;
++	PIC_Controller * pic=&pics[port==0x21 ? 0 : 1];
++	return pic->imr;
+ }
+ 
+-
+ void PIC_ActivateIRQ(Bitu irq) {
+-	if( irq < 8 ) {
+-		irqs[irq].active = true;
+-		if (!irqs[irq].masked) {
+-			PIC_IRQCheck|=(1 << irq);
+-		}
+-	} else 	if (irq < 16) {
+-		irqs[irq].active = true;
+-		PIC_IRQOnSecondPicActive|=(1 << irq);
+-		if (!irqs[irq].masked && !irqs[2].masked) {
+-			PIC_IRQCheck|=(1 << irq);
+-		}
++	Bitu t = irq>7 ? (irq - 8): irq;
++	PIC_Controller * pic=&pics[irq>7 ? 1 : 0];
++
++	Bit32s OldCycles = CPU_Cycles;
++	pic->raise_irq(t); //Will set the CPU_Cycles to zero if this IRQ will be handled directly
++
++	if (GCC_UNLIKELY(OldCycles != CPU_Cycles)) {
++		// if CPU_Cycles have changed, this means that the interrupt was triggered by an I/O
++		// register write rather than an event.
++		// Real hardware executes 0 to ~13 NOPs or comparable instructions
++		// before the processor picks up the interrupt. Let's try with 2
++		// cycles here.
++		// Required by Panic demo (irq0), It came from the desert (MPU401)
++		// Does it matter if CPU_CycleLeft becomes negative?
++
++		// It might be an idea to do this always in order to simulate this
++		// So on write mask and EOI as well. (so inside the activate function)
++//		CPU_CycleLeft += (CPU_Cycles-2);
++		CPU_CycleLeft -= 2;
++		CPU_Cycles = 2;
+ 	}
+ }
+ 
+ void PIC_DeActivateIRQ(Bitu irq) {
+-	if (irq<16) {
+-		irqs[irq].active=false;
+-		PIC_IRQCheck&=~(1 << irq);
+-		PIC_IRQOnSecondPicActive&=~(1 << irq);
+-	}
+-}
+-static inline bool PIC_startIRQ(Bitu i) {
+-	/* irqs on second pic only if irq 2 isn't masked */
+-	if( i > 7 && irqs[2].masked) return false;
+-	irqs[i].active = false;
+-	PIC_IRQCheck&= ~(1 << i);
+-	PIC_IRQOnSecondPicActive&= ~(1 << i);
+-	CPU_HW_Interrupt(irqs[i].vector);
+-	Bitu pic=(i&8)>>3;
+-	if (!pics[pic].auto_eoi) { //irq 0-7 => pic 0 else pic 1 
+-		PIC_IRQActive = i;
+-		irqs[i].inservice = true;
+-	} else if (GCC_UNLIKELY(pics[pic].rotate_on_auto_eoi)) {
+-		E_Exit("rotate on auto EOI not handled");
++	Bitu t = irq>7 ? (irq - 8): irq;
++	PIC_Controller * pic=&pics[irq>7 ? 1 : 0];
++	pic->lower_irq(t);
++}
++
++static void slave_startIRQ(){
++	Bit8u pic1_irq = 8;
++	const Bit8u p = (slave.irr & slave.imrr)&slave.isrr;
++	const Bit8u max = slave.special?8:slave.active_irq;
++	for(Bit8u i = 0,s = 1;i < max;i++, s<<=1){
++		if (p&s){
++			pic1_irq = i;
++			break;
++		}
+ 	}
+-	return true;
++	// Maybe change the E_Exit to a return
++	if (GCC_UNLIKELY(pic1_irq == 8)) E_Exit("irq 2 is active, but no irq active on the slave PIC.");
++
++	slave.start_irq(pic1_irq);
++	master.start_irq(2);
++	CPU_HW_Interrupt(slave.vector_base + pic1_irq);
++}
++
++static void inline master_startIRQ(Bitu i){
++	master.start_irq(i);
++	CPU_HW_Interrupt(master.vector_base + i);
+ }
+ 
+ void PIC_runIRQs(void) {
+@@ -287,70 +342,31 @@
+ 	if (GCC_UNLIKELY(!PIC_IRQCheck)) return;
+ 	if (GCC_UNLIKELY(cpudecoder==CPU_Core_Normal_Trap_Run)) return;
+ 
+-	static Bitu IRQ_priority_order[16] = 
+-		{ 0,1,2,8,9,10,11,12,13,14,15,3,4,5,6,7 };
+-	static Bit16u IRQ_priority_lookup[17] =
+-		{ 0,1,2,11,12,13,14,15,3,4,5,6,7,8,9,10,16 };
+-	Bit16u activeIRQ = PIC_IRQActive;
+-	if (activeIRQ == PIC_NOIRQ) activeIRQ = 16;
+-	/* Get the priority of the active irq */
+-	Bit16u Priority_Active_IRQ = IRQ_priority_lookup[activeIRQ];
+-
+-	Bitu i,j;
+-	/* j is the priority (walker)
+-	 * i is the irq at the current priority */
+-
+-	/* If one of the pics is in special mode use a check that cares for that. */
+-	if(!PIC_Special_Mode) {
+-		for (j = 0; j < Priority_Active_IRQ; j++) {
+-			i = IRQ_priority_order[j];
+-			if (!irqs[i].masked && irqs[i].active) {
+-				if(GCC_LIKELY(PIC_startIRQ(i))) return;
+-			}
+-		}
+-	} else {	/* Special mode variant */
+-		for (j = 0; j<= 15; j++) {
+-			i = IRQ_priority_order[j];
+-			if ( (j < Priority_Active_IRQ) || (pics[ ((i&8)>>3) ].special) ) {
+-				if (!irqs[i].masked && irqs[i].active) {
+-					/* the irq line is active. it's not masked and
+-					 * the irq is allowed priority wise. So let's start it */
+-					/* If started successfully return, else go for the next */
+-					if(PIC_startIRQ(i)) return;
+-				}
++	const Bit8u p = (master.irr & master.imrr)&master.isrr;
++	const Bit8u max = master.special?8:master.active_irq;
++	for(Bit8u i = 0,s = 1;i < max;i++, s<<=1){
++		if (p&s){
++			if (i==2) { //second pic
++				slave_startIRQ();
++			} else {
++				master_startIRQ(i);
+ 			}
++			break;
+ 		}
+ 	}
++	//Disable check variable.
++	PIC_IRQCheck = 0;
+ }
+ 
+ void PIC_SetIRQMask(Bitu irq, bool masked) {
+-	if(irqs[irq].masked == masked) return;	/* Do nothing if mask doesn't change */
+-	bool old_irq2_mask = irqs[2].masked;
+-	irqs[irq].masked=masked;
+-	if(irq < 8) {
+-		if (irqs[irq].active && !irqs[irq].masked) { 
+-			PIC_IRQCheck|=(1 << (irq));
+-		} else { 
+-			PIC_IRQCheck&=~(1 << (irq));
+-		}
+-	} else {
+-		if (irqs[irq].active && !irqs[irq].masked && !irqs[2].masked) {
+-			PIC_IRQCheck|=(1 << (irq));
+-		} else { 
+-			PIC_IRQCheck&=~(1 << (irq));
+-		}
+-	}
+-	if(irqs[2].masked != old_irq2_mask) {
+-	/* Irq 2 mask has changed recheck second pic */
+-		for(Bitu i=8;i<=15;i++) {
+-			if (irqs[i].active && !irqs[i].masked && !irqs[2].masked) PIC_IRQCheck|=(1 << (i));
+-			else PIC_IRQCheck&=~(1 << (i));
+-		}
+-	}
+-	if (PIC_IRQCheck) {
+-		CPU_CycleLeft+=CPU_Cycles;
+-		CPU_Cycles=0;
+-	}
++	Bitu t = irq>7 ? (irq - 8): irq;
++	PIC_Controller * pic=&pics[irq>7 ? 1 : 0];
++	//clear bit
++	Bit8u bit = 1 <<(t);
++	Bit8u newmask = pic->imr;
++	newmask &= ~bit;
++	if (masked) newmask |= bit;
++	pic->set_imr(newmask);
+ }
+ 
+ static void AddEntry(PICEntry * entry) {
+@@ -453,7 +469,7 @@
+ 
+ 
+ bool PIC_RunQueue(void) {
+-	/* Check to see if a new milisecond needs to be started */
++	/* Check to see if a new millisecond needs to be started */
+ 	CPU_CycleLeft+=CPU_Cycles;
+ 	CPU_Cycles=0;
+ 	if (CPU_CycleLeft<=0) {
+@@ -540,20 +556,18 @@
+ 	}
+ }
+ 
+-
+-class PIC:public Module_base{
++/* Use full name to avoid name clash with compile option for position-independent code */
++class PIC_8259A: public Module_base {
+ private:
+ 	IO_ReadHandleObject ReadHandler[4];
+ 	IO_WriteHandleObject WriteHandler[4];
+ public:
+-	PIC(Section* configuration):Module_base(configuration){
++	PIC_8259A(Section* configuration):Module_base(configuration){
+ 		/* Setup pic0 and pic1 with initial values like DOS has normally */
+ 		PIC_IRQCheck=0;
+-		PIC_IRQActive=PIC_NOIRQ;
+ 		PIC_Ticks=0;
+ 		Bitu i;
+ 		for (i=0;i<2;i++) {
+-			pics[i].masked=0xff;
+ 			pics[i].auto_eoi=false;
+ 			pics[i].rotate_on_auto_eoi=false;
+ 			pics[i].request_issr=false;
+@@ -561,24 +575,21 @@
+ 			pics[i].single=false;
+ 			pics[i].icw_index=0;
+ 			pics[i].icw_words=0;
+-		}
+-		for (i=0;i<=7;i++) {
+-			irqs[i].active=false;
+-			irqs[i].masked=true;
+-			irqs[i].inservice=false;
+-			irqs[i+8].active=false;
+-			irqs[i+8].masked=true;
+-			irqs[i+8].inservice=false;
+-			irqs[i].vector=0x8+i;
+-			irqs[i+8].vector=0x70+i;	
+-		}
+-		irqs[0].masked=false;					/* Enable system timer */
+-		irqs[1].masked=false;					/* Enable Keyboard IRQ */
+-		irqs[2].masked=false;					/* Enable second pic */
+-		irqs[8].masked=false;					/* Enable RTC IRQ */
++			pics[i].irr = pics[i].isr = pics[i].imrr = 0;
++			pics[i].isrr = pics[i].imr = 0xff;
++			pics[i].active_irq = 8;
++		}
++		master.vector_base = 0x08;
++		slave.vector_base = 0x70;
++
++		PIC_SetIRQMask(0,false);					/* Enable system timer */
++		PIC_SetIRQMask(1,false);					/* Enable system timer */
++		PIC_SetIRQMask(2,false);					/* Enable second pic */
++		PIC_SetIRQMask(8,false);					/* Enable RTC IRQ */
++
+ 		if (machine==MCH_PCJR) {
+ 			/* Enable IRQ6 (replacement for the NMI for PCJr) */
+-			irqs[6].masked=false;
++			PIC_SetIRQMask(6,false);
+ 		}
+ 		ReadHandler[0].Install(0x20,read_command,IO_MB);
+ 		ReadHandler[1].Install(0x21,read_data,IO_MB);
+@@ -596,17 +607,18 @@
+ 		pic_queue.free_entry=&pic_queue.entries[0];
+ 		pic_queue.next_entry=0;
+ 	}
+-	~PIC(){
++
++	~PIC_8259A(){
+ 	}
+ };
+ 
+-static PIC* test;
++static PIC_8259A* test;
+ 
+ void PIC_Destroy(Section* sec){
+ 	delete test;
+ }
+ 
+ void PIC_Init(Section* sec) {
+-	test = new PIC(sec);
++	test = new PIC_8259A(sec);
+ 	sec->AddDestroyFunction(&PIC_Destroy);
+ }
+diff -Nur dosbox-0.74/src/hardware/sblaster.cpp dosbox/src/hardware/sblaster.cpp
+--- dosbox-0.74/src/hardware/sblaster.cpp	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/hardware/sblaster.cpp	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,7 +16,6 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: sblaster.cpp,v 1.78 2009-10-25 16:22:22 c2woody Exp $ */
+ 
+ #include <iomanip>
+ #include <sstream>
+@@ -275,7 +274,7 @@
+ }
+ 
+ static void DSP_DMA_CallBack(DmaChannel * chan, DMAEvent event) {
+-	if (event==DMA_REACHED_TC) return;
++	if (chan!=sb.dma.chan || event==DMA_REACHED_TC) return;
+ 	else if (event==DMA_MASKED) {
+ 		if (sb.mode==MODE_DMA) {
+ 			GenerateDMASound(sb.dma.min);
+@@ -504,6 +503,8 @@
+ 	sb.dma.left-=read;
+ 	if (!sb.dma.left) {
+ 		PIC_RemoveEvents(END_DMA_Event);
++		if (sb.dma.mode >= DSP_DMA_16) SB_RaiseIRQ(SB_IRQ_16);
++		else SB_RaiseIRQ(SB_IRQ_8);
+ 		if (!sb.dma.autoinit) {
+ 			LOG(LOG_SB,LOG_NORMAL)("Single cycle transfer ended");
+ 			sb.mode=MODE_NONE;
+@@ -515,8 +516,6 @@
+ 				sb.mode=MODE_NONE;
+ 			}
+ 		}
+-		if (sb.dma.mode >= DSP_DMA_16) SB_RaiseIRQ(SB_IRQ_16);
+-		else SB_RaiseIRQ(SB_IRQ_8);
+ 	}
+ }
+ 
+@@ -872,6 +871,11 @@
+ 	case 0x76:  /* 074h : Single Cycle 3-bit(2.6bit) ADPCM */
+ 		DSP_PrepareDMA_Old(DSP_DMA_3,false,false);
+ 		break;
++	case 0x7d:	/* Auto Init 4-bit ADPCM Reference */
++		DSP_SB2_ABOVE;
++		sb.adpcm.haveref=true;
++		DSP_PrepareDMA_Old(DSP_DMA_4,true,false);
++		break;
+ 	case 0x17:	/* 017h : Single Cycle 2-bit ADPCM Reference*/
+ 		sb.adpcm.haveref=true;
+ 	case 0x16:  /* 074h : Single Cycle 2-bit ADPCM */
+@@ -900,6 +904,9 @@
+ 	case 0xd0:	/* Halt 8-bit DMA */
+ //		DSP_ChangeMode(MODE_NONE);
+ //		Games sometimes already program a new dma before stopping, gives noise
++		if (sb.mode==MODE_NONE) {
++			// possibly different code here that does not switch to MODE_DMA_PAUSE
++		}
+ 		sb.mode=MODE_DMA_PAUSE;
+ 		PIC_RemoveEvents(END_DMA_Event);
+ 		break;
+@@ -920,7 +927,7 @@
+ 	case 0xd4:	/* Continue DMA 8-bit*/
+ 		if (sb.mode==MODE_DMA_PAUSE) {
+ 			sb.mode=MODE_DMA_MASKED;
+-			sb.dma.chan->Register_Callback(DSP_DMA_CallBack);
++			if (sb.dma.chan!=NULL) sb.dma.chan->Register_Callback(DSP_DMA_CallBack);
+ 		}
+ 		break;
+ 	case 0xd9:  /* Exit Autoinitialize 16-bit */
+@@ -977,7 +984,12 @@
+ 		DSP_AddData(sb.dsp.test_register);;
+ 		break;
+ 	case 0xf2:	/* Trigger 8bit IRQ */
+-		SB_RaiseIRQ(SB_IRQ_8);
++		//Small delay in order to emulate the slowness of the DSP, fixes Llamatron 2012 and Lemmings 3D
++		PIC_AddEvent(&DSP_RaiseIRQEvent,0.01f); 
++		break;
++	case 0xf3:   /* Trigger 16bit IRQ */
++		DSP_SB16_ONLY; 
++		SB_RaiseIRQ(SB_IRQ_16);
+ 		break;
+ 	case 0xf8:  /* Undocumented, pre-SB16 only */
+ 		DSP_FlushData();
+@@ -990,7 +1002,7 @@
+ 		DSP_SB2_ABOVE;
+ 		LOG(LOG_SB,LOG_ERROR)("DSP:Unimplemented MIDI UART command %2X",sb.dsp.cmd);
+ 		break;
+-	case 0x7d: case 0x7f: case 0x1f:
++	case 0x7f: case 0x1f:
+ 		DSP_SB2_ABOVE;
+ 		LOG(LOG_SB,LOG_ERROR)("DSP:Unimplemented auto-init DMA ADPCM command %2X",sb.dsp.cmd);
+ 		break;
+@@ -1090,11 +1102,16 @@
+ 	chan=MIXER_FindChannel("FM");
+ 	if (chan) chan->SetVolume(float(sb.mixer.master[0])/31.0f*CALCVOL(sb.mixer.fm[0]),
+ 							  float(sb.mixer.master[1])/31.0f*CALCVOL(sb.mixer.fm[1]));
++	chan=MIXER_FindChannel("CDAUDIO");
++	if (chan) chan->SetVolume(float(sb.mixer.master[0])/31.0f*CALCVOL(sb.mixer.cda[0]),
++							  float(sb.mixer.master[1])/31.0f*CALCVOL(sb.mixer.cda[1]));
+ }
+ 
+ static void CTMIXER_Reset(void) {
+ 	sb.mixer.fm[0]=
+ 	sb.mixer.fm[1]=
++	sb.mixer.cda[0]=
++	sb.mixer.cda[1]=
+ 	sb.mixer.dac[0]=
+ 	sb.mixer.dac[1]=31;
+ 	sb.mixer.master[0]=
+@@ -1106,8 +1123,9 @@
+ 	_WHICH_[0]=   ((((_VAL_) & 0xf0) >> 3)|(sb.type==SBT_16 ? 1:3));	\
+ 	_WHICH_[1]=   ((((_VAL_) & 0x0f) << 1)|(sb.type==SBT_16 ? 1:3));	\
+ 
+-#define MAKEPROVOL(_WHICH_)			\
+-	((((_WHICH_[0] & 0x1e) << 3) | ((_WHICH_[1] & 0x1e) >> 1)) & (sb.type==SBT_16 ? 0xff:0xee))
++#define MAKEPROVOL(_WHICH_)											\
++	((((_WHICH_[0] & 0x1e) << 3) | ((_WHICH_[1] & 0x1e) >> 1)) |	\
++		((sb.type==SBT_PRO1 || sb.type==SBT_PRO2) ? 0x11:0))
+ 
+ static void DSP_ChangeStereo(bool stereo) {
+ 	if (!sb.dma.stereo && stereo) {
+@@ -1147,10 +1165,15 @@
+ 		break;
+ 	case 0x08:		/* CDA Volume (SB2 Only) */
+ 		SETPROVOL(sb.mixer.cda,(val&0xf)|(val<<4));
++		CTMIXER_UpdateVolumes();
+ 		break;
+ 	case 0x0a:		/* Mic Level (SBPRO) or DAC Volume (SB2): 2-bit, 3-bit on SB16 */
+-		if (sb.type==SBT_2) sb.mixer.dac[0]=sb.mixer.dac[1]=((val & 0x6) << 2)|3;
+-		else sb.mixer.mic=((val & 0x7) << 2)|(sb.type==SBT_16?1:3);
++		if (sb.type==SBT_2) {
++			sb.mixer.dac[0]=sb.mixer.dac[1]=((val & 0x6) << 2)|3;
++			CTMIXER_UpdateVolumes();
++		} else {
++			sb.mixer.mic=((val & 0x7) << 2)|(sb.type==SBT_16?1:3);
++		}
+ 		break;
+ 	case 0x0e:		/* Output/Stereo Select */
+ 		sb.mixer.stereo=(val & 0x2) > 0;
+@@ -1168,6 +1191,7 @@
+ 		break;
+ 	case 0x28:		/* CD Audio Volume (SBPRO) */
+ 		SETPROVOL(sb.mixer.cda,val);
++		CTMIXER_UpdateVolumes();
+ 		break;
+ 	case 0x2e:		/* Line-in Volume (SBPRO) */
+ 		SETPROVOL(sb.mixer.lin,val);
+@@ -1211,10 +1235,16 @@
+ 		}
+ 		break;
+ 	case 0x36:		/* CD Volume Left (SB16) */
+-		if (sb.type==SBT_16) sb.mixer.cda[0]=val>>3;
++		if (sb.type==SBT_16) {
++			sb.mixer.cda[0]=val>>3;
++			CTMIXER_UpdateVolumes();
++		}
+ 		break;
+ 	case 0x37:		/* CD Volume Right (SB16) */
+-		if (sb.type==SBT_16) sb.mixer.cda[1]=val>>3;
++		if (sb.type==SBT_16) {
++			sb.mixer.cda[1]=val>>3;
++			CTMIXER_UpdateVolumes();
++		}
+ 		break;
+ 	case 0x38:		/* Line-in Volume Left (SB16) */
+ 		if (sb.type==SBT_16) sb.mixer.lin[0]=val>>3;
+@@ -1345,7 +1375,8 @@
+ 		return ret;
+ 	case 0x82:		/* IRQ Status */
+ 		return	(sb.irq.pending_8bit ? 0x1 : 0) |
+-				(sb.irq.pending_16bit ? 0x2 : 0);
++				(sb.irq.pending_16bit ? 0x2 : 0) | 
++				((sb.type == SBT_16) ? 0x20 : 0);
+ 	default:
+ 		if (	((sb.type == SBT_PRO1 || sb.type == SBT_PRO2) && sb.mixer.index==0x0c) || /* Input control on SBPro */
+ 			(sb.type == SBT_16 && sb.mixer.index >= 0x3b && sb.mixer.index <= 0x47)) /* New SB16 registers */
+diff -Nur dosbox-0.74/src/hardware/serialport/directserial.cpp dosbox/src/hardware/serialport/directserial.cpp
+--- dosbox-0.74/src/hardware/serialport/directserial.cpp	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/hardware/serialport/directserial.cpp	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,7 +16,6 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: directserial.cpp,v 1.2 2009-09-26 09:15:19 h-a-l-9000 Exp $ */
+ 
+ #include "dosbox.h"
+ 
+diff -Nur dosbox-0.74/src/hardware/serialport/directserial.h dosbox/src/hardware/serialport/directserial.h
+--- dosbox-0.74/src/hardware/serialport/directserial.h	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/hardware/serialport/directserial.h	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,7 +16,6 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: directserial.h,v 1.2 2009-09-26 09:15:19 h-a-l-9000 Exp $ */
+ 
+ // include guard
+ #ifndef DOSBOX_DIRECTSERIAL_WIN32_H
+diff -Nur dosbox-0.74/src/hardware/serialport/libserial.cpp dosbox/src/hardware/serialport/libserial.cpp
+--- dosbox-0.74/src/hardware/serialport/libserial.cpp	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/hardware/serialport/libserial.cpp	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,7 +16,6 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: libserial.cpp,v 1.4 2009-11-02 09:51:02 h-a-l-9000 Exp $ */
+ 
+ #include "libserial.h"
+ 
+@@ -45,6 +44,7 @@
+ 	int len = strlen(portname);
+ 	if(len > 240) {
+ 		SetLastError(ERROR_BUFFER_OVERFLOW);
++		free(cp);
+ 		return false;
+ 	}
+ 	char extended_portname[256] = "\\\\.\\";
+@@ -197,7 +197,7 @@
+ 	char chRead;
+ 
+ 	int retval = 0;
+-	// receive a byte; TODO communicate faliure
++	// receive a byte; TODO communicate failure
+ 	if (ReadFile (port->porthandle, &chRead, 1, &dwRead, NULL)) {
+ 		if (dwRead) {
+ 			// check for errors
+@@ -580,7 +580,7 @@
+ 	char chRead;
+ 
+ 	int retval = 0;
+-	// receive a byte; TODO communicate faliure
++	// receive a byte; TODO communicate failure
+ 	if (DosRead(port->porthandle, &chRead, 1, &dwRead) == NO_ERROR) {
+ 		if (dwRead) {
+ 			// check for errors; will OS/2 clear the error on reading its data?
+diff -Nur dosbox-0.74/src/hardware/serialport/libserial.h dosbox/src/hardware/serialport/libserial.h
+--- dosbox-0.74/src/hardware/serialport/libserial.h	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/hardware/serialport/libserial.h	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,7 +16,6 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: libserial.h,v 1.2 2009-09-26 09:15:19 h-a-l-9000 Exp $ */
+ 
+ typedef struct _COMPORT *COMPORT;
+ 
+diff -Nur dosbox-0.74/src/hardware/serialport/Makefile.in dosbox/src/hardware/serialport/Makefile.in
+--- dosbox-0.74/src/hardware/serialport/Makefile.in	2010-05-12 11:57:44.000000000 +0200
++++ dosbox/src/hardware/serialport/Makefile.in	1970-01-01 01:00:00.000000000 +0100
+@@ -1,456 +0,0 @@
+-# Makefile.in generated by automake 1.11.1 from Makefile.am.
+-# @configure_input@
+-
+-# Copyright (C) 1994, 1995, 1996, 1997, 1998, 1999, 2000, 2001, 2002,
+-# 2003, 2004, 2005, 2006, 2007, 2008, 2009  Free Software Foundation,
+-# Inc.
+-# This Makefile.in is free software; the Free Software Foundation
+-# gives unlimited permission to copy and/or distribute it,
+-# with or without modifications, as long as this notice is preserved.
+-
+-# This program is distributed in the hope that it will be useful,
+-# but WITHOUT ANY WARRANTY, to the extent permitted by law; without
+-# even the implied warranty of MERCHANTABILITY or FITNESS FOR A
+-# PARTICULAR PURPOSE.
+-
+-@SET_MAKE@
+-
+-VPATH = @srcdir@
+-pkgdatadir = $(datadir)/@PACKAGE@
+-pkgincludedir = $(includedir)/@PACKAGE@
+-pkglibdir = $(libdir)/@PACKAGE@
+-pkglibexecdir = $(libexecdir)/@PACKAGE@
+-am__cd = CDPATH="$${ZSH_VERSION+.}$(PATH_SEPARATOR)" && cd
+-install_sh_DATA = $(install_sh) -c -m 644
+-install_sh_PROGRAM = $(install_sh) -c
+-install_sh_SCRIPT = $(install_sh) -c
+-INSTALL_HEADER = $(INSTALL_DATA)
+-transform = $(program_transform_name)
+-NORMAL_INSTALL = :
+-PRE_INSTALL = :
+-POST_INSTALL = :
+-NORMAL_UNINSTALL = :
+-PRE_UNINSTALL = :
+-POST_UNINSTALL = :
+-build_triplet = @build@
+-host_triplet = @host@
+-subdir = src/hardware/serialport
+-DIST_COMMON = $(srcdir)/Makefile.am $(srcdir)/Makefile.in
+-ACLOCAL_M4 = $(top_srcdir)/aclocal.m4
+-am__aclocal_m4_deps = $(top_srcdir)/acinclude.m4 \
+-	$(top_srcdir)/configure.in
+-am__configure_deps = $(am__aclocal_m4_deps) $(CONFIGURE_DEPENDENCIES) \
+-	$(ACLOCAL_M4)
+-mkinstalldirs = $(install_sh) -d
+-CONFIG_HEADER = $(top_builddir)/config.h
+-CONFIG_CLEAN_FILES =
+-CONFIG_CLEAN_VPATH_FILES =
+-LIBRARIES = $(noinst_LIBRARIES)
+-AR = ar
+-ARFLAGS = cru
+-libserial_a_AR = $(AR) $(ARFLAGS)
+-libserial_a_LIBADD =
+-am_libserial_a_OBJECTS = directserial.$(OBJEXT) libserial.$(OBJEXT) \
+-	serialdummy.$(OBJEXT) serialport.$(OBJEXT) softmodem.$(OBJEXT) \
+-	misc_util.$(OBJEXT) nullmodem.$(OBJEXT)
+-libserial_a_OBJECTS = $(am_libserial_a_OBJECTS)
+-DEFAULT_INCLUDES = -I.@am__isrc@ -I$(top_builddir)
+-depcomp = $(SHELL) $(top_srcdir)/depcomp
+-am__depfiles_maybe = depfiles
+-am__mv = mv -f
+-CXXCOMPILE = $(CXX) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) \
+-	$(AM_CPPFLAGS) $(CPPFLAGS) $(AM_CXXFLAGS) $(CXXFLAGS)
+-CXXLD = $(CXX)
+-CXXLINK = $(CXXLD) $(AM_CXXFLAGS) $(CXXFLAGS) $(AM_LDFLAGS) $(LDFLAGS) \
+-	-o $@
+-COMPILE = $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) \
+-	$(CPPFLAGS) $(AM_CFLAGS) $(CFLAGS)
+-CCLD = $(CC)
+-LINK = $(CCLD) $(AM_CFLAGS) $(CFLAGS) $(AM_LDFLAGS) $(LDFLAGS) -o $@
+-SOURCES = $(libserial_a_SOURCES)
+-DIST_SOURCES = $(libserial_a_SOURCES)
+-ETAGS = etags
+-CTAGS = ctags
+-DISTFILES = $(DIST_COMMON) $(DIST_SOURCES) $(TEXINFOS) $(EXTRA_DIST)
+-ACLOCAL = @ACLOCAL@
+-ALSA_CFLAGS = @ALSA_CFLAGS@
+-ALSA_LIBS = @ALSA_LIBS@
+-AMTAR = @AMTAR@
+-AUTOCONF = @AUTOCONF@
+-AUTOHEADER = @AUTOHEADER@
+-AUTOMAKE = @AUTOMAKE@
+-AWK = @AWK@
+-CC = @CC@
+-CCDEPMODE = @CCDEPMODE@
+-CFLAGS = @CFLAGS@
+-CPP = @CPP@
+-CPPFLAGS = @CPPFLAGS@
+-CXX = @CXX@
+-CXXDEPMODE = @CXXDEPMODE@
+-CXXFLAGS = @CXXFLAGS@
+-CYGPATH_W = @CYGPATH_W@
+-DEFS = @DEFS@
+-DEPDIR = @DEPDIR@
+-ECHO_C = @ECHO_C@
+-ECHO_N = @ECHO_N@
+-ECHO_T = @ECHO_T@
+-EGREP = @EGREP@
+-EXEEXT = @EXEEXT@
+-GREP = @GREP@
+-INSTALL = @INSTALL@
+-INSTALL_DATA = @INSTALL_DATA@
+-INSTALL_PROGRAM = @INSTALL_PROGRAM@
+-INSTALL_SCRIPT = @INSTALL_SCRIPT@
+-INSTALL_STRIP_PROGRAM = @INSTALL_STRIP_PROGRAM@
+-LDFLAGS = @LDFLAGS@
+-LIBOBJS = @LIBOBJS@
+-LIBS = @LIBS@
+-LTLIBOBJS = @LTLIBOBJS@
+-MAKEINFO = @MAKEINFO@
+-MKDIR_P = @MKDIR_P@
+-OBJEXT = @OBJEXT@
+-PACKAGE = @PACKAGE@
+-PACKAGE_BUGREPORT = @PACKAGE_BUGREPORT@
+-PACKAGE_NAME = @PACKAGE_NAME@
+-PACKAGE_STRING = @PACKAGE_STRING@
+-PACKAGE_TARNAME = @PACKAGE_TARNAME@
+-PACKAGE_URL = @PACKAGE_URL@
+-PACKAGE_VERSION = @PACKAGE_VERSION@
+-PATH_SEPARATOR = @PATH_SEPARATOR@
+-RANLIB = @RANLIB@
+-SDL_CFLAGS = @SDL_CFLAGS@
+-SDL_CONFIG = @SDL_CONFIG@
+-SDL_LIBS = @SDL_LIBS@
+-SET_MAKE = @SET_MAKE@
+-SHELL = @SHELL@
+-STRIP = @STRIP@
+-VERSION = @VERSION@
+-WINDRES = @WINDRES@
+-abs_builddir = @abs_builddir@
+-abs_srcdir = @abs_srcdir@
+-abs_top_builddir = @abs_top_builddir@
+-abs_top_srcdir = @abs_top_srcdir@
+-ac_ct_CC = @ac_ct_CC@
+-ac_ct_CXX = @ac_ct_CXX@
+-am__include = @am__include@
+-am__leading_dot = @am__leading_dot@
+-am__quote = @am__quote@
+-am__tar = @am__tar@
+-am__untar = @am__untar@
+-bindir = @bindir@
+-build = @build@
+-build_alias = @build_alias@
+-build_cpu = @build_cpu@
+-build_os = @build_os@
+-build_vendor = @build_vendor@
+-builddir = @builddir@
+-datadir = @datadir@
+-datarootdir = @datarootdir@
+-docdir = @docdir@
+-dvidir = @dvidir@
+-exec_prefix = @exec_prefix@
+-host = @host@
+-host_alias = @host_alias@
+-host_cpu = @host_cpu@
+-host_os = @host_os@
+-host_vendor = @host_vendor@
+-htmldir = @htmldir@
+-includedir = @includedir@
+-infodir = @infodir@
+-install_sh = @install_sh@
+-libdir = @libdir@
+-libexecdir = @libexecdir@
+-localedir = @localedir@
+-localstatedir = @localstatedir@
+-mandir = @mandir@
+-mkdir_p = @mkdir_p@
+-oldincludedir = @oldincludedir@
+-pdfdir = @pdfdir@
+-prefix = @prefix@
+-program_transform_name = @program_transform_name@
+-psdir = @psdir@
+-sbindir = @sbindir@
+-sharedstatedir = @sharedstatedir@
+-srcdir = @srcdir@
+-sysconfdir = @sysconfdir@
+-target_alias = @target_alias@
+-top_build_prefix = @top_build_prefix@
+-top_builddir = @top_builddir@
+-top_srcdir = @top_srcdir@
+-AM_CPPFLAGS = -I$(top_srcdir)/include
+-noinst_LIBRARIES = libserial.a
+-libserial_a_SOURCES = directserial.cpp directserial.h \
+-						libserial.cpp libserial.h \
+-						serialdummy.cpp serialdummy.h serialport.cpp \
+-						softmodem.cpp softmodem.h misc_util.cpp misc_util.h \
+-						nullmodem.cpp nullmodem.h
+-
+-all: all-am
+-
+-.SUFFIXES:
+-.SUFFIXES: .cpp .o .obj
+-$(srcdir)/Makefile.in:  $(srcdir)/Makefile.am  $(am__configure_deps)
+-	@for dep in $?; do \
+-	  case '$(am__configure_deps)' in \
+-	    *$$dep*) \
+-	      ( cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh ) \
+-	        && { if test -f $@; then exit 0; else break; fi; }; \
+-	      exit 1;; \
+-	  esac; \
+-	done; \
+-	echo ' cd $(top_srcdir) && $(AUTOMAKE) --gnu src/hardware/serialport/Makefile'; \
+-	$(am__cd) $(top_srcdir) && \
+-	  $(AUTOMAKE) --gnu src/hardware/serialport/Makefile
+-.PRECIOUS: Makefile
+-Makefile: $(srcdir)/Makefile.in $(top_builddir)/config.status
+-	@case '$?' in \
+-	  *config.status*) \
+-	    cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh;; \
+-	  *) \
+-	    echo ' cd $(top_builddir) && $(SHELL) ./config.status $(subdir)/$@ $(am__depfiles_maybe)'; \
+-	    cd $(top_builddir) && $(SHELL) ./config.status $(subdir)/$@ $(am__depfiles_maybe);; \
+-	esac;
+-
+-$(top_builddir)/config.status: $(top_srcdir)/configure $(CONFIG_STATUS_DEPENDENCIES)
+-	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
+-
+-$(top_srcdir)/configure:  $(am__configure_deps)
+-	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
+-$(ACLOCAL_M4):  $(am__aclocal_m4_deps)
+-	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
+-$(am__aclocal_m4_deps):
+-
+-clean-noinstLIBRARIES:
+-	-test -z "$(noinst_LIBRARIES)" || rm -f $(noinst_LIBRARIES)
+-libserial.a: $(libserial_a_OBJECTS) $(libserial_a_DEPENDENCIES) 
+-	-rm -f libserial.a
+-	$(libserial_a_AR) libserial.a $(libserial_a_OBJECTS) $(libserial_a_LIBADD)
+-	$(RANLIB) libserial.a
+-
+-mostlyclean-compile:
+-	-rm -f *.$(OBJEXT)
+-
+-distclean-compile:
+-	-rm -f *.tab.c
+-
+-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/directserial.Po@am__quote@
+-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/libserial.Po@am__quote@
+-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/misc_util.Po@am__quote@
+-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/nullmodem.Po@am__quote@
+-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/serialdummy.Po@am__quote@
+-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/serialport.Po@am__quote@
+-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/softmodem.Po@am__quote@
+-
+-.cpp.o:
+-@am__fastdepCXX_TRUE@	$(CXXCOMPILE) -MT $@ -MD -MP -MF $(DEPDIR)/$*.Tpo -c -o $@ $<
+-@am__fastdepCXX_TRUE@	$(am__mv) $(DEPDIR)/$*.Tpo $(DEPDIR)/$*.Po
+-@AMDEP_TRUE@@am__fastdepCXX_FALSE@	source='$<' object='$@' libtool=no @AMDEPBACKSLASH@
+-@AMDEP_TRUE@@am__fastdepCXX_FALSE@	DEPDIR=$(DEPDIR) $(CXXDEPMODE) $(depcomp) @AMDEPBACKSLASH@
+-@am__fastdepCXX_FALSE@	$(CXXCOMPILE) -c -o $@ $<
+-
+-.cpp.obj:
+-@am__fastdepCXX_TRUE@	$(CXXCOMPILE) -MT $@ -MD -MP -MF $(DEPDIR)/$*.Tpo -c -o $@ `$(CYGPATH_W) '$<'`
+-@am__fastdepCXX_TRUE@	$(am__mv) $(DEPDIR)/$*.Tpo $(DEPDIR)/$*.Po
+-@AMDEP_TRUE@@am__fastdepCXX_FALSE@	source='$<' object='$@' libtool=no @AMDEPBACKSLASH@
+-@AMDEP_TRUE@@am__fastdepCXX_FALSE@	DEPDIR=$(DEPDIR) $(CXXDEPMODE) $(depcomp) @AMDEPBACKSLASH@
+-@am__fastdepCXX_FALSE@	$(CXXCOMPILE) -c -o $@ `$(CYGPATH_W) '$<'`
+-
+-ID: $(HEADERS) $(SOURCES) $(LISP) $(TAGS_FILES)
+-	list='$(SOURCES) $(HEADERS) $(LISP) $(TAGS_FILES)'; \
+-	unique=`for i in $$list; do \
+-	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
+-	  done | \
+-	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
+-	      END { if (nonempty) { for (i in files) print i; }; }'`; \
+-	mkid -fID $$unique
+-tags: TAGS
+-
+-TAGS:  $(HEADERS) $(SOURCES)  $(TAGS_DEPENDENCIES) \
+-		$(TAGS_FILES) $(LISP)
+-	set x; \
+-	here=`pwd`; \
+-	list='$(SOURCES) $(HEADERS)  $(LISP) $(TAGS_FILES)'; \
+-	unique=`for i in $$list; do \
+-	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
+-	  done | \
+-	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
+-	      END { if (nonempty) { for (i in files) print i; }; }'`; \
+-	shift; \
+-	if test -z "$(ETAGS_ARGS)$$*$$unique"; then :; else \
+-	  test -n "$$unique" || unique=$$empty_fix; \
+-	  if test $$# -gt 0; then \
+-	    $(ETAGS) $(ETAGSFLAGS) $(AM_ETAGSFLAGS) $(ETAGS_ARGS) \
+-	      "$$@" $$unique; \
+-	  else \
+-	    $(ETAGS) $(ETAGSFLAGS) $(AM_ETAGSFLAGS) $(ETAGS_ARGS) \
+-	      $$unique; \
+-	  fi; \
+-	fi
+-ctags: CTAGS
+-CTAGS:  $(HEADERS) $(SOURCES)  $(TAGS_DEPENDENCIES) \
+-		$(TAGS_FILES) $(LISP)
+-	list='$(SOURCES) $(HEADERS)  $(LISP) $(TAGS_FILES)'; \
+-	unique=`for i in $$list; do \
+-	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
+-	  done | \
+-	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
+-	      END { if (nonempty) { for (i in files) print i; }; }'`; \
+-	test -z "$(CTAGS_ARGS)$$unique" \
+-	  || $(CTAGS) $(CTAGSFLAGS) $(AM_CTAGSFLAGS) $(CTAGS_ARGS) \
+-	     $$unique
+-
+-GTAGS:
+-	here=`$(am__cd) $(top_builddir) && pwd` \
+-	  && $(am__cd) $(top_srcdir) \
+-	  && gtags -i $(GTAGS_ARGS) "$$here"
+-
+-distclean-tags:
+-	-rm -f TAGS ID GTAGS GRTAGS GSYMS GPATH tags
+-
+-distdir: $(DISTFILES)
+-	@srcdirstrip=`echo "$(srcdir)" | sed 's/[].[^$$\\*]/\\\\&/g'`; \
+-	topsrcdirstrip=`echo "$(top_srcdir)" | sed 's/[].[^$$\\*]/\\\\&/g'`; \
+-	list='$(DISTFILES)'; \
+-	  dist_files=`for file in $$list; do echo $$file; done | \
+-	  sed -e "s|^$$srcdirstrip/||;t" \
+-	      -e "s|^$$topsrcdirstrip/|$(top_builddir)/|;t"`; \
+-	case $$dist_files in \
+-	  */*) $(MKDIR_P) `echo "$$dist_files" | \
+-			   sed '/\//!d;s|^|$(distdir)/|;s,/[^/]*$$,,' | \
+-			   sort -u` ;; \
+-	esac; \
+-	for file in $$dist_files; do \
+-	  if test -f $$file || test -d $$file; then d=.; else d=$(srcdir); fi; \
+-	  if test -d $$d/$$file; then \
+-	    dir=`echo "/$$file" | sed -e 's,/[^/]*$$,,'`; \
+-	    if test -d "$(distdir)/$$file"; then \
+-	      find "$(distdir)/$$file" -type d ! -perm -700 -exec chmod u+rwx {} \;; \
+-	    fi; \
+-	    if test -d $(srcdir)/$$file && test $$d != $(srcdir); then \
+-	      cp -fpR $(srcdir)/$$file "$(distdir)$$dir" || exit 1; \
+-	      find "$(distdir)/$$file" -type d ! -perm -700 -exec chmod u+rwx {} \;; \
+-	    fi; \
+-	    cp -fpR $$d/$$file "$(distdir)$$dir" || exit 1; \
+-	  else \
+-	    test -f "$(distdir)/$$file" \
+-	    || cp -p $$d/$$file "$(distdir)/$$file" \
+-	    || exit 1; \
+-	  fi; \
+-	done
+-check-am: all-am
+-check: check-am
+-all-am: Makefile $(LIBRARIES)
+-installdirs:
+-install: install-am
+-install-exec: install-exec-am
+-install-data: install-data-am
+-uninstall: uninstall-am
+-
+-install-am: all-am
+-	@$(MAKE) $(AM_MAKEFLAGS) install-exec-am install-data-am
+-
+-installcheck: installcheck-am
+-install-strip:
+-	$(MAKE) $(AM_MAKEFLAGS) INSTALL_PROGRAM="$(INSTALL_STRIP_PROGRAM)" \
+-	  install_sh_PROGRAM="$(INSTALL_STRIP_PROGRAM)" INSTALL_STRIP_FLAG=-s \
+-	  `test -z '$(STRIP)' || \
+-	    echo "INSTALL_PROGRAM_ENV=STRIPPROG='$(STRIP)'"` install
+-mostlyclean-generic:
+-
+-clean-generic:
+-
+-distclean-generic:
+-	-test -z "$(CONFIG_CLEAN_FILES)" || rm -f $(CONFIG_CLEAN_FILES)
+-	-test . = "$(srcdir)" || test -z "$(CONFIG_CLEAN_VPATH_FILES)" || rm -f $(CONFIG_CLEAN_VPATH_FILES)
+-
+-maintainer-clean-generic:
+-	@echo "This command is intended for maintainers to use"
+-	@echo "it deletes files that may require special tools to rebuild."
+-clean: clean-am
+-
+-clean-am: clean-generic clean-noinstLIBRARIES mostlyclean-am
+-
+-distclean: distclean-am
+-	-rm -rf ./$(DEPDIR)
+-	-rm -f Makefile
+-distclean-am: clean-am distclean-compile distclean-generic \
+-	distclean-tags
+-
+-dvi: dvi-am
+-
+-dvi-am:
+-
+-html: html-am
+-
+-html-am:
+-
+-info: info-am
+-
+-info-am:
+-
+-install-data-am:
+-
+-install-dvi: install-dvi-am
+-
+-install-dvi-am:
+-
+-install-exec-am:
+-
+-install-html: install-html-am
+-
+-install-html-am:
+-
+-install-info: install-info-am
+-
+-install-info-am:
+-
+-install-man:
+-
+-install-pdf: install-pdf-am
+-
+-install-pdf-am:
+-
+-install-ps: install-ps-am
+-
+-install-ps-am:
+-
+-installcheck-am:
+-
+-maintainer-clean: maintainer-clean-am
+-	-rm -rf ./$(DEPDIR)
+-	-rm -f Makefile
+-maintainer-clean-am: distclean-am maintainer-clean-generic
+-
+-mostlyclean: mostlyclean-am
+-
+-mostlyclean-am: mostlyclean-compile mostlyclean-generic
+-
+-pdf: pdf-am
+-
+-pdf-am:
+-
+-ps: ps-am
+-
+-ps-am:
+-
+-uninstall-am:
+-
+-.MAKE: install-am install-strip
+-
+-.PHONY: CTAGS GTAGS all all-am check check-am clean clean-generic \
+-	clean-noinstLIBRARIES ctags distclean distclean-compile \
+-	distclean-generic distclean-tags distdir dvi dvi-am html \
+-	html-am info info-am install install-am install-data \
+-	install-data-am install-dvi install-dvi-am install-exec \
+-	install-exec-am install-html install-html-am install-info \
+-	install-info-am install-man install-pdf install-pdf-am \
+-	install-ps install-ps-am install-strip installcheck \
+-	installcheck-am installdirs maintainer-clean \
+-	maintainer-clean-generic mostlyclean mostlyclean-compile \
+-	mostlyclean-generic pdf pdf-am ps ps-am tags uninstall \
+-	uninstall-am
+-
+-
+-# Tell versions [3.59,3.63) of GNU make to not export all variables.
+-# Otherwise a system limit (for SysV at least) may be exceeded.
+-.NOEXPORT:
+diff -Nur dosbox-0.74/src/hardware/serialport/misc_util.cpp dosbox/src/hardware/serialport/misc_util.cpp
+--- dosbox-0.74/src/hardware/serialport/misc_util.cpp	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/hardware/serialport/misc_util.cpp	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+diff -Nur dosbox-0.74/src/hardware/serialport/misc_util.h dosbox/src/hardware/serialport/misc_util.h
+--- dosbox-0.74/src/hardware/serialport/misc_util.h	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/hardware/serialport/misc_util.h	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,7 +16,6 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: misc_util.h,v 1.5 2009-09-25 23:40:47 h-a-l-9000 Exp $ */
+ 
+ #ifndef SDLNETWRAPPER_H
+ #define SDLNETWRAPPER_H
+diff -Nur dosbox-0.74/src/hardware/serialport/nullmodem.cpp dosbox/src/hardware/serialport/nullmodem.cpp
+--- dosbox-0.74/src/hardware/serialport/nullmodem.cpp	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/hardware/serialport/nullmodem.cpp	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,7 +16,6 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: nullmodem.cpp,v 1.8 2009-09-25 23:40:47 h-a-l-9000 Exp $ */
+ 
+ #include "dosbox.h"
+ 
+@@ -53,137 +52,108 @@
+ 	// 1) when it is client connect to the server not immediately but
+ 	//    as soon as a modem-aware application is started (DTR is switched on).
+ 	// 2) only receive data when DTR is on.
+-	if(getBituSubstring("usedtr:", &bool_temp, cmd)) {
+-		if(bool_temp==1) {
++	if (getBituSubstring("usedtr:", &bool_temp, cmd)) {
++		if (bool_temp==1) {
+ 			dtrrespect=true;
+ 			transparent=true;
++			DTR_delta=false; // connect immediately when DTR is already 1
+ 		}
+ 	}
+ 	// transparent: don't add additional handshake control.
+-	if(getBituSubstring("transparent:", &bool_temp, cmd)) {
+-		if(bool_temp==1) transparent=true;
++	if (getBituSubstring("transparent:", &bool_temp, cmd)) {
++		if (bool_temp==1) transparent=true;
+ 		else transparent=false;
+ 	}
+ 	// telnet: interpret telnet commands.
+-	if(getBituSubstring("telnet:", &bool_temp, cmd)) {
+-		if(bool_temp==1) {
++	if (getBituSubstring("telnet:", &bool_temp, cmd)) {
++		if (bool_temp==1) {
+ 			transparent=true;
+ 			telnet=true;
+ 		}
+ 	}
+ 	// rxdelay: How many milliseconds to wait before causing an
+ 	// overflow when the application is unresponsive.
+-	if(getBituSubstring("rxdelay:", &rx_retry_max, cmd)) {
+-		if(!(rx_retry_max<=10000)) {
++	if (getBituSubstring("rxdelay:", &rx_retry_max, cmd)) {
++		if (!(rx_retry_max<=10000)) {
+ 			rx_retry_max=50;
+ 		}
+ 	}
+ 	// txdelay: How many milliseconds to wait before sending data.
+ 	// This reduces network overhead quite a lot.
+-	if(getBituSubstring("txdelay:", &tx_gather, cmd)) {
+-		if(!(tx_gather<=500)) {
++	if (getBituSubstring("txdelay:", &tx_gather, cmd)) {
++		if (!(tx_gather<=500)) {
+ 			tx_gather=12;
+ 		}
+ 	}
+ 	// port is for both server and client
+-	if(getBituSubstring("port:", &temptcpport, cmd)) {
+-		if(!(temptcpport>0&&temptcpport<65536)) {
++	if (getBituSubstring("port:", &temptcpport, cmd)) {
++		if (!(temptcpport>0&&temptcpport<65536)) {
+ 			temptcpport=23;
+ 		}
+ 	}
+-	// socket inheritance
+-	if(getBituSubstring("inhsocket:", &bool_temp, cmd)) {
++	// socket inheritance (client-alike)
++	if (getBituSubstring("inhsocket:", &bool_temp, cmd)) {
+ #ifdef NATIVESOCKETS
+-		if(Netwrapper_GetCapabilities()&NETWRAPPER_TCP_NATIVESOCKET) {
+-			if(bool_temp==1) {
++		if (Netwrapper_GetCapabilities()&NETWRAPPER_TCP_NATIVESOCKET) {
++			if (bool_temp==1) {
+ 				int sock;
+ 				if (control->cmdline->FindInt("-socket",sock,true)) {
+ 					dtrrespect=false;
+ 					transparent=true;
+-					// custom connect
+-					Bit8u peernamebuf[16];
+-					LOG_MSG("inheritance port: %d",sock);
+-					clientsocket = new TCPClientSocket(sock);
+-					if(!clientsocket->isopen) {
+-						LOG_MSG("Serial%d: Connection failed.",COMNUMBER);
+-#if SERIAL_DEBUG
+-						log_ser(dbg_aux,"Nullmodem: Connection failed.");
+-#endif
+-						delete clientsocket;
+-						clientsocket=0;
++					LOG_MSG("Inheritance socket handle: %d",sock);
++					if (!ClientConnect(new TCPClientSocket(sock)))
+ 						return;
+-					}
+-					clientsocket->SetSendBufferSize(256);
+-					clientsocket->GetRemoteAddressString(peernamebuf);
+-					// transmit the line status
+-					if(!transparent) setRTSDTR(getRTS(), getDTR());
+-
+-					LOG_MSG("Serial%d: Connected to %s",COMNUMBER,peernamebuf);
+-#if SERIAL_DEBUG
+-					log_ser(dbg_aux,"Nullmodem: Connected to %s",peernamebuf);
+-#endif
+-					setEvent(SERIAL_POLLING_EVENT, 1);
+-
+-					CSerial::Init_Registers ();
+-					InstallationSuccessful = true;
+-
+-					setCTS(true);
+-					setDSR(true);
+-					setRI (false);
+-					setCD (true);
+-					return;
+ 				} else {
+-					LOG_MSG("Serial%d: -socket start parameter missing.",COMNUMBER);
++					LOG_MSG("Serial%d: -socket parameter missing.",COMNUMBER);
+ 					return;
+ 				}
+ 			}
+ 		} else {
+-#endif
+ 			LOG_MSG("Serial%d: socket inheritance not supported on this platform.",
+ 				COMNUMBER);
+ 			return;
+ 		}
+-	}
+-	std::string tmpstring;
+-	if(cmd->FindStringBegin("server:",tmpstring,false)) {
+-		// we are a client
+-		const char* hostnamechar=tmpstring.c_str();
+-		size_t hostlen=strlen(hostnamechar)+1;
+-		if(hostlen>sizeof(hostnamebuffer)) {
+-			hostlen=sizeof(hostnamebuffer);
+-			hostnamebuffer[sizeof(hostnamebuffer)-1]=0;
+-		}
+-		memcpy(hostnamebuffer,hostnamechar,hostlen);
+-		clientport=(Bit16u)temptcpport;
+-		if(dtrrespect) {
+-			// we connect as soon as DTR is switched on
+-			setEvent(SERIAL_NULLMODEM_DTR_EVENT, 50);
+-			LOG_MSG("Serial%d: Waiting for DTR...",COMNUMBER);
+-		} else ClientConnect();
++#else
++		LOG_MSG("Serial%d: socket inheritance not available.", COMNUMBER);
++#endif
+ 	} else {
+-		// we are a server
+-		serverport = (Bit16u)temptcpport;
+-		serversocket = new TCPServerSocket(serverport);
+-		if(!serversocket->isopen) return;
+-		LOG_MSG("Serial%d: Nullmodem server waiting for connection on port %d...",
+-			COMNUMBER,serverport);
+-		setEvent(SERIAL_SERVER_POLLING_EVENT, 50);
++		// normal server/client
++		std::string tmpstring;
++		if (cmd->FindStringBegin("server:",tmpstring,false)) {
++			// we are a client
++			const char* hostnamechar=tmpstring.c_str();
++			size_t hostlen=strlen(hostnamechar)+1;
++			if (hostlen>sizeof(hostnamebuffer)) {
++				hostlen=sizeof(hostnamebuffer);
++				hostnamebuffer[sizeof(hostnamebuffer)-1]=0;
++			}
++			memcpy(hostnamebuffer,hostnamechar,hostlen);
++			clientport=(Bit16u)temptcpport;
++			if (dtrrespect) {
++				// we connect as soon as DTR is switched on
++				setEvent(SERIAL_NULLMODEM_DTR_EVENT, 50);
++				LOG_MSG("Serial%d: Waiting for DTR...",COMNUMBER);
++			} else if (!ClientConnect(
++				new TCPClientSocket((char*)hostnamebuffer,(Bit16u)clientport)))
++				return;
++		} else {
++			// we are a server
++			serverport = (Bit16u)temptcpport;
++			if (!ServerListen()) return;
++		}
+ 	}
+-
+-	// ....
+-
+-	CSerial::Init_Registers ();
++	CSerial::Init_Registers();
+ 	InstallationSuccessful = true;
+ 
+ 	setCTS(dtrrespect||transparent);
+ 	setDSR(dtrrespect||transparent);
+-	setRI (false);
+-	setCD (dtrrespect);
++	setRI(false);
++	setCD(clientsocket > 0); // CD on if connection established
+ }
+ 
+-CNullModem::~CNullModem () {
+-	if(serversocket) delete serversocket;
+-	if(clientsocket) delete clientsocket;
++CNullModem::~CNullModem() {
++	if (serversocket) delete serversocket;
++	if (clientsocket) delete clientsocket;
+ 	// remove events
+ 	for(Bit16u i = SERIAL_BASE_EVENT_COUNT+1;
+ 			i <= SERIAL_NULLMODEM_EVENT_COUNT; i++) {
+@@ -192,9 +162,8 @@
+ }
+ 
+ void CNullModem::WriteChar(Bit8u data) {
+-	
+-	if(clientsocket)clientsocket->SendByteBuffered(data);
+-	if(!tx_block) {
++	if (clientsocket)clientsocket->SendByteBuffered(data);
++	if (!tx_block) {
+ 		//LOG_MSG("setevreduct");
+ 		setEvent(SERIAL_TX_REDUCTION, (float)tx_gather);
+ 		tx_block=true;
+@@ -202,37 +171,75 @@
+ }
+ 
+ Bits CNullModem::readChar() {
+-	
+ 	Bits rxchar = clientsocket->GetcharNonBlock();
+-	if(telnet && rxchar>=0) return TelnetEmulation((Bit8u)rxchar);
+-	else if(rxchar==0xff && !transparent) {// escape char
++	if (telnet && rxchar>=0) return TelnetEmulation((Bit8u)rxchar);
++	else if (rxchar==0xff && !transparent) {// escape char
+ 		// get the next char
+ 		Bits rxchar = clientsocket->GetcharNonBlock();
+-		if(rxchar==0xff) return rxchar; // 0xff 0xff -> 0xff was meant
++		if (rxchar==0xff) return rxchar; // 0xff 0xff -> 0xff was meant
+ 		rxchar&0x1? setCTS(true) : setCTS(false);
+ 		rxchar&0x2? setDSR(true) : setDSR(false);
+-		if(rxchar&0x4) receiveByteEx(0x0,0x10);
++		if (rxchar&0x4) receiveByteEx(0x0,0x10);
+ 		return -1;	// no "payload" received
+ 	} else return rxchar;
+ }
+ 
+-void CNullModem::ClientConnect(){
++bool CNullModem::ClientConnect(TCPClientSocket* newsocket) {
+ 	Bit8u peernamebuf[16];
+-	clientsocket = new TCPClientSocket((char*)hostnamebuffer,
+-										(Bit16u)clientport); 
+-	if(!clientsocket->isopen) {
+-		LOG_MSG("Serial%d: Connection failed.",idnumber+1);
++	clientsocket = newsocket;
++ 
++	if (!clientsocket->isopen) {
++		LOG_MSG("Serial%d: Connection failed.",COMNUMBER);
+ 		delete clientsocket;
+ 		clientsocket=0;
+-		return;
++		setCD(false);
++		return false;
+ 	}
+ 	clientsocket->SetSendBufferSize(256);
+ 	clientsocket->GetRemoteAddressString(peernamebuf);
+ 	// transmit the line status
+-	if(!transparent) setRTSDTR(getRTS(), getDTR());
++	if (!transparent) setRTSDTR(getRTS(), getDTR());
++	rx_state=N_RX_IDLE;
++	LOG_MSG("Serial%d: Connected to %s",COMNUMBER,peernamebuf);
++	setEvent(SERIAL_POLLING_EVENT, 1);
++	setCD(true);
++	return true;
++}
++
++bool CNullModem::ServerListen() {
++	// Start the server listen port.
++	serversocket = new TCPServerSocket(serverport);
++	if (!serversocket->isopen) return false;
++	LOG_MSG("Serial%d: Nullmodem server waiting for connection on port %d...",
++		COMNUMBER,serverport);
++	setEvent(SERIAL_SERVER_POLLING_EVENT, 50);
++	setCD(false);
++	return true;
++}
++
++bool CNullModem::ServerConnect() {
++	// check if a connection is available.
++	clientsocket=serversocket->Accept();
++	if (!clientsocket) return false;
++	
++	Bit8u peeripbuf[16];
++	clientsocket->GetRemoteAddressString(peeripbuf);
++	LOG_MSG("Serial%d: A client (%s) has connected.",COMNUMBER,peeripbuf);
++#if SERIAL_DEBUG
++	log_ser(dbg_aux,"Nullmodem: A client (%s) has connected.", peeripbuf);
++#endif
++	clientsocket->SetSendBufferSize(256);
+ 	rx_state=N_RX_IDLE;
+-	LOG_MSG("Serial%d: Connected to %s",idnumber+1,peernamebuf);
+ 	setEvent(SERIAL_POLLING_EVENT, 1);
++	
++	// we don't accept further connections
++	delete serversocket;
++	serversocket=0;
++
++	// transmit the line status
++	setRTSDTR(getRTS(), getDTR());
++	if (transparent) setCD(true);
++	return true;
+ }
+ 
+ void CNullModem::Disconnect() {
+@@ -244,11 +251,16 @@
+ 	clientsocket=0;
+ 	setDSR(false);
+ 	setCTS(false);
+-	if(serverport) {
++	setCD(false);
++	
++	if (serverport) {
+ 		serversocket = new TCPServerSocket(serverport);
+-		if(serversocket->isopen) 
++		if (serversocket->isopen) 
+ 			setEvent(SERIAL_SERVER_POLLING_EVENT, 50);
+ 		else delete serversocket;
++	} else if (dtrrespect) {
++		setEvent(SERIAL_NULLMODEM_DTR_EVENT,50);
++		DTR_delta = getDTR(); // try to reconnect the next time DTR is set
+ 	}
+ }
+ 
+@@ -263,8 +275,8 @@
+ 			updateMSR();
+ 			switch(rx_state) {
+ 				case N_RX_IDLE:
+-					if(CanReceiveByte()) {
+-						if(doReceive()) {
++					if (CanReceiveByte()) {
++						if (doReceive()) {
+ 							// a byte was received
+ 							rx_state=N_RX_WAIT;
+ 							setEvent(SERIAL_RX_EVENT, bytetime*0.9f);
+@@ -280,13 +292,13 @@
+ 					break;
+ 				case N_RX_BLOCKED:
+                     // one timeout tick
+-					if(!CanReceiveByte()) {
++					if (!CanReceiveByte()) {
+ 						rx_retry++;
+-						if(rx_retry>=rx_retry_max) {
++						if (rx_retry>=rx_retry_max) {
+ 							// it has timed out:
+ 							rx_retry=0;
+ 							removeEvent(SERIAL_RX_EVENT);
+-							if(doReceive()) {
++							if (doReceive()) {
+ 								// read away everything
+ 								while(doReceive());
+ 								rx_state=N_RX_WAIT;
+@@ -303,7 +315,7 @@
+ 						// good: we can receive again
+ 						removeEvent(SERIAL_RX_EVENT);
+ 						rx_retry=0;
+-						if(doReceive()) {
++						if (doReceive()) {
+ 							rx_state=N_RX_FASTWAIT;
+ 							setEvent(SERIAL_RX_EVENT, bytetime*0.65f);
+ 						} else {
+@@ -328,11 +340,11 @@
+ 				case N_RX_BLOCKED: // try to receive
+ 				case N_RX_WAIT:
+ 				case N_RX_FASTWAIT:
+-					if(CanReceiveByte()) {
++					if (CanReceiveByte()) {
+ 						// just works or unblocked
+-						if(doReceive()) {
++						if (doReceive()) {
+ 							rx_retry=0; // not waiting anymore
+-							if(rx_state==N_RX_WAIT) setEvent(SERIAL_RX_EVENT, bytetime*0.9f);
++							if (rx_state==N_RX_WAIT) setEvent(SERIAL_RX_EVENT, bytetime*0.9f);
+ 							else {
+ 								// maybe unblocked
+ 								rx_state=N_RX_FASTWAIT;
+@@ -346,7 +358,7 @@
+ 					} else {
+ 						// blocking now or still blocked
+ #if SERIAL_DEBUG
+-						if(rx_state==N_RX_BLOCKED)
++						if (rx_state==N_RX_BLOCKED)
+ 							log_ser(dbg_aux,"Nullmodem: rx still blocked (retry=%d)",rx_retry);
+ 						else log_ser(dbg_aux,"Nullmodem: block on continued rx (retry=%d).",rx_retry);
+ #endif
+@@ -360,8 +372,8 @@
+ 		}
+ 		case SERIAL_TX_EVENT: {
+ 			// Maybe echo cirquit works a bit better this way
+-			if(rx_state==N_RX_IDLE && CanReceiveByte() && clientsocket) {
+-				if(doReceive()) {
++			if (rx_state==N_RX_IDLE && CanReceiveByte() && clientsocket) {
++				if (doReceive()) {
+ 					// a byte was received
+ 					rx_state=N_RX_WAIT;
+ 					setEvent(SERIAL_RX_EVENT, bytetime*0.9f);
+@@ -379,25 +391,7 @@
+ 		case SERIAL_SERVER_POLLING_EVENT: {
+ 			// As long as nothing is connected to our server poll the
+ 			// connection.
+-			clientsocket=serversocket->Accept();
+-			if(clientsocket) {
+-				Bit8u peeripbuf[16];
+-				clientsocket->GetRemoteAddressString(peeripbuf);
+-				LOG_MSG("Serial%d: A client (%s) has connected.",COMNUMBER,peeripbuf);
+-#if SERIAL_DEBUG
+-				log_ser(dbg_aux,"Nullmodem: A client (%s) has connected.", peeripbuf);
+-#endif// new socket found...
+-				clientsocket->SetSendBufferSize(256);
+-				rx_state=N_RX_IDLE;
+-				setEvent(SERIAL_POLLING_EVENT, 1);
+-				
+-				// we don't accept further connections
+-				delete serversocket;
+-				serversocket=0;
+-
+-				// transmit the line status
+-				setRTSDTR(getRTS(), getDTR());
+-			} else {
++			if (!ServerConnect()) {
+ 				// continue looking
+ 				setEvent(SERIAL_SERVER_POLLING_EVENT, 50);
+ 			}
+@@ -405,13 +399,19 @@
+ 		}
+ 		case SERIAL_TX_REDUCTION: {
+ 			// Flush the data in the transmitting buffer.
+-			if(clientsocket) clientsocket->FlushBuffer();
++			if (clientsocket) clientsocket->FlushBuffer();
+ 			tx_block=false;
+ 			break;						  
+ 		}
+ 		case SERIAL_NULLMODEM_DTR_EVENT: {
+-			if(getDTR()) ClientConnect();
+-			else setEvent(SERIAL_NULLMODEM_DTR_EVENT,50);
++			if ((!DTR_delta) && getDTR()) {
++				// DTR went positive. Try to connect.
++				if (ClientConnect(new TCPClientSocket((char*)hostnamebuffer,
++								(Bit16u)clientport)))
++					break; // no more DTR wait event when connected
++			}
++			DTR_delta = getDTR();
++			setEvent(SERIAL_NULLMODEM_DTR_EVENT,50);
+ 			break;
+ 		}
+ 	}
+@@ -431,11 +431,11 @@
+ 
+ bool CNullModem::doReceive () {
+ 		Bits rxchar = readChar();
+-		if(rxchar>=0) {
++		if (rxchar>=0) {
+ 			receiveByteEx((Bit8u)rxchar,0);
+ 			return true;
+ 		}
+-		else if(rxchar==-2) {
++		else if (rxchar==-2) {
+ 			Disconnect();
+ 		}
+ 		return false;
+@@ -443,7 +443,7 @@
+  
+ void CNullModem::transmitByte (Bit8u val, bool first) {
+  	// transmit it later in THR_Event
+-	if(first) setEvent(SERIAL_THR_EVENT, bytetime/8);
++	if (first) setEvent(SERIAL_THR_EVENT, bytetime/8);
+ 	else setEvent(SERIAL_TX_EVENT, bytetime);
+ 
+ 	// disable 0xff escaping when transparent mode is enabled
+@@ -454,73 +454,73 @@
+ 
+ Bits CNullModem::TelnetEmulation(Bit8u data) {
+ 	Bit8u response[3];
+-	if(telClient.inIAC) {
+-		if(telClient.recCommand) {
+-			if((data != 0) && (data != 1) && (data != 3)) {
++	if (telClient.inIAC) {
++		if (telClient.recCommand) {
++			if ((data != 0) && (data != 1) && (data != 3)) {
+ 				LOG_MSG("Serial%d: Unrecognized telnet option %d",COMNUMBER, data);
+-				if(telClient.command>250) {
++				if (telClient.command>250) {
+ 					/* Reject anything we don't recognize */
+ 					response[0]=0xff;
+ 					response[1]=252;
+ 					response[2]=data; /* We won't do crap! */
+-					if(clientsocket) clientsocket->SendArray(response, 3);
++					if (clientsocket) clientsocket->SendArray(response, 3);
+ 				}
+ 			}
+ 			switch(telClient.command) {
+ 				case 251: /* Will */
+-					if(data == 0) telClient.binary[TEL_SERVER] = true;
+-					if(data == 1) telClient.echo[TEL_SERVER] = true;
+-					if(data == 3) telClient.supressGA[TEL_SERVER] = true;
++					if (data == 0) telClient.binary[TEL_SERVER] = true;
++					if (data == 1) telClient.echo[TEL_SERVER] = true;
++					if (data == 3) telClient.supressGA[TEL_SERVER] = true;
+ 					break;
+ 				case 252: /* Won't */
+-					if(data == 0) telClient.binary[TEL_SERVER] = false;
+-					if(data == 1) telClient.echo[TEL_SERVER] = false;
+-					if(data == 3) telClient.supressGA[TEL_SERVER] = false;
++					if (data == 0) telClient.binary[TEL_SERVER] = false;
++					if (data == 1) telClient.echo[TEL_SERVER] = false;
++					if (data == 3) telClient.supressGA[TEL_SERVER] = false;
+ 					break;
+ 				case 253: /* Do */
+-					if(data == 0) {
++					if (data == 0) {
+ 						telClient.binary[TEL_CLIENT] = true;
+ 							response[0]=0xff;
+ 							response[1]=251;
+ 							response[2]=0; /* Will do binary transfer */
+-							if(clientsocket) clientsocket->SendArray(response, 3);
++							if (clientsocket) clientsocket->SendArray(response, 3);
+ 					}
+-					if(data == 1) {
++					if (data == 1) {
+ 						telClient.echo[TEL_CLIENT] = false;
+ 							response[0]=0xff;
+ 							response[1]=252;
+ 							response[2]=1; /* Won't echo (too lazy) */
+-							if(clientsocket) clientsocket->SendArray(response, 3);
++							if (clientsocket) clientsocket->SendArray(response, 3);
+ 					}
+-					if(data == 3) {
++					if (data == 3) {
+ 						telClient.supressGA[TEL_CLIENT] = true;
+ 							response[0]=0xff;
+ 							response[1]=251;
+ 							response[2]=3; /* Will Suppress GA */
+-							if(clientsocket) clientsocket->SendArray(response, 3);
++							if (clientsocket) clientsocket->SendArray(response, 3);
+ 					}
+ 					break;
+ 				case 254: /* Don't */
+-					if(data == 0) {
++					if (data == 0) {
+ 						telClient.binary[TEL_CLIENT] = false;
+ 						response[0]=0xff;
+ 						response[1]=252;
+ 						response[2]=0; /* Won't do binary transfer */
+-						if(clientsocket) clientsocket->SendArray(response, 3);
++						if (clientsocket) clientsocket->SendArray(response, 3);
+ 					}
+-					if(data == 1) {
++					if (data == 1) {
+ 						telClient.echo[TEL_CLIENT] = false;
+ 						response[0]=0xff;
+ 						response[1]=252;
+ 						response[2]=1; /* Won't echo (fine by me) */
+-						if(clientsocket) clientsocket->SendArray(response, 3);
++						if (clientsocket) clientsocket->SendArray(response, 3);
+ 					}
+-					if(data == 3) {
++					if (data == 3) {
+ 						telClient.supressGA[TEL_CLIENT] = true;
+ 						response[0]=0xff;
+ 						response[1]=251;
+ 						response[2]=3; /* Will Suppress GA (too lazy) */
+-						if(clientsocket) clientsocket->SendArray(response, 3);
++						if (clientsocket) clientsocket->SendArray(response, 3);
+ 					}
+ 					break;
+ 				default:
+@@ -531,7 +531,7 @@
+ 			telClient.recCommand = false;
+ 			return -1; //continue;
+ 		} else {
+-			if(data==249) {
++			if (data==249) {
+ 				/* Go Ahead received */
+ 				telClient.inIAC = false;
+ 				return -1; //continue;
+@@ -539,7 +539,7 @@
+ 			telClient.command = data;
+ 			telClient.recCommand = true;
+ 			
+-			if((telClient.binary[TEL_SERVER]) && (data == 0xff)) {
++			if ((telClient.binary[TEL_SERVER]) && (data == 0xff)) {
+ 				/* Binary data with value of 255 */
+ 				telClient.inIAC = false;
+ 				telClient.recCommand = false;
+@@ -547,7 +547,7 @@
+ 			}
+ 		}
+ 	} else {
+-		if(data == 0xff) {
++		if (data == 0xff) {
+ 			telClient.inIAC = true;
+ 			return -1;
+ 		}
+@@ -569,14 +569,14 @@
+ /* updateModemControlLines(mcr) sets DTR and RTS.                           **/
+ /*****************************************************************************/
+ void CNullModem::setRTSDTR(bool xrts, bool xdtr) {
+-	if(!transparent) {
++	if (!transparent) {
+ 		Bit8u control[2];
+ 		control[0]=0xff;
+ 		control[1]=0x0;
+-		if(xrts) control[1]|=1;
+-		if(xdtr) control[1]|=2;
+-		if(LCR&LCR_BREAK_MASK) control[1]|=4;
+-		if(clientsocket) clientsocket->SendArray(control, 2);
++		if (xrts) control[1]|=1;
++		if (xdtr) control[1]|=2;
++		if (LCR&LCR_BREAK_MASK) control[1]|=4;
++		if (clientsocket) clientsocket->SendArray(control, 2);
+ 	}
+ }
+ void CNullModem::setRTS(bool val) {
+diff -Nur dosbox-0.74/src/hardware/serialport/nullmodem.h dosbox/src/hardware/serialport/nullmodem.h
+--- dosbox-0.74/src/hardware/serialport/nullmodem.h	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/hardware/serialport/nullmodem.h	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,7 +16,6 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: nullmodem.h,v 1.4 2009-09-25 23:40:47 h-a-l-9000 Exp $ */
+ 
+ // include guard
+ #ifndef DOSBOX_NULLMODEM_WIN32_H
+@@ -36,16 +35,8 @@
+ 
+ class CNullModem : public CSerial {
+ public:
+-	TCPServerSocket* serversocket;
+-	TCPClientSocket* clientsocket;
+-
+ 	CNullModem(Bitu id, CommandLine* cmd);
+ 	~CNullModem();
+-	bool receiveblock;		// It's not a block of data it rather blocks
+-	Bit16u serverport;		// we are a server if this is nonzero
+-	Bit16u clientport;
+-
+-	Bit8u hostnamebuffer[128]; // the name passed to us by the user
+ 
+ 	void updatePortConfig(Bit16u divider, Bit8u lcr);
+ 	void updateMSR();
+@@ -57,6 +48,16 @@
+ 	void setDTR(bool val);
+ 	void handleUpperEvent(Bit16u type);
+ 
++private:
++	TCPServerSocket* serversocket;
++	TCPClientSocket* clientsocket;
++
++	bool receiveblock;		// It's not a block of data it rather blocks
++	Bit16u serverport;		// we are a server if this is nonzero
++	Bit16u clientport;
++
++	Bit8u hostnamebuffer[128]; // the name passed to us by the user
++
+ 	Bitu rx_state;
+ #define N_RX_IDLE		0
+ #define N_RX_WAIT		1
+@@ -65,11 +66,17 @@
+ #define N_RX_DISC		4
+ 
+ 	bool doReceive();
+-	void ClientConnect();
++	bool ClientConnect(TCPClientSocket* newsocket);
++	bool ServerListen();
++	bool ServerConnect();
+     void Disconnect();
+ 	Bits readChar();
+ 	void WriteChar(Bit8u data);
+ 
++	bool DTR_delta;		// with dtrrespect, we try to establish a connection
++						// whenever DTR switches to 1. This variable is
++						// used to remember the old state.
++
+ 	bool tx_block;		// true while the SERIAL_TX_REDUCTION event
+ 						// is pending
+ 
+diff -Nur dosbox-0.74/src/hardware/serialport/serialdummy.cpp dosbox/src/hardware/serialport/serialdummy.cpp
+--- dosbox-0.74/src/hardware/serialport/serialdummy.cpp	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/hardware/serialport/serialdummy.cpp	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,7 +16,6 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: serialdummy.cpp,v 1.5 2009-05-27 09:15:41 qbix79 Exp $ */
+ 
+ #include "dosbox.h"
+ 
+diff -Nur dosbox-0.74/src/hardware/serialport/serialdummy.h dosbox/src/hardware/serialport/serialdummy.h
+--- dosbox-0.74/src/hardware/serialport/serialdummy.h	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/hardware/serialport/serialdummy.h	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,7 +16,6 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: serialdummy.h,v 1.5 2009-05-27 09:15:41 qbix79 Exp $ */
+ 
+ #ifndef INCLUDEGUARD_SERIALDUMMY_H
+ #define INCLUDEGUARD_SERIALDUMMY_H
+diff -Nur dosbox-0.74/src/hardware/serialport/serialport.cpp dosbox/src/hardware/serialport/serialport.cpp
+--- dosbox-0.74/src/hardware/serialport/serialport.cpp	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/hardware/serialport/serialport.cpp	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,7 +16,6 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: serialport.cpp,v 1.14 2009-10-01 17:25:28 h-a-l-9000 Exp $ */
+ 
+ #include <string.h>
+ #include <ctype.h>
+@@ -224,7 +223,8 @@
+ 	else bitlen = (1000.0f/115200.0f)*(float)baud_divider;
+ 	bytetime=bitlen*(float)(1+5+1);		// startbit + minimum length + stopbit
+ 	bytetime+= bitlen*(float)(LCR&0x3); // databits
+-	if(LCR&0x4) bytetime+=bitlen;		// stopbit
++	if(LCR&0x4) bytetime+=bitlen;		// 2nd stopbit
++	if(LCR&0x8) bytetime+=bitlen;		// parity
+ 
+ #if SERIAL_DEBUG
+ 	const char* const dbgtext[]={"none","odd","none","even","none","mark","none","space"};
+diff -Nur dosbox-0.74/src/hardware/serialport/softmodem.cpp dosbox/src/hardware/serialport/softmodem.cpp
+--- dosbox-0.74/src/hardware/serialport/softmodem.cpp	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/hardware/serialport/softmodem.cpp	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,7 +16,6 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: softmodem.cpp,v 1.12 2009-10-04 20:57:40 h-a-l-9000 Exp $ */
+ 
+ #include "dosbox.h"
+ 
+@@ -363,18 +362,23 @@
+ 				helper[0]=0;
+ 				helper--;
+ 			}
++
++			//Large enough scope, so the buffers are still valid when reaching Dail.
++			char buffer[128];
++			char obuffer[128];
+ 			if (strlen(foundstr) >= 12) {
+ 				// Check if supplied parameter only consists of digits
+ 				bool isNum = true;
+-				for (Bitu i=0; i<strlen(foundstr); i++)
++				size_t fl = strlen(foundstr);
++				for (size_t i = 0; i < fl; i++)
+ 					if (foundstr[i] < '0' || foundstr[i] > '9') isNum = false;
+ 				if (isNum) {
+ 					// Parameter is a number with at least 12 digits => this cannot
+ 					// be a valid IP/name
+ 					// Transform by adding dots
+-					char buffer[128];
+-					Bitu j = 0;
+-					for (Bitu i=0; i<strlen(foundstr); i++) {
++					size_t j = 0;
++					size_t foundlen = strlen(foundstr);
++					for (size_t i = 0; i < foundlen; i++) {
+ 						buffer[j++] = foundstr[i];
+ 						// Add a dot after the third, sixth and ninth number
+ 						if (i == 2 || i == 5 || i == 8)
+@@ -386,6 +390,19 @@
+ 					}
+ 					buffer[j] = 0;
+ 					foundstr = buffer;
++
++					// Remove Zeros from beginning of octets
++					size_t k = 0;
++					size_t foundlen2 = strlen(foundstr);
++					for (size_t i = 0; i < foundlen2; i++) {
++						if (i == 0 && foundstr[0] == '0') continue;
++						if (i == 1 && foundstr[0] == '0' && foundstr[1] == '0') continue;
++						if (foundstr[i] == '0' && foundstr[i-1] == '.') continue;
++						if (foundstr[i] == '0' && foundstr[i-1] == '0' && foundstr[i-2] == '.') continue;
++						obuffer[k++] = foundstr[i];
++						}
++					obuffer[k] = 0;
++					foundstr = obuffer;
+ 				}
+ 			}
+ 			Dial(foundstr);
+@@ -393,8 +410,8 @@
+ 		}
+ 		case 'I': // Some strings about firmware
+ 			switch (ScanNumber(scanbuf)) {
+-			case 3: SendLine("DosBox Emulated Modem Firmware V1.00"); break;
+-			case 4: SendLine("Modem compiled for DosBox version " VERSION); break;
++			case 3: SendLine("DOSBox Emulated Modem Firmware V1.00"); break;
++			case 4: SendLine("Modem compiled for DOSBox version " VERSION); break;
+ 			}
+ 			break;
+ 		case 'E': // Echo on/off
+diff -Nur dosbox-0.74/src/hardware/serialport/softmodem.h dosbox/src/hardware/serialport/softmodem.h
+--- dosbox-0.74/src/hardware/serialport/softmodem.h	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/hardware/serialport/softmodem.h	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,7 +16,6 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: softmodem.h,v 1.12 2009-10-04 20:57:40 h-a-l-9000 Exp $ */
+ 
+ #ifndef DOSBOX_SERIALMODEM_H
+ #define DOSBOX_SERIALMODEM_H
+diff -Nur dosbox-0.74/src/hardware/tandy_sound.cpp dosbox/src/hardware/tandy_sound.cpp
+--- dosbox-0.74/src/hardware/tandy_sound.cpp	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/hardware/tandy_sound.cpp	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+diff -Nur dosbox-0.74/src/hardware/timer.cpp dosbox/src/hardware/timer.cpp
+--- dosbox-0.74/src/hardware/timer.cpp	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/hardware/timer.cpp	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,7 +16,6 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: timer.cpp,v 1.49 2009-04-10 09:53:04 c2woody Exp $ */
+ 
+ #include <math.h>
+ #include "dosbox.h"
+@@ -138,8 +137,14 @@
+ 	p->go_read_latch=false;
+ 
+ 	//If gate2 is disabled don't update the read_latch
+-	if(counter == 2 && !gate2 && p->mode !=1) return;
+-
++	if (counter == 2 && !gate2 && p->mode !=1) return;
++	if (GCC_UNLIKELY(p->new_mode)) {
++		double passed_time = PIC_FullIndex() - p->start;
++		Bitu ticks_since_then = (Bitu)(passed_time / (1000.0/PIT_TICK_RATE));
++		//if (p->mode==3) ticks_since_then /= 2; // TODO figure this out on real hardware
++		p->read_latch -= ticks_since_then;
++		return;
++	}
+ 	double index=PIC_FullIndex()-p->start;
+ 	switch (p->mode) {
+ 	case 4:		/* Software Triggered Strobe */
+@@ -299,6 +304,10 @@
+ 			/* Counter latch command */
+ 			counter_latch(latch);
+ 		} else {
++			// save output status to be used with timer 0 irq
++			bool old_output = counter_output(0);
++			// save the current count value to be re-used in undocumented newmode
++			counter_latch(latch);
+ 			pit[latch].bcd = (val&1)>0;   
+ 			if (val & 1) {
+ 				if(pit[latch].cntr>=9999) pit[latch].cntr=9999;
+@@ -309,6 +318,8 @@
+ 				pit[latch].counterstatus_set=false;
+ 				latched_timerstatus_locked=false;
+ 			}
++			pit[latch].start = PIC_FullIndex(); // for undocumented newmode
++			pit[latch].go_read_latch = true;
+ 			pit[latch].update_count = false;
+ 			pit[latch].counting = false;
+ 			pit[latch].read_state  = (val >> 4) & 0x03;
+@@ -317,9 +328,7 @@
+ 			if (mode > 5)
+ 				mode -= 4; //6,7 become 2 and 3
+ 
+-			/* Don't set it directly so counter_output uses the old mode */
+-			/* That's theory. It breaks panic. So set it here again */
+-			if(!pit[latch].mode) pit[latch].mode     = mode;
++			pit[latch].mode = mode;
+ 
+ 			/* If the line goes from low to up => generate irq. 
+ 			 *      ( BUT needs to stay up until acknowlegded by the cpu!!! therefore: )
+@@ -327,20 +336,17 @@
+ 			 * Mode 0 starts with a low line. (so always disable irq)
+ 			 * Mode 2,3 start with a high line.
+ 			 * counter_output tells if the current counter is high or low 
+-			 * So actually a mode 2 timer enables and disables irq al the time. (not handled) */
++			 * So actually a mode 3 timer enables and disables irq al the time. (not handled) */
+ 
+ 			if (latch == 0) {
+ 				PIC_RemoveEvents(PIT0_Event);
+-				if (!counter_output(0) && mode) {
++				if((mode != 0)&& !old_output) {
+ 					PIC_ActivateIRQ(0);
+-					//Don't raise instantaniously. (Origamo)
+-					if(CPU_Cycles < 25) CPU_Cycles = 25;
+-				}
+-				if(!mode)
++				} else {
+ 					PIC_DeActivateIRQ(0);
++				}
+ 			}
+ 			pit[latch].new_mode = true;
+-			pit[latch].mode     = mode; //Set the correct mode (here)
+ 		}
+ 		break;
+     case 3:
+diff -Nur dosbox-0.74/src/hardware/vga_attr.cpp dosbox/src/hardware/vga_attr.cpp
+--- dosbox-0.74/src/hardware/vga_attr.cpp	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/hardware/vga_attr.cpp	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,7 +16,6 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: vga_attr.cpp,v 1.31 2009-06-28 14:56:13 c2woody Exp $ */
+ 
+ #include "dosbox.h"
+ #include "inout.h"
+@@ -24,22 +23,70 @@
+ 
+ #define attr(blah) vga.attr.blah
+ 
+-void VGA_ATTR_SetPalette(Bit8u index,Bit8u val) {
+-	vga.attr.palette[index] = val;
+-	if (vga.attr.mode_control & 0x80) val = (val&0xf) | (vga.attr.color_select << 4);
+-	val &= 63;
+-	val |= (vga.attr.color_select & 0xc) << 4;
+-	if (GCC_UNLIKELY(machine==MCH_EGA)) {
+-		if ((vga.crtc.vertical_total | ((vga.crtc.overflow & 1) << 8)) == 260) {
+-			// check for intensity bit
+-			if (val&0x10) val|=0x38;
+-			else {
+-				val&=0x7;
+-				// check for special brown
+-				if (val==6) val=0x14;
++void VGA_ATTR_SetEGAMonitorPalette(EGAMonitorMode m) {
++	// palette bit assignment:
++	// bit | pin | EGA        | CGA       | monochrome
++	// ----+-----+------------+-----------+------------
++	// 0   | 5   | blue       | blue      | nc
++	// 1   | 4   | green      | green*    | nc
++	// 2   | 3   | red        | red*      | nc
++	// 3   | 7   | blue sec.  | nc        | video
++	// 4   | 6   | green sec. | intensity | intensity
++	// 5   | 2   | red sec.   | nc        | nc
++    // 6-7 | not used
++	// * additive color brown instead of yellow
++	switch(m) {
++		case CGA:
++			//LOG_MSG("Monitor CGA");
++			for (Bitu i=0;i<64;i++) {
++				vga.dac.rgb[i].red=((i & 0x4)? 0x2a:0) + ((i & 0x10)? 0x15:0);
++				vga.dac.rgb[i].blue=((i & 0x1)? 0x2a:0) + ((i & 0x10)? 0x15:0);
++				
++				// replace yellow with brown
++				if ((i & 0x17) == 0x6) vga.dac.rgb[i].green = 0x15;
++				else vga.dac.rgb[i].green =
++					((i & 0x2)? 0x2a:0) + ((i & 0x10)? 0x15:0);
+ 			}
+-		}
++			break;
++		case EGA:
++			//LOG_MSG("Monitor EGA");
++			for (Bitu i=0;i<64;i++) {
++				vga.dac.rgb[i].red=((i & 0x4)? 0x2a:0) + ((i & 0x20)? 0x15:0);
++				vga.dac.rgb[i].green=((i & 0x2)? 0x2a:0) + ((i & 0x10)? 0x15:0);
++				vga.dac.rgb[i].blue=((i & 0x1)? 0x2a:0) + ((i & 0x8)? 0x15:0);
++			}
++			break;
++		case MONO:
++			//LOG_MSG("Monitor MONO");
++			for (Bitu i=0;i<64;i++) {
++				Bit8u value = ((i & 0x8)? 0x2a:0) + ((i & 0x10)? 0x15:0);
++				vga.dac.rgb[i].red = vga.dac.rgb[i].green =
++					vga.dac.rgb[i].blue = value;
++			}
++			break;
+ 	}
++
++	// update the mappings
++	for (Bit8u i=0;i<0x10;i++)
++		VGA_ATTR_SetPalette(i,vga.attr.palette[i]);
++}
++
++void VGA_ATTR_SetPalette(Bit8u index, Bit8u val) {
++	// the attribute table stores only 6 bits
++	val &= 63; 
++	vga.attr.palette[index] = val;
++
++	// apply the plane mask
++	val = vga.attr.palette[index & vga.attr.color_plane_enable];
++
++	// replace bits 4-5 if configured
++	if (vga.attr.mode_control & 0x80)
++		val = (val&0xf) | (vga.attr.color_select << 4);
++
++	// set bits 6 and 7 (not relevant for EGA)
++	val |= (vga.attr.color_select & 0xc) << 4;
++
++	// apply
+ 	VGA_DAC_CombineColor(index,val);
+ }
+ 
+@@ -76,26 +123,33 @@
+ 				10h and 14h.
+ 			*/
+ 			break;
+-		case 0x10: /* Mode Control Register */
++		case 0x10: { /* Mode Control Register */
+ 			if (!IS_VGA_ARCH) val&=0x1f;	// not really correct, but should do it
+-			if ((attr(mode_control) ^ val) & 0x80) {
+-				attr(mode_control)^=0x80;
+-				for (Bit8u i=0;i<0x10;i++) {
++			Bitu difference = attr(mode_control)^val;
++			attr(mode_control)=(Bit8u)val;
++
++			if (difference & 0x80) {
++				for (Bit8u i=0;i<0x10;i++)
+ 					VGA_ATTR_SetPalette(i,vga.attr.palette[i]);
+-				}
+ 			}
+-			if ((attr(mode_control) ^ val) & 0x08) {
++			if (difference & 0x08)
+ 				VGA_SetBlinking(val & 0x8);
+-			}
+-			if ((attr(mode_control) ^ val) & 0x04) {
+-				attr(mode_control)=(Bit8u)val;
+-				VGA_DetermineMode();
+-				if ((IS_VGA_ARCH) && (svgaCard==SVGA_None)) VGA_StartResize();
+-			} else {
+-				attr(mode_control)=(Bit8u)val;
++			
++			if (difference & 0x41)
+ 				VGA_DetermineMode();
+-			}
+ 
++			if (difference & 0x04) {
++				// recompute the panning value
++				if(vga.mode==M_TEXT) {
++					Bit8u pan_reg = attr(horizontal_pel_panning);
++					if (pan_reg > 7)
++						vga.config.pel_panning=0;
++					else if (val&0x4) // 9-dot wide characters
++						vga.config.pel_panning=(Bit8u)(pan_reg+1);
++					else // 8-dot characters
++						vga.config.pel_panning=(Bit8u)pan_reg;
++				}
++			}
+ 			/*
+ 				0	Graphics mode if set, Alphanumeric mode else.
+ 				1	Monochrome mode if set, color mode else.
+@@ -113,13 +167,21 @@
+ 					used.
+ 			*/
+ 			break;
++		}
+ 		case 0x11:	/* Overscan Color Register */
+ 			attr(overscan_color)=(Bit8u)val;
+ 			/* 0-5  Color of screen border. Color is defined as in the palette registers. */
+ 			break;
+ 		case 0x12:	/* Color Plane Enable Register */
+ 			/* Why disable colour planes? */
+-			attr(color_plane_enable)=(Bit8u)val;
++			/* To support weird modes. */
++			if ((attr(color_plane_enable)^val) & 0xf) {
++				// in case the plane enable bits change...
++				attr(color_plane_enable)=(Bit8u)val;
++				for (Bit8u i=0;i<0x10;i++)
++					VGA_ATTR_SetPalette(i,vga.attr.palette[i]);
++			} else
++				attr(color_plane_enable)=(Bit8u)val;
+ 			/* 
+ 				0	Bit plane 0 is enabled if set.
+ 				1	Bit plane 1 is enabled if set.
+@@ -134,9 +196,12 @@
+ 			attr(horizontal_pel_panning)=val & 0xF;
+ 			switch (vga.mode) {
+ 			case M_TEXT:
+-				if ((val==0x7) && (svgaCard==SVGA_None)) vga.config.pel_panning=7;
+-				if (val>0x7) vga.config.pel_panning=0;
+-				else vga.config.pel_panning=(Bit8u)(val+1);
++				if (val > 7)
++					vga.config.pel_panning=0;
++				else if (vga.attr.mode_control&0x4) // 9-dot wide characters
++					vga.config.pel_panning=(Bit8u)(val+1);
++				else // 8-dot characters
++					vga.config.pel_panning=(Bit8u)val;
+ 				break;
+ 			case M_VGA:
+ 			case M_LIN8:
+@@ -146,6 +211,9 @@
+ 			default:
+ 				vga.config.pel_panning=(val & 0x7);
+ 			}
++			if (machine==MCH_EGA)
++				// On the EGA panning can be programmed for every scanline:
++				vga.draw.panning = vga.config.pel_panning;
+ 			/*
+ 				0-3	Indicates number of pixels to shift the display left
+ 					Value  9bit textmode   256color mode   Other modes
+@@ -167,9 +235,8 @@
+ 			}
+ 			if (attr(color_select) ^ val) {
+ 				attr(color_select)=(Bit8u)val;
+-				for (Bit8u i=0;i<0x10;i++) {
++				for (Bit8u i=0;i<0x10;i++)
+ 					VGA_ATTR_SetPalette(i,vga.attr.palette[i]);
+-				}
+ 			}
+ 			/*
+ 				0-1	If 3C0h index 10h bit 7 is set these 2 bits are used as bits 4-5 of
+diff -Nur dosbox-0.74/src/hardware/vga.cpp dosbox/src/hardware/vga.cpp
+--- dosbox-0.74/src/hardware/vga.cpp	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/hardware/vga.cpp	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,7 +16,6 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: vga.cpp,v 1.36 2009-05-27 09:15:41 qbix79 Exp $ */
+ 
+ #include "dosbox.h"
+ //#include "setup.h"
+diff -Nur dosbox-0.74/src/hardware/vga_crtc.cpp dosbox/src/hardware/vga_crtc.cpp
+--- dosbox-0.74/src/hardware/vga_crtc.cpp	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/hardware/vga_crtc.cpp	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,7 +16,6 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: vga_crtc.cpp,v 1.34 2009-03-18 18:08:16 c2woody Exp $ */
+ 
+ #include <stdlib.h>
+ #include "dosbox.h"
+@@ -302,10 +301,14 @@
+ 		*/
+ 		break;
+ 	case 0x16:	/*  End Vertical Blank Register */
+-		crtc(end_vertical_blanking)=val;
+-		 /*
++		if (val!=crtc(end_vertical_blanking)) {
++			crtc(end_vertical_blanking)=val;
++			VGA_StartResize();
++		}
++		/*
+ 			0-6	Vertical blanking stops when the lower 7 bits of the line counter
+ 				equals this field. Some SVGA chips uses all 8 bits!
++				IBM actually says bits 0-7.
+ 		*/
+ 		break;
+ 	case 0x17:	/* Mode Control Register */
+diff -Nur dosbox-0.74/src/hardware/vga_dac.cpp dosbox/src/hardware/vga_dac.cpp
+--- dosbox-0.74/src/hardware/vga_dac.cpp	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/hardware/vga_dac.cpp	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -213,19 +213,5 @@
+ 		IO_RegisterReadHandler(0x3c8,read_p3c8,IO_MB);
+ 		IO_RegisterWriteHandler(0x3c9,write_p3c9,IO_MB);
+ 		IO_RegisterReadHandler(0x3c9,read_p3c9,IO_MB);
+-	} else if (machine==MCH_EGA) {
+-		for (Bitu i=0;i<64;i++) {
+-			if ((i&4)>0) vga.dac.rgb[i].red=0x2a;
+-			else vga.dac.rgb[i].red=0;
+-			if ((i&32)>0) vga.dac.rgb[i].red+=0x15;
+-
+-			if ((i&2)>0) vga.dac.rgb[i].green=0x2a;
+-			else vga.dac.rgb[i].green=0;
+-			if ((i&16)>0) vga.dac.rgb[i].green+=0x15;
+-
+-			if ((i&1)>0) vga.dac.rgb[i].blue=0x2a;
+-			else vga.dac.rgb[i].blue=0;
+-			if ((i&8)>0) vga.dac.rgb[i].blue+=0x15;
+-		}
+ 	}
+ }
+diff -Nur dosbox-0.74/src/hardware/vga_draw.cpp dosbox/src/hardware/vga_draw.cpp
+--- dosbox-0.74/src/hardware/vga_draw.cpp	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/hardware/vga_draw.cpp	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,7 +16,6 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: vga_draw.cpp,v 1.112 2009-11-03 21:06:59 h-a-l-9000 Exp $ */
+ 
+ #include <string.h>
+ #include <math.h>
+@@ -78,70 +77,61 @@
+ 
+ static Bit8u * VGA_Draw_CGA16_Line(Bitu vidstart, Bitu line) {
+ 	const Bit8u *base = vga.tandy.draw_base + ((line & vga.tandy.line_mask) << vga.tandy.line_shift);
+-	const Bit8u *reader = base + vidstart;
++#define CGA16_READER(OFF) (base[(vidstart +(OFF))& (8*1024 -1)])
+ 	Bit32u * draw=(Bit32u *)TempLine;
+-	//Generate a temporary bitline to calculate the avarage
+-	//over bit-2  bit-1  bit  bit+1.
+-	//Combine this number with the current colour to get 
+-	//an unigue index in the pallete. Or it with bit 7 as they are stored 
+-	//in the upperpart to keep them from interfering the regular cga stuff
+-
+-	for(Bitu x = 0; x < 640; x++)
+-		temp[x+2] = (( reader[(x>>3)] >> (7-(x&7)) )&1) << 4;
+-		//shift 4 as that is for the index.
+-	Bitu i = 0,temp1,temp2,temp3,temp4;
++	//There are 640 hdots in each line of the screen.
++	//The color of an even hdot always depends on only 4 bits of video RAM.
++	//The color of an odd hdot depends on 4 bits of video RAM in
++	//1-hdot-per-pixel modes and 6 bits of video RAM in 2-hdot-per-pixel
++	//modes. We always assume 6 and use duplicate palette entries in
++	//1-hdot-per-pixel modes so that we can use the same routine for all
++	//composite modes.
++  temp[1] = (CGA16_READER(0) >> 6) & 3;
++	for(Bitu x = 2; x < 640; x+=2) {
++		temp[x] = (temp[x-1] & 0xf);
++		temp[x+1] = (temp[x] << 2) | ((( CGA16_READER(x>>3)) >> (6-(x&6)) )&3);
++	}
++	temp[640] = temp[639] & 0xf;
++	temp[641] = temp[640] << 2;
++	temp[642] = temp[641] & 0xf;
++
++	Bitu i = 2;
+ 	for (Bitu x=0;x<vga.draw.blocks;x++) {
+-		Bitu val1 = *reader++;
+-		Bitu val2 = val1&0xf;
+-		val1 >>= 4;
+-
+-		temp1 = temp[i] + temp[i+1] + temp[i+2] + temp[i+3]; i++;
+-		temp2 = temp[i] + temp[i+1] + temp[i+2] + temp[i+3]; i++;
+-		temp3 = temp[i] + temp[i+1] + temp[i+2] + temp[i+3]; i++;
+-		temp4 = temp[i] + temp[i+1] + temp[i+2] + temp[i+3]; i++;
+-
+-		*draw++ = 0x80808080|(temp1|val1) |
+-		          ((temp2|val1) << 8) |
+-		          ((temp3|val1) <<16) |
+-		          ((temp4|val1) <<24);
+-		temp1 = temp[i] + temp[i+1] + temp[i+2] + temp[i+3]; i++;
+-		temp2 = temp[i] + temp[i+1] + temp[i+2] + temp[i+3]; i++;
+-		temp3 = temp[i] + temp[i+1] + temp[i+2] + temp[i+3]; i++;
+-		temp4 = temp[i] + temp[i+1] + temp[i+2] + temp[i+3]; i++;
+-		*draw++ = 0x80808080|(temp1|val2) |
+-		          ((temp2|val2) << 8) |
+-		          ((temp3|val2) <<16) |
+-		          ((temp4|val2) <<24);
++		*draw++ = 0xc0708030 | temp[i] | (temp[i+1] << 8) | (temp[i+2] << 16) | (temp[i+3] << 24);
++		i += 4;
++		*draw++ = 0xc0708030 | temp[i] | (temp[i+1] << 8) | (temp[i+2] << 16) | (temp[i+3] << 24);
++		i += 4;
+ 	}
+ 	return TempLine;
++#undef CGA16_READER
+ }
+ 
+ static Bit8u * VGA_Draw_4BPP_Line(Bitu vidstart, Bitu line) {
+ 	const Bit8u *base = vga.tandy.draw_base + ((line & vga.tandy.line_mask) << vga.tandy.line_shift);
+-	Bit32u * draw=(Bit32u *)TempLine;
+-	for (Bitu x=0;x<vga.draw.blocks;x++) {
+-		Bitu val1 = base[vidstart & vga.tandy.addr_mask];
+-		++vidstart;
+-		Bitu val2 = base[vidstart & vga.tandy.addr_mask];
+-		++vidstart;
+-		*draw++=(val1 & 0x0f) << 8  |
+-				(val1 & 0xf0) >> 4  |
+-				(val2 & 0x0f) << 24 |
+-				(val2 & 0xf0) << 12;
++	Bit8u* draw=TempLine;
++	Bitu end = vga.draw.blocks*2;
++	while(end) {
++		Bit8u byte = base[vidstart & vga.tandy.addr_mask];
++		*draw++=vga.attr.palette[byte >> 4];
++		*draw++=vga.attr.palette[byte & 0x0f];
++		vidstart++;
++		end--;
+ 	}
+ 	return TempLine;
+ }
+ 
+ static Bit8u * VGA_Draw_4BPP_Line_Double(Bitu vidstart, Bitu line) {
+ 	const Bit8u *base = vga.tandy.draw_base + ((line & vga.tandy.line_mask) << vga.tandy.line_shift);
+-	Bit32u * draw=(Bit32u *)TempLine;
+-	for (Bitu x=0;x<vga.draw.blocks;x++) {
+-		Bitu val = base[vidstart & vga.tandy.addr_mask];
+-		++vidstart;
+-		*draw++=(val & 0xf0) >> 4  |
+-				(val & 0xf0) << 4  |
+-				(val & 0x0f) << 16 |
+-				(val & 0x0f) << 24;
++	Bit8u* draw=TempLine;
++	Bitu end = vga.draw.blocks;
++	while(end) {
++		Bit8u byte = base[vidstart & vga.tandy.addr_mask];
++		Bit8u data = vga.attr.palette[byte >> 4];
++		*draw++ = data; *draw++ = data;
++		data = vga.attr.palette[byte & 0x0f];
++		*draw++ = data; *draw++ = data;
++		vidstart++;
++		end--;
+ 	}
+ 	return TempLine;
+ }
+@@ -155,7 +145,7 @@
+ 	for (; start <= end;start++) {
+ 		if ( map[start] & checkMask ) {
+ 			Bitu offset = vidstart & vga.draw.linear_mask;
+-			if(vga.draw.linear_mask-offset < vga.draw.line_length)
++			if (vga.draw.linear_mask-offset < vga.draw.line_length)
+ 				memcpy(vga.draw.linear_base+vga.draw.linear_mask+1, vga.draw.linear_base, vga.draw.line_length);
+ 			Bit8u *ret = &vga.draw.linear_base[ offset ];
+ #if !defined(C_UNALIGNED_MEMORY)
+@@ -175,12 +165,28 @@
+ #endif
+ 
+ static Bit8u * VGA_Draw_Linear_Line(Bitu vidstart, Bitu /*line*/) {
+-// There is guaranteed extra memory past the wrap boundary. So, instead of using temporary
+-// storage just copy appropriate chunk from the beginning to the wrap boundary when needed.
+ 	Bitu offset = vidstart & vga.draw.linear_mask;
+-	if (vga.draw.linear_mask-offset < vga.draw.line_length)
+-		memcpy(vga.draw.linear_base+vga.draw.linear_mask+1, vga.draw.linear_base, vga.draw.line_length);
+-	Bit8u *ret = &vga.draw.linear_base[ offset ];
++	Bit8u* ret = &vga.draw.linear_base[offset];
++	
++	// in case (vga.draw.line_length + offset) has bits set that
++	// are not set in the mask: ((x|y)!=y) equals (x&~y)
++	if (GCC_UNLIKELY((vga.draw.line_length + offset)& ~vga.draw.linear_mask)) {
++		// this happens, if at all, only once per frame (1 of 480 lines)
++		// in some obscure games
++		Bitu end = (offset + vga.draw.line_length) & vga.draw.linear_mask;
++		
++		// assuming lines not longer than 4096 pixels
++		Bitu wrapped_len = end & 0xFFF;
++		Bitu unwrapped_len = vga.draw.line_length-wrapped_len;
++		
++		// unwrapped chunk: to top of memory block
++		memcpy(TempLine, &vga.draw.linear_base[offset], unwrapped_len);
++		// wrapped chunk: from base of memory block
++		memcpy(&TempLine[unwrapped_len], vga.draw.linear_base, wrapped_len);
++
++		ret = TempLine;
++	}
++
+ #if !defined(C_UNALIGNED_MEMORY)
+ 	if (GCC_UNLIKELY( ((Bitu)ret) & (sizeof(Bitu)-1)) ) {
+ 		memcpy( TempLine, ret, vga.draw.line_length );
+@@ -197,14 +203,6 @@
+ 		temps[i]=vga.dac.xlat16[ret[i]];
+ 	}
+ 	return TempLine;
+-	/*
+-#if !defined(C_UNALIGNED_MEMORY)
+-	if (GCC_UNLIKELY( ((Bitu)ret) & (sizeof(Bitu)-1)) ) {
+-		memcpy( TempLine, ret, vga.draw.line_length );
+-		return TempLine;
+-	}
+-#endif
+-	return ret;*/
+ }
+ 
+ //Test version, might as well keep it
+@@ -446,167 +444,121 @@
+ skip_cursor:
+ 	return TempLine;
+ }
+-
+-static Bit8u * VGA_TEXT_Xlat16_Draw_Line(Bitu vidstart, Bitu line) {
+-	Bits font_addr;
+-	Bit16u * draw=(Bit16u *)TempLine;
+-	const Bit8u* vidmem = VGA_Text_Memwrap(vidstart);
+-	for (Bitu cx=0;cx<vga.draw.blocks;cx++) {
+-		Bitu chr=vidmem[cx*2];
+-		Bitu col=vidmem[cx*2+1];
+-		Bitu font=vga.draw.font_tables[(col >> 3)&1][chr*32+line];
+-		Bit32u mask1=TXT_Font_Table[font>>4] & FontMask[col >> 7];
+-		Bit32u mask2=TXT_Font_Table[font&0xf] & FontMask[col >> 7];
+-		Bit32u fg=TXT_FG_Table[col&0xf];
+-		Bit32u bg=TXT_BG_Table[col>>4];
+-		
+-		mask1=(fg&mask1) | (bg&~mask1);
+-		mask2=(fg&mask2) | (bg&~mask2);
+-
+-		for(int i = 0; i < 4; i++) {
+-			*draw++ = vga.dac.xlat16[(mask1>>8*i)&0xff];
+-		}
+-		for(int i = 0; i < 4; i++) {
+-			*draw++ = vga.dac.xlat16[(mask2>>8*i)&0xff];
+-		}
+-	}
+-	if (!vga.draw.cursor.enabled || !(vga.draw.cursor.count&0x8)) goto skip_cursor;
+-	font_addr = (vga.draw.cursor.address-vidstart) >> 1;
+-	if (font_addr>=0 && font_addr<(Bits)vga.draw.blocks) {
+-		if (line<vga.draw.cursor.sline) goto skip_cursor;
+-		if (line>vga.draw.cursor.eline) goto skip_cursor;
+-		draw=(Bit16u *)&TempLine[font_addr*16];
+-		Bit8u att=(Bit8u)(TXT_FG_Table[vga.tandy.draw_base[vga.draw.cursor.address+1]&0xf]&0xff);
+-		for(int i = 0; i < 8; i++) {
+-			*draw++ = vga.dac.xlat16[att];
+-		}
+-	}
+-skip_cursor:
+-	return TempLine;
+-}
+-
+ /*
+-static Bit8u * VGA_TEXT_Draw_Line_9(Bitu vidstart, Bitu line) {
+-	Bits font_addr;
+-	Bit8u * draw=(Bit8u *)TempLine;
+-	bool underline=(Bitu)(vga.crtc.underline_location&0x1f)==line;
+-	Bit8u pel_pan=(Bit8u)vga.draw.panning;
+-	if ((vga.attr.mode_control&0x20) && (vga.draw.lines_done>=vga.draw.split_line)) pel_pan=0;
+-	const Bit8u* vidmem = VGA_Text_Memwrap(vidstart);
+-	Bit8u chr=vidmem[0];
+-	Bit8u col=vidmem[1];
+-	Bit8u font=(vga.draw.font_tables[(col >> 3)&1][chr*32+line])<<pel_pan;
+-	if (underline && ((col&0x07) == 0x01)) font=0xff;
+-	Bit8u fg=col&0xf;
+-	Bit8u bg=(Bit8u)(TXT_BG_Table[col>>4]&0xff);
+-	Bitu draw_blocks=vga.draw.blocks;
+-	draw_blocks++;
+-	for (Bitu cx=1;cx<draw_blocks;cx++) {
+-		if (pel_pan) {
+-			chr=vidmem[cx*2];
+-			col=vidmem[cx*2+1];
+-			if (underline && ((col&0x07) == 0x01)) font|=0xff>>(8-pel_pan);
+-			else font|=vga.draw.font_tables[(col >> 3)&1][chr*32+line]>>(8-pel_pan);
+-			fg=col&0xf;
+-			bg=(Bit8u)(TXT_BG_Table[col>>4]&0xff);
++// combined 8/9-dot wide text mode 8bpp line drawing function
++static Bit8u* VGA_TEXT_Draw_Line(Bitu vidstart, Bitu line) {
++	// keep it aligned:
++	Bit8u* draw = ((Bit8u*)TempLine) + 16 - vga.draw.panning;
++	const Bit8u* vidmem = VGA_Text_Memwrap(vidstart); // pointer to chars+attribs
++	Bitu blocks = vga.draw.blocks;
++	if (vga.draw.panning) blocks++; // if the text is panned part of an 
++									// additional character becomes visible
++	while (blocks--) { // for each character in the line
++		Bitu chr = *vidmem++;
++		Bitu attr = *vidmem++;
++		// the font pattern
++		Bitu font = vga.draw.font_tables[(attr >> 3)&1][(chr<<5)+line];
++		
++		Bitu background = attr >> 4;
++		// if blinking is enabled bit7 is not mapped to attributes
++		if (vga.draw.blinking) background &= ~0x8;
++		// choose foreground color if blinking not set for this cell or blink on
++		Bitu foreground = (vga.draw.blink || (!(attr&0x80)))?
++			(attr&0xf):background;
++		// underline: all foreground [freevga: 0x77, previous 0x7]
++		if (GCC_UNLIKELY(((attr&0x77) == 0x01) &&
++			(vga.crtc.underline_location&0x1f)==line))
++				background = foreground;
++		if (vga.draw.char9dot) {
++			font <<=1; // 9 pixels
++			// extend to the 9th pixel if needed
++			if ((font&0x2) && (vga.attr.mode_control&0x04) &&
++				(chr>=0xc0) && (chr<=0xdf)) font |= 1;
++			for (Bitu n = 0; n < 9; n++) {
++				*draw++ = (font&0x100)? foreground:background;
++				font <<= 1;
++			}
+ 		} else {
+-			chr=vidmem[(cx-1)*2];
+-			col=vidmem[(cx-1)*2+1];
+-			if (underline && ((col&0x07) == 0x01)) font=0xff;
+-			else font=vga.draw.font_tables[(col >> 3)&1][chr*32+line];
+-			fg=col&0xf;
+-			bg=(Bit8u)(TXT_BG_Table[col>>4]&0xff);
+-		}
+-		if (FontMask[col>>7]==0) font=0;
+-		*draw++=(font&0x80)?fg:bg;		*draw++=(font&0x40)?fg:bg;
+-		*draw++=(font&0x20)?fg:bg;		*draw++=(font&0x10)?fg:bg;
+-		*draw++=(font&0x08)?fg:bg;		*draw++=(font&0x04)?fg:bg;
+-		*draw++=(font&0x02)?fg:bg;
+-		Bit8u last=(font&0x01)?fg:bg;
+-		*draw++=last;
+-		*draw++=((vga.attr.mode_control&0x04) && ((chr<0xc0) || (chr>0xdf))) ? bg : last;
+-		if (pel_pan) {
+-			if (underline && ((col&0x07) == 0x01)) font=0xff;
+-			else font=(vga.draw.font_tables[(col >> 3)&1][chr*32+line])<<pel_pan;
++			for (Bitu n = 0; n < 8; n++) {
++				*draw++ = (font&0x80)? foreground:background;
++				font <<= 1;
++			}
+ 		}
+ 	}
+-	if (!vga.draw.cursor.enabled || !(vga.draw.cursor.count&0x8)) goto skip_cursor;
+-	font_addr = (vga.draw.cursor.address-vidstart) >> 1;
+-	if (font_addr>=0 && font_addr<(Bits)vga.draw.blocks) {
+-		if (line<vga.draw.cursor.sline) goto skip_cursor;
+-		if (line>vga.draw.cursor.eline) goto skip_cursor;
+-		draw=&TempLine[font_addr*9];
+-		Bit8u fg=vga.tandy.draw_base[vga.draw.cursor.address+1]&0xf;
+-		*draw++=fg;		*draw++=fg;		*draw++=fg;		*draw++=fg;
+-		*draw++=fg;		*draw++=fg;		*draw++=fg;		*draw++=fg;
++	// draw the text mode cursor if needed
++	if ((vga.draw.cursor.count&0x8) && (line >= vga.draw.cursor.sline) &&
++		(line <= vga.draw.cursor.eline) && vga.draw.cursor.enabled) {
++		// the adress of the attribute that makes up the cell the cursor is in
++		Bits attr_addr = (vga.draw.cursor.address-vidstart) >> 1;
++		if (attr_addr >= 0 && attr_addr < (Bits)vga.draw.blocks) {
++			Bitu index = attr_addr * (vga.draw.char9dot? 9:8);
++			draw = (Bit8u*)(&TempLine[index]) + 16 - vga.draw.panning;
++			
++			Bitu foreground = vga.tandy.draw_base[vga.draw.cursor.address+1] & 0xf;
++			for (Bitu i = 0; i < 8; i++) {
++				*draw++ = foreground;
++			}
++		}
+ 	}
+-skip_cursor:
+-	return TempLine;
++	return TempLine+16;
+ }
+ */
+-
+-static Bit8u * VGA_TEXT_Xlat16_Draw_Line_9(Bitu vidstart, Bitu line) {
+-	Bits font_addr;
+-	Bit16u * draw=(Bit16u *)TempLine;
+-	bool underline=(Bitu)(vga.crtc.underline_location&0x1f)==line;
+-	Bit8u pel_pan=(Bit8u)vga.draw.panning;
+-	if ((vga.attr.mode_control&0x20) && (vga.draw.lines_done>=vga.draw.split_line)) pel_pan=0;
+-	const Bit8u* vidmem = VGA_Text_Memwrap(vidstart);
+-	Bit8u chr=vidmem[0];
+-	Bit8u col=vidmem[1];
+-	Bit8u font=(vga.draw.font_tables[(col >> 3)&1][chr*32+line])<<pel_pan;
+-	if (underline && ((col&0x07) == 0x01)) font=0xff;
+-	Bit8u fg=col&0xf;
+-	Bit8u bg=(Bit8u)(TXT_BG_Table[col>>4]&0xff);
+-	Bitu draw_blocks=vga.draw.blocks;
+-	draw_blocks++;
+-	for (Bitu cx=1;cx<draw_blocks;cx++) {
+-		if (pel_pan) {
+-			chr=vidmem[cx*2];
+-			col=vidmem[cx*2+1];
+-			if (underline && ((col&0x07) == 0x01)) font|=0xff>>(8-pel_pan);
+-			else font|=vga.draw.font_tables[(col >> 3)&1][chr*32+line]>>(8-pel_pan);
+-			fg=col&0xf;
+-			bg=(Bit8u)(TXT_BG_Table[col>>4]&0xff);
++// combined 8/9-dot wide text mode 16bpp line drawing function
++static Bit8u* VGA_TEXT_Xlat16_Draw_Line(Bitu vidstart, Bitu line) {
++	// keep it aligned:
++	Bit16u* draw = ((Bit16u*)TempLine) + 16 - vga.draw.panning;
++	const Bit8u* vidmem = VGA_Text_Memwrap(vidstart); // pointer to chars+attribs
++	Bitu blocks = vga.draw.blocks;
++	if (vga.draw.panning) blocks++; // if the text is panned part of an 
++									// additional character becomes visible
++	while (blocks--) { // for each character in the line
++		Bitu chr = *vidmem++;
++		Bitu attr = *vidmem++;
++		// the font pattern
++		Bitu font = vga.draw.font_tables[(attr >> 3)&1][(chr<<5)+line];
++		
++		Bitu background = attr >> 4;
++		// if blinking is enabled bit7 is not mapped to attributes
++		if (vga.draw.blinking) background &= ~0x8;
++		// choose foreground color if blinking not set for this cell or blink on
++		Bitu foreground = (vga.draw.blink || (!(attr&0x80)))?
++			(attr&0xf):background;
++		// underline: all foreground [freevga: 0x77, previous 0x7]
++		if (GCC_UNLIKELY(((attr&0x77) == 0x01) &&
++			(vga.crtc.underline_location&0x1f)==line))
++				background = foreground;
++		if (vga.draw.char9dot) {
++			font <<=1; // 9 pixels
++			// extend to the 9th pixel if needed
++			if ((font&0x2) && (vga.attr.mode_control&0x04) &&
++				(chr>=0xc0) && (chr<=0xdf)) font |= 1;
++			for (Bitu n = 0; n < 9; n++) {
++				*draw++ = vga.dac.xlat16[(font&0x100)? foreground:background];
++				font <<= 1;
++			}
+ 		} else {
+-			chr=vidmem[(cx-1)*2];
+-			col=vidmem[(cx-1)*2+1];
+-			if (underline && ((col&0x07) == 0x01)) font=0xff;
+-			else font=vga.draw.font_tables[(col >> 3)&1][chr*32+line];
+-			fg=col&0xf;
+-			bg=(Bit8u)(TXT_BG_Table[col>>4]&0xff);
+-		}
+-		if (FontMask[col>>7]==0) font=0;
+-		Bit8u mask=0x80;
+-		for (int i = 0; i < 7; i++) {
+-			*draw++=vga.dac.xlat16[font&mask?fg:bg];
+-			mask>>=1;
+-		}
+-		Bit16u lastval=vga.dac.xlat16[font&mask?fg:bg];
+-		*draw++=lastval;
+-		*draw++=(((vga.attr.mode_control&0x04) && ((chr<0xc0) || (chr>0xdf))) && 
+-			!(underline && ((col&0x07) == 0x01))) ? 
+-			(vga.dac.xlat16[bg]) : lastval;
+-		if (pel_pan) {
+-			if (underline && ((col&0x07) == 0x01)) font=0xff;
+-			else font=(vga.draw.font_tables[(col >> 3)&1][chr*32+line])<<pel_pan;
++			for (Bitu n = 0; n < 8; n++) {
++				*draw++ = vga.dac.xlat16[(font&0x80)? foreground:background];
++				font <<= 1;
++			}
+ 		}
+ 	}
+-	if (!vga.draw.cursor.enabled || !(vga.draw.cursor.count&0x8)) goto skip_cursor;
+-	font_addr = (vga.draw.cursor.address-vidstart) >> 1;
+-	if (font_addr>=0 && font_addr<(Bits)vga.draw.blocks) {
+-		if (line<vga.draw.cursor.sline) goto skip_cursor;
+-		if (line>vga.draw.cursor.eline) goto skip_cursor;
+-		draw=(Bit16u*)&TempLine[font_addr*18];
+-		Bit8u fg=vga.tandy.draw_base[vga.draw.cursor.address+1]&0xf;
+-		for(int i = 0; i < 8; i++) {
+-			*draw++ = vga.dac.xlat16[fg];
++	// draw the text mode cursor if needed
++	if ((vga.draw.cursor.count&0x8) && (line >= vga.draw.cursor.sline) &&
++		(line <= vga.draw.cursor.eline) && vga.draw.cursor.enabled) {
++		// the adress of the attribute that makes up the cell the cursor is in
++		Bits attr_addr = (vga.draw.cursor.address-vidstart) >> 1;
++		if (attr_addr >= 0 && attr_addr < (Bits)vga.draw.blocks) {
++			Bitu index = attr_addr * (vga.draw.char9dot? 18:16);
++			draw = (Bit16u*)(&TempLine[index]) + 16 - vga.draw.panning;
++			
++			Bitu foreground = vga.tandy.draw_base[vga.draw.cursor.address+1] & 0xf;
++			for (Bitu i = 0; i < 8; i++) {
++				*draw++ = vga.dac.xlat16[foreground];
++			}
+ 		}
+-		//if(underline && ((col&0x07) == 0x01)) 
+-		//	*draw = vga.dac.xlat16[fg];
+ 	}
+-skip_cursor:
+-	return TempLine;
++	return TempLine+32;
+ }
+ 
+ #ifdef VGA_KEEP_CHANGES
+@@ -628,22 +580,75 @@
+ 
+ 
+ static void VGA_ProcessSplit() {
+-	// On the EGA the address is always reset to 0.
+-	if ((vga.attr.mode_control&0x20) || (machine==MCH_EGA)) {
++	if (vga.attr.mode_control&0x20) {
+ 		vga.draw.address=0;
++		// reset panning to 0 here so we don't have to check for 
++		// it in the character draw functions. It will be set back
++		// to its proper value in v-retrace
++		vga.draw.panning=0; 
+ 	} else {
+ 		// In text mode only the characters are shifted by panning, not the address;
+ 		// this is done in the text line draw function.
+ 		vga.draw.address = vga.draw.byte_panning_shift*vga.draw.bytes_skip;
+-		if (!(vga.mode==M_TEXT)) vga.draw.address += vga.draw.panning;
++		if ((vga.mode!=M_TEXT)&&(machine!=MCH_EGA)) vga.draw.address += vga.draw.panning;
+ 	}
+ 	vga.draw.address_line=0;
+ }
+ 
++static Bit8u bg_color_index = 0; // screen-off black index
+ static void VGA_DrawSingleLine(Bitu /*blah*/) {
+ 	if (GCC_UNLIKELY(vga.attr.disabled)) {
+-		// draw blanked line (DoWhackaDo, Alien Carnage, TV sports Football)
+-		memset(TempLine, 0, sizeof(TempLine));
++		switch(machine) {
++		case MCH_PCJR:
++			// Displays the border color when screen is disabled
++			bg_color_index = vga.tandy.border_color;
++			break;
++		case MCH_TANDY:
++			// Either the PCJr way or the CGA way
++			if (vga.tandy.gfx_control& 0x4) { 
++				bg_color_index = vga.tandy.border_color;
++			} else if (vga.mode==M_TANDY4) 
++				bg_color_index = vga.attr.palette[0];
++			else bg_color_index = 0;
++			break;
++		case MCH_CGA:
++			// the background color
++			bg_color_index = vga.attr.overscan_color;
++			break;
++		case MCH_EGA:
++		case MCH_VGA:
++			// DoWhackaDo, Alien Carnage, TV sports Football
++			// when disabled by attribute index bit 5:
++			//  ET3000, ET4000, Paradise display the border color
++			//  S3 displays the content of the currently selected attribute register
++			// when disabled by sequencer the screen is black "257th color"
++			
++			// the DAC table may not match the bits of the overscan register
++			// so use black for this case too...
++			//if (vga.attr.disabled& 2) {
++			if (vga.dac.xlat16[bg_color_index] != 0) {
++				for(Bitu i = 0; i < 256; i++)
++					if (vga.dac.xlat16[i] == 0) {
++						bg_color_index = i;
++						break;
++					}
++			}
++			//} else 
++            //    bg_color_index = vga.attr.overscan_color;
++			break;
++		default:
++			bg_color_index = 0;
++			break;
++		}
++		if (vga.draw.bpp==8) {
++			memset(TempLine, bg_color_index, sizeof(TempLine));
++		} else if (vga.draw.bpp==16) {
++			Bit16u* wptr = (Bit16u*) TempLine;
++			Bit16u value = vga.dac.xlat16[bg_color_index];
++			for (Bitu i = 0; i < sizeof(TempLine)/2; i++) {
++				wptr[i] = value;
++			}
++		}
+ 		RENDER_DrawLine(TempLine);
+ 	} else {
+ 		Bit8u * data=VGA_DrawLine( vga.draw.address, vga.draw.address_line );	
+@@ -662,6 +667,29 @@
+ 	} else RENDER_EndUpdate(false);
+ }
+ 
++static void VGA_DrawEGASingleLine(Bitu /*blah*/) {
++	if (GCC_UNLIKELY(vga.attr.disabled)) {
++		memset(TempLine, 0, sizeof(TempLine));
++		RENDER_DrawLine(TempLine);
++	} else {
++		Bitu address = vga.draw.address;
++		if (vga.mode!=M_TEXT) address += vga.draw.panning;
++		Bit8u * data=VGA_DrawLine(address, vga.draw.address_line );	
++		RENDER_DrawLine(data);
++	}
++
++	vga.draw.address_line++;
++	if (vga.draw.address_line>=vga.draw.address_line_total) {
++		vga.draw.address_line=0;
++		vga.draw.address+=vga.draw.address_add;
++	}
++	vga.draw.lines_done++;
++	if (vga.draw.split_line==vga.draw.lines_done) VGA_ProcessSplit();
++	if (vga.draw.lines_done < vga.draw.lines_total) {
++		PIC_AddEvent(VGA_DrawEGASingleLine,(float)vga.draw.delay.htotal);
++	} else RENDER_EndUpdate(false);
++}
++
+ static void VGA_DrawPart(Bitu lines) {
+ 	while (lines--) {
+ 		Bit8u * data=VGA_DrawLine( vga.draw.address, vga.draw.address_line );
+@@ -771,7 +799,6 @@
+ 		VGA_DisplayStartLatch(0);
+ 		break;
+ 	case MCH_VGA:
+-	case MCH_EGA:
+ 		PIC_AddEvent(VGA_DisplayStartLatch, (float)vga.draw.delay.vrstart);
+ 		PIC_AddEvent(VGA_PanningLatch, (float)vga.draw.delay.vrend);
+ 		// EGA: 82c435 datasheet: interrupt happens at display end
+@@ -779,12 +806,16 @@
+ 		// add a little amount of time to make sure the last drawpart has already fired
+ 		PIC_AddEvent(VGA_VertInterrupt,(float)(vga.draw.delay.vdend + 0.005));
+ 		break;
++	case MCH_EGA:
++		PIC_AddEvent(VGA_DisplayStartLatch, (float)vga.draw.delay.vrend);
++		PIC_AddEvent(VGA_VertInterrupt,(float)(vga.draw.delay.vdend + 0.005));
++		break;
+ 	default:
+ 		E_Exit("This new machine needs implementation in VGA_VerticalTimer too.");
+ 		break;
+ 	}
+ 	//Check if we can actually render, else skip the rest (frameskip)
+-	if (!RENDER_StartUpdate())
++	if (vga.draw.vga_override || !RENDER_StartUpdate())
+ 		return;
+ 
+ 	vga.draw.address_line = vga.config.hlines_skip;
+@@ -798,7 +829,11 @@
+ 	vga.draw.address = vga.config.real_start;
+ 	vga.draw.byte_panning_shift = 0;
+ 	// go figure...
+-	if (machine==MCH_EGA) vga.draw.split_line*=2;
++	if (machine==MCH_EGA) {
++		if (vga.draw.doubleheight) // Spacepigs EGA Megademo
++			vga.draw.split_line*=2;
++		vga.draw.split_line++; // EGA adds one buggy scanline
++	}
+ //	if (machine==MCH_EGA) vga.draw.split_line = ((((vga.config.line_compare&0x5ff)+1)*2-1)/vga.draw.lines_scaled);
+ #ifdef VGA_KEEP_CHANGES
+ 	bool startaddr_changed=false;
+@@ -811,13 +846,13 @@
+ 		vga.draw.byte_panning_shift = 8;
+ 		vga.draw.address += vga.draw.bytes_skip;
+ 		vga.draw.address *= vga.draw.byte_panning_shift;
+-		vga.draw.address += vga.draw.panning;
++		if (machine!=MCH_EGA) vga.draw.address += vga.draw.panning;
+ #ifdef VGA_KEEP_CHANGES
+ 		startaddr_changed=true;
+ #endif
+ 		break;
+ 	case M_VGA:
+-		if(vga.config.compatible_chain4 && (vga.crtc.underline_location & 0x40)) {
++		if (vga.config.compatible_chain4 && (vga.crtc.underline_location & 0x40)) {
+ 			vga.draw.linear_base = vga.fastmem;
+ 			vga.draw.linear_mask = 0xffff;
+ 		} else {
+@@ -851,9 +886,12 @@
+ 		/* check for blinking and blinking change delay */
+ 		FontMask[1]=(vga.draw.blinking & (vga.draw.cursor.count >> 4)) ?
+ 			0 : 0xffffffff;
++		/* if blinking is enabled, 'blink' will toggle between true
++		 * and false. Otherwise it's true */
++		vga.draw.blink = ((vga.draw.blinking & (vga.draw.cursor.count >> 4))
++			|| !vga.draw.blinking) ? true:false;
+ 		break;
+ 	case M_HERC_GFX:
+-		break;
+ 	case M_CGA4:case M_CGA2:
+ 		vga.draw.address=(vga.draw.address*2)&0x1fff;
+ 		break;
+@@ -889,16 +927,19 @@
+ 		PIC_AddEvent(VGA_DrawPart,(float)vga.draw.delay.parts + draw_skip,vga.draw.parts_lines);
+ 		break;
+ 	case LINE:
++	case EGALINE:
+ 		if (GCC_UNLIKELY(vga.draw.lines_done < vga.draw.lines_total)) {
+ 			LOG(LOG_VGAMISC,LOG_NORMAL)( "Lines left: %d", 
+ 				vga.draw.lines_total-vga.draw.lines_done);
+-			PIC_RemoveEvents(VGA_DrawSingleLine);
++			if (vga.draw.mode==EGALINE) PIC_RemoveEvents(VGA_DrawEGASingleLine);
++			else PIC_RemoveEvents(VGA_DrawSingleLine);
+ 			RENDER_EndUpdate(true);
+ 		}
+ 		vga.draw.lines_done = 0;
+-		PIC_AddEvent(VGA_DrawSingleLine,(float)(vga.draw.delay.htotal/4.0 + draw_skip));
++		if (vga.draw.mode==EGALINE)
++			PIC_AddEvent(VGA_DrawEGASingleLine,(float)(vga.draw.delay.htotal/4.0 + draw_skip));
++		else PIC_AddEvent(VGA_DrawSingleLine,(float)(vga.draw.delay.htotal/4.0 + draw_skip));
+ 		break;
+-	//case EGALINE:
+ 	}
+ }
+ 
+@@ -980,8 +1021,13 @@
+ 	switch (machine) {
+ 	case MCH_CGA:
+ 	case MCH_PCJR:
++	case MCH_TANDY:
+ 		vga.draw.mode = LINE;
+ 		break;
++	case MCH_EGA:
++		// Note: The Paradise SVGA uses the same panning mechanism as EGA
++		vga.draw.mode = EGALINE;
++		break;
+ 	case MCH_VGA:
+ 		if (svgaCard==SVGA_None) {
+ 			vga.draw.mode = LINE;
+@@ -1035,7 +1081,6 @@
+ 		vtotal += 2;
+ 		hdend += 1;
+ 		vdend += 1;
+-		vbstart += 1;
+ 
+ 		hbend = hbstart + ((hbend - hbstart) & 0x3F);
+ 		hrend = vga.crtc.end_horizontal_retrace & 0x1f;
+@@ -1050,10 +1095,16 @@
+ 		if ( !vrend) vrend = vrstart + 0xf + 1;
+ 		else vrend = vrstart + vrend;
+ 
+-		vbend = (vbend - vbstart) & 0x7f;
+-		if ( !vbend) vbend = vbstart + 0x7f + 1;
+-		else vbend = vbstart + vbend;
+-
++		// Special case vbstart==0:
++		// Most graphics cards agree that lines zero to vbend are
++		// blanked. ET4000 doesn't blank at all if vbstart==vbend.
++		// ET3000 blanks lines 1 to vbend (255/6 lines).
++		if (vbstart != 0) {
++			vbstart += 1;
++			vbend = (vbend - vbstart) & 0x7f;
++			if ( !vbend) vbend = vbstart + 0x7f + 1;
++			else vbend = vbstart + vbend;
++		}
+ 		vbend++;
+ 			
+ 		if (svga.get_clock) {
+@@ -1077,13 +1128,13 @@
+ 			htotal*=2;
+ 		}
+ 		vga.draw.address_line_total=(vga.crtc.maximum_scan_line&0x1f)+1;
+-		if(IS_VGA_ARCH && (svgaCard==SVGA_None) && (vga.mode==M_EGA || vga.mode==M_VGA)) {
++		if (IS_VGA_ARCH && (svgaCard==SVGA_None) && (vga.mode==M_EGA || vga.mode==M_VGA)) {
+ 			// vgaonly; can't use with CGA because these use address_line for their
+ 			// own purposes.
+ 			// Set the low resolution modes to have as many lines as are scanned - 
+ 			// Quite a few demos change the max_scanline register at display time
+ 			// to get SFX: Majic12 show, Magic circle, Copper, GBU, Party91
+-			if( vga.crtc.maximum_scan_line&0x80) vga.draw.address_line_total*=2;
++			if ( vga.crtc.maximum_scan_line&0x80) vga.draw.address_line_total*=2;
+ 			vga.draw.double_scan=false;
+ 		}
+ 		else if (IS_VGA_ARCH) vga.draw.double_scan=(vga.crtc.maximum_scan_line&0x80)>0;
+@@ -1148,37 +1199,62 @@
+ 	// Vertical blanking tricks
+ 	vblank_skip = 0;
+ 	if (IS_VGA_ARCH) { // others need more investigation
+-		if (vbend > vtotal) {
+-			// blanking wraps to the start of the screen
+-			vblank_skip = vbend&0x7f;
+-			
+-			// on blanking wrap to 0, the first line is not blanked
+-			// this is used by the S3 BIOS and other S3 drivers in some SVGA modes
+-			if((vbend&0x7f)==1) vblank_skip = 0;
+-			
+-			// it might also cut some lines off the bottom
+-			if(vbstart < vdend) {
+-				vdend = vbstart;
+-			}
+-			LOG(LOG_VGA,LOG_WARN)("Blanking wrap to line %d", vblank_skip);
+-		} else if (vbstart==1) {
+-			// blanking is used to cut lines at the start of the screen
+-			vblank_skip = vbend;
+-			LOG(LOG_VGA,LOG_WARN)("Upper %d lines of the screen blanked", vblank_skip);
+-		} else if (vbstart < vdend) {
+-			if(vbend < vdend) {
+-				// the game wants a black bar somewhere on the screen
+-				LOG(LOG_VGA,LOG_WARN)("Unsupported blanking: line %d-%d",vbstart,vbend);
+-			} else {
+-				// blanking is used to cut off some lines from the bottom
+-				vdend = vbstart;
++		if (vbstart < vtotal) { // There will be no blanking at all otherwise
++			if (vbend > vtotal) {
++				// blanking wraps to the start of the screen
++				vblank_skip = vbend&0x7f;
++				
++				// on blanking wrap to 0, the first line is not blanked
++				// this is used by the S3 BIOS and other S3 drivers in some SVGA modes
++				if ((vbend&0x7f)==1) vblank_skip = 0;
++				
++				// it might also cut some lines off the bottom
++				if (vbstart < vdend) {
++					vdend = vbstart;
++				}
++				LOG(LOG_VGA,LOG_WARN)("Blanking wrap to line %d", vblank_skip);
++			} else if (vbstart<=1) {
++				// blanking is used to cut lines at the start of the screen
++				vblank_skip = vbend;
++				LOG(LOG_VGA,LOG_WARN)("Upper %d lines of the screen blanked", vblank_skip);
++			} else if (vbstart < vdend) {
++				if (vbend < vdend) {
++					// the game wants a black bar somewhere on the screen
++					LOG(LOG_VGA,LOG_WARN)("Unsupported blanking: line %d-%d",vbstart,vbend);
++				} else {
++					// blanking is used to cut off some lines from the bottom
++					vdend = vbstart;
++				}
+ 			}
++			vdend -= vblank_skip;
+ 		}
+-		vdend -= vblank_skip;
+ 	}
+ 	// Display end
+ 	vga.draw.delay.vdend = vdend * vga.draw.delay.htotal;
+ 
++	// EGA frequency dependent monitor palette
++	if (machine == MCH_EGA) {
++		if (vga.misc_output & 1) {
++			// EGA card is in color mode
++			if ((1.0f/vga.draw.delay.htotal) > 19.0f) {
++				// 64 color EGA mode
++				VGA_ATTR_SetEGAMonitorPalette(EGA);
++			} else {
++				// 16 color CGA mode compatibility
++				VGA_ATTR_SetEGAMonitorPalette(CGA);
++			}
++		} else {
++			// EGA card in monochrome mode
++			// It is not meant to be autodetected that way, you either
++			// have a monochrome or color monitor connected and
++			// the EGA switches configured appropriately.
++			// But this would only be a problem if a program sets 
++			// the adapter to monochrome mode and still expects color output.
++			// Such a program should be shot to the moon...
++			VGA_ATTR_SetEGAMonitorPalette(MONO);
++		}
++	}
++
+ 	vga.draw.parts_total=VGA_PARTS;
+ 	/*
+       6  Horizontal Sync Polarity. Negative if set
+@@ -1264,7 +1340,7 @@
+ 	case M_LIN8:
+ 		if (vga.crtc.mode_control & 0x8)
+ 			width >>=1;
+-		else if(svgaCard == SVGA_S3Trio && !(vga.s3.reg_3a&0x10)) {
++		else if (svgaCard == SVGA_S3Trio && !(vga.s3.reg_3a&0x10)) {
+ 			doublewidth=true;
+ 			width >>=1;
+ 		}
+@@ -1298,6 +1374,7 @@
+ 		vga.draw.blocks = width;
+ 		width<<=3;
+ 		if ((IS_VGA_ARCH) && (svgaCard==SVGA_None)) {
++			// This would also be required for EGA in Spacepigs Megademo
+ 			bpp=16;
+ 			VGA_DrawLine = VGA_Draw_Xlat16_Linear_Line;
+ 		} else VGA_DrawLine=VGA_Draw_Linear_Line;
+@@ -1327,17 +1404,22 @@
+ 		aspect_ratio=1.0;
+ 		vga.draw.blocks=width;
+ 		doublewidth=(vga.seq.clocking_mode & 0x8) > 0;
+-		if ((IS_VGA_ARCH) && (svgaCard==SVGA_None) && !(vga.seq.clocking_mode&0x01)) {
+-			width*=9;				/* 9 bit wide text font */
+-			VGA_DrawLine=VGA_TEXT_Xlat16_Draw_Line_9;
++		if ((IS_VGA_ARCH) && (svgaCard==SVGA_None)) {
++			// vgaonly: allow 9-pixel wide fonts
++			if (vga.seq.clocking_mode&0x01) {
++				vga.draw.char9dot = false;
++				width*=8;
++			} else {
++				vga.draw.char9dot = true;
++				width*=9;
++			}
++			VGA_DrawLine=VGA_TEXT_Xlat16_Draw_Line;
+ 			bpp=16;
+-//			VGA_DrawLine=VGA_TEXT_Draw_Line_9;
+ 		} else {
+-			width<<=3;				/* 8 bit wide text font */
+-			if ((IS_VGA_ARCH) && (svgaCard==SVGA_None)) {
+-				VGA_DrawLine=VGA_TEXT_Xlat16_Draw_Line;
+-				bpp=16;
+-			} else VGA_DrawLine=VGA_TEXT_Draw_Line;
++			// not vgaonly: force 8-pixel wide fonts
++			width*=8; // 8 bit wide text font
++			vga.draw.char9dot = false;
++			VGA_DrawLine=VGA_TEXT_Draw_Line;
+ 		}
+ 		break;
+ 	case M_HERC_GFX:
+@@ -1415,7 +1497,7 @@
+ 	}
+ 	vga.draw.vblank_skip = vblank_skip;
+ 		
+-	if(!(IS_VGA_ARCH && (svgaCard==SVGA_None) && (vga.mode==M_EGA || vga.mode==M_VGA))) {
++	if (!(IS_VGA_ARCH && (svgaCard==SVGA_None) && (vga.mode==M_EGA || vga.mode==M_VGA))) {
+ 		//Only check for extra double height in vga modes
+ 		//(line multiplying by address_line_total)
+ 		if (!doubleheight && (vga.mode<M_TEXT) && !(vga.draw.address_line_total & 1)) {
+@@ -1440,8 +1522,10 @@
+ 	}
+ //	LOG_MSG("ht %d vt %d ratio %f", htotal, vtotal, aspect_ratio );
+ 
++	bool fps_changed = false;
+ 	// need to change the vertical timing?
+ 	if (fabs(vga.draw.delay.vtotal - 1000.0 / fps) > 0.0001) {
++		fps_changed = true;
+ 		vga.draw.delay.vtotal = 1000.0 / fps;
+ 		VGA_KillDrawing();
+ 		PIC_RemoveEvents(VGA_Other_VertInterrupt);
+@@ -1468,7 +1552,7 @@
+ 		(vga.draw.doublewidth != doublewidth) ||
+ 		(vga.draw.doubleheight != doubleheight) ||
+ 		(fabs(aspect_ratio - vga.draw.aspect_ratio) > 0.0001) ||
+-		(vga.draw.bpp != bpp)) {
++		(vga.draw.bpp != bpp) || fps_changed) {
+ 
+ 		VGA_KillDrawing();
+ 
+@@ -1485,14 +1569,31 @@
+ 		LOG(LOG_VGA,LOG_NORMAL)("%s width, %s height aspect %f",
+ 			doublewidth ? "double":"normal",doubleheight ? "double":"normal",aspect_ratio);
+ #endif
+-		RENDER_SetSize(width,height,bpp,(float)fps,aspect_ratio,doublewidth,doubleheight);
++		if (!vga.draw.vga_override) 
++			RENDER_SetSize(width, height, bpp, (float)fps, aspect_ratio,
++			doublewidth, doubleheight);
+ 	}
+ }
+ 
+ void VGA_KillDrawing(void) {
+ 	PIC_RemoveEvents(VGA_DrawPart);
+ 	PIC_RemoveEvents(VGA_DrawSingleLine);
++	PIC_RemoveEvents(VGA_DrawEGASingleLine);
+ 	vga.draw.parts_left = 0;
+ 	vga.draw.lines_done = ~0;
+-	RENDER_EndUpdate(true);
++	if (!vga.draw.vga_override) RENDER_EndUpdate(true);
++}
++
++void VGA_SetOverride(bool vga_override) {
++	if (vga.draw.vga_override!=vga_override) {
++		
++		if (vga_override) {
++			VGA_KillDrawing();
++			vga.draw.vga_override=true;
++		} else {
++			vga.draw.vga_override=false;
++			vga.draw.width=0; // change it so the output window gets updated
++			VGA_SetupDrawing(0);
++		}
++	}
+ }
+diff -Nur dosbox-0.74/src/hardware/vga_gfx.cpp dosbox/src/hardware/vga_gfx.cpp
+--- dosbox-0.74/src/hardware/vga_gfx.cpp	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/hardware/vga_gfx.cpp	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,7 +16,6 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: vga_gfx.cpp,v 1.19 2009-05-27 09:15:41 qbix79 Exp $ */
+ 
+ #include "dosbox.h"
+ #include "inout.h"
+diff -Nur dosbox-0.74/src/hardware/vga_memory.cpp dosbox/src/hardware/vga_memory.cpp
+--- dosbox-0.74/src/hardware/vga_memory.cpp	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/hardware/vga_memory.cpp	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,7 +16,6 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: vga_memory.cpp,v 1.53 2009-07-04 21:23:35 qbix79 Exp $ */
+ 
+ #include <stdlib.h>
+ #include <string.h>
+@@ -161,19 +160,19 @@
+ 		addr = PAGING_GetPhysicalAddress(addr) & vgapages.mask;
+ 		addr += vga.svga.bank_read_full;
+ 		addr = CHECKED2(addr);
+-		return 
+-			(readHandler(addr+0) << 0) |
+-			(readHandler(addr+1) << 8);
++		Bitu ret = (readHandler(addr+0) << 0);
++		ret     |= (readHandler(addr+1) << 8);
++		return  ret;
+ 	}
+ 	Bitu readd(PhysPt addr) {
+ 		addr = PAGING_GetPhysicalAddress(addr) & vgapages.mask;
+ 		addr += vga.svga.bank_read_full;
+ 		addr = CHECKED2(addr);
+-		return 
+-			(readHandler(addr+0) << 0)  |
+-			(readHandler(addr+1) << 8)  |
+-			(readHandler(addr+2) << 16) |
+-			(readHandler(addr+3) << 24);
++		Bitu ret = (readHandler(addr+0) << 0);
++		ret     |= (readHandler(addr+1) << 8);
++		ret     |= (readHandler(addr+2) << 16);
++		ret     |= (readHandler(addr+3) << 24);
++		return ret;
+ 	}
+ };
+ 
+@@ -247,19 +246,19 @@
+ 		addr = PAGING_GetPhysicalAddress(addr) & vgapages.mask;
+ 		addr += vga.svga.bank_read_full;
+ 		addr = CHECKED(addr);
+-		return 
+-			(readHandler(addr+0) << 0) |
+-			(readHandler(addr+1) << 8);
++		Bitu ret = (readHandler(addr+0) << 0);
++		ret     |= (readHandler(addr+1) << 8);
++		return ret;
+ 	}
+ 	Bitu readd(PhysPt addr) {
+ 		addr = PAGING_GetPhysicalAddress(addr) & vgapages.mask;
+ 		addr += vga.svga.bank_read_full;
+ 		addr = CHECKED(addr);
+-		return 
+-			(readHandler(addr+0) << 0)  |
+-			(readHandler(addr+1) << 8)  |
+-			(readHandler(addr+2) << 16) |
+-			(readHandler(addr+3) << 24);
++		Bitu ret = (readHandler(addr+0) << 0);
++		ret     |= (readHandler(addr+1) << 8);
++		ret     |= (readHandler(addr+2) << 16);
++		ret     |= (readHandler(addr+3) << 24);
++		return ret;
+ 	}
+ };
+ 
+@@ -356,24 +355,24 @@
+ 		addr = PAGING_GetPhysicalAddress(addr) & vgapages.mask;
+ 		addr += vga.svga.bank_read_full;
+ 		addr = CHECKED(addr);
+-		if (GCC_UNLIKELY(addr & 1))
+-			return
+-				(readHandler<Bit8u>( addr+0 ) << 0 ) | 
+-				(readHandler<Bit8u>( addr+1 ) << 8 );
+-		else
++		if (GCC_UNLIKELY(addr & 1)) {
++			Bitu ret = (readHandler<Bit8u>( addr+0 ) << 0 );
++			ret     |= (readHandler<Bit8u>( addr+1 ) << 8 );
++			return ret;
++		} else
+ 			return readHandler<Bit16u>( addr );
+ 	}
+ 	Bitu readd(PhysPt addr ) {
+ 		addr = PAGING_GetPhysicalAddress(addr) & vgapages.mask;
+ 		addr += vga.svga.bank_read_full;
+ 		addr = CHECKED(addr);
+-		if (GCC_UNLIKELY(addr & 3))
+-			return
+-				(readHandler<Bit8u>( addr+0 ) << 0 ) | 
+-				(readHandler<Bit8u>( addr+1 ) << 8 ) | 
+-				(readHandler<Bit8u>( addr+2 ) << 16 ) | 
+-				(readHandler<Bit8u>( addr+3 ) << 24 );
+-		else
++		if (GCC_UNLIKELY(addr & 3)) {
++			Bitu ret = (readHandler<Bit8u>( addr+0 ) << 0 );
++			ret     |= (readHandler<Bit8u>( addr+1 ) << 8 );
++			ret     |= (readHandler<Bit8u>( addr+2 ) << 16 );
++			ret     |= (readHandler<Bit8u>( addr+3 ) << 24 );
++			return ret;
++		} else
+ 			return readHandler<Bit32u>( addr );
+ 	}
+ 	void writeb(PhysPt addr, Bitu val ) {
+@@ -466,12 +465,29 @@
+ 	}
+ 	Bitu readb(PhysPt addr) {
+ 		addr = PAGING_GetPhysicalAddress(addr) & vgapages.mask;
+-		return vga.draw.font[addr];
++		switch(vga.gfx.read_map_select) {
++		case 0: // character index
++			return vga.mem.linear[CHECKED3(vga.svga.bank_read_full+addr)];
++		case 1: // character attribute
++			return vga.mem.linear[CHECKED3(vga.svga.bank_read_full+addr+1)];
++		case 2: // font map
++			return vga.draw.font[addr];
++		default: // 3=unused, but still RAM that could save values
++			return 0;
++		}
+ 	}
+ 	void writeb(PhysPt addr,Bitu val){
+ 		addr = PAGING_GetPhysicalAddress(addr) & vgapages.mask;
+-		if (vga.seq.map_mask & 0x4) {
++		
++		if (GCC_LIKELY(vga.seq.map_mask == 0x4)) {
+ 			vga.draw.font[addr]=(Bit8u)val;
++		} else {
++			if (vga.seq.map_mask & 0x4) // font map
++				vga.draw.font[addr]=(Bit8u)val;
++			if (vga.seq.map_mask & 0x2) // character attribute
++				vga.mem.linear[CHECKED3(vga.svga.bank_read_full+addr+1)]=(Bit8u)val;
++			if (vga.seq.map_mask & 0x1) // character index
++				vga.mem.linear[CHECKED3(vga.svga.bank_read_full+addr)]=(Bit8u)val;
+ 		}
+ 	}
+ };
+@@ -572,18 +588,18 @@
+ 	Bitu readw(PhysPt addr) {
+ 		addr = vga.svga.bank_read_full + (PAGING_GetPhysicalAddress(addr) & 0xffff);
+ 		addr = CHECKED4(addr);
+-		return 
+-			(readHandler(addr+0) << 0) |
+-			(readHandler(addr+1) << 8);
++		Bitu ret = (readHandler(addr+0) << 0);
++		ret     |= (readHandler(addr+1) << 8);
++		return ret;
+ 	}
+ 	Bitu readd(PhysPt addr) {
+ 		addr = vga.svga.bank_read_full + (PAGING_GetPhysicalAddress(addr) & 0xffff);
+ 		addr = CHECKED4(addr);
+-		return 
+-			(readHandler(addr+0) << 0)  |
+-			(readHandler(addr+1) << 8)  |
+-			(readHandler(addr+2) << 16) |
+-			(readHandler(addr+3) << 24);
++		Bitu ret = (readHandler(addr+0) << 0);
++		ret     |= (readHandler(addr+1) << 8);
++		ret     |= (readHandler(addr+2) << 16);
++		ret     |= (readHandler(addr+3) << 24);
++		return ret;
+ 	}
+ };
+ 
+@@ -684,6 +700,7 @@
+ //			|PFLAG_NOCODE;
+ 	}
+ 	HostPt GetHostReadPt(Bitu phys_page) {
++		// Odd banks are limited to 16kB and repeated
+ 		if (vga.tandy.mem_bank & 1) 
+ 			phys_page&=0x03;
+ 		else 
+@@ -703,9 +720,9 @@
+ 	}
+ 	HostPt GetHostReadPt(Bitu phys_page) {
+ 		phys_page-=0xb8;
+-		//test for a unaliged bank, then replicate 2x16kb
+-		if (vga.tandy.mem_bank & 1) 
+-			phys_page&=0x03;
++		// The 16kB map area is repeated in the 32kB range
++		// On CGA CPU A14 is not decoded so it repeats there too
++		phys_page&=0x03;
+ 		return vga.tandy.mem_base + (phys_page * 4096);
+ 	}
+ 	HostPt GetHostWritePt(Bitu phys_page) {
+diff -Nur dosbox-0.74/src/hardware/vga_misc.cpp dosbox/src/hardware/vga_misc.cpp
+--- dosbox-0.74/src/hardware/vga_misc.cpp	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/hardware/vga_misc.cpp	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,7 +16,6 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: vga_misc.cpp,v 1.39 2009-01-25 12:00:49 c2woody Exp $ */
+ 
+ #include "dosbox.h"
+ #include "inout.h"
+diff -Nur dosbox-0.74/src/hardware/vga_other.cpp dosbox/src/hardware/vga_other.cpp
+--- dosbox-0.74/src/hardware/vga_other.cpp	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/hardware/vga_other.cpp	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,7 +16,6 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: vga_other.cpp,v 1.28 2009-07-11 10:25:24 c2woody Exp $ */
+ 
+ #include <string.h>
+ #include <math.h>
+@@ -84,7 +83,9 @@
+ 		vga.draw.cursor.eline = (Bit8u)(val&0x1f);
+ 		break;
+ 	case 0x0C:	/* Start Address High Register */
+-		vga.config.display_start=(vga.config.display_start & 0x00FF) | (val << 8);
++		// Bit 12 (depending on video mode) and 13 are actually masked too,
++		// but so far no need to implement it.
++		vga.config.display_start=(vga.config.display_start & 0x00FF) | ((val&0x3F) << 8);
+ 		break;
+ 	case 0x0D:	/* Start Address Low Register */
+ 		vga.config.display_start=(vga.config.display_start & 0xFF00) | val;
+@@ -153,7 +154,31 @@
+ 	return (Bitu)(~0);
+ }
+ 
++static void write_lightpen(Bitu port,Bitu val,Bitu) {
++	switch (port) {
++	case 0x3db:	// Clear lightpen latch
++		vga.other.lightpen_triggered = false;
++		break;
++	case 0x3dc:	// Preset lightpen latch
++		if (!vga.other.lightpen_triggered) {
++			vga.other.lightpen_triggered = true; // TODO: this shows at port 3ba/3da bit 1
++			
++			double timeInFrame = PIC_FullIndex()-vga.draw.delay.framestart;
++			double timeInLine = fmod(timeInFrame,vga.draw.delay.htotal);
++			Bitu current_scanline = (Bitu)(timeInFrame / vga.draw.delay.htotal);
++			
++			vga.other.lightpen = (Bit16u)((vga.draw.address_add/2) * (current_scanline/2));
++			vga.other.lightpen += (Bit16u)((timeInLine / vga.draw.delay.hdend) *
++				((float)(vga.draw.address_add/2)));
++		}
++		break;
++	}
++}
++
+ static double hue_offset = 0.0;
++static Bit8u cga_comp = 0;
++static bool new_cga = 0;
++
+ static Bit8u cga16_val = 0;
+ static void update_cga16_color(void);
+ static Bit8u herc_pal = 0;
+@@ -164,57 +189,151 @@
+ }
+ 
+ static void update_cga16_color(void) {
+-// Algorithm provided by NewRisingSun
+-// His/Her algorithm is more complex and gives better results than the one below
+-// However that algorithm doesn't fit in our vga pallette.
+-// Therefore a simple variant is used, but the colours are bit lighter.
+-
+-// It uses an avarage over the bits to give smooth transitions from colour to colour
+-// This is represented by the j variable. The i variable gives the 16 colours
+-// The draw handler calculates the needed avarage and combines this with the colour
+-// to match an entry that is generated here.
+-
+-	int baseR=0, baseG=0, baseB=0;
+-	double sinhue,coshue,hue,basehue = 50.0;
+-	double I,Q,Y,pixelI,pixelQ,R,G,B;
+-	Bitu colorBit1,colorBit2,colorBit3,colorBit4,index;
+-
+-	if (cga16_val & 0x01) baseB += 0xa8;
+-	if (cga16_val & 0x02) baseG += 0xa8;
+-	if (cga16_val & 0x04) baseR += 0xa8;
+-	if (cga16_val & 0x08) { baseR += 0x57; baseG += 0x57; baseB += 0x57; }
+-	if (cga16_val & 0x20) basehue = 35.0;
+-
+-	hue = (basehue + hue_offset)*0.017453239;
+-	sinhue = sin(hue);
+-	coshue = cos(hue);
+-
+-	for(Bitu i = 0; i < 16;i++) {
+-		for(Bitu j = 0;j < 5;j++) {
+-			index = 0x80|(j << 4)|i; //use upperpart of vga pallette
+-			colorBit4 = (i&1)>>0;
+-			colorBit3 = (i&2)>>1;
+-			colorBit2 = (i&4)>>2;
+-			colorBit1 = (i&8)>>3;
+-
+-			//calculate lookup table
+-			I = 0; Q = 0;
+-			I += (double) colorBit1;
+-			Q += (double) colorBit2;
+-			I -= (double) colorBit3;
+-			Q -= (double) colorBit4;
+-			Y  = (double) j / 4.0; //calculated avarage is over 4 bits
+-
+-			pixelI = I * 1.0 / 3.0; //I* tvSaturnation / 3.0
+-			pixelQ = Q * 1.0 / 3.0; //Q* tvSaturnation / 3.0
+-			I = pixelI*coshue + pixelQ*sinhue;
+-			Q = pixelQ*coshue - pixelI*sinhue;
+-
+-			R = Y + 0.956*I + 0.621*Q; if (R < 0.0) R = 0.0; if (R > 1.0) R = 1.0;
+-			G = Y - 0.272*I - 0.647*Q; if (G < 0.0) G = 0.0; if (G > 1.0) G = 1.0;
+-			B = Y - 1.105*I + 1.702*Q; if (B < 0.0) B = 0.0; if (B > 1.0) B = 1.0;
++// New algorithm based on code by reenigne
++// Works in all CGA graphics modes/color settings and can simulate older and newer CGA revisions
++	static const double tau = 6.28318531; // == 2*pi
++	static const double ns = 567.0/440;  // degrees of hue shift per nanosecond
++
++	double tv_brightness = 0.0; // hardcoded for simpler implementation
++	double tv_saturation = (new_cga ? 0.7 : 0.6);
++
++	bool bw = (vga.tandy.mode_control&4) != 0;
++	bool color_sel = (cga16_val&0x20) != 0;
++	bool background_i = (cga16_val&0x10) != 0;	// Really foreground intensity, but this is what the CGA schematic calls it.
++	bool bpp1 = (vga.tandy.mode_control&0x10) != 0;
++	Bit8u overscan = cga16_val&0x0f;  // aka foreground colour in 1bpp mode
++
++	double chroma_coefficient = new_cga ? 0.29 : 0.72;
++	double b_coefficient = new_cga ? 0.07 : 0;
++	double g_coefficient = new_cga ? 0.22 : 0;
++	double r_coefficient = new_cga ? 0.1 : 0;
++	double i_coefficient = new_cga ? 0.32 : 0.28;
++	double rgbi_coefficients[0x10];
++	for (int c = 0; c < 0x10; c++) {
++		double v = 0;
++		if ((c & 1) != 0)
++			v += b_coefficient;
++		if ((c & 2) != 0)
++			v += g_coefficient;
++		if ((c & 4) != 0)
++			v += r_coefficient;
++		if ((c & 8) != 0)
++			v += i_coefficient;
++		rgbi_coefficients[c] = v;
++	}
++
++	// The pixel clock delay calculation is not accurate for 2bpp, but the difference is small and a more accurate calculation would be too slow.
++	static const double rgbi_pixel_delay = 15.5*ns;
++	static const double chroma_pixel_delays[8] = {
++		0,        // Black:   no chroma
++		35*ns,    // Blue:    no XORs
++		44.5*ns,  // Green:   XOR on rising and falling edges
++		39.5*ns,  // Cyan:    XOR on falling but not rising edge
++		44.5*ns,  // Red:     XOR on rising and falling edges
++		39.5*ns,  // Magenta: XOR on falling but not rising edge
++		44.5*ns,  // Yellow:  XOR on rising and falling edges
++		39.5*ns}; // White:   XOR on falling but not rising edge
++	double pixel_clock_delay;
++	int o = overscan == 0 ? 15 : overscan;
++	if (overscan == 8)
++		pixel_clock_delay = rgbi_pixel_delay;
++	else {
++		double d = rgbi_coefficients[o];
++		pixel_clock_delay = (chroma_pixel_delays[o & 7]*chroma_coefficient + rgbi_pixel_delay*d)/(chroma_coefficient + d);
++	}
++	pixel_clock_delay -= 21.5*ns;  // correct for delay of color burst
++
++	double hue_adjust = (-(90-33)-hue_offset+pixel_clock_delay)*tau/360.0;
++	double chroma_signals[8][4];
++	for (Bit8u i=0; i<4; i++) {
++		chroma_signals[0][i] = 0;
++		chroma_signals[7][i] = 1;
++		for (Bit8u j=0; j<6; j++) {
++			static const double phases[6] = {
++				270 - 21.5*ns,  // blue
++				135 - 29.5*ns,  // green
++				180 - 21.5*ns,  // cyan
++				  0 - 21.5*ns,  // red
++				315 - 29.5*ns,  // magenta
++				 90 - 21.5*ns}; // yellow/burst
++			// All the duty cycle fractions are the same, just under 0.5 as the rising edge is delayed 2ns more than the falling edge.
++			static const double duty = 0.5 - 2*ns/360.0;
++
++			// We have a rectangle wave with period 1 (in units of the reciprocal of the color burst frequency) and duty
++			// cycle fraction "duty" and phase "phase". We band-limit this wave to frequency 2 and sample it at intervals of 1/4.
++			// We model our band-limited wave with 4 frequency components:
++			//   f(x) = a + b*sin(x*tau) + c*cos(x*tau) + d*sin(x*2*tau)
++			// Then:
++			//   a =   integral(0, 1, f(x)*dx) = duty
++			//   b = 2*integral(0, 1, f(x)*sin(x*tau)*dx) = 2*integral(0, duty, sin(x*tau)*dx) = 2*(1-cos(x*tau))/tau
++			//   c = 2*integral(0, 1, f(x)*cos(x*tau)*dx) = 2*integral(0, duty, cos(x*tau)*dx) = 2*sin(duty*tau)/tau
++			//   d = 2*integral(0, 1, f(x)*sin(x*2*tau)*dx) = 2*integral(0, duty, sin(x*4*pi)*dx) = 2*(1-cos(2*tau*duty))/(2*tau)
++			double a = duty;
++			double b = 2.0*(1.0-cos(duty*tau))/tau;
++			double c = 2.0*sin(duty*tau)/tau;
++			double d = 2.0*(1.0-cos(duty*2*tau))/(2*tau);
++
++			double x = (phases[j] + 21.5*ns + pixel_clock_delay)/360.0 + i/4.0;
+ 
+-			RENDER_SetPal((Bit8u)index,static_cast<Bit8u>(R*baseR),static_cast<Bit8u>(G*baseG),static_cast<Bit8u>(B*baseB));
++			chroma_signals[j+1][i] = a + b*sin(x*tau) + c*cos(x*tau) + d*sin(x*2*tau);
++		}
++	}
++	Bitu CGApal[4] = {
++		overscan,
++		2 + (color_sel||bw ? 1 : 0) + (background_i ? 8 : 0),
++		4 + (color_sel&&!bw? 1 : 0) + (background_i ? 8 : 0),
++		6 + (color_sel||bw ? 1 : 0) + (background_i ? 8 : 0)
++	};
++	for (Bit8u x=0; x<4; x++) {	 // Position of pixel in question
++		bool even = (x & 1) == 0;
++		for (Bit8u bits=0; bits<(even ? 0x10 : 0x40); ++bits) {
++			double Y=0, I=0, Q=0;
++			for (Bit8u p=0; p<4; p++) {  // Position within color carrier cycle
++				// generate pixel pattern.
++				Bit8u rgbi;
++				if (bpp1)
++					rgbi = ((bits >> (3-p)) & (even ? 1 : 2)) != 0 ? overscan : 0;
++				else
++					if (even)
++						rgbi = CGApal[(bits >> (2-(p&2)))&3];
++					else
++						rgbi = CGApal[(bits >> (4-((p+1)&6)))&3];
++				Bit8u c = rgbi & 7;
++				if (bw && c != 0)
++					c = 7;
++
++				// calculate composite output
++				double chroma = chroma_signals[c][(p+x)&3]*chroma_coefficient;
++				double composite = chroma + rgbi_coefficients[rgbi];
++
++				Y+=composite;
++				if (!bw) { // burst on
++					I+=composite*2*cos(hue_adjust + (p+x)*tau/4.0);
++					Q+=composite*2*sin(hue_adjust + (p+x)*tau/4.0);
++				}
++			}
++
++			double contrast = 1 - tv_brightness;
++
++			Y = (contrast*Y/4.0) + tv_brightness; if (Y>1.0) Y=1.0; if (Y<0.0) Y=0.0;
++			I = (contrast*I/4.0) * tv_saturation; if (I>0.5957) I=0.5957; if (I<-0.5957) I=-0.5957;
++			Q = (contrast*Q/4.0) * tv_saturation; if (Q>0.5226) Q=0.5226; if (Q<-0.5226) Q=-0.5226;
++
++			static const double gamma = 2.2;
++
++			double R = Y + 0.9563*I + 0.6210*Q;	R = (R - 0.075) / (1-0.075); if (R<0) R=0; if (R>1) R=1;
++			double G = Y - 0.2721*I - 0.6474*Q;	G = (G - 0.075) / (1-0.075); if (G<0) G=0; if (G>1) G=1;
++			double B = Y - 1.1069*I + 1.7046*Q;	B = (B - 0.075) / (1-0.075); if (B<0) B=0; if (B>1) B=1;
++			R = pow(R, gamma);
++			G = pow(G, gamma);
++			B = pow(B, gamma);
++
++			int r = static_cast<int>(255*pow( 1.5073*R -0.3725*G -0.0832*B, 1/gamma)); if (r<0) r=0; if (r>255) r=255;
++			int g = static_cast<int>(255*pow(-0.0275*R +0.9350*G +0.0670*B, 1/gamma)); if (g<0) g=0; if (g>255) g=255;
++			int b = static_cast<int>(255*pow(-0.0272*R -0.0401*G +1.1677*B, 1/gamma)); if (b<0) b=0; if (b>255) b=255;
++
++			Bit8u index = bits | ((x & 1) == 0 ? 0x30 : 0x80) | ((x & 2) == 0 ? 0x40 : 0);
++			RENDER_SetPal(index,r,g,b);
+ 		}
+ 	}
+ }
+@@ -235,56 +354,159 @@
+ 	LOG_MSG("Hue at %f",hue_offset); 
+ }
+ 
+-static void write_color_select(Bit8u val) {
++static void write_cga_color_select(Bitu val) {
+ 	vga.tandy.color_select=val;
+-	switch (vga.mode) {
++	switch(vga.mode) {
++	case  M_TANDY4: {
++		Bit8u base = (val & 0x10) ? 0x08 : 0;
++		Bit8u bg = val & 0xf;
++		if (vga.tandy.mode_control & 0x4)	// cyan red white
++			VGA_SetCGA4Table(bg, 3+base, 4+base, 7+base);
++		else if (val & 0x20)				// cyan magenta white
++			VGA_SetCGA4Table(bg, 3+base, 5+base, 7+base);
++		else								// green red brown
++			VGA_SetCGA4Table(bg, 2+base, 4+base, 6+base);
++		vga.tandy.border_color = bg;
++		vga.attr.overscan_color = bg;
++		break;
++	}
+ 	case M_TANDY2:
+ 		VGA_SetCGA2Table(0,val & 0xf);
+-		break;
+-	case M_TANDY4:
+-		{
+-			if ((machine==MCH_TANDY && (vga.tandy.gfx_control & 0x8)) ||
+-				(machine==MCH_PCJR && (vga.tandy.mode_control==0x0b))) {
+-				VGA_SetCGA4Table(0,1,2,3);
+-				return;
+-			}
+-			Bit8u base=(val & 0x10) ? 0x08 : 0;
+-			/* Check for BW Mode */
+-			if (vga.tandy.mode_control & 0x4) {
+-				VGA_SetCGA4Table(val & 0xf,3+base,4+base,7+base);
+-			} else {
+-				if (val & 0x20) VGA_SetCGA4Table(val & 0xf,3+base,5+base,7+base);
+-				else VGA_SetCGA4Table(val & 0xf,2+base,4+base,6+base);
+-			}
+-		}
++		vga.attr.overscan_color = 0;
+ 		break;
+ 	case M_CGA16:
+ 		cga16_color_select(val);
+ 		break;
+ 	case M_TEXT:
+-	case M_TANDY16:
++		vga.tandy.border_color = val & 0xf;
++		vga.attr.overscan_color = 0;
+ 		break;
+ 	}
+ }
+ 
++static void write_cga(Bitu port,Bitu val,Bitu /*iolen*/) {
++	switch (port) {
++	case 0x3d8:
++		vga.tandy.mode_control=(Bit8u)val;
++		vga.attr.disabled = (val&0x8)? 0: 1; 
++		if (vga.tandy.mode_control & 0x2) {		// graphics mode
++			if (vga.tandy.mode_control & 0x10) {// highres mode
++				if (cga_comp==1 || (cga_comp==0 && !(val&0x4))) {	// composite display
++					VGA_SetMode(M_CGA16);		// composite ntsc 640x200 16 color mode
++				} else {
++					VGA_SetMode(M_TANDY2);
++				}
++			} else {							// lowres mode
++				if (cga_comp==1) {				// composite display
++					VGA_SetMode(M_CGA16);		// composite ntsc 640x200 16 color mode
++				} else {
++					VGA_SetMode(M_TANDY4);
++				}
++			}
++
++			write_cga_color_select(vga.tandy.color_select);
++		} else {
++			VGA_SetMode(M_TANDY_TEXT);
++		}
++		VGA_SetBlinking(val & 0x20);
++		break;
++	case 0x3d9: // color select
++		write_cga_color_select(val);
++		break;
++	}
++}
++
++static void CGAModel(bool pressed) {
++	if (!pressed) return;
++	new_cga = !new_cga;
++	update_cga16_color();
++	LOG_MSG("%s model CGA selected", new_cga ? "Late" : "Early");
++}
++ 
++static void Composite(bool pressed) {
++	if (!pressed) return;
++	if (++cga_comp>2) cga_comp=0;
++	LOG_MSG("Composite output: %s",(cga_comp==0)?"auto":((cga_comp==1)?"on":"off"));
++	// switch RGB and Composite if in graphics mode
++	if (vga.tandy.mode_control & 0x2)
++		write_cga(0x3d8,vga.tandy.mode_control,1);
++}
++
++static void tandy_update_palette() {
++	// TODO mask off bits if needed
++	if (machine == MCH_TANDY) {
++		switch (vga.mode) {
++		case M_TANDY2:
++			VGA_SetCGA2Table(vga.attr.palette[0],
++				vga.attr.palette[vga.tandy.color_select&0xf]);
++			break;
++		case M_TANDY4:
++			if (vga.tandy.gfx_control & 0x8) {
++				// 4-color high resolution - might be an idea to introduce M_TANDY4H
++				VGA_SetCGA4Table( // function sets both medium and highres 4color tables
++					vga.attr.palette[0], vga.attr.palette[1],
++					vga.attr.palette[2], vga.attr.palette[3]);
++			} else {
++				Bit8u color_set = 0;
++				Bit8u r_mask = 0xf;
++				if (vga.tandy.color_select & 0x10) color_set |= 8; // intensity
++				if (vga.tandy.color_select & 0x20) color_set |= 1; // Cyan Mag. White
++				if (vga.tandy.mode_control & 0x04) {			// Cyan Red White
++					color_set |= 1; 
++					r_mask &= ~1;
++				}
++				VGA_SetCGA4Table(
++					vga.attr.palette[vga.tandy.color_select&0xf],
++					vga.attr.palette[(2|color_set)& vga.tandy.palette_mask],
++					vga.attr.palette[(4|(color_set& r_mask))& vga.tandy.palette_mask],
++					vga.attr.palette[(6|color_set)& vga.tandy.palette_mask]);
++			}
++			break;
++		default:
++			break;
++		}
++	} else {
++		// PCJr
++		switch (vga.mode) {
++		case M_TANDY2:
++			VGA_SetCGA2Table(vga.attr.palette[0],vga.attr.palette[1]);
++			break;
++		case M_TANDY4:
++			VGA_SetCGA4Table(
++				vga.attr.palette[0], vga.attr.palette[1],
++				vga.attr.palette[2], vga.attr.palette[3]);
++			break;
++		default:
++			break;
++		}
++	}
++}
++
++void VGA_SetModeNow(VGAModes mode);
++
+ static void TANDY_FindMode(void) {
+ 	if (vga.tandy.mode_control & 0x2) {
+-		if (vga.tandy.gfx_control & 0x10) 
+-			VGA_SetMode(M_TANDY16);
+-		else if (vga.tandy.gfx_control & 0x08) 
++		if (vga.tandy.gfx_control & 0x10) {
++			if (vga.mode==M_TANDY4) {
++				VGA_SetModeNow(M_TANDY16);
++			} else VGA_SetMode(M_TANDY16);
++		}
++		else if (vga.tandy.gfx_control & 0x08) {
+ 			VGA_SetMode(M_TANDY4);
++		}
+ 		else if (vga.tandy.mode_control & 0x10)
+ 			VGA_SetMode(M_TANDY2);
+-		else
+-			VGA_SetMode(M_TANDY4);
+-		write_color_select(vga.tandy.color_select);
++		else {
++			if (vga.mode==M_TANDY16) {
++				VGA_SetModeNow(M_TANDY4);
++			} else VGA_SetMode(M_TANDY4);
++		}
++		tandy_update_palette();
+ 	} else {
+ 		VGA_SetMode(M_TANDY_TEXT);
+ 	}
+ }
+ 
+-void VGA_SetModeNow(VGAModes mode);
+-
+ static void PCJr_FindMode(void) {
+ 	if (vga.tandy.mode_control & 0x2) {
+ 		if (vga.tandy.mode_control & 0x10) {
+@@ -299,7 +521,7 @@
+ 			if (vga.mode==M_TANDY16) VGA_SetModeNow(M_TANDY4);
+ 			else VGA_SetMode(M_TANDY4);
+ 		}
+-		write_color_select(vga.tandy.color_select);
++		tandy_update_palette();
+ 	} else {
+ 		VGA_SetMode(M_TANDY_TEXT);
+ 	}
+@@ -327,11 +549,16 @@
+ 			vga.tandy.mode_control=val;
+ 			VGA_SetBlinking(val & 0x20);
+ 			PCJr_FindMode();
+-			vga.attr.disabled = (val&0x8)? 0: 1;
++			if (val&0x8) vga.attr.disabled &= ~1;
++			else vga.attr.disabled |= 1;
+ 		} else {
+ 			LOG(LOG_VGAMISC,LOG_NORMAL)("Unhandled Write %2X to tandy reg %X",val,vga.tandy.reg_index);
+ 		}
+ 		break;
++	case 0x1:	/* Palette mask */
++		vga.tandy.palette_mask = val;
++		tandy_update_palette();
++		break;
+ 	case 0x2:	/* Border color */
+ 		vga.tandy.border_color=val;
+ 		break;
+@@ -348,87 +575,56 @@
+ 		TandyCheckLineMask();
+ 		VGA_SetupHandlers();
+ 		break;
+-	case 0x8:	/* Monitor mode seletion */
+-		//Bit 1 select mode e, for 640x200x16, some double clocking thing?
+-		//Bit 4 select 350 line mode for hercules emulation
+-		LOG(LOG_VGAMISC,LOG_NORMAL)("Write %2X to tandy monitor mode",val );
+-		break;
+-	/* palette colors */
+-	case 0x10: case 0x11: case 0x12: case 0x13:
+-	case 0x14: case 0x15: case 0x16: case 0x17:
+-	case 0x18: case 0x19: case 0x1a: case 0x1b:
+-	case 0x1c: case 0x1d: case 0x1e: case 0x1f:
+-		VGA_ATTR_SetPalette(vga.tandy.reg_index-0x10,val & 0xf);
+-		break;
+-	default:		
+-		LOG(LOG_VGAMISC,LOG_NORMAL)("Unhandled Write %2X to tandy reg %X",val,vga.tandy.reg_index);
+-	}
+-}
+-
+-static void write_cga(Bitu port,Bitu val,Bitu /*iolen*/) {
+-	switch (port) {
+-	case 0x3d8:
+-		vga.tandy.mode_control=(Bit8u)val;
+-		vga.attr.disabled = (val&0x8)? 0: 1; 
+-		if (vga.tandy.mode_control & 0x2) {
+-			if (vga.tandy.mode_control & 0x10) {
+-				if (!(val & 0x4) && machine==MCH_CGA) {
+-					VGA_SetMode(M_CGA16);		//Video burst 16 160x200 color mode
+-				} else {
+-					VGA_SetMode(M_TANDY2);
+-				}
+-			} else VGA_SetMode(M_TANDY4);
+-			write_color_select(vga.tandy.color_select);
+-		} else {
+-			VGA_SetMode(M_TANDY_TEXT);
+-		}
+-		VGA_SetBlinking(val & 0x20);
+-		break;
+-	case 0x3d9:
+-		write_color_select((Bit8u)val);
+-		break;
++	default:
++		if ((vga.tandy.reg_index & 0xf0) == 0x10) { // color palette
++			vga.attr.palette[vga.tandy.reg_index-0x10] = val&0xf;
++			tandy_update_palette();
++		} else
++			LOG(LOG_VGAMISC,LOG_NORMAL)("Unhandled Write %2X to tandy reg %X",val,vga.tandy.reg_index);
+ 	}
+ }
+ 
+ static void write_tandy(Bitu port,Bitu val,Bitu /*iolen*/) {
+ 	switch (port) {
+ 	case 0x3d8:
+-		vga.tandy.mode_control=(Bit8u)val;
+-		TandyCheckLineMask();
+-		VGA_SetBlinking(val & 0x20);
+-		TANDY_FindMode();
++		val &= 0x3f; // only bits 0-6 are used
++		if (vga.tandy.mode_control ^ val) {
++			vga.tandy.mode_control=(Bit8u)val;
++			if (val&0x8) vga.attr.disabled &= ~1;
++			else vga.attr.disabled |= 1;
++			TandyCheckLineMask();
++			VGA_SetBlinking(val & 0x20);
++			TANDY_FindMode();
++			VGA_StartResize();
++		}
+ 		break;
+ 	case 0x3d9:
+-		write_color_select((Bit8u)val);
++		vga.tandy.color_select=val;
++		tandy_update_palette();
+ 		break;
+ 	case 0x3da:
+ 		vga.tandy.reg_index=(Bit8u)val;
+-		break;
+-	case 0x3db:	// Clear lightpen latch
+-		vga.other.lightpen_triggered = false;
+-		break;
+-	case 0x3dc:	// Preset lightpen latch
+-		if (!vga.other.lightpen_triggered) {
+-			vga.other.lightpen_triggered = true; // TODO: this shows at port 3ba/3da bit 1
+-			
+-			double timeInFrame = PIC_FullIndex()-vga.draw.delay.framestart;
+-			double timeInLine = fmod(timeInFrame,vga.draw.delay.htotal);
+-			Bitu current_scanline = (Bitu)(timeInFrame / vga.draw.delay.htotal);
+-			
+-			vga.other.lightpen = (Bit16u)((vga.draw.address_add/2) * (current_scanline/2));
+-			vga.other.lightpen += (Bit16u)((timeInLine / vga.draw.delay.hdend) *
+-				((float)(vga.draw.address_add/2)));
+-		}
++		//if (val&0x10) vga.attr.disabled |= 2;
++		//else vga.attr.disabled &= ~2;
+ 		break;
+ //	case 0x3dd:	//Extended ram page address register:
+-		break;
++//		break;
+ 	case 0x3de:
+ 		write_tandy_reg((Bit8u)val);
+ 		break;
+ 	case 0x3df:
++		// CRT/processor page register
++		// See the comments on the PCJr version of this register.
++		// A difference to it is:
++		// Bit 3-5: Processor page CPU_PG
++		// The remapped range is 32kB instead of 16. Therefore CPU_PG bit 0
++		// appears to be ORed with CPU A14 (to preserve some sort of
++		// backwards compatibility?), resulting in odd pages being mapped
++		// as 2x16kB. Implemeted in vga_memory.cpp Tandy handler.
++
+ 		vga.tandy.line_mask = (Bit8u)(val >> 6);
+ 		vga.tandy.draw_bank = val & ((vga.tandy.line_mask&2) ? 0x6 : 0x7);
+-		vga.tandy.mem_bank = (val >> 3) & ((vga.tandy.line_mask&2) ? 0x6 : 0x7);
++		vga.tandy.mem_bank = (val >> 3) & 7;
+ 		TandyCheckLineMask();
+ 		VGA_SetupHandlers();
+ 		break;
+@@ -437,18 +633,49 @@
+ 
+ static void write_pcjr(Bitu port,Bitu val,Bitu /*iolen*/) {
+ 	switch (port) {
+-	case 0x3d9:
+-		write_color_select((Bit8u)val);
+-		break;
+ 	case 0x3da:
+ 		if (vga.tandy.pcjr_flipflop) write_tandy_reg((Bit8u)val);
+-		else vga.tandy.reg_index=(Bit8u)val;
++		else {
++			vga.tandy.reg_index=(Bit8u)val;
++			if (vga.tandy.reg_index & 0x10)
++				vga.attr.disabled |= 2;
++			else vga.attr.disabled &= ~2;
++		}
+ 		vga.tandy.pcjr_flipflop=!vga.tandy.pcjr_flipflop;
+ 		break;
+ 	case 0x3df:
++		// CRT/processor page register
++		
++		// Bit 0-2: CRT page PG0-2
++		// In one- and two bank modes, bit 0-2 select the 16kB memory
++		// area of system RAM that is displayed on the screen.
++		// In 4-banked modes, bit 1-2 select the 32kB memory area.
++		// Bit 2 only has effect when the PCJR upgrade to 128k is installed.
++		
++		// Bit 3-5: Processor page CPU_PG
++		// Selects the 16kB area of system RAM that is mapped to
++		// the B8000h IBM PC video memory window. Since A14-A16 of the 
++		// processor are unconditionally replaced with these bits when
++		// B8000h is accessed, the 16kB area is mapped to the 32kB
++		// range twice in a row. (Scuba Venture writes across the boundary)
++		
++		// Bit 6-7: Video Address mode
++		// 0: CRTC addresses A0-12 directly, accessing 8k characters
++		//    (+8k attributes). Used in text modes (one bank).
++		//    PG0-2 in effect. 16k range.
++		// 1: CRTC A12 is replaced with CRTC RA0 (see max_scanline).
++		//    This results in the even/odd scanline two bank system.
++		//    PG0-2 in effect. 16k range.
++		// 2: Documented as unused. CRTC addresses A0-12, PG0 is replaced
++		//    with RA1. Looks like nonsense.
++		//    PG1-2 in effect. 32k range which cannot be used completely.
++		// 3: CRTC A12 is replaced with CRTC RA0, PG0 is replaced with
++		//    CRTC RA1. This results in the 4-bank mode.
++		//    PG1-2 in effect. 32k range.
++
+ 		vga.tandy.line_mask = (Bit8u)(val >> 6);
+ 		vga.tandy.draw_bank = val & ((vga.tandy.line_mask&2) ? 0x6 : 0x7);
+-		vga.tandy.mem_bank = (val >> 3) & ((vga.tandy.line_mask&2) ? 0x6 : 0x7);
++		vga.tandy.mem_bank = (val >> 3) & 7;
+ 		vga.tandy.draw_base = &MemBase[vga.tandy.draw_bank * 16 * 1024];
+ 		vga.tandy.mem_base = &MemBase[vga.tandy.mem_bank * 16 * 1024];
+ 		TandyCheckLineMask();
+@@ -516,7 +743,12 @@
+ 		break;
+ 		}
+ 	case 0x3bf:
+-		vga.herc.enable_bits=(Bit8u)val;
++		if ( vga.herc.enable_bits ^ val) {
++			vga.herc.enable_bits=val;
++			// Bit 1 enables the upper 32k of video memory,
++			// so update the handlers
++			VGA_SetupHandlers();
++		}
+ 		break;
+ 	}
+ }
+@@ -572,6 +804,10 @@
+ 		for (i=0;i<256;i++)	memcpy(&vga.draw.font[i*32],&int10_font_08[i*8],8);
+ 		vga.draw.font_tables[0]=vga.draw.font_tables[1]=vga.draw.font;
+ 	}
++	if (machine==MCH_CGA || IS_TANDY_ARCH || machine==MCH_HERC) {
++		IO_RegisterWriteHandler(0x3db,write_lightpen,IO_MB);
++		IO_RegisterWriteHandler(0x3dc,write_lightpen,IO_MB);
++	}
+ 	if (machine==MCH_HERC) {
+ 		extern Bit8u int10_font_14[256 * 14];
+ 		for (i=0;i<256;i++)	memcpy(&vga.draw.font[i*32],&int10_font_14[i*14],14);
+@@ -581,25 +817,27 @@
+ 	if (machine==MCH_CGA) {
+ 		IO_RegisterWriteHandler(0x3d8,write_cga,IO_MB);
+ 		IO_RegisterWriteHandler(0x3d9,write_cga,IO_MB);
+-		IO_RegisterWriteHandler(0x3db,write_tandy,IO_MB);
+-		IO_RegisterWriteHandler(0x3dc,write_tandy,IO_MB);
+ 		MAPPER_AddHandler(IncreaseHue,MK_f11,MMOD2,"inchue","Inc Hue");
+ 		MAPPER_AddHandler(DecreaseHue,MK_f11,0,"dechue","Dec Hue");
++		MAPPER_AddHandler(CGAModel,MK_f11,MMOD1|MMOD2,"cgamodel","CGA Model");
++		MAPPER_AddHandler(Composite,MK_f12,0,"cgacomp","CGA Comp");
+ 	}
+ 	if (machine==MCH_TANDY) {
+ 		write_tandy( 0x3df, 0x0, 0 );
+ 		IO_RegisterWriteHandler(0x3d8,write_tandy,IO_MB);
+ 		IO_RegisterWriteHandler(0x3d9,write_tandy,IO_MB);
++		IO_RegisterWriteHandler(0x3da,write_tandy,IO_MB);
+ 		IO_RegisterWriteHandler(0x3de,write_tandy,IO_MB);
+ 		IO_RegisterWriteHandler(0x3df,write_tandy,IO_MB);
+-		IO_RegisterWriteHandler(0x3da,write_tandy,IO_MB);
+ 	}
+ 	if (machine==MCH_PCJR) {
+ 		//write_pcjr will setup base address
+ 		write_pcjr( 0x3df, 0x7 | (0x7 << 3), 0 );
+-		IO_RegisterWriteHandler(0x3d9,write_pcjr,IO_MB);
+ 		IO_RegisterWriteHandler(0x3da,write_pcjr,IO_MB);
+ 		IO_RegisterWriteHandler(0x3df,write_pcjr,IO_MB);
++		// additional CRTC access documented
++		IO_RegisterWriteHandler(0x3d0,write_crtc_index_other,IO_MB);
++		IO_RegisterWriteHandler(0x3d1,write_crtc_data_other,IO_MB);
+ 	}
+ 	if (machine==MCH_HERC) {
+ 		Bitu base=0x3b0;
+diff -Nur dosbox-0.74/src/hardware/vga_paradise.cpp dosbox/src/hardware/vga_paradise.cpp
+--- dosbox-0.74/src/hardware/vga_paradise.cpp	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/hardware/vga_paradise.cpp	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,7 +16,6 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: vga_paradise.cpp,v 1.4 2009-05-27 09:15:41 qbix79 Exp $ */
+ 
+ #include "dosbox.h"
+ #include "setup.h"
+diff -Nur dosbox-0.74/src/hardware/vga_s3.cpp dosbox/src/hardware/vga_s3.cpp
+--- dosbox-0.74/src/hardware/vga_s3.cpp	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/hardware/vga_s3.cpp	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,7 +16,6 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: vga_s3.cpp,v 1.18 2009-03-15 11:28:35 c2woody Exp $ */
+ 
+ #include "dosbox.h"
+ #include "inout.h"
+@@ -342,7 +341,7 @@
+ 		vga.svga.bank_write = vga.svga.bank_read;
+ 		VGA_SetupHandlers();
+ 		break;
+-	case 0x6b:	// BIOS scratchpad: LFB adress
++	case 0x6b:	// BIOS scratchpad: LFB address
+ 		vga.s3.reg_6b=(Bit8u)val;
+ 		break;
+ 	default:
+diff -Nur dosbox-0.74/src/hardware/vga_seq.cpp dosbox/src/hardware/vga_seq.cpp
+--- dosbox-0.74/src/hardware/vga_seq.cpp	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/hardware/vga_seq.cpp	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,7 +16,6 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: vga_seq.cpp,v 1.24 2009-05-27 09:15:41 qbix79 Exp $ */
+ 
+ #include "dosbox.h"
+ #include "inout.h"
+diff -Nur dosbox-0.74/src/hardware/vga_tseng.cpp dosbox/src/hardware/vga_tseng.cpp
+--- dosbox-0.74/src/hardware/vga_tseng.cpp	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/hardware/vga_tseng.cpp	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,7 +16,6 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: vga_tseng.cpp,v 1.5 2009-05-27 09:15:41 qbix79 Exp $ */
+ 
+ 
+ #include "dosbox.h"
+diff -Nur dosbox-0.74/src/hardware/vga_xga.cpp dosbox/src/hardware/vga_xga.cpp
+--- dosbox-0.74/src/hardware/vga_xga.cpp	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/hardware/vga_xga.cpp	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,7 +16,6 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: vga_xga.cpp,v 1.17 2009-05-27 09:15:41 qbix79 Exp $ */
+ 
+ #include <string.h>
+ #include "dosbox.h"
+diff -Nur dosbox-0.74/src/ints/bios.cpp dosbox/src/ints/bios.cpp
+--- dosbox-0.74/src/ints/bios.cpp	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/ints/bios.cpp	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,7 +16,6 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: bios.cpp,v 1.78 2009-10-10 13:26:46 h-a-l-9000 Exp $ */
+ 
+ #include "dosbox.h"
+ #include "mem.h"
+@@ -27,10 +26,13 @@
+ #include "inout.h"
+ #include "pic.h"
+ #include "hardware.h"
++#include "pci_bus.h"
+ #include "joystick.h"
+ #include "mouse.h"
+ #include "setup.h"
+ #include "serialport.h"
++#include <time.h>
++#include <sys/timeb.h>
+ 
+ 
+ /* if mem_systems 0 then size_extended is reported as the real size else 
+@@ -312,7 +314,8 @@
+ 	case 0x00:	/* Get System time */
+ 		{
+ 			Bit32u ticks=mem_readd(BIOS_TIMER);
+-			reg_al=0;		/* Midnight never passes :) */
++			reg_al=mem_readb(BIOS_24_HOURS_FLAG);
++			mem_writeb(BIOS_24_HOURS_FLAG,0); // reset the "flag"
+ 			reg_cx=(Bit16u)(ticks >> 16);
+ 			reg_dx=(Bit16u)(ticks & 0xffff);
+ 			break;
+@@ -352,8 +355,120 @@
+ 		TandyDAC_Handler(reg_ah);
+ 		break;
+ 	case 0xb1:		/* PCI Bios Calls */
+-		LOG(LOG_BIOS,LOG_ERROR)("INT1A:PCI bios call %2X",reg_al);
++		LOG(LOG_BIOS,LOG_WARN)("INT1A:PCI bios call %2X",reg_al);
++#if defined(PCI_FUNCTIONALITY_ENABLED)
++		switch (reg_al) {
++			case 0x01:	// installation check
++				if (PCI_IsInitialized()) {
++					reg_ah=0x00;
++					reg_al=0x01;	// cfg space mechanism 1 supported
++					reg_bx=0x0210;	// ver 2.10
++					reg_cx=0x0000;	// only one PCI bus
++					reg_edx=0x20494350;
++					reg_edi=PCI_GetPModeInterface();
++					CALLBACK_SCF(false);
++				} else {
++					CALLBACK_SCF(true);
++				}
++				break;
++			case 0x02: {	// find device
++				Bitu devnr=0;
++				Bitu count=0x100;
++				Bit32u devicetag=(reg_cx<<16)|reg_dx;
++				Bits found=-1;
++				for (Bitu i=0; i<=count; i++) {
++					IO_WriteD(0xcf8,0x80000000|(i<<8));	// query unique device/subdevice entries
++					if (IO_ReadD(0xcfc)==devicetag) {
++						if (devnr==reg_si) {
++							found=i;
++							break;
++						} else {
++							// device found, but not the SIth device
++							devnr++;
++						}
++					}
++				}
++				if (found>=0) {
++					reg_ah=0x00;
++					reg_bh=0x00;	// bus 0
++					reg_bl=(Bit8u)(found&0xff);
++					CALLBACK_SCF(false);
++				} else {
++					reg_ah=0x86;	// device not found
++					CALLBACK_SCF(true);
++				}
++				}
++				break;
++			case 0x03: {	// find device by class code
++				Bitu devnr=0;
++				Bitu count=0x100;
++				Bit32u classtag=reg_ecx&0xffffff;
++				Bits found=-1;
++				for (Bitu i=0; i<=count; i++) {
++					IO_WriteD(0xcf8,0x80000000|(i<<8));	// query unique device/subdevice entries
++					if (IO_ReadD(0xcfc)!=0xffffffff) {
++						IO_WriteD(0xcf8,0x80000000|(i<<8)|0x08);
++						if ((IO_ReadD(0xcfc)>>8)==classtag) {
++							if (devnr==reg_si) {
++								found=i;
++								break;
++							} else {
++								// device found, but not the SIth device
++								devnr++;
++							}
++						}
++					}
++				}
++				if (found>=0) {
++					reg_ah=0x00;
++					reg_bh=0x00;	// bus 0
++					reg_bl=(Bit8u)(found&0xff);
++					CALLBACK_SCF(false);
++				} else {
++					reg_ah=0x86;	// device not found
++					CALLBACK_SCF(true);
++				}
++				}
++				break;
++			case 0x08:	// read configuration byte
++				IO_WriteD(0xcf8,0x80000000|(reg_bx<<8)|(reg_di&0xfc));
++				reg_cl=IO_ReadB(0xcfc+(reg_di&3));
++				CALLBACK_SCF(false);
++				break;
++			case 0x09:	// read configuration word
++				IO_WriteD(0xcf8,0x80000000|(reg_bx<<8)|(reg_di&0xfc));
++				reg_cx=IO_ReadW(0xcfc+(reg_di&2));
++				CALLBACK_SCF(false);
++				break;
++			case 0x0a:	// read configuration dword
++				IO_WriteD(0xcf8,0x80000000|(reg_bx<<8)|(reg_di&0xfc));
++				reg_ecx=IO_ReadD(0xcfc+(reg_di&3));
++				CALLBACK_SCF(false);
++				break;
++			case 0x0b:	// write configuration byte
++				IO_WriteD(0xcf8,0x80000000|(reg_bx<<8)|(reg_di&0xfc));
++				IO_WriteB(0xcfc+(reg_di&3),reg_cl);
++				CALLBACK_SCF(false);
++				break;
++			case 0x0c:	// write configuration word
++				IO_WriteD(0xcf8,0x80000000|(reg_bx<<8)|(reg_di&0xfc));
++				IO_WriteW(0xcfc+(reg_di&2),reg_cx);
++				CALLBACK_SCF(false);
++				break;
++			case 0x0d:	// write configuration dword
++				IO_WriteD(0xcf8,0x80000000|(reg_bx<<8)|(reg_di&0xfc));
++				IO_WriteD(0xcfc+(reg_di&3),reg_ecx);
++				CALLBACK_SCF(false);
++				break;
++			default:
++				LOG(LOG_BIOS,LOG_ERROR)("INT1A:PCI BIOS: unknown function %x (%x %x %x)",
++					reg_ax,reg_bx,reg_cx,reg_dx);
++				CALLBACK_SCF(true);
++				break;
++		}
++#else
+ 		CALLBACK_SCF(true);
++#endif
+ 		break;
+ 	default:
+ 		LOG(LOG_BIOS,LOG_ERROR)("INT1A:Undefined call %2X",reg_ah);
+@@ -372,9 +487,45 @@
+ #ifndef DOSBOX_CLOCKSYNC
+ #define DOSBOX_CLOCKSYNC 0
+ #endif
++
++static void BIOS_HostTimeSync() {
++	/* Setup time and date */
++	struct timeb timebuffer;
++	ftime(&timebuffer);
++	
++	struct tm *loctime;
++	loctime = localtime (&timebuffer.time);
++
++	/*
++	loctime->tm_hour = 23;
++	loctime->tm_min = 59;
++	loctime->tm_sec = 45;
++	loctime->tm_mday = 28;
++	loctime->tm_mon = 2-1;
++	loctime->tm_year = 2007 - 1900;
++	*/
++
++	dos.date.day=(Bit8u)loctime->tm_mday;
++	dos.date.month=(Bit8u)loctime->tm_mon+1;
++	dos.date.year=(Bit16u)loctime->tm_year+1900;
++
++	Bit32u ticks=(Bit32u)(((double)(
++		loctime->tm_hour*3600*1000+
++		loctime->tm_min*60*1000+
++		loctime->tm_sec*1000+
++		timebuffer.millitm))*(((double)PIT_TICK_RATE/65536.0)/1000.0));
++	mem_writed(BIOS_TIMER,ticks);
++}
++
+ static Bitu INT8_Handler(void) {
+ 	/* Increase the bios tick counter */
+ 	Bit32u value = mem_readd(BIOS_TIMER) + 1;
++	if(value >= 0x1800B0) {
++		// time wrap at midnight
++		mem_writeb(BIOS_24_HOURS_FLAG,mem_readb(BIOS_24_HOURS_FLAG)+1);
++		value=0;
++	}
++
+ #if DOSBOX_CLOCKSYNC
+ 	static bool check = false;
+ 	if((value %50)==0) {
+@@ -434,18 +585,16 @@
+ 	return CBRET_NONE;
+ }
+ 
+-static Bit8u INT14_Wait(Bit16u port, Bit8u mask, Bit8u timeout) {
++static bool INT14_Wait(Bit16u port, Bit8u mask, Bit8u timeout, Bit8u* retval) {
+ 	double starttime = PIC_FullIndex();
+ 	double timeout_f = timeout * 1000.0;
+-	Bit8u retval;
+-	while (((retval = IO_ReadB(port)) & mask) != mask) {
++	while (((*retval = IO_ReadB(port)) & mask) != mask) {
+ 		if (starttime < (PIC_FullIndex() - timeout_f)) {
+-			retval |= 0x80;
+-			break;
++			return false;
+ 		}
+ 		CALLBACK_Idle();
+ 	}
+-	return retval;
++	return true;
+ }
+ 
+ static Bitu INT14_Handler(void) {
+@@ -500,7 +649,7 @@
+ 		CALLBACK_SCF(false);
+ 		break;
+ 	}
+-	case 0x01: { // Transmit character
++	case 0x01: // Transmit character
+ 		// Parameters:				Return:
+ 		// AL: character			AL: unchanged
+ 		// AH: 0x01					AH: line status from just before the char was sent
+@@ -510,20 +659,19 @@
+ 
+ 		// set DTR & RTS on
+ 		IO_WriteB(port+4,0x3);
+-
+ 		// wait for DSR & CTS
+-		reg_ah = INT14_Wait(port+6, 0x30, timeout);
+-		if (!(reg_ah & 0x80)) {
++		if (INT14_Wait(port+6, 0x30, timeout, &reg_ah)) {
+ 			// wait for TX buffer empty
+-			reg_ah = INT14_Wait(port+5, 0x20, timeout);
+-			if (!(reg_ah & 0x80)) {
++			if (INT14_Wait(port+5, 0x20, timeout, &reg_ah)) {
+ 				// fianlly send the character
+ 				IO_WriteB(port,reg_al);
+-			}
+-		} // else timed out
++			} else
++				reg_ah |= 0x80;
++		} else // timed out
++			reg_ah |= 0x80;
++
+ 		CALLBACK_SCF(false);
+ 		break;
+-	}
+ 	case 0x02: // Read character
+ 		// Parameters:				Return:
+ 		// AH: 0x02					AL: received character
+@@ -537,15 +685,16 @@
+ 		IO_WriteB(port+4,0x1);
+ 
+ 		// wait for DSR
+-		reg_ah = INT14_Wait(port+6, 0x20, timeout);
+-		if (!(reg_ah & 0x80)) {
++		if (INT14_Wait(port+6, 0x20, timeout, &reg_ah)) {
+ 			// wait for character to arrive
+-			reg_ah = INT14_Wait(port+5, 0x01, timeout);
+-			if (!(reg_ah & 0x80)) {
++			if (INT14_Wait(port+5, 0x01, timeout, &reg_ah)) {
+ 				reg_ah &= 0x1E;
+ 				reg_al = IO_ReadB(port);
+-			}
+-		}
++			} else
++				reg_ah |= 0x80;
++		} else
++			reg_ah |= 0x80;
++
+ 		CALLBACK_SCF(false);
+ 		break;
+ 	case 0x03: // get status
+@@ -678,6 +827,7 @@
+ 				CALLBACK_Idle();
+ 			}
+ 			CALLBACK_SCF(false);
++			break;
+ 		}
+ 	case 0x87:	/* Copy extended memory */
+ 		{
+@@ -847,14 +997,14 @@
+ 		CALLBACK_Setup(call_irq0,INT8_Handler,CB_IRQ0,Real2Phys(BIOS_DEFAULT_IRQ0_LOCATION),"IRQ 0 Clock");
+ 		RealSetVec(0x08,BIOS_DEFAULT_IRQ0_LOCATION);
+ 		// pseudocode for CB_IRQ0:
++		//	sti
+ 		//	callback INT8_Handler
+-		//	push ax,dx,ds
++		//	push ds,ax,dx
+ 		//	int 0x1c
+ 		//	cli
+-		//	pop ds,dx
+ 		//	mov al, 0x20
+ 		//	out 0x20, al
+-		//	pop ax
++		//	pop dx,ax,ds
+ 		//	iret
+ 
+ 		mem_writed(BIOS_TIMER,0);			//Calculate the correct time
+@@ -869,7 +1019,7 @@
+ 		if (IS_TANDY_ARCH) {
+ 			/* reduce reported memory size for the Tandy (32k graphics memory
+ 			   at the end of the conventional 640k) */
+-			if (machine==MCH_TANDY) mem_writew(BIOS_MEMORY_SIZE,608);
++			if (machine==MCH_TANDY) mem_writew(BIOS_MEMORY_SIZE,624);
+ 			else mem_writew(BIOS_MEMORY_SIZE,640);
+ 			mem_writew(BIOS_TRUE_MEMORY_SIZE,640);
+ 		} else mem_writew(BIOS_MEMORY_SIZE,640);
+@@ -909,14 +1059,29 @@
+ 		callback[9].Set_RealVec(0x71);
+ 
+ 		/* Reboot */
++		// This handler is an exit for more than only reboots, since we
++		// don't handle these cases
+ 		callback[10].Install(&Reboot_Handler,CB_IRET,"reboot");
++		
++		// INT 18h: Enter BASIC
++		// Non-IBM BIOS would display "NO ROM BASIC" here
+ 		callback[10].Set_RealVec(0x18);
+ 		RealPt rptr = callback[10].Get_RealPointer();
++
++		// INT 19h: Boot function
++		// This is not a complete reboot as it happens after the POST
++		// We don't handle it, so use the reboot function as exit.
+ 		RealSetVec(0x19,rptr);
+-		// set system BIOS entry point too
+-		phys_writeb(0xFFFF0,0xEA);	// FARJMP
+-		phys_writew(0xFFFF1,RealOff(rptr));	// offset
+-		phys_writew(0xFFFF3,RealSeg(rptr));	// segment
++
++		// The farjump at the processor reset entry point (jumps to POST routine)
++		phys_writeb(0xFFFF0,0xEA);		// FARJMP
++		phys_writew(0xFFFF1,RealOff(BIOS_DEFAULT_RESET_LOCATION));	// offset
++		phys_writew(0xFFFF3,RealSeg(BIOS_DEFAULT_RESET_LOCATION));	// segment
++
++		// Compatible POST routine location: jump to the callback
++		phys_writeb(Real2Phys(BIOS_DEFAULT_RESET_LOCATION)+0,0xEA);				// FARJMP
++		phys_writew(Real2Phys(BIOS_DEFAULT_RESET_LOCATION)+1,RealOff(rptr));	// offset
++		phys_writew(Real2Phys(BIOS_DEFAULT_RESET_LOCATION)+3,RealSeg(rptr));	// segment
+ 
+ 		/* Irq 2 */
+ 		Bitu call_irq2=CALLBACK_Allocate();	
+@@ -1078,6 +1243,7 @@
+ 		size_extended=IO_Read(0x71);
+ 		IO_Write(0x70,0x31);
+ 		size_extended|=(IO_Read(0x71) << 8);
++		BIOS_HostTimeSync();
+ 	}
+ 	~BIOS(){
+ 		/* abort DAC playing */
+diff -Nur dosbox-0.74/src/ints/bios_disk.cpp dosbox/src/ints/bios_disk.cpp
+--- dosbox-0.74/src/ints/bios_disk.cpp	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/ints/bios_disk.cpp	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,11 +16,11 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: bios_disk.cpp,v 1.40 2009-08-23 17:24:54 c2woody Exp $ */
+ 
+ #include "dosbox.h"
+ #include "callback.h"
+ #include "bios.h"
++#include "bios_disk.h"
+ #include "regs.h"
+ #include "mem.h"
+ #include "dos_inc.h" /* for Drives[] */
+@@ -86,13 +86,26 @@
+ 	}
+ }
+ 
++void incrementFDD(void) {
++	Bit16u equipment=mem_readw(BIOS_CONFIGURATION);
++	if(equipment&1) {
++		Bitu numofdisks = (equipment>>6)&3;
++		numofdisks++;
++		if(numofdisks > 1) numofdisks=1;//max 2 floppies at the moment
++		equipment&=~0x00C0;
++		equipment|=(numofdisks<<6);
++	} else equipment|=1;
++	mem_writew(BIOS_CONFIGURATION,equipment);
++	CMOS_SetRegister(0x14, (Bit8u)(equipment&0xff));
++}
++
+ void swapInDisks(void) {
+ 	bool allNull = true;
+ 	Bits diskcount = 0;
+ 	Bits swapPos = swapPosition;
+ 	int i;
+ 
+-	/* Check to make sure there's atleast one setup image */
++	/* Check to make sure that  there is at least one setup image */
+ 	for(i=0;i<MAX_SWAPPABLE_DISKS;i++) {
+ 		if(diskSwap[i]!=NULL) {
+ 			allNull = false;
+@@ -150,8 +163,9 @@
+ 
+ 	bytenum = sectnum * sector_size;
+ 
+-	fseek(diskimg,bytenum,SEEK_SET);
+-	fread(data, 1, sector_size, diskimg);
++	if (bytenum!=current_fpos) fseek(diskimg,bytenum,SEEK_SET);
++	size_t ret=fread(data, 1, sector_size, diskimg);
++	current_fpos=bytenum+ret;
+ 
+ 	return 0x00;
+ }
+@@ -162,7 +176,6 @@
+ 	sectnum = ( (cylinder * heads + head) * sectors ) + sector - 1L;
+ 
+ 	return Write_AbsoluteSector(sectnum, data);
+-
+ }
+ 
+ 
+@@ -173,8 +186,9 @@
+ 
+ 	//LOG_MSG("Writing sectors to %ld at bytenum %d", sectnum, bytenum);
+ 
+-	fseek(diskimg,bytenum,SEEK_SET);
++	if (bytenum!=current_fpos) fseek(diskimg,bytenum,SEEK_SET);
+ 	size_t ret=fwrite(data, sector_size, 1, diskimg);
++	current_fpos=bytenum+ret;
+ 
+ 	return ((ret>0)?0x00:0x05);
+ 
+@@ -185,7 +199,9 @@
+ 	cylinders = 0;
+ 	sectors = 0;
+ 	sector_size = 512;
++	current_fpos = 0;
+ 	diskimg = imgFile;
++	fseek(diskimg,0,SEEK_SET);
+ 	
+ 	memset(diskname,0,512);
+ 	if(strlen((const char *)imgName) > 511) {
+@@ -217,16 +233,7 @@
+ 		if(!founddisk) {
+ 			active = false;
+ 		} else {
+-			Bit16u equipment=mem_readw(BIOS_CONFIGURATION);
+-			if(equipment&1) {
+-				Bitu numofdisks = (equipment>>6)&3;
+-				numofdisks++;
+-				if(numofdisks > 1) numofdisks=1;//max 2 floppies at the moment
+-				equipment&=~0x00C0;
+-				equipment|=(numofdisks<<6);
+-			} else equipment|=1;
+-			mem_writew(BIOS_CONFIGURATION,equipment);
+-			CMOS_SetRegister(0x14, (Bit8u)(equipment&0xff));
++			incrementFDD();
+ 		}
+ 	}
+ }
+@@ -327,12 +334,14 @@
+ 				if ((machine==MCH_CGA) || (machine==MCH_PCJR)) {
+ 					/* those bioses call floppy drive reset for invalid drive values */
+ 					if (((imageDiskList[0]) && (imageDiskList[0]->active)) || ((imageDiskList[1]) && (imageDiskList[1]->active))) {
++						if (machine!=MCH_PCJR && reg_dl<0x80) reg_ip++;
+ 						last_status = 0x00;
+ 						CALLBACK_SCF(false);
+ 					}
+ 				}
+ 				return CBRET_NONE;
+ 			}
++			if (machine!=MCH_PCJR && reg_dl<0x80) reg_ip++;
+ 			last_status = 0x00;
+ 			CALLBACK_SCF(false);
+ 		}
+@@ -494,7 +503,7 @@
+ void BIOS_SetupDisks(void) {
+ /* TODO Start the time correctly */
+ 	call_int13=CALLBACK_Allocate();	
+-	CALLBACK_Setup(call_int13,&INT13_DiskHandler,CB_IRET,"Int 13 Bios disk");
++	CALLBACK_Setup(call_int13,&INT13_DiskHandler,CB_INT13,"Int 13 Bios disk");
+ 	RealSetVec(0x13,CALLBACK_RealPointer(call_int13));
+ 	int i;
+ 	for(i=0;i<4;i++) {
+diff -Nur dosbox-0.74/src/ints/bios_keyboard.cpp dosbox/src/ints/bios_keyboard.cpp
+--- dosbox-0.74/src/ints/bios_keyboard.cpp	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/ints/bios_keyboard.cpp	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,7 +16,6 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: bios_keyboard.cpp,v 1.36 2009-06-11 16:05:17 c2woody Exp $ */
+ 
+ #include "dosbox.h"
+ #include "callback.h"
+@@ -33,6 +32,8 @@
+  * Define the following if this is the case */
+ #if SDL_VERSION_ATLEAST(1, 2, 14)
+ #define CAN_USE_LOCK 1
++/* For lower versions of SDL we also use a slight hack to get the startup states of numclock and capslock right.
++ * The proper way is in the mapper, but the repeating key is an unwanted side effect for lower versions of SDL */
+ #endif
+ 
+ static Bitu call_int16,call_irq1,call_irq6;
+@@ -381,7 +382,7 @@
+ 				add_key(scan_to_scanascii[scancode].normal+0x5000);
+ 			} else if (flags1 &0x04) {
+ 				add_key((scan_to_scanascii[scancode].control&0xff00)|0xe0);
+-			} else if( ((flags1 &0x3) != 0) || ((flags1 &0x20) != 0) ) {
++			} else if( ((flags1 &0x3) != 0) || ((flags1 &0x20) != 0) ) { //Due to |0xe0 results are identical. 
+ 				add_key((scan_to_scanascii[scancode].shift&0xff00)|0xe0);
+ 			} else add_key((scan_to_scanascii[scancode].normal&0xff00)|0xe0);
+ 			break;
+@@ -392,7 +393,7 @@
+ 			mem_writeb(BIOS_KEYBOARD_TOKEN,token);
+ 		} else if (flags1 &0x04) {
+ 			add_key(scan_to_scanascii[scancode].control);
+-		} else if( ((flags1 &0x3) != 0) || ((flags1 &0x20) != 0) ) {
++		} else if( ((flags1 &0x3) != 0) ^ ((flags1 &0x20) != 0) ) { //Xor shift and numlock (both means off)
+ 			add_key(scan_to_scanascii[scancode].shift);
+ 		} else add_key(scan_to_scanascii[scancode].normal);
+ 		break;
+@@ -513,7 +514,7 @@
+ 		break;
+ 	case 0x01: /* CHECK FOR KEYSTROKE */
+ 		// enable interrupt-flag after IRET of this int16
+-		mem_writew(SegPhys(ss)+reg_sp+4,(mem_readw(SegPhys(ss)+reg_sp+4) | FLAG_IF));
++		CALLBACK_SIF(true);
+ 		for (;;) {
+ 			if (check_key(temp)) {
+ 				if (!IsEnhancedKey(temp)) {
+@@ -534,6 +535,8 @@
+ 		}
+ 		break;
+ 	case 0x11: /* CHECK FOR KEYSTROKE (enhanced keyboards only) */
++		// enable interrupt-flag after IRET of this int16
++		CALLBACK_SIF(true);
+ 		if (!check_key(temp)) {
+ 			CALLBACK_SZF(true);
+ 		} else {
+@@ -545,7 +548,7 @@
+ 			reg_ax=temp;
+ 		}
+ 		break;
+-	case 0x02:	/* GET SHIFT FlAGS */
++	case 0x02:	/* GET SHIFT FLAGS */
+ 		reg_al=mem_readb(BIOS_KEYBOARD_FLAGS1);
+ 		break;
+ 	case 0x03:	/* SET TYPEMATIC RATE AND DELAY */
+@@ -564,8 +567,10 @@
+ 		else reg_al=1;
+ 		break;
+ 	case 0x12: /* GET EXTENDED SHIFT STATES */
+-		reg_al=mem_readb(BIOS_KEYBOARD_FLAGS1);
+-		reg_ah=mem_readb(BIOS_KEYBOARD_FLAGS2);		
++		reg_al = mem_readb(BIOS_KEYBOARD_FLAGS1);
++		reg_ah = (mem_readb(BIOS_KEYBOARD_FLAGS2)&0x73)   |
++		         ((mem_readb(BIOS_KEYBOARD_FLAGS2)&4)<<5) | // SysReq pressed, bit 7
++		         (mem_readb(BIOS_KEYBOARD_FLAGS3)&0x0c);    // Right Ctrl/Alt pressed, bits 2,3
+ 		break;
+ 	case 0x55:
+ 		/* Weird call used by some dos apps */
+@@ -591,10 +596,15 @@
+ 	mem_writew(BIOS_KEYBOARD_BUFFER_HEAD,0x1e);
+ 	mem_writew(BIOS_KEYBOARD_BUFFER_TAIL,0x1e);
+ 	Bit8u flag1 = 0;
+-	Bit8u leds = 16; /* Ack recieved */
+-//MAPPER_Init takes care of this now ?
+-//	if(startup_state_capslock) { flag1|=0x40; leds|=0x04;}
+-//	if(startup_state_numlock){ flag1|=0x20; leds|=0x02;}
++	Bit8u leds = 16; /* Ack received */
++
++#if SDL_VERSION_ATLEAST(1, 2, 14)
++//Nothing, mapper handles all.
++#else
++	if (startup_state_capslock) { flag1|=0x40; leds|=0x04;}
++	if (startup_state_numlock)  { flag1|=0x20; leds|=0x02;}
++#endif
++
+ 	mem_writeb(BIOS_KEYBOARD_FLAGS1,flag1);
+ 	mem_writeb(BIOS_KEYBOARD_FLAGS2,0);
+ 	mem_writeb(BIOS_KEYBOARD_FLAGS3,16); /* Enhanced keyboard installed */	
+diff -Nur dosbox-0.74/src/ints/ems.cpp dosbox/src/ints/ems.cpp
+--- dosbox-0.74/src/ints/ems.cpp	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/ints/ems.cpp	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,7 +16,6 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: ems.cpp,v 1.65 2009-10-11 17:11:52 c2woody Exp $ */
+ 
+ #include <string.h>
+ #include <stdlib.h>
+@@ -32,6 +31,7 @@
+ #include "setup.h"
+ #include "support.h"
+ #include "cpu.h"
++#include "dma.h"
+ 
+ #define EMM_PAGEFRAME	0xE000
+ #define EMM_PAGEFRAME4K	((EMM_PAGEFRAME*16)/4096)
+@@ -88,6 +88,8 @@
+ 	EMM_Mapping page_map[EMM_MAX_PHYS];
+ };
+ 
++static Bitu ems_type;
++
+ static EMM_Handle emm_handles[EMM_MAX_HANDLES];
+ static EMM_Mapping emm_mappings[EMM_MAX_PHYS];
+ static EMM_Mapping emm_segmentmappings[0x40];
+@@ -97,7 +99,8 @@
+ 
+ class device_EMM : public DOS_Device {
+ public:
+-	device_EMM() {
++	device_EMM(bool is_emm386_avail) {
++		is_emm386=is_emm386_avail;
+ 		SetName("EMMXXXX0");
+ 		GEMMIS_seg=0;
+ 	}
+@@ -108,11 +111,12 @@
+ 	}
+ 	bool Seek(Bit32u * /*pos*/,Bit32u /*type*/){return false;}
+ 	bool Close(){return false;}
+-	Bit16u GetInformation(void){return 0xc080;}
++	Bit16u GetInformation(void){return 0xc0c0;}
+ 	bool ReadFromControlChannel(PhysPt bufptr,Bit16u size,Bit16u * retcode);
+ 	bool WriteToControlChannel(PhysPt /*bufptr*/,Bit16u /*size*/,Bit16u * /*retcode*/){return true;}
+ private:
+ 	Bit8u cache;
++	bool is_emm386;
+ };
+ 
+ bool device_EMM::ReadFromControlChannel(PhysPt bufptr,Bit16u size,Bit16u * retcode) { 
+@@ -125,6 +129,7 @@
+ 			*retcode=6;
+ 			return true;
+ 		case 0x01: {
++			if (!is_emm386) return false;
+ 			if (size!=6) return false;
+ 			if (GEMMIS_seg==0) GEMMIS_seg=DOS_GetMemory(0x20);
+ 			PhysPt GEMMIS_addr=PhysMake(GEMMIS_seg,0);
+@@ -181,12 +186,14 @@
+ 			return true;
+ 			}
+ 		case 0x02:
++			if (!is_emm386) return false;
+ 			if (size!=2) return false;
+ 			mem_writeb(bufptr+0x00,EMM_VERSION>>4);		// version 4
+ 			mem_writeb(bufptr+0x01,EMM_MINOR_VERSION);
+ 			*retcode=2;
+ 			return true;
+ 		case 0x03:
++			if (!is_emm386) return false;
+ 			if (EMM_MINOR_VERSION < 0x2d) return false;
+ 			if (size!=4) return false;
+ 			mem_writew(bufptr+0x00,(Bit16u)(MEM_TotalPages()*4));	// max size (kb)
+@@ -323,7 +330,23 @@
+ static Bit8u EMM_MapSegment(Bitu segment,Bit16u handle,Bit16u log_page) {
+ //	LOG_MSG("EMS MapSegment handle %d segment %d log %d",handle,segment,log_page);
+ 
+-	if (((segment>=0xa000) && (segment<0xb000)) || ((segment>=EMM_PAGEFRAME-0x1000) && (segment<EMM_PAGEFRAME+0x1000))) {
++	bool valid_segment=false;
++
++	if ((ems_type==1) || (ems_type==3)) {
++		if (segment<0xf000+0x1000) valid_segment=true;
++	} else {
++		if ((segment>=0xa000) && (segment<0xb000)) {
++			valid_segment=true;		// allow mapping of graphics memory
++		}
++		if ((segment>=EMM_PAGEFRAME) && (segment<EMM_PAGEFRAME+0x1000)) {
++			valid_segment=true;		// allow mapping of EMS page frame
++		}
++/*		if ((segment>=EMM_PAGEFRAME-0x1000) && (segment<EMM_PAGEFRAME)) {
++			valid_segment=true;
++		} */
++	}
++
++	if (valid_segment) {
+ 		Bit32s tphysPage = ((Bit32s)segment-EMM_PAGEFRAME)/(0x1000/EMM_MAX_PHYS);
+ 
+ 		/* unmapping doesn't need valid handle (as handle isn't used) */
+@@ -466,7 +489,7 @@
+ 				mem_writew(data,segment);data+=2;
+ 				MEM_BlockWrite(data,&emm_mappings[page],sizeof(EMM_Mapping));
+ 				data+=sizeof(EMM_Mapping);
+-			} else if (((segment>=EMM_PAGEFRAME-0x1000) && (segment<EMM_PAGEFRAME)) || ((segment>=0xa000) && (segment<0xb000))) {
++			} else if ((ems_type==1) || (ems_type==3) || ((segment>=EMM_PAGEFRAME-0x1000) && (segment<EMM_PAGEFRAME)) || ((segment>=0xa000) && (segment<0xb000))) {
+ 				mem_writew(data,segment);data+=2;
+ 				MEM_BlockWrite(data,&emm_segmentmappings[segment>>10],sizeof(EMM_Mapping));
+ 				data+=sizeof(EMM_Mapping);
+@@ -483,7 +506,7 @@
+ 			if ((segment>=EMM_PAGEFRAME) && (segment<EMM_PAGEFRAME+0x1000)) {
+ 				Bit16u page = (segment-EMM_PAGEFRAME) / (EMM_PAGE_SIZE>>4);
+ 				MEM_BlockRead(data,&emm_mappings[page],sizeof(EMM_Mapping));
+-			} else if (((segment>=EMM_PAGEFRAME-0x1000) && (segment<EMM_PAGEFRAME)) || ((segment>=0xa000) && (segment<0xb000))) {
++			} else if ((ems_type==1) || (ems_type==3) || ((segment>=EMM_PAGEFRAME-0x1000) && (segment<EMM_PAGEFRAME)) || ((segment>=0xa000) && (segment<0xb000))) {
+ 				MEM_BlockRead(data,&emm_segmentmappings[segment>>10],sizeof(EMM_Mapping));
+ 			} else {
+ 				return EMM_ILL_PHYS;
+@@ -1056,7 +1079,7 @@
+ 
+ 		reg_esp+=6;		// skip ip of CALL and error code of EXCEPTION 0x0d
+ 
+-		/* Get adress of faulting instruction */
++		/* Get address of faulting instruction */
+ 		Bit16u v86_cs=mem_readw(SegPhys(ss)+((reg_esp+4) & cpu.stack.mask));
+ 		Bit16u v86_ip=mem_readw(SegPhys(ss)+((reg_esp+0) & cpu.stack.mask));
+ 		Bit8u v86_opcode=mem_readb((v86_cs<<4)+v86_ip);
+@@ -1262,9 +1285,25 @@
+ 	return CBRET_NONE;
+ }
+ 
++Bitu GetEMSType(Section_prop * section) {
++	Bitu rtype = 0;
++	std::string emstypestr(section->Get_string("ems"));
++	if (emstypestr=="true") {
++		rtype = 1;	// mixed mode
++	} else if (emstypestr=="emsboard") {
++		rtype = 2;
++	} else if (emstypestr=="emm386") {
++		rtype = 3;
++	} else {
++		rtype = 0;
++	}
++	return rtype;
++}
++
+ 
+ class EMS: public Module_base {
+ private:
++	DOS_Device * emm_device;
+ 	/* location in protected unfreeable memory where the ems name and callback are
+ 	 * stored  32 bytes.*/
+ 	static Bit16u ems_baseseg;
+@@ -1273,7 +1312,9 @@
+ 	Bitu call_int67;
+ 
+ public:
+-	EMS(Section* configuration):Module_base(configuration){
++	EMS(Section* configuration):Module_base(configuration) {
++		emm_device=NULL;
++		ems_type=0;
+ 
+ 		/* Virtual DMA interrupt callback */
+ 		call_vdma.Install(&INT4B_Handler,CB_IRET,"Int 4b vdma");
+@@ -1283,8 +1324,11 @@
+ 		GEMMIS_seg=0;
+ 		
+ 		Section_prop * section=static_cast<Section_prop *>(configuration);
+-		if (!section->Get_bool("ems")) return;
++		ems_type=GetEMSType(section);
++		if (ems_type<=0) return;
++
+ 		if (machine==MCH_PCJR) {
++			ems_type=0;
+ 			LOG_MSG("EMS disabled for PCJr machine");
+ 			return;
+ 		}
+@@ -1302,8 +1346,8 @@
+ 
+ 		/* Register the ems device */
+ 		//TODO MAYBE put it in the class.
+-		DOS_Device * newdev = new device_EMM();
+-		DOS_AddDevice(newdev);
++		emm_device = new device_EMM(ems_type!=2);
++		DOS_AddDevice(emm_device);
+ 
+ 		/* Clear handle and page tables */
+ 		Bitu i;
+@@ -1321,63 +1365,69 @@
+ 			emm_segmentmappings[i].handle=NULL_HANDLE;
+ 		}
+ 
+-		EMM_AllocateSystemHandle(8);	// allocate OS-dedicated handle (ems handle zero, 128kb)
++		EMM_AllocateSystemHandle(24);	// allocate OS-dedicated handle (ems handle zero, 384kb)
+ 
++		if (ems_type==3) {
++			DMA_SetWrapping(0xffffffff);	// emm386-bug that disables dma wrapping
++		}
+ 
+ 		if (!ENABLE_VCPI) return;
+ 
+-		/* Install a callback that handles VCPI-requests in protected mode requests */
+-		call_vcpi.Install(&VCPI_PM_Handler,CB_IRETD,"VCPI PM");
+-		vcpi.pm_interface=(call_vcpi.Get_callback())*CB_SIZE;
+-
+-		/* Initialize private data area and set up descriptor tables */
+-		SetupVCPI();
+-
+-		if (!vcpi.enabled) return;
+-
+-		/* Install v86-callback that handles interrupts occuring
+-		   in v86 mode, including protection fault exceptions */
+-		call_v86mon.Install(&V86_Monitor,CB_IRET,"V86 Monitor");
+-
+-		mem_writeb(vcpi.private_area+0x2e00,(Bit8u)0xFE);       //GRP 4
+-		mem_writeb(vcpi.private_area+0x2e01,(Bit8u)0x38);       //Extra Callback instruction
+-		mem_writew(vcpi.private_area+0x2e02,call_v86mon.Get_callback());		//The immediate word
+-		mem_writeb(vcpi.private_area+0x2e04,(Bit8u)0x66);
+-		mem_writeb(vcpi.private_area+0x2e05,(Bit8u)0xCF);       //A IRETD Instruction
+-
+-		/* Testcode only, starts up dosbox in v86-mode */
+-		if (ENABLE_V86_STARTUP) {
+-			/* Prepare V86-task */
+-			CPU_SET_CRX(0, 1);
+-			CPU_LGDT(0xff, vcpi.private_area+0x0000);
+-			CPU_LIDT(0x7ff, vcpi.private_area+0x2000);
+-			if (CPU_LLDT(0x08)) LOG_MSG("VCPI:Could not load LDT");
+-			if (CPU_LTR(0x10)) LOG_MSG("VCPI:Could not load TR");
+-
+-			CPU_Push32(SegValue(gs));
+-			CPU_Push32(SegValue(fs));
+-			CPU_Push32(SegValue(ds));
+-			CPU_Push32(SegValue(es));
+-			CPU_Push32(SegValue(ss));
+-			CPU_Push32(0x23002);
+-			CPU_Push32(SegValue(cs));
+-			CPU_Push32(reg_eip&0xffff);
+-			/* Switch to V86-mode */
+-			cpu.cpl=0;
+-			CPU_IRET(true,0);
++		if (ems_type!=2) {
++			/* Install a callback that handles VCPI-requests in protected mode requests */
++			call_vcpi.Install(&VCPI_PM_Handler,CB_IRETD,"VCPI PM");
++			vcpi.pm_interface=(call_vcpi.Get_callback())*CB_SIZE;
++
++			/* Initialize private data area and set up descriptor tables */
++			SetupVCPI();
++
++			if (!vcpi.enabled) return;
++
++			/* Install v86-callback that handles interrupts occuring
++			   in v86 mode, including protection fault exceptions */
++			call_v86mon.Install(&V86_Monitor,CB_IRET,"V86 Monitor");
++
++			mem_writeb(vcpi.private_area+0x2e00,(Bit8u)0xFE);       //GRP 4
++			mem_writeb(vcpi.private_area+0x2e01,(Bit8u)0x38);       //Extra Callback instruction
++			mem_writew(vcpi.private_area+0x2e02,call_v86mon.Get_callback());		//The immediate word
++			mem_writeb(vcpi.private_area+0x2e04,(Bit8u)0x66);
++			mem_writeb(vcpi.private_area+0x2e05,(Bit8u)0xCF);       //A IRETD Instruction
++
++			/* Testcode only, starts up dosbox in v86-mode */
++			if (ENABLE_V86_STARTUP) {
++				/* Prepare V86-task */
++				CPU_SET_CRX(0, 1);
++				CPU_LGDT(0xff, vcpi.private_area+0x0000);
++				CPU_LIDT(0x7ff, vcpi.private_area+0x2000);
++				if (CPU_LLDT(0x08)) LOG_MSG("VCPI:Could not load LDT");
++				if (CPU_LTR(0x10)) LOG_MSG("VCPI:Could not load TR");
++
++				CPU_Push32(SegValue(gs));
++				CPU_Push32(SegValue(fs));
++				CPU_Push32(SegValue(ds));
++				CPU_Push32(SegValue(es));
++				CPU_Push32(SegValue(ss));
++				CPU_Push32(0x23002);
++				CPU_Push32(SegValue(cs));
++				CPU_Push32(reg_eip&0xffff);
++				/* Switch to V86-mode */
++				cpu.cpl=0;
++				CPU_IRET(true,0);
++			}
+ 		}
+ 	}
+ 	
+ 	~EMS() {
+-		Section_prop * section=static_cast<Section_prop *>(m_configuration);
+-		if (!section->Get_bool("ems")) return;
++		if (ems_type<=0) return;
+ 
+ 		/* Undo Biosclearing */
+ 		BIOS_ZeroExtendedSize(false);
+  
+ 		/* Remove ems device */
+-		device_EMM newdev;
+-		DOS_DelDevice(&newdev);
++		if (emm_device!=NULL) {
++			DOS_DelDevice(emm_device);
++			emm_device=NULL;
++		}
+ 		GEMMIS_seg=0;
+ 
+ 		/* Remove the emsname and callback hack */
+diff -Nur dosbox-0.74/src/ints/int10_char.cpp dosbox/src/ints/int10_char.cpp
+--- dosbox-0.74/src/ints/int10_char.cpp	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/ints/int10_char.cpp	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,7 +16,6 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: int10_char.cpp,v 1.60 2009-10-15 20:36:56 c2woody Exp $ */
+ 
+ /* Character displaying moving functions */
+ 
+@@ -202,9 +201,23 @@
+ 	if(clr>=ncols) clr=(Bit8u)ncols-1;
+ 	clr++;
+ 
+-	/* Get the correct page */
+-	if(page==0xFF) page=real_readb(BIOSMEM_SEG,BIOSMEM_CURRENT_PAGE);
+-	PhysPt base=CurMode->pstart+page*real_readw(BIOSMEM_SEG,BIOSMEM_PAGE_SIZE);
++	/* Get the correct page: current start address for current page (0xFF),
++	   otherwise calculate from page number and page size */
++	PhysPt base=CurMode->pstart;
++	if (page==0xff) base+=real_readw(BIOSMEM_SEG,BIOSMEM_CURRENT_START);
++	else base+=page*real_readw(BIOSMEM_SEG,BIOSMEM_PAGE_SIZE);
++	
++	if (GCC_UNLIKELY(machine==MCH_PCJR)) {
++		if (real_readb(BIOSMEM_SEG, BIOSMEM_CURRENT_MODE) >= 9) {
++			// PCJr cannot handle these modes at 0xb800
++			// See INT10_PutPixel M_TANDY16
++			Bitu cpupage =
++				(real_readb(BIOSMEM_SEG, BIOSMEM_CRTCPU_PAGE) >> 3) & 0x7;
++
++			base = cpupage << 14;
++			base += page*real_readw(BIOSMEM_SEG,BIOSMEM_PAGE_SIZE);
++		}
++	}
+ 
+ 	/* See how much lines need to be copied */
+ 	Bit8u start,end;Bits next;
+diff -Nur dosbox-0.74/src/ints/int10.cpp dosbox/src/ints/int10.cpp
+--- dosbox-0.74/src/ints/int10.cpp	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/ints/int10.cpp	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,7 +16,6 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: int10.cpp,v 1.56 2009-09-06 19:25:34 c2woody Exp $ */
+ 
+ #include "dosbox.h"
+ #include "mem.h"
+@@ -107,7 +106,9 @@
+ 		INT10_ReadCharAttr(&reg_ax,reg_bh);
+ 		break;						
+ 	case 0x09:								/* Write Character & Attribute at cursor CX times */
+-		INT10_WriteChar(reg_al,reg_bl,reg_bh,reg_cx,true);
++		if (real_readb(BIOSMEM_SEG,BIOSMEM_CURRENT_MODE)==0x11)
++			INT10_WriteChar(reg_al,(reg_bl&0x80)|0x3f,reg_bh,reg_cx,true);
++		else INT10_WriteChar(reg_al,reg_bl,reg_bh,reg_cx,true);
+ 		break;
+ 	case 0x0A:								/* Write Character at cursor CX times */
+ 		INT10_WriteChar(reg_al,reg_bl,reg_bh,reg_cx,false);
+@@ -138,8 +139,8 @@
+ 		reg_ah=(Bit8u)real_readw(BIOSMEM_SEG,BIOSMEM_NB_COLS);
+ 		break;					
+ 	case 0x10:								/* Palette functions */
+-		if ((machine==MCH_CGA) || ((!IS_VGA_ARCH) && (reg_al>0x02))) break;
+-		//TODO: subfunction 0x03 for ega
++		if (!IS_EGAVGA_ARCH && (reg_al>0x02)) break;
++		else if (!IS_VGA_ARCH && (reg_al>0x03)) break;
+ 		switch (reg_al) {
+ 		case 0x00:							/* SET SINGLE PALETTE REGISTER */
+ 			INT10_SetSinglePaletteRegister(reg_bl,reg_bh);
+@@ -163,7 +164,7 @@
+ 			INT10_GetAllPaletteRegisters(SegPhys(es)+reg_dx);
+ 			break;
+ 		case 0x10:							/* SET INDIVIDUAL DAC REGISTER */
+-			INT10_SetSingleDacRegister(reg_bl,reg_dh,reg_ch,reg_cl);
++			INT10_SetSingleDACRegister(reg_bl,reg_dh,reg_ch,reg_cl);
+ 			break;
+ 		case 0x12:							/* SET BLOCK OF DAC REGISTERS */
+ 			INT10_SetDACBlock(reg_bx,reg_cx,SegPhys(es)+reg_dx);
+@@ -172,7 +173,7 @@
+ 			INT10_SelectDACPage(reg_bl,reg_bh);
+ 			break;
+ 		case 0x15:							/* GET INDIVIDUAL DAC REGISTER */
+-			INT10_GetSingleDacRegister(reg_bl,&reg_dh,&reg_ch,&reg_cl);
++			INT10_GetSingleDACRegister(reg_bl,&reg_dh,&reg_ch,&reg_cl);
+ 			break;
+ 		case 0x17:							/* GET BLOCK OF DAC REGISTER */
+ 			INT10_GetDACBlock(reg_bx,reg_cx,SegPhys(es)+reg_dx);
+@@ -209,11 +210,11 @@
+ 			break;
+ 		case 0x01:			/* Load 8x14 font */
+ 		case 0x11:
+-			INT10_LoadFont(Real2Phys(int10.rom.font_14),reg_al==0x11,256,0,0,14);
++			INT10_LoadFont(Real2Phys(int10.rom.font_14),reg_al==0x11,256,0,reg_bl,14);
+ 			break;
+ 		case 0x02:			/* Load 8x8 font */
+ 		case 0x12:
+-			INT10_LoadFont(Real2Phys(int10.rom.font_8_first),reg_al==0x12,256,0,0,8);
++			INT10_LoadFont(Real2Phys(int10.rom.font_8_first),reg_al==0x12,256,0,reg_bl,8);
+ 			break;
+ 		case 0x03:			/* Set Block Specifier */
+ 			IO_Write(0x3c4,0x3);IO_Write(0x3c5,reg_bl);
+@@ -221,7 +222,7 @@
+ 		case 0x04:			/* Load 8x16 font */
+ 		case 0x14:
+ 			if (!IS_VGA_ARCH) break;
+-			INT10_LoadFont(Real2Phys(int10.rom.font_16),reg_al==0x14,256,0,0,16);
++			INT10_LoadFont(Real2Phys(int10.rom.font_16),reg_al==0x14,256,0,reg_bl,16);
+ 			break;
+ /* Graphics mode calls */
+ 		case 0x20:			/* Set User 8x8 Graphics characters */
+@@ -302,13 +303,8 @@
+ 				break;
+ 			}
+ 			if ((reg_bh<=7) || (svgaCard==SVGA_TsengET4K)) {
+-				if (machine==MCH_EGA) {
+-					reg_cx=0x0e;
+-					reg_dl=0x18;
+-				} else {
+-					reg_cx=real_readw(BIOSMEM_SEG,BIOSMEM_CHAR_HEIGHT);
+-					reg_dl=real_readb(BIOSMEM_SEG,BIOSMEM_NB_ROWS);
+-				}
++				reg_cx=real_readw(BIOSMEM_SEG,BIOSMEM_CHAR_HEIGHT);
++				reg_dl=real_readb(BIOSMEM_SEG,BIOSMEM_NB_ROWS);
+ 			}
+ 			break;
+ 		default:
+@@ -379,7 +375,7 @@
+ 				reg_al=0x12;
+ 				break;	
+ 			}		
+-		case 0x32:							/* Video adressing */
++		case 0x32:							/* Video addressing */
+ 			if (!IS_VGA_ARCH) break;
+ 			LOG(LOG_INT10,LOG_ERROR)("Function 12:Call %2X not handled",reg_bl);
+ 			if (svgaCard==SVGA_TsengET4K) reg_al&=1;
+@@ -716,11 +712,18 @@
+ 
+ 
+ static void INT10_InitVGA(void) {
+-/* switch to color mode and enable CPU access 480 lines */
+-	IO_Write(0x3c2,0xc3);
+-	/* More than 64k */
+-	IO_Write(0x3c4,0x04);
+-	IO_Write(0x3c5,0x02);
++	if (IS_EGAVGA_ARCH) {
++		/* switch to color mode and enable CPU access 480 lines */
++		IO_Write(0x3c2,0xc3);
++		/* More than 64k */
++		IO_Write(0x3c4,0x04);
++		IO_Write(0x3c5,0x02);
++		if (IS_VGA_ARCH) {
++			/* Initialize DAC */
++			IO_Write(0x3c8,0);
++			for (Bitu i=0;i<3*256;i++) IO_Write(0x3c9,0);
++		}
++	}
+ }
+ 
+ static void SetupTandyBios(void) {
+diff -Nur dosbox-0.74/src/ints/int10.h dosbox/src/ints/int10.h
+--- dosbox-0.74/src/ints/int10.h	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/ints/int10.h	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,7 +16,6 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: int10.h,v 1.42 2009-09-06 19:25:34 c2woody Exp $ */
+ 
+ #include "vga.h"
+ 
+@@ -187,8 +186,8 @@
+ void INT10_GetSinglePaletteRegister(Bit8u reg,Bit8u * val);
+ void INT10_GetOverscanBorderColor(Bit8u * val);
+ void INT10_GetAllPaletteRegisters(PhysPt data);
+-void INT10_SetSingleDacRegister(Bit8u index,Bit8u red,Bit8u green,Bit8u blue);
+-void INT10_GetSingleDacRegister(Bit8u index,Bit8u * red,Bit8u * green,Bit8u * blue);
++void INT10_SetSingleDACRegister(Bit8u index,Bit8u red,Bit8u green,Bit8u blue);
++void INT10_GetSingleDACRegister(Bit8u index,Bit8u * red,Bit8u * green,Bit8u * blue);
+ void INT10_SetDACBlock(Bit16u index,Bit16u count,PhysPt data);
+ void INT10_GetDACBlock(Bit16u index,Bit16u count,PhysPt data);
+ void INT10_SelectDACPage(Bit8u function,Bit8u mode);
+diff -Nur dosbox-0.74/src/ints/int10_memory.cpp dosbox/src/ints/int10_memory.cpp
+--- dosbox-0.74/src/ints/int10_memory.cpp	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/ints/int10_memory.cpp	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,7 +16,6 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: int10_memory.cpp,v 1.30 2009-09-06 19:25:34 c2woody Exp $ */
+ 
+ #include "dosbox.h"
+ #include "mem.h"
+@@ -50,7 +49,7 @@
+ 	PhysPt ftwhere=PhysMake(0xa000,map_offset[map & 0x7]+(Bit16u)(offset*32));
+ 	IO_Write(0x3c4,0x2);IO_Write(0x3c5,0x4);	//Enable plane 2
+ 	IO_Write(0x3ce,0x6);Bitu old_6=IO_Read(0x3cf);
+-	IO_Write(0x3cf,0x0);	//Disable odd/even and a0000 adressing
++	IO_Write(0x3cf,0x0);	//Disable odd/even and a0000 addressing
+ 	for (Bitu i=0;i<count;i++) {
+ 		MEM_BlockCopy(ftwhere,font,height);
+ 		ftwhere+=32;
+@@ -58,7 +57,7 @@
+ 	}
+ 	IO_Write(0x3c4,0x2);IO_Write(0x3c5,0x3);	//Enable textmode planes (0,1)
+ 	IO_Write(0x3ce,0x6);
+-	if (IS_VGA_ARCH) IO_Write(0x3cf,(Bit8u)old_6);	//odd/even and b8000 adressing
++	if (IS_VGA_ARCH) IO_Write(0x3cf,(Bit8u)old_6);	//odd/even and b8000 addressing
+ 	else IO_Write(0x3cf,0x0e);
+ 	/* Reload tables and registers with new values based on this height */
+ 	if (reload) {
+@@ -66,9 +65,21 @@
+ 		Bit16u base=real_readw(BIOSMEM_SEG,BIOSMEM_CRTC_ADDRESS);
+ 		IO_Write(base,0x9);
+ 		IO_Write(base+1,(IO_Read(base+1) & 0xe0)|(height-1));
+-		//Vertical display end bios says, but should stay the same?
++		// Vertical display end bios says, but should stay the same?
++		// Not on EGA.
++        Bitu rows = CurMode->sheight/height;
++		if (machine==MCH_EGA) {
++			Bitu displayend = rows*height - 1;
++			IO_Write(base,0x12);
++			IO_Write(base+1,(Bit8u)(displayend & 0xff));
++			IO_Write(base,0x7);
++			// Note: IBM EGA registers can't be read
++			Bitu v_overflow = IO_Read(base+1) & ~0x2;
++			if (displayend & 0x100) v_overflow |= 0x2;
++			IO_Write(base+1,(Bit8u)v_overflow);
++		}
+ 		//Rows setting in bios segment
+-		real_writeb(BIOSMEM_SEG,BIOSMEM_NB_ROWS,(CurMode->sheight/height)-1);
++		real_writeb(BIOSMEM_SEG,BIOSMEM_NB_ROWS,rows-1);
+ 		real_writeb(BIOSMEM_SEG,BIOSMEM_CHAR_HEIGHT,(Bit8u)height);
+ 		//TODO Reprogram cursor size?
+ 	}
+@@ -143,7 +154,7 @@
+ 			int10.rom.video_dcc_table=RealMake(0xC000,int10.rom.used);
+ 			phys_writeb(rom_base+int10.rom.used++,0x10);	// number of entries
+ 			phys_writeb(rom_base+int10.rom.used++,1);		// version number
+-			phys_writeb(rom_base+int10.rom.used++,8);		// maximal display code
++			phys_writeb(rom_base+int10.rom.used++,8);		// maximum display code
+ 			phys_writeb(rom_base+int10.rom.used++,0);		// reserved
+ 			// display combination codes
+ 			phys_writew(rom_base+int10.rom.used,0x0000);	int10.rom.used+=2;
+diff -Nur dosbox-0.74/src/ints/int10_misc.cpp dosbox/src/ints/int10_misc.cpp
+--- dosbox-0.74/src/ints/int10_misc.cpp	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/ints/int10_misc.cpp	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,7 +16,6 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: int10_misc.cpp,v 1.21 2009-05-27 09:15:42 qbix79 Exp $ */
+ 
+ #include "dosbox.h"
+ #include "mem.h"
+diff -Nur dosbox-0.74/src/ints/int10_modes.cpp dosbox/src/ints/int10_modes.cpp
+--- dosbox-0.74/src/ints/int10_modes.cpp	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/ints/int10_modes.cpp	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,7 +16,6 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: int10_modes.cpp,v 1.91 2009-10-19 16:00:22 h-a-l-9000 Exp $ */
+ 
+ #include <string.h>
+ 
+@@ -54,8 +53,8 @@
+ { 0x012  ,M_EGA    ,640 ,480 ,80 ,30 ,8 ,16 ,1 ,0xA0000 ,0xA000 ,100 ,525 ,80 ,480 ,0	},
+ { 0x013  ,M_VGA    ,320 ,200 ,40 ,25 ,8 ,8  ,1 ,0xA0000 ,0x2000 ,100 ,449 ,80 ,400 ,0   },
+ 
+-{ 0x054  ,M_TEXT   ,1056,688, 132,43, 8, 16, 1 ,0xB8000 ,0x4000, 192, 800, 132,688, 0   },
+-{ 0x055  ,M_TEXT   ,1056,400, 132,25, 8, 16, 1 ,0xB8000 ,0x2000, 192, 449, 132,400, 0   },
++{ 0x054  ,M_TEXT   ,1056,344, 132,43, 8,  8, 1 ,0xB8000 ,0x4000, 160, 449, 132,344, 0   },
++{ 0x055  ,M_TEXT   ,1056,400, 132,25, 8, 16, 1 ,0xB8000 ,0x2000, 160, 449, 132,400, 0   },
+ 
+ /* Alias of mode 101 */
+ { 0x069  ,M_LIN8   ,640 ,480 ,80 ,30 ,8 ,16 ,1 ,0xA0000 ,0x10000,100 ,525 ,80 ,480 ,0	},
+@@ -72,6 +71,14 @@
+ { 0x106  ,M_LIN4   ,1280,1024,160,64 ,8 ,16 ,1 ,0xA0000 ,0x10000,212 ,1066,160,1024,0	},
+ { 0x107  ,M_LIN8   ,1280,1024,160,64 ,8 ,16 ,1 ,0xA0000 ,0x10000,212 ,1066,160,1024,0	},
+ 
++/* VESA text modes */ 
++{ 0x108  ,M_TEXT   ,640 ,480,  80,60, 8,  8 ,2 ,0xB8000 ,0x4000, 100 ,525 ,80 ,480 ,0   },
++{ 0x109  ,M_TEXT   ,1056,400, 132,25, 8, 16, 1 ,0xB8000 ,0x2000, 160, 449, 132,400, 0   },
++{ 0x10A  ,M_TEXT   ,1056,688, 132,43, 8,  8, 1 ,0xB8000 ,0x4000, 160, 449, 132,344, 0   },
++{ 0x10B  ,M_TEXT   ,1056,400, 132,50, 8,  8, 1 ,0xB8000 ,0x4000, 160, 449, 132,400, 0   },
++{ 0x10C  ,M_TEXT   ,1056,480, 132,60, 8,  8, 2 ,0xB8000 ,0x4000, 160, 531, 132,480, 0   },
++
++/* VESA higher color modes */
+ { 0x10D  ,M_LIN15  ,320 ,200 ,40 ,25 ,8 ,8  ,1 ,0xA0000 ,0x10000,100 ,449 ,80 ,400 , _VGA_PIXEL_DOUBLE | _EGA_LINE_DOUBLE },
+ { 0x10E  ,M_LIN16  ,320 ,200 ,40 ,25 ,8 ,8  ,1 ,0xA0000 ,0x10000,100 ,449 ,80 ,400 , _VGA_PIXEL_DOUBLE | _EGA_LINE_DOUBLE },
+ { 0x10F  ,M_LIN32  ,320 ,200 ,40 ,25 ,8 ,8  ,1 ,0xA0000 ,0x10000,50  ,449 ,40 ,400 , _VGA_PIXEL_DOUBLE | _EGA_LINE_DOUBLE },
+@@ -81,10 +88,10 @@
+ { 0x113  ,M_LIN15  ,800 ,600 ,100,37 ,8 ,16 ,1 ,0xA0000 ,0x10000,264 ,628 ,200,600 ,0   },
+ { 0x114  ,M_LIN16  ,800 ,600 ,100,37 ,8 ,16 ,1 ,0xA0000 ,0x10000,264 ,628 ,200,600 ,0   },
+ { 0x115  ,M_LIN32  ,800 ,600 ,100,37 ,8 ,16 ,1 ,0xA0000 ,0x10000,132 ,628 ,100,600 ,0   },
+-
+ { 0x116  ,M_LIN15  ,1024,768 ,128,48 ,8 ,16 ,1 ,0xA0000 ,0x10000,336 ,806 ,256,768 ,0	},
+ { 0x117  ,M_LIN16  ,1024,768 ,128,48 ,8 ,16 ,1 ,0xA0000 ,0x10000,336 ,806 ,256,768 ,0	},
+ { 0x118  ,M_LIN32  ,1024,768 ,128,48 ,8 ,16 ,1 ,0xA0000 ,0x10000,168 ,806 ,128,768 ,0	},
++
+ /* those should be interlaced but ok */
+ //{ 0x119  ,M_LIN15  ,1280,1024,160,64 ,8 ,16 ,1 ,0xA0000 ,0x10000,424 ,1066,320,1024,0	},
+ //{ 0x11A  ,M_LIN16  ,1280,1024,160,64 ,8 ,16 ,1 ,0xA0000 ,0x10000,424 ,1066,320,1024,0	},
+@@ -246,6 +253,7 @@
+ { 0x008  ,M_TANDY16,160 ,200 ,20 ,25 ,8 ,8  ,8 ,0xB8000 ,0x2000 ,56  ,127 ,40 ,100 ,0   },
+ { 0x009  ,M_TANDY16,320 ,200 ,40 ,25 ,8 ,8  ,8 ,0xB8000 ,0x2000 ,113 ,63  ,80 ,50  ,0   },
+ { 0x00A  ,M_CGA4   ,640 ,200 ,80 ,25 ,8 ,8  ,8 ,0xB8000 ,0x2000 ,113 ,63  ,80 ,50  ,0   },
++//{ 0x00E  ,M_TANDY16,640 ,200 ,80 ,25 ,8 ,8  ,8 ,0xA0000 ,0x10000 ,113 ,256 ,80 ,200 ,0   },
+ {0xFFFF  ,M_ERROR  ,0   ,0   ,0  ,0  ,0 ,0  ,0 ,0x00000 ,0x0000 ,0   ,0   ,0  ,0   ,0 	},
+ };
+ 
+@@ -318,7 +326,7 @@
+ 	{0x15,0x15,0x15}, {0x15,0x15,0x3f}, {0x15,0x3f,0x15}, {0x15,0x3f,0x3f}, {0x3f,0x15,0x15}, {0x3f,0x15,0x3f}, {0x3f,0x3f,0x15}, {0x3f,0x3f,0x3f},
+ };
+ 
+-static Bit8u vga_palette[256][3]=
++static Bit8u vga_palette[248][3]=
+ {
+   {0x00,0x00,0x00},{0x00,0x00,0x2a},{0x00,0x2a,0x00},{0x00,0x2a,0x2a},{0x2a,0x00,0x00},{0x2a,0x00,0x2a},{0x2a,0x15,0x00},{0x2a,0x2a,0x2a},
+   {0x15,0x15,0x15},{0x15,0x15,0x3f},{0x15,0x3f,0x15},{0x15,0x3f,0x3f},{0x3f,0x15,0x15},{0x3f,0x15,0x3f},{0x3f,0x3f,0x15},{0x3f,0x3f,0x3f},
+@@ -353,8 +361,7 @@
+   {0x08,0x10,0x08},{0x08,0x10,0x0a},{0x08,0x10,0x0c},{0x08,0x10,0x0e},{0x08,0x10,0x10},{0x08,0x0e,0x10},{0x08,0x0c,0x10},{0x08,0x0a,0x10},
+   {0x0b,0x0b,0x10},{0x0c,0x0b,0x10},{0x0d,0x0b,0x10},{0x0f,0x0b,0x10},{0x10,0x0b,0x10},{0x10,0x0b,0x0f},{0x10,0x0b,0x0d},{0x10,0x0b,0x0c},
+   {0x10,0x0b,0x0b},{0x10,0x0c,0x0b},{0x10,0x0d,0x0b},{0x10,0x0f,0x0b},{0x10,0x10,0x0b},{0x0f,0x10,0x0b},{0x0d,0x10,0x0b},{0x0c,0x10,0x0b},
+-  {0x0b,0x10,0x0b},{0x0b,0x10,0x0c},{0x0b,0x10,0x0d},{0x0b,0x10,0x0f},{0x0b,0x10,0x10},{0x0b,0x0f,0x10},{0x0b,0x0d,0x10},{0x0b,0x0c,0x10},
+-  {0x00,0x00,0x00},{0x00,0x00,0x00},{0x00,0x00,0x00},{0x00,0x00,0x00},{0x00,0x00,0x00},{0x00,0x00,0x00},{0x00,0x00,0x00},{0x00,0x00,0x00}
++  {0x0b,0x10,0x0b},{0x0b,0x10,0x0c},{0x0b,0x10,0x0d},{0x0b,0x10,0x0f},{0x0b,0x10,0x10},{0x0b,0x0f,0x10},{0x0b,0x0d,0x10},{0x0b,0x0c,0x10}
+ };
+ VideoModeBlock * CurMode;
+ 
+@@ -397,7 +404,7 @@
+ 		case M_LIN15:
+ 		case M_LIN16:
+ 		case M_LIN32:
+-			/* Hack we just acess the memory directly */
++			/* Hack we just access the memory directly */
+ 			memset(vga.mem.linear,0,vga.vmemsize);
+ 			memset(vga.fastmem, 0, vga.vmemsize<<1);
+ 		}
+@@ -547,6 +554,11 @@
+ 		default:
+ 			IO_WriteB(0x3de,0x0);break;
+ 		}
++		// write palette
++		for(Bitu i = 0; i < 16; i++) {
++			IO_WriteB(0x3da,i+0x10);
++			IO_WriteB(0x3de,i);
++		}
+ 		//Clear extended mapping
+ 		IO_WriteB(0x3da,0x5);
+ 		IO_WriteB(0x3de,0x0);
+@@ -587,8 +599,9 @@
+ 
+ 		if (CurMode->mode == 0x6 || CurMode->mode==0xa) color_select=0x3f;
+ 		else color_select=0x30;
+-		IO_WriteB(0x3d9,color_select);
+ 		real_writeb(BIOSMEM_SEG,BIOSMEM_CURRENT_PAL,color_select);
++		INT10_SetColorSelect(1);
++		INT10_SetBackgroundBorder(0);
+ 		break;
+ 	}
+ 
+@@ -1032,6 +1045,8 @@
+ 		break;
+ 	case M_LIN4:
+ 	case M_EGA:
++		if (CurMode->mode == 0x0f)
++			gfx_data[0x7]=0x05;		// only planes 0 and 2 are used
+ 		gfx_data[0x6]|=0x05;		//graphics mode at 0xa000-affff
+ 		break;
+ 	case M_CGA4:
+@@ -1061,12 +1076,14 @@
+ 		att_data[0x10]=0x01;		//Color Graphics
+ 		switch (CurMode->mode) {
+ 		case 0x0f:
+-			att_data[0x10]|=0x0a;	//Monochrome
+-			att_data[0x01]=0x08;
+-			att_data[0x04]=0x18;
+-			att_data[0x05]=0x18;
+-			att_data[0x09]=0x08;
+-			att_data[0x0d]=0x18;
++			att_data[0x12]=0x05;	// planes 0 and 2 enabled
++			att_data[0x10]|=0x0a;	// monochrome and blinking
++	
++			att_data[0x01]=0x08; // low-intensity
++			att_data[0x04]=0x18; // blink-on case
++			att_data[0x05]=0x18; // high-intensity
++			att_data[0x09]=0x08; // low-intensity in blink-off case
++			att_data[0x0d]=0x18; // high-intensity in blink-off
+ 			break;
+ 		case 0x11:
+ 			for (i=1;i<16;i++) att_data[i]=0x3f;
+@@ -1211,7 +1228,10 @@
+ 		case M_LIN15:
+ 		case M_LIN16:
+ 		case M_LIN32:
+-			for (i=0;i<256;i++) {
++			// IBM and clones use 248 default colors in the palette for 256-color mode.
++			// The last 8 colors of the palette are only initialized to 0 at BIOS init.
++			// Palette index is left at 0xf8 as on most clones, IBM leaves it at 0x10.
++			for (i=0;i<248;i++) {
+ 				IO_Write(0x3c9,vga_palette[i][0]);
+ 				IO_Write(0x3c9,vga_palette[i][1]);
+ 				IO_Write(0x3c9,vga_palette[i][2]);
+diff -Nur dosbox-0.74/src/ints/int10_pal.cpp dosbox/src/ints/int10_pal.cpp
+--- dosbox-0.74/src/ints/int10_pal.cpp	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/ints/int10_pal.cpp	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -35,9 +35,44 @@
+ 
+ void INT10_SetSinglePaletteRegister(Bit8u reg,Bit8u val) {
+ 	switch (machine) {
+-	case TANDY_ARCH_CASE:
++	case MCH_PCJR:
++		reg&=0xf;
+ 		IO_Read(VGAREG_TDY_RESET);
+ 		WriteTandyACTL(reg+0x10,val);
++		IO_Write(0x3da,0x0); // palette back on
++		break;
++	case MCH_TANDY:
++		// TODO waits for vertical retrace
++		switch(vga.mode) {
++		case M_TANDY2:
++			if (reg >= 0x10) break;
++			else if (reg==1) reg = 0x1f;
++			else reg |= 0x10;
++			WriteTandyACTL(reg+0x10,val);
++			break;
++		case M_TANDY4: {
++			if (CurMode->mode!=0x0a) {
++				// Palette values are kept constand by the BIOS.
++				// The four colors are mapped to special palette values by hardware.
++				// 3D8/3D9 registers influence this mapping. We need to figure out
++				// which entry is used for the requested color.
++				if (reg > 3) break;
++				if (reg != 0) { // 0 is assumed to be at 0
++					Bit8u color_select=real_readb(BIOSMEM_SEG,BIOSMEM_CURRENT_PAL);
++					reg = reg*2+8; // Green Red Brown
++					if (color_select& 0x20) reg++; // Cyan Magenta White
++				}
++				WriteTandyACTL(reg+0x10,val);
++			} 
++			// 4-color high resolution mode 0x0a isn't handled specially
++			else WriteTandyACTL(reg+0x10,val);
++			break;
++		}
++		default:
++			WriteTandyACTL(reg+0x10,val);
++			break;
++		}
++		IO_Write(0x3da,0x0); // palette back on
+ 		break;
+ 	case EGAVGA_ARCH_CASE:
+ 		if (!IS_VGA_ARCH) reg&=0x1f;
+@@ -57,6 +92,7 @@
+ 	case TANDY_ARCH_CASE:
+ 		IO_Read(VGAREG_TDY_RESET);
+ 		WriteTandyACTL(0x02,val);
++		IO_Write(VGAREG_TDY_ADDRESS, 0); // enable the screen
+ 		break;
+ 	case EGAVGA_ARCH_CASE:
+ 		ResetACTL();
+@@ -96,25 +132,42 @@
+ }
+ 
+ void INT10_ToggleBlinkingBit(Bit8u state) {
+-	Bit8u value;
+-//	state&=0x01;
+-	if ((state>1) && (svgaCard==SVGA_S3Trio)) return;
+-	ResetACTL();
+-	
+-	IO_Write(VGAREG_ACTL_ADDRESS,0x10);
+-	value=IO_Read(VGAREG_ACTL_READ_DATA);
+-	if (state<=1) {
+-		value&=0xf7;
+-		value|=state<<3;
+-	}
++	if(IS_VGA_ARCH) {
++		Bit8u value;
++	//	state&=0x01;
++		if ((state>1) && (svgaCard==SVGA_S3Trio)) return;
++		ResetACTL();
++		
++		IO_Write(VGAREG_ACTL_ADDRESS,0x10);
++		value=IO_Read(VGAREG_ACTL_READ_DATA);
++		if (state<=1) {
++			value&=0xf7;
++			value|=state<<3;
++		}
+ 
+-	ResetACTL();
+-	IO_Write(VGAREG_ACTL_ADDRESS,0x10);
+-	IO_Write(VGAREG_ACTL_WRITE_DATA,value);
+-	IO_Write(VGAREG_ACTL_ADDRESS,32);		//Enable output and protect palette
++		ResetACTL();
++		IO_Write(VGAREG_ACTL_ADDRESS,0x10);
++		IO_Write(VGAREG_ACTL_WRITE_DATA,value);
++		IO_Write(VGAREG_ACTL_ADDRESS,32);		//Enable output and protect palette
+ 
+-	if (state<=1) {
+-		Bit8u msrval=real_readb(BIOSMEM_SEG,BIOSMEM_CURRENT_MSR)&0xdf;
++		if (state<=1) {
++			Bit8u msrval=real_readb(BIOSMEM_SEG,BIOSMEM_CURRENT_MSR)&0xdf;
++			if (state) msrval|=0x20;
++			real_writeb(BIOSMEM_SEG,BIOSMEM_CURRENT_MSR,msrval);
++		}
++	} else { // EGA
++		// Usually it reads this from the mode list in ROM
++		if (CurMode->type!=M_TEXT) return;
++
++		Bit8u value = (CurMode->cwidth==9)? 0x4:0x0;
++		if (state) value |= 0x8;
++		
++		ResetACTL();
++		IO_Write(VGAREG_ACTL_ADDRESS,0x10);
++		IO_Write(VGAREG_ACTL_WRITE_DATA,value);
++		IO_Write(VGAREG_ACTL_ADDRESS,0x20);
++
++		Bit8u msrval=real_readb(BIOSMEM_SEG,BIOSMEM_CURRENT_MSR)& ~0x20;
+ 		if (state) msrval|=0x20;
+ 		real_writeb(BIOSMEM_SEG,BIOSMEM_CURRENT_MSR,msrval);
+ 	}
+@@ -151,14 +204,23 @@
+ 	ResetACTL();
+ }
+ 
+-void INT10_SetSingleDacRegister(Bit8u index,Bit8u red,Bit8u green,Bit8u blue) {
++void INT10_SetSingleDACRegister(Bit8u index,Bit8u red,Bit8u green,Bit8u blue) {
+ 	IO_Write(VGAREG_DAC_WRITE_ADDRESS,(Bit8u)index);
+-	IO_Write(VGAREG_DAC_DATA,red);
+-	IO_Write(VGAREG_DAC_DATA,green);
+-	IO_Write(VGAREG_DAC_DATA,blue);
++	if ((real_readb(BIOSMEM_SEG,BIOSMEM_MODESET_CTL)&0x06)==0) {
++		IO_Write(VGAREG_DAC_DATA,red);
++		IO_Write(VGAREG_DAC_DATA,green);
++		IO_Write(VGAREG_DAC_DATA,blue);
++	} else {
++		/* calculate clamped intensity, taken from VGABIOS */
++		Bit32u i=(( 77*red + 151*green + 28*blue ) + 0x80) >> 8;
++		Bit8u ic=(i>0x3f) ? 0x3f : ((Bit8u)(i & 0xff));
++		IO_Write(VGAREG_DAC_DATA,ic);
++		IO_Write(VGAREG_DAC_DATA,ic);
++		IO_Write(VGAREG_DAC_DATA,ic);
++	}
+ }
+ 
+-void INT10_GetSingleDacRegister(Bit8u index,Bit8u * red,Bit8u * green,Bit8u * blue) {
++void INT10_GetSingleDACRegister(Bit8u index,Bit8u * red,Bit8u * green,Bit8u * blue) {
+ 	IO_Write(VGAREG_DAC_READ_ADDRESS,index);
+ 	*red=IO_Read(VGAREG_DAC_DATA);
+ 	*green=IO_Read(VGAREG_DAC_DATA);
+@@ -167,10 +229,25 @@
+ 
+ void INT10_SetDACBlock(Bit16u index,Bit16u count,PhysPt data) {
+  	IO_Write(VGAREG_DAC_WRITE_ADDRESS,(Bit8u)index);
+-	for (;count>0;count--) {
+-		IO_Write(VGAREG_DAC_DATA,mem_readb(data++));
+-		IO_Write(VGAREG_DAC_DATA,mem_readb(data++));
+-		IO_Write(VGAREG_DAC_DATA,mem_readb(data++));
++	if ((real_readb(BIOSMEM_SEG,BIOSMEM_MODESET_CTL)&0x06)==0) {
++		for (;count>0;count--) {
++			IO_Write(VGAREG_DAC_DATA,mem_readb(data++));
++			IO_Write(VGAREG_DAC_DATA,mem_readb(data++));
++			IO_Write(VGAREG_DAC_DATA,mem_readb(data++));
++		}
++	} else {
++		for (;count>0;count--) {
++			Bit8u red=mem_readb(data++);
++			Bit8u green=mem_readb(data++);
++			Bit8u blue=mem_readb(data++);
++
++			/* calculate clamped intensity, taken from VGABIOS */
++			Bit32u i=(( 77*red + 151*green + 28*blue ) + 0x80) >> 8;
++			Bit8u ic=(i>0x3f) ? 0x3f : ((Bit8u)(i & 0xff));
++			IO_Write(VGAREG_DAC_DATA,ic);
++			IO_Write(VGAREG_DAC_DATA,ic);
++			IO_Write(VGAREG_DAC_DATA,ic);
++		}
+ 	}
+ }
+ 
+@@ -225,28 +302,67 @@
+ 
+ void INT10_GetPelMask(Bit8u & mask) {
+ 	mask=IO_Read(VGAREG_PEL_MASK);
+-}	
++}
+ 
+ void INT10_SetBackgroundBorder(Bit8u val) {
+-	Bit8u temp=real_readb(BIOSMEM_SEG,BIOSMEM_CURRENT_PAL);
+-	temp=(temp & 0xe0) | (val & 0x1f);
+-	real_writeb(BIOSMEM_SEG,BIOSMEM_CURRENT_PAL,temp);
+-	if (machine == MCH_CGA || IS_TANDY_ARCH)
+-		IO_Write(0x3d9,temp);
+-	else if (IS_EGAVGA_ARCH) {
++	Bit8u color_select=real_readb(BIOSMEM_SEG,BIOSMEM_CURRENT_PAL);
++	color_select=(color_select & 0xe0) | (val & 0x1f);
++	real_writeb(BIOSMEM_SEG,BIOSMEM_CURRENT_PAL,color_select);
++	
++	switch (machine) {
++	case MCH_CGA:
++		// only write the color select register
++		IO_Write(0x3d9,color_select);
++		break;
++	case MCH_TANDY:
++		// TODO handle val == 0x1x, wait for retrace
++		switch(CurMode->mode) {
++		default: // modes 0-5: write to color select and border
++			INT10_SetOverscanBorderColor(val);
++			IO_Write(0x3d9, color_select);
++			break;
++		case 0x06: // 2-color: only write the color select register
++			IO_Write(0x3d9, color_select);
++			break;
++		case 0x07: // Tandy monochrome not implemented
++			break; 
++		case 0x08:
++		case 0x09: // 16-color: write to color select, border and pal. index 0
++			INT10_SetOverscanBorderColor(val);
++			INT10_SetSinglePaletteRegister(0, val);
++			IO_Write(0x3d9, color_select);
++			break;
++		case 0x0a: // 4-color highres:
++			// write zero to color select, write palette to indexes 1-3
++			// TODO palette
++			IO_Write(0x3d9, 0);
++			break;
++		}
++		break;
++	case MCH_PCJR:
++		IO_Read(VGAREG_TDY_RESET); // reset the flipflop
++		if (vga.mode!=M_TANDY_TEXT) {
++			IO_Write(VGAREG_TDY_ADDRESS, 0x10);
++			IO_Write(VGAREG_PCJR_DATA, color_select&0xf);
++		}
++		IO_Write(VGAREG_TDY_ADDRESS, 0x2); // border color
++		IO_Write(VGAREG_PCJR_DATA, color_select&0xf);
++		break;
++	case EGAVGA_ARCH_CASE:
+ 		val = ((val << 1) & 0x10) | (val & 0x7);
+-		/* Aways set the overscan color */
++		/* Always set the overscan color */
+ 		INT10_SetSinglePaletteRegister( 0x11, val );
+ 		/* Don't set any extra colors when in text mode */
+ 		if (CurMode->mode <= 3)
+ 			return;
+ 		INT10_SetSinglePaletteRegister( 0, val );
+-		val = (temp & 0x10) | 2 | ((temp & 0x20) >> 5);
++		val = (color_select & 0x10) | 2 | ((color_select & 0x20) >> 5);
+ 		INT10_SetSinglePaletteRegister( 1, val );
+ 		val+=2;
+ 		INT10_SetSinglePaletteRegister( 2, val );
+ 		val+=2;
+ 		INT10_SetSinglePaletteRegister( 3, val );
++		break;
+ 	}
+ }
+ 
+@@ -254,8 +370,32 @@
+ 	Bit8u temp=real_readb(BIOSMEM_SEG,BIOSMEM_CURRENT_PAL);
+ 	temp=(temp & 0xdf) | ((val & 1) ? 0x20 : 0x0);
+ 	real_writeb(BIOSMEM_SEG,BIOSMEM_CURRENT_PAL,temp);
+-	if (machine == MCH_CGA || IS_TANDY_ARCH)
++	if (machine == MCH_CGA || machine==MCH_TANDY)
+ 		IO_Write(0x3d9,temp);
++	else if (machine == MCH_PCJR) {
++		IO_Read(VGAREG_TDY_RESET); // reset the flipflop
++		switch(vga.mode) {
++		case M_TANDY2:
++			IO_Write(VGAREG_TDY_ADDRESS, 0x11);
++			IO_Write(VGAREG_PCJR_DATA, val&1? 0xf:0);
++			break;
++		case M_TANDY4:
++			for(Bit8u i = 0x11; i < 0x14; i++) {
++				const Bit8u t4_table[] = {0,2,4,6, 0,3,5,0xf};
++				IO_Write(VGAREG_TDY_ADDRESS, i);
++				IO_Write(VGAREG_PCJR_DATA, t4_table[(i-0x10)+(val&1? 4:0)]);
++			}
++			break;
++		default:
++			// 16-color modes: always write the same palette
++			for(Bit8u i = 0x11; i < 0x20; i++) {
++				IO_Write(VGAREG_TDY_ADDRESS, i);
++				IO_Write(VGAREG_PCJR_DATA, i-0x10);
++			}
++			break;
++		}
++		IO_Write(VGAREG_TDY_ADDRESS, 0); // enable palette
++	}
+ 	else if (IS_EGAVGA_ARCH) {
+ 		if (CurMode->mode <= 3) //Maybe even skip the total function!
+ 			return;
+@@ -279,6 +419,6 @@
+ 		/* calculate clamped intensity, taken from VGABIOS */
+ 		Bit32u i=(( 77*red + 151*green + 28*blue ) + 0x80) >> 8;
+ 		Bit8u ic=(i>0x3f) ? 0x3f : ((Bit8u)(i & 0xff));
+-		INT10_SetSingleDacRegister(start_reg+ct,ic,ic,ic);
++		INT10_SetSingleDACRegister(start_reg+ct,ic,ic,ic);
+ 	}
+ }
+diff -Nur dosbox-0.74/src/ints/int10_put_pixel.cpp dosbox/src/ints/int10_put_pixel.cpp
+--- dosbox-0.74/src/ints/int10_put_pixel.cpp	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/ints/int10_put_pixel.cpp	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,7 +16,6 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: int10_put_pixel.cpp,v 1.23 2009-05-27 09:15:42 qbix79 Exp $ */
+ 
+ #include "dosbox.h"
+ #include "mem.h"
+@@ -31,34 +30,44 @@
+ 
+ 	switch (CurMode->type) {
+ 	case M_CGA4:
+-		{
+-				if (real_readb(BIOSMEM_SEG,BIOSMEM_CURRENT_MODE)<=5) {
+-					Bit16u off=(y>>1)*80+(x>>2);
+-					if (y&1) off+=8*1024;
+-
+-					Bit8u old=real_readb(0xb800,off);
+-					if (color & 0x80) {
+-						color&=3;
+-						old^=color << (2*(3-(x&3)));
+-					} else {
+-						old=(old&cga_masks[x&3])|((color&3) << (2*(3-(x&3))));
+-					}
+-					real_writeb(0xb800,off,old);
+-				} else {
+-					Bit16u off=(y>>2)*160+((x>>2)&(~1));
+-					off+=(8*1024) * (y & 3);
++	{
++		if (real_readb(BIOSMEM_SEG,BIOSMEM_CURRENT_MODE)<=5) {
++			// this is a 16k mode
++			Bit16u off=(y>>1)*80+(x>>2);
++			if (y&1) off+=8*1024;
+ 
+-					Bit16u old=real_readw(0xb800,off);
+-					if (color & 0x80) {
+-						old^=(color&1) << (7-(x&7));
+-						old^=((color&2)>>1) << ((7-(x&7))+8);
+-					} else {
+-						old=(old&(~(0x101<<(7-(x&7))))) | ((color&1) << (7-(x&7))) | (((color&2)>>1) << ((7-(x&7))+8));
+-					}
+-					real_writew(0xb800,off,old);
+-				}
++			Bit8u old=real_readb(0xb800,off);
++			if (color & 0x80) {
++				color&=3;
++				old^=color << (2*(3-(x&3)));
++			} else {
++				old=(old&cga_masks[x&3])|((color&3) << (2*(3-(x&3))));
++			}
++			real_writeb(0xb800,off,old);
++		} else {
++			// a 32k mode: PCJr special case (see M_TANDY16)
++			Bit16u seg;
++			if (machine==MCH_PCJR) {
++				Bitu cpupage =
++					(real_readb(BIOSMEM_SEG, BIOSMEM_CRTCPU_PAGE) >> 3) & 0x7;
++				seg = cpupage << 10; // A14-16 to addr bits 14-16
++			} else
++				seg = 0xb800;
++
++			Bit16u off=(y>>2)*160+((x>>2)&(~1));
++			off+=(8*1024) * (y & 3);
++
++			Bit16u old=real_readw(seg,off);
++			if (color & 0x80) {
++				old^=(color&1) << (7-(x&7));
++				old^=((color&2)>>1) << ((7-(x&7))+8);
++			} else {
++				old=(old&(~(0x101<<(7-(x&7))))) | ((color&1) << (7-(x&7))) | (((color&2)>>1) << ((7-(x&7))+8));
++			}
++			real_writew(seg,off,old);
+ 		}
+-		break;
++	}
++	break;
+ 	case M_CGA2:
+ 		{
+ 				Bit16u off=(y>>1)*80+(x>>3);
+@@ -74,26 +83,50 @@
+ 		}
+ 		break;
+ 	case M_TANDY16:
+-		{
+-			IO_Write(0x3d4,0x09);
+-			Bit8u scanlines_m1=IO_Read(0x3d5);
+-			Bit16u off=(y>>((scanlines_m1==1)?1:2))*(CurMode->swidth>>1)+(x>>1);
+-			off+=(8*1024) * (y & scanlines_m1);
+-			Bit8u old=real_readb(0xb800,off);
+-			Bit8u p[2];
+-			p[1] = (old >> 4) & 0xf;
+-			p[0] = old & 0xf;
+-			Bitu ind = 1-(x & 0x1);
++	{
++		// find out if we are in a 32k mode (0x9 or 0xa)
++		// This requires special handling on the PCJR
++		// because only 16k are mapped at 0xB800
++		bool is_32k = (real_readb(BIOSMEM_SEG, BIOSMEM_CURRENT_MODE) >= 9)?
++			true:false;
++
++		Bit16u segment, offset;
++		if (is_32k) {
++			if (machine==MCH_PCJR) {
++				Bitu cpupage =
++					(real_readb(BIOSMEM_SEG, BIOSMEM_CRTCPU_PAGE) >> 3) & 0x7;
++				segment = cpupage << 10; // A14-16 to addr bits 14-16
++			} else
++				segment = 0xb800;
++			// bits 1 and 0 of y select the bank
++			// two pixels per byte (thus x>>1)
++			offset = (y >> 2) * (CurMode->swidth >> 1) + (x>>1);
++			// select the scanline bank
++			offset += (8*1024) * (y & 3);
++		} else {
++			segment = 0xb800;
++			// bit 0 of y selects the bank
++			offset = (y >> 1) * (CurMode->swidth >> 1) + (x>>1);
++			offset += (8*1024) * (y & 1);
++		}
+ 
+-			if (color & 0x80) {
+-	 			p[ind]^=(color & 0x7f);
+-			} else {
+-				p[ind]=color;
+-			}
+-			old = (p[1] << 4) | p[0];
+-			real_writeb(0xb800,off,old);
++		// update the pixel
++		Bit8u old=real_readb(segment, offset);
++		Bit8u p[2];
++		p[1] = (old >> 4) & 0xf;
++		p[0] = old & 0xf;
++		Bitu ind = 1-(x & 0x1);
++
++		if (color & 0x80) {
++			// color is to be XORed
++	 		p[ind]^=(color & 0x7f);
++		} else {
++			p[ind]=color;
+ 		}
+-		break;
++		old = (p[1] << 4) | p[0];
++		real_writeb(segment,offset, old);
++	}
++	break;
+ 	case M_LIN4:
+ 		if ((machine!=MCH_VGA) || (svgaCard!=SVGA_TsengET4K) ||
+ 				(CurMode->swidth>800)) {
+diff -Nur dosbox-0.74/src/ints/int10_vesa.cpp dosbox/src/ints/int10_vesa.cpp
+--- dosbox-0.74/src/ints/int10_vesa.cpp	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/ints/int10_vesa.cpp	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,7 +16,6 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: int10_vesa.cpp,v 1.40 2009-07-31 15:36:01 c2woody Exp $ */
+ 
+ #include <string.h>
+ #include <stddef.h>
+@@ -29,6 +28,13 @@
+ #include "int10.h"
+ #include "dos_inc.h"
+ 
++#define VESA_SUCCESS          0x00
++#define VESA_FAIL             0x01
++#define VESA_HW_UNSUPPORTED   0x02
++#define VESA_MODE_UNSUPPORTED 0x03
++// internal definition to pass to the caller
++#define VESA_UNIMPLEMENTED    0xFF
++
+ static struct {
+ 	Bitu setwindow;
+ 	Bitu pmStart;
+@@ -117,7 +123,7 @@
+ 	mem_writed(buffer+0x0a,0x0);					//Capabilities and flags
+ 	mem_writed(buffer+0x0e,int10.rom.vesa_modes);	//VESA Mode list
+ 	mem_writew(buffer+0x12,(Bit16u)(vga.vmemsize/(64*1024))); // memory size in 64kb blocks
+-	return 0x00;
++	return VESA_SUCCESS;
+ }
+ 
+ Bit8u VESA_GetSVGAModeInformation(Bit16u mode,Bit16u seg,Bit16u off) {
+@@ -136,14 +142,13 @@
+ 	while (ModeList_VGA[i].mode!=0xffff) {
+ 		if (mode==ModeList_VGA[i].mode) goto foundit; else i++;
+ 	}
+-	return 0x01;
++	return VESA_FAIL;
+ foundit:
+ 	if ((int10.vesa_oldvbe) && (ModeList_VGA[i].mode>=0x120)) return 0x01;
+ 	VideoModeBlock * mblock=&ModeList_VGA[i];
+ 	switch (mblock->type) {
+ 	case M_LIN4:
+ 		pageSize = mblock->sheight * mblock->swidth/2;
+-		pageSize = (pageSize | 15) & ~ 15;
+ 		var_write(&minfo.BytesPerScanLine,mblock->swidth/8);
+ 		var_write(&minfo.NumberOfPlanes,0x4);
+ 		var_write(&minfo.BitsPerPixel,4);
+@@ -152,7 +157,6 @@
+ 		break;
+ 	case M_LIN8:
+ 		pageSize = mblock->sheight * mblock->swidth;
+-		pageSize = (pageSize | 15) & ~ 15;
+ 		var_write(&minfo.BytesPerScanLine,mblock->swidth);
+ 		var_write(&minfo.NumberOfPlanes,0x1);
+ 		var_write(&minfo.BitsPerPixel,8);
+@@ -162,7 +166,6 @@
+ 		break;
+ 	case M_LIN15:
+ 		pageSize = mblock->sheight * mblock->swidth*2;
+-		pageSize = (pageSize | 15) & ~ 15;
+ 		var_write(&minfo.BytesPerScanLine,mblock->swidth*2);
+ 		var_write(&minfo.NumberOfPlanes,0x1);
+ 		var_write(&minfo.BitsPerPixel,15);
+@@ -180,7 +183,6 @@
+ 		break;
+ 	case M_LIN16:
+ 		pageSize = mblock->sheight * mblock->swidth*2;
+-		pageSize = (pageSize | 15) & ~ 15;
+ 		var_write(&minfo.BytesPerScanLine,mblock->swidth*2);
+ 		var_write(&minfo.NumberOfPlanes,0x1);
+ 		var_write(&minfo.BitsPerPixel,16);
+@@ -196,7 +198,6 @@
+ 		break;
+ 	case M_LIN32:
+ 		pageSize = mblock->sheight * mblock->swidth*4;
+-		pageSize = (pageSize | 15) & ~ 15;
+ 		var_write(&minfo.BytesPerScanLine,mblock->swidth*4);
+ 		var_write(&minfo.NumberOfPlanes,0x1);
+ 		var_write(&minfo.BitsPerPixel,32);
+@@ -212,36 +213,40 @@
+ 		modeAttributes = 0x1b;	// Color, graphics
+ 		if (!int10.vesa_nolfb) modeAttributes |= 0x80;	// linear framebuffer
+ 		break;
+-/*	case M_TEXT:
+-		pageSize = mblock->sheight/8 * mblock->swidth*2/8;
+-		pageSize = (pageSize | 15) & ~ 15;
+-		var_write(&minfo.BytesPerScanLine,mblock->swidth*2/8);
++	case M_TEXT:
++		pageSize = 0;
++		var_write(&minfo.BytesPerScanLine, mblock->twidth * 2);
+ 		var_write(&minfo.NumberOfPlanes,0x4);
+ 		var_write(&minfo.BitsPerPixel,4);
+-		var_write(&minfo.MemoryModel,0);	//Text
++		var_write(&minfo.MemoryModel,0);	// text
+ 		modeAttributes = 0x0f;	//Color, text, bios output
+-		break; */
++		break;
+ 	default:
+-		return 0x1;
+-	}
+-	var_write(&minfo.WinAAttributes,0x7);	// Exists/readable/writable
+-	
+-	if(pageSize > vga.vmemsize) {
+-		// Mode not supported by current hardware configuration
+-		var_write(&minfo.ModeAttributes, modeAttributes & ~0x1);
+-		var_write(&minfo.NumberOfImagePages,0);
+-	} else {
+-		var_write(&minfo.ModeAttributes, modeAttributes);
+-		Bitu pages = (vga.vmemsize / pageSize)-1;
+-		var_write(&minfo.NumberOfImagePages,pages);
++		return VESA_FAIL;
+ 	}
++	if (pageSize & 0xFFFF) {
++		// It is documented that many applications assume 64k-aligned page sizes
++		// VBETEST is one of them
++		pageSize += 0x10000;
++		pageSize &= ~0xFFFF;
++	}
++	Bitu pages = 0;
++	if (pageSize > vga.vmemsize) {
++		// mode not supported by current hardware configuration
++		modeAttributes &= ~0x1;
++	} else if (pageSize) {
++		pages = (vga.vmemsize / pageSize)-1;
++	}
++	var_write(&minfo.NumberOfImagePages, pages);
++	var_write(&minfo.ModeAttributes, modeAttributes);
++	var_write(&minfo.WinAAttributes, 0x7);	// Exists/readable/writable
+ 
+ 	if (mblock->type==M_TEXT) {
+ 		var_write(&minfo.WinGranularity,32);
+ 		var_write(&minfo.WinSize,32);
+ 		var_write(&minfo.WinASegment,0xb800);
+-		var_write(&minfo.XResolution,mblock->swidth/8);
+-		var_write(&minfo.YResolution,mblock->sheight/8);
++		var_write(&minfo.XResolution,mblock->twidth);
++		var_write(&minfo.YResolution,mblock->theight);
+ 	} else {
+ 		var_write(&minfo.WinGranularity,64);
+ 		var_write(&minfo.WinSize,64);
+@@ -257,46 +262,46 @@
+ 	if (!int10.vesa_nolfb) var_write(&minfo.PhysBasePtr,S3_LFB_BASE);
+ 
+ 	MEM_BlockWrite(buf,&minfo,sizeof(MODE_INFO));
+-	return 0x00;
++	return VESA_SUCCESS;
+ }
+ 
+ 
+ Bit8u VESA_SetSVGAMode(Bit16u mode) {
+ 	if (INT10_SetVideoMode(mode)) {
+ 		int10.vesa_setmode=mode&0x7fff;
+-		return 0x00;
++		return VESA_SUCCESS;
+ 	}
+-	return 0x01;
++	return VESA_FAIL;
+ }
+ 
+ Bit8u VESA_GetSVGAMode(Bit16u & mode) {
+ 	if (int10.vesa_setmode!=0xffff) mode=int10.vesa_setmode;
+ 	else mode=CurMode->mode;
+-	return 0x00;
++	return VESA_SUCCESS;
+ }
+ 
+ Bit8u VESA_SetCPUWindow(Bit8u window,Bit8u address) {
+-	if (window) return 0x1;
++	if (window) return VESA_FAIL;
+ 	if (((Bit32u)(address)*64*1024<vga.vmemsize)) {
+ 		IO_Write(0x3d4,0x6a);
+ 		IO_Write(0x3d5,(Bit8u)address);
+-		return 0x0;
+-	} else return 0x1;
++		return VESA_SUCCESS;
++	} else return VESA_FAIL;
+ }
+ 
+ Bit8u VESA_GetCPUWindow(Bit8u window,Bit16u & address) {
+-	if (window) return 0x1;
++	if (window) return VESA_FAIL;
+ 	IO_Write(0x3d4,0x6a);
+ 	address=IO_Read(0x3d5);
+-	return 0x0;
++	return VESA_SUCCESS;
+ }
+ 
+ 
+ Bit8u VESA_SetPalette(PhysPt data,Bitu index,Bitu count) {
+ //Structure is (vesa 3.0 doc): blue,green,red,alignment
+ 	Bit8u r,g,b;
+-	if (index>255) return 0x1;
+-	if (index+count>256) return 0x1;
++	if (index>255) return VESA_FAIL;
++	if (index+count>256) return VESA_FAIL;
+ 	IO_Write(0x3c8,(Bit8u)index);
+ 	while (count) {
+ 		b = mem_readb(data++);
+@@ -308,14 +313,14 @@
+ 		IO_Write(0x3c9,b);
+ 		count--;
+ 	}
+-	return 0x00;
++	return VESA_SUCCESS;
+ }
+ 
+ 
+ Bit8u VESA_GetPalette(PhysPt data,Bitu index,Bitu count) {
+ 	Bit8u r,g,b;
+-	if (index>255) return 0x1;
+-	if (index+count>256) return 0x1;
++	if (index>255) return VESA_FAIL;
++	if (index+count>256) return VESA_FAIL;
+ 	IO_Write(0x3c7,(Bit8u)index);
+ 	while (count) {
+ 		r = IO_Read(0x3c9);
+@@ -327,114 +332,182 @@
+ 		data++;
+ 		count--;
+ 	}
+-	return 0x00;
++	return VESA_SUCCESS;
+ }
+ 
++// maximum offset for the S3 Trio64 is 10 bits
++#define S3_MAX_OFFSET 0x3ff
+ 
+ Bit8u VESA_ScanLineLength(Bit8u subcall,Bit16u val, Bit16u & bytes,Bit16u & pixels,Bit16u & lines) {
+-	Bit8u bpp;
++	// offset register: virtual scanline length
++	Bitu pixels_per_offset;
++	Bitu bytes_per_offset = 8;
++	Bitu vmemsize = vga.vmemsize;
++	Bitu new_offset = vga.config.scan_len;
++	Bitu screen_height = CurMode->sheight;
++
+ 	switch (CurMode->type) {
++	case M_TEXT:
++		vmemsize = 0x8000;      // we have only the 32kB window here
++		screen_height = CurMode->theight;
++		pixels_per_offset = 16; // two characters each 8 pixels wide
++		bytes_per_offset = 4;   // 2 characters + 2 attributes
++		break;
+ 	case M_LIN4:
+-		bpp = 1;
++		pixels_per_offset = 16;
+ 		break;
+ 	case M_LIN8:
+-		bpp=1;
++		pixels_per_offset = 8;
+ 		break;
+ 	case M_LIN15:
+ 	case M_LIN16:
+-		bpp=2;
++		pixels_per_offset = 4;
+ 		break;
+ 	case M_LIN32:
+-		bpp=4;
++		pixels_per_offset = 2;
+ 		break;
+ 	default:
+-		return 0x1;
++		return VESA_MODE_UNSUPPORTED;
+ 	}
+ 	switch (subcall) {
+-	case 0x00:	/* Set in pixels */
+-		if(CurMode->type==M_LIN4) vga.config.scan_len=val/2;
+-		else vga.config.scan_len = (val * bpp);
+-		break;
+-	case 0x02:	/* Set in bytes */
+-		if(CurMode->type==M_LIN4) vga.config.scan_len = val*4;
+-		else vga.config.scan_len = val;
+-		break;
+-	case 0x03:	/* Get maximum */
+-		bytes=0x400*4;
+-		pixels=bytes/bpp;
+-		lines = (Bit16u)(vga.vmemsize / bytes);
+-		return 0x00;
+-	case 0x01:	/* Get lengths */
++	case 0x00: // set scan length in pixels
++		new_offset = val / pixels_per_offset;
++		if (val % pixels_per_offset) new_offset++;
++		
++		if (new_offset > S3_MAX_OFFSET)
++			return VESA_HW_UNSUPPORTED; // scanline too long
++		vga.config.scan_len = new_offset;
++		VGA_CheckScanLength();
++		break;
++
++	case 0x01: // get current scanline length
++		// implemented at the end of this function
++		break;
++
++	case 0x02: // set scan length in bytes
++		new_offset = val / bytes_per_offset;
++		if (val % bytes_per_offset) new_offset++;
++		
++		if (new_offset > S3_MAX_OFFSET)
++			return VESA_HW_UNSUPPORTED; // scanline too long
++		vga.config.scan_len = new_offset;
++		VGA_CheckScanLength();
++		break;
++
++	case 0x03: // get maximum scan line length
++		// the smaller of either the hardware maximum scanline length or
++		// the limit to get full y resolution of this mode
++		new_offset = S3_MAX_OFFSET;
++		if ((new_offset * bytes_per_offset * screen_height) > vmemsize)
++			new_offset = vmemsize / (bytes_per_offset * screen_height);
+ 		break;
++
+ 	default:
+-		return 0x1;			//Illegal call
++		return VESA_UNIMPLEMENTED;
+ 	}
+-	if (subcall!=0x01) {
+-		/* Write the scan line to video card the simple way */
+-		if (vga.config.scan_len & 7)
+-			vga.config.scan_len += 8;
+-		vga.config.scan_len /= 8;
+-	}
+-	if(CurMode->type==M_LIN4) {
+-		pixels=(vga.config.scan_len*16)/bpp;
+-		bytes=vga.config.scan_len*2;
+-		lines = (Bit16u)(vga.vmemsize /( bytes*4));
+-	}
+-	else {
+-		pixels=(vga.config.scan_len*8)/bpp;
+-		bytes=vga.config.scan_len*8;
+-		lines = (Bit16u)(vga.vmemsize / bytes);
+-	}
+-	VGA_StartResize();
+-	return 0x0;
++
++	// set up the return values
++	bytes = (Bit16u)(new_offset * bytes_per_offset);
++	pixels = (Bit16u)(new_offset * pixels_per_offset);
++	if (!bytes)
++		// return failure on division by zero
++		// some real VESA BIOS implementations may crash here
++		return VESA_FAIL;
++
++	lines = (Bit16u)(vmemsize / bytes);
++	
++	if (CurMode->type==M_TEXT)
++		lines *= CurMode->cheight;
++
++	return VESA_SUCCESS;
+ }
+ 
+ Bit8u VESA_SetDisplayStart(Bit16u x,Bit16u y) {
+-	//TODO Maybe do things differently with lowres double line modes?	
+-	Bitu start;
++	// TODO wait for retrace in case bl==0x80
++	Bitu pixels_per_offset;
++	Bitu panning_factor = 1;
++
+ 	switch (CurMode->type) {
++	case M_TEXT:
+ 	case M_LIN4:
+-		start=vga.config.scan_len*16*y+x;
+-		vga.config.display_start=start/8;
+-		IO_Read(0x3da);
+-		IO_Write(0x3c0,0x13+32);
+-		IO_Write(0x3c0,start % 8);
++		pixels_per_offset = 16;
+ 		break;
+ 	case M_LIN8:
+-		start=vga.config.scan_len*8*y+x;
+-		vga.config.display_start=start/4;
+-		IO_Read(0x3da);
+-		IO_Write(0x3c0,0x13+32);
+-		IO_Write(0x3c0,(start % 4)*2);
++		panning_factor = 2; // the panning register ignores bit0 in this mode
++		pixels_per_offset = 8;
+ 		break;
+-	case M_LIN16:
+ 	case M_LIN15:
+-		start=vga.config.scan_len*8*y+x*2;
+-		vga.config.display_start=start/4;
++	case M_LIN16:
++		panning_factor = 2; // this may be DOSBox specific
++		pixels_per_offset = 4;
+ 		break;
+ 	case M_LIN32:
+-		start=vga.config.scan_len*8*y+x*4;
+-		vga.config.display_start=start/4;
++		pixels_per_offset = 2;
+ 		break;
+ 	default:
+-		return 0x1;
++		return VESA_MODE_UNSUPPORTED;
+ 	}
+-	return 0x00;
++	// We would have to divide y by the character height for text modes and
++	// write the remainder to the CRTC preset row scan register,
++	// but VBE2 BIOSes that actually get that far also don't.
++	// Only a VBE3 BIOS got it right.
++	Bitu virtual_screen_width = vga.config.scan_len * pixels_per_offset;
++	Bitu new_start_pixel = virtual_screen_width * y + x;
++	Bitu new_crtc_start = new_start_pixel / (pixels_per_offset/2);
++	Bitu new_panning = new_start_pixel % (pixels_per_offset/2);
++	new_panning *= panning_factor;
++
++	vga.config.display_start = new_crtc_start;
++	
++	// Setting the panning register is nice as it allows for super smooth
++	// scrolling, but if we hit the retrace pulse there may be flicker as
++	// panning and display start are latched at different times. 
++
++	IO_Read(0x3da);              // reset attribute flipflop
++	IO_Write(0x3c0,0x13 | 0x20); // panning register, screen on
++	IO_Write(0x3c0,new_panning);
++
++	return VESA_SUCCESS;
+ }
+ 
+ Bit8u VESA_GetDisplayStart(Bit16u & x,Bit16u & y) {
+-	Bitu times=(vga.config.display_start*4)/(vga.config.scan_len*8);
+-	Bitu rem=(vga.config.display_start*4) % (vga.config.scan_len*8);
+-	Bitu pan=vga.config.pel_panning;
++	Bitu pixels_per_offset;
++	Bitu panning_factor = 1;
++
+ 	switch (CurMode->type) {
++	case M_TEXT:
++		pixels_per_offset = 16;
++		break;
++	case M_LIN4:
++		pixels_per_offset = 16;
++		break;
+ 	case M_LIN8:
+-		y=(Bit16u)times;
+-		x=(Bit16u)(rem+pan);
++		panning_factor = 2;
++		pixels_per_offset = 8;
++		break;
++	case M_LIN15:
++	case M_LIN16:
++		panning_factor = 2;
++		pixels_per_offset = 4;
++		break;
++	case M_LIN32:
++		pixels_per_offset = 2;
+ 		break;
+ 	default:
+-		return 0x1;
++		return VESA_MODE_UNSUPPORTED;
+ 	}
+-	return 0x00;
++
++	IO_Read(0x3da);              // reset attribute flipflop
++	IO_Write(0x3c0,0x13 | 0x20); // panning register, screen on
++	Bit8u panning = IO_Read(0x3c1);
++
++	Bitu virtual_screen_width = vga.config.scan_len * pixels_per_offset;
++	Bitu start_pixel = vga.config.display_start * (pixels_per_offset/2) 
++		+ panning / panning_factor;
++	
++	y = start_pixel / virtual_screen_width;
++	x = start_pixel % virtual_screen_width;
++	return VESA_SUCCESS;
+ }
+ 
+ static Bitu VESA_SetWindow(void) {
+@@ -453,6 +526,10 @@
+ 	return 0;
+ }
+ static Bitu VESA_PMSetStart(void) {
++	// This function is from VBE2 and directly sets the VGA
++	// display start address.
++
++	// TODO wait for retrace in case bl==0x80
+ 	Bit32u start = (reg_dx << 16) | reg_cx;
+ 	vga.config.display_start = start;
+ 	return 0;
+diff -Nur dosbox-0.74/src/ints/int10_video_state.cpp dosbox/src/ints/int10_video_state.cpp
+--- dosbox-0.74/src/ints/int10_video_state.cpp	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/ints/int10_video_state.cpp	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,7 +16,6 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: int10_video_state.cpp,v 1.3 2009-05-27 09:15:42 qbix79 Exp $ */
+ 
+ #include "dosbox.h"
+ #include "mem.h"
+diff -Nur dosbox-0.74/src/ints/int10_vptable.cpp dosbox/src/ints/int10_vptable.cpp
+--- dosbox-0.74/src/ints/int10_vptable.cpp	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/ints/int10_vptable.cpp	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,7 +16,6 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: int10_vptable.cpp,v 1.6 2009-08-01 13:39:48 c2woody Exp $ */
+ 
+ #include "dosbox.h"
+ #include "mem.h"
+diff -Nur dosbox-0.74/src/ints/Makefile.in dosbox/src/ints/Makefile.in
+--- dosbox-0.74/src/ints/Makefile.in	2010-05-12 11:57:44.000000000 +0200
++++ dosbox/src/ints/Makefile.in	1970-01-01 01:00:00.000000000 +0100
+@@ -1,468 +0,0 @@
+-# Makefile.in generated by automake 1.11.1 from Makefile.am.
+-# @configure_input@
+-
+-# Copyright (C) 1994, 1995, 1996, 1997, 1998, 1999, 2000, 2001, 2002,
+-# 2003, 2004, 2005, 2006, 2007, 2008, 2009  Free Software Foundation,
+-# Inc.
+-# This Makefile.in is free software; the Free Software Foundation
+-# gives unlimited permission to copy and/or distribute it,
+-# with or without modifications, as long as this notice is preserved.
+-
+-# This program is distributed in the hope that it will be useful,
+-# but WITHOUT ANY WARRANTY, to the extent permitted by law; without
+-# even the implied warranty of MERCHANTABILITY or FITNESS FOR A
+-# PARTICULAR PURPOSE.
+-
+-@SET_MAKE@
+-
+-VPATH = @srcdir@
+-pkgdatadir = $(datadir)/@PACKAGE@
+-pkgincludedir = $(includedir)/@PACKAGE@
+-pkglibdir = $(libdir)/@PACKAGE@
+-pkglibexecdir = $(libexecdir)/@PACKAGE@
+-am__cd = CDPATH="$${ZSH_VERSION+.}$(PATH_SEPARATOR)" && cd
+-install_sh_DATA = $(install_sh) -c -m 644
+-install_sh_PROGRAM = $(install_sh) -c
+-install_sh_SCRIPT = $(install_sh) -c
+-INSTALL_HEADER = $(INSTALL_DATA)
+-transform = $(program_transform_name)
+-NORMAL_INSTALL = :
+-PRE_INSTALL = :
+-POST_INSTALL = :
+-NORMAL_UNINSTALL = :
+-PRE_UNINSTALL = :
+-POST_UNINSTALL = :
+-build_triplet = @build@
+-host_triplet = @host@
+-subdir = src/ints
+-DIST_COMMON = $(srcdir)/Makefile.am $(srcdir)/Makefile.in
+-ACLOCAL_M4 = $(top_srcdir)/aclocal.m4
+-am__aclocal_m4_deps = $(top_srcdir)/acinclude.m4 \
+-	$(top_srcdir)/configure.in
+-am__configure_deps = $(am__aclocal_m4_deps) $(CONFIGURE_DEPENDENCIES) \
+-	$(ACLOCAL_M4)
+-mkinstalldirs = $(install_sh) -d
+-CONFIG_HEADER = $(top_builddir)/config.h
+-CONFIG_CLEAN_FILES =
+-CONFIG_CLEAN_VPATH_FILES =
+-LIBRARIES = $(noinst_LIBRARIES)
+-AR = ar
+-ARFLAGS = cru
+-libints_a_AR = $(AR) $(ARFLAGS)
+-libints_a_LIBADD =
+-am_libints_a_OBJECTS = mouse.$(OBJEXT) xms.$(OBJEXT) ems.$(OBJEXT) \
+-	int10.$(OBJEXT) int10_char.$(OBJEXT) int10_memory.$(OBJEXT) \
+-	int10_misc.$(OBJEXT) int10_modes.$(OBJEXT) \
+-	int10_vesa.$(OBJEXT) int10_pal.$(OBJEXT) \
+-	int10_put_pixel.$(OBJEXT) int10_video_state.$(OBJEXT) \
+-	int10_vptable.$(OBJEXT) bios.$(OBJEXT) bios_disk.$(OBJEXT) \
+-	bios_keyboard.$(OBJEXT)
+-libints_a_OBJECTS = $(am_libints_a_OBJECTS)
+-DEFAULT_INCLUDES = -I.@am__isrc@ -I$(top_builddir)
+-depcomp = $(SHELL) $(top_srcdir)/depcomp
+-am__depfiles_maybe = depfiles
+-am__mv = mv -f
+-CXXCOMPILE = $(CXX) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) \
+-	$(AM_CPPFLAGS) $(CPPFLAGS) $(AM_CXXFLAGS) $(CXXFLAGS)
+-CXXLD = $(CXX)
+-CXXLINK = $(CXXLD) $(AM_CXXFLAGS) $(CXXFLAGS) $(AM_LDFLAGS) $(LDFLAGS) \
+-	-o $@
+-COMPILE = $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) \
+-	$(CPPFLAGS) $(AM_CFLAGS) $(CFLAGS)
+-CCLD = $(CC)
+-LINK = $(CCLD) $(AM_CFLAGS) $(CFLAGS) $(AM_LDFLAGS) $(LDFLAGS) -o $@
+-SOURCES = $(libints_a_SOURCES)
+-DIST_SOURCES = $(libints_a_SOURCES)
+-ETAGS = etags
+-CTAGS = ctags
+-DISTFILES = $(DIST_COMMON) $(DIST_SOURCES) $(TEXINFOS) $(EXTRA_DIST)
+-ACLOCAL = @ACLOCAL@
+-ALSA_CFLAGS = @ALSA_CFLAGS@
+-ALSA_LIBS = @ALSA_LIBS@
+-AMTAR = @AMTAR@
+-AUTOCONF = @AUTOCONF@
+-AUTOHEADER = @AUTOHEADER@
+-AUTOMAKE = @AUTOMAKE@
+-AWK = @AWK@
+-CC = @CC@
+-CCDEPMODE = @CCDEPMODE@
+-CFLAGS = @CFLAGS@
+-CPP = @CPP@
+-CPPFLAGS = @CPPFLAGS@
+-CXX = @CXX@
+-CXXDEPMODE = @CXXDEPMODE@
+-CXXFLAGS = @CXXFLAGS@
+-CYGPATH_W = @CYGPATH_W@
+-DEFS = @DEFS@
+-DEPDIR = @DEPDIR@
+-ECHO_C = @ECHO_C@
+-ECHO_N = @ECHO_N@
+-ECHO_T = @ECHO_T@
+-EGREP = @EGREP@
+-EXEEXT = @EXEEXT@
+-GREP = @GREP@
+-INSTALL = @INSTALL@
+-INSTALL_DATA = @INSTALL_DATA@
+-INSTALL_PROGRAM = @INSTALL_PROGRAM@
+-INSTALL_SCRIPT = @INSTALL_SCRIPT@
+-INSTALL_STRIP_PROGRAM = @INSTALL_STRIP_PROGRAM@
+-LDFLAGS = @LDFLAGS@
+-LIBOBJS = @LIBOBJS@
+-LIBS = @LIBS@
+-LTLIBOBJS = @LTLIBOBJS@
+-MAKEINFO = @MAKEINFO@
+-MKDIR_P = @MKDIR_P@
+-OBJEXT = @OBJEXT@
+-PACKAGE = @PACKAGE@
+-PACKAGE_BUGREPORT = @PACKAGE_BUGREPORT@
+-PACKAGE_NAME = @PACKAGE_NAME@
+-PACKAGE_STRING = @PACKAGE_STRING@
+-PACKAGE_TARNAME = @PACKAGE_TARNAME@
+-PACKAGE_URL = @PACKAGE_URL@
+-PACKAGE_VERSION = @PACKAGE_VERSION@
+-PATH_SEPARATOR = @PATH_SEPARATOR@
+-RANLIB = @RANLIB@
+-SDL_CFLAGS = @SDL_CFLAGS@
+-SDL_CONFIG = @SDL_CONFIG@
+-SDL_LIBS = @SDL_LIBS@
+-SET_MAKE = @SET_MAKE@
+-SHELL = @SHELL@
+-STRIP = @STRIP@
+-VERSION = @VERSION@
+-WINDRES = @WINDRES@
+-abs_builddir = @abs_builddir@
+-abs_srcdir = @abs_srcdir@
+-abs_top_builddir = @abs_top_builddir@
+-abs_top_srcdir = @abs_top_srcdir@
+-ac_ct_CC = @ac_ct_CC@
+-ac_ct_CXX = @ac_ct_CXX@
+-am__include = @am__include@
+-am__leading_dot = @am__leading_dot@
+-am__quote = @am__quote@
+-am__tar = @am__tar@
+-am__untar = @am__untar@
+-bindir = @bindir@
+-build = @build@
+-build_alias = @build_alias@
+-build_cpu = @build_cpu@
+-build_os = @build_os@
+-build_vendor = @build_vendor@
+-builddir = @builddir@
+-datadir = @datadir@
+-datarootdir = @datarootdir@
+-docdir = @docdir@
+-dvidir = @dvidir@
+-exec_prefix = @exec_prefix@
+-host = @host@
+-host_alias = @host_alias@
+-host_cpu = @host_cpu@
+-host_os = @host_os@
+-host_vendor = @host_vendor@
+-htmldir = @htmldir@
+-includedir = @includedir@
+-infodir = @infodir@
+-install_sh = @install_sh@
+-libdir = @libdir@
+-libexecdir = @libexecdir@
+-localedir = @localedir@
+-localstatedir = @localstatedir@
+-mandir = @mandir@
+-mkdir_p = @mkdir_p@
+-oldincludedir = @oldincludedir@
+-pdfdir = @pdfdir@
+-prefix = @prefix@
+-program_transform_name = @program_transform_name@
+-psdir = @psdir@
+-sbindir = @sbindir@
+-sharedstatedir = @sharedstatedir@
+-srcdir = @srcdir@
+-sysconfdir = @sysconfdir@
+-target_alias = @target_alias@
+-top_build_prefix = @top_build_prefix@
+-top_builddir = @top_builddir@
+-top_srcdir = @top_srcdir@
+-AM_CPPFLAGS = -I$(top_srcdir)/include
+-noinst_LIBRARIES = libints.a
+-libints_a_SOURCES = mouse.cpp xms.cpp xms.h ems.cpp \
+-                    int10.cpp int10.h int10_char.cpp int10_memory.cpp int10_misc.cpp int10_modes.cpp \
+-                    int10_vesa.cpp int10_pal.cpp int10_put_pixel.cpp int10_video_state.cpp int10_vptable.cpp \
+-                    bios.cpp bios_disk.cpp bios_keyboard.cpp 
+-
+-all: all-am
+-
+-.SUFFIXES:
+-.SUFFIXES: .cpp .o .obj
+-$(srcdir)/Makefile.in:  $(srcdir)/Makefile.am  $(am__configure_deps)
+-	@for dep in $?; do \
+-	  case '$(am__configure_deps)' in \
+-	    *$$dep*) \
+-	      ( cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh ) \
+-	        && { if test -f $@; then exit 0; else break; fi; }; \
+-	      exit 1;; \
+-	  esac; \
+-	done; \
+-	echo ' cd $(top_srcdir) && $(AUTOMAKE) --gnu src/ints/Makefile'; \
+-	$(am__cd) $(top_srcdir) && \
+-	  $(AUTOMAKE) --gnu src/ints/Makefile
+-.PRECIOUS: Makefile
+-Makefile: $(srcdir)/Makefile.in $(top_builddir)/config.status
+-	@case '$?' in \
+-	  *config.status*) \
+-	    cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh;; \
+-	  *) \
+-	    echo ' cd $(top_builddir) && $(SHELL) ./config.status $(subdir)/$@ $(am__depfiles_maybe)'; \
+-	    cd $(top_builddir) && $(SHELL) ./config.status $(subdir)/$@ $(am__depfiles_maybe);; \
+-	esac;
+-
+-$(top_builddir)/config.status: $(top_srcdir)/configure $(CONFIG_STATUS_DEPENDENCIES)
+-	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
+-
+-$(top_srcdir)/configure:  $(am__configure_deps)
+-	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
+-$(ACLOCAL_M4):  $(am__aclocal_m4_deps)
+-	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
+-$(am__aclocal_m4_deps):
+-
+-clean-noinstLIBRARIES:
+-	-test -z "$(noinst_LIBRARIES)" || rm -f $(noinst_LIBRARIES)
+-libints.a: $(libints_a_OBJECTS) $(libints_a_DEPENDENCIES) 
+-	-rm -f libints.a
+-	$(libints_a_AR) libints.a $(libints_a_OBJECTS) $(libints_a_LIBADD)
+-	$(RANLIB) libints.a
+-
+-mostlyclean-compile:
+-	-rm -f *.$(OBJEXT)
+-
+-distclean-compile:
+-	-rm -f *.tab.c
+-
+-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/bios.Po@am__quote@
+-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/bios_disk.Po@am__quote@
+-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/bios_keyboard.Po@am__quote@
+-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/ems.Po@am__quote@
+-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/int10.Po@am__quote@
+-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/int10_char.Po@am__quote@
+-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/int10_memory.Po@am__quote@
+-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/int10_misc.Po@am__quote@
+-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/int10_modes.Po@am__quote@
+-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/int10_pal.Po@am__quote@
+-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/int10_put_pixel.Po@am__quote@
+-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/int10_vesa.Po@am__quote@
+-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/int10_video_state.Po@am__quote@
+-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/int10_vptable.Po@am__quote@
+-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/mouse.Po@am__quote@
+-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/xms.Po@am__quote@
+-
+-.cpp.o:
+-@am__fastdepCXX_TRUE@	$(CXXCOMPILE) -MT $@ -MD -MP -MF $(DEPDIR)/$*.Tpo -c -o $@ $<
+-@am__fastdepCXX_TRUE@	$(am__mv) $(DEPDIR)/$*.Tpo $(DEPDIR)/$*.Po
+-@AMDEP_TRUE@@am__fastdepCXX_FALSE@	source='$<' object='$@' libtool=no @AMDEPBACKSLASH@
+-@AMDEP_TRUE@@am__fastdepCXX_FALSE@	DEPDIR=$(DEPDIR) $(CXXDEPMODE) $(depcomp) @AMDEPBACKSLASH@
+-@am__fastdepCXX_FALSE@	$(CXXCOMPILE) -c -o $@ $<
+-
+-.cpp.obj:
+-@am__fastdepCXX_TRUE@	$(CXXCOMPILE) -MT $@ -MD -MP -MF $(DEPDIR)/$*.Tpo -c -o $@ `$(CYGPATH_W) '$<'`
+-@am__fastdepCXX_TRUE@	$(am__mv) $(DEPDIR)/$*.Tpo $(DEPDIR)/$*.Po
+-@AMDEP_TRUE@@am__fastdepCXX_FALSE@	source='$<' object='$@' libtool=no @AMDEPBACKSLASH@
+-@AMDEP_TRUE@@am__fastdepCXX_FALSE@	DEPDIR=$(DEPDIR) $(CXXDEPMODE) $(depcomp) @AMDEPBACKSLASH@
+-@am__fastdepCXX_FALSE@	$(CXXCOMPILE) -c -o $@ `$(CYGPATH_W) '$<'`
+-
+-ID: $(HEADERS) $(SOURCES) $(LISP) $(TAGS_FILES)
+-	list='$(SOURCES) $(HEADERS) $(LISP) $(TAGS_FILES)'; \
+-	unique=`for i in $$list; do \
+-	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
+-	  done | \
+-	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
+-	      END { if (nonempty) { for (i in files) print i; }; }'`; \
+-	mkid -fID $$unique
+-tags: TAGS
+-
+-TAGS:  $(HEADERS) $(SOURCES)  $(TAGS_DEPENDENCIES) \
+-		$(TAGS_FILES) $(LISP)
+-	set x; \
+-	here=`pwd`; \
+-	list='$(SOURCES) $(HEADERS)  $(LISP) $(TAGS_FILES)'; \
+-	unique=`for i in $$list; do \
+-	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
+-	  done | \
+-	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
+-	      END { if (nonempty) { for (i in files) print i; }; }'`; \
+-	shift; \
+-	if test -z "$(ETAGS_ARGS)$$*$$unique"; then :; else \
+-	  test -n "$$unique" || unique=$$empty_fix; \
+-	  if test $$# -gt 0; then \
+-	    $(ETAGS) $(ETAGSFLAGS) $(AM_ETAGSFLAGS) $(ETAGS_ARGS) \
+-	      "$$@" $$unique; \
+-	  else \
+-	    $(ETAGS) $(ETAGSFLAGS) $(AM_ETAGSFLAGS) $(ETAGS_ARGS) \
+-	      $$unique; \
+-	  fi; \
+-	fi
+-ctags: CTAGS
+-CTAGS:  $(HEADERS) $(SOURCES)  $(TAGS_DEPENDENCIES) \
+-		$(TAGS_FILES) $(LISP)
+-	list='$(SOURCES) $(HEADERS)  $(LISP) $(TAGS_FILES)'; \
+-	unique=`for i in $$list; do \
+-	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
+-	  done | \
+-	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
+-	      END { if (nonempty) { for (i in files) print i; }; }'`; \
+-	test -z "$(CTAGS_ARGS)$$unique" \
+-	  || $(CTAGS) $(CTAGSFLAGS) $(AM_CTAGSFLAGS) $(CTAGS_ARGS) \
+-	     $$unique
+-
+-GTAGS:
+-	here=`$(am__cd) $(top_builddir) && pwd` \
+-	  && $(am__cd) $(top_srcdir) \
+-	  && gtags -i $(GTAGS_ARGS) "$$here"
+-
+-distclean-tags:
+-	-rm -f TAGS ID GTAGS GRTAGS GSYMS GPATH tags
+-
+-distdir: $(DISTFILES)
+-	@srcdirstrip=`echo "$(srcdir)" | sed 's/[].[^$$\\*]/\\\\&/g'`; \
+-	topsrcdirstrip=`echo "$(top_srcdir)" | sed 's/[].[^$$\\*]/\\\\&/g'`; \
+-	list='$(DISTFILES)'; \
+-	  dist_files=`for file in $$list; do echo $$file; done | \
+-	  sed -e "s|^$$srcdirstrip/||;t" \
+-	      -e "s|^$$topsrcdirstrip/|$(top_builddir)/|;t"`; \
+-	case $$dist_files in \
+-	  */*) $(MKDIR_P) `echo "$$dist_files" | \
+-			   sed '/\//!d;s|^|$(distdir)/|;s,/[^/]*$$,,' | \
+-			   sort -u` ;; \
+-	esac; \
+-	for file in $$dist_files; do \
+-	  if test -f $$file || test -d $$file; then d=.; else d=$(srcdir); fi; \
+-	  if test -d $$d/$$file; then \
+-	    dir=`echo "/$$file" | sed -e 's,/[^/]*$$,,'`; \
+-	    if test -d "$(distdir)/$$file"; then \
+-	      find "$(distdir)/$$file" -type d ! -perm -700 -exec chmod u+rwx {} \;; \
+-	    fi; \
+-	    if test -d $(srcdir)/$$file && test $$d != $(srcdir); then \
+-	      cp -fpR $(srcdir)/$$file "$(distdir)$$dir" || exit 1; \
+-	      find "$(distdir)/$$file" -type d ! -perm -700 -exec chmod u+rwx {} \;; \
+-	    fi; \
+-	    cp -fpR $$d/$$file "$(distdir)$$dir" || exit 1; \
+-	  else \
+-	    test -f "$(distdir)/$$file" \
+-	    || cp -p $$d/$$file "$(distdir)/$$file" \
+-	    || exit 1; \
+-	  fi; \
+-	done
+-check-am: all-am
+-check: check-am
+-all-am: Makefile $(LIBRARIES)
+-installdirs:
+-install: install-am
+-install-exec: install-exec-am
+-install-data: install-data-am
+-uninstall: uninstall-am
+-
+-install-am: all-am
+-	@$(MAKE) $(AM_MAKEFLAGS) install-exec-am install-data-am
+-
+-installcheck: installcheck-am
+-install-strip:
+-	$(MAKE) $(AM_MAKEFLAGS) INSTALL_PROGRAM="$(INSTALL_STRIP_PROGRAM)" \
+-	  install_sh_PROGRAM="$(INSTALL_STRIP_PROGRAM)" INSTALL_STRIP_FLAG=-s \
+-	  `test -z '$(STRIP)' || \
+-	    echo "INSTALL_PROGRAM_ENV=STRIPPROG='$(STRIP)'"` install
+-mostlyclean-generic:
+-
+-clean-generic:
+-
+-distclean-generic:
+-	-test -z "$(CONFIG_CLEAN_FILES)" || rm -f $(CONFIG_CLEAN_FILES)
+-	-test . = "$(srcdir)" || test -z "$(CONFIG_CLEAN_VPATH_FILES)" || rm -f $(CONFIG_CLEAN_VPATH_FILES)
+-
+-maintainer-clean-generic:
+-	@echo "This command is intended for maintainers to use"
+-	@echo "it deletes files that may require special tools to rebuild."
+-clean: clean-am
+-
+-clean-am: clean-generic clean-noinstLIBRARIES mostlyclean-am
+-
+-distclean: distclean-am
+-	-rm -rf ./$(DEPDIR)
+-	-rm -f Makefile
+-distclean-am: clean-am distclean-compile distclean-generic \
+-	distclean-tags
+-
+-dvi: dvi-am
+-
+-dvi-am:
+-
+-html: html-am
+-
+-html-am:
+-
+-info: info-am
+-
+-info-am:
+-
+-install-data-am:
+-
+-install-dvi: install-dvi-am
+-
+-install-dvi-am:
+-
+-install-exec-am:
+-
+-install-html: install-html-am
+-
+-install-html-am:
+-
+-install-info: install-info-am
+-
+-install-info-am:
+-
+-install-man:
+-
+-install-pdf: install-pdf-am
+-
+-install-pdf-am:
+-
+-install-ps: install-ps-am
+-
+-install-ps-am:
+-
+-installcheck-am:
+-
+-maintainer-clean: maintainer-clean-am
+-	-rm -rf ./$(DEPDIR)
+-	-rm -f Makefile
+-maintainer-clean-am: distclean-am maintainer-clean-generic
+-
+-mostlyclean: mostlyclean-am
+-
+-mostlyclean-am: mostlyclean-compile mostlyclean-generic
+-
+-pdf: pdf-am
+-
+-pdf-am:
+-
+-ps: ps-am
+-
+-ps-am:
+-
+-uninstall-am:
+-
+-.MAKE: install-am install-strip
+-
+-.PHONY: CTAGS GTAGS all all-am check check-am clean clean-generic \
+-	clean-noinstLIBRARIES ctags distclean distclean-compile \
+-	distclean-generic distclean-tags distdir dvi dvi-am html \
+-	html-am info info-am install install-am install-data \
+-	install-data-am install-dvi install-dvi-am install-exec \
+-	install-exec-am install-html install-html-am install-info \
+-	install-info-am install-man install-pdf install-pdf-am \
+-	install-ps install-ps-am install-strip installcheck \
+-	installcheck-am installdirs maintainer-clean \
+-	maintainer-clean-generic mostlyclean mostlyclean-compile \
+-	mostlyclean-generic pdf pdf-am ps ps-am tags uninstall \
+-	uninstall-am
+-
+-
+-# Tell versions [3.59,3.63) of GNU make to not export all variables.
+-# Otherwise a system limit (for SysV at least) may be exceeded.
+-.NOEXPORT:
+diff -Nur dosbox-0.74/src/ints/mouse.cpp dosbox/src/ints/mouse.cpp
+--- dosbox-0.74/src/ints/mouse.cpp	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/ints/mouse.cpp	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,7 +16,6 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: mouse.cpp,v 1.80 2009-06-16 19:00:26 qbix79 Exp $ */
+ 
+ #include <string.h>
+ #include <math.h>
+@@ -51,8 +50,8 @@
+ #define QUEUE_SIZE 32
+ #define MOUSE_BUTTONS 3
+ #define MOUSE_IRQ 12
+-#define POS_X ((Bit16s)(mouse.x) & mouse.granMask)
+-#define POS_Y (Bit16s)(mouse.y)
++#define POS_X (static_cast<Bit16s>(mouse.x) & mouse.gran_x)
++#define POS_Y (static_cast<Bit16s>(mouse.y) & mouse.gran_y)
+ 
+ #define CURSORX 16
+ #define CURSORY 16
+@@ -126,7 +125,7 @@
+ 	bool timer_in_progress;
+ 	bool in_UIR;
+ 	Bit8u mode;
+-	Bit16s granMask;
++	Bit16s gran_x,gran_y;
+ } mouse;
+ 
+ bool Mouse_SetPS2State(bool use) {
+@@ -256,6 +255,7 @@
+ 	// Save Background
+ 	mouse.backposx		= POS_X>>3;
+ 	mouse.backposy		= POS_Y>>3;
++	if (mouse.mode < 2) mouse.backposx >>= 1; 
+ 
+ 	//use current page (CV program)
+ 	Bit8u page = real_readb(BIOSMEM_SEG,BIOSMEM_CURRENT_PAGE);
+@@ -454,8 +454,12 @@
+ 	if((fabs(yrel) > 1.0) || (mouse.senv_y < 1.0)) dy *= mouse.senv_y;
+ 	if (useps2callback) dy *= 2;	
+ 
+-	mouse.mickey_x += dx;
+-	mouse.mickey_y += dy;
++	mouse.mickey_x += (dx * mouse.mickeysPerPixel_x);
++	mouse.mickey_y += (dy * mouse.mickeysPerPixel_y);
++	if (mouse.mickey_x >= 32768.0) mouse.mickey_x -= 65536.0;
++	else if (mouse.mickey_x <= -32769.0) mouse.mickey_x += 65536.0;
++	if (mouse.mickey_y >= 32768.0) mouse.mickey_y -= 65536.0;
++	else if (mouse.mickey_y <= -32769.0) mouse.mickey_y += 65536.0;
+ 	if (emulate) {
+ 		mouse.x += dx;
+ 		mouse.y += dy;
+@@ -484,6 +488,11 @@
+ 		if (mouse.x < mouse.min_x) mouse.x = mouse.min_x;
+ 		if (mouse.y > mouse.max_y) mouse.y = mouse.max_y;
+ 		if (mouse.y < mouse.min_y) mouse.y = mouse.min_y;
++	} else {
++		if (mouse.x >= 32768.0) mouse.x -= 65536.0;
++		else if (mouse.x <= -32769.0) mouse.x += 65536.0;
++		if (mouse.y >= 32768.0) mouse.y -= 65536.0;
++		else if (mouse.y <= -32769.0) mouse.y += 65536.0;
+ 	}
+ 	Mouse_AddEvent(MOUSE_HAS_MOVED);
+ 	DrawCursor();
+@@ -583,43 +592,48 @@
+ 
+ //Does way to much. Many things should be moved to mouse reset one day
+ void Mouse_NewVideoMode(void) {
+-	mouse.inhibit_draw=false;
++	mouse.inhibit_draw = false;
+ 	/* Get the correct resolution from the current video mode */
+-	Bit8u mode=mem_readb(BIOS_VIDEO_MODE);
++	Bit8u mode = mem_readb(BIOS_VIDEO_MODE);
+ 	if(mode == mouse.mode) {LOG(LOG_MOUSE,LOG_NORMAL)("New video is the same as the old"); /*return;*/}
++	mouse.gran_x = (Bit16s)0xffff;
++	mouse.gran_y = (Bit16s)0xffff;
+ 	switch (mode) {
+ 	case 0x00:
+ 	case 0x01:
+ 	case 0x02:
+-	case 0x03: {
+-		Bitu rows=real_readb(BIOSMEM_SEG,BIOSMEM_NB_ROWS);
+-		if ((rows==0) || (rows>250)) rows=25-1;
+-		mouse.max_y=8*(rows+1)-1;
++	case 0x03:
++	case 0x07: {
++		mouse.gran_x = (mode<2)?0xfff0:0xfff8;
++		mouse.gran_y = (Bit16s)0xfff8;
++		Bitu rows = real_readb(BIOSMEM_SEG,BIOSMEM_NB_ROWS);
++		if ((rows == 0) || (rows > 250)) rows = 25 - 1;
++		mouse.max_y = 8*(rows+1) - 1;
+ 		break;
+ 	}
+ 	case 0x04:
+ 	case 0x05:
+ 	case 0x06:
+-	case 0x07:
+ 	case 0x08:
+ 	case 0x09:
+ 	case 0x0a:
+ 	case 0x0d:
+ 	case 0x0e:
+ 	case 0x13:
+-		mouse.max_y=199;
++		if (mode == 0x0d || mode == 0x13) mouse.gran_x = (Bit16s)0xfffe;
++		mouse.max_y = 199;
+ 		break;
+ 	case 0x0f:
+ 	case 0x10:
+-		mouse.max_y=349;
++		mouse.max_y = 349;
+ 		break;
+ 	case 0x11:
+ 	case 0x12:
+-		mouse.max_y=479;
++		mouse.max_y = 479;
+ 		break;
+ 	default:
+ 		LOG(LOG_MOUSE,LOG_ERROR)("Unhandled videomode %X on reset",mode);
+-		mouse.inhibit_draw=true;
++		mouse.inhibit_draw = true;
+ 		return;
+ 	}
+ 	mouse.mode = mode;
+@@ -627,7 +641,6 @@
+ 	mouse.max_x = 639;
+ 	mouse.min_x = 0;
+ 	mouse.min_y = 0;
+-	mouse.granMask = (mode == 0x0d || mode == 0x13) ? 0xfffe : 0xffff;
+ 
+ 	mouse.events = 0;
+ 	mouse.timer_in_progress = false;
+@@ -793,8 +806,8 @@
+ 		mouse.textXorMask = reg_dx;
+ 		break;
+ 	case 0x0b:	/* Read Motion Data */
+-		reg_cx=(Bit16s)(mouse.mickey_x*mouse.mickeysPerPixel_x);
+-		reg_dx=(Bit16s)(mouse.mickey_y*mouse.mickeysPerPixel_y);
++		reg_cx=static_cast<Bit16s>(mouse.mickey_x);
++		reg_dx=static_cast<Bit16s>(mouse.mickey_y);
+ 		mouse.mickey_x=0;
+ 		mouse.mickey_y=0;
+ 		break;
+@@ -916,6 +929,12 @@
+ 		reg_cx=(Bit16u)mouse.max_x;
+ 		reg_dx=(Bit16u)mouse.max_y;
+ 		break;
++	case 0x2a:	/* Get cursor hot spot */
++		reg_al=(Bit8u)-mouse.hidden;	// Microsoft uses a negative byte counter for cursor visibility
++		reg_bx=(Bit16u)mouse.hotx;
++		reg_cx=(Bit16u)mouse.hoty;
++		reg_dx=0x04;	// PS/2 mouse type
++		break;
+ 	case 0x31: /* Get Current Minimum/Maximum virtual coordinates */
+ 		reg_ax=(Bit16u)mouse.min_x;
+ 		reg_bx=(Bit16u)mouse.min_y;
+@@ -997,8 +1016,8 @@
+ 			reg_bx=mouse.event_queue[mouse.events].buttons;
+ 			reg_cx=POS_X;
+ 			reg_dx=POS_Y;
+-			reg_si=(Bit16s)(mouse.mickey_x*mouse.mickeysPerPixel_x);
+-			reg_di=(Bit16s)(mouse.mickey_y*mouse.mickeysPerPixel_y);
++			reg_si=static_cast<Bit16s>(mouse.mickey_x);
++			reg_di=static_cast<Bit16s>(mouse.mickey_y);
+ 			CPU_Push16(RealSeg(CALLBACK_RealPointer(int74_ret_callback)));
+ 			CPU_Push16(RealOff(CALLBACK_RealPointer(int74_ret_callback)));
+ 			SegSet16(cs, mouse.sub_seg);
+@@ -1008,7 +1027,7 @@
+ 		} else if (useps2callback) {
+ 			CPU_Push16(RealSeg(CALLBACK_RealPointer(int74_ret_callback)));
+ 			CPU_Push16(RealOff(CALLBACK_RealPointer(int74_ret_callback)));
+-			DoPS2Callback(mouse.event_queue[mouse.events].buttons, POS_X, POS_Y);
++			DoPS2Callback(mouse.event_queue[mouse.events].buttons, static_cast<Bit16s>(mouse.x), static_cast<Bit16s>(mouse.y));
+ 		} else {
+ 			SegSet16(cs, RealSeg(CALLBACK_RealPointer(int74_ret_callback)));
+ 			reg_ip = RealOff(CALLBACK_RealPointer(int74_ret_callback));
+diff -Nur dosbox-0.74/src/ints/xms.cpp dosbox/src/ints/xms.cpp
+--- dosbox-0.74/src/ints/xms.cpp	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/ints/xms.cpp	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,10 +16,10 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: xms.cpp,v 1.55 2009-05-27 09:15:42 qbix79 Exp $ */
+ 
+ #include <stdlib.h>
+ #include <string.h>
++#include <stddef.h>
+ #include "dosbox.h"
+ #include "callback.h"
+ #include "mem.h"
+@@ -412,6 +412,8 @@
+ 	return CBRET_NONE;
+ }
+ 
++Bitu GetEMSType(Section_prop * section);
++
+ class XMS: public Module_base {
+ private:
+ 	CALLBACK_HandlerObject callbackhandler;
+@@ -445,7 +447,8 @@
+ 
+ 		/* Set up UMB chain */
+ 		umb_available=section->Get_bool("umb");
+-		DOS_BuildUMBChain(section->Get_bool("umb"),section->Get_bool("ems"));
++		bool ems_available = GetEMSType(section)>0;
++		DOS_BuildUMBChain(section->Get_bool("umb"),ems_available);
+ 	}
+ 
+ 	~XMS(){
+diff -Nur dosbox-0.74/src/ints/xms.h dosbox/src/ints/xms.h
+--- dosbox-0.74/src/ints/xms.h	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/ints/xms.h	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+diff -Nur dosbox-0.74/src/libs/gui_tk/Doxyfile dosbox/src/libs/gui_tk/Doxyfile
+--- dosbox-0.74/src/libs/gui_tk/Doxyfile	1970-01-01 01:00:00.000000000 +0100
++++ dosbox/src/libs/gui_tk/Doxyfile	2014-01-12 14:43:47.000000000 +0100
+@@ -0,0 +1,238 @@
++# Doxyfile 1.5.2
++
++#---------------------------------------------------------------------------
++# Project related configuration options
++#---------------------------------------------------------------------------
++DOXYFILE_ENCODING      = UTF-8
++PROJECT_NAME           = gui::tk
++PROJECT_NUMBER         = "Version 1.0"
++OUTPUT_DIRECTORY       = 
++CREATE_SUBDIRS         = NO
++OUTPUT_LANGUAGE        = English
++BRIEF_MEMBER_DESC      = YES
++REPEAT_BRIEF           = YES
++ABBREVIATE_BRIEF       = "The $name class" \
++                         "The $name widget" \
++                         "The $name file" \
++                         is \
++                         provides \
++                         specifies \
++                         contains \
++                         represents \
++                         a \
++                         an \
++                         the
++ALWAYS_DETAILED_SEC    = NO
++INLINE_INHERITED_MEMB  = NO
++FULL_PATH_NAMES        = YES
++STRIP_FROM_PATH        = .
++STRIP_FROM_INC_PATH    = 
++SHORT_NAMES            = NO
++JAVADOC_AUTOBRIEF      = NO
++MULTILINE_CPP_IS_BRIEF = NO
++DETAILS_AT_TOP         = YES
++INHERIT_DOCS           = YES
++SEPARATE_MEMBER_PAGES  = NO
++TAB_SIZE               = 8
++ALIASES                = 
++OPTIMIZE_OUTPUT_FOR_C  = NO
++OPTIMIZE_OUTPUT_JAVA   = NO
++BUILTIN_STL_SUPPORT    = YES
++CPP_CLI_SUPPORT        = NO
++DISTRIBUTE_GROUP_DOC   = NO
++SUBGROUPING            = YES
++#---------------------------------------------------------------------------
++# Build related configuration options
++#---------------------------------------------------------------------------
++EXTRACT_ALL            = NO
++EXTRACT_PRIVATE        = NO
++EXTRACT_STATIC         = NO
++EXTRACT_LOCAL_CLASSES  = YES
++EXTRACT_LOCAL_METHODS  = NO
++HIDE_UNDOC_MEMBERS     = NO
++HIDE_UNDOC_CLASSES     = NO
++HIDE_FRIEND_COMPOUNDS  = NO
++HIDE_IN_BODY_DOCS      = NO
++INTERNAL_DOCS          = NO
++CASE_SENSE_NAMES       = YES
++HIDE_SCOPE_NAMES       = NO
++SHOW_INCLUDE_FILES     = YES
++INLINE_INFO            = YES
++SORT_MEMBER_DOCS       = YES
++SORT_BRIEF_DOCS        = NO
++SORT_BY_SCOPE_NAME     = NO
++GENERATE_TODOLIST      = YES
++GENERATE_TESTLIST      = YES
++GENERATE_BUGLIST       = YES
++GENERATE_DEPRECATEDLIST= YES
++ENABLED_SECTIONS       = 
++MAX_INITIALIZER_LINES  = 30
++SHOW_USED_FILES        = YES
++SHOW_DIRECTORIES       = YES
++FILE_VERSION_FILTER    = 
++#---------------------------------------------------------------------------
++# configuration options related to warning and progress messages
++#---------------------------------------------------------------------------
++QUIET                  = NO
++WARNINGS               = YES
++WARN_IF_UNDOCUMENTED   = NO
++WARN_IF_DOC_ERROR      = YES
++WARN_NO_PARAMDOC       = NO
++WARN_FORMAT            = "$file:$line: $text"
++WARN_LOGFILE           = 
++#---------------------------------------------------------------------------
++# configuration options related to the input files
++#---------------------------------------------------------------------------
++INPUT                  = .
++INPUT_ENCODING         = UTF-8
++FILE_PATTERNS          = gui_tk.h \
++                         gui_tk.cpp
++RECURSIVE              = NO
++EXCLUDE                = 
++EXCLUDE_SYMLINKS       = NO
++EXCLUDE_PATTERNS       = 
++EXCLUDE_SYMBOLS        = 
++EXAMPLE_PATH           = 
++EXAMPLE_PATTERNS       = *
++EXAMPLE_RECURSIVE      = NO
++IMAGE_PATH             = 
++INPUT_FILTER           = 
++FILTER_PATTERNS        = 
++FILTER_SOURCE_FILES    = NO
++#---------------------------------------------------------------------------
++# configuration options related to source browsing
++#---------------------------------------------------------------------------
++SOURCE_BROWSER         = YES
++INLINE_SOURCES         = NO
++STRIP_CODE_COMMENTS    = YES
++REFERENCED_BY_RELATION = YES
++REFERENCES_RELATION    = YES
++REFERENCES_LINK_SOURCE = YES
++USE_HTAGS              = NO
++VERBATIM_HEADERS       = YES
++#---------------------------------------------------------------------------
++# configuration options related to the alphabetical class index
++#---------------------------------------------------------------------------
++ALPHABETICAL_INDEX     = NO
++COLS_IN_ALPHA_INDEX    = 5
++IGNORE_PREFIX          = 
++#---------------------------------------------------------------------------
++# configuration options related to the HTML output
++#---------------------------------------------------------------------------
++GENERATE_HTML          = YES
++HTML_OUTPUT            = html
++HTML_FILE_EXTENSION    = .html
++HTML_HEADER            = 
++HTML_FOOTER            = 
++HTML_STYLESHEET        = 
++HTML_ALIGN_MEMBERS     = YES
++GENERATE_HTMLHELP      = NO
++CHM_FILE               = 
++HHC_LOCATION           = 
++GENERATE_CHI           = NO
++BINARY_TOC             = NO
++TOC_EXPAND             = NO
++DISABLE_INDEX          = NO
++ENUM_VALUES_PER_LINE   = 4
++GENERATE_TREEVIEW      = NO
++TREEVIEW_WIDTH         = 250
++#---------------------------------------------------------------------------
++# configuration options related to the LaTeX output
++#---------------------------------------------------------------------------
++GENERATE_LATEX         = NO
++LATEX_OUTPUT           = latex
++LATEX_CMD_NAME         = latex
++MAKEINDEX_CMD_NAME     = makeindex
++COMPACT_LATEX          = NO
++PAPER_TYPE             = a4wide
++EXTRA_PACKAGES         = 
++LATEX_HEADER           = 
++PDF_HYPERLINKS         = NO
++USE_PDFLATEX           = NO
++LATEX_BATCHMODE        = NO
++LATEX_HIDE_INDICES     = NO
++#---------------------------------------------------------------------------
++# configuration options related to the RTF output
++#---------------------------------------------------------------------------
++GENERATE_RTF           = NO
++RTF_OUTPUT             = rtf
++COMPACT_RTF            = NO
++RTF_HYPERLINKS         = NO
++RTF_STYLESHEET_FILE    = 
++RTF_EXTENSIONS_FILE    = 
++#---------------------------------------------------------------------------
++# configuration options related to the man page output
++#---------------------------------------------------------------------------
++GENERATE_MAN           = NO
++MAN_OUTPUT             = man
++MAN_EXTENSION          = .3
++MAN_LINKS              = NO
++#---------------------------------------------------------------------------
++# configuration options related to the XML output
++#---------------------------------------------------------------------------
++GENERATE_XML           = NO
++XML_OUTPUT             = xml
++XML_SCHEMA             = 
++XML_DTD                = 
++XML_PROGRAMLISTING     = YES
++#---------------------------------------------------------------------------
++# configuration options for the AutoGen Definitions output
++#---------------------------------------------------------------------------
++GENERATE_AUTOGEN_DEF   = NO
++#---------------------------------------------------------------------------
++# configuration options related to the Perl module output
++#---------------------------------------------------------------------------
++GENERATE_PERLMOD       = NO
++PERLMOD_LATEX          = NO
++PERLMOD_PRETTY         = YES
++PERLMOD_MAKEVAR_PREFIX = 
++#---------------------------------------------------------------------------
++# Configuration options related to the preprocessor   
++#---------------------------------------------------------------------------
++ENABLE_PREPROCESSING   = YES
++MACRO_EXPANSION        = NO
++EXPAND_ONLY_PREDEF     = NO
++SEARCH_INCLUDES        = YES
++INCLUDE_PATH           = 
++INCLUDE_FILE_PATTERNS  = 
++PREDEFINED             = TESTING SDL_MAJOR_VERSION
++EXPAND_AS_DEFINED      = 
++SKIP_FUNCTION_MACROS   = YES
++#---------------------------------------------------------------------------
++# Configuration::additions related to external references   
++#---------------------------------------------------------------------------
++TAGFILES               = 
++GENERATE_TAGFILE       = DOSBox.tag
++ALLEXTERNALS           = NO
++EXTERNAL_GROUPS        = YES
++PERL_PATH              = /usr/bin/perl
++#---------------------------------------------------------------------------
++# Configuration options related to the dot tool   
++#---------------------------------------------------------------------------
++CLASS_DIAGRAMS         = YES
++MSCGEN_PATH            = 
++HIDE_UNDOC_RELATIONS   = YES
++HAVE_DOT               = YES
++CLASS_GRAPH            = YES
++COLLABORATION_GRAPH    = YES
++GROUP_GRAPHS           = YES
++UML_LOOK               = YES
++TEMPLATE_RELATIONS     = YES
++INCLUDE_GRAPH          = YES
++INCLUDED_BY_GRAPH      = YES
++CALL_GRAPH             = YES
++CALLER_GRAPH           = YES
++GRAPHICAL_HIERARCHY    = YES
++DIRECTORY_GRAPH        = YES
++DOT_IMAGE_FORMAT       = png
++DOT_PATH               = 
++DOTFILE_DIRS           = 
++DOT_GRAPH_MAX_NODES    = 50
++DOT_TRANSPARENT        = YES
++DOT_MULTI_TARGETS      = YES
++GENERATE_LEGEND        = YES
++DOT_CLEANUP            = YES
++#---------------------------------------------------------------------------
++# Configuration::additions related to the search engine   
++#---------------------------------------------------------------------------
++SEARCHENGINE           = NO
+diff -Nur dosbox-0.74/src/libs/gui_tk/gui_tk.cpp dosbox/src/libs/gui_tk/gui_tk.cpp
+--- dosbox-0.74/src/libs/gui_tk/gui_tk.cpp	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/libs/gui_tk/gui_tk.cpp	2014-01-12 14:43:47.000000000 +0100
+@@ -20,7 +20,6 @@
+ /* TODO:
+   - make menu a bufferedwindow with shadow
+ */
+-/* $Id: gui_tk.cpp,v 1.5 2009-02-01 16:06:26 qbix79 Exp $ */
+ 
+ /** \file
+  *  \brief Implementation file for gui_tk.
+diff -Nur dosbox-0.74/src/libs/gui_tk/gui_tk.h dosbox/src/libs/gui_tk/gui_tk.h
+--- dosbox-0.74/src/libs/gui_tk/gui_tk.h	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/libs/gui_tk/gui_tk.h	2014-01-12 14:43:47.000000000 +0100
+@@ -102,7 +102,6 @@
+  * along with this program.  If not, see <http://www.gnu.org/licenses/>
+  */
+ 
+-/* $Id: gui_tk.h,v 1.6 2009-05-17 15:28:05 c2woody Exp $ */
+ 
+ #ifndef GUI__TOOLKIT_H
+ #define GUI__TOOLKIT_H
+diff -Nur dosbox-0.74/src/libs/gui_tk/Makefile.in dosbox/src/libs/gui_tk/Makefile.in
+--- dosbox-0.74/src/libs/gui_tk/Makefile.in	2010-05-12 11:57:44.000000000 +0200
++++ dosbox/src/libs/gui_tk/Makefile.in	1970-01-01 01:00:00.000000000 +0100
+@@ -1,443 +0,0 @@
+-# Makefile.in generated by automake 1.11.1 from Makefile.am.
+-# @configure_input@
+-
+-# Copyright (C) 1994, 1995, 1996, 1997, 1998, 1999, 2000, 2001, 2002,
+-# 2003, 2004, 2005, 2006, 2007, 2008, 2009  Free Software Foundation,
+-# Inc.
+-# This Makefile.in is free software; the Free Software Foundation
+-# gives unlimited permission to copy and/or distribute it,
+-# with or without modifications, as long as this notice is preserved.
+-
+-# This program is distributed in the hope that it will be useful,
+-# but WITHOUT ANY WARRANTY, to the extent permitted by law; without
+-# even the implied warranty of MERCHANTABILITY or FITNESS FOR A
+-# PARTICULAR PURPOSE.
+-
+-@SET_MAKE@
+-
+-VPATH = @srcdir@
+-pkgdatadir = $(datadir)/@PACKAGE@
+-pkgincludedir = $(includedir)/@PACKAGE@
+-pkglibdir = $(libdir)/@PACKAGE@
+-pkglibexecdir = $(libexecdir)/@PACKAGE@
+-am__cd = CDPATH="$${ZSH_VERSION+.}$(PATH_SEPARATOR)" && cd
+-install_sh_DATA = $(install_sh) -c -m 644
+-install_sh_PROGRAM = $(install_sh) -c
+-install_sh_SCRIPT = $(install_sh) -c
+-INSTALL_HEADER = $(INSTALL_DATA)
+-transform = $(program_transform_name)
+-NORMAL_INSTALL = :
+-PRE_INSTALL = :
+-POST_INSTALL = :
+-NORMAL_UNINSTALL = :
+-PRE_UNINSTALL = :
+-POST_UNINSTALL = :
+-build_triplet = @build@
+-host_triplet = @host@
+-subdir = src/libs/gui_tk
+-DIST_COMMON = $(srcdir)/Makefile.am $(srcdir)/Makefile.in
+-ACLOCAL_M4 = $(top_srcdir)/aclocal.m4
+-am__aclocal_m4_deps = $(top_srcdir)/acinclude.m4 \
+-	$(top_srcdir)/configure.in
+-am__configure_deps = $(am__aclocal_m4_deps) $(CONFIGURE_DEPENDENCIES) \
+-	$(ACLOCAL_M4)
+-mkinstalldirs = $(install_sh) -d
+-CONFIG_HEADER = $(top_builddir)/config.h
+-CONFIG_CLEAN_FILES =
+-CONFIG_CLEAN_VPATH_FILES =
+-LIBRARIES = $(noinst_LIBRARIES)
+-AR = ar
+-ARFLAGS = cru
+-libgui_tk_a_AR = $(AR) $(ARFLAGS)
+-libgui_tk_a_LIBADD =
+-am_libgui_tk_a_OBJECTS = gui_tk.$(OBJEXT)
+-libgui_tk_a_OBJECTS = $(am_libgui_tk_a_OBJECTS)
+-DEFAULT_INCLUDES = -I.@am__isrc@ -I$(top_builddir)
+-depcomp = $(SHELL) $(top_srcdir)/depcomp
+-am__depfiles_maybe = depfiles
+-am__mv = mv -f
+-CXXCOMPILE = $(CXX) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) \
+-	$(AM_CPPFLAGS) $(CPPFLAGS) $(AM_CXXFLAGS) $(CXXFLAGS)
+-CXXLD = $(CXX)
+-CXXLINK = $(CXXLD) $(AM_CXXFLAGS) $(CXXFLAGS) $(AM_LDFLAGS) $(LDFLAGS) \
+-	-o $@
+-COMPILE = $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) \
+-	$(CPPFLAGS) $(AM_CFLAGS) $(CFLAGS)
+-CCLD = $(CC)
+-LINK = $(CCLD) $(AM_CFLAGS) $(CFLAGS) $(AM_LDFLAGS) $(LDFLAGS) -o $@
+-SOURCES = $(libgui_tk_a_SOURCES)
+-DIST_SOURCES = $(libgui_tk_a_SOURCES)
+-ETAGS = etags
+-CTAGS = ctags
+-DISTFILES = $(DIST_COMMON) $(DIST_SOURCES) $(TEXINFOS) $(EXTRA_DIST)
+-ACLOCAL = @ACLOCAL@
+-ALSA_CFLAGS = @ALSA_CFLAGS@
+-ALSA_LIBS = @ALSA_LIBS@
+-AMTAR = @AMTAR@
+-AUTOCONF = @AUTOCONF@
+-AUTOHEADER = @AUTOHEADER@
+-AUTOMAKE = @AUTOMAKE@
+-AWK = @AWK@
+-CC = @CC@
+-CCDEPMODE = @CCDEPMODE@
+-CFLAGS = @CFLAGS@
+-CPP = @CPP@
+-CPPFLAGS = @CPPFLAGS@
+-CXX = @CXX@
+-CXXDEPMODE = @CXXDEPMODE@
+-CXXFLAGS = @CXXFLAGS@
+-CYGPATH_W = @CYGPATH_W@
+-DEFS = @DEFS@
+-DEPDIR = @DEPDIR@
+-ECHO_C = @ECHO_C@
+-ECHO_N = @ECHO_N@
+-ECHO_T = @ECHO_T@
+-EGREP = @EGREP@
+-EXEEXT = @EXEEXT@
+-GREP = @GREP@
+-INSTALL = @INSTALL@
+-INSTALL_DATA = @INSTALL_DATA@
+-INSTALL_PROGRAM = @INSTALL_PROGRAM@
+-INSTALL_SCRIPT = @INSTALL_SCRIPT@
+-INSTALL_STRIP_PROGRAM = @INSTALL_STRIP_PROGRAM@
+-LDFLAGS = @LDFLAGS@
+-LIBOBJS = @LIBOBJS@
+-LIBS = @LIBS@
+-LTLIBOBJS = @LTLIBOBJS@
+-MAKEINFO = @MAKEINFO@
+-MKDIR_P = @MKDIR_P@
+-OBJEXT = @OBJEXT@
+-PACKAGE = @PACKAGE@
+-PACKAGE_BUGREPORT = @PACKAGE_BUGREPORT@
+-PACKAGE_NAME = @PACKAGE_NAME@
+-PACKAGE_STRING = @PACKAGE_STRING@
+-PACKAGE_TARNAME = @PACKAGE_TARNAME@
+-PACKAGE_URL = @PACKAGE_URL@
+-PACKAGE_VERSION = @PACKAGE_VERSION@
+-PATH_SEPARATOR = @PATH_SEPARATOR@
+-RANLIB = @RANLIB@
+-SDL_CFLAGS = @SDL_CFLAGS@
+-SDL_CONFIG = @SDL_CONFIG@
+-SDL_LIBS = @SDL_LIBS@
+-SET_MAKE = @SET_MAKE@
+-SHELL = @SHELL@
+-STRIP = @STRIP@
+-VERSION = @VERSION@
+-WINDRES = @WINDRES@
+-abs_builddir = @abs_builddir@
+-abs_srcdir = @abs_srcdir@
+-abs_top_builddir = @abs_top_builddir@
+-abs_top_srcdir = @abs_top_srcdir@
+-ac_ct_CC = @ac_ct_CC@
+-ac_ct_CXX = @ac_ct_CXX@
+-am__include = @am__include@
+-am__leading_dot = @am__leading_dot@
+-am__quote = @am__quote@
+-am__tar = @am__tar@
+-am__untar = @am__untar@
+-bindir = @bindir@
+-build = @build@
+-build_alias = @build_alias@
+-build_cpu = @build_cpu@
+-build_os = @build_os@
+-build_vendor = @build_vendor@
+-builddir = @builddir@
+-datadir = @datadir@
+-datarootdir = @datarootdir@
+-docdir = @docdir@
+-dvidir = @dvidir@
+-exec_prefix = @exec_prefix@
+-host = @host@
+-host_alias = @host_alias@
+-host_cpu = @host_cpu@
+-host_os = @host_os@
+-host_vendor = @host_vendor@
+-htmldir = @htmldir@
+-includedir = @includedir@
+-infodir = @infodir@
+-install_sh = @install_sh@
+-libdir = @libdir@
+-libexecdir = @libexecdir@
+-localedir = @localedir@
+-localstatedir = @localstatedir@
+-mandir = @mandir@
+-mkdir_p = @mkdir_p@
+-oldincludedir = @oldincludedir@
+-pdfdir = @pdfdir@
+-prefix = @prefix@
+-program_transform_name = @program_transform_name@
+-psdir = @psdir@
+-sbindir = @sbindir@
+-sharedstatedir = @sharedstatedir@
+-srcdir = @srcdir@
+-sysconfdir = @sysconfdir@
+-target_alias = @target_alias@
+-top_build_prefix = @top_build_prefix@
+-top_builddir = @top_builddir@
+-top_srcdir = @top_srcdir@
+-AM_CPPFLAGS = -I$(top_srcdir)/include
+-noinst_LIBRARIES = libgui_tk.a
+-libgui_tk_a_SOURCES = gui_tk.cpp gui_tk.h
+-all: all-am
+-
+-.SUFFIXES:
+-.SUFFIXES: .cpp .o .obj
+-$(srcdir)/Makefile.in:  $(srcdir)/Makefile.am  $(am__configure_deps)
+-	@for dep in $?; do \
+-	  case '$(am__configure_deps)' in \
+-	    *$$dep*) \
+-	      ( cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh ) \
+-	        && { if test -f $@; then exit 0; else break; fi; }; \
+-	      exit 1;; \
+-	  esac; \
+-	done; \
+-	echo ' cd $(top_srcdir) && $(AUTOMAKE) --gnu src/libs/gui_tk/Makefile'; \
+-	$(am__cd) $(top_srcdir) && \
+-	  $(AUTOMAKE) --gnu src/libs/gui_tk/Makefile
+-.PRECIOUS: Makefile
+-Makefile: $(srcdir)/Makefile.in $(top_builddir)/config.status
+-	@case '$?' in \
+-	  *config.status*) \
+-	    cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh;; \
+-	  *) \
+-	    echo ' cd $(top_builddir) && $(SHELL) ./config.status $(subdir)/$@ $(am__depfiles_maybe)'; \
+-	    cd $(top_builddir) && $(SHELL) ./config.status $(subdir)/$@ $(am__depfiles_maybe);; \
+-	esac;
+-
+-$(top_builddir)/config.status: $(top_srcdir)/configure $(CONFIG_STATUS_DEPENDENCIES)
+-	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
+-
+-$(top_srcdir)/configure:  $(am__configure_deps)
+-	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
+-$(ACLOCAL_M4):  $(am__aclocal_m4_deps)
+-	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
+-$(am__aclocal_m4_deps):
+-
+-clean-noinstLIBRARIES:
+-	-test -z "$(noinst_LIBRARIES)" || rm -f $(noinst_LIBRARIES)
+-libgui_tk.a: $(libgui_tk_a_OBJECTS) $(libgui_tk_a_DEPENDENCIES) 
+-	-rm -f libgui_tk.a
+-	$(libgui_tk_a_AR) libgui_tk.a $(libgui_tk_a_OBJECTS) $(libgui_tk_a_LIBADD)
+-	$(RANLIB) libgui_tk.a
+-
+-mostlyclean-compile:
+-	-rm -f *.$(OBJEXT)
+-
+-distclean-compile:
+-	-rm -f *.tab.c
+-
+-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/gui_tk.Po@am__quote@
+-
+-.cpp.o:
+-@am__fastdepCXX_TRUE@	$(CXXCOMPILE) -MT $@ -MD -MP -MF $(DEPDIR)/$*.Tpo -c -o $@ $<
+-@am__fastdepCXX_TRUE@	$(am__mv) $(DEPDIR)/$*.Tpo $(DEPDIR)/$*.Po
+-@AMDEP_TRUE@@am__fastdepCXX_FALSE@	source='$<' object='$@' libtool=no @AMDEPBACKSLASH@
+-@AMDEP_TRUE@@am__fastdepCXX_FALSE@	DEPDIR=$(DEPDIR) $(CXXDEPMODE) $(depcomp) @AMDEPBACKSLASH@
+-@am__fastdepCXX_FALSE@	$(CXXCOMPILE) -c -o $@ $<
+-
+-.cpp.obj:
+-@am__fastdepCXX_TRUE@	$(CXXCOMPILE) -MT $@ -MD -MP -MF $(DEPDIR)/$*.Tpo -c -o $@ `$(CYGPATH_W) '$<'`
+-@am__fastdepCXX_TRUE@	$(am__mv) $(DEPDIR)/$*.Tpo $(DEPDIR)/$*.Po
+-@AMDEP_TRUE@@am__fastdepCXX_FALSE@	source='$<' object='$@' libtool=no @AMDEPBACKSLASH@
+-@AMDEP_TRUE@@am__fastdepCXX_FALSE@	DEPDIR=$(DEPDIR) $(CXXDEPMODE) $(depcomp) @AMDEPBACKSLASH@
+-@am__fastdepCXX_FALSE@	$(CXXCOMPILE) -c -o $@ `$(CYGPATH_W) '$<'`
+-
+-ID: $(HEADERS) $(SOURCES) $(LISP) $(TAGS_FILES)
+-	list='$(SOURCES) $(HEADERS) $(LISP) $(TAGS_FILES)'; \
+-	unique=`for i in $$list; do \
+-	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
+-	  done | \
+-	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
+-	      END { if (nonempty) { for (i in files) print i; }; }'`; \
+-	mkid -fID $$unique
+-tags: TAGS
+-
+-TAGS:  $(HEADERS) $(SOURCES)  $(TAGS_DEPENDENCIES) \
+-		$(TAGS_FILES) $(LISP)
+-	set x; \
+-	here=`pwd`; \
+-	list='$(SOURCES) $(HEADERS)  $(LISP) $(TAGS_FILES)'; \
+-	unique=`for i in $$list; do \
+-	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
+-	  done | \
+-	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
+-	      END { if (nonempty) { for (i in files) print i; }; }'`; \
+-	shift; \
+-	if test -z "$(ETAGS_ARGS)$$*$$unique"; then :; else \
+-	  test -n "$$unique" || unique=$$empty_fix; \
+-	  if test $$# -gt 0; then \
+-	    $(ETAGS) $(ETAGSFLAGS) $(AM_ETAGSFLAGS) $(ETAGS_ARGS) \
+-	      "$$@" $$unique; \
+-	  else \
+-	    $(ETAGS) $(ETAGSFLAGS) $(AM_ETAGSFLAGS) $(ETAGS_ARGS) \
+-	      $$unique; \
+-	  fi; \
+-	fi
+-ctags: CTAGS
+-CTAGS:  $(HEADERS) $(SOURCES)  $(TAGS_DEPENDENCIES) \
+-		$(TAGS_FILES) $(LISP)
+-	list='$(SOURCES) $(HEADERS)  $(LISP) $(TAGS_FILES)'; \
+-	unique=`for i in $$list; do \
+-	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
+-	  done | \
+-	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
+-	      END { if (nonempty) { for (i in files) print i; }; }'`; \
+-	test -z "$(CTAGS_ARGS)$$unique" \
+-	  || $(CTAGS) $(CTAGSFLAGS) $(AM_CTAGSFLAGS) $(CTAGS_ARGS) \
+-	     $$unique
+-
+-GTAGS:
+-	here=`$(am__cd) $(top_builddir) && pwd` \
+-	  && $(am__cd) $(top_srcdir) \
+-	  && gtags -i $(GTAGS_ARGS) "$$here"
+-
+-distclean-tags:
+-	-rm -f TAGS ID GTAGS GRTAGS GSYMS GPATH tags
+-
+-distdir: $(DISTFILES)
+-	@srcdirstrip=`echo "$(srcdir)" | sed 's/[].[^$$\\*]/\\\\&/g'`; \
+-	topsrcdirstrip=`echo "$(top_srcdir)" | sed 's/[].[^$$\\*]/\\\\&/g'`; \
+-	list='$(DISTFILES)'; \
+-	  dist_files=`for file in $$list; do echo $$file; done | \
+-	  sed -e "s|^$$srcdirstrip/||;t" \
+-	      -e "s|^$$topsrcdirstrip/|$(top_builddir)/|;t"`; \
+-	case $$dist_files in \
+-	  */*) $(MKDIR_P) `echo "$$dist_files" | \
+-			   sed '/\//!d;s|^|$(distdir)/|;s,/[^/]*$$,,' | \
+-			   sort -u` ;; \
+-	esac; \
+-	for file in $$dist_files; do \
+-	  if test -f $$file || test -d $$file; then d=.; else d=$(srcdir); fi; \
+-	  if test -d $$d/$$file; then \
+-	    dir=`echo "/$$file" | sed -e 's,/[^/]*$$,,'`; \
+-	    if test -d "$(distdir)/$$file"; then \
+-	      find "$(distdir)/$$file" -type d ! -perm -700 -exec chmod u+rwx {} \;; \
+-	    fi; \
+-	    if test -d $(srcdir)/$$file && test $$d != $(srcdir); then \
+-	      cp -fpR $(srcdir)/$$file "$(distdir)$$dir" || exit 1; \
+-	      find "$(distdir)/$$file" -type d ! -perm -700 -exec chmod u+rwx {} \;; \
+-	    fi; \
+-	    cp -fpR $$d/$$file "$(distdir)$$dir" || exit 1; \
+-	  else \
+-	    test -f "$(distdir)/$$file" \
+-	    || cp -p $$d/$$file "$(distdir)/$$file" \
+-	    || exit 1; \
+-	  fi; \
+-	done
+-check-am: all-am
+-check: check-am
+-all-am: Makefile $(LIBRARIES)
+-installdirs:
+-install: install-am
+-install-exec: install-exec-am
+-install-data: install-data-am
+-uninstall: uninstall-am
+-
+-install-am: all-am
+-	@$(MAKE) $(AM_MAKEFLAGS) install-exec-am install-data-am
+-
+-installcheck: installcheck-am
+-install-strip:
+-	$(MAKE) $(AM_MAKEFLAGS) INSTALL_PROGRAM="$(INSTALL_STRIP_PROGRAM)" \
+-	  install_sh_PROGRAM="$(INSTALL_STRIP_PROGRAM)" INSTALL_STRIP_FLAG=-s \
+-	  `test -z '$(STRIP)' || \
+-	    echo "INSTALL_PROGRAM_ENV=STRIPPROG='$(STRIP)'"` install
+-mostlyclean-generic:
+-
+-clean-generic:
+-
+-distclean-generic:
+-	-test -z "$(CONFIG_CLEAN_FILES)" || rm -f $(CONFIG_CLEAN_FILES)
+-	-test . = "$(srcdir)" || test -z "$(CONFIG_CLEAN_VPATH_FILES)" || rm -f $(CONFIG_CLEAN_VPATH_FILES)
+-
+-maintainer-clean-generic:
+-	@echo "This command is intended for maintainers to use"
+-	@echo "it deletes files that may require special tools to rebuild."
+-clean: clean-am
+-
+-clean-am: clean-generic clean-noinstLIBRARIES mostlyclean-am
+-
+-distclean: distclean-am
+-	-rm -rf ./$(DEPDIR)
+-	-rm -f Makefile
+-distclean-am: clean-am distclean-compile distclean-generic \
+-	distclean-tags
+-
+-dvi: dvi-am
+-
+-dvi-am:
+-
+-html: html-am
+-
+-html-am:
+-
+-info: info-am
+-
+-info-am:
+-
+-install-data-am:
+-
+-install-dvi: install-dvi-am
+-
+-install-dvi-am:
+-
+-install-exec-am:
+-
+-install-html: install-html-am
+-
+-install-html-am:
+-
+-install-info: install-info-am
+-
+-install-info-am:
+-
+-install-man:
+-
+-install-pdf: install-pdf-am
+-
+-install-pdf-am:
+-
+-install-ps: install-ps-am
+-
+-install-ps-am:
+-
+-installcheck-am:
+-
+-maintainer-clean: maintainer-clean-am
+-	-rm -rf ./$(DEPDIR)
+-	-rm -f Makefile
+-maintainer-clean-am: distclean-am maintainer-clean-generic
+-
+-mostlyclean: mostlyclean-am
+-
+-mostlyclean-am: mostlyclean-compile mostlyclean-generic
+-
+-pdf: pdf-am
+-
+-pdf-am:
+-
+-ps: ps-am
+-
+-ps-am:
+-
+-uninstall-am:
+-
+-.MAKE: install-am install-strip
+-
+-.PHONY: CTAGS GTAGS all all-am check check-am clean clean-generic \
+-	clean-noinstLIBRARIES ctags distclean distclean-compile \
+-	distclean-generic distclean-tags distdir dvi dvi-am html \
+-	html-am info info-am install install-am install-data \
+-	install-data-am install-dvi install-dvi-am install-exec \
+-	install-exec-am install-html install-html-am install-info \
+-	install-info-am install-man install-pdf install-pdf-am \
+-	install-ps install-ps-am install-strip installcheck \
+-	installcheck-am installdirs maintainer-clean \
+-	maintainer-clean-generic mostlyclean mostlyclean-compile \
+-	mostlyclean-generic pdf pdf-am ps ps-am tags uninstall \
+-	uninstall-am
+-
+-
+-# Tell versions [3.59,3.63) of GNU make to not export all variables.
+-# Otherwise a system limit (for SysV at least) may be exceeded.
+-.NOEXPORT:
+diff -Nur dosbox-0.74/src/libs/Makefile.in dosbox/src/libs/Makefile.in
+--- dosbox-0.74/src/libs/Makefile.in	2010-05-12 11:57:44.000000000 +0200
++++ dosbox/src/libs/Makefile.in	1970-01-01 01:00:00.000000000 +0100
+@@ -1,539 +0,0 @@
+-# Makefile.in generated by automake 1.11.1 from Makefile.am.
+-# @configure_input@
+-
+-# Copyright (C) 1994, 1995, 1996, 1997, 1998, 1999, 2000, 2001, 2002,
+-# 2003, 2004, 2005, 2006, 2007, 2008, 2009  Free Software Foundation,
+-# Inc.
+-# This Makefile.in is free software; the Free Software Foundation
+-# gives unlimited permission to copy and/or distribute it,
+-# with or without modifications, as long as this notice is preserved.
+-
+-# This program is distributed in the hope that it will be useful,
+-# but WITHOUT ANY WARRANTY, to the extent permitted by law; without
+-# even the implied warranty of MERCHANTABILITY or FITNESS FOR A
+-# PARTICULAR PURPOSE.
+-
+-@SET_MAKE@
+-VPATH = @srcdir@
+-pkgdatadir = $(datadir)/@PACKAGE@
+-pkgincludedir = $(includedir)/@PACKAGE@
+-pkglibdir = $(libdir)/@PACKAGE@
+-pkglibexecdir = $(libexecdir)/@PACKAGE@
+-am__cd = CDPATH="$${ZSH_VERSION+.}$(PATH_SEPARATOR)" && cd
+-install_sh_DATA = $(install_sh) -c -m 644
+-install_sh_PROGRAM = $(install_sh) -c
+-install_sh_SCRIPT = $(install_sh) -c
+-INSTALL_HEADER = $(INSTALL_DATA)
+-transform = $(program_transform_name)
+-NORMAL_INSTALL = :
+-PRE_INSTALL = :
+-POST_INSTALL = :
+-NORMAL_UNINSTALL = :
+-PRE_UNINSTALL = :
+-POST_UNINSTALL = :
+-build_triplet = @build@
+-host_triplet = @host@
+-subdir = src/libs
+-DIST_COMMON = $(srcdir)/Makefile.am $(srcdir)/Makefile.in
+-ACLOCAL_M4 = $(top_srcdir)/aclocal.m4
+-am__aclocal_m4_deps = $(top_srcdir)/acinclude.m4 \
+-	$(top_srcdir)/configure.in
+-am__configure_deps = $(am__aclocal_m4_deps) $(CONFIGURE_DEPENDENCIES) \
+-	$(ACLOCAL_M4)
+-mkinstalldirs = $(install_sh) -d
+-CONFIG_HEADER = $(top_builddir)/config.h
+-CONFIG_CLEAN_FILES =
+-CONFIG_CLEAN_VPATH_FILES =
+-SOURCES =
+-DIST_SOURCES =
+-RECURSIVE_TARGETS = all-recursive check-recursive dvi-recursive \
+-	html-recursive info-recursive install-data-recursive \
+-	install-dvi-recursive install-exec-recursive \
+-	install-html-recursive install-info-recursive \
+-	install-pdf-recursive install-ps-recursive install-recursive \
+-	installcheck-recursive installdirs-recursive pdf-recursive \
+-	ps-recursive uninstall-recursive
+-RECURSIVE_CLEAN_TARGETS = mostlyclean-recursive clean-recursive	\
+-  distclean-recursive maintainer-clean-recursive
+-AM_RECURSIVE_TARGETS = $(RECURSIVE_TARGETS:-recursive=) \
+-	$(RECURSIVE_CLEAN_TARGETS:-recursive=) tags TAGS ctags CTAGS \
+-	distdir
+-ETAGS = etags
+-CTAGS = ctags
+-DIST_SUBDIRS = $(SUBDIRS)
+-DISTFILES = $(DIST_COMMON) $(DIST_SOURCES) $(TEXINFOS) $(EXTRA_DIST)
+-am__relativize = \
+-  dir0=`pwd`; \
+-  sed_first='s,^\([^/]*\)/.*$$,\1,'; \
+-  sed_rest='s,^[^/]*/*,,'; \
+-  sed_last='s,^.*/\([^/]*\)$$,\1,'; \
+-  sed_butlast='s,/*[^/]*$$,,'; \
+-  while test -n "$$dir1"; do \
+-    first=`echo "$$dir1" | sed -e "$$sed_first"`; \
+-    if test "$$first" != "."; then \
+-      if test "$$first" = ".."; then \
+-        dir2=`echo "$$dir0" | sed -e "$$sed_last"`/"$$dir2"; \
+-        dir0=`echo "$$dir0" | sed -e "$$sed_butlast"`; \
+-      else \
+-        first2=`echo "$$dir2" | sed -e "$$sed_first"`; \
+-        if test "$$first2" = "$$first"; then \
+-          dir2=`echo "$$dir2" | sed -e "$$sed_rest"`; \
+-        else \
+-          dir2="../$$dir2"; \
+-        fi; \
+-        dir0="$$dir0"/"$$first"; \
+-      fi; \
+-    fi; \
+-    dir1=`echo "$$dir1" | sed -e "$$sed_rest"`; \
+-  done; \
+-  reldir="$$dir2"
+-ACLOCAL = @ACLOCAL@
+-ALSA_CFLAGS = @ALSA_CFLAGS@
+-ALSA_LIBS = @ALSA_LIBS@
+-AMTAR = @AMTAR@
+-AUTOCONF = @AUTOCONF@
+-AUTOHEADER = @AUTOHEADER@
+-AUTOMAKE = @AUTOMAKE@
+-AWK = @AWK@
+-CC = @CC@
+-CCDEPMODE = @CCDEPMODE@
+-CFLAGS = @CFLAGS@
+-CPP = @CPP@
+-CPPFLAGS = @CPPFLAGS@
+-CXX = @CXX@
+-CXXDEPMODE = @CXXDEPMODE@
+-CXXFLAGS = @CXXFLAGS@
+-CYGPATH_W = @CYGPATH_W@
+-DEFS = @DEFS@
+-DEPDIR = @DEPDIR@
+-ECHO_C = @ECHO_C@
+-ECHO_N = @ECHO_N@
+-ECHO_T = @ECHO_T@
+-EGREP = @EGREP@
+-EXEEXT = @EXEEXT@
+-GREP = @GREP@
+-INSTALL = @INSTALL@
+-INSTALL_DATA = @INSTALL_DATA@
+-INSTALL_PROGRAM = @INSTALL_PROGRAM@
+-INSTALL_SCRIPT = @INSTALL_SCRIPT@
+-INSTALL_STRIP_PROGRAM = @INSTALL_STRIP_PROGRAM@
+-LDFLAGS = @LDFLAGS@
+-LIBOBJS = @LIBOBJS@
+-LIBS = @LIBS@
+-LTLIBOBJS = @LTLIBOBJS@
+-MAKEINFO = @MAKEINFO@
+-MKDIR_P = @MKDIR_P@
+-OBJEXT = @OBJEXT@
+-PACKAGE = @PACKAGE@
+-PACKAGE_BUGREPORT = @PACKAGE_BUGREPORT@
+-PACKAGE_NAME = @PACKAGE_NAME@
+-PACKAGE_STRING = @PACKAGE_STRING@
+-PACKAGE_TARNAME = @PACKAGE_TARNAME@
+-PACKAGE_URL = @PACKAGE_URL@
+-PACKAGE_VERSION = @PACKAGE_VERSION@
+-PATH_SEPARATOR = @PATH_SEPARATOR@
+-RANLIB = @RANLIB@
+-SDL_CFLAGS = @SDL_CFLAGS@
+-SDL_CONFIG = @SDL_CONFIG@
+-SDL_LIBS = @SDL_LIBS@
+-SET_MAKE = @SET_MAKE@
+-SHELL = @SHELL@
+-STRIP = @STRIP@
+-VERSION = @VERSION@
+-WINDRES = @WINDRES@
+-abs_builddir = @abs_builddir@
+-abs_srcdir = @abs_srcdir@
+-abs_top_builddir = @abs_top_builddir@
+-abs_top_srcdir = @abs_top_srcdir@
+-ac_ct_CC = @ac_ct_CC@
+-ac_ct_CXX = @ac_ct_CXX@
+-am__include = @am__include@
+-am__leading_dot = @am__leading_dot@
+-am__quote = @am__quote@
+-am__tar = @am__tar@
+-am__untar = @am__untar@
+-bindir = @bindir@
+-build = @build@
+-build_alias = @build_alias@
+-build_cpu = @build_cpu@
+-build_os = @build_os@
+-build_vendor = @build_vendor@
+-builddir = @builddir@
+-datadir = @datadir@
+-datarootdir = @datarootdir@
+-docdir = @docdir@
+-dvidir = @dvidir@
+-exec_prefix = @exec_prefix@
+-host = @host@
+-host_alias = @host_alias@
+-host_cpu = @host_cpu@
+-host_os = @host_os@
+-host_vendor = @host_vendor@
+-htmldir = @htmldir@
+-includedir = @includedir@
+-infodir = @infodir@
+-install_sh = @install_sh@
+-libdir = @libdir@
+-libexecdir = @libexecdir@
+-localedir = @localedir@
+-localstatedir = @localstatedir@
+-mandir = @mandir@
+-mkdir_p = @mkdir_p@
+-oldincludedir = @oldincludedir@
+-pdfdir = @pdfdir@
+-prefix = @prefix@
+-program_transform_name = @program_transform_name@
+-psdir = @psdir@
+-sbindir = @sbindir@
+-sharedstatedir = @sharedstatedir@
+-srcdir = @srcdir@
+-sysconfdir = @sysconfdir@
+-target_alias = @target_alias@
+-top_build_prefix = @top_build_prefix@
+-top_builddir = @top_builddir@
+-top_srcdir = @top_srcdir@
+-AM_CPPFLAGS = -I$(top_srcdir)/include
+-SUBDIRS = zmbv gui_tk
+-all: all-recursive
+-
+-.SUFFIXES:
+-$(srcdir)/Makefile.in:  $(srcdir)/Makefile.am  $(am__configure_deps)
+-	@for dep in $?; do \
+-	  case '$(am__configure_deps)' in \
+-	    *$$dep*) \
+-	      ( cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh ) \
+-	        && { if test -f $@; then exit 0; else break; fi; }; \
+-	      exit 1;; \
+-	  esac; \
+-	done; \
+-	echo ' cd $(top_srcdir) && $(AUTOMAKE) --gnu src/libs/Makefile'; \
+-	$(am__cd) $(top_srcdir) && \
+-	  $(AUTOMAKE) --gnu src/libs/Makefile
+-.PRECIOUS: Makefile
+-Makefile: $(srcdir)/Makefile.in $(top_builddir)/config.status
+-	@case '$?' in \
+-	  *config.status*) \
+-	    cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh;; \
+-	  *) \
+-	    echo ' cd $(top_builddir) && $(SHELL) ./config.status $(subdir)/$@ $(am__depfiles_maybe)'; \
+-	    cd $(top_builddir) && $(SHELL) ./config.status $(subdir)/$@ $(am__depfiles_maybe);; \
+-	esac;
+-
+-$(top_builddir)/config.status: $(top_srcdir)/configure $(CONFIG_STATUS_DEPENDENCIES)
+-	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
+-
+-$(top_srcdir)/configure:  $(am__configure_deps)
+-	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
+-$(ACLOCAL_M4):  $(am__aclocal_m4_deps)
+-	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
+-$(am__aclocal_m4_deps):
+-
+-# This directory's subdirectories are mostly independent; you can cd
+-# into them and run `make' without going through this Makefile.
+-# To change the values of `make' variables: instead of editing Makefiles,
+-# (1) if the variable is set in `config.status', edit `config.status'
+-#     (which will cause the Makefiles to be regenerated when you run `make');
+-# (2) otherwise, pass the desired values on the `make' command line.
+-$(RECURSIVE_TARGETS):
+-	@fail= failcom='exit 1'; \
+-	for f in x $$MAKEFLAGS; do \
+-	  case $$f in \
+-	    *=* | --[!k]*);; \
+-	    *k*) failcom='fail=yes';; \
+-	  esac; \
+-	done; \
+-	dot_seen=no; \
+-	target=`echo $@ | sed s/-recursive//`; \
+-	list='$(SUBDIRS)'; for subdir in $$list; do \
+-	  echo "Making $$target in $$subdir"; \
+-	  if test "$$subdir" = "."; then \
+-	    dot_seen=yes; \
+-	    local_target="$$target-am"; \
+-	  else \
+-	    local_target="$$target"; \
+-	  fi; \
+-	  ($(am__cd) $$subdir && $(MAKE) $(AM_MAKEFLAGS) $$local_target) \
+-	  || eval $$failcom; \
+-	done; \
+-	if test "$$dot_seen" = "no"; then \
+-	  $(MAKE) $(AM_MAKEFLAGS) "$$target-am" || exit 1; \
+-	fi; test -z "$$fail"
+-
+-$(RECURSIVE_CLEAN_TARGETS):
+-	@fail= failcom='exit 1'; \
+-	for f in x $$MAKEFLAGS; do \
+-	  case $$f in \
+-	    *=* | --[!k]*);; \
+-	    *k*) failcom='fail=yes';; \
+-	  esac; \
+-	done; \
+-	dot_seen=no; \
+-	case "$@" in \
+-	  distclean-* | maintainer-clean-*) list='$(DIST_SUBDIRS)' ;; \
+-	  *) list='$(SUBDIRS)' ;; \
+-	esac; \
+-	rev=''; for subdir in $$list; do \
+-	  if test "$$subdir" = "."; then :; else \
+-	    rev="$$subdir $$rev"; \
+-	  fi; \
+-	done; \
+-	rev="$$rev ."; \
+-	target=`echo $@ | sed s/-recursive//`; \
+-	for subdir in $$rev; do \
+-	  echo "Making $$target in $$subdir"; \
+-	  if test "$$subdir" = "."; then \
+-	    local_target="$$target-am"; \
+-	  else \
+-	    local_target="$$target"; \
+-	  fi; \
+-	  ($(am__cd) $$subdir && $(MAKE) $(AM_MAKEFLAGS) $$local_target) \
+-	  || eval $$failcom; \
+-	done && test -z "$$fail"
+-tags-recursive:
+-	list='$(SUBDIRS)'; for subdir in $$list; do \
+-	  test "$$subdir" = . || ($(am__cd) $$subdir && $(MAKE) $(AM_MAKEFLAGS) tags); \
+-	done
+-ctags-recursive:
+-	list='$(SUBDIRS)'; for subdir in $$list; do \
+-	  test "$$subdir" = . || ($(am__cd) $$subdir && $(MAKE) $(AM_MAKEFLAGS) ctags); \
+-	done
+-
+-ID: $(HEADERS) $(SOURCES) $(LISP) $(TAGS_FILES)
+-	list='$(SOURCES) $(HEADERS) $(LISP) $(TAGS_FILES)'; \
+-	unique=`for i in $$list; do \
+-	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
+-	  done | \
+-	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
+-	      END { if (nonempty) { for (i in files) print i; }; }'`; \
+-	mkid -fID $$unique
+-tags: TAGS
+-
+-TAGS: tags-recursive $(HEADERS) $(SOURCES)  $(TAGS_DEPENDENCIES) \
+-		$(TAGS_FILES) $(LISP)
+-	set x; \
+-	here=`pwd`; \
+-	if ($(ETAGS) --etags-include --version) >/dev/null 2>&1; then \
+-	  include_option=--etags-include; \
+-	  empty_fix=.; \
+-	else \
+-	  include_option=--include; \
+-	  empty_fix=; \
+-	fi; \
+-	list='$(SUBDIRS)'; for subdir in $$list; do \
+-	  if test "$$subdir" = .; then :; else \
+-	    test ! -f $$subdir/TAGS || \
+-	      set "$$@" "$$include_option=$$here/$$subdir/TAGS"; \
+-	  fi; \
+-	done; \
+-	list='$(SOURCES) $(HEADERS)  $(LISP) $(TAGS_FILES)'; \
+-	unique=`for i in $$list; do \
+-	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
+-	  done | \
+-	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
+-	      END { if (nonempty) { for (i in files) print i; }; }'`; \
+-	shift; \
+-	if test -z "$(ETAGS_ARGS)$$*$$unique"; then :; else \
+-	  test -n "$$unique" || unique=$$empty_fix; \
+-	  if test $$# -gt 0; then \
+-	    $(ETAGS) $(ETAGSFLAGS) $(AM_ETAGSFLAGS) $(ETAGS_ARGS) \
+-	      "$$@" $$unique; \
+-	  else \
+-	    $(ETAGS) $(ETAGSFLAGS) $(AM_ETAGSFLAGS) $(ETAGS_ARGS) \
+-	      $$unique; \
+-	  fi; \
+-	fi
+-ctags: CTAGS
+-CTAGS: ctags-recursive $(HEADERS) $(SOURCES)  $(TAGS_DEPENDENCIES) \
+-		$(TAGS_FILES) $(LISP)
+-	list='$(SOURCES) $(HEADERS)  $(LISP) $(TAGS_FILES)'; \
+-	unique=`for i in $$list; do \
+-	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
+-	  done | \
+-	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
+-	      END { if (nonempty) { for (i in files) print i; }; }'`; \
+-	test -z "$(CTAGS_ARGS)$$unique" \
+-	  || $(CTAGS) $(CTAGSFLAGS) $(AM_CTAGSFLAGS) $(CTAGS_ARGS) \
+-	     $$unique
+-
+-GTAGS:
+-	here=`$(am__cd) $(top_builddir) && pwd` \
+-	  && $(am__cd) $(top_srcdir) \
+-	  && gtags -i $(GTAGS_ARGS) "$$here"
+-
+-distclean-tags:
+-	-rm -f TAGS ID GTAGS GRTAGS GSYMS GPATH tags
+-
+-distdir: $(DISTFILES)
+-	@srcdirstrip=`echo "$(srcdir)" | sed 's/[].[^$$\\*]/\\\\&/g'`; \
+-	topsrcdirstrip=`echo "$(top_srcdir)" | sed 's/[].[^$$\\*]/\\\\&/g'`; \
+-	list='$(DISTFILES)'; \
+-	  dist_files=`for file in $$list; do echo $$file; done | \
+-	  sed -e "s|^$$srcdirstrip/||;t" \
+-	      -e "s|^$$topsrcdirstrip/|$(top_builddir)/|;t"`; \
+-	case $$dist_files in \
+-	  */*) $(MKDIR_P) `echo "$$dist_files" | \
+-			   sed '/\//!d;s|^|$(distdir)/|;s,/[^/]*$$,,' | \
+-			   sort -u` ;; \
+-	esac; \
+-	for file in $$dist_files; do \
+-	  if test -f $$file || test -d $$file; then d=.; else d=$(srcdir); fi; \
+-	  if test -d $$d/$$file; then \
+-	    dir=`echo "/$$file" | sed -e 's,/[^/]*$$,,'`; \
+-	    if test -d "$(distdir)/$$file"; then \
+-	      find "$(distdir)/$$file" -type d ! -perm -700 -exec chmod u+rwx {} \;; \
+-	    fi; \
+-	    if test -d $(srcdir)/$$file && test $$d != $(srcdir); then \
+-	      cp -fpR $(srcdir)/$$file "$(distdir)$$dir" || exit 1; \
+-	      find "$(distdir)/$$file" -type d ! -perm -700 -exec chmod u+rwx {} \;; \
+-	    fi; \
+-	    cp -fpR $$d/$$file "$(distdir)$$dir" || exit 1; \
+-	  else \
+-	    test -f "$(distdir)/$$file" \
+-	    || cp -p $$d/$$file "$(distdir)/$$file" \
+-	    || exit 1; \
+-	  fi; \
+-	done
+-	@list='$(DIST_SUBDIRS)'; for subdir in $$list; do \
+-	  if test "$$subdir" = .; then :; else \
+-	    test -d "$(distdir)/$$subdir" \
+-	    || $(MKDIR_P) "$(distdir)/$$subdir" \
+-	    || exit 1; \
+-	  fi; \
+-	done
+-	@list='$(DIST_SUBDIRS)'; for subdir in $$list; do \
+-	  if test "$$subdir" = .; then :; else \
+-	    dir1=$$subdir; dir2="$(distdir)/$$subdir"; \
+-	    $(am__relativize); \
+-	    new_distdir=$$reldir; \
+-	    dir1=$$subdir; dir2="$(top_distdir)"; \
+-	    $(am__relativize); \
+-	    new_top_distdir=$$reldir; \
+-	    echo " (cd $$subdir && $(MAKE) $(AM_MAKEFLAGS) top_distdir="$$new_top_distdir" distdir="$$new_distdir" \\"; \
+-	    echo "     am__remove_distdir=: am__skip_length_check=: am__skip_mode_fix=: distdir)"; \
+-	    ($(am__cd) $$subdir && \
+-	      $(MAKE) $(AM_MAKEFLAGS) \
+-	        top_distdir="$$new_top_distdir" \
+-	        distdir="$$new_distdir" \
+-		am__remove_distdir=: \
+-		am__skip_length_check=: \
+-		am__skip_mode_fix=: \
+-	        distdir) \
+-	      || exit 1; \
+-	  fi; \
+-	done
+-check-am: all-am
+-check: check-recursive
+-all-am: Makefile
+-installdirs: installdirs-recursive
+-installdirs-am:
+-install: install-recursive
+-install-exec: install-exec-recursive
+-install-data: install-data-recursive
+-uninstall: uninstall-recursive
+-
+-install-am: all-am
+-	@$(MAKE) $(AM_MAKEFLAGS) install-exec-am install-data-am
+-
+-installcheck: installcheck-recursive
+-install-strip:
+-	$(MAKE) $(AM_MAKEFLAGS) INSTALL_PROGRAM="$(INSTALL_STRIP_PROGRAM)" \
+-	  install_sh_PROGRAM="$(INSTALL_STRIP_PROGRAM)" INSTALL_STRIP_FLAG=-s \
+-	  `test -z '$(STRIP)' || \
+-	    echo "INSTALL_PROGRAM_ENV=STRIPPROG='$(STRIP)'"` install
+-mostlyclean-generic:
+-
+-clean-generic:
+-
+-distclean-generic:
+-	-test -z "$(CONFIG_CLEAN_FILES)" || rm -f $(CONFIG_CLEAN_FILES)
+-	-test . = "$(srcdir)" || test -z "$(CONFIG_CLEAN_VPATH_FILES)" || rm -f $(CONFIG_CLEAN_VPATH_FILES)
+-
+-maintainer-clean-generic:
+-	@echo "This command is intended for maintainers to use"
+-	@echo "it deletes files that may require special tools to rebuild."
+-clean: clean-recursive
+-
+-clean-am: clean-generic mostlyclean-am
+-
+-distclean: distclean-recursive
+-	-rm -f Makefile
+-distclean-am: clean-am distclean-generic distclean-tags
+-
+-dvi: dvi-recursive
+-
+-dvi-am:
+-
+-html: html-recursive
+-
+-html-am:
+-
+-info: info-recursive
+-
+-info-am:
+-
+-install-data-am:
+-
+-install-dvi: install-dvi-recursive
+-
+-install-dvi-am:
+-
+-install-exec-am:
+-
+-install-html: install-html-recursive
+-
+-install-html-am:
+-
+-install-info: install-info-recursive
+-
+-install-info-am:
+-
+-install-man:
+-
+-install-pdf: install-pdf-recursive
+-
+-install-pdf-am:
+-
+-install-ps: install-ps-recursive
+-
+-install-ps-am:
+-
+-installcheck-am:
+-
+-maintainer-clean: maintainer-clean-recursive
+-	-rm -f Makefile
+-maintainer-clean-am: distclean-am maintainer-clean-generic
+-
+-mostlyclean: mostlyclean-recursive
+-
+-mostlyclean-am: mostlyclean-generic
+-
+-pdf: pdf-recursive
+-
+-pdf-am:
+-
+-ps: ps-recursive
+-
+-ps-am:
+-
+-uninstall-am:
+-
+-.MAKE: $(RECURSIVE_CLEAN_TARGETS) $(RECURSIVE_TARGETS) ctags-recursive \
+-	install-am install-strip tags-recursive
+-
+-.PHONY: $(RECURSIVE_CLEAN_TARGETS) $(RECURSIVE_TARGETS) CTAGS GTAGS \
+-	all all-am check check-am clean clean-generic ctags \
+-	ctags-recursive distclean distclean-generic distclean-tags \
+-	distdir dvi dvi-am html html-am info info-am install \
+-	install-am install-data install-data-am install-dvi \
+-	install-dvi-am install-exec install-exec-am install-html \
+-	install-html-am install-info install-info-am install-man \
+-	install-pdf install-pdf-am install-ps install-ps-am \
+-	install-strip installcheck installcheck-am installdirs \
+-	installdirs-am maintainer-clean maintainer-clean-generic \
+-	mostlyclean mostlyclean-generic pdf pdf-am ps ps-am tags \
+-	tags-recursive uninstall uninstall-am
+-
+-
+-# Tell versions [3.59,3.63) of GNU make to not export all variables.
+-# Otherwise a system limit (for SysV at least) may be exceeded.
+-.NOEXPORT:
+diff -Nur dosbox-0.74/src/libs/zmbv/drvproc.cpp dosbox/src/libs/zmbv/drvproc.cpp
+--- dosbox-0.74/src/libs/zmbv/drvproc.cpp	1970-01-01 01:00:00.000000000 +0100
++++ dosbox/src/libs/zmbv/drvproc.cpp	2014-01-12 14:43:47.000000000 +0100
+@@ -0,0 +1,212 @@
++/*
++ *  Copyright (C) 2002-2013  The DOSBox Team
++ *
++ *  This program is free software; you can redistribute it and/or modify
++ *  it under the terms of the GNU General Public License as published by
++ *  the Free Software Foundation; either version 2 of the License, or
++ *  (at your option) any later version.
++ *
++ *  This program is distributed in the hope that it will be useful,
++ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
++ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
++ *  GNU General Public License for more details.
++ *
++ *  You should have received a copy of the GNU General Public License
++ *  along with this program; if not, write to the Free Software
++ *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
++ */
++//
++// Zipped Motion Block Video
++//
++// Based on Huffyuv by Ben Rudiak-Gould.
++// which was based on MSYUV sample code, which is:
++// Copyright (c) 1993 Microsoft Corporation.
++// All Rights Reserved.
++//
++
++#include "zmbv_vfw.h"
++
++/***************************************************************************
++ * DriverProc  -  The entry point for an installable driver.
++ *
++ * PARAMETERS
++ * dwDriverId:  For most messages, <dwDriverId> is the DWORD
++ *     value that the driver returns in response to a <DRV_OPEN> message.
++ *     Each time that the driver is opened, through the <DrvOpen> API,
++ *     the driver receives a <DRV_OPEN> message and can return an
++ *     arbitrary, non-zero value. The installable driver interface
++ *     saves this value and returns a unique driver handle to the
++ *     application. Whenever the application sends a message to the
++ *     driver using the driver handle, the interface routes the message
++ *     to this entry point and passes the corresponding <dwDriverId>.
++ *     This mechanism allows the driver to use the same or different
++ *     identifiers for multiple opens but ensures that driver handles
++ *     are unique at the application interface layer.
++ *
++ *     The following messages are not related to a particular open
++ *     instance of the driver. For these messages, the dwDriverId
++ *     will always be zero.
++ *
++ *         DRV_LOAD, DRV_FREE, DRV_ENABLE, DRV_DISABLE, DRV_OPEN
++ *
++ * hDriver: This is the handle returned to the application by the
++ *    driver interface.
++ *
++ * uiMessage: The requested action to be performed. Message
++ *     values below <DRV_RESERVED> are used for globally defined messages.
++ *     Message values from <DRV_RESERVED> to <DRV_USER> are used for
++ *     defined driver protocols. Messages above <DRV_USER> are used
++ *     for driver specific messages.
++ *
++ * lParam1: Data for this message.  Defined separately for
++ *     each message
++ *
++ * lParam2: Data for this message.  Defined separately for
++ *     each message
++ *
++ * RETURNS
++ *   Defined separately for each message.
++ *
++ ***************************************************************************/
++LRESULT PASCAL DriverProc(DWORD dwDriverID, HDRVR hDriver, UINT uiMessage, LPARAM lParam1, LPARAM lParam2) {
++  CodecInst* pi = (CodecInst*)dwDriverID;
++
++  switch (uiMessage) {
++    case DRV_LOAD:
++      return (LRESULT)1L;
++
++    case DRV_FREE:
++      return (LRESULT)1L;
++
++    case DRV_OPEN:
++      // GAAH! This used to return a pointer to 0xFFFF0000 when lParam==0!
++      return (LRESULT)(DWORD)(UINT) Open((ICOPEN*) lParam2);
++
++    case DRV_CLOSE:
++      if (pi) Close(pi);
++      return (LRESULT)1L;
++
++    /*********************************************************************
++
++      state messages
++
++    *********************************************************************/
++
++    // cwk
++    case DRV_QUERYCONFIGURE:    // configuration from drivers applet
++      return (LRESULT)1L;
++
++    case DRV_CONFIGURE:
++      pi->Configure((HWND)lParam1);
++      return DRV_OK;
++
++    case ICM_CONFIGURE:
++      //
++      //  return ICERR_OK if you will do a configure box, error otherwise
++      //
++      if (lParam1 == -1)
++        return pi->QueryConfigure() ? ICERR_OK : ICERR_UNSUPPORTED;
++      else
++        return pi->Configure((HWND)lParam1);
++
++    case ICM_ABOUT:
++      //
++      //  return ICERR_OK if you will do a about box, error otherwise
++      //
++      if (lParam1 == -1)
++        return pi->QueryAbout() ? ICERR_OK : ICERR_UNSUPPORTED;
++      else
++        return pi->About((HWND)lParam1);
++
++    case ICM_GETSTATE:
++      return pi->GetState((LPVOID)lParam1, (DWORD)lParam2);
++
++    case ICM_SETSTATE:
++      return pi->SetState((LPVOID)lParam1, (DWORD)lParam2);
++
++    case ICM_GETINFO:
++      return pi->GetInfo((ICINFO*)lParam1, (DWORD)lParam2);
++
++    case ICM_GETDEFAULTQUALITY:
++      if (lParam1) {
++        *((LPDWORD)lParam1) = 10000;
++        return ICERR_OK;
++      }
++      break;
++
++    /*********************************************************************
++
++      compression messages
++
++    *********************************************************************/
++
++    case ICM_COMPRESS_QUERY:
++      return pi->CompressQuery((LPBITMAPINFOHEADER)lParam1, (LPBITMAPINFOHEADER)lParam2);
++
++    case ICM_COMPRESS_BEGIN:
++      return pi->CompressBegin((LPBITMAPINFOHEADER)lParam1, (LPBITMAPINFOHEADER)lParam2);
++
++    case ICM_COMPRESS_GET_FORMAT:
++      return pi->CompressGetFormat((LPBITMAPINFOHEADER)lParam1, (LPBITMAPINFOHEADER)lParam2);
++
++    case ICM_COMPRESS_GET_SIZE:
++      return pi->CompressGetSize((LPBITMAPINFOHEADER)lParam1, (LPBITMAPINFOHEADER)lParam2);
++
++    case ICM_COMPRESS:
++      return pi->Compress((ICCOMPRESS*)lParam1, (DWORD)lParam2);
++
++    case ICM_COMPRESS_END:
++      return pi->CompressEnd();
++
++    /*********************************************************************
++
++      decompress messages
++
++    *********************************************************************/
++
++    case ICM_DECOMPRESS_QUERY:
++      return pi->DecompressQuery((LPBITMAPINFOHEADER)lParam1, (LPBITMAPINFOHEADER)lParam2);
++
++    case ICM_DECOMPRESS_BEGIN:
++      return pi->DecompressBegin((LPBITMAPINFOHEADER)lParam1, (LPBITMAPINFOHEADER)lParam2);
++
++    case ICM_DECOMPRESS_GET_FORMAT:
++      return pi->DecompressGetFormat((LPBITMAPINFOHEADER)lParam1, (LPBITMAPINFOHEADER)lParam2);
++
++    case ICM_DECOMPRESS_GET_PALETTE:
++      return pi->DecompressGetPalette((LPBITMAPINFOHEADER)lParam1, (LPBITMAPINFOHEADER)lParam2);
++
++    case ICM_DECOMPRESS:
++      return pi->Decompress((ICDECOMPRESS*)lParam1, (DWORD)lParam2);
++
++    case ICM_DECOMPRESS_END:
++      return pi->DecompressEnd();
++
++    /*********************************************************************
++
++      standard driver messages
++
++    *********************************************************************/
++
++    case DRV_DISABLE:
++    case DRV_ENABLE:
++      return (LRESULT)1L;
++
++    case DRV_INSTALL:
++    case DRV_REMOVE:
++      return (LRESULT)DRV_OK;
++  }
++
++  if (uiMessage < DRV_USER)
++    return DefDriverProc(dwDriverID, hDriver, uiMessage, lParam1, lParam2);
++  else
++    return ICERR_UNSUPPORTED;
++}
++
++
++HMODULE hmoduleCodec=0;
++
++BOOL WINAPI DllMain(HINSTANCE hinstDLL, DWORD, LPVOID) {
++  hmoduleCodec = (HMODULE) hinstDLL;
++  return TRUE;
++}
+diff -Nur dosbox-0.74/src/libs/zmbv/Makefile.in dosbox/src/libs/zmbv/Makefile.in
+--- dosbox-0.74/src/libs/zmbv/Makefile.in	2010-05-12 11:57:44.000000000 +0200
++++ dosbox/src/libs/zmbv/Makefile.in	1970-01-01 01:00:00.000000000 +0100
+@@ -1,336 +0,0 @@
+-# Makefile.in generated by automake 1.11.1 from Makefile.am.
+-# @configure_input@
+-
+-# Copyright (C) 1994, 1995, 1996, 1997, 1998, 1999, 2000, 2001, 2002,
+-# 2003, 2004, 2005, 2006, 2007, 2008, 2009  Free Software Foundation,
+-# Inc.
+-# This Makefile.in is free software; the Free Software Foundation
+-# gives unlimited permission to copy and/or distribute it,
+-# with or without modifications, as long as this notice is preserved.
+-
+-# This program is distributed in the hope that it will be useful,
+-# but WITHOUT ANY WARRANTY, to the extent permitted by law; without
+-# even the implied warranty of MERCHANTABILITY or FITNESS FOR A
+-# PARTICULAR PURPOSE.
+-
+-@SET_MAKE@
+-VPATH = @srcdir@
+-pkgdatadir = $(datadir)/@PACKAGE@
+-pkgincludedir = $(includedir)/@PACKAGE@
+-pkglibdir = $(libdir)/@PACKAGE@
+-pkglibexecdir = $(libexecdir)/@PACKAGE@
+-am__cd = CDPATH="$${ZSH_VERSION+.}$(PATH_SEPARATOR)" && cd
+-install_sh_DATA = $(install_sh) -c -m 644
+-install_sh_PROGRAM = $(install_sh) -c
+-install_sh_SCRIPT = $(install_sh) -c
+-INSTALL_HEADER = $(INSTALL_DATA)
+-transform = $(program_transform_name)
+-NORMAL_INSTALL = :
+-PRE_INSTALL = :
+-POST_INSTALL = :
+-NORMAL_UNINSTALL = :
+-PRE_UNINSTALL = :
+-POST_UNINSTALL = :
+-build_triplet = @build@
+-host_triplet = @host@
+-subdir = src/libs/zmbv
+-DIST_COMMON = $(srcdir)/Makefile.am $(srcdir)/Makefile.in
+-ACLOCAL_M4 = $(top_srcdir)/aclocal.m4
+-am__aclocal_m4_deps = $(top_srcdir)/acinclude.m4 \
+-	$(top_srcdir)/configure.in
+-am__configure_deps = $(am__aclocal_m4_deps) $(CONFIGURE_DEPENDENCIES) \
+-	$(ACLOCAL_M4)
+-mkinstalldirs = $(install_sh) -d
+-CONFIG_HEADER = $(top_builddir)/config.h
+-CONFIG_CLEAN_FILES =
+-CONFIG_CLEAN_VPATH_FILES =
+-SOURCES =
+-DIST_SOURCES =
+-DISTFILES = $(DIST_COMMON) $(DIST_SOURCES) $(TEXINFOS) $(EXTRA_DIST)
+-ACLOCAL = @ACLOCAL@
+-ALSA_CFLAGS = @ALSA_CFLAGS@
+-ALSA_LIBS = @ALSA_LIBS@
+-AMTAR = @AMTAR@
+-AUTOCONF = @AUTOCONF@
+-AUTOHEADER = @AUTOHEADER@
+-AUTOMAKE = @AUTOMAKE@
+-AWK = @AWK@
+-CC = @CC@
+-CCDEPMODE = @CCDEPMODE@
+-CFLAGS = @CFLAGS@
+-CPP = @CPP@
+-CPPFLAGS = @CPPFLAGS@
+-CXX = @CXX@
+-CXXDEPMODE = @CXXDEPMODE@
+-CXXFLAGS = @CXXFLAGS@
+-CYGPATH_W = @CYGPATH_W@
+-DEFS = @DEFS@
+-DEPDIR = @DEPDIR@
+-ECHO_C = @ECHO_C@
+-ECHO_N = @ECHO_N@
+-ECHO_T = @ECHO_T@
+-EGREP = @EGREP@
+-EXEEXT = @EXEEXT@
+-GREP = @GREP@
+-INSTALL = @INSTALL@
+-INSTALL_DATA = @INSTALL_DATA@
+-INSTALL_PROGRAM = @INSTALL_PROGRAM@
+-INSTALL_SCRIPT = @INSTALL_SCRIPT@
+-INSTALL_STRIP_PROGRAM = @INSTALL_STRIP_PROGRAM@
+-LDFLAGS = @LDFLAGS@
+-LIBOBJS = @LIBOBJS@
+-LIBS = @LIBS@
+-LTLIBOBJS = @LTLIBOBJS@
+-MAKEINFO = @MAKEINFO@
+-MKDIR_P = @MKDIR_P@
+-OBJEXT = @OBJEXT@
+-PACKAGE = @PACKAGE@
+-PACKAGE_BUGREPORT = @PACKAGE_BUGREPORT@
+-PACKAGE_NAME = @PACKAGE_NAME@
+-PACKAGE_STRING = @PACKAGE_STRING@
+-PACKAGE_TARNAME = @PACKAGE_TARNAME@
+-PACKAGE_URL = @PACKAGE_URL@
+-PACKAGE_VERSION = @PACKAGE_VERSION@
+-PATH_SEPARATOR = @PATH_SEPARATOR@
+-RANLIB = @RANLIB@
+-SDL_CFLAGS = @SDL_CFLAGS@
+-SDL_CONFIG = @SDL_CONFIG@
+-SDL_LIBS = @SDL_LIBS@
+-SET_MAKE = @SET_MAKE@
+-SHELL = @SHELL@
+-STRIP = @STRIP@
+-VERSION = @VERSION@
+-WINDRES = @WINDRES@
+-abs_builddir = @abs_builddir@
+-abs_srcdir = @abs_srcdir@
+-abs_top_builddir = @abs_top_builddir@
+-abs_top_srcdir = @abs_top_srcdir@
+-ac_ct_CC = @ac_ct_CC@
+-ac_ct_CXX = @ac_ct_CXX@
+-am__include = @am__include@
+-am__leading_dot = @am__leading_dot@
+-am__quote = @am__quote@
+-am__tar = @am__tar@
+-am__untar = @am__untar@
+-bindir = @bindir@
+-build = @build@
+-build_alias = @build_alias@
+-build_cpu = @build_cpu@
+-build_os = @build_os@
+-build_vendor = @build_vendor@
+-builddir = @builddir@
+-datadir = @datadir@
+-datarootdir = @datarootdir@
+-docdir = @docdir@
+-dvidir = @dvidir@
+-exec_prefix = @exec_prefix@
+-host = @host@
+-host_alias = @host_alias@
+-host_cpu = @host_cpu@
+-host_os = @host_os@
+-host_vendor = @host_vendor@
+-htmldir = @htmldir@
+-includedir = @includedir@
+-infodir = @infodir@
+-install_sh = @install_sh@
+-libdir = @libdir@
+-libexecdir = @libexecdir@
+-localedir = @localedir@
+-localstatedir = @localstatedir@
+-mandir = @mandir@
+-mkdir_p = @mkdir_p@
+-oldincludedir = @oldincludedir@
+-pdfdir = @pdfdir@
+-prefix = @prefix@
+-program_transform_name = @program_transform_name@
+-psdir = @psdir@
+-sbindir = @sbindir@
+-sharedstatedir = @sharedstatedir@
+-srcdir = @srcdir@
+-sysconfdir = @sysconfdir@
+-target_alias = @target_alias@
+-top_build_prefix = @top_build_prefix@
+-top_builddir = @top_builddir@
+-top_srcdir = @top_srcdir@
+-EXTRA_DIST = zmbv.cpp zmbv.h
+-all: all-am
+-
+-.SUFFIXES:
+-$(srcdir)/Makefile.in:  $(srcdir)/Makefile.am  $(am__configure_deps)
+-	@for dep in $?; do \
+-	  case '$(am__configure_deps)' in \
+-	    *$$dep*) \
+-	      ( cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh ) \
+-	        && { if test -f $@; then exit 0; else break; fi; }; \
+-	      exit 1;; \
+-	  esac; \
+-	done; \
+-	echo ' cd $(top_srcdir) && $(AUTOMAKE) --gnu src/libs/zmbv/Makefile'; \
+-	$(am__cd) $(top_srcdir) && \
+-	  $(AUTOMAKE) --gnu src/libs/zmbv/Makefile
+-.PRECIOUS: Makefile
+-Makefile: $(srcdir)/Makefile.in $(top_builddir)/config.status
+-	@case '$?' in \
+-	  *config.status*) \
+-	    cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh;; \
+-	  *) \
+-	    echo ' cd $(top_builddir) && $(SHELL) ./config.status $(subdir)/$@ $(am__depfiles_maybe)'; \
+-	    cd $(top_builddir) && $(SHELL) ./config.status $(subdir)/$@ $(am__depfiles_maybe);; \
+-	esac;
+-
+-$(top_builddir)/config.status: $(top_srcdir)/configure $(CONFIG_STATUS_DEPENDENCIES)
+-	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
+-
+-$(top_srcdir)/configure:  $(am__configure_deps)
+-	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
+-$(ACLOCAL_M4):  $(am__aclocal_m4_deps)
+-	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
+-$(am__aclocal_m4_deps):
+-tags: TAGS
+-TAGS:
+-
+-ctags: CTAGS
+-CTAGS:
+-
+-
+-distdir: $(DISTFILES)
+-	@srcdirstrip=`echo "$(srcdir)" | sed 's/[].[^$$\\*]/\\\\&/g'`; \
+-	topsrcdirstrip=`echo "$(top_srcdir)" | sed 's/[].[^$$\\*]/\\\\&/g'`; \
+-	list='$(DISTFILES)'; \
+-	  dist_files=`for file in $$list; do echo $$file; done | \
+-	  sed -e "s|^$$srcdirstrip/||;t" \
+-	      -e "s|^$$topsrcdirstrip/|$(top_builddir)/|;t"`; \
+-	case $$dist_files in \
+-	  */*) $(MKDIR_P) `echo "$$dist_files" | \
+-			   sed '/\//!d;s|^|$(distdir)/|;s,/[^/]*$$,,' | \
+-			   sort -u` ;; \
+-	esac; \
+-	for file in $$dist_files; do \
+-	  if test -f $$file || test -d $$file; then d=.; else d=$(srcdir); fi; \
+-	  if test -d $$d/$$file; then \
+-	    dir=`echo "/$$file" | sed -e 's,/[^/]*$$,,'`; \
+-	    if test -d "$(distdir)/$$file"; then \
+-	      find "$(distdir)/$$file" -type d ! -perm -700 -exec chmod u+rwx {} \;; \
+-	    fi; \
+-	    if test -d $(srcdir)/$$file && test $$d != $(srcdir); then \
+-	      cp -fpR $(srcdir)/$$file "$(distdir)$$dir" || exit 1; \
+-	      find "$(distdir)/$$file" -type d ! -perm -700 -exec chmod u+rwx {} \;; \
+-	    fi; \
+-	    cp -fpR $$d/$$file "$(distdir)$$dir" || exit 1; \
+-	  else \
+-	    test -f "$(distdir)/$$file" \
+-	    || cp -p $$d/$$file "$(distdir)/$$file" \
+-	    || exit 1; \
+-	  fi; \
+-	done
+-check-am: all-am
+-check: check-am
+-all-am: Makefile
+-installdirs:
+-install: install-am
+-install-exec: install-exec-am
+-install-data: install-data-am
+-uninstall: uninstall-am
+-
+-install-am: all-am
+-	@$(MAKE) $(AM_MAKEFLAGS) install-exec-am install-data-am
+-
+-installcheck: installcheck-am
+-install-strip:
+-	$(MAKE) $(AM_MAKEFLAGS) INSTALL_PROGRAM="$(INSTALL_STRIP_PROGRAM)" \
+-	  install_sh_PROGRAM="$(INSTALL_STRIP_PROGRAM)" INSTALL_STRIP_FLAG=-s \
+-	  `test -z '$(STRIP)' || \
+-	    echo "INSTALL_PROGRAM_ENV=STRIPPROG='$(STRIP)'"` install
+-mostlyclean-generic:
+-
+-clean-generic:
+-
+-distclean-generic:
+-	-test -z "$(CONFIG_CLEAN_FILES)" || rm -f $(CONFIG_CLEAN_FILES)
+-	-test . = "$(srcdir)" || test -z "$(CONFIG_CLEAN_VPATH_FILES)" || rm -f $(CONFIG_CLEAN_VPATH_FILES)
+-
+-maintainer-clean-generic:
+-	@echo "This command is intended for maintainers to use"
+-	@echo "it deletes files that may require special tools to rebuild."
+-clean: clean-am
+-
+-clean-am: clean-generic mostlyclean-am
+-
+-distclean: distclean-am
+-	-rm -f Makefile
+-distclean-am: clean-am distclean-generic
+-
+-dvi: dvi-am
+-
+-dvi-am:
+-
+-html: html-am
+-
+-html-am:
+-
+-info: info-am
+-
+-info-am:
+-
+-install-data-am:
+-
+-install-dvi: install-dvi-am
+-
+-install-dvi-am:
+-
+-install-exec-am:
+-
+-install-html: install-html-am
+-
+-install-html-am:
+-
+-install-info: install-info-am
+-
+-install-info-am:
+-
+-install-man:
+-
+-install-pdf: install-pdf-am
+-
+-install-pdf-am:
+-
+-install-ps: install-ps-am
+-
+-install-ps-am:
+-
+-installcheck-am:
+-
+-maintainer-clean: maintainer-clean-am
+-	-rm -f Makefile
+-maintainer-clean-am: distclean-am maintainer-clean-generic
+-
+-mostlyclean: mostlyclean-am
+-
+-mostlyclean-am: mostlyclean-generic
+-
+-pdf: pdf-am
+-
+-pdf-am:
+-
+-ps: ps-am
+-
+-ps-am:
+-
+-uninstall-am:
+-
+-.MAKE: install-am install-strip
+-
+-.PHONY: all all-am check check-am clean clean-generic distclean \
+-	distclean-generic distdir dvi dvi-am html html-am info info-am \
+-	install install-am install-data install-data-am install-dvi \
+-	install-dvi-am install-exec install-exec-am install-html \
+-	install-html-am install-info install-info-am install-man \
+-	install-pdf install-pdf-am install-ps install-ps-am \
+-	install-strip installcheck installcheck-am installdirs \
+-	maintainer-clean maintainer-clean-generic mostlyclean \
+-	mostlyclean-generic pdf pdf-am ps ps-am uninstall uninstall-am
+-
+-
+-# Tell versions [3.59,3.63) of GNU make to not export all variables.
+-# Otherwise a system limit (for SysV at least) may be exceeded.
+-.NOEXPORT:
+diff -Nur dosbox-0.74/src/libs/zmbv/resource.h dosbox/src/libs/zmbv/resource.h
+--- dosbox-0.74/src/libs/zmbv/resource.h	1970-01-01 01:00:00.000000000 +0100
++++ dosbox/src/libs/zmbv/resource.h	2014-01-12 14:43:47.000000000 +0100
+@@ -0,0 +1,21 @@
++//{{NO_DEPENDENCIES}}
++// Microsoft Visual C++ generated include file.
++// Used by zmbv_vfw.rc
++//
++#define IDD_ABOUT                       101
++#define IDD_CONFIGURE                   102
++#define IDC_HOMEPAGE                    1000
++#define IDC_EMAIL                       1001
++#define IDC_SLIDER1                     1008
++
++// Next default values for new objects
++// 
++#ifdef APSTUDIO_INVOKED
++#ifndef APSTUDIO_READONLY_SYMBOLS
++#define _APS_NO_MFC                     1
++#define _APS_NEXT_RESOURCE_VALUE        103
++#define _APS_NEXT_COMMAND_VALUE         40001
++#define _APS_NEXT_CONTROL_VALUE         1009
++#define _APS_NEXT_SYMED_VALUE           101
++#endif
++#endif
+diff -Nur dosbox-0.74/src/libs/zmbv/zmbv.cpp dosbox/src/libs/zmbv/zmbv.cpp
+--- dosbox-0.74/src/libs/zmbv/zmbv.cpp	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/libs/zmbv/zmbv.cpp	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+diff -Nur dosbox-0.74/src/libs/zmbv/zmbv.def dosbox/src/libs/zmbv/zmbv.def
+--- dosbox-0.74/src/libs/zmbv/zmbv.def	1970-01-01 01:00:00.000000000 +0100
++++ dosbox/src/libs/zmbv/zmbv.def	2014-01-12 14:43:47.000000000 +0100
+@@ -0,0 +1,4 @@
++LIBRARY         ZMBV
++
++EXPORTS
++	DriverProc
+diff -Nur dosbox-0.74/src/libs/zmbv/zmbv.h dosbox/src/libs/zmbv/zmbv.h
+--- dosbox-0.74/src/libs/zmbv/zmbv.h	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/libs/zmbv/zmbv.h	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+diff -Nur dosbox-0.74/src/libs/zmbv/zmbv.inf dosbox/src/libs/zmbv/zmbv.inf
+--- dosbox-0.74/src/libs/zmbv/zmbv.inf	1970-01-01 01:00:00.000000000 +0100
++++ dosbox/src/libs/zmbv/zmbv.inf	2014-01-12 14:43:47.000000000 +0100
+@@ -0,0 +1,105 @@
++[Version]
++Signature="$CHICAGO$"
++Provider=%ZMBV_PUBLISHER%
++Class=MEDIA
++
++
++[DefaultInstall]
++CopyFiles=ZMBV.Files.Inf,ZMBV.Files.Dll
++AddReg=ZMBV.Reg9x
++UpdateInis=ZMBV.INIs
++
++[DefaultInstall.ntx86]
++CopyFiles=ZMBV.Files.Inf,ZMBV.Files.Dll
++AddReg=ZMBV.RegNTx86
++UpdateInis=ZMBV.INIs
++
++[DefaultInstall.ntamd64]
++CopyFiles=ZMBV.Files.Inf,ZMBV.Files.Dll.NTamd64
++AddReg=ZMBV.RegNTamd64
++UpdateInis=ZMBV.INIs
++
++[DefaultUnInstall]
++DelFiles=ZMBV.Files.Dll,ZMBV.Files.Inf,ZMBV.Files.Ini
++DelReg=ZMBV.Reg9x
++UpdateInis=ZMBV.INIs.Del
++
++[DefaultUnInstall.ntx86]
++DelFiles=ZMBV.Files.Dll,ZMBV.Files.Inf,ZMBV.Files.Ini
++DelReg=ZMBV.RegNTx86
++UpdateInis=ZMBV.INIs.Del
++
++[DefaultUnInstall.ntamd64]
++DelFiles=ZMBV.Files.Dll.NTamd64,ZMBV.Files.Inf,ZMBV.Files.Ini
++DelReg=ZMBV.RegNTamd64
++UpdateInis=ZMBV.INIs.Del
++
++[SourceDisksNames]
++1="Zip Motion Block Video codec","",1
++
++[SourceDisksFiles]
++ZMBV.INF=1
++
++[DestinationDirs]
++ZMBV.Files.Inf=17
++ZMBV.Files.Dll=11
++ZMBV.Files.Dll.NTamd64=10,SysWOW64
++ZMBV.Files.Ini=25
++
++[ZMBV.Files.Inf]
++zmbv.inf
++
++[ZMBV.Files.Dll]
++zmbv.dll
++
++[ZMBV.Files.Dll.NTamd64]
++zmbv.dll
++
++[ZMBV.Files.Ini]
++zmbv.ini
++
++[ZMBV.Reg9x]
++HKLM,SYSTEM\CurrentControlSet\Control\MediaResources\icm\VIDC.ZMBV,Description,,"%ZMBV_DISPLAY_NAME%"
++HKLM,SYSTEM\CurrentControlSet\Control\MediaResources\icm\VIDC.ZMBV,Driver,,"zmbv.dll"
++HKLM,SYSTEM\CurrentControlSet\Control\MediaResources\icm\VIDC.ZMBV,FriendlyName,,"%ZMBV_DISPLAY_NAME%"
++
++HKLM,Software\Microsoft\Windows\CurrentVersion\Uninstall\ZMBV
++HKLM,Software\Microsoft\Windows\CurrentVersion\Uninstall\ZMBV,DisplayName,,"%ZMBV_UNINST_DISPLAY_NAME%"
++HKLM,Software\Microsoft\Windows\CurrentVersion\Uninstall\ZMBV,UninstallString,,"rundll.exe setupx.dll,InstallHinfSection DefaultUninstall 132 %17%\ZMBV.INF"
++
++[ZMBV.RegNTx86]
++HKLM,SOFTWARE\Microsoft\Windows NT\CurrentVersion\drivers.desc,zmbv.dll,,"%ZMBV_DISPLAY_NAME%"
++HKLM,SOFTWARE\Microsoft\Windows NT\CurrentVersion\drivers32,vidc.zmbv,,zmbv.dll
++
++HKLM,SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\ZMBV
++HKLM,SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\ZMBV,DisplayName,,"%ZMBV_UNINST_DISPLAY_NAME%"
++HKLM,SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\ZMBV,Publisher,,"%ZMBV_PUBLISHER%"
++HKLM,SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\ZMBV,URLInfoAbout,,"%ZMBV_URL_HOMEPAGE%"
++HKLM,SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\ZMBV,NoRepair,0x10001,01,00,00,00
++HKLM,SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\ZMBV,NoModify,0x10001,01,00,00,00
++HKLM,SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\ZMBV,UninstallString,,"rundll32.exe setupapi,InstallHinfSection DefaultUninstall 132 %17%\ZMBV.INF"
++
++[ZMBV.RegNTamd64]
++HKLM,SOFTWARE\Wow6432Node\Microsoft\Windows NT\CurrentVersion\drivers.desc,zmbv.dll,,"%ZMBV_DISPLAY_NAME%"
++HKLM,SOFTWARE\Wow6432Node\Microsoft\Windows NT\CurrentVersion\drivers32,vidc.zmbv,,zmbv.dll
++
++HKLM,SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\ZMBV
++HKLM,SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\ZMBV,DisplayName,,"%ZMBV_UNINST_DISPLAY_NAME%"
++HKLM,SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\ZMBV,Publisher,,"%ZMBV_PUBLISHER%"
++HKLM,SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\ZMBV,URLInfoAbout,,"%ZMBV_URL_HOMEPAGE%"
++HKLM,SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\ZMBV,NoRepair,0x10001,01,00,00,00
++HKLM,SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\ZMBV,NoModify,0x10001,01,00,00,00
++HKLM,SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\ZMBV,UninstallString,,"rundll32.exe setupapi.dll,InstallHinfSection DefaultUninstall 132 %17%\ZMBV.INF"
++
++[ZMBV.INIs]
++system.ini, drivers32,, "VIDC.ZMBV=zmbv.dll"
++
++[ZMBV.INIs.Del]
++system.ini, drivers32, "VIDC.ZMBV=zmbv.dll"
++
++[Strings]
++ZMBV_PUBLISHER = "DOSBox Team"
++ZMBV_DISPLAY_NAME = "Zip Motion Block Video [ZMBV]"
++ZMBV_UNINST_DISPLAY_NAME = "Zip Motion Block Video codec (Remove Only)"
++ZMBV_URL_HOMEPAGE = "http://www.dosbox.com/"
++CODEC_INSTALLATION_FINISHED = "Zip Motion Block Video codec installation is complete."
+diff -Nur dosbox-0.74/src/libs/zmbv/zmbv.sln dosbox/src/libs/zmbv/zmbv.sln
+--- dosbox-0.74/src/libs/zmbv/zmbv.sln	1970-01-01 01:00:00.000000000 +0100
++++ dosbox/src/libs/zmbv/zmbv.sln	2014-01-12 14:43:47.000000000 +0100
+@@ -0,0 +1,21 @@
++Microsoft Visual Studio Solution File, Format Version 8.00
++Project("{8BC9CEB8-8B4A-11D0-8D11-00A0C91BC942}") = "zmbv", "zmbv.vcproj", "{619CF3F9-C373-4BD5-93DA-025F5E16F8FA}"
++	ProjectSection(ProjectDependencies) = postProject
++	EndProjectSection
++EndProject
++Global
++	GlobalSection(SolutionConfiguration) = preSolution
++		Debug = Debug
++		Release = Release
++	EndGlobalSection
++	GlobalSection(ProjectConfiguration) = postSolution
++		{619CF3F9-C373-4BD5-93DA-025F5E16F8FA}.Debug.ActiveCfg = Debug|Win32
++		{619CF3F9-C373-4BD5-93DA-025F5E16F8FA}.Debug.Build.0 = Debug|Win32
++		{619CF3F9-C373-4BD5-93DA-025F5E16F8FA}.Release.ActiveCfg = Release|Win32
++		{619CF3F9-C373-4BD5-93DA-025F5E16F8FA}.Release.Build.0 = Release|Win32
++	EndGlobalSection
++	GlobalSection(ExtensibilityGlobals) = postSolution
++	EndGlobalSection
++	GlobalSection(ExtensibilityAddIns) = postSolution
++	EndGlobalSection
++EndGlobal
+diff -Nur dosbox-0.74/src/libs/zmbv/zmbv.vcproj dosbox/src/libs/zmbv/zmbv.vcproj
+--- dosbox-0.74/src/libs/zmbv/zmbv.vcproj	1970-01-01 01:00:00.000000000 +0100
++++ dosbox/src/libs/zmbv/zmbv.vcproj	2014-01-12 14:43:47.000000000 +0100
+@@ -0,0 +1,141 @@
++<?xml version="1.0" encoding="Windows-1252"?>
++<VisualStudioProject
++	ProjectType="Visual C++"
++	Version="7.10"
++	Name="zmbv"
++	ProjectGUID="{619CF3F9-C373-4BD5-93DA-025F5E16F8FA}"
++	Keyword="Win32Proj">
++	<Platforms>
++		<Platform
++			Name="Win32"/>
++	</Platforms>
++	<Configurations>
++		<Configuration
++			Name="Debug|Win32"
++			OutputDirectory="Debug"
++			IntermediateDirectory="Debug"
++			ConfigurationType="2"
++			CharacterSet="2">
++			<Tool
++				Name="VCCLCompilerTool"
++				Optimization="0"
++				PreprocessorDefinitions="WIN32;_DEBUG;_WINDOWS"
++				MinimalRebuild="TRUE"
++				BasicRuntimeChecks="3"
++				RuntimeLibrary="5"
++				BufferSecurityCheck="TRUE"
++				UsePrecompiledHeader="0"
++				WarningLevel="3"
++				Detect64BitPortabilityProblems="TRUE"
++				DebugInformationFormat="4"/>
++			<Tool
++				Name="VCCustomBuildTool"/>
++			<Tool
++				Name="VCLinkerTool"
++				AdditionalDependencies="winmm.lib odbc32.lib odbccp32.lib zlib.lib"
++				OutputFile="$(OutDir)/zmbv.dll"
++				LinkIncremental="2"
++				ModuleDefinitionFile="zmbv.def"
++				GenerateDebugInformation="TRUE"
++				ProgramDatabaseFile="$(OutDir)/zmbv.pdb"
++				SubSystem="2"
++				TargetMachine="1"/>
++			<Tool
++				Name="VCMIDLTool"/>
++			<Tool
++				Name="VCPostBuildEventTool"/>
++			<Tool
++				Name="VCPreBuildEventTool"/>
++			<Tool
++				Name="VCPreLinkEventTool"/>
++			<Tool
++				Name="VCResourceCompilerTool"/>
++			<Tool
++				Name="VCWebServiceProxyGeneratorTool"/>
++			<Tool
++				Name="VCXMLDataGeneratorTool"/>
++			<Tool
++				Name="VCWebDeploymentTool"/>
++			<Tool
++				Name="VCManagedWrapperGeneratorTool"/>
++			<Tool
++				Name="VCAuxiliaryManagedWrapperGeneratorTool"/>
++		</Configuration>
++		<Configuration
++			Name="Release|Win32"
++			OutputDirectory="Release"
++			IntermediateDirectory="Release"
++			ConfigurationType="2"
++			CharacterSet="2">
++			<Tool
++				Name="VCCLCompilerTool"
++				PreprocessorDefinitions="WIN32;NDEBUG;_WINDOWS"
++				RuntimeLibrary="4"
++				UsePrecompiledHeader="0"
++				WarningLevel="3"
++				Detect64BitPortabilityProblems="TRUE"
++				DebugInformationFormat="3"/>
++			<Tool
++				Name="VCCustomBuildTool"/>
++			<Tool
++				Name="VCLinkerTool"
++				AdditionalDependencies="winmm.lib odbc32.lib odbccp32.lib zlib.lib"
++				OutputFile="$(OutDir)/zmbv.dll"
++				LinkIncremental="1"
++				ModuleDefinitionFile="zmbv.def"
++				GenerateDebugInformation="TRUE"
++				MapExports="TRUE"
++				SubSystem="2"
++				OptimizeReferences="2"
++				EnableCOMDATFolding="2"
++				TargetMachine="1"/>
++			<Tool
++				Name="VCMIDLTool"/>
++			<Tool
++				Name="VCPostBuildEventTool"/>
++			<Tool
++				Name="VCPreBuildEventTool"/>
++			<Tool
++				Name="VCPreLinkEventTool"/>
++			<Tool
++				Name="VCResourceCompilerTool"/>
++			<Tool
++				Name="VCWebServiceProxyGeneratorTool"/>
++			<Tool
++				Name="VCXMLDataGeneratorTool"/>
++			<Tool
++				Name="VCWebDeploymentTool"/>
++			<Tool
++				Name="VCManagedWrapperGeneratorTool"/>
++			<Tool
++				Name="VCAuxiliaryManagedWrapperGeneratorTool"/>
++		</Configuration>
++	</Configurations>
++	<References>
++	</References>
++	<Files>
++		<File
++			RelativePath=".\drvproc.cpp">
++		</File>
++		<File
++			RelativePath=".\Resource.h">
++		</File>
++		<File
++			RelativePath=".\zmbv.cpp">
++		</File>
++		<File
++			RelativePath=".\zmbv.def">
++		</File>
++		<File
++			RelativePath=".\zmbv.h">
++		</File>
++		<File
++			RelativePath=".\zmbv_vfw.cpp">
++		</File>
++		<File
++			RelativePath=".\zmbv_vfw.rc">
++		</File>
++	</Files>
++	<Globals>
++	</Globals>
++</VisualStudioProject>
+diff -Nur dosbox-0.74/src/libs/zmbv/zmbv_vfw.cpp dosbox/src/libs/zmbv/zmbv_vfw.cpp
+--- dosbox-0.74/src/libs/zmbv/zmbv_vfw.cpp	1970-01-01 01:00:00.000000000 +0100
++++ dosbox/src/libs/zmbv/zmbv_vfw.cpp	2014-01-12 14:43:47.000000000 +0100
+@@ -0,0 +1,397 @@
++/*
++ *  Copyright (C) 2002-2013  The DOSBox Team
++ *
++ *  This program is free software; you can redistribute it and/or modify
++ *  it under the terms of the GNU General Public License as published by
++ *  the Free Software Foundation; either version 2 of the License, or
++ *  (at your option) any later version.
++ *
++ *  This program is distributed in the hope that it will be useful,
++ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
++ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
++ *  GNU General Public License for more details.
++ *
++ *  You should have received a copy of the GNU General Public License
++ *  along with this program; if not, write to the Free Software
++ *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
++ */
++//
++// Zipped Motion Block Video
++//
++// Based on Huffyuv by Ben Rudiak-Gould.
++// which was based on MSYUV sample code, which is:
++// Copyright (c) 1993 Microsoft Corporation.
++// All Rights Reserved.
++//
++
++#include "zmbv_vfw.h"
++#include "resource.h"
++
++#include <crtdbg.h>
++#include <string.h>
++
++TCHAR szDescription[] = TEXT("Zipped Motion Block Video v0.1");
++TCHAR szName[]        = TEXT(CODEC_4CC);
++
++#define VERSION         0x00000001      // 0.1
++
++/********************************************************************
++********************************************************************/
++
++CodecInst *encode_table_owner, *decode_table_owner;
++
++/********************************************************************
++********************************************************************/
++
++void Msg(const char fmt[], ...) {
++  DWORD written;
++  char buf[2000];
++  va_list val;
++  
++  va_start(val, fmt);
++  wvsprintf(buf, fmt, val);
++
++  const COORD _80x50 = {80,50};
++  static BOOL startup = (AllocConsole(), SetConsoleScreenBufferSize(GetStdHandle(STD_OUTPUT_HANDLE), _80x50));
++  WriteConsole(GetStdHandle(STD_OUTPUT_HANDLE), buf, lstrlen(buf), &written, 0);
++}
++
++
++/********************************************************************
++********************************************************************/
++
++CodecInst::CodecInst() {
++	codec = 0;
++}
++
++CodecInst* Open(ICOPEN* icinfo) {
++  if (icinfo && icinfo->fccType != ICTYPE_VIDEO)
++      return NULL;
++
++  CodecInst* pinst = new CodecInst();
++
++  if (icinfo) icinfo->dwError = pinst ? ICERR_OK : ICERR_MEMORY;
++
++  return pinst;
++}
++
++DWORD Close(CodecInst* pinst) {
++//    delete pinst;       // this caused problems when deleting at app close time
++    return 1;
++}
++
++/********************************************************************
++********************************************************************/
++
++
++/********************************************************************
++********************************************************************/
++
++BOOL CodecInst::QueryAbout() { return TRUE; }
++
++static BOOL CALLBACK AboutDialogProc(HWND hwndDlg, UINT uMsg, WPARAM wParam, LPARAM lParam) {
++  if (uMsg == WM_COMMAND) {
++    switch (LOWORD(wParam)) {
++    case IDOK:
++      EndDialog(hwndDlg, 0);
++      break;
++    case IDC_HOMEPAGE:
++      ShellExecute(NULL, NULL, "http://www.dosbox.com", NULL, NULL, SW_SHOW);
++      break;
++    case IDC_EMAIL:
++      ShellExecute(NULL, NULL, "mailto:dosbox.crew@gmail.com", NULL, NULL, SW_SHOW);
++      break;
++    }
++  }
++  return FALSE;
++}
++DWORD CodecInst::About(HWND hwnd) {
++  DialogBox(hmoduleCodec, MAKEINTRESOURCE(IDD_ABOUT), hwnd, AboutDialogProc);
++  return ICERR_OK;
++}
++
++static BOOL CALLBACK ConfigureDialogProc(HWND hwndDlg, UINT uMsg, WPARAM wParam, LPARAM lParam) {
++
++  if (uMsg == WM_INITDIALOG) {
++
++  } else if (uMsg == WM_COMMAND) {
++
++    switch (LOWORD(wParam)) {
++
++    case IDOK:
++
++    case IDCANCEL:
++      EndDialog(hwndDlg, 0);
++      break;
++
++    default:
++      return AboutDialogProc(hwndDlg, uMsg, wParam, lParam);    // handle email and home-page buttons
++    }
++  }
++  return FALSE;
++}
++
++BOOL CodecInst::QueryConfigure() { return TRUE; }
++
++DWORD CodecInst::Configure(HWND hwnd) {
++  DialogBox(hmoduleCodec, MAKEINTRESOURCE(IDD_CONFIGURE), hwnd, ConfigureDialogProc);
++  return ICERR_OK;
++}
++
++
++/********************************************************************
++********************************************************************/
++
++
++// we have no state information which needs to be stored
++
++DWORD CodecInst::GetState(LPVOID pv, DWORD dwSize) { return 0; }
++
++DWORD CodecInst::SetState(LPVOID pv, DWORD dwSize) { return 0; }
++
++
++DWORD CodecInst::GetInfo(ICINFO* icinfo, DWORD dwSize) {
++  if (icinfo == NULL)
++    return sizeof(ICINFO);
++
++  if (dwSize < sizeof(ICINFO))
++    return 0;
++
++  icinfo->dwSize            = sizeof(ICINFO);
++  icinfo->fccType           = ICTYPE_VIDEO;
++  memcpy(&icinfo->fccHandler,CODEC_4CC, 4);
++  icinfo->dwFlags           = VIDCF_FASTTEMPORALC | VIDCF_FASTTEMPORALD | VIDCF_TEMPORAL;
++
++  icinfo->dwVersion         = VERSION;
++  icinfo->dwVersionICM      = ICVERSION;
++  MultiByteToWideChar(CP_ACP, 0, szDescription, -1, icinfo->szDescription, sizeof(icinfo->szDescription)/sizeof(WCHAR));
++  MultiByteToWideChar(CP_ACP, 0, szName, -1, icinfo->szName, sizeof(icinfo->szName)/sizeof(WCHAR));
++
++  return sizeof(ICINFO);
++}
++
++/********************************************************************
++****************************************************************/
++
++static int GetInputBitDepth(const BITMAPINFOHEADER *lpbiIn) {
++	if (lpbiIn->biCompression == BI_RGB) {
++		if (lpbiIn->biPlanes != 1)
++			return -1;
++
++		switch(lpbiIn->biBitCount) {
++			case 8:
++				return 8;
++			case 16:
++				return 15;		// Standard Windows 16-bit RGB is 1555.
++			case 32:
++				return 32;
++		}
++
++	} else if (lpbiIn->biCompression == BI_BITFIELDS) {
++		// BI_BITFIELDS RGB masks lie right after the BITMAPINFOHEADER structure,
++		// at (ptr+40). This is true even for a BITMAPV4HEADER or BITMAPV5HEADER.
++		const DWORD *masks = (const DWORD *)(lpbiIn + 1);
++
++		if (lpbiIn->biBitCount == 16) {
++			// Test for 16 (555)
++			if (masks[0] == 0x7C00 && masks[1] == 0x03E0 && masks[2] == 0x001F)
++				return 15;
++
++			// Test for 16 (565)
++			if (masks[0] == 0xF800 && masks[1] == 0x07E0 && masks[2] == 0x001F)
++				return 16;
++		} else if (lpbiIn->biBitCount == 32) {
++			if (masks[0] == 0xFF0000 && masks[1] == 0x00FF00 && masks[2] == 0x0000FF)
++				return 32;
++		}
++	}
++
++	return -1;
++}
++
++static bool CanCompress(LPBITMAPINFOHEADER lpbiIn, LPBITMAPINFOHEADER lpbiOut, bool requireOutput) {
++	if (lpbiIn) {
++		if (GetInputBitDepth(lpbiIn) < 0)
++			return false;
++	} else return false;
++	if (lpbiOut) {
++		if (memcmp(&lpbiOut->biCompression,CODEC_4CC, 4))
++			return false;
++	} else return !requireOutput;
++	return true;
++}
++
++/********************************************************************
++****************************************************************/
++
++DWORD CodecInst::CompressQuery(LPBITMAPINFOHEADER lpbiIn, LPBITMAPINFOHEADER lpbiOut) {
++	if (CanCompress(lpbiIn,lpbiOut,false)) return ICERR_OK;
++	return ICERR_BADFORMAT;
++}
++
++DWORD CodecInst::CompressGetFormat(LPBITMAPINFOHEADER lpbiIn, LPBITMAPINFOHEADER lpbiOut) {
++	if (!lpbiOut)
++		return sizeof(BITMAPINFOHEADER);
++	lpbiOut->biSize			= sizeof(BITMAPINFOHEADER);
++	lpbiOut->biWidth		= lpbiIn->biWidth;
++	lpbiOut->biHeight		= lpbiIn->biHeight;
++	lpbiOut->biPlanes		= 1;
++	lpbiOut->biCompression	= *(const DWORD *)CODEC_4CC;
++	lpbiOut->biBitCount		= lpbiIn->biBitCount;
++	lpbiOut->biSizeImage	= lpbiIn->biWidth * lpbiIn->biHeight * lpbiIn->biBitCount/8 + 1024;
++	lpbiOut->biXPelsPerMeter = lpbiIn->biXPelsPerMeter;
++	lpbiOut->biYPelsPerMeter = lpbiIn->biYPelsPerMeter;
++	lpbiOut->biClrUsed		= 0;
++	lpbiOut->biClrImportant	= 0;
++	return ICERR_OK;
++}
++
++DWORD CodecInst::CompressBegin(LPBITMAPINFOHEADER lpbiIn, LPBITMAPINFOHEADER lpbiOut) {
++	CompressEnd();  // free resources if necessary
++	if (!CanCompress(lpbiIn, lpbiOut, true))
++		return ICERR_BADFORMAT;
++	codec = new VideoCodec();
++	if (!codec)
++		return ICERR_MEMORY;
++	if (!codec->SetupCompress( lpbiIn->biWidth, lpbiIn->biHeight))
++		return ICERR_MEMORY;
++	return ICERR_OK;
++}
++
++DWORD CodecInst::CompressGetSize(LPBITMAPINFOHEADER lpbiIn, LPBITMAPINFOHEADER lpbiOut) {
++	if (!CanCompress(lpbiIn, lpbiOut, true))
++		return ICERR_BADFORMAT;
++	return lpbiIn->biWidth * lpbiIn->biHeight * lpbiIn->biBitCount/8 + 1024;
++}
++
++DWORD CodecInst::Compress(ICCOMPRESS* icinfo, DWORD dwSize) {
++	int i, pitch;
++	zmbv_format_t format;
++	LPBITMAPINFOHEADER lpbiIn=icinfo->lpbiInput;
++	LPBITMAPINFOHEADER lpbiOut=icinfo->lpbiOutput;
++	if (!CanCompress(lpbiIn, lpbiOut, true))
++		return ICERR_BADFORMAT;
++	if (!icinfo->lpInput || !icinfo->lpOutput)
++		return ICERR_ABORT;
++	switch (GetInputBitDepth(lpbiIn)) {
++	case 8:
++		format = ZMBV_FORMAT_8BPP;
++		pitch = lpbiIn->biWidth;
++		break;
++	case 15:
++		format = ZMBV_FORMAT_15BPP;
++		pitch = lpbiIn->biWidth * 2;
++		break;
++	case 16:
++		format = ZMBV_FORMAT_16BPP;
++		pitch = lpbiIn->biWidth * 2;
++		break;
++	case 32:
++		format = ZMBV_FORMAT_32BPP;
++		pitch = lpbiIn->biWidth * 4;
++		break;
++	}
++
++	// DIB scanlines for RGB formats are always aligned to DWORD.
++	pitch = (pitch + 3) & ~3;
++
++	// force a key frame if requested by the client
++	int flags = 0;
++	if (icinfo->dwFlags & ICCOMPRESS_KEYFRAME)
++		flags |= 1;
++
++	codec->PrepareCompressFrame( flags, format, 0, icinfo->lpOutput, 99999999);
++	char *readPt = (char *)icinfo->lpInput + pitch*(lpbiIn->biHeight - 1);
++	for(i = 0;i<lpbiIn->biHeight;i++) {
++		codec->CompressLines(1, (void **)&readPt );
++		readPt -= pitch;
++	}
++	lpbiOut->biSizeImage = codec->FinishCompressFrame();
++
++	if (flags & 1)
++		*icinfo->lpdwFlags = AVIIF_KEYFRAME;
++	else
++		*icinfo->lpdwFlags = 0;
++
++	return ICERR_OK;
++}
++
++
++DWORD CodecInst::CompressEnd() {
++	if (codec) 
++		delete codec;
++	codec = 0;
++	return ICERR_OK;
++}
++
++/********************************************************************
++********************************************************************/
++
++static bool CanDecompress(LPBITMAPINFOHEADER lpbiIn, LPBITMAPINFOHEADER lpbiOut) {
++	if (memcmp(&lpbiIn->biCompression,CODEC_4CC,4))
++		return false;
++	if (lpbiOut) {
++		if (lpbiOut->biCompression!=0) return false;
++		if (lpbiOut->biBitCount != 24) return false;
++		if (lpbiIn->biWidth!=lpbiOut->biWidth || lpbiIn->biHeight!=lpbiOut->biHeight)
++            return false;
++	}
++	return true;
++}
++
++/********************************************************************
++********************************************************************/
++
++
++DWORD CodecInst::DecompressQuery(LPBITMAPINFOHEADER lpbiIn, LPBITMAPINFOHEADER lpbiOut) {
++	return CanDecompress(lpbiIn, lpbiOut) ? ICERR_OK : ICERR_BADFORMAT;
++}
++
++DWORD CodecInst::DecompressGetFormat(LPBITMAPINFOHEADER lpbiIn, LPBITMAPINFOHEADER lpbiOut) {
++	if (memcmp(&lpbiIn->biCompression,CODEC_4CC,4))
++		 return ICERR_BADFORMAT;
++	if (!lpbiOut) return sizeof(BITMAPINFOHEADER);
++	*lpbiOut = *lpbiIn;
++	lpbiOut->biPlanes		= 1;
++	lpbiOut->biSize			= sizeof(BITMAPINFOHEADER);
++	lpbiOut->biBitCount		= 24;
++	lpbiOut->biSizeImage	= ((lpbiOut->biWidth*3 + 3) & ~3) * lpbiOut->biHeight;
++	lpbiOut->biCompression	= BI_RGB;
++	lpbiOut->biClrUsed		= 0;
++	lpbiOut->biClrImportant	= 0;
++	return ICERR_OK;
++}
++
++DWORD CodecInst::DecompressBegin(LPBITMAPINFOHEADER lpbiIn, LPBITMAPINFOHEADER lpbiOut) {
++	DecompressEnd();  // free resources if necessary
++	if (!CanDecompress(lpbiIn, lpbiOut))
++		return ICERR_BADFORMAT;
++	codec=new VideoCodec();
++	if (!codec)
++		return ICERR_MEMORY;
++	if (!codec->SetupDecompress( lpbiIn->biWidth, lpbiIn->biHeight))
++		return ICERR_MEMORY;
++	return ICERR_OK;
++}
++
++DWORD CodecInst::Decompress(ICDECOMPRESS* icinfo, DWORD dwSize) {
++	if (!codec || !icinfo)
++		return ICERR_ABORT;
++	if (codec->DecompressFrame( icinfo->lpInput, icinfo->lpbiInput->biSizeImage)) {
++		codec->Output_UpsideDown_24(icinfo->lpOutput);
++	} else return ICERR_DONTDRAW;
++	return ICERR_OK;
++}
++
++
++// palette-mapped output only
++DWORD CodecInst::DecompressGetPalette(LPBITMAPINFOHEADER lpbiIn, LPBITMAPINFOHEADER lpbiOut) {
++	return ICERR_BADFORMAT;
++}
++
++DWORD CodecInst::DecompressEnd() {
++	if (codec) 
++		delete codec;
++	codec = 0;
++	return ICERR_OK;
++}
+diff -Nur dosbox-0.74/src/libs/zmbv/zmbv_vfw.h dosbox/src/libs/zmbv/zmbv_vfw.h
+--- dosbox-0.74/src/libs/zmbv/zmbv_vfw.h	1970-01-01 01:00:00.000000000 +0100
++++ dosbox/src/libs/zmbv/zmbv_vfw.h	2014-01-12 14:43:47.000000000 +0100
+@@ -0,0 +1,61 @@
++//
++// Huffyuv v2.1.1, by Ben Rudiak-Gould.
++// http://www.math.berkeley.edu/~benrg/huffyuv.html
++//
++// This file is copyright 2000 Ben Rudiak-Gould, and distributed under
++// the terms of the GNU General Public License, v2 or later.  See
++// http://www.gnu.org/copyleft/gpl.html.
++//
++// I edit these files in 10-point Verdana, a proportionally-spaced font.
++// You may notice formatting oddities if you use a monospaced font.
++//
++
++
++#include <windows.h>
++#include <vfw.h>
++#include <zlib.h>
++#include "zmbv.h"
++#pragma hdrstop
++
++extern HMODULE hmoduleCodec;
++
++
++// huffyuv.cpp
++
++class CodecInst {
++private:
++	VideoCodec * codec;
++public:
++  CodecInst();
++  ~CodecInst();
++
++  BOOL QueryAbout();
++  DWORD About(HWND hwnd);
++
++  BOOL QueryConfigure();
++  DWORD Configure(HWND hwnd);
++
++  DWORD GetState(LPVOID pv, DWORD dwSize);
++  DWORD SetState(LPVOID pv, DWORD dwSize);
++
++  DWORD GetInfo(ICINFO* icinfo, DWORD dwSize);
++
++  DWORD CompressQuery(LPBITMAPINFOHEADER lpbiIn, LPBITMAPINFOHEADER lpbiOut);
++  DWORD CompressGetFormat(LPBITMAPINFOHEADER lpbiIn, LPBITMAPINFOHEADER lpbiOut);
++  DWORD CompressBegin(LPBITMAPINFOHEADER lpbiIn, LPBITMAPINFOHEADER lpbiOut);
++  DWORD CompressGetSize(LPBITMAPINFOHEADER lpbiIn, LPBITMAPINFOHEADER lpbiOut);
++  DWORD Compress(ICCOMPRESS* icinfo, DWORD dwSize);
++  DWORD CompressEnd();
++
++  DWORD DecompressQuery(LPBITMAPINFOHEADER lpbiIn, LPBITMAPINFOHEADER lpbiOut);
++  DWORD DecompressGetFormat(LPBITMAPINFOHEADER lpbiIn, LPBITMAPINFOHEADER lpbiOut);
++  DWORD DecompressBegin(LPBITMAPINFOHEADER lpbiIn, LPBITMAPINFOHEADER lpbiOut);
++  
++  DWORD Decompress(ICDECOMPRESS* icinfo, DWORD dwSize);
++  DWORD DecompressGetPalette(LPBITMAPINFOHEADER lpbiIn, LPBITMAPINFOHEADER lpbiOut);
++  DWORD DecompressEnd();
++};
++
++CodecInst* Open(ICOPEN* icinfo);
++DWORD Close(CodecInst* pinst);
++
+diff -Nur dosbox-0.74/src/libs/zmbv/zmbv_vfw.rc dosbox/src/libs/zmbv/zmbv_vfw.rc
+--- dosbox-0.74/src/libs/zmbv/zmbv_vfw.rc	1970-01-01 01:00:00.000000000 +0100
++++ dosbox/src/libs/zmbv/zmbv_vfw.rc	2014-01-12 14:43:47.000000000 +0100
+@@ -0,0 +1,123 @@
++// Microsoft Visual C++ generated resource script.
++//
++#include "resource.h"
++
++#define APSTUDIO_READONLY_SYMBOLS
++/////////////////////////////////////////////////////////////////////////////
++//
++// Generated from the TEXTINCLUDE 2 resource.
++//
++#include "winres.h"
++
++/////////////////////////////////////////////////////////////////////////////
++#undef APSTUDIO_READONLY_SYMBOLS
++
++/////////////////////////////////////////////////////////////////////////////
++// English (U.S.) resources
++
++#if !defined(AFX_RESOURCE_DLL) || defined(AFX_TARG_ENU)
++#ifdef _WIN32
++LANGUAGE LANG_ENGLISH, SUBLANG_ENGLISH_US
++#pragma code_page(1252)
++#endif //_WIN32
++
++#ifdef APSTUDIO_INVOKED
++/////////////////////////////////////////////////////////////////////////////
++//
++// TEXTINCLUDE
++//
++
++1 TEXTINCLUDE
++BEGIN
++    "resource.h\0"
++END
++
++2 TEXTINCLUDE
++BEGIN
++    "#include ""winres.h""\r\n"
++    "\0"
++END
++
++3 TEXTINCLUDE
++BEGIN
++    "\r\n"
++    "\0"
++END
++
++#endif    // APSTUDIO_INVOKED
++
++
++/////////////////////////////////////////////////////////////////////////////
++//
++// Dialog
++//
++
++IDD_ABOUT DIALOGEX 0, 0, 167, 55
++STYLE DS_SETFONT | DS_MODALFRAME | DS_CENTER | WS_POPUP | WS_CAPTION |
++    WS_SYSMENU
++CAPTION "DOSBox Video Codec v0.1"
++FONT 8, "MS Sans Serif", 0, 0, 0x0
++BEGIN
++    DEFPUSHBUTTON   "OK",IDOK,131,34,29,14
++    CTEXT           "Zipped Motion Block Video v 0.1\nCopyright 2009-2013 DOSBox Team",
++                    IDC_STATIC,7,7,153,25,SS_NOPREFIX
++    PUSHBUTTON      "Email author",IDC_EMAIL,7,34,50,14
++    PUSHBUTTON      "Visit home page",IDC_HOMEPAGE,59,34,58,14
++END
++
++IDD_CONFIGURE DIALOGEX 0, 0, 213, 146
++STYLE DS_SETFONT | DS_MODALFRAME | DS_CENTER | WS_POPUP | WS_CAPTION |
++    WS_SYSMENU
++CAPTION "ZMBV configuration dialog"
++FONT 8, "MS Sans Serif", 0, 0, 0x0
++BEGIN
++    PUSHBUTTON      "Email author",IDC_EMAIL,44,86,50,14
++    PUSHBUTTON      "Visit home page",IDC_HOMEPAGE,109,87,58,14
++    DEFPUSHBUTTON   "OK",IDOK,44,125,50,14
++    PUSHBUTTON      "Cancel",IDCANCEL,117,125,50,14
++    CONTROL         "",IDC_SLIDER1,"msctls_trackbar32",TBS_BOTH |
++                    TBS_NOTICKS | WS_TABSTOP,57,30,92,18
++END
++
++
++/////////////////////////////////////////////////////////////////////////////
++//
++// DESIGNINFO
++//
++
++#ifdef APSTUDIO_INVOKED
++GUIDELINES DESIGNINFO
++BEGIN
++    IDD_ABOUT, DIALOG
++    BEGIN
++        LEFTMARGIN, 7
++        RIGHTMARGIN, 160
++        TOPMARGIN, 7
++        BOTTOMMARGIN, 48
++    END
++
++    IDD_CONFIGURE, DIALOG
++    BEGIN
++        LEFTMARGIN, 44
++        RIGHTMARGIN, 167
++        TOPMARGIN, 6
++        BOTTOMMARGIN, 139
++    END
++END
++#endif    // APSTUDIO_INVOKED
++
++#endif    // English (U.S.) resources
++/////////////////////////////////////////////////////////////////////////////
++
++
++
++#ifndef APSTUDIO_INVOKED
++/////////////////////////////////////////////////////////////////////////////
++//
++// Generated from the TEXTINCLUDE 3 resource.
++//
++
++
++/////////////////////////////////////////////////////////////////////////////
++#endif    // not APSTUDIO_INVOKED
++
+diff -Nur dosbox-0.74/src/Makefile.in dosbox/src/Makefile.in
+--- dosbox-0.74/src/Makefile.in	2010-05-12 11:57:43.000000000 +0200
++++ dosbox/src/Makefile.in	1970-01-01 01:00:00.000000000 +0100
+@@ -1,640 +0,0 @@
+-# Makefile.in generated by automake 1.11.1 from Makefile.am.
+-# @configure_input@
+-
+-# Copyright (C) 1994, 1995, 1996, 1997, 1998, 1999, 2000, 2001, 2002,
+-# 2003, 2004, 2005, 2006, 2007, 2008, 2009  Free Software Foundation,
+-# Inc.
+-# This Makefile.in is free software; the Free Software Foundation
+-# gives unlimited permission to copy and/or distribute it,
+-# with or without modifications, as long as this notice is preserved.
+-
+-# This program is distributed in the hope that it will be useful,
+-# but WITHOUT ANY WARRANTY, to the extent permitted by law; without
+-# even the implied warranty of MERCHANTABILITY or FITNESS FOR A
+-# PARTICULAR PURPOSE.
+-
+-@SET_MAKE@
+-
+-VPATH = @srcdir@
+-pkgdatadir = $(datadir)/@PACKAGE@
+-pkgincludedir = $(includedir)/@PACKAGE@
+-pkglibdir = $(libdir)/@PACKAGE@
+-pkglibexecdir = $(libexecdir)/@PACKAGE@
+-am__cd = CDPATH="$${ZSH_VERSION+.}$(PATH_SEPARATOR)" && cd
+-install_sh_DATA = $(install_sh) -c -m 644
+-install_sh_PROGRAM = $(install_sh) -c
+-install_sh_SCRIPT = $(install_sh) -c
+-INSTALL_HEADER = $(INSTALL_DATA)
+-transform = $(program_transform_name)
+-NORMAL_INSTALL = :
+-PRE_INSTALL = :
+-POST_INSTALL = :
+-NORMAL_UNINSTALL = :
+-PRE_UNINSTALL = :
+-POST_UNINSTALL = :
+-build_triplet = @build@
+-host_triplet = @host@
+-bin_PROGRAMS = dosbox$(EXEEXT)
+-subdir = src
+-DIST_COMMON = $(srcdir)/Makefile.am $(srcdir)/Makefile.in
+-ACLOCAL_M4 = $(top_srcdir)/aclocal.m4
+-am__aclocal_m4_deps = $(top_srcdir)/acinclude.m4 \
+-	$(top_srcdir)/configure.in
+-am__configure_deps = $(am__aclocal_m4_deps) $(CONFIGURE_DEPENDENCIES) \
+-	$(ACLOCAL_M4)
+-mkinstalldirs = $(install_sh) -d
+-CONFIG_HEADER = $(top_builddir)/config.h
+-CONFIG_CLEAN_FILES =
+-CONFIG_CLEAN_VPATH_FILES =
+-am__installdirs = "$(DESTDIR)$(bindir)"
+-PROGRAMS = $(bin_PROGRAMS)
+-am__dosbox_SOURCES_DIST = dosbox.cpp winres.rc
+-@HAVE_WINDRES_TRUE@am__objects_1 = winres.$(OBJEXT)
+-am_dosbox_OBJECTS = dosbox.$(OBJEXT) $(am__objects_1)
+-dosbox_OBJECTS = $(am_dosbox_OBJECTS)
+-dosbox_DEPENDENCIES = cpu/libcpu.a debug/libdebug.a dos/libdos.a \
+-	fpu/libfpu.a hardware/libhardware.a gui/libgui.a \
+-	ints/libints.a misc/libmisc.a shell/libshell.a \
+-	hardware/serialport/libserial.a libs/gui_tk/libgui_tk.a
+-DEFAULT_INCLUDES = -I.@am__isrc@ -I$(top_builddir)
+-depcomp = $(SHELL) $(top_srcdir)/depcomp
+-am__depfiles_maybe = depfiles
+-am__mv = mv -f
+-CXXCOMPILE = $(CXX) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) \
+-	$(AM_CPPFLAGS) $(CPPFLAGS) $(AM_CXXFLAGS) $(CXXFLAGS)
+-CXXLD = $(CXX)
+-CXXLINK = $(CXXLD) $(AM_CXXFLAGS) $(CXXFLAGS) $(AM_LDFLAGS) $(LDFLAGS) \
+-	-o $@
+-SOURCES = $(dosbox_SOURCES)
+-DIST_SOURCES = $(am__dosbox_SOURCES_DIST)
+-RECURSIVE_TARGETS = all-recursive check-recursive dvi-recursive \
+-	html-recursive info-recursive install-data-recursive \
+-	install-dvi-recursive install-exec-recursive \
+-	install-html-recursive install-info-recursive \
+-	install-pdf-recursive install-ps-recursive install-recursive \
+-	installcheck-recursive installdirs-recursive pdf-recursive \
+-	ps-recursive uninstall-recursive
+-RECURSIVE_CLEAN_TARGETS = mostlyclean-recursive clean-recursive	\
+-  distclean-recursive maintainer-clean-recursive
+-AM_RECURSIVE_TARGETS = $(RECURSIVE_TARGETS:-recursive=) \
+-	$(RECURSIVE_CLEAN_TARGETS:-recursive=) tags TAGS ctags CTAGS \
+-	distdir
+-ETAGS = etags
+-CTAGS = ctags
+-DIST_SUBDIRS = $(SUBDIRS)
+-DISTFILES = $(DIST_COMMON) $(DIST_SOURCES) $(TEXINFOS) $(EXTRA_DIST)
+-am__relativize = \
+-  dir0=`pwd`; \
+-  sed_first='s,^\([^/]*\)/.*$$,\1,'; \
+-  sed_rest='s,^[^/]*/*,,'; \
+-  sed_last='s,^.*/\([^/]*\)$$,\1,'; \
+-  sed_butlast='s,/*[^/]*$$,,'; \
+-  while test -n "$$dir1"; do \
+-    first=`echo "$$dir1" | sed -e "$$sed_first"`; \
+-    if test "$$first" != "."; then \
+-      if test "$$first" = ".."; then \
+-        dir2=`echo "$$dir0" | sed -e "$$sed_last"`/"$$dir2"; \
+-        dir0=`echo "$$dir0" | sed -e "$$sed_butlast"`; \
+-      else \
+-        first2=`echo "$$dir2" | sed -e "$$sed_first"`; \
+-        if test "$$first2" = "$$first"; then \
+-          dir2=`echo "$$dir2" | sed -e "$$sed_rest"`; \
+-        else \
+-          dir2="../$$dir2"; \
+-        fi; \
+-        dir0="$$dir0"/"$$first"; \
+-      fi; \
+-    fi; \
+-    dir1=`echo "$$dir1" | sed -e "$$sed_rest"`; \
+-  done; \
+-  reldir="$$dir2"
+-ACLOCAL = @ACLOCAL@
+-ALSA_CFLAGS = @ALSA_CFLAGS@
+-ALSA_LIBS = @ALSA_LIBS@
+-AMTAR = @AMTAR@
+-AUTOCONF = @AUTOCONF@
+-AUTOHEADER = @AUTOHEADER@
+-AUTOMAKE = @AUTOMAKE@
+-AWK = @AWK@
+-CC = @CC@
+-CCDEPMODE = @CCDEPMODE@
+-CFLAGS = @CFLAGS@
+-CPP = @CPP@
+-CPPFLAGS = @CPPFLAGS@
+-CXX = @CXX@
+-CXXDEPMODE = @CXXDEPMODE@
+-CXXFLAGS = @CXXFLAGS@
+-CYGPATH_W = @CYGPATH_W@
+-DEFS = @DEFS@
+-DEPDIR = @DEPDIR@
+-ECHO_C = @ECHO_C@
+-ECHO_N = @ECHO_N@
+-ECHO_T = @ECHO_T@
+-EGREP = @EGREP@
+-EXEEXT = @EXEEXT@
+-GREP = @GREP@
+-INSTALL = @INSTALL@
+-INSTALL_DATA = @INSTALL_DATA@
+-INSTALL_PROGRAM = @INSTALL_PROGRAM@
+-INSTALL_SCRIPT = @INSTALL_SCRIPT@
+-INSTALL_STRIP_PROGRAM = @INSTALL_STRIP_PROGRAM@
+-LDFLAGS = @LDFLAGS@
+-LIBOBJS = @LIBOBJS@
+-LIBS = @LIBS@
+-LTLIBOBJS = @LTLIBOBJS@
+-MAKEINFO = @MAKEINFO@
+-MKDIR_P = @MKDIR_P@
+-OBJEXT = @OBJEXT@
+-PACKAGE = @PACKAGE@
+-PACKAGE_BUGREPORT = @PACKAGE_BUGREPORT@
+-PACKAGE_NAME = @PACKAGE_NAME@
+-PACKAGE_STRING = @PACKAGE_STRING@
+-PACKAGE_TARNAME = @PACKAGE_TARNAME@
+-PACKAGE_URL = @PACKAGE_URL@
+-PACKAGE_VERSION = @PACKAGE_VERSION@
+-PATH_SEPARATOR = @PATH_SEPARATOR@
+-RANLIB = @RANLIB@
+-SDL_CFLAGS = @SDL_CFLAGS@
+-SDL_CONFIG = @SDL_CONFIG@
+-SDL_LIBS = @SDL_LIBS@
+-SET_MAKE = @SET_MAKE@
+-SHELL = @SHELL@
+-STRIP = @STRIP@
+-VERSION = @VERSION@
+-WINDRES = @WINDRES@
+-abs_builddir = @abs_builddir@
+-abs_srcdir = @abs_srcdir@
+-abs_top_builddir = @abs_top_builddir@
+-abs_top_srcdir = @abs_top_srcdir@
+-ac_ct_CC = @ac_ct_CC@
+-ac_ct_CXX = @ac_ct_CXX@
+-am__include = @am__include@
+-am__leading_dot = @am__leading_dot@
+-am__quote = @am__quote@
+-am__tar = @am__tar@
+-am__untar = @am__untar@
+-bindir = @bindir@
+-build = @build@
+-build_alias = @build_alias@
+-build_cpu = @build_cpu@
+-build_os = @build_os@
+-build_vendor = @build_vendor@
+-builddir = @builddir@
+-datadir = @datadir@
+-datarootdir = @datarootdir@
+-docdir = @docdir@
+-dvidir = @dvidir@
+-exec_prefix = @exec_prefix@
+-host = @host@
+-host_alias = @host_alias@
+-host_cpu = @host_cpu@
+-host_os = @host_os@
+-host_vendor = @host_vendor@
+-htmldir = @htmldir@
+-includedir = @includedir@
+-infodir = @infodir@
+-install_sh = @install_sh@
+-libdir = @libdir@
+-libexecdir = @libexecdir@
+-localedir = @localedir@
+-localstatedir = @localstatedir@
+-mandir = @mandir@
+-mkdir_p = @mkdir_p@
+-oldincludedir = @oldincludedir@
+-pdfdir = @pdfdir@
+-prefix = @prefix@
+-program_transform_name = @program_transform_name@
+-psdir = @psdir@
+-sbindir = @sbindir@
+-sharedstatedir = @sharedstatedir@
+-srcdir = @srcdir@
+-sysconfdir = @sysconfdir@
+-target_alias = @target_alias@
+-top_build_prefix = @top_build_prefix@
+-top_builddir = @top_builddir@
+-top_srcdir = @top_srcdir@
+-AM_CPPFLAGS = -I$(top_srcdir)/include
+-SUBDIRS = cpu debug dos fpu gui hardware libs ints misc shell platform 
+-@HAVE_WINDRES_TRUE@ico_stuff = winres.rc
+-dosbox_SOURCES = dosbox.cpp $(ico_stuff)
+-dosbox_LDADD = cpu/libcpu.a debug/libdebug.a dos/libdos.a fpu/libfpu.a  hardware/libhardware.a gui/libgui.a \
+-               ints/libints.a misc/libmisc.a shell/libshell.a hardware/serialport/libserial.a libs/gui_tk/libgui_tk.a
+-
+-EXTRA_DIST = winres.rc dosbox.ico
+-all: all-recursive
+-
+-.SUFFIXES:
+-.SUFFIXES: .cpp .o .obj .rc
+-$(srcdir)/Makefile.in:  $(srcdir)/Makefile.am  $(am__configure_deps)
+-	@for dep in $?; do \
+-	  case '$(am__configure_deps)' in \
+-	    *$$dep*) \
+-	      ( cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh ) \
+-	        && { if test -f $@; then exit 0; else break; fi; }; \
+-	      exit 1;; \
+-	  esac; \
+-	done; \
+-	echo ' cd $(top_srcdir) && $(AUTOMAKE) --gnu src/Makefile'; \
+-	$(am__cd) $(top_srcdir) && \
+-	  $(AUTOMAKE) --gnu src/Makefile
+-.PRECIOUS: Makefile
+-Makefile: $(srcdir)/Makefile.in $(top_builddir)/config.status
+-	@case '$?' in \
+-	  *config.status*) \
+-	    cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh;; \
+-	  *) \
+-	    echo ' cd $(top_builddir) && $(SHELL) ./config.status $(subdir)/$@ $(am__depfiles_maybe)'; \
+-	    cd $(top_builddir) && $(SHELL) ./config.status $(subdir)/$@ $(am__depfiles_maybe);; \
+-	esac;
+-
+-$(top_builddir)/config.status: $(top_srcdir)/configure $(CONFIG_STATUS_DEPENDENCIES)
+-	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
+-
+-$(top_srcdir)/configure:  $(am__configure_deps)
+-	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
+-$(ACLOCAL_M4):  $(am__aclocal_m4_deps)
+-	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
+-$(am__aclocal_m4_deps):
+-install-binPROGRAMS: $(bin_PROGRAMS)
+-	@$(NORMAL_INSTALL)
+-	test -z "$(bindir)" || $(MKDIR_P) "$(DESTDIR)$(bindir)"
+-	@list='$(bin_PROGRAMS)'; test -n "$(bindir)" || list=; \
+-	for p in $$list; do echo "$$p $$p"; done | \
+-	sed 's/$(EXEEXT)$$//' | \
+-	while read p p1; do if test -f $$p; \
+-	  then echo "$$p"; echo "$$p"; else :; fi; \
+-	done | \
+-	sed -e 'p;s,.*/,,;n;h' -e 's|.*|.|' \
+-	    -e 'p;x;s,.*/,,;s/$(EXEEXT)$$//;$(transform);s/$$/$(EXEEXT)/' | \
+-	sed 'N;N;N;s,\n, ,g' | \
+-	$(AWK) 'BEGIN { files["."] = ""; dirs["."] = 1 } \
+-	  { d=$$3; if (dirs[d] != 1) { print "d", d; dirs[d] = 1 } \
+-	    if ($$2 == $$4) files[d] = files[d] " " $$1; \
+-	    else { print "f", $$3 "/" $$4, $$1; } } \
+-	  END { for (d in files) print "f", d, files[d] }' | \
+-	while read type dir files; do \
+-	    if test "$$dir" = .; then dir=; else dir=/$$dir; fi; \
+-	    test -z "$$files" || { \
+-	      echo " $(INSTALL_PROGRAM_ENV) $(INSTALL_PROGRAM) $$files '$(DESTDIR)$(bindir)$$dir'"; \
+-	      $(INSTALL_PROGRAM_ENV) $(INSTALL_PROGRAM) $$files "$(DESTDIR)$(bindir)$$dir" || exit $$?; \
+-	    } \
+-	; done
+-
+-uninstall-binPROGRAMS:
+-	@$(NORMAL_UNINSTALL)
+-	@list='$(bin_PROGRAMS)'; test -n "$(bindir)" || list=; \
+-	files=`for p in $$list; do echo "$$p"; done | \
+-	  sed -e 'h;s,^.*/,,;s/$(EXEEXT)$$//;$(transform)' \
+-	      -e 's/$$/$(EXEEXT)/' `; \
+-	test -n "$$list" || exit 0; \
+-	echo " ( cd '$(DESTDIR)$(bindir)' && rm -f" $$files ")"; \
+-	cd "$(DESTDIR)$(bindir)" && rm -f $$files
+-
+-clean-binPROGRAMS:
+-	-test -z "$(bin_PROGRAMS)" || rm -f $(bin_PROGRAMS)
+-dosbox$(EXEEXT): $(dosbox_OBJECTS) $(dosbox_DEPENDENCIES) 
+-	@rm -f dosbox$(EXEEXT)
+-	$(CXXLINK) $(dosbox_OBJECTS) $(dosbox_LDADD) $(LIBS)
+-
+-mostlyclean-compile:
+-	-rm -f *.$(OBJEXT)
+-
+-distclean-compile:
+-	-rm -f *.tab.c
+-
+-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/dosbox.Po@am__quote@
+-
+-.cpp.o:
+-@am__fastdepCXX_TRUE@	$(CXXCOMPILE) -MT $@ -MD -MP -MF $(DEPDIR)/$*.Tpo -c -o $@ $<
+-@am__fastdepCXX_TRUE@	$(am__mv) $(DEPDIR)/$*.Tpo $(DEPDIR)/$*.Po
+-@AMDEP_TRUE@@am__fastdepCXX_FALSE@	source='$<' object='$@' libtool=no @AMDEPBACKSLASH@
+-@AMDEP_TRUE@@am__fastdepCXX_FALSE@	DEPDIR=$(DEPDIR) $(CXXDEPMODE) $(depcomp) @AMDEPBACKSLASH@
+-@am__fastdepCXX_FALSE@	$(CXXCOMPILE) -c -o $@ $<
+-
+-.cpp.obj:
+-@am__fastdepCXX_TRUE@	$(CXXCOMPILE) -MT $@ -MD -MP -MF $(DEPDIR)/$*.Tpo -c -o $@ `$(CYGPATH_W) '$<'`
+-@am__fastdepCXX_TRUE@	$(am__mv) $(DEPDIR)/$*.Tpo $(DEPDIR)/$*.Po
+-@AMDEP_TRUE@@am__fastdepCXX_FALSE@	source='$<' object='$@' libtool=no @AMDEPBACKSLASH@
+-@AMDEP_TRUE@@am__fastdepCXX_FALSE@	DEPDIR=$(DEPDIR) $(CXXDEPMODE) $(depcomp) @AMDEPBACKSLASH@
+-@am__fastdepCXX_FALSE@	$(CXXCOMPILE) -c -o $@ `$(CYGPATH_W) '$<'`
+-
+-# This directory's subdirectories are mostly independent; you can cd
+-# into them and run `make' without going through this Makefile.
+-# To change the values of `make' variables: instead of editing Makefiles,
+-# (1) if the variable is set in `config.status', edit `config.status'
+-#     (which will cause the Makefiles to be regenerated when you run `make');
+-# (2) otherwise, pass the desired values on the `make' command line.
+-$(RECURSIVE_TARGETS):
+-	@fail= failcom='exit 1'; \
+-	for f in x $$MAKEFLAGS; do \
+-	  case $$f in \
+-	    *=* | --[!k]*);; \
+-	    *k*) failcom='fail=yes';; \
+-	  esac; \
+-	done; \
+-	dot_seen=no; \
+-	target=`echo $@ | sed s/-recursive//`; \
+-	list='$(SUBDIRS)'; for subdir in $$list; do \
+-	  echo "Making $$target in $$subdir"; \
+-	  if test "$$subdir" = "."; then \
+-	    dot_seen=yes; \
+-	    local_target="$$target-am"; \
+-	  else \
+-	    local_target="$$target"; \
+-	  fi; \
+-	  ($(am__cd) $$subdir && $(MAKE) $(AM_MAKEFLAGS) $$local_target) \
+-	  || eval $$failcom; \
+-	done; \
+-	if test "$$dot_seen" = "no"; then \
+-	  $(MAKE) $(AM_MAKEFLAGS) "$$target-am" || exit 1; \
+-	fi; test -z "$$fail"
+-
+-$(RECURSIVE_CLEAN_TARGETS):
+-	@fail= failcom='exit 1'; \
+-	for f in x $$MAKEFLAGS; do \
+-	  case $$f in \
+-	    *=* | --[!k]*);; \
+-	    *k*) failcom='fail=yes';; \
+-	  esac; \
+-	done; \
+-	dot_seen=no; \
+-	case "$@" in \
+-	  distclean-* | maintainer-clean-*) list='$(DIST_SUBDIRS)' ;; \
+-	  *) list='$(SUBDIRS)' ;; \
+-	esac; \
+-	rev=''; for subdir in $$list; do \
+-	  if test "$$subdir" = "."; then :; else \
+-	    rev="$$subdir $$rev"; \
+-	  fi; \
+-	done; \
+-	rev="$$rev ."; \
+-	target=`echo $@ | sed s/-recursive//`; \
+-	for subdir in $$rev; do \
+-	  echo "Making $$target in $$subdir"; \
+-	  if test "$$subdir" = "."; then \
+-	    local_target="$$target-am"; \
+-	  else \
+-	    local_target="$$target"; \
+-	  fi; \
+-	  ($(am__cd) $$subdir && $(MAKE) $(AM_MAKEFLAGS) $$local_target) \
+-	  || eval $$failcom; \
+-	done && test -z "$$fail"
+-tags-recursive:
+-	list='$(SUBDIRS)'; for subdir in $$list; do \
+-	  test "$$subdir" = . || ($(am__cd) $$subdir && $(MAKE) $(AM_MAKEFLAGS) tags); \
+-	done
+-ctags-recursive:
+-	list='$(SUBDIRS)'; for subdir in $$list; do \
+-	  test "$$subdir" = . || ($(am__cd) $$subdir && $(MAKE) $(AM_MAKEFLAGS) ctags); \
+-	done
+-
+-ID: $(HEADERS) $(SOURCES) $(LISP) $(TAGS_FILES)
+-	list='$(SOURCES) $(HEADERS) $(LISP) $(TAGS_FILES)'; \
+-	unique=`for i in $$list; do \
+-	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
+-	  done | \
+-	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
+-	      END { if (nonempty) { for (i in files) print i; }; }'`; \
+-	mkid -fID $$unique
+-tags: TAGS
+-
+-TAGS: tags-recursive $(HEADERS) $(SOURCES)  $(TAGS_DEPENDENCIES) \
+-		$(TAGS_FILES) $(LISP)
+-	set x; \
+-	here=`pwd`; \
+-	if ($(ETAGS) --etags-include --version) >/dev/null 2>&1; then \
+-	  include_option=--etags-include; \
+-	  empty_fix=.; \
+-	else \
+-	  include_option=--include; \
+-	  empty_fix=; \
+-	fi; \
+-	list='$(SUBDIRS)'; for subdir in $$list; do \
+-	  if test "$$subdir" = .; then :; else \
+-	    test ! -f $$subdir/TAGS || \
+-	      set "$$@" "$$include_option=$$here/$$subdir/TAGS"; \
+-	  fi; \
+-	done; \
+-	list='$(SOURCES) $(HEADERS)  $(LISP) $(TAGS_FILES)'; \
+-	unique=`for i in $$list; do \
+-	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
+-	  done | \
+-	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
+-	      END { if (nonempty) { for (i in files) print i; }; }'`; \
+-	shift; \
+-	if test -z "$(ETAGS_ARGS)$$*$$unique"; then :; else \
+-	  test -n "$$unique" || unique=$$empty_fix; \
+-	  if test $$# -gt 0; then \
+-	    $(ETAGS) $(ETAGSFLAGS) $(AM_ETAGSFLAGS) $(ETAGS_ARGS) \
+-	      "$$@" $$unique; \
+-	  else \
+-	    $(ETAGS) $(ETAGSFLAGS) $(AM_ETAGSFLAGS) $(ETAGS_ARGS) \
+-	      $$unique; \
+-	  fi; \
+-	fi
+-ctags: CTAGS
+-CTAGS: ctags-recursive $(HEADERS) $(SOURCES)  $(TAGS_DEPENDENCIES) \
+-		$(TAGS_FILES) $(LISP)
+-	list='$(SOURCES) $(HEADERS)  $(LISP) $(TAGS_FILES)'; \
+-	unique=`for i in $$list; do \
+-	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
+-	  done | \
+-	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
+-	      END { if (nonempty) { for (i in files) print i; }; }'`; \
+-	test -z "$(CTAGS_ARGS)$$unique" \
+-	  || $(CTAGS) $(CTAGSFLAGS) $(AM_CTAGSFLAGS) $(CTAGS_ARGS) \
+-	     $$unique
+-
+-GTAGS:
+-	here=`$(am__cd) $(top_builddir) && pwd` \
+-	  && $(am__cd) $(top_srcdir) \
+-	  && gtags -i $(GTAGS_ARGS) "$$here"
+-
+-distclean-tags:
+-	-rm -f TAGS ID GTAGS GRTAGS GSYMS GPATH tags
+-
+-distdir: $(DISTFILES)
+-	@srcdirstrip=`echo "$(srcdir)" | sed 's/[].[^$$\\*]/\\\\&/g'`; \
+-	topsrcdirstrip=`echo "$(top_srcdir)" | sed 's/[].[^$$\\*]/\\\\&/g'`; \
+-	list='$(DISTFILES)'; \
+-	  dist_files=`for file in $$list; do echo $$file; done | \
+-	  sed -e "s|^$$srcdirstrip/||;t" \
+-	      -e "s|^$$topsrcdirstrip/|$(top_builddir)/|;t"`; \
+-	case $$dist_files in \
+-	  */*) $(MKDIR_P) `echo "$$dist_files" | \
+-			   sed '/\//!d;s|^|$(distdir)/|;s,/[^/]*$$,,' | \
+-			   sort -u` ;; \
+-	esac; \
+-	for file in $$dist_files; do \
+-	  if test -f $$file || test -d $$file; then d=.; else d=$(srcdir); fi; \
+-	  if test -d $$d/$$file; then \
+-	    dir=`echo "/$$file" | sed -e 's,/[^/]*$$,,'`; \
+-	    if test -d "$(distdir)/$$file"; then \
+-	      find "$(distdir)/$$file" -type d ! -perm -700 -exec chmod u+rwx {} \;; \
+-	    fi; \
+-	    if test -d $(srcdir)/$$file && test $$d != $(srcdir); then \
+-	      cp -fpR $(srcdir)/$$file "$(distdir)$$dir" || exit 1; \
+-	      find "$(distdir)/$$file" -type d ! -perm -700 -exec chmod u+rwx {} \;; \
+-	    fi; \
+-	    cp -fpR $$d/$$file "$(distdir)$$dir" || exit 1; \
+-	  else \
+-	    test -f "$(distdir)/$$file" \
+-	    || cp -p $$d/$$file "$(distdir)/$$file" \
+-	    || exit 1; \
+-	  fi; \
+-	done
+-	@list='$(DIST_SUBDIRS)'; for subdir in $$list; do \
+-	  if test "$$subdir" = .; then :; else \
+-	    test -d "$(distdir)/$$subdir" \
+-	    || $(MKDIR_P) "$(distdir)/$$subdir" \
+-	    || exit 1; \
+-	  fi; \
+-	done
+-	@list='$(DIST_SUBDIRS)'; for subdir in $$list; do \
+-	  if test "$$subdir" = .; then :; else \
+-	    dir1=$$subdir; dir2="$(distdir)/$$subdir"; \
+-	    $(am__relativize); \
+-	    new_distdir=$$reldir; \
+-	    dir1=$$subdir; dir2="$(top_distdir)"; \
+-	    $(am__relativize); \
+-	    new_top_distdir=$$reldir; \
+-	    echo " (cd $$subdir && $(MAKE) $(AM_MAKEFLAGS) top_distdir="$$new_top_distdir" distdir="$$new_distdir" \\"; \
+-	    echo "     am__remove_distdir=: am__skip_length_check=: am__skip_mode_fix=: distdir)"; \
+-	    ($(am__cd) $$subdir && \
+-	      $(MAKE) $(AM_MAKEFLAGS) \
+-	        top_distdir="$$new_top_distdir" \
+-	        distdir="$$new_distdir" \
+-		am__remove_distdir=: \
+-		am__skip_length_check=: \
+-		am__skip_mode_fix=: \
+-	        distdir) \
+-	      || exit 1; \
+-	  fi; \
+-	done
+-check-am: all-am
+-check: check-recursive
+-all-am: Makefile $(PROGRAMS)
+-installdirs: installdirs-recursive
+-installdirs-am:
+-	for dir in "$(DESTDIR)$(bindir)"; do \
+-	  test -z "$$dir" || $(MKDIR_P) "$$dir"; \
+-	done
+-install: install-recursive
+-install-exec: install-exec-recursive
+-install-data: install-data-recursive
+-uninstall: uninstall-recursive
+-
+-install-am: all-am
+-	@$(MAKE) $(AM_MAKEFLAGS) install-exec-am install-data-am
+-
+-installcheck: installcheck-recursive
+-install-strip:
+-	$(MAKE) $(AM_MAKEFLAGS) INSTALL_PROGRAM="$(INSTALL_STRIP_PROGRAM)" \
+-	  install_sh_PROGRAM="$(INSTALL_STRIP_PROGRAM)" INSTALL_STRIP_FLAG=-s \
+-	  `test -z '$(STRIP)' || \
+-	    echo "INSTALL_PROGRAM_ENV=STRIPPROG='$(STRIP)'"` install
+-mostlyclean-generic:
+-
+-clean-generic:
+-
+-distclean-generic:
+-	-test -z "$(CONFIG_CLEAN_FILES)" || rm -f $(CONFIG_CLEAN_FILES)
+-	-test . = "$(srcdir)" || test -z "$(CONFIG_CLEAN_VPATH_FILES)" || rm -f $(CONFIG_CLEAN_VPATH_FILES)
+-
+-maintainer-clean-generic:
+-	@echo "This command is intended for maintainers to use"
+-	@echo "it deletes files that may require special tools to rebuild."
+-clean: clean-recursive
+-
+-clean-am: clean-binPROGRAMS clean-generic mostlyclean-am
+-
+-distclean: distclean-recursive
+-	-rm -rf ./$(DEPDIR)
+-	-rm -f Makefile
+-distclean-am: clean-am distclean-compile distclean-generic \
+-	distclean-tags
+-
+-dvi: dvi-recursive
+-
+-dvi-am:
+-
+-html: html-recursive
+-
+-html-am:
+-
+-info: info-recursive
+-
+-info-am:
+-
+-install-data-am:
+-
+-install-dvi: install-dvi-recursive
+-
+-install-dvi-am:
+-
+-install-exec-am: install-binPROGRAMS
+-
+-install-html: install-html-recursive
+-
+-install-html-am:
+-
+-install-info: install-info-recursive
+-
+-install-info-am:
+-
+-install-man:
+-
+-install-pdf: install-pdf-recursive
+-
+-install-pdf-am:
+-
+-install-ps: install-ps-recursive
+-
+-install-ps-am:
+-
+-installcheck-am:
+-
+-maintainer-clean: maintainer-clean-recursive
+-	-rm -rf ./$(DEPDIR)
+-	-rm -f Makefile
+-maintainer-clean-am: distclean-am maintainer-clean-generic
+-
+-mostlyclean: mostlyclean-recursive
+-
+-mostlyclean-am: mostlyclean-compile mostlyclean-generic
+-
+-pdf: pdf-recursive
+-
+-pdf-am:
+-
+-ps: ps-recursive
+-
+-ps-am:
+-
+-uninstall-am: uninstall-binPROGRAMS
+-
+-.MAKE: $(RECURSIVE_CLEAN_TARGETS) $(RECURSIVE_TARGETS) ctags-recursive \
+-	install-am install-strip tags-recursive
+-
+-.PHONY: $(RECURSIVE_CLEAN_TARGETS) $(RECURSIVE_TARGETS) CTAGS GTAGS \
+-	all all-am check check-am clean clean-binPROGRAMS \
+-	clean-generic ctags ctags-recursive distclean \
+-	distclean-compile distclean-generic distclean-tags distdir dvi \
+-	dvi-am html html-am info info-am install install-am \
+-	install-binPROGRAMS install-data install-data-am install-dvi \
+-	install-dvi-am install-exec install-exec-am install-html \
+-	install-html-am install-info install-info-am install-man \
+-	install-pdf install-pdf-am install-ps install-ps-am \
+-	install-strip installcheck installcheck-am installdirs \
+-	installdirs-am maintainer-clean maintainer-clean-generic \
+-	mostlyclean mostlyclean-compile mostlyclean-generic pdf pdf-am \
+-	ps ps-am tags tags-recursive uninstall uninstall-am \
+-	uninstall-binPROGRAMS
+-
+-
+-.rc.o:
+-	$(WINDRES) -o $@ $<
+-
+-# Tell versions [3.59,3.63) of GNU make to not export all variables.
+-# Otherwise a system limit (for SysV at least) may be exceeded.
+-.NOEXPORT:
+diff -Nur dosbox-0.74/src/misc/cross.cpp dosbox/src/misc/cross.cpp
+--- dosbox-0.74/src/misc/cross.cpp	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/misc/cross.cpp	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,7 +16,6 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: cross.cpp,v 1.7 2009-05-26 17:43:39 qbix79 Exp $ */
+ 
+ #include "dosbox.h"
+ #include "cross.h"
+@@ -122,6 +121,19 @@
+ #endif
+ }
+ 
++bool Cross::IsPathAbsolute(std::string const& in) {
++	// Absolute paths
++#if defined (WIN32) || defined(OS2)
++	// drive letter
++	if (in.size() > 2 && in[1] == ':' ) return true;
++	// UNC path
++	else if (in.size() > 2 && in[0]=='\\' && in[1]=='\\') return true;
++#else
++	if (in.size() > 1 && in[0] == '/' ) return true;
++#endif
++	return false;
++}
++
+ #if defined (WIN32)
+ 
+ dir_information* open_directory(const char* dirname) {
+diff -Nur dosbox-0.74/src/misc/Makefile.in dosbox/src/misc/Makefile.in
+--- dosbox-0.74/src/misc/Makefile.in	2010-05-12 11:57:44.000000000 +0200
++++ dosbox/src/misc/Makefile.in	1970-01-01 01:00:00.000000000 +0100
+@@ -1,444 +0,0 @@
+-# Makefile.in generated by automake 1.11.1 from Makefile.am.
+-# @configure_input@
+-
+-# Copyright (C) 1994, 1995, 1996, 1997, 1998, 1999, 2000, 2001, 2002,
+-# 2003, 2004, 2005, 2006, 2007, 2008, 2009  Free Software Foundation,
+-# Inc.
+-# This Makefile.in is free software; the Free Software Foundation
+-# gives unlimited permission to copy and/or distribute it,
+-# with or without modifications, as long as this notice is preserved.
+-
+-# This program is distributed in the hope that it will be useful,
+-# but WITHOUT ANY WARRANTY, to the extent permitted by law; without
+-# even the implied warranty of MERCHANTABILITY or FITNESS FOR A
+-# PARTICULAR PURPOSE.
+-
+-@SET_MAKE@
+-
+-VPATH = @srcdir@
+-pkgdatadir = $(datadir)/@PACKAGE@
+-pkgincludedir = $(includedir)/@PACKAGE@
+-pkglibdir = $(libdir)/@PACKAGE@
+-pkglibexecdir = $(libexecdir)/@PACKAGE@
+-am__cd = CDPATH="$${ZSH_VERSION+.}$(PATH_SEPARATOR)" && cd
+-install_sh_DATA = $(install_sh) -c -m 644
+-install_sh_PROGRAM = $(install_sh) -c
+-install_sh_SCRIPT = $(install_sh) -c
+-INSTALL_HEADER = $(INSTALL_DATA)
+-transform = $(program_transform_name)
+-NORMAL_INSTALL = :
+-PRE_INSTALL = :
+-POST_INSTALL = :
+-NORMAL_UNINSTALL = :
+-PRE_UNINSTALL = :
+-POST_UNINSTALL = :
+-build_triplet = @build@
+-host_triplet = @host@
+-subdir = src/misc
+-DIST_COMMON = $(srcdir)/Makefile.am $(srcdir)/Makefile.in
+-ACLOCAL_M4 = $(top_srcdir)/aclocal.m4
+-am__aclocal_m4_deps = $(top_srcdir)/acinclude.m4 \
+-	$(top_srcdir)/configure.in
+-am__configure_deps = $(am__aclocal_m4_deps) $(CONFIGURE_DEPENDENCIES) \
+-	$(ACLOCAL_M4)
+-mkinstalldirs = $(install_sh) -d
+-CONFIG_HEADER = $(top_builddir)/config.h
+-CONFIG_CLEAN_FILES =
+-CONFIG_CLEAN_VPATH_FILES =
+-LIBRARIES = $(noinst_LIBRARIES)
+-AR = ar
+-ARFLAGS = cru
+-libmisc_a_AR = $(AR) $(ARFLAGS)
+-libmisc_a_LIBADD =
+-am_libmisc_a_OBJECTS = cross.$(OBJEXT) messages.$(OBJEXT) \
+-	programs.$(OBJEXT) setup.$(OBJEXT) support.$(OBJEXT)
+-libmisc_a_OBJECTS = $(am_libmisc_a_OBJECTS)
+-DEFAULT_INCLUDES = -I.@am__isrc@ -I$(top_builddir)
+-depcomp = $(SHELL) $(top_srcdir)/depcomp
+-am__depfiles_maybe = depfiles
+-am__mv = mv -f
+-CXXCOMPILE = $(CXX) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) \
+-	$(AM_CPPFLAGS) $(CPPFLAGS) $(AM_CXXFLAGS) $(CXXFLAGS)
+-CXXLD = $(CXX)
+-CXXLINK = $(CXXLD) $(AM_CXXFLAGS) $(CXXFLAGS) $(AM_LDFLAGS) $(LDFLAGS) \
+-	-o $@
+-SOURCES = $(libmisc_a_SOURCES)
+-DIST_SOURCES = $(libmisc_a_SOURCES)
+-ETAGS = etags
+-CTAGS = ctags
+-DISTFILES = $(DIST_COMMON) $(DIST_SOURCES) $(TEXINFOS) $(EXTRA_DIST)
+-ACLOCAL = @ACLOCAL@
+-ALSA_CFLAGS = @ALSA_CFLAGS@
+-ALSA_LIBS = @ALSA_LIBS@
+-AMTAR = @AMTAR@
+-AUTOCONF = @AUTOCONF@
+-AUTOHEADER = @AUTOHEADER@
+-AUTOMAKE = @AUTOMAKE@
+-AWK = @AWK@
+-CC = @CC@
+-CCDEPMODE = @CCDEPMODE@
+-CFLAGS = @CFLAGS@
+-CPP = @CPP@
+-CPPFLAGS = @CPPFLAGS@
+-CXX = @CXX@
+-CXXDEPMODE = @CXXDEPMODE@
+-CXXFLAGS = @CXXFLAGS@
+-CYGPATH_W = @CYGPATH_W@
+-DEFS = @DEFS@
+-DEPDIR = @DEPDIR@
+-ECHO_C = @ECHO_C@
+-ECHO_N = @ECHO_N@
+-ECHO_T = @ECHO_T@
+-EGREP = @EGREP@
+-EXEEXT = @EXEEXT@
+-GREP = @GREP@
+-INSTALL = @INSTALL@
+-INSTALL_DATA = @INSTALL_DATA@
+-INSTALL_PROGRAM = @INSTALL_PROGRAM@
+-INSTALL_SCRIPT = @INSTALL_SCRIPT@
+-INSTALL_STRIP_PROGRAM = @INSTALL_STRIP_PROGRAM@
+-LDFLAGS = @LDFLAGS@
+-LIBOBJS = @LIBOBJS@
+-LIBS = @LIBS@
+-LTLIBOBJS = @LTLIBOBJS@
+-MAKEINFO = @MAKEINFO@
+-MKDIR_P = @MKDIR_P@
+-OBJEXT = @OBJEXT@
+-PACKAGE = @PACKAGE@
+-PACKAGE_BUGREPORT = @PACKAGE_BUGREPORT@
+-PACKAGE_NAME = @PACKAGE_NAME@
+-PACKAGE_STRING = @PACKAGE_STRING@
+-PACKAGE_TARNAME = @PACKAGE_TARNAME@
+-PACKAGE_URL = @PACKAGE_URL@
+-PACKAGE_VERSION = @PACKAGE_VERSION@
+-PATH_SEPARATOR = @PATH_SEPARATOR@
+-RANLIB = @RANLIB@
+-SDL_CFLAGS = @SDL_CFLAGS@
+-SDL_CONFIG = @SDL_CONFIG@
+-SDL_LIBS = @SDL_LIBS@
+-SET_MAKE = @SET_MAKE@
+-SHELL = @SHELL@
+-STRIP = @STRIP@
+-VERSION = @VERSION@
+-WINDRES = @WINDRES@
+-abs_builddir = @abs_builddir@
+-abs_srcdir = @abs_srcdir@
+-abs_top_builddir = @abs_top_builddir@
+-abs_top_srcdir = @abs_top_srcdir@
+-ac_ct_CC = @ac_ct_CC@
+-ac_ct_CXX = @ac_ct_CXX@
+-am__include = @am__include@
+-am__leading_dot = @am__leading_dot@
+-am__quote = @am__quote@
+-am__tar = @am__tar@
+-am__untar = @am__untar@
+-bindir = @bindir@
+-build = @build@
+-build_alias = @build_alias@
+-build_cpu = @build_cpu@
+-build_os = @build_os@
+-build_vendor = @build_vendor@
+-builddir = @builddir@
+-datadir = @datadir@
+-datarootdir = @datarootdir@
+-docdir = @docdir@
+-dvidir = @dvidir@
+-exec_prefix = @exec_prefix@
+-host = @host@
+-host_alias = @host_alias@
+-host_cpu = @host_cpu@
+-host_os = @host_os@
+-host_vendor = @host_vendor@
+-htmldir = @htmldir@
+-includedir = @includedir@
+-infodir = @infodir@
+-install_sh = @install_sh@
+-libdir = @libdir@
+-libexecdir = @libexecdir@
+-localedir = @localedir@
+-localstatedir = @localstatedir@
+-mandir = @mandir@
+-mkdir_p = @mkdir_p@
+-oldincludedir = @oldincludedir@
+-pdfdir = @pdfdir@
+-prefix = @prefix@
+-program_transform_name = @program_transform_name@
+-psdir = @psdir@
+-sbindir = @sbindir@
+-sharedstatedir = @sharedstatedir@
+-srcdir = @srcdir@
+-sysconfdir = @sysconfdir@
+-target_alias = @target_alias@
+-top_build_prefix = @top_build_prefix@
+-top_builddir = @top_builddir@
+-top_srcdir = @top_srcdir@
+-AM_CPPFLAGS = -I$(top_srcdir)/include
+-noinst_LIBRARIES = libmisc.a
+-libmisc_a_SOURCES = cross.cpp messages.cpp programs.cpp setup.cpp support.cpp
+-all: all-am
+-
+-.SUFFIXES:
+-.SUFFIXES: .cpp .o .obj
+-$(srcdir)/Makefile.in:  $(srcdir)/Makefile.am  $(am__configure_deps)
+-	@for dep in $?; do \
+-	  case '$(am__configure_deps)' in \
+-	    *$$dep*) \
+-	      ( cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh ) \
+-	        && { if test -f $@; then exit 0; else break; fi; }; \
+-	      exit 1;; \
+-	  esac; \
+-	done; \
+-	echo ' cd $(top_srcdir) && $(AUTOMAKE) --gnu src/misc/Makefile'; \
+-	$(am__cd) $(top_srcdir) && \
+-	  $(AUTOMAKE) --gnu src/misc/Makefile
+-.PRECIOUS: Makefile
+-Makefile: $(srcdir)/Makefile.in $(top_builddir)/config.status
+-	@case '$?' in \
+-	  *config.status*) \
+-	    cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh;; \
+-	  *) \
+-	    echo ' cd $(top_builddir) && $(SHELL) ./config.status $(subdir)/$@ $(am__depfiles_maybe)'; \
+-	    cd $(top_builddir) && $(SHELL) ./config.status $(subdir)/$@ $(am__depfiles_maybe);; \
+-	esac;
+-
+-$(top_builddir)/config.status: $(top_srcdir)/configure $(CONFIG_STATUS_DEPENDENCIES)
+-	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
+-
+-$(top_srcdir)/configure:  $(am__configure_deps)
+-	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
+-$(ACLOCAL_M4):  $(am__aclocal_m4_deps)
+-	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
+-$(am__aclocal_m4_deps):
+-
+-clean-noinstLIBRARIES:
+-	-test -z "$(noinst_LIBRARIES)" || rm -f $(noinst_LIBRARIES)
+-libmisc.a: $(libmisc_a_OBJECTS) $(libmisc_a_DEPENDENCIES) 
+-	-rm -f libmisc.a
+-	$(libmisc_a_AR) libmisc.a $(libmisc_a_OBJECTS) $(libmisc_a_LIBADD)
+-	$(RANLIB) libmisc.a
+-
+-mostlyclean-compile:
+-	-rm -f *.$(OBJEXT)
+-
+-distclean-compile:
+-	-rm -f *.tab.c
+-
+-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/cross.Po@am__quote@
+-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/messages.Po@am__quote@
+-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/programs.Po@am__quote@
+-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/setup.Po@am__quote@
+-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/support.Po@am__quote@
+-
+-.cpp.o:
+-@am__fastdepCXX_TRUE@	$(CXXCOMPILE) -MT $@ -MD -MP -MF $(DEPDIR)/$*.Tpo -c -o $@ $<
+-@am__fastdepCXX_TRUE@	$(am__mv) $(DEPDIR)/$*.Tpo $(DEPDIR)/$*.Po
+-@AMDEP_TRUE@@am__fastdepCXX_FALSE@	source='$<' object='$@' libtool=no @AMDEPBACKSLASH@
+-@AMDEP_TRUE@@am__fastdepCXX_FALSE@	DEPDIR=$(DEPDIR) $(CXXDEPMODE) $(depcomp) @AMDEPBACKSLASH@
+-@am__fastdepCXX_FALSE@	$(CXXCOMPILE) -c -o $@ $<
+-
+-.cpp.obj:
+-@am__fastdepCXX_TRUE@	$(CXXCOMPILE) -MT $@ -MD -MP -MF $(DEPDIR)/$*.Tpo -c -o $@ `$(CYGPATH_W) '$<'`
+-@am__fastdepCXX_TRUE@	$(am__mv) $(DEPDIR)/$*.Tpo $(DEPDIR)/$*.Po
+-@AMDEP_TRUE@@am__fastdepCXX_FALSE@	source='$<' object='$@' libtool=no @AMDEPBACKSLASH@
+-@AMDEP_TRUE@@am__fastdepCXX_FALSE@	DEPDIR=$(DEPDIR) $(CXXDEPMODE) $(depcomp) @AMDEPBACKSLASH@
+-@am__fastdepCXX_FALSE@	$(CXXCOMPILE) -c -o $@ `$(CYGPATH_W) '$<'`
+-
+-ID: $(HEADERS) $(SOURCES) $(LISP) $(TAGS_FILES)
+-	list='$(SOURCES) $(HEADERS) $(LISP) $(TAGS_FILES)'; \
+-	unique=`for i in $$list; do \
+-	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
+-	  done | \
+-	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
+-	      END { if (nonempty) { for (i in files) print i; }; }'`; \
+-	mkid -fID $$unique
+-tags: TAGS
+-
+-TAGS:  $(HEADERS) $(SOURCES)  $(TAGS_DEPENDENCIES) \
+-		$(TAGS_FILES) $(LISP)
+-	set x; \
+-	here=`pwd`; \
+-	list='$(SOURCES) $(HEADERS)  $(LISP) $(TAGS_FILES)'; \
+-	unique=`for i in $$list; do \
+-	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
+-	  done | \
+-	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
+-	      END { if (nonempty) { for (i in files) print i; }; }'`; \
+-	shift; \
+-	if test -z "$(ETAGS_ARGS)$$*$$unique"; then :; else \
+-	  test -n "$$unique" || unique=$$empty_fix; \
+-	  if test $$# -gt 0; then \
+-	    $(ETAGS) $(ETAGSFLAGS) $(AM_ETAGSFLAGS) $(ETAGS_ARGS) \
+-	      "$$@" $$unique; \
+-	  else \
+-	    $(ETAGS) $(ETAGSFLAGS) $(AM_ETAGSFLAGS) $(ETAGS_ARGS) \
+-	      $$unique; \
+-	  fi; \
+-	fi
+-ctags: CTAGS
+-CTAGS:  $(HEADERS) $(SOURCES)  $(TAGS_DEPENDENCIES) \
+-		$(TAGS_FILES) $(LISP)
+-	list='$(SOURCES) $(HEADERS)  $(LISP) $(TAGS_FILES)'; \
+-	unique=`for i in $$list; do \
+-	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
+-	  done | \
+-	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
+-	      END { if (nonempty) { for (i in files) print i; }; }'`; \
+-	test -z "$(CTAGS_ARGS)$$unique" \
+-	  || $(CTAGS) $(CTAGSFLAGS) $(AM_CTAGSFLAGS) $(CTAGS_ARGS) \
+-	     $$unique
+-
+-GTAGS:
+-	here=`$(am__cd) $(top_builddir) && pwd` \
+-	  && $(am__cd) $(top_srcdir) \
+-	  && gtags -i $(GTAGS_ARGS) "$$here"
+-
+-distclean-tags:
+-	-rm -f TAGS ID GTAGS GRTAGS GSYMS GPATH tags
+-
+-distdir: $(DISTFILES)
+-	@srcdirstrip=`echo "$(srcdir)" | sed 's/[].[^$$\\*]/\\\\&/g'`; \
+-	topsrcdirstrip=`echo "$(top_srcdir)" | sed 's/[].[^$$\\*]/\\\\&/g'`; \
+-	list='$(DISTFILES)'; \
+-	  dist_files=`for file in $$list; do echo $$file; done | \
+-	  sed -e "s|^$$srcdirstrip/||;t" \
+-	      -e "s|^$$topsrcdirstrip/|$(top_builddir)/|;t"`; \
+-	case $$dist_files in \
+-	  */*) $(MKDIR_P) `echo "$$dist_files" | \
+-			   sed '/\//!d;s|^|$(distdir)/|;s,/[^/]*$$,,' | \
+-			   sort -u` ;; \
+-	esac; \
+-	for file in $$dist_files; do \
+-	  if test -f $$file || test -d $$file; then d=.; else d=$(srcdir); fi; \
+-	  if test -d $$d/$$file; then \
+-	    dir=`echo "/$$file" | sed -e 's,/[^/]*$$,,'`; \
+-	    if test -d "$(distdir)/$$file"; then \
+-	      find "$(distdir)/$$file" -type d ! -perm -700 -exec chmod u+rwx {} \;; \
+-	    fi; \
+-	    if test -d $(srcdir)/$$file && test $$d != $(srcdir); then \
+-	      cp -fpR $(srcdir)/$$file "$(distdir)$$dir" || exit 1; \
+-	      find "$(distdir)/$$file" -type d ! -perm -700 -exec chmod u+rwx {} \;; \
+-	    fi; \
+-	    cp -fpR $$d/$$file "$(distdir)$$dir" || exit 1; \
+-	  else \
+-	    test -f "$(distdir)/$$file" \
+-	    || cp -p $$d/$$file "$(distdir)/$$file" \
+-	    || exit 1; \
+-	  fi; \
+-	done
+-check-am: all-am
+-check: check-am
+-all-am: Makefile $(LIBRARIES)
+-installdirs:
+-install: install-am
+-install-exec: install-exec-am
+-install-data: install-data-am
+-uninstall: uninstall-am
+-
+-install-am: all-am
+-	@$(MAKE) $(AM_MAKEFLAGS) install-exec-am install-data-am
+-
+-installcheck: installcheck-am
+-install-strip:
+-	$(MAKE) $(AM_MAKEFLAGS) INSTALL_PROGRAM="$(INSTALL_STRIP_PROGRAM)" \
+-	  install_sh_PROGRAM="$(INSTALL_STRIP_PROGRAM)" INSTALL_STRIP_FLAG=-s \
+-	  `test -z '$(STRIP)' || \
+-	    echo "INSTALL_PROGRAM_ENV=STRIPPROG='$(STRIP)'"` install
+-mostlyclean-generic:
+-
+-clean-generic:
+-
+-distclean-generic:
+-	-test -z "$(CONFIG_CLEAN_FILES)" || rm -f $(CONFIG_CLEAN_FILES)
+-	-test . = "$(srcdir)" || test -z "$(CONFIG_CLEAN_VPATH_FILES)" || rm -f $(CONFIG_CLEAN_VPATH_FILES)
+-
+-maintainer-clean-generic:
+-	@echo "This command is intended for maintainers to use"
+-	@echo "it deletes files that may require special tools to rebuild."
+-clean: clean-am
+-
+-clean-am: clean-generic clean-noinstLIBRARIES mostlyclean-am
+-
+-distclean: distclean-am
+-	-rm -rf ./$(DEPDIR)
+-	-rm -f Makefile
+-distclean-am: clean-am distclean-compile distclean-generic \
+-	distclean-tags
+-
+-dvi: dvi-am
+-
+-dvi-am:
+-
+-html: html-am
+-
+-html-am:
+-
+-info: info-am
+-
+-info-am:
+-
+-install-data-am:
+-
+-install-dvi: install-dvi-am
+-
+-install-dvi-am:
+-
+-install-exec-am:
+-
+-install-html: install-html-am
+-
+-install-html-am:
+-
+-install-info: install-info-am
+-
+-install-info-am:
+-
+-install-man:
+-
+-install-pdf: install-pdf-am
+-
+-install-pdf-am:
+-
+-install-ps: install-ps-am
+-
+-install-ps-am:
+-
+-installcheck-am:
+-
+-maintainer-clean: maintainer-clean-am
+-	-rm -rf ./$(DEPDIR)
+-	-rm -f Makefile
+-maintainer-clean-am: distclean-am maintainer-clean-generic
+-
+-mostlyclean: mostlyclean-am
+-
+-mostlyclean-am: mostlyclean-compile mostlyclean-generic
+-
+-pdf: pdf-am
+-
+-pdf-am:
+-
+-ps: ps-am
+-
+-ps-am:
+-
+-uninstall-am:
+-
+-.MAKE: install-am install-strip
+-
+-.PHONY: CTAGS GTAGS all all-am check check-am clean clean-generic \
+-	clean-noinstLIBRARIES ctags distclean distclean-compile \
+-	distclean-generic distclean-tags distdir dvi dvi-am html \
+-	html-am info info-am install install-am install-data \
+-	install-data-am install-dvi install-dvi-am install-exec \
+-	install-exec-am install-html install-html-am install-info \
+-	install-info-am install-man install-pdf install-pdf-am \
+-	install-ps install-ps-am install-strip installcheck \
+-	installcheck-am installdirs maintainer-clean \
+-	maintainer-clean-generic mostlyclean mostlyclean-compile \
+-	mostlyclean-generic pdf pdf-am ps ps-am tags uninstall \
+-	uninstall-am
+-
+-
+-# Tell versions [3.59,3.63) of GNU make to not export all variables.
+-# Otherwise a system limit (for SysV at least) may be exceeded.
+-.NOEXPORT:
+diff -Nur dosbox-0.74/src/misc/messages.cpp dosbox/src/misc/messages.cpp
+--- dosbox-0.74/src/misc/messages.cpp	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/misc/messages.cpp	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,7 +16,6 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: messages.cpp,v 1.23 2009-06-17 08:52:35 qbix79 Exp $ */
+ 
+ #include <stdio.h>
+ #include <stdlib.h>
+@@ -99,7 +98,7 @@
+ 			strcpy(name,linein+1);
+ 		/* End of string marker */
+ 		} else if (linein[0]=='.') {
+-			/* Replace/Add the string to the internal langaugefile */
++			/* Replace/Add the string to the internal languagefile */
+ 			/* Remove last newline (marker is \n.\n) */
+ 			size_t ll = strlen(string);
+ 			if(ll && string[ll - 1] == '\n') string[ll - 1] = 0; //Second if should not be needed, but better be safe.
+@@ -124,13 +123,14 @@
+ }
+ 
+ 
+-void MSG_Write(const char * location) {
++bool MSG_Write(const char * location) {
+ 	FILE* out=fopen(location,"w+t");
+-	if(out==NULL) return;//maybe an error?
++	if(out==NULL) return false;//maybe an error?
+ 	for(itmb tel=Lang.begin();tel!=Lang.end();tel++){
+ 		fprintf(out,":%s\n%s\n.\n",(*tel).name.c_str(),(*tel).val.c_str());
+ 	}
+ 	fclose(out);
++	return true;
+ }
+ 
+ void MSG_Init(Section_prop * section) {
+diff -Nur dosbox-0.74/src/misc/programs.cpp dosbox/src/misc/programs.cpp
+--- dosbox-0.74/src/misc/programs.cpp	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/misc/programs.cpp	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,9 +16,9 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: programs.cpp,v 1.37 2009-05-27 09:15:42 qbix79 Exp $ */
+ 
+ #include <vector>
++#include <sstream>
+ #include <ctype.h>
+ #include <stdlib.h>
+ #include <stdarg.h>
+@@ -78,7 +78,7 @@
+ 	HostPt writer=(HostPt)&index;
+ 	for (;size>0;size--) *writer++=mem_readb(reader++);
+ 	Program * new_program;
+-	if(index > internal_progs.size()) E_Exit("something is messing with the memory");
++	if (index > internal_progs.size()) E_Exit("something is messing with the memory");
+ 	PROGRAMS_Main * handler = internal_progs[index];
+ 	(*handler)(&new_program);
+ 	new_program->Run();
+@@ -120,7 +120,7 @@
+ 	 * Length of arguments can be ~120. but switch when above 100 to be sure
+ 	 */
+ 
+-	if(/*control->SecureMode() ||*/ cmd->Get_arglength() > 100) {	
++	if (/*control->SecureMode() ||*/ cmd->Get_arglength() > 100) {	
+ 		CommandLine* temp = new CommandLine(cmd->GetFileName(),full_arguments.c_str());
+ 		delete cmd;
+ 		cmd = temp;
+@@ -128,6 +128,7 @@
+ 	full_arguments.assign(""); //Clear so it gets even more save
+ }
+ 
++static char last_written_character = 0;//For 0xA to OxD 0xA expansion
+ void Program::WriteOut(const char * format,...) {
+ 	char buf[2048];
+ 	va_list msg;
+@@ -139,10 +140,10 @@
+ 	Bit16u size = (Bit16u)strlen(buf);
+ 	for(Bit16u i = 0; i < size;i++) {
+ 		Bit8u out;Bit16u s=1;
+-		if(buf[i] == 0xA && i > 0 && buf[i-1] !=0xD) {
++		if (buf[i] == 0xA && last_written_character != 0xD) {
+ 			out = 0xD;DOS_WriteFile(STDOUT,&out,&s);
+ 		}
+-		out = buf[i];
++		last_written_character = out = buf[i];
+ 		DOS_WriteFile(STDOUT,&out,&s);
+ 	}
+ 	
+@@ -154,10 +155,10 @@
+ 	char const* buf = format;
+ 	for(Bit16u i = 0; i < size;i++) {
+ 		Bit8u out;Bit16u s=1;
+-		if(buf[i] == 0xA && i > 0 && buf[i-1] !=0xD) {
++		if (buf[i] == 0xA && last_written_character != 0xD) {
+ 			out = 0xD;DOS_WriteFile(STDOUT,&out,&s);
+ 		}
+-		out = buf[i];
++		last_written_character = out = buf[i];
+ 		DOS_WriteFile(STDOUT,&out,&s);
+ 	}
+ 
+@@ -243,149 +244,505 @@
+ 	return true;
+ }
+ 
++bool MSG_Write(const char *);
++void restart_program(std::vector<std::string> & parameters);
++
+ class CONFIG : public Program {
+ public:
+ 	void Run(void);
+-};
+-
+-void MSG_Write(const char *);
+-
+-void CONFIG::Run(void) {
+-	FILE * f;
+-	if (cmd->FindString("-writeconf",temp_line,true) 
+-			|| cmd->FindString("-wc",temp_line,true)) {
+-		/* In secure mode don't allow a new configfile to be created */
+-		if(control->SecureMode()) {
+-			WriteOut(MSG_Get("PROGRAM_CONFIG_SECURE_DISALLOW"));
+-			return;
++private:
++	void restart(const char* useconfig);
++	
++	void writeconf(std::string name, bool configdir) {
++		if (configdir) {
++			// write file to the default config directory
++			std::string config_path;
++			Cross::GetPlatformConfigDir(config_path);
++			name = config_path + name;
+ 		}
+-		f=fopen(temp_line.c_str(),"wb+");
+-		if (!f) {
+-			WriteOut(MSG_Get("PROGRAM_CONFIG_FILE_ERROR"),temp_line.c_str());
+-			return;
++		WriteOut(MSG_Get("PROGRAM_CONFIG_FILE_WHICH"),name.c_str());
++		if (!control->PrintConfig(name.c_str())) {
++			WriteOut(MSG_Get("PROGRAM_CONFIG_FILE_ERROR"),name.c_str());
+ 		}
+-		fclose(f);
+-		control->PrintConfig(temp_line.c_str());
+ 		return;
+ 	}
+-	if (cmd->FindString("-writelang",temp_line,true)
+-			||cmd->FindString("-wl",temp_line,true)) {
+-		/* In secure mode don't allow a new languagefile to be created
+-		 * Who knows which kind of file we would overwriting. */
+-		if(control->SecureMode()) {
++	
++	bool securemode_check() {
++		if (control->SecureMode()) {
+ 			WriteOut(MSG_Get("PROGRAM_CONFIG_SECURE_DISALLOW"));
+-			return;
+-		}
+-		f=fopen(temp_line.c_str(),"wb+");
+-		if (!f) {
+-			WriteOut(MSG_Get("PROGRAM_CONFIG_FILE_ERROR"),temp_line.c_str());
+-			return;
++			return true;
+ 		}
+-		fclose(f);
+-		MSG_Write(temp_line.c_str());
+-		return;
++		return false;
+ 	}
++};
+ 
+-	/* Code for switching to secure mode */
+-	if(cmd->FindExist("-securemode",true)) {
+-		control->SwitchToSecureMode();
+-		WriteOut(MSG_Get("PROGRAM_CONFIG_SECURE_ON"));
+-		return;
+-	}
+-   
+-	/* Code for getting the current configuration.           *
+-	 * Official format: config -get "section property"       *
+-	 * As a bonus it will set %CONFIG% to this value as well */
+-	if(cmd->FindString("-get",temp_line,true)) {
+-		std::string temp2 = "";
+-		cmd->GetStringRemain(temp2);//So -get n1 n2= can be used without quotes
+-		if(temp2 != "") temp_line = temp_line + " " + temp2;
+-
+-		std::string::size_type space = temp_line.find(" ");
+-		if(space == std::string::npos) {
+-			WriteOut(MSG_Get("PROGRAM_CONFIG_GET_SYNTAX"));
++void CONFIG::Run(void) {
++	static const char* const params[] = {
++		"-r", "-wcp", "-wcd", "-wc", "-writeconf", "-l", "-rmconf",
++		"-h", "-help", "-?", "-axclear", "-axadd", "-axtype", "-get", "-set",
++		"-writelang", "-wl", "-securemode", "" };
++	enum prs {
++		P_NOMATCH, P_NOPARAMS, // fixed return values for GetParameterFromList
++		P_RESTART,
++		P_WRITECONF_PORTABLE, P_WRITECONF_DEFAULT, P_WRITECONF, P_WRITECONF2,
++		P_LISTCONF,	P_KILLCONF,
++		P_HELP, P_HELP2, P_HELP3,
++		P_AUTOEXEC_CLEAR, P_AUTOEXEC_ADD, P_AUTOEXEC_TYPE,
++		P_GETPROP, P_SETPROP,
++		P_WRITELANG, P_WRITELANG2,
++		P_SECURE
++	} presult = P_NOMATCH;
++	
++	bool first = true;
++	std::vector<std::string> pvars;
++	// Loop through the passed parameters
++	while(presult != P_NOPARAMS) {
++		presult = (enum prs)cmd->GetParameterFromList(params, pvars);
++		switch(presult) {
++		
++		case P_RESTART:
++			if (securemode_check()) return;
++			if (pvars.size() == 0) restart_program(control->startup_params);
++			else {
++				std::vector<std::string> restart_params;
++				restart_params.push_back(control->cmdline->GetFileName());
++				for(size_t i = 0; i < pvars.size(); i++) {
++					restart_params.push_back(pvars[i]);
++					if (pvars[i].find(' ') != std::string::npos) {
++						pvars[i] = "\""+pvars[i]+"\""; // add back spaces
++					}
++				}
++				// the rest on the commandline, too
++				cmd->FillVector(restart_params);
++				restart_program(restart_params);
++			}
+ 			return;
++		
++		case P_LISTCONF: {
++			Bitu size = control->configfiles.size();
++			std::string config_path;
++			Cross::GetPlatformConfigDir(config_path);
++			WriteOut(MSG_Get("PROGRAM_CONFIG_CONFDIR"), VERSION,config_path.c_str());
++			if (size==0) WriteOut(MSG_Get("PROGRAM_CONFIG_NOCONFIGFILE"));
++			else {
++				WriteOut(MSG_Get("PROGRAM_CONFIG_PRIMARY_CONF"),control->configfiles.front().c_str());
++				if (size > 1) {
++					WriteOut(MSG_Get("PROGRAM_CONFIG_ADDITIONAL_CONF"));
++					for(Bitu i = 1; i < size; i++)
++						WriteOut("%s\n",control->configfiles[i].c_str());
++				}
++			}
++			if (control->startup_params.size() > 0) {
++				std::string test;
++				for(size_t k = 0; k < control->startup_params.size(); k++)
++					test += control->startup_params[k] + " ";
++				WriteOut(MSG_Get("PROGRAM_CONFIG_PRINT_STARTUP"), test.c_str());
++			}
++			break;
++		}
++		case P_WRITECONF: case P_WRITECONF2:
++			if (securemode_check()) return;
++			if (pvars.size() > 1) return;
++			else if (pvars.size() == 1) {
++				// write config to specific file, except if it is an absolute path
++				writeconf(pvars[0], !Cross::IsPathAbsolute(pvars[0]));
++			} else {
++				// -wc without parameter: write primary config file
++				if (control->configfiles.size()) writeconf(control->configfiles[0], false);
++				else WriteOut(MSG_Get("PROGRAM_CONFIG_NOCONFIGFILE"));
++			}
++			break;
++		case P_WRITECONF_DEFAULT: {
++			// write to /userdir/dosbox0.xx.conf
++			if (securemode_check()) return;
++			if (pvars.size() > 0) return;
++			std::string confname;
++			Cross::GetPlatformConfigName(confname);
++			writeconf(confname, true);
++			break;
+ 		}
+-		//Copy the found property to a new string and erase from templine (mind the space)
+-		std::string prop = temp_line.substr(space+1); temp_line.erase(space);
++		case P_WRITECONF_PORTABLE:
++			if (securemode_check()) return;
++			if (pvars.size() > 1) return;
++			else if (pvars.size() == 1) {
++				// write config to startup directory
++				writeconf(pvars[0], false);
++			} else {
++				// -wcp without parameter: write dosbox.conf to startup directory
++				if (control->configfiles.size()) writeconf(std::string("dosbox.conf"), false);
++				else WriteOut(MSG_Get("PROGRAM_CONFIG_NOCONFIGFILE"));
++			}
++			break;
+ 
+-		Section* sec = control->GetSection(temp_line.c_str());
+-		if(!sec) {
+-			WriteOut(MSG_Get("PROGRAM_CONFIG_SECTION_ERROR"),temp_line.c_str());
++		case P_NOPARAMS:
++			if (!first) break;
++
++		case P_NOMATCH:
++			WriteOut(MSG_Get("PROGRAM_CONFIG_USAGE"));
+ 			return;
++
++		case P_HELP: case P_HELP2: case P_HELP3: {
++			switch(pvars.size()) {
++			case 0:
++				WriteOut(MSG_Get("PROGRAM_CONFIG_USAGE"));
++				return;
++			case 1: {
++				if (!strcasecmp("sections",pvars[0].c_str())) {
++					// list the sections
++					WriteOut(MSG_Get("PROGRAM_CONFIG_HLP_SECTLIST"));
++					Bitu i = 0;
++					while(true) {
++						Section* sec = control->GetSection(i++);
++						if (!sec) break;
++						WriteOut("%s\n",sec->GetName());
++					}
++					return;
++				}
++				// if it's a section, leave it as one-param
++				Section* sec = control->GetSection(pvars[0].c_str());
++				if (!sec) {
++					// could be a property
++					sec = control->GetSectionFromProperty(pvars[0].c_str());
++					if (!sec) {
++						WriteOut(MSG_Get("PROGRAM_CONFIG_PROPERTY_ERROR"));
++						return;
++					}
++					pvars.insert(pvars.begin(),std::string(sec->GetName()));
++				}
++				break;
++			}
++			case 2: {
++				// sanity check
++				Section* sec = control->GetSection(pvars[0].c_str());
++				Section* sec2 = control->GetSectionFromProperty(pvars[1].c_str());
++				if (sec != sec2) {
++					WriteOut(MSG_Get("PROGRAM_CONFIG_PROPERTY_ERROR"));
++				}
++				break;
++			}
++			default:
++				WriteOut(MSG_Get("PROGRAM_CONFIG_USAGE"));
++				return;
++			}	
++			// if we have one value in pvars, it's a section
++			// two values are section + property
++			Section* sec = control->GetSection(pvars[0].c_str());
++			if (sec==NULL) {
++				WriteOut(MSG_Get("PROGRAM_CONFIG_PROPERTY_ERROR"));
++				return;
++			}
++			Section_prop* psec = dynamic_cast <Section_prop*>(sec);
++			if (psec==NULL) {
++				// failed; maybe it's the autoexec section?
++				Section_line* pline = dynamic_cast <Section_line*>(sec);
++				if (pline==NULL) E_Exit("Section dynamic cast failed.");
++
++				WriteOut(MSG_Get("PROGRAM_CONFIG_HLP_LINEHLP"),
++					pline->GetName(),
++					// this is 'unclean' but the autoexec section has no help associated
++					MSG_Get("AUTOEXEC_CONFIGFILE_HELP"),
++					pline->data.c_str() );
++				return;
++			} 
++			if (pvars.size()==1) {
++				size_t i = 0;
++				WriteOut(MSG_Get("PROGRAM_CONFIG_HLP_SECTHLP"),pvars[0].c_str());
++				while(true) {
++					// list the properties
++					Property* p = psec->Get_prop(i++);
++					if (p==NULL) break;
++					WriteOut("%s\n", p->propname.c_str());
++				}
++			} else {
++				// find the property by it's name
++				size_t i = 0;
++				while (true) {
++					Property *p = psec->Get_prop(i++);
++					if (p==NULL) break;
++					if (!strcasecmp(p->propname.c_str(),pvars[1].c_str())) {
++						// found it; make the list of possible values
++						std::string propvalues;
++						std::vector<Value> pv = p->GetValues();
++						
++						if (p->Get_type()==Value::V_BOOL) {
++							// possible values for boolean are true, false
++							propvalues += "true, false";
++						} else if (p->Get_type()==Value::V_INT) {
++							// print min, max for integer values if used
++							Prop_int* pint = dynamic_cast <Prop_int*>(p);
++							if (pint==NULL) E_Exit("Int property dynamic cast failed.");
++							if (pint->getMin() != pint->getMax()) {
++								std::ostringstream oss;
++								oss << pint->getMin();
++								oss << "..";
++								oss << pint->getMax();
++								propvalues += oss.str();
++							}
++						}
++						for(Bitu k = 0; k < pv.size(); k++) {
++							if (pv[k].ToString() =="%u")
++								propvalues += MSG_Get("PROGRAM_CONFIG_HLP_POSINT");
++							else propvalues += pv[k].ToString();
++							if ((k+1) < pv.size()) propvalues += ", ";
++						}
++
++						WriteOut(MSG_Get("PROGRAM_CONFIG_HLP_PROPHLP"),
++							p->propname.c_str(),
++							sec->GetName(),
++							p->Get_help(),propvalues.c_str(),
++							p->Get_Default_Value().ToString().c_str(),
++							p->GetValue().ToString().c_str());
++						// print 'changability'
++						if (p->getChange()==Property::Changeable::OnlyAtStart) {
++							WriteOut(MSG_Get("PROGRAM_CONFIG_HLP_NOCHANGE"));
++						}
++						return;
++					}
++				}
++				break;
++			}
++			return;
++		}
++		case P_AUTOEXEC_CLEAR: {
++			Section_line* sec = dynamic_cast <Section_line*>
++				(control->GetSection(std::string("autoexec")));
++			sec->data.clear();
++			break;
+ 		}
+-		std::string val = sec->GetPropValue(prop.c_str());
+-		if(val == NO_SUCH_PROPERTY) {
+-			WriteOut(MSG_Get("PROGRAM_CONFIG_NO_PROPERTY"),prop.c_str(),temp_line.c_str());   
++		case P_AUTOEXEC_ADD: {
++			if (pvars.size() == 0) {
++				WriteOut(MSG_Get("PROGRAM_CONFIG_MISSINGPARAM"));
++				return;
++			}
++			Section_line* sec = dynamic_cast <Section_line*>
++				(control->GetSection(std::string("autoexec")));
++
++			for(Bitu i = 0; i < pvars.size(); i++) sec->HandleInputline(pvars[i]);
++			break;
++		}
++		case P_AUTOEXEC_TYPE: {
++			Section_line* sec = dynamic_cast <Section_line*>
++				(control->GetSection(std::string("autoexec")));
++			WriteOut("\n%s",sec->data.c_str());
++			break;
++		}
++		case P_GETPROP: {
++			// "section property"
++			// "property"
++			// "section"
++			// "section" "property"
++			if (pvars.size()==0) {
++				WriteOut(MSG_Get("PROGRAM_CONFIG_GET_SYNTAX"));
++				return;
++			}
++			std::string::size_type spcpos = pvars[0].find_first_of(' ');
++			// split on the ' '
++			if (spcpos != std::string::npos) {
++				pvars.insert(++pvars.begin(),pvars[0].substr(spcpos+1));
++				pvars[0].erase(spcpos);
++			}
++			switch(pvars.size()) {
++			case 1: {
++				// property/section only
++				// is it a section?
++				Section* sec = control->GetSection(pvars[0].c_str());
++				if (sec) {
++					// list properties in section
++					Bitu i = 0;
++					Section_prop* psec = dynamic_cast <Section_prop*>(sec);
++					if (psec==NULL) {
++						// autoexec section
++						Section_line* pline = dynamic_cast <Section_line*>(sec);
++						if (pline==NULL) E_Exit("Section dynamic cast failed.");
++
++						WriteOut("%s",pline->data.c_str());
++						break;
++					}
++					while(true) {
++						// list the properties
++						Property* p = psec->Get_prop(i++);
++						if (p==NULL) break;
++						WriteOut("%s=%s\n", p->propname.c_str(),
++							p->GetValue().ToString().c_str());
++					}
++				} else {
++					// no: maybe it's a property?
++					sec = control->GetSectionFromProperty(pvars[0].c_str());
++					if (!sec) {
++						WriteOut(MSG_Get("PROGRAM_CONFIG_PROPERTY_ERROR"));
++						return;
++					}
++					// it's a property name
++					std::string val = sec->GetPropValue(pvars[0].c_str());
++					WriteOut("%s",val.c_str());
++					first_shell->SetEnv("CONFIG",val.c_str());
++				}
++				break;
++			}
++			case 2: {
++				// section + property
++				Section* sec = control->GetSection(pvars[0].c_str());
++				if (!sec) {
++					WriteOut(MSG_Get("PROGRAM_CONFIG_SECTION_ERROR"));
++					return;
++				}
++				std::string val = sec->GetPropValue(pvars[1].c_str());
++				if (val == NO_SUCH_PROPERTY) {
++					WriteOut(MSG_Get("PROGRAM_CONFIG_NO_PROPERTY"),
++						pvars[1].c_str(),pvars[0].c_str());   
++					return;
++				}
++				WriteOut("%s",val.c_str());
++				first_shell->SetEnv("CONFIG",val.c_str());
++				break;
++			}
++			default:
++				WriteOut(MSG_Get("PROGRAM_CONFIG_GET_SYNTAX"));
++				return;
++			}
+ 			return;
+ 		}
+-		WriteOut("%s",val.c_str());
+-		first_shell->SetEnv("CONFIG",val.c_str());
+-		return;
+-	}
++		case P_SETPROP:	{
++			// Code for the configuration changes
++			// Official format: config -set "section property=value"
++			// Accepted: with or without -set, 
++			// "section property value"
++			// "section property=value"
++			// "property" "value"
++			// "section" "property=value"
++			// "section" "property=value" "value" "value" ...
++			// "section" "property" "value" "value" ...
++			// "section property" "value" "value" ...
++			// "property" "value" "value" ...
++			// "property=value" "value" "value" ...
+ 
++			if (pvars.size()==0) {
++				WriteOut(MSG_Get("PROGRAM_CONFIG_SET_SYNTAX"));
++				return;
++			}
+ 
++			// add rest of command
++			std::string rest;
++			if (cmd->GetStringRemain(rest)) pvars.push_back(rest);
++
++			// attempt to split off the first word
++			std::string::size_type spcpos = pvars[0].find_first_of(' ');
++			std::string::size_type equpos = pvars[0].find_first_of('=');
++
++			if ((equpos != std::string::npos) && 
++				((spcpos == std::string::npos) || (equpos < spcpos))) {
++				// If we have a '=' possibly before a ' ' split on the =
++				pvars.insert(++pvars.begin(),pvars[0].substr(equpos+1));
++				pvars[0].erase(equpos);
++				// As we had a = the first thing must be a property now
++				Section* sec=control->GetSectionFromProperty(pvars[0].c_str());
++				if (sec) pvars.insert(pvars.begin(),std::string(sec->GetName()));
++				else {
++					WriteOut(MSG_Get("PROGRAM_CONFIG_PROPERTY_ERROR"));
++					return;
++				}
++				// order in the vector should be ok now
++			} else {
++				if ((spcpos != std::string::npos) &&
++					((equpos == std::string::npos) || (spcpos < equpos))) {
++					// ' ' before a possible '=', split on the ' '
++					pvars.insert(++pvars.begin(),pvars[0].substr(spcpos+1));
++					pvars[0].erase(spcpos);
++				}
++				// check if the first parameter is a section or property
++				Section* sec = control->GetSection(pvars[0].c_str());
++				if (!sec) {
++					// not a section: little duplicate from above
++					Section* sec=control->GetSectionFromProperty(pvars[0].c_str());
++					if (sec) pvars.insert(pvars.begin(),std::string(sec->GetName()));
++					else {
++						WriteOut(MSG_Get("PROGRAM_CONFIG_PROPERTY_ERROR"));
++						return;
++					}
++				} else {
++					// first of pvars is most likely a section, but could still be gus
++					// have a look at the second parameter
++					if (pvars.size() < 2) {
++						WriteOut(MSG_Get("PROGRAM_CONFIG_SET_SYNTAX"));
++						return;
++					}
++					std::string::size_type spcpos2 = pvars[1].find_first_of(' ');
++					std::string::size_type equpos2 = pvars[1].find_first_of('=');
++					if ((equpos2 != std::string::npos) && 
++						((spcpos2 == std::string::npos) || (equpos2 < spcpos2))) {
++						// split on the =
++						pvars.insert(pvars.begin()+2,pvars[1].substr(equpos2+1));
++						pvars[1].erase(equpos2);
++					} else if ((spcpos2 != std::string::npos) &&
++						((equpos2 == std::string::npos) || (spcpos2 < equpos2))) {
++						// split on the ' '
++						pvars.insert(pvars.begin()+2,pvars[1].substr(spcpos2+1));
++						pvars[1].erase(spcpos2);
++					}
++					// is this a property?
++					Section* sec2 = control->GetSectionFromProperty(pvars[1].c_str());
++					if (!sec2) {
++						// not a property, 
++						Section* sec3 = control->GetSectionFromProperty(pvars[0].c_str());
++						if (sec3) {
++							// section and property name are identical
++							pvars.insert(pvars.begin(),pvars[0]);
++						} // else has been checked above already
++					}
++				}
++			}
++			if(pvars.size() < 3) {
++				WriteOut(MSG_Get("PROGRAM_CONFIG_SET_SYNTAX"));
++				return;
++			}
++			// check if the property actually exists in the section
++			Section* sec2 = control->GetSectionFromProperty(pvars[1].c_str());
++			if (!sec2) {
++				WriteOut(MSG_Get("PROGRAM_CONFIG_NO_PROPERTY"),
++					pvars[1].c_str(),pvars[0].c_str());
++				return;
++			}
++			// Input has been parsed (pvar[0]=section, [1]=property, [2]=value)
++			// now execute
++			Section* tsec = control->GetSection(pvars[0]);
++			std::string value;
++			value += pvars[2];
++			for(Bitu i = 3; i < pvars.size(); i++) value += (std::string(" ") + pvars[i]);
++			std::string inputline = pvars[1] + "=" + value;
++			
++			tsec->ExecuteDestroy(false);
++			bool change_success = tsec->HandleInputline(inputline.c_str());
++			if (!change_success) WriteOut(MSG_Get("PROGRAM_CONFIG_VALUE_ERROR"),
++				value.c_str(),pvars[1].c_str());
++			tsec->ExecuteInit(false);
++			return;
++		}
++		case P_WRITELANG: case P_WRITELANG2:
++			// In secure mode don't allow a new languagefile to be created
++			// Who knows which kind of file we would overwrite.
++			if (securemode_check()) return;
++			if (pvars.size() < 1) {
++				WriteOut(MSG_Get("PROGRAM_CONFIG_MISSINGPARAM"));
++				return;
++			}
++			if (!MSG_Write(pvars[0].c_str())) {
++				WriteOut(MSG_Get("PROGRAM_CONFIG_FILE_ERROR"),pvars[0].c_str());
++				return;
++			}
++			break;
+ 
+-	/* Code for the configuration changes                                  *
+-	 * Official format: config -set "section property=value"               *
+-	 * Accepted: without quotes and/or without -set and/or without section *
+-	 *           and/or the "=" replaced by a " "                          */
+-
+-	if (cmd->FindString("-set",temp_line,true)) { //get all arguments
+-		std::string temp2 = "";
+-		cmd->GetStringRemain(temp2);//So -set n1 n2=n3 can be used without quotes
+-		if(temp2!="") temp_line = temp_line + " " + temp2;
+-	} else 	if(!cmd->GetStringRemain(temp_line)) {//no set 
+-			WriteOut(MSG_Get("PROGRAM_CONFIG_USAGE")); //and no arguments specified
++		case P_SECURE:
++			// Code for switching to secure mode
++			control->SwitchToSecureMode();
++			WriteOut(MSG_Get("PROGRAM_CONFIG_SECURE_ON"));
+ 			return;
+-	};
+-	//Wanted input: n1 n2=n3
+-	char copy[1024];
+-	strcpy(copy,temp_line.c_str());
+-	//seperate section from property
+-	const char* temp = strchr(copy,' ');
+-	if((temp && *temp) || (temp=strchr(copy,'=')) ) copy[temp++ - copy]= 0;
+-	else {
+-		WriteOut(MSG_Get("PROGRAM_CONFIG_USAGE"));
+-		return;
+-	}
+-	//if n1 n2 n3 then replace last space with =
+-	const char* sign = strchr(temp,'=');
+-	if(!sign) {
+-		sign = strchr(temp,' ');
+-		if(sign) {
+-			copy[sign - copy] = '=';
+-		} else {
+-			//2 items specified (no space nor = between n2 and n3
+-			//assume that they posted: property value
+-			//Try to determine the section.
+-			Section* sec=control->GetSectionFromProperty(copy);
+-			if(!sec){
+-				if(control->GetSectionFromProperty(temp)) return; //Weird situation:ignore
+-				WriteOut(MSG_Get("PROGRAM_CONFIG_PROPERTY_ERROR"),copy);
+-				return;
+-			} //Hack to allow config ems true
+-			char buffer[1024];strcpy(buffer,copy);strcat(buffer,"=");strcat(buffer,temp);
+-			sign = strchr(buffer,' '); 
+-			if(sign) buffer[sign - buffer] = '=';
+-			strcpy(copy,sec->GetName());
+-			temp = buffer;
++
++		default:
++			E_Exit("bug");
++			break;
+ 		}
++		first = false;
+ 	}
+-	
+-	/* Input processed. Now the real job starts
+-	 * copy contains the likely "sectionname" 
+-	 * temp contains "property=value" 
+-	 * the section is destroyed and a new input line is given to
+-	 * the configuration parser. Then the section is restarted.
+-	 */
+-	char* inputline = const_cast<char*>(temp);
+-	Section* sec = 0;
+-	sec = control->GetSection(copy);
+-	if(!sec) { WriteOut(MSG_Get("PROGRAM_CONFIG_SECTION_ERROR"),copy);return;}
+-	sec->ExecuteDestroy(false);
+-	sec->HandleInputline(inputline);
+-	sec->ExecuteInit(false);
+ 	return;
+ }
+ 
+@@ -401,12 +758,49 @@
+ 	CALLBACK_Setup(call_program,&PROGRAMS_Handler,CB_RETF,"internal program");
+ 	PROGRAMS_MakeFile("CONFIG.COM",CONFIG_ProgramStart);
+ 
+-	MSG_Add("PROGRAM_CONFIG_FILE_ERROR","Can't open file %s\n");
+-	MSG_Add("PROGRAM_CONFIG_USAGE","Config tool:\nUse -writeconf filename to write the current config.\nUse -writelang filename to write the current language strings.\n");
++	// listconf
++	MSG_Add("PROGRAM_CONFIG_NOCONFIGFILE","No config file loaded!\n");
++	MSG_Add("PROGRAM_CONFIG_PRIMARY_CONF","Primary config file: \n%s\n");
++	MSG_Add("PROGRAM_CONFIG_ADDITIONAL_CONF","Additional config files:\n");
++	MSG_Add("PROGRAM_CONFIG_CONFDIR","DOSBox %s configuration directory: \n%s\n\n");
++	
++	// writeconf
++	MSG_Add("PROGRAM_CONFIG_FILE_ERROR","\nCan't open file %s\n");
++	MSG_Add("PROGRAM_CONFIG_FILE_WHICH","Writing config file %s");
++	
++	// help
++	MSG_Add("PROGRAM_CONFIG_USAGE","Config tool:\n"\
++		"-writeconf or -wc without parameter: write to primary loaded config file.\n"\
++		"-writeconf or -wc with filename: write file to config directory.\n"\
++		"Use -writelang or -wl filename to write the current language strings.\n"\
++		"-r [parameters]\n Restart DOSBox, either using the previous parameters or any that are appended.\n"\
++		"-wcp [filename]\n Write config file to the program directory, dosbox.conf or the specified \n filename.\n"\
++		"-wcd\n Write to the default config file in the config directory.\n"\
++		"-l lists configuration parameters.\n"\
++		"-h, -help, -? sections / sectionname / propertyname\n"\
++		" Without parameters, displays this help screen. Add \"sections\" for a list of\n sections."\
++		" For info about a specific section or property add its name behind.\n"\
++		"-axclear clears the autoexec section.\n"\
++		"-axadd [line] adds a line to the autoexec section.\n"\
++		"-axtype prints the content of the autoexec section.\n"\
++		"-securemode switches to secure mode.\n"\
++		"-get \"section property\" returns the value of the property.\n"\
++		"-set \"section property=value\" sets the value." );
++	MSG_Add("PROGRAM_CONFIG_HLP_PROPHLP","Purpose of property \"%s\" (contained in section \"%s\"):\n%s\n\nPossible Values: %s\nDefault value: %s\nCurrent value: %s\n");
++	MSG_Add("PROGRAM_CONFIG_HLP_LINEHLP","Purpose of section \"%s\":\n%s\nCurrent value:\n%s\n");
++	MSG_Add("PROGRAM_CONFIG_HLP_NOCHANGE","This property cannot be changed at runtime.\n");
++	MSG_Add("PROGRAM_CONFIG_HLP_POSINT","positive integer"); 
++	MSG_Add("PROGRAM_CONFIG_HLP_SECTHLP","Section %s contains the following properties:\n");				
++	MSG_Add("PROGRAM_CONFIG_HLP_SECTLIST","DOSBox configuration contains the following sections:\n\n");
++
+ 	MSG_Add("PROGRAM_CONFIG_SECURE_ON","Switched to secure mode.\n");
+ 	MSG_Add("PROGRAM_CONFIG_SECURE_DISALLOW","This operation is not permitted in secure mode.\n");
+ 	MSG_Add("PROGRAM_CONFIG_SECTION_ERROR","Section %s doesn't exist.\n");
++	MSG_Add("PROGRAM_CONFIG_VALUE_ERROR","\"%s\" is not a valid value for property %s.\n");
+ 	MSG_Add("PROGRAM_CONFIG_PROPERTY_ERROR","No such section or property.\n");
+ 	MSG_Add("PROGRAM_CONFIG_NO_PROPERTY","There is no property %s in section %s.\n");
++	MSG_Add("PROGRAM_CONFIG_SET_SYNTAX","Correct syntax: config -set \"section property\".\n");
+ 	MSG_Add("PROGRAM_CONFIG_GET_SYNTAX","Correct syntax: config -get \"section property\".\n");
++	MSG_Add("PROGRAM_CONFIG_PRINT_STARTUP","\nDOSBox was started with the following command line parameters:\n%s");
++	MSG_Add("PROGRAM_CONFIG_MISSINGPARAM","Missing parameter.");
+ }
+diff -Nur dosbox-0.74/src/misc/setup.cpp dosbox/src/misc/setup.cpp
+--- dosbox-0.74/src/misc/setup.cpp	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/misc/setup.cpp	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,7 +16,6 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: setup.cpp,v 1.56 2009-05-27 09:15:42 qbix79 Exp $ */
+ 
+ #include "dosbox.h"
+ #include "cross.h"
+@@ -29,6 +28,8 @@
+ #include <list>
+ #include <stdlib.h>
+ #include <stdio.h>
++#include <limits>
++#include <limits.h>
+ 
+ using namespace std;
+ static std::string current_config_dir; // Set by parseconfigfile so Prop_path can use it to construct the realpath
+@@ -104,7 +105,7 @@
+ 	}
+ 	return false;
+ }
+-void Value::SetValue(string const& in,Etype _type) throw(WrongType) {
++bool Value::SetValue(string const& in,Etype _type) throw(WrongType) {
+ 	/* Throw exception if the current type isn't the wanted type 
+ 	 * Unless the wanted type is current.
+ 	 */
+@@ -113,21 +114,22 @@
+ 		if(type != V_NONE && type != _type) throw WrongType();
+ 		type = _type;
+ 	}
++	bool retval = true;
+ 	switch(type){
+ 		case V_HEX:
+-			set_hex(in);
++			retval = set_hex(in);
+ 			break;
+ 		case V_INT:
+-			set_int(in);
++			retval = set_int(in);
+ 			break;
+ 		case V_BOOL:
+-			set_bool(in);
++			retval = set_bool(in);
+ 			break;
+ 		case V_STRING:
+ 			set_string(in);
+ 			break;
+ 		case V_DOUBLE:
+-			set_double(in);
++			retval = set_double(in);
+ 			break;
+ 
+ 		case V_NONE:
+@@ -137,39 +139,51 @@
+ 			throw WrongType();
+ 			break;
+ 	}
++	return retval;
+ }
+ 
+-void Value::set_hex(std::string const& in) {
++bool Value::set_hex(std::string const& in) {
+ 	istringstream input(in);
+ 	input.flags(ios::hex);
+-	int result = 0;
++	Bits result = INT_MIN;
+ 	input >> result;
++	if(result == INT_MIN) return false;
+ 	_hex = result;
++	return true;
+ }
+ 
+-void Value::set_int(string const &in) {
++bool Value::set_int(string const &in) {
+ 	istringstream input(in);
+-	int result = 0;
++	Bits result = INT_MIN;
+ 	input >> result;
++	if(result == INT_MIN) return false;
+ 	_int = result;
++	return true;
+ }
+-void Value::set_double(string const &in) {
++bool Value::set_double(string const &in) {
+ 	istringstream input(in);
+-	double result = 0;
++	double result = std::numeric_limits<double>::infinity();
+ 	input >> result;
++	if(result == std::numeric_limits<double>::infinity()) return false;
+ 	_double = result;
++	return true;
+ }
+ 
+-void Value::set_bool(string const &in) {
++bool Value::set_bool(string const &in) {
+ 	istringstream input(in);
+ 	string result;
+ 	input >> result;
+-	_bool = true;
+ 	lowcase(result);
+-	/* valid false entries: 0 ,d*, f*, off  everything else gets true */
+-	if( !result.size() ) return;
+-	if(result[0] == '0' || result[0] == 'd' || result[0] == 'f' || result == "off") 
++	_bool = true; // TODO
++	if(!result.size()) return false;
++	
++	if(result=="0" || result=="disabled" || result=="false" || result=="off") {
+ 		_bool = false;
++	} else if(result=="1" || result=="enabled" || result=="true" || result=="on") {
++		_bool = true;
++	} else return false;
++	
++	return true;
+ }
+ 
+ void Value::set_string(string const & in) {
+@@ -242,27 +256,30 @@
+ 	return false;
+ }
+ 
+-void Prop_double::SetValue(std::string const& input){
+-	Value val(input,Value::V_DOUBLE);
+-	SetVal(val,false,true);
++bool Prop_double::SetValue(std::string const& input){
++	Value val;
++	if(!val.SetValue(input,Value::V_DOUBLE)) return false;
++	return SetVal(val,false,true);
+ }
+ 
+ //void Property::SetValue(char* input){ 
+ //	value.SetValue(input, Value::V_CURRENT);
+ //}
+-void Prop_int::SetValue(std::string const& input){;
+-	Value val(input,Value::V_INT);
+-	SetVal(val,false,true);
++bool Prop_int::SetValue(std::string const& input){;
++	Value val;
++	if(!val.SetValue(input,Value::V_INT)) return false;
++	bool retval = SetVal(val,false,true);
++	return retval;
+ }
+ 
+-void Prop_string::SetValue(std::string const& input){
++bool Prop_string::SetValue(std::string const& input){
+ 	//Special version for lowcase stuff
+ 	std::string temp(input);
+ 	//suggested values always case insensitive. 
+ 	//If there are none then it can be paths and such which are case sensitive
+ 	if(!suggested_values.empty()) lowcase(temp);
+ 	Value val(temp,Value::V_STRING);
+-	SetVal(val,false,true);
++	return SetVal(val,false,true);
+ }
+ bool Prop_string::CheckValue(Value const& in, bool warn){
+ 	if(suggested_values.empty()) return true;
+@@ -271,25 +288,25 @@
+ 			return true;
+ 		}
+ 		if((*it).ToString() == "%u") {
+-			Bitu value;
++			Bit32u value;
+ 			if(sscanf(in.ToString().c_str(),"%u",&value) == 1) {
+ 				return true;
+ 			}
+ 		}
+ 	}
+-	if(warn) LOG_MSG("\"%s\" is not a valid value for variable: %s.\nIt might now be reset it to default value: %s",in.ToString().c_str(),propname.c_str(),default_value.ToString().c_str());
++	if(warn) LOG_MSG("\"%s\" is not a valid value for variable: %s.\nIt might now be reset to the default value: %s",in.ToString().c_str(),propname.c_str(),default_value.ToString().c_str());
+ 	return false;
+ }
+ 
+-void Prop_path::SetValue(std::string const& input){
++bool Prop_path::SetValue(std::string const& input){
+ 	//Special version to merge realpath with it
+ 
+ 	Value val(input,Value::V_STRING);
+-	SetVal(val,false,true);
++	bool retval = SetVal(val,false,true);
+ 
+ 	if(input.empty()) {
+ 		realpath = "";
+-		return;
++		return false;
+ 	}
+ 	std::string workcopy(input);
+ 	Cross::ResolveHomedir(workcopy); //Parse ~ and friends
+@@ -297,20 +314,18 @@
+ 	if( current_config_dir.empty()) realpath = workcopy;
+ 	else realpath = current_config_dir + CROSS_FILESPLIT + workcopy;
+ 	//Absolute paths
+-#if defined (WIN32) || defined(OS2)
+-	if( workcopy.size() > 2 && workcopy[1] == ':' ) realpath = workcopy;
+-#else
+-	if( workcopy.size() > 1 && workcopy[0] == '/' ) realpath = workcopy;
+-#endif
++	if (Cross::IsPathAbsolute(workcopy)) realpath = workcopy;
++	return retval;
+ }
+ 	
+-void Prop_bool::SetValue(std::string const& input){
+-	value.SetValue(input,Value::V_BOOL);
++bool Prop_bool::SetValue(std::string const& input){
++	return value.SetValue(input,Value::V_BOOL);
+ }
+ 
+-void Prop_hex::SetValue(std::string const& input){
+-	Value val(input,Value::V_HEX);
+-	SetVal(val,false,true);
++bool Prop_hex::SetValue(std::string const& input){
++	Value val;
++	val.SetValue(input,Value::V_HEX);
++	return SetVal(val,false,true);
+ }
+ 
+ void Prop_multival::make_default_value(){
+@@ -331,15 +346,15 @@
+    
+ 
+ //TODO checkvalue stuff
+-void Prop_multival_remain::SetValue(std::string const& input) {
++bool Prop_multival_remain::SetValue(std::string const& input) {
+ 	Value val(input,Value::V_STRING);
+-	SetVal(val,false,true);
++	bool retval = SetVal(val,false,true);
+ 
+ 	std::string local(input);
+ 	int i = 0,number_of_properties = 0;
+ 	Property *p = section->Get_prop(0);
+ 	//No properties in this section. do nothing
+-	if(!p) return;
++	if(!p) return false;
+ 	
+ 	while( (section->Get_prop(number_of_properties)) )
+ 		number_of_properties++;
+@@ -364,22 +379,23 @@
+ 		Value valtest (in,p->Get_type());
+ 		if(!p->CheckValue(valtest,true)) {
+ 			make_default_value();
+-			return;
++			return false;
+ 		}
+ 		p->SetValue(in);
+ 	}
++	return retval;
+ }
+ 
+ //TODO checkvalue stuff
+-void Prop_multival::SetValue(std::string const& input) {
++bool Prop_multival::SetValue(std::string const& input) {
+ 	Value val(input,Value::V_STRING);
+-	SetVal(val,false,true);
++	bool retval = SetVal(val,false,true);
+ 
+ 	std::string local(input);
+ 	int i = 0;
+ 	Property *p = section->Get_prop(0);
+ 	//No properties in this section. do nothing
+-	if(!p) return;
++	if(!p) return false;
+ 	string::size_type loc = string::npos;
+ 	while( (p = section->Get_prop(i++)) ) {
+ 		//trim leading seperators
+@@ -398,11 +414,12 @@
+ 		Value valtest (in,p->Get_type());
+ 		if(!p->CheckValue(valtest,true)) {
+ 			make_default_value();
+-			return;
++			return false;
+ 		}
+ 		p->SetValue(in);
+ 
+ 	}
++	return retval;
+ }
+ 
+ const std::vector<Value>& Property::GetValues() const {
+@@ -563,20 +580,20 @@
+ }
+ 
+ //TODO double c_str
+-void Section_prop::HandleInputline(string const& gegevens){
++bool Section_prop::HandleInputline(string const& gegevens){
+ 	string str1 = gegevens;
+ 	string::size_type loc = str1.find('=');
+-	if(loc == string::npos) return;
++	if(loc == string::npos) return false;
+ 	string name = str1.substr(0,loc);
+ 	string val = str1.substr(loc + 1);
+ 	/* trim the results incase there were spaces somewhere */
+ 	trim(name);trim(val);
+ 	for(it tel=properties.begin();tel!=properties.end();tel++){
+ 		if(!strcasecmp((*tel)->propname.c_str(),name.c_str())){
+-			(*tel)->SetValue(val);
+-			return;
++			return (*tel)->SetValue(val);
+ 		}
+ 	}
++	return false;
+ }
+ 
+ void Section_prop::PrintData(FILE* outfile) const {
+@@ -596,9 +613,10 @@
+ 	return NO_SUCH_PROPERTY;
+ }
+ 
+-void Section_line::HandleInputline(string const& line){ 
++bool Section_line::HandleInputline(string const& line){ 
+ 	data+=line;
+ 	data+="\n";
++	return true;
+ }
+ 
+ void Section_line::PrintData(FILE* outfile) const {
+@@ -633,7 +651,7 @@
+ 			}
+ 			i=0;
+ 			char prefix[80];
+-			snprintf(prefix,80, "\n# %*s  ", maxwidth, "");
++			snprintf(prefix,80, "\n# %*s  ", (int)maxwidth, "");
+ 			while ((p = sec->Get_prop(i++))) {		
+ 				std::string help = p->Get_help();
+ 				std::string::size_type pos = std::string::npos;
+@@ -641,7 +659,7 @@
+ 					help.replace(pos, 1, prefix);
+ 				}
+ 		     
+-				fprintf(outfile, "# %*s: %s", maxwidth, p->propname.c_str(), help.c_str());
++				fprintf(outfile, "# %*s: %s", (int)maxwidth, p->propname.c_str(), help.c_str());
+ 
+ 				std::vector<Value> values = p->GetValues();
+ 				if (!values.empty()) {
+@@ -770,11 +788,13 @@
+ 
+ 
+ bool Config::ParseConfigFile(char const * const configfilename){
+-	static bool first_configfile = true;
++	//static bool first_configfile = true;
+ 	ifstream in(configfilename);
+ 	if (!in) return false;
+-	const char * settings_type = first_configfile?"primary":"additional";
+-	first_configfile = false;
++	const char * settings_type;
++	settings_type = (configfiles.size() == 0)? "primary":"additional";
++	configfiles.push_back(configfilename);
++	
+ 	LOG_MSG("CONFIG:Loading %s settings from config file %s", settings_type,configfilename);
+ 
+ 	//Get directory from configfilename, used with relative paths.
+@@ -824,6 +844,10 @@
+ 	return true;
+ }
+ 
++/*const char* Config::GetPrimaryConfigFile() {
++	return configfile.c_str();
++}*/
++
+ void Config::ParseEnv(char ** envp) {
+ 	for(char** env=envp; *env;env++) {
+ 		char copy[1024];
+@@ -850,6 +874,7 @@
+ 
+ 
+ void Config::StartUp(void) {
++	initialised=true;
+ 	(*_start_function)();
+ }
+ 
+@@ -930,6 +955,39 @@
+ 	return true;
+ }
+ 
++/* Only used for parsing command.com /C 
++ * Allowing /C dir and /Cdir
++ * Restoring quotes back into the commands so command /C mount d "/tmp/a b" works as intended
++ */
++bool CommandLine::FindStringRemainBegin(char const * const name,std::string & value) {
++	cmd_it it;value="";
++	if (!FindEntry(name,it)) {
++		size_t len = strlen(name);
++			for (it=cmds.begin();it!=cmds.end();it++) {
++				if (strncasecmp(name,(*it).c_str(),len)==0) {
++					std::string temp = ((*it).c_str() + len);
++					//Restore quotes for correct parsing in later stages
++					if(temp.find(" ") != std::string::npos)
++						value = std::string("\"") + temp + std::string("\"");
++					else
++						value = temp;
++					break;
++				}
++			}
++		if( it == cmds.end()) return false;
++	}
++	it++;
++	for (;it!=cmds.end();it++) {
++		value += " ";
++		std::string temp = (*it);
++		if(temp.find(" ") != std::string::npos)
++			value += std::string("\"") + temp + std::string("\"");
++		else
++			value += temp;
++	}
++	return true;
++}
++
+ bool CommandLine::GetStringRemain(std::string & value) {
+ 	if(!cmds.size()) return false;
+ 		
+@@ -946,6 +1004,90 @@
+ 	return (unsigned int)cmds.size();
+ }
+ 
++void CommandLine::FillVector(std::vector<std::string> & vector) {
++	for(cmd_it it=cmds.begin(); it != cmds.end(); it++) {
++		vector.push_back((*it));
++	}
++	// add back the \" if the parameter contained a space
++	for(Bitu i = 0; i < vector.size(); i++) {
++		if(vector[i].find(' ') != std::string::npos) {
++			vector[i] = "\""+vector[i]+"\"";
++		}
++	}
++}
++
++int CommandLine::GetParameterFromList(const char* const params[], std::vector<std::string> & output) {
++	// return values: 0 = P_NOMATCH, 1 = P_NOPARAMS
++	// TODO return nomoreparams
++	int retval = 1;
++	output.clear();
++	enum {
++		P_START, P_FIRSTNOMATCH, P_FIRSTMATCH
++	} parsestate = P_START;
++	cmd_it it = cmds.begin();
++	while(it!=cmds.end()) {
++		bool found = false;
++		for(Bitu i = 0; *params[i]!=0; i++) {
++			if (!strcasecmp((*it).c_str(),params[i])) {
++				// found a parameter
++				found = true;
++				switch(parsestate) {
++				case P_START:
++					retval = i+2;
++					parsestate = P_FIRSTMATCH;
++					break;
++				case P_FIRSTMATCH:
++				case P_FIRSTNOMATCH:
++					return retval;
++				}
++			}
++		}
++		if(!found) 
++			switch(parsestate) {
++			case P_START:
++				retval = 0; // no match
++				parsestate = P_FIRSTNOMATCH;
++				output.push_back(*it);
++				break;
++			case P_FIRSTMATCH:
++			case P_FIRSTNOMATCH:
++				output.push_back(*it);
++				break;
++			}
++		cmd_it itold = it;
++		it++;
++		cmds.erase(itold);
++
++	}
++	
++	return retval;
++/*
++bool CommandLine::FindEntry(char const * const name,cmd_it & it,bool neednext) {
++	for (it=cmds.begin();it!=cmds.end();it++) {
++		if (!strcasecmp((*it).c_str(),name)) {
++			cmd_it itnext=it;itnext++;
++			if (neednext && (itnext==cmds.end())) return false;
++			return true;
++		}
++	}
++	return false;
++*/
++
++
++/*
++	cmd_it it=cmds.begin();value=(*it++);
++	while(it != cmds.end()) {
++		if(params.
++
++		it++;
++	}
++*/
++	// find next parameter
++	//return -1;
++
++}
++
++
+ CommandLine::CommandLine(int argc,char const * const argv[]) {
+ 	if (argc>0) {
+ 		file_name=argv[0];
+diff -Nur dosbox-0.74/src/misc/support.cpp dosbox/src/misc/support.cpp
+--- dosbox-0.74/src/misc/support.cpp	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/misc/support.cpp	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,7 +16,6 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: support.cpp,v 1.37 2009-05-27 09:15:42 qbix79 Exp $ */
+ 
+ #include <string.h>
+ #include <stdlib.h>
+diff -Nur dosbox-0.74/src/platform/Makefile.in dosbox/src/platform/Makefile.in
+--- dosbox-0.74/src/platform/Makefile.in	2010-05-12 11:57:44.000000000 +0200
++++ dosbox/src/platform/Makefile.in	1970-01-01 01:00:00.000000000 +0100
+@@ -1,539 +0,0 @@
+-# Makefile.in generated by automake 1.11.1 from Makefile.am.
+-# @configure_input@
+-
+-# Copyright (C) 1994, 1995, 1996, 1997, 1998, 1999, 2000, 2001, 2002,
+-# 2003, 2004, 2005, 2006, 2007, 2008, 2009  Free Software Foundation,
+-# Inc.
+-# This Makefile.in is free software; the Free Software Foundation
+-# gives unlimited permission to copy and/or distribute it,
+-# with or without modifications, as long as this notice is preserved.
+-
+-# This program is distributed in the hope that it will be useful,
+-# but WITHOUT ANY WARRANTY, to the extent permitted by law; without
+-# even the implied warranty of MERCHANTABILITY or FITNESS FOR A
+-# PARTICULAR PURPOSE.
+-
+-@SET_MAKE@
+-VPATH = @srcdir@
+-pkgdatadir = $(datadir)/@PACKAGE@
+-pkgincludedir = $(includedir)/@PACKAGE@
+-pkglibdir = $(libdir)/@PACKAGE@
+-pkglibexecdir = $(libexecdir)/@PACKAGE@
+-am__cd = CDPATH="$${ZSH_VERSION+.}$(PATH_SEPARATOR)" && cd
+-install_sh_DATA = $(install_sh) -c -m 644
+-install_sh_PROGRAM = $(install_sh) -c
+-install_sh_SCRIPT = $(install_sh) -c
+-INSTALL_HEADER = $(INSTALL_DATA)
+-transform = $(program_transform_name)
+-NORMAL_INSTALL = :
+-PRE_INSTALL = :
+-POST_INSTALL = :
+-NORMAL_UNINSTALL = :
+-PRE_UNINSTALL = :
+-POST_UNINSTALL = :
+-build_triplet = @build@
+-host_triplet = @host@
+-subdir = src/platform
+-DIST_COMMON = $(srcdir)/Makefile.am $(srcdir)/Makefile.in
+-ACLOCAL_M4 = $(top_srcdir)/aclocal.m4
+-am__aclocal_m4_deps = $(top_srcdir)/acinclude.m4 \
+-	$(top_srcdir)/configure.in
+-am__configure_deps = $(am__aclocal_m4_deps) $(CONFIGURE_DEPENDENCIES) \
+-	$(ACLOCAL_M4)
+-mkinstalldirs = $(install_sh) -d
+-CONFIG_HEADER = $(top_builddir)/config.h
+-CONFIG_CLEAN_FILES =
+-CONFIG_CLEAN_VPATH_FILES =
+-SOURCES =
+-DIST_SOURCES =
+-RECURSIVE_TARGETS = all-recursive check-recursive dvi-recursive \
+-	html-recursive info-recursive install-data-recursive \
+-	install-dvi-recursive install-exec-recursive \
+-	install-html-recursive install-info-recursive \
+-	install-pdf-recursive install-ps-recursive install-recursive \
+-	installcheck-recursive installdirs-recursive pdf-recursive \
+-	ps-recursive uninstall-recursive
+-RECURSIVE_CLEAN_TARGETS = mostlyclean-recursive clean-recursive	\
+-  distclean-recursive maintainer-clean-recursive
+-AM_RECURSIVE_TARGETS = $(RECURSIVE_TARGETS:-recursive=) \
+-	$(RECURSIVE_CLEAN_TARGETS:-recursive=) tags TAGS ctags CTAGS \
+-	distdir
+-ETAGS = etags
+-CTAGS = ctags
+-DIST_SUBDIRS = $(SUBDIRS)
+-DISTFILES = $(DIST_COMMON) $(DIST_SOURCES) $(TEXINFOS) $(EXTRA_DIST)
+-am__relativize = \
+-  dir0=`pwd`; \
+-  sed_first='s,^\([^/]*\)/.*$$,\1,'; \
+-  sed_rest='s,^[^/]*/*,,'; \
+-  sed_last='s,^.*/\([^/]*\)$$,\1,'; \
+-  sed_butlast='s,/*[^/]*$$,,'; \
+-  while test -n "$$dir1"; do \
+-    first=`echo "$$dir1" | sed -e "$$sed_first"`; \
+-    if test "$$first" != "."; then \
+-      if test "$$first" = ".."; then \
+-        dir2=`echo "$$dir0" | sed -e "$$sed_last"`/"$$dir2"; \
+-        dir0=`echo "$$dir0" | sed -e "$$sed_butlast"`; \
+-      else \
+-        first2=`echo "$$dir2" | sed -e "$$sed_first"`; \
+-        if test "$$first2" = "$$first"; then \
+-          dir2=`echo "$$dir2" | sed -e "$$sed_rest"`; \
+-        else \
+-          dir2="../$$dir2"; \
+-        fi; \
+-        dir0="$$dir0"/"$$first"; \
+-      fi; \
+-    fi; \
+-    dir1=`echo "$$dir1" | sed -e "$$sed_rest"`; \
+-  done; \
+-  reldir="$$dir2"
+-ACLOCAL = @ACLOCAL@
+-ALSA_CFLAGS = @ALSA_CFLAGS@
+-ALSA_LIBS = @ALSA_LIBS@
+-AMTAR = @AMTAR@
+-AUTOCONF = @AUTOCONF@
+-AUTOHEADER = @AUTOHEADER@
+-AUTOMAKE = @AUTOMAKE@
+-AWK = @AWK@
+-CC = @CC@
+-CCDEPMODE = @CCDEPMODE@
+-CFLAGS = @CFLAGS@
+-CPP = @CPP@
+-CPPFLAGS = @CPPFLAGS@
+-CXX = @CXX@
+-CXXDEPMODE = @CXXDEPMODE@
+-CXXFLAGS = @CXXFLAGS@
+-CYGPATH_W = @CYGPATH_W@
+-DEFS = @DEFS@
+-DEPDIR = @DEPDIR@
+-ECHO_C = @ECHO_C@
+-ECHO_N = @ECHO_N@
+-ECHO_T = @ECHO_T@
+-EGREP = @EGREP@
+-EXEEXT = @EXEEXT@
+-GREP = @GREP@
+-INSTALL = @INSTALL@
+-INSTALL_DATA = @INSTALL_DATA@
+-INSTALL_PROGRAM = @INSTALL_PROGRAM@
+-INSTALL_SCRIPT = @INSTALL_SCRIPT@
+-INSTALL_STRIP_PROGRAM = @INSTALL_STRIP_PROGRAM@
+-LDFLAGS = @LDFLAGS@
+-LIBOBJS = @LIBOBJS@
+-LIBS = @LIBS@
+-LTLIBOBJS = @LTLIBOBJS@
+-MAKEINFO = @MAKEINFO@
+-MKDIR_P = @MKDIR_P@
+-OBJEXT = @OBJEXT@
+-PACKAGE = @PACKAGE@
+-PACKAGE_BUGREPORT = @PACKAGE_BUGREPORT@
+-PACKAGE_NAME = @PACKAGE_NAME@
+-PACKAGE_STRING = @PACKAGE_STRING@
+-PACKAGE_TARNAME = @PACKAGE_TARNAME@
+-PACKAGE_URL = @PACKAGE_URL@
+-PACKAGE_VERSION = @PACKAGE_VERSION@
+-PATH_SEPARATOR = @PATH_SEPARATOR@
+-RANLIB = @RANLIB@
+-SDL_CFLAGS = @SDL_CFLAGS@
+-SDL_CONFIG = @SDL_CONFIG@
+-SDL_LIBS = @SDL_LIBS@
+-SET_MAKE = @SET_MAKE@
+-SHELL = @SHELL@
+-STRIP = @STRIP@
+-VERSION = @VERSION@
+-WINDRES = @WINDRES@
+-abs_builddir = @abs_builddir@
+-abs_srcdir = @abs_srcdir@
+-abs_top_builddir = @abs_top_builddir@
+-abs_top_srcdir = @abs_top_srcdir@
+-ac_ct_CC = @ac_ct_CC@
+-ac_ct_CXX = @ac_ct_CXX@
+-am__include = @am__include@
+-am__leading_dot = @am__leading_dot@
+-am__quote = @am__quote@
+-am__tar = @am__tar@
+-am__untar = @am__untar@
+-bindir = @bindir@
+-build = @build@
+-build_alias = @build_alias@
+-build_cpu = @build_cpu@
+-build_os = @build_os@
+-build_vendor = @build_vendor@
+-builddir = @builddir@
+-datadir = @datadir@
+-datarootdir = @datarootdir@
+-docdir = @docdir@
+-dvidir = @dvidir@
+-exec_prefix = @exec_prefix@
+-host = @host@
+-host_alias = @host_alias@
+-host_cpu = @host_cpu@
+-host_os = @host_os@
+-host_vendor = @host_vendor@
+-htmldir = @htmldir@
+-includedir = @includedir@
+-infodir = @infodir@
+-install_sh = @install_sh@
+-libdir = @libdir@
+-libexecdir = @libexecdir@
+-localedir = @localedir@
+-localstatedir = @localstatedir@
+-mandir = @mandir@
+-mkdir_p = @mkdir_p@
+-oldincludedir = @oldincludedir@
+-pdfdir = @pdfdir@
+-prefix = @prefix@
+-program_transform_name = @program_transform_name@
+-psdir = @psdir@
+-sbindir = @sbindir@
+-sharedstatedir = @sharedstatedir@
+-srcdir = @srcdir@
+-sysconfdir = @sysconfdir@
+-target_alias = @target_alias@
+-top_build_prefix = @top_build_prefix@
+-top_builddir = @top_builddir@
+-top_srcdir = @top_srcdir@
+-SUBDIRS = visualc
+-EXTRA_DIST = sdl-win32.diff
+-all: all-recursive
+-
+-.SUFFIXES:
+-$(srcdir)/Makefile.in:  $(srcdir)/Makefile.am  $(am__configure_deps)
+-	@for dep in $?; do \
+-	  case '$(am__configure_deps)' in \
+-	    *$$dep*) \
+-	      ( cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh ) \
+-	        && { if test -f $@; then exit 0; else break; fi; }; \
+-	      exit 1;; \
+-	  esac; \
+-	done; \
+-	echo ' cd $(top_srcdir) && $(AUTOMAKE) --gnu src/platform/Makefile'; \
+-	$(am__cd) $(top_srcdir) && \
+-	  $(AUTOMAKE) --gnu src/platform/Makefile
+-.PRECIOUS: Makefile
+-Makefile: $(srcdir)/Makefile.in $(top_builddir)/config.status
+-	@case '$?' in \
+-	  *config.status*) \
+-	    cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh;; \
+-	  *) \
+-	    echo ' cd $(top_builddir) && $(SHELL) ./config.status $(subdir)/$@ $(am__depfiles_maybe)'; \
+-	    cd $(top_builddir) && $(SHELL) ./config.status $(subdir)/$@ $(am__depfiles_maybe);; \
+-	esac;
+-
+-$(top_builddir)/config.status: $(top_srcdir)/configure $(CONFIG_STATUS_DEPENDENCIES)
+-	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
+-
+-$(top_srcdir)/configure:  $(am__configure_deps)
+-	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
+-$(ACLOCAL_M4):  $(am__aclocal_m4_deps)
+-	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
+-$(am__aclocal_m4_deps):
+-
+-# This directory's subdirectories are mostly independent; you can cd
+-# into them and run `make' without going through this Makefile.
+-# To change the values of `make' variables: instead of editing Makefiles,
+-# (1) if the variable is set in `config.status', edit `config.status'
+-#     (which will cause the Makefiles to be regenerated when you run `make');
+-# (2) otherwise, pass the desired values on the `make' command line.
+-$(RECURSIVE_TARGETS):
+-	@fail= failcom='exit 1'; \
+-	for f in x $$MAKEFLAGS; do \
+-	  case $$f in \
+-	    *=* | --[!k]*);; \
+-	    *k*) failcom='fail=yes';; \
+-	  esac; \
+-	done; \
+-	dot_seen=no; \
+-	target=`echo $@ | sed s/-recursive//`; \
+-	list='$(SUBDIRS)'; for subdir in $$list; do \
+-	  echo "Making $$target in $$subdir"; \
+-	  if test "$$subdir" = "."; then \
+-	    dot_seen=yes; \
+-	    local_target="$$target-am"; \
+-	  else \
+-	    local_target="$$target"; \
+-	  fi; \
+-	  ($(am__cd) $$subdir && $(MAKE) $(AM_MAKEFLAGS) $$local_target) \
+-	  || eval $$failcom; \
+-	done; \
+-	if test "$$dot_seen" = "no"; then \
+-	  $(MAKE) $(AM_MAKEFLAGS) "$$target-am" || exit 1; \
+-	fi; test -z "$$fail"
+-
+-$(RECURSIVE_CLEAN_TARGETS):
+-	@fail= failcom='exit 1'; \
+-	for f in x $$MAKEFLAGS; do \
+-	  case $$f in \
+-	    *=* | --[!k]*);; \
+-	    *k*) failcom='fail=yes';; \
+-	  esac; \
+-	done; \
+-	dot_seen=no; \
+-	case "$@" in \
+-	  distclean-* | maintainer-clean-*) list='$(DIST_SUBDIRS)' ;; \
+-	  *) list='$(SUBDIRS)' ;; \
+-	esac; \
+-	rev=''; for subdir in $$list; do \
+-	  if test "$$subdir" = "."; then :; else \
+-	    rev="$$subdir $$rev"; \
+-	  fi; \
+-	done; \
+-	rev="$$rev ."; \
+-	target=`echo $@ | sed s/-recursive//`; \
+-	for subdir in $$rev; do \
+-	  echo "Making $$target in $$subdir"; \
+-	  if test "$$subdir" = "."; then \
+-	    local_target="$$target-am"; \
+-	  else \
+-	    local_target="$$target"; \
+-	  fi; \
+-	  ($(am__cd) $$subdir && $(MAKE) $(AM_MAKEFLAGS) $$local_target) \
+-	  || eval $$failcom; \
+-	done && test -z "$$fail"
+-tags-recursive:
+-	list='$(SUBDIRS)'; for subdir in $$list; do \
+-	  test "$$subdir" = . || ($(am__cd) $$subdir && $(MAKE) $(AM_MAKEFLAGS) tags); \
+-	done
+-ctags-recursive:
+-	list='$(SUBDIRS)'; for subdir in $$list; do \
+-	  test "$$subdir" = . || ($(am__cd) $$subdir && $(MAKE) $(AM_MAKEFLAGS) ctags); \
+-	done
+-
+-ID: $(HEADERS) $(SOURCES) $(LISP) $(TAGS_FILES)
+-	list='$(SOURCES) $(HEADERS) $(LISP) $(TAGS_FILES)'; \
+-	unique=`for i in $$list; do \
+-	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
+-	  done | \
+-	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
+-	      END { if (nonempty) { for (i in files) print i; }; }'`; \
+-	mkid -fID $$unique
+-tags: TAGS
+-
+-TAGS: tags-recursive $(HEADERS) $(SOURCES)  $(TAGS_DEPENDENCIES) \
+-		$(TAGS_FILES) $(LISP)
+-	set x; \
+-	here=`pwd`; \
+-	if ($(ETAGS) --etags-include --version) >/dev/null 2>&1; then \
+-	  include_option=--etags-include; \
+-	  empty_fix=.; \
+-	else \
+-	  include_option=--include; \
+-	  empty_fix=; \
+-	fi; \
+-	list='$(SUBDIRS)'; for subdir in $$list; do \
+-	  if test "$$subdir" = .; then :; else \
+-	    test ! -f $$subdir/TAGS || \
+-	      set "$$@" "$$include_option=$$here/$$subdir/TAGS"; \
+-	  fi; \
+-	done; \
+-	list='$(SOURCES) $(HEADERS)  $(LISP) $(TAGS_FILES)'; \
+-	unique=`for i in $$list; do \
+-	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
+-	  done | \
+-	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
+-	      END { if (nonempty) { for (i in files) print i; }; }'`; \
+-	shift; \
+-	if test -z "$(ETAGS_ARGS)$$*$$unique"; then :; else \
+-	  test -n "$$unique" || unique=$$empty_fix; \
+-	  if test $$# -gt 0; then \
+-	    $(ETAGS) $(ETAGSFLAGS) $(AM_ETAGSFLAGS) $(ETAGS_ARGS) \
+-	      "$$@" $$unique; \
+-	  else \
+-	    $(ETAGS) $(ETAGSFLAGS) $(AM_ETAGSFLAGS) $(ETAGS_ARGS) \
+-	      $$unique; \
+-	  fi; \
+-	fi
+-ctags: CTAGS
+-CTAGS: ctags-recursive $(HEADERS) $(SOURCES)  $(TAGS_DEPENDENCIES) \
+-		$(TAGS_FILES) $(LISP)
+-	list='$(SOURCES) $(HEADERS)  $(LISP) $(TAGS_FILES)'; \
+-	unique=`for i in $$list; do \
+-	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
+-	  done | \
+-	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
+-	      END { if (nonempty) { for (i in files) print i; }; }'`; \
+-	test -z "$(CTAGS_ARGS)$$unique" \
+-	  || $(CTAGS) $(CTAGSFLAGS) $(AM_CTAGSFLAGS) $(CTAGS_ARGS) \
+-	     $$unique
+-
+-GTAGS:
+-	here=`$(am__cd) $(top_builddir) && pwd` \
+-	  && $(am__cd) $(top_srcdir) \
+-	  && gtags -i $(GTAGS_ARGS) "$$here"
+-
+-distclean-tags:
+-	-rm -f TAGS ID GTAGS GRTAGS GSYMS GPATH tags
+-
+-distdir: $(DISTFILES)
+-	@srcdirstrip=`echo "$(srcdir)" | sed 's/[].[^$$\\*]/\\\\&/g'`; \
+-	topsrcdirstrip=`echo "$(top_srcdir)" | sed 's/[].[^$$\\*]/\\\\&/g'`; \
+-	list='$(DISTFILES)'; \
+-	  dist_files=`for file in $$list; do echo $$file; done | \
+-	  sed -e "s|^$$srcdirstrip/||;t" \
+-	      -e "s|^$$topsrcdirstrip/|$(top_builddir)/|;t"`; \
+-	case $$dist_files in \
+-	  */*) $(MKDIR_P) `echo "$$dist_files" | \
+-			   sed '/\//!d;s|^|$(distdir)/|;s,/[^/]*$$,,' | \
+-			   sort -u` ;; \
+-	esac; \
+-	for file in $$dist_files; do \
+-	  if test -f $$file || test -d $$file; then d=.; else d=$(srcdir); fi; \
+-	  if test -d $$d/$$file; then \
+-	    dir=`echo "/$$file" | sed -e 's,/[^/]*$$,,'`; \
+-	    if test -d "$(distdir)/$$file"; then \
+-	      find "$(distdir)/$$file" -type d ! -perm -700 -exec chmod u+rwx {} \;; \
+-	    fi; \
+-	    if test -d $(srcdir)/$$file && test $$d != $(srcdir); then \
+-	      cp -fpR $(srcdir)/$$file "$(distdir)$$dir" || exit 1; \
+-	      find "$(distdir)/$$file" -type d ! -perm -700 -exec chmod u+rwx {} \;; \
+-	    fi; \
+-	    cp -fpR $$d/$$file "$(distdir)$$dir" || exit 1; \
+-	  else \
+-	    test -f "$(distdir)/$$file" \
+-	    || cp -p $$d/$$file "$(distdir)/$$file" \
+-	    || exit 1; \
+-	  fi; \
+-	done
+-	@list='$(DIST_SUBDIRS)'; for subdir in $$list; do \
+-	  if test "$$subdir" = .; then :; else \
+-	    test -d "$(distdir)/$$subdir" \
+-	    || $(MKDIR_P) "$(distdir)/$$subdir" \
+-	    || exit 1; \
+-	  fi; \
+-	done
+-	@list='$(DIST_SUBDIRS)'; for subdir in $$list; do \
+-	  if test "$$subdir" = .; then :; else \
+-	    dir1=$$subdir; dir2="$(distdir)/$$subdir"; \
+-	    $(am__relativize); \
+-	    new_distdir=$$reldir; \
+-	    dir1=$$subdir; dir2="$(top_distdir)"; \
+-	    $(am__relativize); \
+-	    new_top_distdir=$$reldir; \
+-	    echo " (cd $$subdir && $(MAKE) $(AM_MAKEFLAGS) top_distdir="$$new_top_distdir" distdir="$$new_distdir" \\"; \
+-	    echo "     am__remove_distdir=: am__skip_length_check=: am__skip_mode_fix=: distdir)"; \
+-	    ($(am__cd) $$subdir && \
+-	      $(MAKE) $(AM_MAKEFLAGS) \
+-	        top_distdir="$$new_top_distdir" \
+-	        distdir="$$new_distdir" \
+-		am__remove_distdir=: \
+-		am__skip_length_check=: \
+-		am__skip_mode_fix=: \
+-	        distdir) \
+-	      || exit 1; \
+-	  fi; \
+-	done
+-check-am: all-am
+-check: check-recursive
+-all-am: Makefile
+-installdirs: installdirs-recursive
+-installdirs-am:
+-install: install-recursive
+-install-exec: install-exec-recursive
+-install-data: install-data-recursive
+-uninstall: uninstall-recursive
+-
+-install-am: all-am
+-	@$(MAKE) $(AM_MAKEFLAGS) install-exec-am install-data-am
+-
+-installcheck: installcheck-recursive
+-install-strip:
+-	$(MAKE) $(AM_MAKEFLAGS) INSTALL_PROGRAM="$(INSTALL_STRIP_PROGRAM)" \
+-	  install_sh_PROGRAM="$(INSTALL_STRIP_PROGRAM)" INSTALL_STRIP_FLAG=-s \
+-	  `test -z '$(STRIP)' || \
+-	    echo "INSTALL_PROGRAM_ENV=STRIPPROG='$(STRIP)'"` install
+-mostlyclean-generic:
+-
+-clean-generic:
+-
+-distclean-generic:
+-	-test -z "$(CONFIG_CLEAN_FILES)" || rm -f $(CONFIG_CLEAN_FILES)
+-	-test . = "$(srcdir)" || test -z "$(CONFIG_CLEAN_VPATH_FILES)" || rm -f $(CONFIG_CLEAN_VPATH_FILES)
+-
+-maintainer-clean-generic:
+-	@echo "This command is intended for maintainers to use"
+-	@echo "it deletes files that may require special tools to rebuild."
+-clean: clean-recursive
+-
+-clean-am: clean-generic mostlyclean-am
+-
+-distclean: distclean-recursive
+-	-rm -f Makefile
+-distclean-am: clean-am distclean-generic distclean-tags
+-
+-dvi: dvi-recursive
+-
+-dvi-am:
+-
+-html: html-recursive
+-
+-html-am:
+-
+-info: info-recursive
+-
+-info-am:
+-
+-install-data-am:
+-
+-install-dvi: install-dvi-recursive
+-
+-install-dvi-am:
+-
+-install-exec-am:
+-
+-install-html: install-html-recursive
+-
+-install-html-am:
+-
+-install-info: install-info-recursive
+-
+-install-info-am:
+-
+-install-man:
+-
+-install-pdf: install-pdf-recursive
+-
+-install-pdf-am:
+-
+-install-ps: install-ps-recursive
+-
+-install-ps-am:
+-
+-installcheck-am:
+-
+-maintainer-clean: maintainer-clean-recursive
+-	-rm -f Makefile
+-maintainer-clean-am: distclean-am maintainer-clean-generic
+-
+-mostlyclean: mostlyclean-recursive
+-
+-mostlyclean-am: mostlyclean-generic
+-
+-pdf: pdf-recursive
+-
+-pdf-am:
+-
+-ps: ps-recursive
+-
+-ps-am:
+-
+-uninstall-am:
+-
+-.MAKE: $(RECURSIVE_CLEAN_TARGETS) $(RECURSIVE_TARGETS) ctags-recursive \
+-	install-am install-strip tags-recursive
+-
+-.PHONY: $(RECURSIVE_CLEAN_TARGETS) $(RECURSIVE_TARGETS) CTAGS GTAGS \
+-	all all-am check check-am clean clean-generic ctags \
+-	ctags-recursive distclean distclean-generic distclean-tags \
+-	distdir dvi dvi-am html html-am info info-am install \
+-	install-am install-data install-data-am install-dvi \
+-	install-dvi-am install-exec install-exec-am install-html \
+-	install-html-am install-info install-info-am install-man \
+-	install-pdf install-pdf-am install-ps install-ps-am \
+-	install-strip installcheck installcheck-am installdirs \
+-	installdirs-am maintainer-clean maintainer-clean-generic \
+-	mostlyclean mostlyclean-generic pdf pdf-am ps ps-am tags \
+-	tags-recursive uninstall uninstall-am
+-
+-
+-# Tell versions [3.59,3.63) of GNU make to not export all variables.
+-# Otherwise a system limit (for SysV at least) may be exceeded.
+-.NOEXPORT:
+diff -Nur dosbox-0.74/src/platform/visualc/config.h dosbox/src/platform/visualc/config.h
+--- dosbox-0.74/src/platform/visualc/config.h	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/platform/visualc/config.h	2014-01-12 14:43:47.000000000 +0100
+@@ -1,4 +1,4 @@
+-#define VERSION "0.74"
++#define VERSION "SVN"
+ 
+ /* Define to 1 to enable internal debugger, requires libcurses */
+ #define C_DEBUG 0
+diff -Nur dosbox-0.74/src/platform/visualc/Makefile.in dosbox/src/platform/visualc/Makefile.in
+--- dosbox-0.74/src/platform/visualc/Makefile.in	2010-05-12 11:57:44.000000000 +0200
++++ dosbox/src/platform/visualc/Makefile.in	1970-01-01 01:00:00.000000000 +0100
+@@ -1,336 +0,0 @@
+-# Makefile.in generated by automake 1.11.1 from Makefile.am.
+-# @configure_input@
+-
+-# Copyright (C) 1994, 1995, 1996, 1997, 1998, 1999, 2000, 2001, 2002,
+-# 2003, 2004, 2005, 2006, 2007, 2008, 2009  Free Software Foundation,
+-# Inc.
+-# This Makefile.in is free software; the Free Software Foundation
+-# gives unlimited permission to copy and/or distribute it,
+-# with or without modifications, as long as this notice is preserved.
+-
+-# This program is distributed in the hope that it will be useful,
+-# but WITHOUT ANY WARRANTY, to the extent permitted by law; without
+-# even the implied warranty of MERCHANTABILITY or FITNESS FOR A
+-# PARTICULAR PURPOSE.
+-
+-@SET_MAKE@
+-VPATH = @srcdir@
+-pkgdatadir = $(datadir)/@PACKAGE@
+-pkgincludedir = $(includedir)/@PACKAGE@
+-pkglibdir = $(libdir)/@PACKAGE@
+-pkglibexecdir = $(libexecdir)/@PACKAGE@
+-am__cd = CDPATH="$${ZSH_VERSION+.}$(PATH_SEPARATOR)" && cd
+-install_sh_DATA = $(install_sh) -c -m 644
+-install_sh_PROGRAM = $(install_sh) -c
+-install_sh_SCRIPT = $(install_sh) -c
+-INSTALL_HEADER = $(INSTALL_DATA)
+-transform = $(program_transform_name)
+-NORMAL_INSTALL = :
+-PRE_INSTALL = :
+-POST_INSTALL = :
+-NORMAL_UNINSTALL = :
+-PRE_UNINSTALL = :
+-POST_UNINSTALL = :
+-build_triplet = @build@
+-host_triplet = @host@
+-subdir = src/platform/visualc
+-DIST_COMMON = $(srcdir)/Makefile.am $(srcdir)/Makefile.in
+-ACLOCAL_M4 = $(top_srcdir)/aclocal.m4
+-am__aclocal_m4_deps = $(top_srcdir)/acinclude.m4 \
+-	$(top_srcdir)/configure.in
+-am__configure_deps = $(am__aclocal_m4_deps) $(CONFIGURE_DEPENDENCIES) \
+-	$(ACLOCAL_M4)
+-mkinstalldirs = $(install_sh) -d
+-CONFIG_HEADER = $(top_builddir)/config.h
+-CONFIG_CLEAN_FILES =
+-CONFIG_CLEAN_VPATH_FILES =
+-SOURCES =
+-DIST_SOURCES =
+-DISTFILES = $(DIST_COMMON) $(DIST_SOURCES) $(TEXINFOS) $(EXTRA_DIST)
+-ACLOCAL = @ACLOCAL@
+-ALSA_CFLAGS = @ALSA_CFLAGS@
+-ALSA_LIBS = @ALSA_LIBS@
+-AMTAR = @AMTAR@
+-AUTOCONF = @AUTOCONF@
+-AUTOHEADER = @AUTOHEADER@
+-AUTOMAKE = @AUTOMAKE@
+-AWK = @AWK@
+-CC = @CC@
+-CCDEPMODE = @CCDEPMODE@
+-CFLAGS = @CFLAGS@
+-CPP = @CPP@
+-CPPFLAGS = @CPPFLAGS@
+-CXX = @CXX@
+-CXXDEPMODE = @CXXDEPMODE@
+-CXXFLAGS = @CXXFLAGS@
+-CYGPATH_W = @CYGPATH_W@
+-DEFS = @DEFS@
+-DEPDIR = @DEPDIR@
+-ECHO_C = @ECHO_C@
+-ECHO_N = @ECHO_N@
+-ECHO_T = @ECHO_T@
+-EGREP = @EGREP@
+-EXEEXT = @EXEEXT@
+-GREP = @GREP@
+-INSTALL = @INSTALL@
+-INSTALL_DATA = @INSTALL_DATA@
+-INSTALL_PROGRAM = @INSTALL_PROGRAM@
+-INSTALL_SCRIPT = @INSTALL_SCRIPT@
+-INSTALL_STRIP_PROGRAM = @INSTALL_STRIP_PROGRAM@
+-LDFLAGS = @LDFLAGS@
+-LIBOBJS = @LIBOBJS@
+-LIBS = @LIBS@
+-LTLIBOBJS = @LTLIBOBJS@
+-MAKEINFO = @MAKEINFO@
+-MKDIR_P = @MKDIR_P@
+-OBJEXT = @OBJEXT@
+-PACKAGE = @PACKAGE@
+-PACKAGE_BUGREPORT = @PACKAGE_BUGREPORT@
+-PACKAGE_NAME = @PACKAGE_NAME@
+-PACKAGE_STRING = @PACKAGE_STRING@
+-PACKAGE_TARNAME = @PACKAGE_TARNAME@
+-PACKAGE_URL = @PACKAGE_URL@
+-PACKAGE_VERSION = @PACKAGE_VERSION@
+-PATH_SEPARATOR = @PATH_SEPARATOR@
+-RANLIB = @RANLIB@
+-SDL_CFLAGS = @SDL_CFLAGS@
+-SDL_CONFIG = @SDL_CONFIG@
+-SDL_LIBS = @SDL_LIBS@
+-SET_MAKE = @SET_MAKE@
+-SHELL = @SHELL@
+-STRIP = @STRIP@
+-VERSION = @VERSION@
+-WINDRES = @WINDRES@
+-abs_builddir = @abs_builddir@
+-abs_srcdir = @abs_srcdir@
+-abs_top_builddir = @abs_top_builddir@
+-abs_top_srcdir = @abs_top_srcdir@
+-ac_ct_CC = @ac_ct_CC@
+-ac_ct_CXX = @ac_ct_CXX@
+-am__include = @am__include@
+-am__leading_dot = @am__leading_dot@
+-am__quote = @am__quote@
+-am__tar = @am__tar@
+-am__untar = @am__untar@
+-bindir = @bindir@
+-build = @build@
+-build_alias = @build_alias@
+-build_cpu = @build_cpu@
+-build_os = @build_os@
+-build_vendor = @build_vendor@
+-builddir = @builddir@
+-datadir = @datadir@
+-datarootdir = @datarootdir@
+-docdir = @docdir@
+-dvidir = @dvidir@
+-exec_prefix = @exec_prefix@
+-host = @host@
+-host_alias = @host_alias@
+-host_cpu = @host_cpu@
+-host_os = @host_os@
+-host_vendor = @host_vendor@
+-htmldir = @htmldir@
+-includedir = @includedir@
+-infodir = @infodir@
+-install_sh = @install_sh@
+-libdir = @libdir@
+-libexecdir = @libexecdir@
+-localedir = @localedir@
+-localstatedir = @localstatedir@
+-mandir = @mandir@
+-mkdir_p = @mkdir_p@
+-oldincludedir = @oldincludedir@
+-pdfdir = @pdfdir@
+-prefix = @prefix@
+-program_transform_name = @program_transform_name@
+-psdir = @psdir@
+-sbindir = @sbindir@
+-sharedstatedir = @sharedstatedir@
+-srcdir = @srcdir@
+-sysconfdir = @sysconfdir@
+-target_alias = @target_alias@
+-top_build_prefix = @top_build_prefix@
+-top_builddir = @top_builddir@
+-top_srcdir = @top_srcdir@
+-EXTRA_DIST = unistd.h config.h ntddscsi.h ntddcdrm.h
+-all: all-am
+-
+-.SUFFIXES:
+-$(srcdir)/Makefile.in:  $(srcdir)/Makefile.am  $(am__configure_deps)
+-	@for dep in $?; do \
+-	  case '$(am__configure_deps)' in \
+-	    *$$dep*) \
+-	      ( cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh ) \
+-	        && { if test -f $@; then exit 0; else break; fi; }; \
+-	      exit 1;; \
+-	  esac; \
+-	done; \
+-	echo ' cd $(top_srcdir) && $(AUTOMAKE) --gnu src/platform/visualc/Makefile'; \
+-	$(am__cd) $(top_srcdir) && \
+-	  $(AUTOMAKE) --gnu src/platform/visualc/Makefile
+-.PRECIOUS: Makefile
+-Makefile: $(srcdir)/Makefile.in $(top_builddir)/config.status
+-	@case '$?' in \
+-	  *config.status*) \
+-	    cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh;; \
+-	  *) \
+-	    echo ' cd $(top_builddir) && $(SHELL) ./config.status $(subdir)/$@ $(am__depfiles_maybe)'; \
+-	    cd $(top_builddir) && $(SHELL) ./config.status $(subdir)/$@ $(am__depfiles_maybe);; \
+-	esac;
+-
+-$(top_builddir)/config.status: $(top_srcdir)/configure $(CONFIG_STATUS_DEPENDENCIES)
+-	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
+-
+-$(top_srcdir)/configure:  $(am__configure_deps)
+-	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
+-$(ACLOCAL_M4):  $(am__aclocal_m4_deps)
+-	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
+-$(am__aclocal_m4_deps):
+-tags: TAGS
+-TAGS:
+-
+-ctags: CTAGS
+-CTAGS:
+-
+-
+-distdir: $(DISTFILES)
+-	@srcdirstrip=`echo "$(srcdir)" | sed 's/[].[^$$\\*]/\\\\&/g'`; \
+-	topsrcdirstrip=`echo "$(top_srcdir)" | sed 's/[].[^$$\\*]/\\\\&/g'`; \
+-	list='$(DISTFILES)'; \
+-	  dist_files=`for file in $$list; do echo $$file; done | \
+-	  sed -e "s|^$$srcdirstrip/||;t" \
+-	      -e "s|^$$topsrcdirstrip/|$(top_builddir)/|;t"`; \
+-	case $$dist_files in \
+-	  */*) $(MKDIR_P) `echo "$$dist_files" | \
+-			   sed '/\//!d;s|^|$(distdir)/|;s,/[^/]*$$,,' | \
+-			   sort -u` ;; \
+-	esac; \
+-	for file in $$dist_files; do \
+-	  if test -f $$file || test -d $$file; then d=.; else d=$(srcdir); fi; \
+-	  if test -d $$d/$$file; then \
+-	    dir=`echo "/$$file" | sed -e 's,/[^/]*$$,,'`; \
+-	    if test -d "$(distdir)/$$file"; then \
+-	      find "$(distdir)/$$file" -type d ! -perm -700 -exec chmod u+rwx {} \;; \
+-	    fi; \
+-	    if test -d $(srcdir)/$$file && test $$d != $(srcdir); then \
+-	      cp -fpR $(srcdir)/$$file "$(distdir)$$dir" || exit 1; \
+-	      find "$(distdir)/$$file" -type d ! -perm -700 -exec chmod u+rwx {} \;; \
+-	    fi; \
+-	    cp -fpR $$d/$$file "$(distdir)$$dir" || exit 1; \
+-	  else \
+-	    test -f "$(distdir)/$$file" \
+-	    || cp -p $$d/$$file "$(distdir)/$$file" \
+-	    || exit 1; \
+-	  fi; \
+-	done
+-check-am: all-am
+-check: check-am
+-all-am: Makefile
+-installdirs:
+-install: install-am
+-install-exec: install-exec-am
+-install-data: install-data-am
+-uninstall: uninstall-am
+-
+-install-am: all-am
+-	@$(MAKE) $(AM_MAKEFLAGS) install-exec-am install-data-am
+-
+-installcheck: installcheck-am
+-install-strip:
+-	$(MAKE) $(AM_MAKEFLAGS) INSTALL_PROGRAM="$(INSTALL_STRIP_PROGRAM)" \
+-	  install_sh_PROGRAM="$(INSTALL_STRIP_PROGRAM)" INSTALL_STRIP_FLAG=-s \
+-	  `test -z '$(STRIP)' || \
+-	    echo "INSTALL_PROGRAM_ENV=STRIPPROG='$(STRIP)'"` install
+-mostlyclean-generic:
+-
+-clean-generic:
+-
+-distclean-generic:
+-	-test -z "$(CONFIG_CLEAN_FILES)" || rm -f $(CONFIG_CLEAN_FILES)
+-	-test . = "$(srcdir)" || test -z "$(CONFIG_CLEAN_VPATH_FILES)" || rm -f $(CONFIG_CLEAN_VPATH_FILES)
+-
+-maintainer-clean-generic:
+-	@echo "This command is intended for maintainers to use"
+-	@echo "it deletes files that may require special tools to rebuild."
+-clean: clean-am
+-
+-clean-am: clean-generic mostlyclean-am
+-
+-distclean: distclean-am
+-	-rm -f Makefile
+-distclean-am: clean-am distclean-generic
+-
+-dvi: dvi-am
+-
+-dvi-am:
+-
+-html: html-am
+-
+-html-am:
+-
+-info: info-am
+-
+-info-am:
+-
+-install-data-am:
+-
+-install-dvi: install-dvi-am
+-
+-install-dvi-am:
+-
+-install-exec-am:
+-
+-install-html: install-html-am
+-
+-install-html-am:
+-
+-install-info: install-info-am
+-
+-install-info-am:
+-
+-install-man:
+-
+-install-pdf: install-pdf-am
+-
+-install-pdf-am:
+-
+-install-ps: install-ps-am
+-
+-install-ps-am:
+-
+-installcheck-am:
+-
+-maintainer-clean: maintainer-clean-am
+-	-rm -f Makefile
+-maintainer-clean-am: distclean-am maintainer-clean-generic
+-
+-mostlyclean: mostlyclean-am
+-
+-mostlyclean-am: mostlyclean-generic
+-
+-pdf: pdf-am
+-
+-pdf-am:
+-
+-ps: ps-am
+-
+-ps-am:
+-
+-uninstall-am:
+-
+-.MAKE: install-am install-strip
+-
+-.PHONY: all all-am check check-am clean clean-generic distclean \
+-	distclean-generic distdir dvi dvi-am html html-am info info-am \
+-	install install-am install-data install-data-am install-dvi \
+-	install-dvi-am install-exec install-exec-am install-html \
+-	install-html-am install-info install-info-am install-man \
+-	install-pdf install-pdf-am install-ps install-ps-am \
+-	install-strip installcheck installcheck-am installdirs \
+-	maintainer-clean maintainer-clean-generic mostlyclean \
+-	mostlyclean-generic pdf pdf-am ps ps-am uninstall uninstall-am
+-
+-
+-# Tell versions [3.59,3.63) of GNU make to not export all variables.
+-# Otherwise a system limit (for SysV at least) may be exceeded.
+-.NOEXPORT:
+diff -Nur dosbox-0.74/src/shell/Makefile.in dosbox/src/shell/Makefile.in
+--- dosbox-0.74/src/shell/Makefile.in	2010-05-12 11:57:44.000000000 +0200
++++ dosbox/src/shell/Makefile.in	1970-01-01 01:00:00.000000000 +0100
+@@ -1,443 +0,0 @@
+-# Makefile.in generated by automake 1.11.1 from Makefile.am.
+-# @configure_input@
+-
+-# Copyright (C) 1994, 1995, 1996, 1997, 1998, 1999, 2000, 2001, 2002,
+-# 2003, 2004, 2005, 2006, 2007, 2008, 2009  Free Software Foundation,
+-# Inc.
+-# This Makefile.in is free software; the Free Software Foundation
+-# gives unlimited permission to copy and/or distribute it,
+-# with or without modifications, as long as this notice is preserved.
+-
+-# This program is distributed in the hope that it will be useful,
+-# but WITHOUT ANY WARRANTY, to the extent permitted by law; without
+-# even the implied warranty of MERCHANTABILITY or FITNESS FOR A
+-# PARTICULAR PURPOSE.
+-
+-@SET_MAKE@
+-
+-VPATH = @srcdir@
+-pkgdatadir = $(datadir)/@PACKAGE@
+-pkgincludedir = $(includedir)/@PACKAGE@
+-pkglibdir = $(libdir)/@PACKAGE@
+-pkglibexecdir = $(libexecdir)/@PACKAGE@
+-am__cd = CDPATH="$${ZSH_VERSION+.}$(PATH_SEPARATOR)" && cd
+-install_sh_DATA = $(install_sh) -c -m 644
+-install_sh_PROGRAM = $(install_sh) -c
+-install_sh_SCRIPT = $(install_sh) -c
+-INSTALL_HEADER = $(INSTALL_DATA)
+-transform = $(program_transform_name)
+-NORMAL_INSTALL = :
+-PRE_INSTALL = :
+-POST_INSTALL = :
+-NORMAL_UNINSTALL = :
+-PRE_UNINSTALL = :
+-POST_UNINSTALL = :
+-build_triplet = @build@
+-host_triplet = @host@
+-subdir = src/shell
+-DIST_COMMON = $(srcdir)/Makefile.am $(srcdir)/Makefile.in
+-ACLOCAL_M4 = $(top_srcdir)/aclocal.m4
+-am__aclocal_m4_deps = $(top_srcdir)/acinclude.m4 \
+-	$(top_srcdir)/configure.in
+-am__configure_deps = $(am__aclocal_m4_deps) $(CONFIGURE_DEPENDENCIES) \
+-	$(ACLOCAL_M4)
+-mkinstalldirs = $(install_sh) -d
+-CONFIG_HEADER = $(top_builddir)/config.h
+-CONFIG_CLEAN_FILES =
+-CONFIG_CLEAN_VPATH_FILES =
+-LIBRARIES = $(noinst_LIBRARIES)
+-AR = ar
+-ARFLAGS = cru
+-libshell_a_AR = $(AR) $(ARFLAGS)
+-libshell_a_LIBADD =
+-am_libshell_a_OBJECTS = shell.$(OBJEXT) shell_batch.$(OBJEXT) \
+-	shell_cmds.$(OBJEXT) shell_misc.$(OBJEXT)
+-libshell_a_OBJECTS = $(am_libshell_a_OBJECTS)
+-DEFAULT_INCLUDES = -I.@am__isrc@ -I$(top_builddir)
+-depcomp = $(SHELL) $(top_srcdir)/depcomp
+-am__depfiles_maybe = depfiles
+-am__mv = mv -f
+-CXXCOMPILE = $(CXX) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) \
+-	$(AM_CPPFLAGS) $(CPPFLAGS) $(AM_CXXFLAGS) $(CXXFLAGS)
+-CXXLD = $(CXX)
+-CXXLINK = $(CXXLD) $(AM_CXXFLAGS) $(CXXFLAGS) $(AM_LDFLAGS) $(LDFLAGS) \
+-	-o $@
+-SOURCES = $(libshell_a_SOURCES)
+-DIST_SOURCES = $(libshell_a_SOURCES)
+-ETAGS = etags
+-CTAGS = ctags
+-DISTFILES = $(DIST_COMMON) $(DIST_SOURCES) $(TEXINFOS) $(EXTRA_DIST)
+-ACLOCAL = @ACLOCAL@
+-ALSA_CFLAGS = @ALSA_CFLAGS@
+-ALSA_LIBS = @ALSA_LIBS@
+-AMTAR = @AMTAR@
+-AUTOCONF = @AUTOCONF@
+-AUTOHEADER = @AUTOHEADER@
+-AUTOMAKE = @AUTOMAKE@
+-AWK = @AWK@
+-CC = @CC@
+-CCDEPMODE = @CCDEPMODE@
+-CFLAGS = @CFLAGS@
+-CPP = @CPP@
+-CPPFLAGS = @CPPFLAGS@
+-CXX = @CXX@
+-CXXDEPMODE = @CXXDEPMODE@
+-CXXFLAGS = @CXXFLAGS@
+-CYGPATH_W = @CYGPATH_W@
+-DEFS = @DEFS@
+-DEPDIR = @DEPDIR@
+-ECHO_C = @ECHO_C@
+-ECHO_N = @ECHO_N@
+-ECHO_T = @ECHO_T@
+-EGREP = @EGREP@
+-EXEEXT = @EXEEXT@
+-GREP = @GREP@
+-INSTALL = @INSTALL@
+-INSTALL_DATA = @INSTALL_DATA@
+-INSTALL_PROGRAM = @INSTALL_PROGRAM@
+-INSTALL_SCRIPT = @INSTALL_SCRIPT@
+-INSTALL_STRIP_PROGRAM = @INSTALL_STRIP_PROGRAM@
+-LDFLAGS = @LDFLAGS@
+-LIBOBJS = @LIBOBJS@
+-LIBS = @LIBS@
+-LTLIBOBJS = @LTLIBOBJS@
+-MAKEINFO = @MAKEINFO@
+-MKDIR_P = @MKDIR_P@
+-OBJEXT = @OBJEXT@
+-PACKAGE = @PACKAGE@
+-PACKAGE_BUGREPORT = @PACKAGE_BUGREPORT@
+-PACKAGE_NAME = @PACKAGE_NAME@
+-PACKAGE_STRING = @PACKAGE_STRING@
+-PACKAGE_TARNAME = @PACKAGE_TARNAME@
+-PACKAGE_URL = @PACKAGE_URL@
+-PACKAGE_VERSION = @PACKAGE_VERSION@
+-PATH_SEPARATOR = @PATH_SEPARATOR@
+-RANLIB = @RANLIB@
+-SDL_CFLAGS = @SDL_CFLAGS@
+-SDL_CONFIG = @SDL_CONFIG@
+-SDL_LIBS = @SDL_LIBS@
+-SET_MAKE = @SET_MAKE@
+-SHELL = @SHELL@
+-STRIP = @STRIP@
+-VERSION = @VERSION@
+-WINDRES = @WINDRES@
+-abs_builddir = @abs_builddir@
+-abs_srcdir = @abs_srcdir@
+-abs_top_builddir = @abs_top_builddir@
+-abs_top_srcdir = @abs_top_srcdir@
+-ac_ct_CC = @ac_ct_CC@
+-ac_ct_CXX = @ac_ct_CXX@
+-am__include = @am__include@
+-am__leading_dot = @am__leading_dot@
+-am__quote = @am__quote@
+-am__tar = @am__tar@
+-am__untar = @am__untar@
+-bindir = @bindir@
+-build = @build@
+-build_alias = @build_alias@
+-build_cpu = @build_cpu@
+-build_os = @build_os@
+-build_vendor = @build_vendor@
+-builddir = @builddir@
+-datadir = @datadir@
+-datarootdir = @datarootdir@
+-docdir = @docdir@
+-dvidir = @dvidir@
+-exec_prefix = @exec_prefix@
+-host = @host@
+-host_alias = @host_alias@
+-host_cpu = @host_cpu@
+-host_os = @host_os@
+-host_vendor = @host_vendor@
+-htmldir = @htmldir@
+-includedir = @includedir@
+-infodir = @infodir@
+-install_sh = @install_sh@
+-libdir = @libdir@
+-libexecdir = @libexecdir@
+-localedir = @localedir@
+-localstatedir = @localstatedir@
+-mandir = @mandir@
+-mkdir_p = @mkdir_p@
+-oldincludedir = @oldincludedir@
+-pdfdir = @pdfdir@
+-prefix = @prefix@
+-program_transform_name = @program_transform_name@
+-psdir = @psdir@
+-sbindir = @sbindir@
+-sharedstatedir = @sharedstatedir@
+-srcdir = @srcdir@
+-sysconfdir = @sysconfdir@
+-target_alias = @target_alias@
+-top_build_prefix = @top_build_prefix@
+-top_builddir = @top_builddir@
+-top_srcdir = @top_srcdir@
+-AM_CPPFLAGS = -I$(top_srcdir)/include
+-noinst_LIBRARIES = libshell.a
+-libshell_a_SOURCES = shell.cpp shell_batch.cpp shell_cmds.cpp shell_misc.cpp
+-all: all-am
+-
+-.SUFFIXES:
+-.SUFFIXES: .cpp .o .obj
+-$(srcdir)/Makefile.in:  $(srcdir)/Makefile.am  $(am__configure_deps)
+-	@for dep in $?; do \
+-	  case '$(am__configure_deps)' in \
+-	    *$$dep*) \
+-	      ( cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh ) \
+-	        && { if test -f $@; then exit 0; else break; fi; }; \
+-	      exit 1;; \
+-	  esac; \
+-	done; \
+-	echo ' cd $(top_srcdir) && $(AUTOMAKE) --gnu src/shell/Makefile'; \
+-	$(am__cd) $(top_srcdir) && \
+-	  $(AUTOMAKE) --gnu src/shell/Makefile
+-.PRECIOUS: Makefile
+-Makefile: $(srcdir)/Makefile.in $(top_builddir)/config.status
+-	@case '$?' in \
+-	  *config.status*) \
+-	    cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh;; \
+-	  *) \
+-	    echo ' cd $(top_builddir) && $(SHELL) ./config.status $(subdir)/$@ $(am__depfiles_maybe)'; \
+-	    cd $(top_builddir) && $(SHELL) ./config.status $(subdir)/$@ $(am__depfiles_maybe);; \
+-	esac;
+-
+-$(top_builddir)/config.status: $(top_srcdir)/configure $(CONFIG_STATUS_DEPENDENCIES)
+-	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
+-
+-$(top_srcdir)/configure:  $(am__configure_deps)
+-	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
+-$(ACLOCAL_M4):  $(am__aclocal_m4_deps)
+-	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
+-$(am__aclocal_m4_deps):
+-
+-clean-noinstLIBRARIES:
+-	-test -z "$(noinst_LIBRARIES)" || rm -f $(noinst_LIBRARIES)
+-libshell.a: $(libshell_a_OBJECTS) $(libshell_a_DEPENDENCIES) 
+-	-rm -f libshell.a
+-	$(libshell_a_AR) libshell.a $(libshell_a_OBJECTS) $(libshell_a_LIBADD)
+-	$(RANLIB) libshell.a
+-
+-mostlyclean-compile:
+-	-rm -f *.$(OBJEXT)
+-
+-distclean-compile:
+-	-rm -f *.tab.c
+-
+-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/shell.Po@am__quote@
+-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/shell_batch.Po@am__quote@
+-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/shell_cmds.Po@am__quote@
+-@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/shell_misc.Po@am__quote@
+-
+-.cpp.o:
+-@am__fastdepCXX_TRUE@	$(CXXCOMPILE) -MT $@ -MD -MP -MF $(DEPDIR)/$*.Tpo -c -o $@ $<
+-@am__fastdepCXX_TRUE@	$(am__mv) $(DEPDIR)/$*.Tpo $(DEPDIR)/$*.Po
+-@AMDEP_TRUE@@am__fastdepCXX_FALSE@	source='$<' object='$@' libtool=no @AMDEPBACKSLASH@
+-@AMDEP_TRUE@@am__fastdepCXX_FALSE@	DEPDIR=$(DEPDIR) $(CXXDEPMODE) $(depcomp) @AMDEPBACKSLASH@
+-@am__fastdepCXX_FALSE@	$(CXXCOMPILE) -c -o $@ $<
+-
+-.cpp.obj:
+-@am__fastdepCXX_TRUE@	$(CXXCOMPILE) -MT $@ -MD -MP -MF $(DEPDIR)/$*.Tpo -c -o $@ `$(CYGPATH_W) '$<'`
+-@am__fastdepCXX_TRUE@	$(am__mv) $(DEPDIR)/$*.Tpo $(DEPDIR)/$*.Po
+-@AMDEP_TRUE@@am__fastdepCXX_FALSE@	source='$<' object='$@' libtool=no @AMDEPBACKSLASH@
+-@AMDEP_TRUE@@am__fastdepCXX_FALSE@	DEPDIR=$(DEPDIR) $(CXXDEPMODE) $(depcomp) @AMDEPBACKSLASH@
+-@am__fastdepCXX_FALSE@	$(CXXCOMPILE) -c -o $@ `$(CYGPATH_W) '$<'`
+-
+-ID: $(HEADERS) $(SOURCES) $(LISP) $(TAGS_FILES)
+-	list='$(SOURCES) $(HEADERS) $(LISP) $(TAGS_FILES)'; \
+-	unique=`for i in $$list; do \
+-	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
+-	  done | \
+-	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
+-	      END { if (nonempty) { for (i in files) print i; }; }'`; \
+-	mkid -fID $$unique
+-tags: TAGS
+-
+-TAGS:  $(HEADERS) $(SOURCES)  $(TAGS_DEPENDENCIES) \
+-		$(TAGS_FILES) $(LISP)
+-	set x; \
+-	here=`pwd`; \
+-	list='$(SOURCES) $(HEADERS)  $(LISP) $(TAGS_FILES)'; \
+-	unique=`for i in $$list; do \
+-	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
+-	  done | \
+-	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
+-	      END { if (nonempty) { for (i in files) print i; }; }'`; \
+-	shift; \
+-	if test -z "$(ETAGS_ARGS)$$*$$unique"; then :; else \
+-	  test -n "$$unique" || unique=$$empty_fix; \
+-	  if test $$# -gt 0; then \
+-	    $(ETAGS) $(ETAGSFLAGS) $(AM_ETAGSFLAGS) $(ETAGS_ARGS) \
+-	      "$$@" $$unique; \
+-	  else \
+-	    $(ETAGS) $(ETAGSFLAGS) $(AM_ETAGSFLAGS) $(ETAGS_ARGS) \
+-	      $$unique; \
+-	  fi; \
+-	fi
+-ctags: CTAGS
+-CTAGS:  $(HEADERS) $(SOURCES)  $(TAGS_DEPENDENCIES) \
+-		$(TAGS_FILES) $(LISP)
+-	list='$(SOURCES) $(HEADERS)  $(LISP) $(TAGS_FILES)'; \
+-	unique=`for i in $$list; do \
+-	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
+-	  done | \
+-	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
+-	      END { if (nonempty) { for (i in files) print i; }; }'`; \
+-	test -z "$(CTAGS_ARGS)$$unique" \
+-	  || $(CTAGS) $(CTAGSFLAGS) $(AM_CTAGSFLAGS) $(CTAGS_ARGS) \
+-	     $$unique
+-
+-GTAGS:
+-	here=`$(am__cd) $(top_builddir) && pwd` \
+-	  && $(am__cd) $(top_srcdir) \
+-	  && gtags -i $(GTAGS_ARGS) "$$here"
+-
+-distclean-tags:
+-	-rm -f TAGS ID GTAGS GRTAGS GSYMS GPATH tags
+-
+-distdir: $(DISTFILES)
+-	@srcdirstrip=`echo "$(srcdir)" | sed 's/[].[^$$\\*]/\\\\&/g'`; \
+-	topsrcdirstrip=`echo "$(top_srcdir)" | sed 's/[].[^$$\\*]/\\\\&/g'`; \
+-	list='$(DISTFILES)'; \
+-	  dist_files=`for file in $$list; do echo $$file; done | \
+-	  sed -e "s|^$$srcdirstrip/||;t" \
+-	      -e "s|^$$topsrcdirstrip/|$(top_builddir)/|;t"`; \
+-	case $$dist_files in \
+-	  */*) $(MKDIR_P) `echo "$$dist_files" | \
+-			   sed '/\//!d;s|^|$(distdir)/|;s,/[^/]*$$,,' | \
+-			   sort -u` ;; \
+-	esac; \
+-	for file in $$dist_files; do \
+-	  if test -f $$file || test -d $$file; then d=.; else d=$(srcdir); fi; \
+-	  if test -d $$d/$$file; then \
+-	    dir=`echo "/$$file" | sed -e 's,/[^/]*$$,,'`; \
+-	    if test -d "$(distdir)/$$file"; then \
+-	      find "$(distdir)/$$file" -type d ! -perm -700 -exec chmod u+rwx {} \;; \
+-	    fi; \
+-	    if test -d $(srcdir)/$$file && test $$d != $(srcdir); then \
+-	      cp -fpR $(srcdir)/$$file "$(distdir)$$dir" || exit 1; \
+-	      find "$(distdir)/$$file" -type d ! -perm -700 -exec chmod u+rwx {} \;; \
+-	    fi; \
+-	    cp -fpR $$d/$$file "$(distdir)$$dir" || exit 1; \
+-	  else \
+-	    test -f "$(distdir)/$$file" \
+-	    || cp -p $$d/$$file "$(distdir)/$$file" \
+-	    || exit 1; \
+-	  fi; \
+-	done
+-check-am: all-am
+-check: check-am
+-all-am: Makefile $(LIBRARIES)
+-installdirs:
+-install: install-am
+-install-exec: install-exec-am
+-install-data: install-data-am
+-uninstall: uninstall-am
+-
+-install-am: all-am
+-	@$(MAKE) $(AM_MAKEFLAGS) install-exec-am install-data-am
+-
+-installcheck: installcheck-am
+-install-strip:
+-	$(MAKE) $(AM_MAKEFLAGS) INSTALL_PROGRAM="$(INSTALL_STRIP_PROGRAM)" \
+-	  install_sh_PROGRAM="$(INSTALL_STRIP_PROGRAM)" INSTALL_STRIP_FLAG=-s \
+-	  `test -z '$(STRIP)' || \
+-	    echo "INSTALL_PROGRAM_ENV=STRIPPROG='$(STRIP)'"` install
+-mostlyclean-generic:
+-
+-clean-generic:
+-
+-distclean-generic:
+-	-test -z "$(CONFIG_CLEAN_FILES)" || rm -f $(CONFIG_CLEAN_FILES)
+-	-test . = "$(srcdir)" || test -z "$(CONFIG_CLEAN_VPATH_FILES)" || rm -f $(CONFIG_CLEAN_VPATH_FILES)
+-
+-maintainer-clean-generic:
+-	@echo "This command is intended for maintainers to use"
+-	@echo "it deletes files that may require special tools to rebuild."
+-clean: clean-am
+-
+-clean-am: clean-generic clean-noinstLIBRARIES mostlyclean-am
+-
+-distclean: distclean-am
+-	-rm -rf ./$(DEPDIR)
+-	-rm -f Makefile
+-distclean-am: clean-am distclean-compile distclean-generic \
+-	distclean-tags
+-
+-dvi: dvi-am
+-
+-dvi-am:
+-
+-html: html-am
+-
+-html-am:
+-
+-info: info-am
+-
+-info-am:
+-
+-install-data-am:
+-
+-install-dvi: install-dvi-am
+-
+-install-dvi-am:
+-
+-install-exec-am:
+-
+-install-html: install-html-am
+-
+-install-html-am:
+-
+-install-info: install-info-am
+-
+-install-info-am:
+-
+-install-man:
+-
+-install-pdf: install-pdf-am
+-
+-install-pdf-am:
+-
+-install-ps: install-ps-am
+-
+-install-ps-am:
+-
+-installcheck-am:
+-
+-maintainer-clean: maintainer-clean-am
+-	-rm -rf ./$(DEPDIR)
+-	-rm -f Makefile
+-maintainer-clean-am: distclean-am maintainer-clean-generic
+-
+-mostlyclean: mostlyclean-am
+-
+-mostlyclean-am: mostlyclean-compile mostlyclean-generic
+-
+-pdf: pdf-am
+-
+-pdf-am:
+-
+-ps: ps-am
+-
+-ps-am:
+-
+-uninstall-am:
+-
+-.MAKE: install-am install-strip
+-
+-.PHONY: CTAGS GTAGS all all-am check check-am clean clean-generic \
+-	clean-noinstLIBRARIES ctags distclean distclean-compile \
+-	distclean-generic distclean-tags distdir dvi dvi-am html \
+-	html-am info info-am install install-am install-data \
+-	install-data-am install-dvi install-dvi-am install-exec \
+-	install-exec-am install-html install-html-am install-info \
+-	install-info-am install-man install-pdf install-pdf-am \
+-	install-ps install-ps-am install-strip installcheck \
+-	installcheck-am installdirs maintainer-clean \
+-	maintainer-clean-generic mostlyclean mostlyclean-compile \
+-	mostlyclean-generic pdf pdf-am ps ps-am tags uninstall \
+-	uninstall-am
+-
+-
+-# Tell versions [3.59,3.63) of GNU make to not export all variables.
+-# Otherwise a system limit (for SysV at least) may be exceeded.
+-.NOEXPORT:
+diff -Nur dosbox-0.74/src/shell/shell_batch.cpp dosbox/src/shell/shell_batch.cpp
+--- dosbox-0.74/src/shell/shell_batch.cpp	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/shell/shell_batch.cpp	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,7 +16,6 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: shell_batch.cpp,v 1.36 2009-07-03 19:36:56 qbix79 Exp $ */
+ 
+ #include <stdlib.h>
+ #include <string.h>
+diff -Nur dosbox-0.74/src/shell/shell_cmds.cpp dosbox/src/shell/shell_cmds.cpp
+--- dosbox-0.74/src/shell/shell_cmds.cpp	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/shell/shell_cmds.cpp	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,12 +16,12 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: shell_cmds.cpp,v 1.93 2009-09-21 21:04:25 h-a-l-9000 Exp $ */
+ 
+ #include "dosbox.h"
+ #include "shell.h"
+ #include "callback.h"
+ #include "regs.h"
++#include "bios.h"
+ #include "../dos/drives.h"
+ #include "support.h"
+ #include "control.h"
+@@ -30,6 +30,7 @@
+ #include <cstdlib>
+ #include <vector>
+ #include <string>
++#include <time.h>
+ 
+ static SHELL_Cmd cmd_list[]={
+ {	"DIR",		0,			&DOS_Shell::CMD_DIR,		"SHELL_CMD_DIR_HELP"},
+@@ -40,6 +41,7 @@
+ {	"CHOICE",	1,			&DOS_Shell::CMD_CHOICE,		"SHELL_CMD_CHOICE_HELP"},
+ {	"CLS",		0,			&DOS_Shell::CMD_CLS,		"SHELL_CMD_CLS_HELP"},
+ {	"COPY",		0,			&DOS_Shell::CMD_COPY,		"SHELL_CMD_COPY_HELP"},
++{	"DATE",		0,			&DOS_Shell::CMD_DATE,		"SHELL_CMD_DATE_HELP"},
+ {	"DEL",		0,			&DOS_Shell::CMD_DELETE,		"SHELL_CMD_DELETE_HELP"},
+ {	"DELETE",	1,			&DOS_Shell::CMD_DELETE,		"SHELL_CMD_DELETE_HELP"},
+ {	"ERASE",	1,			&DOS_Shell::CMD_DELETE,		"SHELL_CMD_DELETE_HELP"},
+@@ -62,6 +64,7 @@
+ {	"SET",		1,			&DOS_Shell::CMD_SET,		"SHELL_CMD_SET_HELP"},
+ {	"SHIFT",	1,			&DOS_Shell::CMD_SHIFT,		"SHELL_CMD_SHIFT_HELP"},
+ {	"SUBST",	1,			&DOS_Shell::CMD_SUBST,		"SHELL_CMD_SUBST_HELP"},
++{	"TIME",		0,			&DOS_Shell::CMD_TIME,		"SHELL_CMD_TIME_HELP"},
+ {	"TYPE",		0,			&DOS_Shell::CMD_TYPE,		"SHELL_CMD_TYPE_HELP"},
+ {	"VER",		0,			&DOS_Shell::CMD_VER,		"SHELL_CMD_VER_HELP"},
+ {0,0,0,0}
+@@ -108,7 +111,7 @@
+ 		if(val != NO_SUCH_PROPERTY) WriteOut("%s\n",val.c_str());
+ 		return true;
+ 	}
+-	char newcom[1024]; newcom[0] = 0; strcpy(newcom,"z:\\config ");
++	char newcom[1024]; newcom[0] = 0; strcpy(newcom,"z:\\config -set ");
+ 	strcat(newcom,test->GetName());	strcat(newcom," ");
+ 	strcat(newcom,cmd_in);strcat(newcom,line);
+ 	DoCommand(newcom);
+@@ -121,11 +124,12 @@
+ 	char cmd_buffer[CMD_MAXLINE];
+ 	char * cmd_write=cmd_buffer;
+ 	while (*line) {
+-		if (*line==32) break;
+-		if (*line=='/') break;
+-		if (*line=='\t') break;
+-		if (*line=='=') break;
+-		if ((*line=='.') ||(*line =='\\')) {  //allow stuff like cd.. and dir.exe cd\kees
++		if (*line == 32) break;
++		if (*line == '/') break;
++		if (*line == '\t') break;
++		if (*line == '=') break;
++//		if (*line == ':') break; //This breaks drive switching as that is handled at a later stage. 
++		if ((*line == '.') ||(*line == '\\')) {  //allow stuff like cd.. and dir.exe cd\kees
+ 			*cmd_write=0;
+ 			Bit32u cmd_index=0;
+ 			while (cmd_list[cmd_index].name) {
+@@ -285,7 +289,7 @@
+ 	args++;//skip first character. either a slash or dot or space
+ 	size_t len = strlen(args); //TODO check input of else ook nodig is.
+ 	if(len && args[len - 1] == '\r') {
+-		LOG(LOG_MISC,LOG_WARN)("Hu ? carriage return allready present. Is this possible?");
++		LOG(LOG_MISC,LOG_WARN)("Hu ? carriage return already present. Is this possible?");
+ 		WriteOut("%s\n",args);
+ 	} else WriteOut("%s\r\n",args);
+ }
+@@ -366,8 +370,8 @@
+ 	}
+ }
+ 
+-static void FormatNumber(Bitu num,char * buf) {
+-	Bitu numm,numk,numb,numg;
++static void FormatNumber(Bit32u num,char * buf) {
++	Bit32u numm,numk,numb,numg;
+ 	numb=num % 1000;
+ 	num/=1000;
+ 	numk=num % 1000;
+@@ -571,6 +575,7 @@
+ 	while(ScanCMDBool(args,"A")) ;
+ 	ScanCMDBool(args,"Y");
+ 	ScanCMDBool(args,"-Y");
++	ScanCMDBool(args,"V");
+ 
+ 	char * rem=ScanCMDRemain(args);
+ 	if (rem) {
+@@ -586,6 +591,14 @@
+ 	while ( (source_p = StripWord(args)) && *source_p ) {
+ 		do {
+ 			char* plus = strchr(source_p,'+');
++			// If StripWord() previously cut at a space before a plus then
++			// set concatenate flag on last source and remove leading plus.
++			if (plus == source_p && sources.size()) {
++				sources[sources.size()-1].concat = true;
++				// If spaces also followed plus then item is only a plus.
++				if (strlen(++source_p)==0) break;
++				plus = strchr(source_p,'+');
++			}
+ 			if (plus) *plus++ = 0;
+ 			safe_strncpy(source_x,source_p,CROSS_LEN);
+ 			bool has_drive_spec = false;
+@@ -593,10 +606,10 @@
+ 			if (source_x_len>0) {
+ 				if (source_x[source_x_len-1]==':') has_drive_spec = true;
+ 			}
+-			if (!has_drive_spec) {
++			if (!has_drive_spec  && !strpbrk(source_p,"*?") ) { //doubt that fu*\*.* is valid
+ 				if (DOS_FindFirst(source_p,0xffff & ~DOS_ATTR_VOLUME)) {
+ 					dta.GetResult(name,size,date,time,attr);
+-					if (attr & DOS_ATTR_DIRECTORY && !strstr(source_p,"*.*"))
++					if (attr & DOS_ATTR_DIRECTORY)
+ 						strcat(source_x,"\\*.*");
+ 				}
+ 			}
+@@ -739,6 +752,11 @@
+ 		}
+ 		return;
+ 	}
++	//There are args:
++	char * pcheck = args;
++	while ( *pcheck && (*pcheck == ' ' || *pcheck == '\t')) pcheck++;
++	if (*pcheck && strlen(pcheck) >3 && (strncasecmp(pcheck,"/p ",3) == 0)) E_Exit("Set /P is not supported. Use Choice!");
++
+ 	char * p=strpbrk(args, "=");
+ 	if (!p) {
+ 		if (!GetEnvStr(args,line)) WriteOut(MSG_Get("SHELL_CMD_SET_NOT_SET"),args);
+@@ -930,6 +948,107 @@
+ 	this->call=false;
+ }
+ 
++void DOS_Shell::CMD_DATE(char * args) {
++	HELP("DATE");	
++	if(ScanCMDBool(args,"H")) {
++		// synchronize date with host parameter
++		time_t curtime;
++		struct tm *loctime;
++		curtime = time (NULL);
++		loctime = localtime (&curtime);
++		
++		reg_cx = loctime->tm_year+1900;
++		reg_dh = loctime->tm_mon+1;
++		reg_dl = loctime->tm_mday;
++
++		reg_ah=0x2b; // set system date
++		CALLBACK_RunRealInt(0x21);
++		return;
++	}
++	// check if a date was passed in command line
++	Bit32u newday,newmonth,newyear;
++	if(sscanf(args,"%u-%u-%u",&newmonth,&newday,&newyear)==3) {
++		reg_cx = static_cast<Bit16u>(newyear);
++		reg_dh = static_cast<Bit8u>(newmonth);
++		reg_dl = static_cast<Bit8u>(newday);
++
++		reg_ah=0x2b; // set system date
++		CALLBACK_RunRealInt(0x21);
++		if(reg_al==0xff) WriteOut(MSG_Get("SHELL_CMD_DATE_ERROR"));
++		return;
++	}
++	// display the current date
++	reg_ah=0x2a; // get system date
++	CALLBACK_RunRealInt(0x21);
++
++	const char* datestring = MSG_Get("SHELL_CMD_DATE_DAYS");
++	Bit32u length;
++	char day[6] = {0};
++	if(sscanf(datestring,"%u",&length) && (length<5) && (strlen(datestring)==(length*7+1))) {
++		// date string appears valid
++		for(Bit32u i = 0; i < length; i++) day[i] = datestring[reg_al*length+1+i];
++	}
++	bool dateonly = ScanCMDBool(args,"T");
++	if(!dateonly) WriteOut(MSG_Get("SHELL_CMD_DATE_NOW"));
++
++	const char* formatstring = MSG_Get("SHELL_CMD_DATE_FORMAT");
++	if(strlen(formatstring)!=5) return;
++	char buffer[15] = {0};
++	Bitu bufferptr=0;
++	for(Bitu i = 0; i < 5; i++) {
++		if(i==1 || i==3) {
++			buffer[bufferptr] = formatstring[i];
++			bufferptr++;
++		} else {
++			if(formatstring[i]=='M') bufferptr += sprintf(buffer+bufferptr,"%02u",(Bit8u) reg_dh);
++			if(formatstring[i]=='D') bufferptr += sprintf(buffer+bufferptr,"%02u",(Bit8u) reg_dl);
++			if(formatstring[i]=='Y') bufferptr += sprintf(buffer+bufferptr,"%04u",(Bit16u) reg_cx);
++		}
++	}
++	WriteOut("%s %s\n",day, buffer);
++	if(!dateonly) WriteOut(MSG_Get("SHELL_CMD_DATE_SETHLP"));
++};
++
++void DOS_Shell::CMD_TIME(char * args) {
++	HELP("TIME");
++	if(ScanCMDBool(args,"H")) {
++		// synchronize time with host parameter
++		time_t curtime;
++		struct tm *loctime;
++		curtime = time (NULL);
++		loctime = localtime (&curtime);
++		
++		//reg_cx = loctime->;
++		//reg_dh = loctime->;
++		//reg_dl = loctime->;
++
++		// reg_ah=0x2d; // set system time TODO
++		// CALLBACK_RunRealInt(0x21);
++		
++		Bit32u ticks=(Bit32u)(((double)(loctime->tm_hour*3600+
++										loctime->tm_min*60+
++										loctime->tm_sec))*18.206481481);
++		mem_writed(BIOS_TIMER,ticks);
++		return;
++	}
++	bool timeonly = ScanCMDBool(args,"T");
++
++	reg_ah=0x2c; // get system time
++	CALLBACK_RunRealInt(0x21);
++/*
++		reg_dl= // 1/100 seconds
++		reg_dh= // seconds
++		reg_cl= // minutes
++		reg_ch= // hours
++*/
++	if(timeonly) {
++		WriteOut("%2u:%02u\n",reg_ch,reg_cl);
++	} else {
++		WriteOut(MSG_Get("SHELL_CMD_TIME_NOW"));
++		WriteOut("%2u:%02u:%02u,%02u\n",reg_ch,reg_cl,reg_dh,reg_dl);
++	}
++};
++
+ void DOS_Shell::CMD_SUBST (char * args) {
+ /* If more that one type can be substed think of something else 
+  * E.g. make basedir member dos_drive instead of localdrive
+@@ -945,17 +1064,22 @@
+ 		CommandLine command(0,args);
+ 
+ 		if (command.GetCount() != 2) throw 0 ;
+-		command.FindCommand(2,arg);
+-		if((arg=="/D" ) || (arg=="/d")) throw 1; //No removal (one day)
+   
+ 		command.FindCommand(1,arg);
+ 		if( (arg.size()>1) && arg[1] !=':')  throw(0);
+ 		temp_str[0]=(char)toupper(args[0]);
++		command.FindCommand(2,arg);
++		if((arg=="/D") || (arg=="/d")) {
++			if(!Drives[temp_str[0]-'A'] ) throw 1; //targetdrive not in use
++			strcat(mountstring,"-u ");
++			strcat(mountstring,temp_str);
++			this->ParseLine(mountstring);
++			return;
++		}
+ 		if(Drives[temp_str[0]-'A'] ) throw 0; //targetdrive in use
+ 		strcat(mountstring,temp_str);
+ 		strcat(mountstring," ");
+ 
+-		command.FindCommand(2,arg);
+    		Bit8u drive;char fulldir[DOS_PATHLENGTH];
+ 		if (!DOS_MakeName(const_cast<char*>(arg.c_str()),fulldir,&drive)) throw 0;
+ 	
+diff -Nur dosbox-0.74/src/shell/shell.cpp dosbox/src/shell/shell.cpp
+--- dosbox-0.74/src/shell/shell.cpp	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/shell/shell.cpp	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,7 +16,6 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: shell.cpp,v 1.100 2009-07-08 20:05:41 c2woody Exp $ */
+ 
+ #include <stdlib.h>
+ #include <stdarg.h>
+@@ -50,14 +49,14 @@
+ void VFILE_Remove(const char *name);
+ 
+ void AutoexecObject::Install(const std::string &in) {
+-	if(GCC_UNLIKELY(installed)) E_Exit("autoexec: allready created %s",buf.c_str());
++	if(GCC_UNLIKELY(installed)) E_Exit("autoexec: already created %s",buf.c_str());
+ 	installed = true;
+ 	buf = in;
+ 	autoexec_strings.push_back(buf);
+ 	this->CreateAutoexec();
+ 
+ 	//autoexec.bat is normally created AUTOEXEC_Init.
+-	//But if we are allready running (first_shell)
++	//But if we are already running (first_shell)
+ 	//we have to update the envirionment to display changes
+ 
+ 	if(first_shell)	{
+@@ -78,7 +77,7 @@
+ }
+ 
+ void AutoexecObject::InstallBefore(const std::string &in) {
+-	if(GCC_UNLIKELY(installed)) E_Exit("autoexec: allready created %s",buf.c_str());
++	if(GCC_UNLIKELY(installed)) E_Exit("autoexec: already created %s",buf.c_str());
+ 	installed = true;
+ 	buf = in;
+ 	autoexec_strings.push_front(buf);
+@@ -286,7 +285,7 @@
+ void DOS_Shell::Run(void) {
+ 	char input_line[CMD_MAXLINE] = {0};
+ 	std::string line;
+-	if (cmd->FindStringRemain("/C",line)) {
++	if (cmd->FindStringRemainBegin("/C",line)) {
+ 		strcpy(input_line,line.c_str());
+ 		char* sep = strpbrk(input_line,"\r\n"); //GTA installer
+ 		if (sep) *sep = 0;
+@@ -412,7 +411,7 @@
+ 				if (access(buffer,F_OK)) goto nomount;
+ 				autoexec[12].Install(std::string("MOUNT C \"") + buffer + "\"");
+ 				autoexec[13].Install("C:");
+-				/* Save the non modified filename (so boot and imgmount can use it (long filenames, case sensivitive)*/
++				/* Save the non-modified filename (so boot and imgmount can use it (long filenames, case sensivitive)) */
+ 				strcpy(orig,name);
+ 				upcase(name);
+ 				if(strstr(name,".BAT") != 0) {
+@@ -425,10 +424,11 @@
+ 					/* Boot image files */
+ 					autoexec[15].Install(std::string("BOOT ") + orig);
+ 				} else if((strstr(name,".ISO") != 0) || (strstr(name,".CUE") !=0 )) {
+-					if(secure) autoexec[14].Install("z:\\config.com -securemode");
+ 					/* imgmount CD image files */
+-					autoexec[15].Install(std::string("IMGMOUNT D \"") + orig + std::string("\" -t iso"));
++					/* securemode gets a different number from the previous branches! */
++					autoexec[14].Install(std::string("IMGMOUNT D \"") + orig + std::string("\" -t iso"));
+ 					//autoexec[16].Install("D:");
++					if(secure) autoexec[15].Install("z:\\config.com -securemode");
+ 					/* Makes no sense to exit here */
+ 				} else {
+ 					if(secure) autoexec[14].Install("z:\\config.com -securemode");
+@@ -465,6 +465,23 @@
+ 	MSG_Add("SHELL_CMD_CHDIR_HINT","To change to different drive type \033[31m%c:\033[0m\n");
+ 	MSG_Add("SHELL_CMD_CHDIR_HINT_2","directoryname is longer than 8 characters and/or contains spaces.\nTry \033[31mcd %s\033[0m\n");
+ 	MSG_Add("SHELL_CMD_CHDIR_HINT_3","You are still on drive Z:, change to a mounted drive with \033[31mC:\033[0m.\n");
++	MSG_Add("SHELL_CMD_DATE_HELP","Displays or changes the internal date.\n");
++	MSG_Add("SHELL_CMD_DATE_ERROR","The specified date is not correct.\n");
++	MSG_Add("SHELL_CMD_DATE_DAYS","3SunMonTueWedThuFriSat"); // "2SoMoDiMiDoFrSa"
++	MSG_Add("SHELL_CMD_DATE_NOW","Current date: ");
++	MSG_Add("SHELL_CMD_DATE_SETHLP","Type 'date MM-DD-YYYY' to change.\n");
++	MSG_Add("SHELL_CMD_DATE_FORMAT","M/D/Y");
++	MSG_Add("SHELL_CMD_DATE_HELP_LONG","DATE [[/T] [/H] [/S] | MM-DD-YYYY]\n"\
++									"  MM-DD-YYYY: new date to set\n"\
++									"  /S:         Permanently use host time and date as DOS time\n"\
++                                    "  /F:         Switch back to DOSBox internal time (opposite of /S)\n"\
++									"  /T:         Only display date\n"\
++									"  /H:         Synchronize with host\n");
++	MSG_Add("SHELL_CMD_TIME_HELP","Displays the internal time.\n");
++	MSG_Add("SHELL_CMD_TIME_NOW","Current time: ");
++	MSG_Add("SHELL_CMD_TIME_HELP_LONG","TIME [/T] [/H]\n"\
++									"  /T:         Display simple time\n"\
++									"  /H:         Synchronize with host\n");
+ 	MSG_Add("SHELL_CMD_MKDIR_ERROR","Unable to make: %s.\n");
+ 	MSG_Add("SHELL_CMD_RMDIR_ERROR","Unable to remove: %s.\n");
+ 	MSG_Add("SHELL_CMD_DEL_ERROR","Unable to delete: %s.\n");
+@@ -487,14 +504,14 @@
+ 	MSG_Add("SHELL_CMD_PAUSE_HELP","Waits for 1 keystroke to continue.\n");
+ 	MSG_Add("SHELL_CMD_COPY_FAILURE","Copy failure : %s.\n");
+ 	MSG_Add("SHELL_CMD_COPY_SUCCESS","   %d File(s) copied.\n");
+-	MSG_Add("SHELL_CMD_SUBST_NO_REMOVE","Removing drive not supported. Doing nothing.\n");
++	MSG_Add("SHELL_CMD_SUBST_NO_REMOVE","Unable to remove, drive not in use.\n");
+ 	MSG_Add("SHELL_CMD_SUBST_FAILURE","SUBST failed. You either made an error in your commandline or the target drive is already used.\nIt's only possible to use SUBST on Local drives");
+ 
+ 	MSG_Add("SHELL_STARTUP_BEGIN",
+ 		"\033[44;1m\xC9\xCD\xCD\xCD\xCD\xCD\xCD\xCD\xCD\xCD\xCD\xCD\xCD\xCD\xCD\xCD\xCD\xCD\xCD\xCD\xCD\xCD\xCD\xCD"
+ 		"\xCD\xCD\xCD\xCD\xCD\xCD\xCD\xCD\xCD\xCD\xCD\xCD\xCD\xCD\xCD\xCD\xCD\xCD\xCD\xCD\xCD\xCD\xCD\xCD"
+ 		"\xCD\xCD\xCD\xCD\xCD\xCD\xCD\xCD\xCD\xCD\xCD\xCD\xCD\xCD\xCD\xCD\xCD\xCD\xCD\xCD\xCD\xBB\n"
+-		"\xBA \033[32mWelcome to DOSBox v%-8s\033[37m                                        \xBA\n"
++		"\xBA \033[32mWelcome to DOSBox %-8s\033[37m                                         \xBA\n"
+ 		"\xBA                                                                    \xBA\n"
+ //		"\xBA DOSBox runs real and protected mode games.                         \xBA\n"
+ 		"\xBA For a short introduction for new users type: \033[33mINTRO\033[37m                 \xBA\n"
+@@ -506,7 +523,8 @@
+ 		"\xBA                                                                    \xBA\n"
+ 	);
+ 	MSG_Add("SHELL_STARTUP_CGA","\xBA DOSBox supports Composite CGA mode.                                \xBA\n"
+-	        "\xBA Use \033[31m(alt-)F11\033[37m to change the colours when in this mode.             \xBA\n"
++	        "\xBA Use \033[31mF12\033[37m to set composite output ON, OFF, or AUTO (default).        \xBA\n"
++	        "\xBA \033[31m(Alt-)F11\033[37m changes hue; \033[31mctrl-alt-F11\033[37m selects early/late CGA model.  \xBA\n"
+ 	        "\xBA                                                                    \xBA\n"
+ 	);
+ 	MSG_Add("SHELL_STARTUP_HERC","\xBA Use \033[31mF11\033[37m to cycle through white, amber, and green monochrome color. \xBA\n"
+@@ -633,7 +651,7 @@
+ 	DOS_ForceDuplicateEntry(1,0);				/* "new" STDIN */
+ 	DOS_ForceDuplicateEntry(1,2);				/* STDERR */
+ 	DOS_OpenFile("CON",OPEN_READWRITE,&dummy);	/* STDAUX */
+-	DOS_OpenFile("CON",OPEN_READWRITE,&dummy);	/* STDPRN */
++	DOS_OpenFile("PRN",OPEN_READWRITE,&dummy);	/* STDPRN */
+ 
+ 	psp.SetParent(psp_seg);
+ 	/* Set the environment */
+diff -Nur dosbox-0.74/src/shell/shell_misc.cpp dosbox/src/shell/shell_misc.cpp
+--- dosbox-0.74/src/shell/shell_misc.cpp	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/shell/shell_misc.cpp	2014-01-12 14:43:47.000000000 +0100
+@@ -1,5 +1,5 @@
+ /*
+- *  Copyright (C) 2002-2010  The DOSBox Team
++ *  Copyright (C) 2002-2013  The DOSBox Team
+  *
+  *  This program is free software; you can redistribute it and/or modify
+  *  it under the terms of the GNU General Public License as published by
+@@ -16,7 +16,6 @@
+  *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+  */
+ 
+-/* $Id: shell_misc.cpp,v 1.54 2009-05-27 09:15:42 qbix79 Exp $ */
+ 
+ #include <stdlib.h>
+ #include <string.h>
+@@ -57,7 +56,7 @@
+ 			Bit16u dummy;
+ 			DOS_CloseFile(input_handle);
+ 			DOS_OpenFile("con",2,&dummy);
+-			LOG(LOG_MISC,LOG_ERROR)("Reopening the input handle.This is a bug!");
++			LOG(LOG_MISC,LOG_ERROR)("Reopening the input handle. This is a bug!");
+ 		}
+ 		if (!n) {
+ 			size=0;			//Kill the while loop
+@@ -175,6 +174,24 @@
+ 						size++;
+ 					}
+ 					break;
++				case 15:		/* Shift-Tab */
++					if (l_completion.size()) {
++						if (it_completion == l_completion.begin()) it_completion = l_completion.end (); 
++						it_completion--;
++		
++						if (it_completion->length()) {
++							for (;str_index > completion_index; str_index--) {
++								// removes all characters
++								outc(8); outc(' '); outc(8);
++							}
++
++							strcpy(&line[completion_index], it_completion->c_str());
++							len = (Bit16u)it_completion->length();
++							str_len = str_index = completion_index + len;
++							size = CMD_MAXLINE - str_index - 2;
++							DOS_WriteFile(STDOUT, (Bit8u *)it_completion->c_str(), &len);
++						}
++					}
+ 				default:
+ 					break;
+ 				}
+@@ -282,7 +299,7 @@
+ 						}
+ 						res=DOS_FindNext();
+ 					}
+-					/* Add excutable list to front of completion list. */
++					/* Add executable list to front of completion list. */
+ 					std::copy(executable.begin(),executable.end(),std::front_inserter(l_completion));
+ 					it_completion = l_completion.begin();
+ 					dos.dta(save_dta);
+@@ -456,7 +473,7 @@
+ 		/* Fill the command line */
+ 		CommandTail cmdtail;
+ 		cmdtail.count = 0;
+-		memset(&cmdtail.buffer,0,126); //Else some part of the string is unitialized (valgrind)
++		memset(&cmdtail.buffer,0,127); //Else some part of the string is unitialized (valgrind)
+ 		if (strlen(line)>126) line[126]=0;
+ 		cmdtail.count=(Bit8u)strlen(line);
+ 		memcpy(cmdtail.buffer,line,strlen(line));
+diff -Nur dosbox-0.74/src/winres.rc dosbox/src/winres.rc
+--- dosbox-0.74/src/winres.rc	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/src/winres.rc	2014-01-12 14:43:47.000000000 +0100
+@@ -19,12 +19,12 @@
+     BEGIN
+         BLOCK "040904b0"
+         BEGIN
+-            VALUE "Comments", " 2002-2010 DOSBox Team, published under GNU GPL"
++            VALUE "Comments", " 2002-2013 DOSBox Team, published under GNU GPL"
+             VALUE "CompanyName", "DOSBox Team"
+             VALUE "FileDescription", "DOSBox DOS Emulator"
+             VALUE "FileVersion", "0, 74, 0, 0"
+             VALUE "InternalName", "DOSBox"
+-            VALUE "LegalCopyright", "Copyright  2002-2010 DOSBox Team"
++            VALUE "LegalCopyright", "Copyright  2002-2013 DOSBox Team"
+             VALUE "OriginalFilename", "dosbox.exe"
+             VALUE "ProductName", "DOSBox DOS Emulator"
+             VALUE "ProductVersion", "0, 74, 0, 0"
+diff -Nur dosbox-0.74/VERSION dosbox/VERSION
+--- dosbox-0.74/VERSION	1970-01-01 01:00:00.000000000 +0100
++++ dosbox/VERSION	2014-01-12 14:43:47.000000000 +0100
+@@ -0,0 +1 @@
++0.74
+diff -Nur dosbox-0.74/visualc_net/dosbox.vcproj dosbox/visualc_net/dosbox.vcproj
+--- dosbox-0.74/visualc_net/dosbox.vcproj	2010-05-10 19:43:54.000000000 +0200
++++ dosbox/visualc_net/dosbox.vcproj	2014-01-12 14:43:47.000000000 +0100
+@@ -481,6 +481,9 @@
+ 					RelativePath="..\src\hardware\mixer.cpp">
+ 				</File>
+ 				<File
++					RelativePath="..\src\hardware\pci_bus.cpp">
++				</File>
++				<File
+ 					RelativePath="..\src\hardware\pic.cpp">
+ 				</File>
+ 				<File
+@@ -820,6 +823,9 @@
+ 				RelativePath="..\include\mem.h">
+ 			</File>
+ 			<File
++				RelativePath="..\include\midi.h">
++			</File>
++			<File
+ 				RelativePath="..\include\mixer.h">
+ 			</File>
+ 			<File
+@@ -832,6 +838,9 @@
+ 				RelativePath="..\include\paging.h">
+ 			</File>
+ 			<File
++				RelativePath="..\include\pci_bus.h">
++			</File>
++			<File
+ 				RelativePath="..\include\pic.h">
+ 			</File>
+ 			<File
+diff -Nur dosbox-0.74/visualc_net/Makefile.in dosbox/visualc_net/Makefile.in
+--- dosbox-0.74/visualc_net/Makefile.in	2010-05-12 11:57:44.000000000 +0200
++++ dosbox/visualc_net/Makefile.in	1970-01-01 01:00:00.000000000 +0100
+@@ -1,336 +0,0 @@
+-# Makefile.in generated by automake 1.11.1 from Makefile.am.
+-# @configure_input@
+-
+-# Copyright (C) 1994, 1995, 1996, 1997, 1998, 1999, 2000, 2001, 2002,
+-# 2003, 2004, 2005, 2006, 2007, 2008, 2009  Free Software Foundation,
+-# Inc.
+-# This Makefile.in is free software; the Free Software Foundation
+-# gives unlimited permission to copy and/or distribute it,
+-# with or without modifications, as long as this notice is preserved.
+-
+-# This program is distributed in the hope that it will be useful,
+-# but WITHOUT ANY WARRANTY, to the extent permitted by law; without
+-# even the implied warranty of MERCHANTABILITY or FITNESS FOR A
+-# PARTICULAR PURPOSE.
+-
+-@SET_MAKE@
+-VPATH = @srcdir@
+-pkgdatadir = $(datadir)/@PACKAGE@
+-pkgincludedir = $(includedir)/@PACKAGE@
+-pkglibdir = $(libdir)/@PACKAGE@
+-pkglibexecdir = $(libexecdir)/@PACKAGE@
+-am__cd = CDPATH="$${ZSH_VERSION+.}$(PATH_SEPARATOR)" && cd
+-install_sh_DATA = $(install_sh) -c -m 644
+-install_sh_PROGRAM = $(install_sh) -c
+-install_sh_SCRIPT = $(install_sh) -c
+-INSTALL_HEADER = $(INSTALL_DATA)
+-transform = $(program_transform_name)
+-NORMAL_INSTALL = :
+-PRE_INSTALL = :
+-POST_INSTALL = :
+-NORMAL_UNINSTALL = :
+-PRE_UNINSTALL = :
+-POST_UNINSTALL = :
+-build_triplet = @build@
+-host_triplet = @host@
+-subdir = visualc_net
+-DIST_COMMON = $(srcdir)/Makefile.am $(srcdir)/Makefile.in
+-ACLOCAL_M4 = $(top_srcdir)/aclocal.m4
+-am__aclocal_m4_deps = $(top_srcdir)/acinclude.m4 \
+-	$(top_srcdir)/configure.in
+-am__configure_deps = $(am__aclocal_m4_deps) $(CONFIGURE_DEPENDENCIES) \
+-	$(ACLOCAL_M4)
+-mkinstalldirs = $(install_sh) -d
+-CONFIG_HEADER = $(top_builddir)/config.h
+-CONFIG_CLEAN_FILES =
+-CONFIG_CLEAN_VPATH_FILES =
+-SOURCES =
+-DIST_SOURCES =
+-DISTFILES = $(DIST_COMMON) $(DIST_SOURCES) $(TEXINFOS) $(EXTRA_DIST)
+-ACLOCAL = @ACLOCAL@
+-ALSA_CFLAGS = @ALSA_CFLAGS@
+-ALSA_LIBS = @ALSA_LIBS@
+-AMTAR = @AMTAR@
+-AUTOCONF = @AUTOCONF@
+-AUTOHEADER = @AUTOHEADER@
+-AUTOMAKE = @AUTOMAKE@
+-AWK = @AWK@
+-CC = @CC@
+-CCDEPMODE = @CCDEPMODE@
+-CFLAGS = @CFLAGS@
+-CPP = @CPP@
+-CPPFLAGS = @CPPFLAGS@
+-CXX = @CXX@
+-CXXDEPMODE = @CXXDEPMODE@
+-CXXFLAGS = @CXXFLAGS@
+-CYGPATH_W = @CYGPATH_W@
+-DEFS = @DEFS@
+-DEPDIR = @DEPDIR@
+-ECHO_C = @ECHO_C@
+-ECHO_N = @ECHO_N@
+-ECHO_T = @ECHO_T@
+-EGREP = @EGREP@
+-EXEEXT = @EXEEXT@
+-GREP = @GREP@
+-INSTALL = @INSTALL@
+-INSTALL_DATA = @INSTALL_DATA@
+-INSTALL_PROGRAM = @INSTALL_PROGRAM@
+-INSTALL_SCRIPT = @INSTALL_SCRIPT@
+-INSTALL_STRIP_PROGRAM = @INSTALL_STRIP_PROGRAM@
+-LDFLAGS = @LDFLAGS@
+-LIBOBJS = @LIBOBJS@
+-LIBS = @LIBS@
+-LTLIBOBJS = @LTLIBOBJS@
+-MAKEINFO = @MAKEINFO@
+-MKDIR_P = @MKDIR_P@
+-OBJEXT = @OBJEXT@
+-PACKAGE = @PACKAGE@
+-PACKAGE_BUGREPORT = @PACKAGE_BUGREPORT@
+-PACKAGE_NAME = @PACKAGE_NAME@
+-PACKAGE_STRING = @PACKAGE_STRING@
+-PACKAGE_TARNAME = @PACKAGE_TARNAME@
+-PACKAGE_URL = @PACKAGE_URL@
+-PACKAGE_VERSION = @PACKAGE_VERSION@
+-PATH_SEPARATOR = @PATH_SEPARATOR@
+-RANLIB = @RANLIB@
+-SDL_CFLAGS = @SDL_CFLAGS@
+-SDL_CONFIG = @SDL_CONFIG@
+-SDL_LIBS = @SDL_LIBS@
+-SET_MAKE = @SET_MAKE@
+-SHELL = @SHELL@
+-STRIP = @STRIP@
+-VERSION = @VERSION@
+-WINDRES = @WINDRES@
+-abs_builddir = @abs_builddir@
+-abs_srcdir = @abs_srcdir@
+-abs_top_builddir = @abs_top_builddir@
+-abs_top_srcdir = @abs_top_srcdir@
+-ac_ct_CC = @ac_ct_CC@
+-ac_ct_CXX = @ac_ct_CXX@
+-am__include = @am__include@
+-am__leading_dot = @am__leading_dot@
+-am__quote = @am__quote@
+-am__tar = @am__tar@
+-am__untar = @am__untar@
+-bindir = @bindir@
+-build = @build@
+-build_alias = @build_alias@
+-build_cpu = @build_cpu@
+-build_os = @build_os@
+-build_vendor = @build_vendor@
+-builddir = @builddir@
+-datadir = @datadir@
+-datarootdir = @datarootdir@
+-docdir = @docdir@
+-dvidir = @dvidir@
+-exec_prefix = @exec_prefix@
+-host = @host@
+-host_alias = @host_alias@
+-host_cpu = @host_cpu@
+-host_os = @host_os@
+-host_vendor = @host_vendor@
+-htmldir = @htmldir@
+-includedir = @includedir@
+-infodir = @infodir@
+-install_sh = @install_sh@
+-libdir = @libdir@
+-libexecdir = @libexecdir@
+-localedir = @localedir@
+-localstatedir = @localstatedir@
+-mandir = @mandir@
+-mkdir_p = @mkdir_p@
+-oldincludedir = @oldincludedir@
+-pdfdir = @pdfdir@
+-prefix = @prefix@
+-program_transform_name = @program_transform_name@
+-psdir = @psdir@
+-sbindir = @sbindir@
+-sharedstatedir = @sharedstatedir@
+-srcdir = @srcdir@
+-sysconfdir = @sysconfdir@
+-target_alias = @target_alias@
+-top_build_prefix = @top_build_prefix@
+-top_builddir = @top_builddir@
+-top_srcdir = @top_srcdir@
+-EXTRA_DIST = dosbox.sln dosbox.vcproj
+-all: all-am
+-
+-.SUFFIXES:
+-$(srcdir)/Makefile.in:  $(srcdir)/Makefile.am  $(am__configure_deps)
+-	@for dep in $?; do \
+-	  case '$(am__configure_deps)' in \
+-	    *$$dep*) \
+-	      ( cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh ) \
+-	        && { if test -f $@; then exit 0; else break; fi; }; \
+-	      exit 1;; \
+-	  esac; \
+-	done; \
+-	echo ' cd $(top_srcdir) && $(AUTOMAKE) --gnu visualc_net/Makefile'; \
+-	$(am__cd) $(top_srcdir) && \
+-	  $(AUTOMAKE) --gnu visualc_net/Makefile
+-.PRECIOUS: Makefile
+-Makefile: $(srcdir)/Makefile.in $(top_builddir)/config.status
+-	@case '$?' in \
+-	  *config.status*) \
+-	    cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh;; \
+-	  *) \
+-	    echo ' cd $(top_builddir) && $(SHELL) ./config.status $(subdir)/$@ $(am__depfiles_maybe)'; \
+-	    cd $(top_builddir) && $(SHELL) ./config.status $(subdir)/$@ $(am__depfiles_maybe);; \
+-	esac;
+-
+-$(top_builddir)/config.status: $(top_srcdir)/configure $(CONFIG_STATUS_DEPENDENCIES)
+-	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
+-
+-$(top_srcdir)/configure:  $(am__configure_deps)
+-	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
+-$(ACLOCAL_M4):  $(am__aclocal_m4_deps)
+-	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
+-$(am__aclocal_m4_deps):
+-tags: TAGS
+-TAGS:
+-
+-ctags: CTAGS
+-CTAGS:
+-
+-
+-distdir: $(DISTFILES)
+-	@srcdirstrip=`echo "$(srcdir)" | sed 's/[].[^$$\\*]/\\\\&/g'`; \
+-	topsrcdirstrip=`echo "$(top_srcdir)" | sed 's/[].[^$$\\*]/\\\\&/g'`; \
+-	list='$(DISTFILES)'; \
+-	  dist_files=`for file in $$list; do echo $$file; done | \
+-	  sed -e "s|^$$srcdirstrip/||;t" \
+-	      -e "s|^$$topsrcdirstrip/|$(top_builddir)/|;t"`; \
+-	case $$dist_files in \
+-	  */*) $(MKDIR_P) `echo "$$dist_files" | \
+-			   sed '/\//!d;s|^|$(distdir)/|;s,/[^/]*$$,,' | \
+-			   sort -u` ;; \
+-	esac; \
+-	for file in $$dist_files; do \
+-	  if test -f $$file || test -d $$file; then d=.; else d=$(srcdir); fi; \
+-	  if test -d $$d/$$file; then \
+-	    dir=`echo "/$$file" | sed -e 's,/[^/]*$$,,'`; \
+-	    if test -d "$(distdir)/$$file"; then \
+-	      find "$(distdir)/$$file" -type d ! -perm -700 -exec chmod u+rwx {} \;; \
+-	    fi; \
+-	    if test -d $(srcdir)/$$file && test $$d != $(srcdir); then \
+-	      cp -fpR $(srcdir)/$$file "$(distdir)$$dir" || exit 1; \
+-	      find "$(distdir)/$$file" -type d ! -perm -700 -exec chmod u+rwx {} \;; \
+-	    fi; \
+-	    cp -fpR $$d/$$file "$(distdir)$$dir" || exit 1; \
+-	  else \
+-	    test -f "$(distdir)/$$file" \
+-	    || cp -p $$d/$$file "$(distdir)/$$file" \
+-	    || exit 1; \
+-	  fi; \
+-	done
+-check-am: all-am
+-check: check-am
+-all-am: Makefile
+-installdirs:
+-install: install-am
+-install-exec: install-exec-am
+-install-data: install-data-am
+-uninstall: uninstall-am
+-
+-install-am: all-am
+-	@$(MAKE) $(AM_MAKEFLAGS) install-exec-am install-data-am
+-
+-installcheck: installcheck-am
+-install-strip:
+-	$(MAKE) $(AM_MAKEFLAGS) INSTALL_PROGRAM="$(INSTALL_STRIP_PROGRAM)" \
+-	  install_sh_PROGRAM="$(INSTALL_STRIP_PROGRAM)" INSTALL_STRIP_FLAG=-s \
+-	  `test -z '$(STRIP)' || \
+-	    echo "INSTALL_PROGRAM_ENV=STRIPPROG='$(STRIP)'"` install
+-mostlyclean-generic:
+-
+-clean-generic:
+-
+-distclean-generic:
+-	-test -z "$(CONFIG_CLEAN_FILES)" || rm -f $(CONFIG_CLEAN_FILES)
+-	-test . = "$(srcdir)" || test -z "$(CONFIG_CLEAN_VPATH_FILES)" || rm -f $(CONFIG_CLEAN_VPATH_FILES)
+-
+-maintainer-clean-generic:
+-	@echo "This command is intended for maintainers to use"
+-	@echo "it deletes files that may require special tools to rebuild."
+-clean: clean-am
+-
+-clean-am: clean-generic mostlyclean-am
+-
+-distclean: distclean-am
+-	-rm -f Makefile
+-distclean-am: clean-am distclean-generic
+-
+-dvi: dvi-am
+-
+-dvi-am:
+-
+-html: html-am
+-
+-html-am:
+-
+-info: info-am
+-
+-info-am:
+-
+-install-data-am:
+-
+-install-dvi: install-dvi-am
+-
+-install-dvi-am:
+-
+-install-exec-am:
+-
+-install-html: install-html-am
+-
+-install-html-am:
+-
+-install-info: install-info-am
+-
+-install-info-am:
+-
+-install-man:
+-
+-install-pdf: install-pdf-am
+-
+-install-pdf-am:
+-
+-install-ps: install-ps-am
+-
+-install-ps-am:
+-
+-installcheck-am:
+-
+-maintainer-clean: maintainer-clean-am
+-	-rm -f Makefile
+-maintainer-clean-am: distclean-am maintainer-clean-generic
+-
+-mostlyclean: mostlyclean-am
+-
+-mostlyclean-am: mostlyclean-generic
+-
+-pdf: pdf-am
+-
+-pdf-am:
+-
+-ps: ps-am
+-
+-ps-am:
+-
+-uninstall-am:
+-
+-.MAKE: install-am install-strip
+-
+-.PHONY: all all-am check check-am clean clean-generic distclean \
+-	distclean-generic distdir dvi dvi-am html html-am info info-am \
+-	install install-am install-data install-data-am install-dvi \
+-	install-dvi-am install-exec install-exec-am install-html \
+-	install-html-am install-info install-info-am install-man \
+-	install-pdf install-pdf-am install-ps install-ps-am \
+-	install-strip installcheck installcheck-am installdirs \
+-	maintainer-clean maintainer-clean-generic mostlyclean \
+-	mostlyclean-generic pdf pdf-am ps ps-am uninstall uninstall-am
+-
+-
+-# Tell versions [3.59,3.63) of GNU make to not export all variables.
+-# Otherwise a system limit (for SysV at least) may be exceeded.
+-.NOEXPORT:
diff -Nur dosbox-0.74/VERSION dosbox-0.74.patch/VERSION
--- dosbox-0.74/VERSION	1970-01-01 01:00:00.000000000 +0100
+++ dosbox-0.74.patch/VERSION	2016-12-11 18:35:15.558284005 +0100
@@ -0,0 +1 @@
+0.74
diff -Nur dosbox-0.74/visualc_net/dosbox.vcproj dosbox-0.74.patch/visualc_net/dosbox.vcproj
--- dosbox-0.74/visualc_net/dosbox.vcproj	2010-05-10 19:43:54.000000000 +0200
+++ dosbox-0.74.patch/visualc_net/dosbox.vcproj	2016-12-11 18:35:15.558284005 +0100
@@ -481,6 +481,9 @@
 					RelativePath="..\src\hardware\mixer.cpp">
 				</File>
 				<File
+					RelativePath="..\src\hardware\pci_bus.cpp">
+				</File>
+				<File
 					RelativePath="..\src\hardware\pic.cpp">
 				</File>
 				<File
@@ -820,6 +823,9 @@
 				RelativePath="..\include\mem.h">
 			</File>
 			<File
+				RelativePath="..\include\midi.h">
+			</File>
+			<File
 				RelativePath="..\include\mixer.h">
 			</File>
 			<File
@@ -832,6 +838,9 @@
 				RelativePath="..\include\paging.h">
 			</File>
 			<File
+				RelativePath="..\include\pci_bus.h">
+			</File>
+			<File
 				RelativePath="..\include\pic.h">
 			</File>
 			<File
diff -Nur dosbox-0.74/visualc_net/Makefile.in dosbox-0.74.patch/visualc_net/Makefile.in
--- dosbox-0.74/visualc_net/Makefile.in	2010-05-12 11:57:44.000000000 +0200
+++ dosbox-0.74.patch/visualc_net/Makefile.in	1970-01-01 01:00:00.000000000 +0100
@@ -1,336 +0,0 @@
-# Makefile.in generated by automake 1.11.1 from Makefile.am.
-# @configure_input@
-
-# Copyright (C) 1994, 1995, 1996, 1997, 1998, 1999, 2000, 2001, 2002,
-# 2003, 2004, 2005, 2006, 2007, 2008, 2009  Free Software Foundation,
-# Inc.
-# This Makefile.in is free software; the Free Software Foundation
-# gives unlimited permission to copy and/or distribute it,
-# with or without modifications, as long as this notice is preserved.
-
-# This program is distributed in the hope that it will be useful,
-# but WITHOUT ANY WARRANTY, to the extent permitted by law; without
-# even the implied warranty of MERCHANTABILITY or FITNESS FOR A
-# PARTICULAR PURPOSE.
-
-@SET_MAKE@
-VPATH = @srcdir@
-pkgdatadir = $(datadir)/@PACKAGE@
-pkgincludedir = $(includedir)/@PACKAGE@
-pkglibdir = $(libdir)/@PACKAGE@
-pkglibexecdir = $(libexecdir)/@PACKAGE@
-am__cd = CDPATH="$${ZSH_VERSION+.}$(PATH_SEPARATOR)" && cd
-install_sh_DATA = $(install_sh) -c -m 644
-install_sh_PROGRAM = $(install_sh) -c
-install_sh_SCRIPT = $(install_sh) -c
-INSTALL_HEADER = $(INSTALL_DATA)
-transform = $(program_transform_name)
-NORMAL_INSTALL = :
-PRE_INSTALL = :
-POST_INSTALL = :
-NORMAL_UNINSTALL = :
-PRE_UNINSTALL = :
-POST_UNINSTALL = :
-build_triplet = @build@
-host_triplet = @host@
-subdir = visualc_net
-DIST_COMMON = $(srcdir)/Makefile.am $(srcdir)/Makefile.in
-ACLOCAL_M4 = $(top_srcdir)/aclocal.m4
-am__aclocal_m4_deps = $(top_srcdir)/acinclude.m4 \
-	$(top_srcdir)/configure.in
-am__configure_deps = $(am__aclocal_m4_deps) $(CONFIGURE_DEPENDENCIES) \
-	$(ACLOCAL_M4)
-mkinstalldirs = $(install_sh) -d
-CONFIG_HEADER = $(top_builddir)/config.h
-CONFIG_CLEAN_FILES =
-CONFIG_CLEAN_VPATH_FILES =
-SOURCES =
-DIST_SOURCES =
-DISTFILES = $(DIST_COMMON) $(DIST_SOURCES) $(TEXINFOS) $(EXTRA_DIST)
-ACLOCAL = @ACLOCAL@
-ALSA_CFLAGS = @ALSA_CFLAGS@
-ALSA_LIBS = @ALSA_LIBS@
-AMTAR = @AMTAR@
-AUTOCONF = @AUTOCONF@
-AUTOHEADER = @AUTOHEADER@
-AUTOMAKE = @AUTOMAKE@
-AWK = @AWK@
-CC = @CC@
-CCDEPMODE = @CCDEPMODE@
-CFLAGS = @CFLAGS@
-CPP = @CPP@
-CPPFLAGS = @CPPFLAGS@
-CXX = @CXX@
-CXXDEPMODE = @CXXDEPMODE@
-CXXFLAGS = @CXXFLAGS@
-CYGPATH_W = @CYGPATH_W@
-DEFS = @DEFS@
-DEPDIR = @DEPDIR@
-ECHO_C = @ECHO_C@
-ECHO_N = @ECHO_N@
-ECHO_T = @ECHO_T@
-EGREP = @EGREP@
-EXEEXT = @EXEEXT@
-GREP = @GREP@
-INSTALL = @INSTALL@
-INSTALL_DATA = @INSTALL_DATA@
-INSTALL_PROGRAM = @INSTALL_PROGRAM@
-INSTALL_SCRIPT = @INSTALL_SCRIPT@
-INSTALL_STRIP_PROGRAM = @INSTALL_STRIP_PROGRAM@
-LDFLAGS = @LDFLAGS@
-LIBOBJS = @LIBOBJS@
-LIBS = @LIBS@
-LTLIBOBJS = @LTLIBOBJS@
-MAKEINFO = @MAKEINFO@
-MKDIR_P = @MKDIR_P@
-OBJEXT = @OBJEXT@
-PACKAGE = @PACKAGE@
-PACKAGE_BUGREPORT = @PACKAGE_BUGREPORT@
-PACKAGE_NAME = @PACKAGE_NAME@
-PACKAGE_STRING = @PACKAGE_STRING@
-PACKAGE_TARNAME = @PACKAGE_TARNAME@
-PACKAGE_URL = @PACKAGE_URL@
-PACKAGE_VERSION = @PACKAGE_VERSION@
-PATH_SEPARATOR = @PATH_SEPARATOR@
-RANLIB = @RANLIB@
-SDL_CFLAGS = @SDL_CFLAGS@
-SDL_CONFIG = @SDL_CONFIG@
-SDL_LIBS = @SDL_LIBS@
-SET_MAKE = @SET_MAKE@
-SHELL = @SHELL@
-STRIP = @STRIP@
-VERSION = @VERSION@
-WINDRES = @WINDRES@
-abs_builddir = @abs_builddir@
-abs_srcdir = @abs_srcdir@
-abs_top_builddir = @abs_top_builddir@
-abs_top_srcdir = @abs_top_srcdir@
-ac_ct_CC = @ac_ct_CC@
-ac_ct_CXX = @ac_ct_CXX@
-am__include = @am__include@
-am__leading_dot = @am__leading_dot@
-am__quote = @am__quote@
-am__tar = @am__tar@
-am__untar = @am__untar@
-bindir = @bindir@
-build = @build@
-build_alias = @build_alias@
-build_cpu = @build_cpu@
-build_os = @build_os@
-build_vendor = @build_vendor@
-builddir = @builddir@
-datadir = @datadir@
-datarootdir = @datarootdir@
-docdir = @docdir@
-dvidir = @dvidir@
-exec_prefix = @exec_prefix@
-host = @host@
-host_alias = @host_alias@
-host_cpu = @host_cpu@
-host_os = @host_os@
-host_vendor = @host_vendor@
-htmldir = @htmldir@
-includedir = @includedir@
-infodir = @infodir@
-install_sh = @install_sh@
-libdir = @libdir@
-libexecdir = @libexecdir@
-localedir = @localedir@
-localstatedir = @localstatedir@
-mandir = @mandir@
-mkdir_p = @mkdir_p@
-oldincludedir = @oldincludedir@
-pdfdir = @pdfdir@
-prefix = @prefix@
-program_transform_name = @program_transform_name@
-psdir = @psdir@
-sbindir = @sbindir@
-sharedstatedir = @sharedstatedir@
-srcdir = @srcdir@
-sysconfdir = @sysconfdir@
-target_alias = @target_alias@
-top_build_prefix = @top_build_prefix@
-top_builddir = @top_builddir@
-top_srcdir = @top_srcdir@
-EXTRA_DIST = dosbox.sln dosbox.vcproj
-all: all-am
-
-.SUFFIXES:
-$(srcdir)/Makefile.in:  $(srcdir)/Makefile.am  $(am__configure_deps)
-	@for dep in $?; do \
-	  case '$(am__configure_deps)' in \
-	    *$$dep*) \
-	      ( cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh ) \
-	        && { if test -f $@; then exit 0; else break; fi; }; \
-	      exit 1;; \
-	  esac; \
-	done; \
-	echo ' cd $(top_srcdir) && $(AUTOMAKE) --gnu visualc_net/Makefile'; \
-	$(am__cd) $(top_srcdir) && \
-	  $(AUTOMAKE) --gnu visualc_net/Makefile
-.PRECIOUS: Makefile
-Makefile: $(srcdir)/Makefile.in $(top_builddir)/config.status
-	@case '$?' in \
-	  *config.status*) \
-	    cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh;; \
-	  *) \
-	    echo ' cd $(top_builddir) && $(SHELL) ./config.status $(subdir)/$@ $(am__depfiles_maybe)'; \
-	    cd $(top_builddir) && $(SHELL) ./config.status $(subdir)/$@ $(am__depfiles_maybe);; \
-	esac;
-
-$(top_builddir)/config.status: $(top_srcdir)/configure $(CONFIG_STATUS_DEPENDENCIES)
-	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
-
-$(top_srcdir)/configure:  $(am__configure_deps)
-	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
-$(ACLOCAL_M4):  $(am__aclocal_m4_deps)
-	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
-$(am__aclocal_m4_deps):
-tags: TAGS
-TAGS:
-
-ctags: CTAGS
-CTAGS:
-
-
-distdir: $(DISTFILES)
-	@srcdirstrip=`echo "$(srcdir)" | sed 's/[].[^$$\\*]/\\\\&/g'`; \
-	topsrcdirstrip=`echo "$(top_srcdir)" | sed 's/[].[^$$\\*]/\\\\&/g'`; \
-	list='$(DISTFILES)'; \
-	  dist_files=`for file in $$list; do echo $$file; done | \
-	  sed -e "s|^$$srcdirstrip/||;t" \
-	      -e "s|^$$topsrcdirstrip/|$(top_builddir)/|;t"`; \
-	case $$dist_files in \
-	  */*) $(MKDIR_P) `echo "$$dist_files" | \
-			   sed '/\//!d;s|^|$(distdir)/|;s,/[^/]*$$,,' | \
-			   sort -u` ;; \
-	esac; \
-	for file in $$dist_files; do \
-	  if test -f $$file || test -d $$file; then d=.; else d=$(srcdir); fi; \
-	  if test -d $$d/$$file; then \
-	    dir=`echo "/$$file" | sed -e 's,/[^/]*$$,,'`; \
-	    if test -d "$(distdir)/$$file"; then \
-	      find "$(distdir)/$$file" -type d ! -perm -700 -exec chmod u+rwx {} \;; \
-	    fi; \
-	    if test -d $(srcdir)/$$file && test $$d != $(srcdir); then \
-	      cp -fpR $(srcdir)/$$file "$(distdir)$$dir" || exit 1; \
-	      find "$(distdir)/$$file" -type d ! -perm -700 -exec chmod u+rwx {} \;; \
-	    fi; \
-	    cp -fpR $$d/$$file "$(distdir)$$dir" || exit 1; \
-	  else \
-	    test -f "$(distdir)/$$file" \
-	    || cp -p $$d/$$file "$(distdir)/$$file" \
-	    || exit 1; \
-	  fi; \
-	done
-check-am: all-am
-check: check-am
-all-am: Makefile
-installdirs:
-install: install-am
-install-exec: install-exec-am
-install-data: install-data-am
-uninstall: uninstall-am
-
-install-am: all-am
-	@$(MAKE) $(AM_MAKEFLAGS) install-exec-am install-data-am
-
-installcheck: installcheck-am
-install-strip:
-	$(MAKE) $(AM_MAKEFLAGS) INSTALL_PROGRAM="$(INSTALL_STRIP_PROGRAM)" \
-	  install_sh_PROGRAM="$(INSTALL_STRIP_PROGRAM)" INSTALL_STRIP_FLAG=-s \
-	  `test -z '$(STRIP)' || \
-	    echo "INSTALL_PROGRAM_ENV=STRIPPROG='$(STRIP)'"` install
-mostlyclean-generic:
-
-clean-generic:
-
-distclean-generic:
-	-test -z "$(CONFIG_CLEAN_FILES)" || rm -f $(CONFIG_CLEAN_FILES)
-	-test . = "$(srcdir)" || test -z "$(CONFIG_CLEAN_VPATH_FILES)" || rm -f $(CONFIG_CLEAN_VPATH_FILES)
-
-maintainer-clean-generic:
-	@echo "This command is intended for maintainers to use"
-	@echo "it deletes files that may require special tools to rebuild."
-clean: clean-am
-
-clean-am: clean-generic mostlyclean-am
-
-distclean: distclean-am
-	-rm -f Makefile
-distclean-am: clean-am distclean-generic
-
-dvi: dvi-am
-
-dvi-am:
-
-html: html-am
-
-html-am:
-
-info: info-am
-
-info-am:
-
-install-data-am:
-
-install-dvi: install-dvi-am
-
-install-dvi-am:
-
-install-exec-am:
-
-install-html: install-html-am
-
-install-html-am:
-
-install-info: install-info-am
-
-install-info-am:
-
-install-man:
-
-install-pdf: install-pdf-am
-
-install-pdf-am:
-
-install-ps: install-ps-am
-
-install-ps-am:
-
-installcheck-am:
-
-maintainer-clean: maintainer-clean-am
-	-rm -f Makefile
-maintainer-clean-am: distclean-am maintainer-clean-generic
-
-mostlyclean: mostlyclean-am
-
-mostlyclean-am: mostlyclean-generic
-
-pdf: pdf-am
-
-pdf-am:
-
-ps: ps-am
-
-ps-am:
-
-uninstall-am:
-
-.MAKE: install-am install-strip
-
-.PHONY: all all-am check check-am clean clean-generic distclean \
-	distclean-generic distdir dvi dvi-am html html-am info info-am \
-	install install-am install-data install-data-am install-dvi \
-	install-dvi-am install-exec install-exec-am install-html \
-	install-html-am install-info install-info-am install-man \
-	install-pdf install-pdf-am install-ps install-ps-am \
-	install-strip installcheck installcheck-am installdirs \
-	maintainer-clean maintainer-clean-generic mostlyclean \
-	mostlyclean-generic pdf pdf-am ps ps-am uninstall uninstall-am
-
-
-# Tell versions [3.59,3.63) of GNU make to not export all variables.
-# Otherwise a system limit (for SysV at least) may be exceeded.
-.NOEXPORT:
